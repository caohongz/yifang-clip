var zw=Object.defineProperty;var Od=f=>{throw TypeError(f)};var Fw=(f,l,h)=>l in f?zw(f,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):f[l]=h;var Nd=(f,l,h)=>Fw(f,typeof l!="symbol"?l+"":l,h),ph=(f,l,h)=>l.has(f)||Od("Cannot "+h);var ft=(f,l,h)=>(ph(f,l,"read from private field"),h?h.call(f):l.get(f)),Jn=(f,l,h)=>l.has(f)?Od("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,h),Qn=(f,l,h,u)=>(ph(f,l,"write to private field"),u?u.call(f,h):l.set(f,h),h),tr=(f,l,h)=>(ph(f,l,"access private method"),h);import{m as vc,s as kw,q as Lw,d as Di,x as Gd,r as pt,y as Ee,o as fs,z as ra,A as On,B as Pw,i as Ct,c as Et,a as O,C as qi,t as je,b as et,D as mn,G as Kh,n as ta,H as _h,E as gr,I as Rw,g as mt,f as Qt,w as Gt,F as xi,e as Nn,j as Ze,J as fe,p as Hd,K as Dw,L as Pn,M as Ps,N as wc,h as Mw,O as Yd}from"./index-D3jeGj0w.js";import{d as Be,_ as ps}from"./_plugin-vue_export-helper-Cw5ivDAb.js";var xc={};(function(f){var l=function(){var t=new Date,e=4,n=3,a=2,d=1,g=e,y={setLogLevel:function(w){w==this.debug?g=d:w==this.info?g=a:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),d>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){a>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return y}();l.getDurationString=function(t,e){var n;function a(L,k){for(var F=""+L,G=F.split(".");G[0].length<k;)G[0]="0"+G[0];return G.join(".")}t<0?(n=!0,t=-t):n=!1;var d=e||1,g=t/d,y=Math.floor(g/3600);g-=y*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+y+":"+a(w,2)+":"+a(g,2)+"."+a(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",a=0;a<e;a++)a>0&&(n+=","),n+="["+l.getDurationString(t.start(a))+","+l.getDurationString(t.end(a))+"]";return n}else return"(empty)"},f.Log=l;var h=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};h.prototype.getPosition=function(){return this.position},h.prototype.getEndPosition=function(){return this.buffer.byteLength},h.prototype.getLength=function(){return this.buffer.byteLength},h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},h.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},h.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},h.prototype.readUint8=function(){return this.readAnyInt(1,!1)},h.prototype.readUint16=function(){return this.readAnyInt(2,!1)},h.prototype.readUint24=function(){return this.readAnyInt(3,!1)},h.prototype.readUint32=function(){return this.readAnyInt(4,!1)},h.prototype.readUint64=function(){return this.readAnyInt(8,!1)},h.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},h.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},h.prototype.readInt8=function(){return this.readAnyInt(1,!0)},h.prototype.readInt16=function(){return this.readAnyInt(2,!0)},h.prototype.readInt32=function(){return this.readAnyInt(4,!0)},h.prototype.readInt64=function(){return this.readAnyInt(8,!1)},h.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},h.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},h.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},h.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},h.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},f.MP4BoxStream=h;var u=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??u.LITTLE_ENDIAN};u.prototype={},u.prototype.getPosition=function(){return this.position},u.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var a=new ArrayBuffer(n),d=new Uint8Array(this._buffer),g=new Uint8Array(a,0,d.length);g.set(d),this.buffer=a,this._byteLength=e}},u.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},u.BIG_ENDIAN=!1,u.LITTLE_ENDIAN=!0,u.prototype._byteLength=0,Object.defineProperty(u.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(u.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},u.prototype.isEof=function(){return this.position>=this._byteLength},u.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},u.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},u.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},u.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,u.memcpy=function(t,e,n,a,d){var g=new Uint8Array(t,e,d),y=new Uint8Array(n,a,d);g.set(y)},u.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},u.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},u.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var a=n+t.BYTES_PER_ELEMENT-1,d=n;a>d;a--,d++){var g=e[d];e[d]=e[a],e[a]=g}return t},u.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},u.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},u.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),a=e;t!=null&&(a=Math.min(t,e));for(var d=0;d<a&&n[d]!==0;d++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(d)]);return t!=null?this.position+=a-d:d!=e&&(this.position+=1),g};var p=Math.pow(2,32);u.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},u.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},f.DataStream=u,u.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",n),a.setAttribute("download",t),a.setAttribute("target","_self"),a.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},u.prototype._dynamicSize=!0,Object.defineProperty(u.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),u.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),a=new Uint8Array(this._buffer,t,n.length);n.set(a),this.buffer=e,this.position-=t},u.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},u.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},u.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},u.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},u.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},u.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},u.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},u.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},u.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},u.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},u.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},u.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var a=0;a<t.length&&a<n;a++)this.writeUint16(t.charCodeAt(a),e);for(;a<n;a++)this.writeUint16(0)},u.prototype.writeString=function(t,e,n){var a=0;if(e==null||e=="ASCII")if(n!=null){var d=Math.min(t.length,n);for(a=0;a<d;a++)this.writeUint8(t.charCodeAt(a));for(;a<n;a++)this.writeUint8(0)}else for(a=0;a<t.length;a++)this.writeUint8(t.charCodeAt(a));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},u.prototype.writeCString=function(t,e){var n=0;if(e!=null){var a=Math.min(t.length,e);for(n=0;n<a;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},u.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var a=t[n+1];this.writeType(a,e[t[n]],e)}},u.prototype.writeType=function(t,e,n){var a;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var d=null,g="ASCII",y=this.position;switch(typeof t=="string"&&/:/.test(t)&&(a=t.split(":"),t=a[0],d=parseInt(a[1])),typeof t=="string"&&/,/.test(t)&&(a=t.split(","),t=a[0],g=parseInt(a[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,u.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,u.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,u.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,u.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,u.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,u.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,u.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,u.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,u.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,u.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,u.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,u.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,d);break;case"string":this.writeString(e,g,d);break;case"u16string":this.writeUCS2String(e,this.endianness,d);break;case"u16stringle":this.writeUCS2String(e,u.LITTLE_ENDIAN,d);break;case"u16stringbe":this.writeUCS2String(e,u.BIG_ENDIAN,d);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}d!=null&&(this.position=y,this._realloc(d),this.position=y+d)},u.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},u.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},u.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},u.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*8,n},u.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new u(new ArrayBuffer,0,u.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var a;return a=new Uint8Array(n),a.set(new Uint8Array(t,e,n)),a.buffer.fileStart=t.fileStart+e,a.buffer.usedBytes=0,a.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var a=this.buffers[n];if(t.fileStart<=a.fileStart){if(t.fileStart===a.fileStart)if(t.byteLength>a.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=a.fileStart||(t=this.reduceBuffer(t,0,a.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<a.fileStart+a.byteLength){var d=a.fileStart+a.byteLength-t.fileStart,g=t.byteLength-d;if(g>0)t=this.reduceBuffer(t,d,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,a,d,g=[],y,w="";for(a=0,d=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(y={},g.push(y),y.start=n.fileStart,y.end=n.fileStart+n.byteLength,w+="["+y.start+"-"):y.end===n.fileStart?y.end=n.fileStart+n.byteLength:(y={},y.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+y.start+"-",y.end=n.fileStart+n.byteLength,g.push(y)),a+=n.usedBytes,d+=n.byteLength;g.length>0&&(w+=y.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+a+"/"+d+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,a=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=a,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var a,d=null,g=-1;for(t===!0?a=0:a=this.bufferIndex;a<this.buffers.length&&(d=this.buffers[a],d.fileStart<=e);){g=a,n&&(d.fileStart+d.byteLength<=e?d.usedBytes=d.byteLength:d.usedBytes=e-d.fileStart,this.logBufferLevel());a++}return g!==-1?(d=this.buffers[g],d.fileStart+d.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,a,d=t!==void 0?t:this.bufferIndex;if(n=this.buffers[d],this.buffers.length>d+1)for(e=d+1;e<this.buffers.length&&(a=this.buffers[e],a.fileStart===n.fileStart+n.byteLength);e++)n=a;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var a;return a=this.findPosition(e,t,n),a!==-1?(this.buffer=this.buffers[a],this.bufferIndex=a,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},f.MultiBufferStream=_;var v=function(){var t=3,e=4,n=5,a=6,d=[];d[t]="ES_Descriptor",d[e]="DecoderConfigDescriptor",d[n]="DecoderSpecificInfo",d[a]="SLConfigDescriptor",this.getDescriptorName=function(w){return d[w]};var g=this,y={};return this.parseOneDescriptor=function(w){var S=0,L,k,F;for(L=w.readUint8(),F=w.readUint8();F&128;)S=(F&127)<<7,F=w.readUint8();return S+=F&127,l.debug("MPEG4DescriptorParser","Found "+(d[L]||"Descriptor "+L)+", size "+S+" at position "+w.getPosition()),d[L]?k=new y[d[L]](S):k=new y.Descriptor(S),k.parse(w),k},y.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},y.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},y.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},y.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var L=g.parseOneDescriptor(w);this.descs.push(L)}},y.ES_Descriptor=function(w){y.Descriptor.call(this,t,w)},y.ES_Descriptor.prototype=new y.Descriptor,y.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},y.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},y.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var L=S.findDescriptor(n);if(L&&L.data){var k=(L.data[0]&248)>>3;return k===31&&L.data.length>=2&&(k=32+((L.data[0]&7)<<3)+((L.data[1]&224)>>5)),k}else return null},y.DecoderConfigDescriptor=function(w){y.Descriptor.call(this,e,w)},y.DecoderConfigDescriptor.prototype=new y.Descriptor,y.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},y.DecoderSpecificInfo=function(w){y.Descriptor.call(this,n,w)},y.DecoderSpecificInfo.prototype=new y.Descriptor,y.SLConfigDescriptor=function(w){y.Descriptor.call(this,a,w)},y.SLConfigDescriptor.prototype=new y.Descriptor,this};f.MPEG4DescriptorParser=v;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,a){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=a},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(a){s.ContainerBox.call(this,t,a),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(a,d){s.SampleEntry.call(this,a,d),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,a){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(d){s[t+"SampleEntry"].call(this,e,d),s.addSubBoxArrays.call(this,a)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,a){s.UUIDs.push(t),s.UUIDBoxes[t]=function(d){e?s.FullBox.call(this,"uuid",d,t):n?s.ContainerBox.call(this,"uuid",d,t):s.Box.call(this,"uuid",d,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,a&&(e?s.UUIDBoxes[t].prototype.parse=function(d){this.parseFullHeader(d),a&&a.call(this,d)}:s.UUIDBoxes[t].prototype.parse=a)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},f.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var a=t.readUint8().toString(16);e+=a.length===1?"0"+a:a}return e},s.parseOneBox=function(t,e,n){var a,d=t.getPosition(),g=0,y,w;if(t.getEndPosition()-d<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),L=t.readString(4),k=L;if(l.debug("BoxParser","Found box of type '"+L+"' and size "+S+" at position "+d),g=8,L=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(d),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,k=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(d),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+L+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(L!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+L+"'"),a=new s.Box(L,S),{code:s.OK,box:a,size:a.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+L+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+L+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):S!==0&&d+S>t.getEndPosition()?(t.seek(d),l.info("BoxParser","Not enough data in stream to parse the entire '"+L+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):e?{code:s.OK,type:L,size:S,hdr_size:g,start:d}:(s[L+"Box"]?a=new s[L+"Box"](S):L!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+L+"'"),a=new s.Box(L,S),a.has_unparsed_data=!0):s.UUIDBoxes[w]?a=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),a=new s.Box(L,S),a.uuid=w,a.has_unparsed_data=!0),a.hdr_size=g,a.start=d,a.write===s.Box.prototype.write&&a.type!=="mdat"&&(l.info("BoxParser","'"+k+"' box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),y=t.getPosition()-(a.start+a.size),y<0?(l.warn("BoxParser","Parsing of box '"+k+"' did not read the entire indicated box data size (missing "+-y+" bytes), seeking forward"),t.seek(a.start+a.size)):y>0&&(l.error("BoxParser","Parsing of box '"+k+"' read "+y+" more bytes than the indicated box data size, seeking backwards"),a.size!==0&&t.seek(a.start+a.size)),{code:s.OK,box:a,size:a.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var a=n.type!=="uuid"?n.type:n.uuid;this[a]?l.warn("Box of type "+a+" already stored in field of this type"):this[a]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var a=0;a<3;a++)n==16?this.layer_size[a]=t.readUint16():this.layer_size[a]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var a=t.readInt32();a<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(a)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),a=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|a>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var a={};this.ind_subs.push(a);var d=t.readUint8(),g=t.readUint8(),y=t.readUint8();a.fscod=d>>6,a.bsid=d>>1&31,a.bsmod=(d&1)<<4|g>>4&15,a.acmod=g>>1&7,a.lfeon=g&1,a.num_dep_sub=y>>1&15,a.num_dep_sub>0&&(a.chan_loc=(y&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,a=[],d=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),y=Math.min(g&e,d.length-1);if(y?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),a.push(d[y]),g&n)break}while(!0);this.numMetadataBlocks=a.length+" ("+a.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var a=t.readUint32(),d=0;d<a;d++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),this.version===1?(a.segment_duration=t.readUint64(),a.media_time=t.readInt64()):(a.segment_duration=t.readUint32(),a.media_time=t.readInt32()),a.media_rate_integer=t.readInt16(),a.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var a=n.readUint32();this.entity_ids.push(a)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof v<"u"){var n=new v;this.esd=n.parseOneDescriptor(new u(e.buffer,0,u.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,a,d;this.configurationVersion=t.readUint8(),d=t.readUint8(),this.general_profile_space=d>>6,this.general_tier_flag=(d&32)>>5,this.general_profile_idc=d&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),d=t.readUint8(),this.constantFrameRate=d>>6,this.numTemporalLayers=(d&13)>>3,this.temporalIdNested=(d&4)>>2,this.lengthSizeMinusOne=d&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var y=[];this.nalu_arrays.push(y),d=t.readUint8(),y.completeness=(d&128)>>7,y.nalu_type=d&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};y.push(S),a=t.readUint16(),S.data=t.readUint8Array(a)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var a=0;a<n;a++){var d={};if(this.items.push(d),this.version<2)d.item_ID=t.readUint16();else if(this.version===2)d.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?d.construction_method=t.readUint16()&15:d.construction_method=0,d.data_reference_index=t.readUint16(),this.base_offset_size){case 0:d.base_offset=0;break;case 4:d.base_offset=t.readUint32();break;case 8:d.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();d.extents=[];for(var y=0;y<g;y++){var w={};if(d.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var a={};this.associations.push(a),this.version<1?a.id=t.readUint16():a.id=t.readUint32();var d=t.readUint8();for(a.props=[],n=0;n<d;n++){var g=t.readUint8(),y={};a.props.push(y),y.essential=(g&128)>>7===1,this.flags&1?y.property_index=(g&127)<<8|t.readUint8():y.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var a={};this.levels[n]=a,a.track_ID=t.readUint32();var d=t.readUint8();switch(a.padding_flag=d>>7,a.assignment_type=d&127,a.assignment_type){case 0:a.grouping_type=t.readString(4);break;case 1:a.grouping_type=t.readString(4),a.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:a.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,a;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,a=t.readUint8(),this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var d=t.readUint8();for(e=0;e<d;e++){var g=[];this.nalu_arrays.push(g),a=t.readUint8(),g.completeness=(a&128)>>7,g.nalu_type=a&63;var y=t.readUint16();for(n=0;n<y;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var a=t.readUint32();a>0&&(this.data=t.readUint8Array(a))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var a=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<a/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),a=0;a<n;a++){var d={};this.dependency.push(d),d.subSeqDirectionFlag=t.readUint8(),d.layerNumber=t.readUint8(),d.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),a.sample_count=t.readInt32(),a.group_description_index=t.readInt32()}});function A(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}A.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var a=t.readUint32(),d=t.readUint32();this.bad_pixels.push(new A(a,d))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var a=0;a<n;a++)e=t.readUint8(),this.is_leading[a]=e>>6,this.sample_depends_on[a]=e>>4&3,this.sample_is_depended_on[a]=e>>2&3,this.sample_has_redundancy[a]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a;s[this.grouping_type+"SampleGroupEntry"]?a=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):a=new s.SampleGroupEntry(this.grouping_type),this.entries.push(a),this.version===1?this.default_length===0?a.description_length=t.readUint32():a.description_length=this.default_length:a.description_length=this.default_length,a.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),a.data=t.readUint8Array(a.description_length),t.position-=a.description_length),a.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var a={};this.references.push(a);var d=t.readUint32();a.reference_type=d>>31&1,a.referenced_size=d&2147483647,a.subsegment_duration=t.readUint32(),d=t.readUint32(),a.starts_with_SAP=d>>31&1,a.SAP_type=d>>28&7,a.SAP_delta_time=d&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.subsegments.push(a),a.ranges=[];for(var d=t.readUint32(),g=0;g<d;g++){var y={};a.ranges.push(y),y.level=t.readUint8(),y.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,a,d;for(this.entries=[],a=t.readUint32(),e=1;e<=a;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(d=new s[n.type+"SampleEntry"](n.size),d.hdr_size=n.hdr_size,d.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),d=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),d.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+d.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(t)),d.parse(t),this.entries.push(d);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,a;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),a=t.readInt32(),a<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),a=1),this.sample_deltas.push(a)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var a,d;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(a=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),a.code===s.OK)d=a.box,this.boxes.push(d),this[d.type]=d;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var a=t.readUint8();this.sample_sizes[e]=a>>4&15,this.sample_sizes[e+1]=a&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,a,d;for(a=t.readUint32(),this.entries=[],e=0;e<a;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],d=t.readUint16(),d>0)for(n=0;n<d;n++){var y={};g.subsamples.push(y),this.version==1?y.size=t.readUint32():y.size=t.readUint16(),y.priority=t.readUint8(),y.discardable=t.readUint8(),y.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),a=0;a<n;a++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},a=0,d=0;this.version===1?(a=t.readUint64(),d=t.readUint64()):(a=t.readUint32(),d=t.readUint32()),n.absolute_time=a,n.absolute_duration=d,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,a={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(R){this.held_bits=R.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(R){this.held_bits=R.readUint16(),this.num_held_bits=16},extract_bits:function(R){var lt=this.held_bits>>this.num_held_bits-R&(1<<R)-1;return this.num_held_bits-=R,lt}};if(a.stream_read_1_bytes(t),a.extract_bits(5),this.lengthSizeMinusOne=a.extract_bits(2),this.ptl_present_flag=a.extract_bits(1),this.ptl_present_flag){a.stream_read_2_bytes(t),this.ols_idx=a.extract_bits(9),this.num_sublayers=a.extract_bits(3),this.constant_frame_rate=a.extract_bits(2),this.chroma_format_idc=a.extract_bits(2),a.stream_read_1_bytes(t),this.bit_depth_minus8=a.extract_bits(3),a.extract_bits(5);{if(a.stream_read_2_bytes(t),a.extract_bits(2),this.num_bytes_constraint_info=a.extract_bits(6),this.general_profile_idc=a.extract_bits(7),this.general_tier_flag=a.extract_bits(1),this.general_level_idc=t.readUint8(),a.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=a.extract_bits(1),this.ptl_multilayer_enabled_flag=a.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var d=a.extract_bits(6);a.stream_read_1_bytes(t);var g=a.extract_bits(2);this.general_constraint_info[e]=d<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=a.extract_bits(6)}else a.extract_bits(6);if(this.num_sublayers>1){for(a.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var y=a.extract_bits(1);this.ptl_sublayer_present_mask|=y<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)a.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var L=t.readUint8();for(e=0;e<L;e++){var k=[];this.nalu_arrays.push(k),a.stream_read_1_bytes(t),k.completeness=a.extract_bits(1),a.extract_bits(2),k.nalu_type=a.extract_bits(5);var F=1;for(k.nalu_type!=S&&k.nalu_type!=w&&(F=t.readUint16()),n=0;n<F;n++){var G=t.readUint16();k.push({data:t.readUint8Array(G),length:G})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,a=0;for(t=0;t<32&&(a|=n&1,t!=31);t++)a<<=1,n>>=1;e+=s.decimalToHex(a,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var d=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||d)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,d=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var a=[],d=0;d|=this.vvcC.ptl_frame_only_constraint<<7,d|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)d|=this.vvcC.general_constraint_info[t]>>2&63,a.push(d),d&&(g=t),d=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var y="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|a[t],S+=8;S>=5;){var L=w>>S-5&31;n+=y[L],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=y[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[a].pts=t[a].dts+this.sample_offsets[e],a++},s.sttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)a===0?t[a].dts=0:t[a].dts=t[a-1].dts+this.sample_deltas[e],a++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,a,d,g;for(d=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,a=0;a<this.samples_per_chunk[e];a++){if(t[d])t[d].description_index=this.sample_description_index[e],t[d].chunk_index=g;else return;d++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var a=s.DIFF_BOXES_PROP_NAMES[n];if(t[a]&&e[a]&&!s.boxEqual(t[a],e[a]))return!1}return!0};var I=function(){};I.prototype.parseSample=function(t){var e={},n;e.resources=[];var a=new h(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=a.readString(t.data.length);else if(e.documentString=a.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=a.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var B=function(){};B.prototype.parseSample=function(t){var e,n=new h(t.data.buffer);return e=n.readString(t.data.length),e},B.prototype.parseConfig=function(t){var e,n=new h(t.buffer);return n.readUint32(),e=n.readCString(),e},f.XMLSubtitlein4Parser=I,f.Textin4Parser=B;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var d={};this.fragmentedTracks.push(d),d.id=t,d.user=e,d.trak=a,a.nextSample=0,d.segmentStream=null,d.nb_samples=1e3,d.rapAlignement=!0,n&&(n.nbSamples&&(d.nb_samples=n.nbSamples),n.rapAlignement&&(d.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var a=this.fragmentedTracks[n];a.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var d={};this.extractedTracks.push(d),d.id=t,d.user=e,d.trak=a,a.nextSample=0,d.nb_samples=1e3,d.samples=[],n&&n.nbSamples&&(d.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var a=this.extractedTracks[n];a.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var a;switch(e=t.box,a=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),a){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[a]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+a+", overriding previous occurrence"),this[a]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},a,d,g,y,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=this.moov.traks[t],y=a.mdia.minf.stbl.stsd.entries[0],d={},n.tracks.push(d),d.id=a.tkhd.track_id,d.name=a.mdia.hdlr.name,d.references=[],a.tref)for(e=0;e<a.tref.boxes.length;e++)g={},d.references.push(g),g.type=a.tref.boxes[e].type,g.track_ids=a.tref.boxes[e].track_ids;a.edts&&(d.edits=a.edts.elst.entries),d.created=new Date(w+a.tkhd.creation_time*1e3),d.modified=new Date(w+a.tkhd.modification_time*1e3),d.movie_duration=a.tkhd.duration,d.movie_timescale=n.timescale,d.layer=a.tkhd.layer,d.alternate_group=a.tkhd.alternate_group,d.volume=a.tkhd.volume,d.matrix=a.tkhd.matrix,d.track_width=a.tkhd.width/65536,d.track_height=a.tkhd.height/65536,d.timescale=a.mdia.mdhd.timescale,d.cts_shift=a.mdia.minf.stbl.cslg,d.duration=a.mdia.mdhd.duration,d.samples_duration=a.samples_duration,d.codec=y.getCodec(),d.kind=a.udta&&a.udta.kinds.length?a.udta.kinds[0]:{schemeURI:"",value:""},d.language=a.mdia.elng?a.mdia.elng.extended_language:a.mdia.mdhd.languageString,d.nb_samples=a.samples.length,d.size=a.samples_size,d.bitrate=d.size*8*d.timescale/d.samples_duration,y.isAudio()?(d.type="audio",n.audioTracks.push(d),d.audio={},d.audio.sample_rate=y.getSampleRate(),d.audio.channel_count=y.getChannelCount(),d.audio.sample_size=y.getSampleSize()):y.isVideo()?(d.type="video",n.videoTracks.push(d),d.video={},d.video.width=y.getWidth(),d.video.height=y.getHeight()):y.isSubtitle()?(d.type="subtitles",n.subtitleTracks.push(d)):y.isHint()?(d.type="metadata",n.hintTracks.push(d)):y.isMetadata()?(d.type="metadata",n.metadataTracks.push(d)):(d.type="metadata",n.otherTracks.push(d))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var a=this.fragmentedTracks[e];for(n=a.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+a.id+" for sample "+n.nextSample);var d=this.createFragment(a.id,n.nextSample,a.segmentStream);if(d)a.segmentStream=d,n.nextSample++;else break;if((n.nextSample%a.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+a.id+" for samples ["+Math.max(0,n.nextSample-a.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(a.id,a.user,a.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),a.segmentStream=null,a!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var y=this.getSample(n,n.nextSample);if(y)n.nextSample++,g.samples.push(y);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var a in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[a],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),a=this.getSample(n,e);return a},U.prototype.releaseUsedSamples=function(t,e){var n=0,a=this.getTrackById(t);a.lastValidSample||(a.lastValidSample=0);for(var d=a.lastValidSample;d<e;d++)n+=this.releaseSample(a,d);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),a.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var a,d,g=1/0,y=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(a=0;a<n.samples.length;a++){if(d=n.samples[a],a===0)w=0,S=d.timescale;else if(d.cts>t*d.timescale){w=a-1;break}e&&d.is_sync&&(y=a)}for(e&&(w=y),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,a,d,g,y={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)a=n.traks[g],!(t>this.getTrackDuration(a))&&(d=this.seekTrack(t,e,a),d.offset<y.offset&&(y.offset=d.offset),d.time<y.time&&(y.time=d.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(y.time,1)+" needs a buffer with a fileStart position of "+y.offset),y.offset===1/0?y={offset:this.nextParsePosition,time:0}:y.offset=this.stream.getEndFilePositionAfter(y.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+y.offset),y}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],a=t.boxes[e];if(!s.boxEqual(n,a))return!1;e++}return!0},f.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,a;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,a=this.stream.seek(e.start+e.size,!1,this.discardMdatData),a?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var a=n.add("mdia");a.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),a.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),a.add("elng").set("extended_language",e.language||"fr-FR");var d=a.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var y="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],L=0;L<S.length;L++)if(S.indexOf(e.type)>-1){y=w;break}switch(y){case"Visual":if(d.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var k=new s.avcCBox;k.parse(new h(e.avcDecoderConfigRecord)),g.addBox(k)}else if(e.hevcDecoderConfigRecord){var F=new s.hvcCBox;F.parse(new h(e.hevcDecoderConfigRecord)),g.addBox(F)}break;case"Audio":d.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":d.add("hmhd");break;case"Subtitle":switch(d.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":d.add("nmhd");break;case"System":d.add("nmhd");break;default:d.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(R){g.addBox(R)}),d.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var G=d.add("stbl");return G.add("stsd").addEntry(g),G.add("stts").set("sample_counts",[]).set("sample_deltas",[]),G.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),G.add("stco").set("chunk_offsets",[]),G.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new u;e.endianness=u.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var a=n||{},d={},g=this.getTrackById(t);if(g!==null){d.number=g.samples.length,d.track_id=g.tkhd.track_id,d.timescale=g.mdia.mdhd.timescale,d.description_index=a.sample_description_index?a.sample_description_index-1:0,d.description=g.mdia.minf.stbl.stsd.entries[d.description_index],d.data=e,d.size=e.byteLength,d.alreadyRead=d.size,d.duration=a.duration||1,d.cts=a.cts||0,d.dts=a.dts||0,d.is_sync=a.is_sync||!1,d.is_leading=a.is_leading||0,d.depends_on=a.depends_on||0,d.is_depended_on=a.is_depended_on||0,d.has_redundancy=a.has_redundancy||0,d.degradation_priority=a.degradation_priority||0,d.offset=0,d.subsamples=a.subsamples,g.samples.push(d),g.samples_size+=d.size,g.samples_duration+=d.duration,g.first_dts===void 0&&(g.first_dts=a.dts),this.processSamples();var y=this.createSingleSampleMoof(d);return this.addBox(y),y.computeSize(),y.trafs[0].truns[0].data_offset=y.size+8,this.add("mdat").data=new Uint8Array(e),d}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var a=n.add("traf"),d=this.getTrackById(t.track_id);return a.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),a.add("tfdt").set("baseMediaDecodeTime",t.dts-(d.first_dts||0)),a.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,a,d,g,y,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],a=e.mdia.minf.stbl.stsc,a.first_chunk=[],a.samples_per_chunk=[],a.sample_description_index=[],d=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,d.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],y=e.mdia.minf.stbl.ctts,y&&(y.sample_counts=[],y.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,a,d){var g,y,w,S;function L(k,F,G){this.grouping_type=k,this.grouping_type_parameter=F,this.sbgp=G,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),y=0;y<n.length;y++){for(S=n[y].grouping_type+"/"+n[y].grouping_type_parameter,w=new L(n[y].grouping_type,n[y].grouping_type_parameter,n[y]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<a.length;g++)a[g].grouping_type===n[y].grouping_type&&(w.description=a[g],w.description.used=!0);if(d)for(g=0;g<d.length;g++)d[g].grouping_type===n[y].grouping_type&&(w.fragment_description=d[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(d)for(y=0;y<d.length;y++)!d[y].used&&d[y].version>=2&&(S=d[y].grouping_type+"/0",w=new L(d[y].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(y=0;y<a.length;y++)!a[y].used&&a[y].version>=2&&(S=a[y].grouping_type+"/0",w=new L(a[y].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,a){var d,g;e.sample_groups=[];for(d in a)if(e.sample_groups[d]={},e.sample_groups[d].grouping_type=a[d].grouping_type,e.sample_groups[d].grouping_type_parameter=a[d].grouping_type_parameter,n>=a[d].last_sample_in_run&&(a[d].last_sample_in_run<0&&(a[d].last_sample_in_run=0),a[d].entry_index++,a[d].entry_index<=a[d].sbgp.entries.length-1&&(a[d].last_sample_in_run+=a[d].sbgp.entries[a[d].entry_index].sample_count)),a[d].entry_index<=a[d].sbgp.entries.length-1?e.sample_groups[d].group_description_index=a[d].sbgp.entries[a[d].entry_index].group_description_index:e.sample_groups[d].group_description_index=-1,e.sample_groups[d].group_description_index!==0){var y;a[d].fragment_description?y=a[d].fragment_description:y=a[d].description,e.sample_groups[d].group_description_index>0?(e.sample_groups[d].group_description_index>65535?g=(e.sample_groups[d].group_description_index>>16)-1:g=e.sample_groups[d].group_description_index-1,y&&g>=0&&(e.sample_groups[d].description=y.entries[g])):y&&y.version>=2&&y.default_group_description_index>0&&(e.sample_groups[d].description=y.entries[y.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,a,d,g,y,w,S,L,k,F,G,R,lt,st,bt,V,Yt,Tt,Nt,it,Y,K,at;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,a=t.mdia.minf.stbl.stsc,d=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,y=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,L=t.mdia.minf.stbl.subs,G=t.mdia.minf.stbl.stdp,k=t.mdia.minf.stbl.sbgps,F=t.mdia.minf.stbl.sgpds,Yt=-1,Tt=-1,Nt=-1,it=-1,Y=0,K=0,at=0,U.initSampleGroups(t,null,k,F),!(typeof d>"u")){for(e=0;e<d.sample_sizes.length;e++){var X={};X.number=e,X.track_id=t.tkhd.track_id,X.timescale=t.mdia.mdhd.timescale,X.alreadyRead=0,t.samples[e]=X,X.size=d.sample_sizes[e],t.samples_size+=X.size,e===0?(lt=1,R=0,X.chunk_index=lt,X.chunk_run_index=R,V=a.samples_per_chunk[R],bt=0,R+1<a.first_chunk.length?st=a.first_chunk[R+1]-1:st=1/0):e<V?(X.chunk_index=lt,X.chunk_run_index=R):(lt++,X.chunk_index=lt,bt=0,lt<=st||(R++,R+1<a.first_chunk.length?st=a.first_chunk[R+1]-1:st=1/0),X.chunk_run_index=R,V+=a.samples_per_chunk[R]),X.description_index=a.sample_description_index[X.chunk_run_index]-1,X.description=S.entries[X.description_index],X.offset=n.chunk_offsets[X.chunk_index-1]+bt,bt+=X.size,e>Yt&&(Tt++,Yt<0&&(Yt=0),Yt+=g.sample_counts[Tt]),e>0?(t.samples[e-1].duration=g.sample_deltas[Tt],t.samples_duration+=t.samples[e-1].duration,X.dts=t.samples[e-1].dts+t.samples[e-1].duration):X.dts=0,y?(e>=Nt&&(it++,Nt<0&&(Nt=0),Nt+=y.sample_counts[it]),X.cts=t.samples[e].dts+y.sample_offsets[it]):X.cts=X.dts,w?(e==w.sample_numbers[Y]-1?(X.is_sync=!0,Y++):(X.is_sync=!1,X.degradation_priority=0),L&&L.entries[K].sample_delta+at==e+1&&(X.subsamples=L.entries[K].subsamples,at+=L.entries[K].sample_delta,K++)):X.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,X,X.number),G?X.degradation_priority=G.priority[e]:X.degradation_priority=0,L&&L.entries[K].sample_delta+at==e&&(X.subsamples=L.entries[K].subsamples,at+=L.entries[K].sample_delta),(k.length>0||F.length>0)&&U.setSampleGroupProperties(t,X,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,a,d,g,y,w,S,L,k,F,G,R,lt;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(L=S,t=0;t<L.trafs.length;t++){for(k=L.trafs[t],F=this.getTrackById(k.tfhd.track_id),G=this.getTrexById(k.tfhd.track_id),k.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?a=k.tfhd.default_sample_description_index:a=G?G.default_sample_description_index:1,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?d=k.tfhd.default_sample_duration:d=G?G.default_sample_duration:0,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=k.tfhd.default_sample_size:g=G?G.default_sample_size:0,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?y=k.tfhd.default_sample_flags:y=G?G.default_sample_flags:0,k.sample_number=0,k.sbgps.length>0&&U.initSampleGroups(F,k,k.sbgps,F.mdia.minf.stbl.sgpds,k.sgpds),e=0;e<k.truns.length;e++){var st=k.truns[e];for(n=0;n<st.sample_count;n++){R={},R.moof_number=this.lastMoofIndex,R.number_in_traf=k.sample_number,k.sample_number++,R.number=F.samples.length,k.first_sample_index=F.samples.length,F.samples.push(R),R.track_id=F.tkhd.track_id,R.timescale=F.mdia.mdhd.timescale,R.description_index=a-1,R.description=F.mdia.minf.stbl.stsd.entries[R.description_index],R.size=g,st.flags&s.TRUN_FLAGS_SIZE&&(R.size=st.sample_size[n]),F.samples_size+=R.size,R.duration=d,st.flags&s.TRUN_FLAGS_DURATION&&(R.duration=st.sample_duration[n]),F.samples_duration+=R.duration,F.first_traf_merged||n>0?R.dts=F.samples[F.samples.length-2].dts+F.samples[F.samples.length-2].duration:(k.tfdt?R.dts=k.tfdt.baseMediaDecodeTime:R.dts=0,F.first_traf_merged=!0),R.cts=R.dts,st.flags&s.TRUN_FLAGS_CTS_OFFSET&&(R.cts=R.dts+st.sample_composition_time_offset[n]),lt=y,st.flags&s.TRUN_FLAGS_FLAGS?lt=st.sample_flags[n]:n===0&&st.flags&s.TRUN_FLAGS_FIRST_FLAG&&(lt=st.first_sample_flags),R.is_sync=!(lt>>16&1),R.is_leading=lt>>26&3,R.depends_on=lt>>24&3,R.is_depended_on=lt>>22&3,R.has_redundancy=lt>>20&3,R.degradation_priority=lt&65535;var bt=!!(k.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),V=!!(k.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Yt=!!(st.flags&s.TRUN_FLAGS_DATA_OFFSET),Tt=0;bt?Tt=k.tfhd.base_data_offset:V||e===0?Tt=L.start:Tt=w,e===0&&n===0?Yt?R.offset=Tt+st.data_offset:R.offset=Tt:R.offset=w,w=R.offset+R.size,(k.sbgps.length>0||k.sgpds.length>0||F.mdia.minf.stbl.sbgps.length>0||F.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(F,R,R.number_in_traf,k.sample_groups_info)}}if(k.subs){F.has_fragment_subsamples=!0;var Nt=k.first_sample_index;for(e=0;e<k.subs.entries.length;e++)Nt+=k.subs.entries[e].sample_delta,R=F.samples[Nt-1],R.subsamples=k.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,a=t.samples[e];if(!this.moov)return null;if(!a.data)a.data=new Uint8Array(a.size),a.alreadyRead=0,this.samplesDataSize+=a.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+a.size+" (total: "+this.samplesDataSize+")");else if(a.alreadyRead==a.size)return a;for(;;){var d=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(d>-1){n=this.stream.buffers[d];var g=n.byteLength-(a.offset+a.alreadyRead-n.fileStart);if(a.size-a.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+(a.size-a.alreadyRead)+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,a.size-a.alreadyRead),n.usedBytes+=a.size-a.alreadyRead,this.stream.logBufferLevel(),a.alreadyRead=a.size,a;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,g),a.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,a,d,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)d={},d.id=g.iinf.item_infos[n].item_ID,t[d.id]=d,d.ref_to=[],d.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(d.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?d.type=g.iinf.item_infos[n].item_type:d.type="mime",d.content_type=g.iinf.item_infos[n].content_type,d.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var y=g.iloc.items[n];switch(d=t[y.item_ID],y.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),d.source=g.dinf.boxes[y.data_reference_index-1]),y.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(d.extents=[],d.size=0,a=0;a<y.extents.length;a++)d.extents[a]={},d.extents[a].offset=y.extents[a].extent_offset+y.base_offset,d.extents[a].length=y.extents[a].extent_length,d.extents[a].alreadyRead=0,d.size+=d.extents[a].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(a=0;a<w.references.length;a++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[a]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var L=g.iprp.ipmas[S];for(n=0;n<L.associations.length;n++){var k=L.associations[n];if(d=t[k.id],d||(d=e[k.id]),d)for(d.properties===void 0&&(d.properties={},d.properties.boxes=[]),a=0;a<k.props.length;a++){var F=k.props[a];if(F.property_index>0&&F.property_index-1<g.iprp.ipco.boxes.length){var G=g.iprp.ipco.boxes[F.property_index-1];d.properties[G.type]=G,d.properties.boxes.push(G)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var a=0;a<n.extents.length;a++){var d=n.extents[a];if(d.alreadyRead!==d.length){var g=this.stream.findPosition(!0,d.offset+d.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var y=e.byteLength-(d.offset+d.alreadyRead-e.fileStart);if(d.length-d.alreadyRead<=y)l.debug("ISOFile","Getting item #"+t+" extent #"+a+" data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-e.fileStart)+" read size: "+(d.length-d.alreadyRead)+" full extent size: "+d.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,d.offset+d.alreadyRead-e.fileStart,d.length-d.alreadyRead),e.usedBytes+=d.length-d.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=d.length-d.alreadyRead,d.alreadyRead=d.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+a+" partial data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-e.fileStart)+" read size: "+y+" full extent size: "+d.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,d.offset+d.alreadyRead-e.fileStart,y),d.alreadyRead+=y,n.alreadyRead+=y,e.usedBytes+=y,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var a=e.extents[n];a.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var a=new U;a.discardMdatData=!1;var d={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(d.width=n.properties.ispe.image_width,d.height=n.properties.ispe.image_height);var g=a.addTrack(d);return g?(a.addSample(g,n.data),a):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var a=this.getTrackById(t),d=this.getSample(a,e);if(d==null)return this.setNextSeekPositionFromSample(a.samples[e]),null;var g=n||new u;g.endianness=u.BIG_ENDIAN;var y=this.createSingleSampleMoof(d);y.write(g),y.trafs[0].truns[0].data_offset=y.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+y.trafs[0].truns[0].data_offset),g.adjustUint32(y.trafs[0].truns[0].data_offset_position,y.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=d.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,a){var d;l.debug("ISOFile","Generating initialization segment");var g=new u;g.endianness=u.BIG_ENDIAN,t.write(g);var y=e.add("mvex");for(n&&y.add("mehd").set("fragment_duration",n),d=0;d<e.traks.length;d++)y.add("trex").set("track_id",e.traks[d].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",a).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new u;e.endianness=u.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new u;return t.endianness=u.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,a;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var d=new s.moovBox;d.mvhd=this.moov.mvhd,d.boxes.push(d.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),d.boxes.push(n),d.traks.push(n),a={},a.id=n.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=U.writeInitializationSegment(this.ftyp,d,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(a)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var N={};N.createFile=function(t,e){var n=t!==void 0?t:!0,a=new U(e);return a.discardMdatData=!n,a},f.createFile=N.createFile})(xc);const Th=vc(xc);var bc={};(function(f){var l=function(){var t=new Date,e=4,n=3,a=2,d=1,g=e,y={setLogLevel:function(w){w==this.debug?g=d:w==this.info?g=a:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),d>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){a>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return y}();l.getDurationString=function(t,e){var n;function a(L,k){for(var F=""+L,G=F.split(".");G[0].length<k;)G[0]="0"+G[0];return G.join(".")}t<0?(n=!0,t=-t):n=!1;var d=e||1,g=t/d,y=Math.floor(g/3600);g-=y*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+y+":"+a(w,2)+":"+a(g,2)+"."+a(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",a=0;a<e;a++)a>0&&(n+=","),n+="["+l.getDurationString(t.start(a))+","+l.getDurationString(t.end(a))+"]";return n}else return"(empty)"},f.Log=l;var h=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};h.prototype.getPosition=function(){return this.position},h.prototype.getEndPosition=function(){return this.buffer.byteLength},h.prototype.getLength=function(){return this.buffer.byteLength},h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},h.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},h.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},h.prototype.readUint8=function(){return this.readAnyInt(1,!1)},h.prototype.readUint16=function(){return this.readAnyInt(2,!1)},h.prototype.readUint24=function(){return this.readAnyInt(3,!1)},h.prototype.readUint32=function(){return this.readAnyInt(4,!1)},h.prototype.readUint64=function(){return this.readAnyInt(8,!1)},h.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},h.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},h.prototype.readInt8=function(){return this.readAnyInt(1,!0)},h.prototype.readInt16=function(){return this.readAnyInt(2,!0)},h.prototype.readInt32=function(){return this.readAnyInt(4,!0)},h.prototype.readInt64=function(){return this.readAnyInt(8,!1)},h.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},h.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},h.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},h.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},h.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},f.MP4BoxStream=h;var u=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??u.LITTLE_ENDIAN};u.prototype={},u.prototype.getPosition=function(){return this.position},u.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var a=new ArrayBuffer(n),d=new Uint8Array(this._buffer),g=new Uint8Array(a,0,d.length);g.set(d),this.buffer=a,this._byteLength=e}},u.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},u.BIG_ENDIAN=!1,u.LITTLE_ENDIAN=!0,u.prototype._byteLength=0,Object.defineProperty(u.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(u.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},u.prototype.isEof=function(){return this.position>=this._byteLength},u.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},u.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},u.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},u.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,u.memcpy=function(t,e,n,a,d){var g=new Uint8Array(t,e,d),y=new Uint8Array(n,a,d);g.set(y)},u.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},u.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},u.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var a=n+t.BYTES_PER_ELEMENT-1,d=n;a>d;a--,d++){var g=e[d];e[d]=e[a],e[a]=g}return t},u.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},u.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},u.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),a=e;t!=null&&(a=Math.min(t,e));for(var d=0;d<a&&n[d]!==0;d++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(d)]);return t!=null?this.position+=a-d:d!=e&&(this.position+=1),g};var p=Math.pow(2,32);u.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},u.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},f.DataStream=u,u.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",n),a.setAttribute("download",t),a.setAttribute("target","_self"),a.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},u.prototype._dynamicSize=!0,Object.defineProperty(u.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),u.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),a=new Uint8Array(this._buffer,t,n.length);n.set(a),this.buffer=e,this.position-=t},u.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},u.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},u.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},u.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},u.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},u.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},u.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},u.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},u.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},u.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},u.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},u.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var a=0;a<t.length&&a<n;a++)this.writeUint16(t.charCodeAt(a),e);for(;a<n;a++)this.writeUint16(0)},u.prototype.writeString=function(t,e,n){var a=0;if(e==null||e=="ASCII")if(n!=null){var d=Math.min(t.length,n);for(a=0;a<d;a++)this.writeUint8(t.charCodeAt(a));for(;a<n;a++)this.writeUint8(0)}else for(a=0;a<t.length;a++)this.writeUint8(t.charCodeAt(a));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},u.prototype.writeCString=function(t,e){var n=0;if(e!=null){var a=Math.min(t.length,e);for(n=0;n<a;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},u.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var a=t[n+1];this.writeType(a,e[t[n]],e)}},u.prototype.writeType=function(t,e,n){var a;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var d=null,g="ASCII",y=this.position;switch(typeof t=="string"&&/:/.test(t)&&(a=t.split(":"),t=a[0],d=parseInt(a[1])),typeof t=="string"&&/,/.test(t)&&(a=t.split(","),t=a[0],g=parseInt(a[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,u.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,u.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,u.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,u.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,u.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,u.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,u.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,u.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,u.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,u.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,u.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,u.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,d);break;case"string":this.writeString(e,g,d);break;case"u16string":this.writeUCS2String(e,this.endianness,d);break;case"u16stringle":this.writeUCS2String(e,u.LITTLE_ENDIAN,d);break;case"u16stringbe":this.writeUCS2String(e,u.BIG_ENDIAN,d);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}d!=null&&(this.position=y,this._realloc(d),this.position=y+d)},u.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},u.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},u.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},u.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*8,n},u.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new u(new ArrayBuffer,0,u.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var a;return a=new Uint8Array(n),a.set(new Uint8Array(t,e,n)),a.buffer.fileStart=t.fileStart+e,a.buffer.usedBytes=0,a.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var a=this.buffers[n];if(t.fileStart<=a.fileStart){if(t.fileStart===a.fileStart)if(t.byteLength>a.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=a.fileStart||(t=this.reduceBuffer(t,0,a.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<a.fileStart+a.byteLength){var d=a.fileStart+a.byteLength-t.fileStart,g=t.byteLength-d;if(g>0)t=this.reduceBuffer(t,d,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,a,d,g=[],y,w="";for(a=0,d=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(y={},g.push(y),y.start=n.fileStart,y.end=n.fileStart+n.byteLength,w+="["+y.start+"-"):y.end===n.fileStart?y.end=n.fileStart+n.byteLength:(y={},y.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+y.start+"-",y.end=n.fileStart+n.byteLength,g.push(y)),a+=n.usedBytes,d+=n.byteLength;g.length>0&&(w+=y.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+a+"/"+d+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,a=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=a,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var a,d=null,g=-1;for(t===!0?a=0:a=this.bufferIndex;a<this.buffers.length&&(d=this.buffers[a],d.fileStart<=e);){g=a,n&&(d.fileStart+d.byteLength<=e?d.usedBytes=d.byteLength:d.usedBytes=e-d.fileStart,this.logBufferLevel());a++}return g!==-1?(d=this.buffers[g],d.fileStart+d.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,a,d=t!==void 0?t:this.bufferIndex;if(n=this.buffers[d],this.buffers.length>d+1)for(e=d+1;e<this.buffers.length&&(a=this.buffers[e],a.fileStart===n.fileStart+n.byteLength);e++)n=a;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var a;return a=this.findPosition(e,t,n),a!==-1?(this.buffer=this.buffers[a],this.bufferIndex=a,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},f.MultiBufferStream=_;var v=function(){var t=3,e=4,n=5,a=6,d=[];d[t]="ES_Descriptor",d[e]="DecoderConfigDescriptor",d[n]="DecoderSpecificInfo",d[a]="SLConfigDescriptor",this.getDescriptorName=function(w){return d[w]};var g=this,y={};return this.parseOneDescriptor=function(w){var S=0,L,k,F;for(L=w.readUint8(),F=w.readUint8();F&128;)S=(F&127)<<7,F=w.readUint8();return S+=F&127,l.debug("MPEG4DescriptorParser","Found "+(d[L]||"Descriptor "+L)+", size "+S+" at position "+w.getPosition()),d[L]?k=new y[d[L]](S):k=new y.Descriptor(S),k.parse(w),k},y.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},y.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},y.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},y.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var L=g.parseOneDescriptor(w);this.descs.push(L)}},y.ES_Descriptor=function(w){y.Descriptor.call(this,t,w)},y.ES_Descriptor.prototype=new y.Descriptor,y.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},y.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},y.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var L=S.findDescriptor(n);if(L&&L.data){var k=(L.data[0]&248)>>3;return k===31&&L.data.length>=2&&(k=32+((L.data[0]&7)<<3)+((L.data[1]&224)>>5)),k}else return null},y.DecoderConfigDescriptor=function(w){y.Descriptor.call(this,e,w)},y.DecoderConfigDescriptor.prototype=new y.Descriptor,y.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},y.DecoderSpecificInfo=function(w){y.Descriptor.call(this,n,w)},y.DecoderSpecificInfo.prototype=new y.Descriptor,y.SLConfigDescriptor=function(w){y.Descriptor.call(this,a,w)},y.SLConfigDescriptor.prototype=new y.Descriptor,this};f.MPEG4DescriptorParser=v;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,a){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=a},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(a){s.ContainerBox.call(this,t,a),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(a,d){s.SampleEntry.call(this,a,d),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,a){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(d){s[t+"SampleEntry"].call(this,e,d),s.addSubBoxArrays.call(this,a)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,a){s.UUIDs.push(t),s.UUIDBoxes[t]=function(d){e?s.FullBox.call(this,"uuid",d,t):n?s.ContainerBox.call(this,"uuid",d,t):s.Box.call(this,"uuid",d,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,a&&(e?s.UUIDBoxes[t].prototype.parse=function(d){this.parseFullHeader(d),a&&a.call(this,d)}:s.UUIDBoxes[t].prototype.parse=a)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},f.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var a=t.readUint8().toString(16);e+=a.length===1?"0"+a:a}return e},s.parseOneBox=function(t,e,n){var a,d=t.getPosition(),g=0,y,w;if(t.getEndPosition()-d<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),L=t.readString(4),k=L;if(l.debug("BoxParser","Found box of type '"+L+"' and size "+S+" at position "+d),g=8,L=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(d),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,k=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(d),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+L+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(L!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+L+"'"),a=new s.Box(L,S),{code:s.OK,box:a,size:a.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+L+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+L+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):S!==0&&d+S>t.getEndPosition()?(t.seek(d),l.info("BoxParser","Not enough data in stream to parse the entire '"+L+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:d}):e?{code:s.OK,type:L,size:S,hdr_size:g,start:d}:(s[L+"Box"]?a=new s[L+"Box"](S):L!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+L+"'"),a=new s.Box(L,S),a.has_unparsed_data=!0):s.UUIDBoxes[w]?a=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),a=new s.Box(L,S),a.uuid=w,a.has_unparsed_data=!0),a.hdr_size=g,a.start=d,a.write===s.Box.prototype.write&&a.type!=="mdat"&&(l.info("BoxParser","'"+k+"' box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),y=t.getPosition()-(a.start+a.size),y<0?(l.warn("BoxParser","Parsing of box '"+k+"' did not read the entire indicated box data size (missing "+-y+" bytes), seeking forward"),t.seek(a.start+a.size)):y>0&&(l.error("BoxParser","Parsing of box '"+k+"' read "+y+" more bytes than the indicated box data size, seeking backwards"),a.size!==0&&t.seek(a.start+a.size)),{code:s.OK,box:a,size:a.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var a=n.type!=="uuid"?n.type:n.uuid;this[a]?l.warn("Box of type "+a+" already stored in field of this type"):this[a]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var a=0;a<3;a++)n==16?this.layer_size[a]=t.readUint16():this.layer_size[a]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var a=t.readInt32();a<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(a)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),a=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|a>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var a={};this.ind_subs.push(a);var d=t.readUint8(),g=t.readUint8(),y=t.readUint8();a.fscod=d>>6,a.bsid=d>>1&31,a.bsmod=(d&1)<<4|g>>4&15,a.acmod=g>>1&7,a.lfeon=g&1,a.num_dep_sub=y>>1&15,a.num_dep_sub>0&&(a.chan_loc=(y&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,a=[],d=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),y=Math.min(g&e,d.length-1);if(y?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),a.push(d[y]),g&n)break}while(!0);this.numMetadataBlocks=a.length+" ("+a.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var a=t.readUint32(),d=0;d<a;d++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),this.version===1?(a.segment_duration=t.readUint64(),a.media_time=t.readInt64()):(a.segment_duration=t.readUint32(),a.media_time=t.readInt32()),a.media_rate_integer=t.readInt16(),a.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var a=n.readUint32();this.entity_ids.push(a)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof v<"u"){var n=new v;this.esd=n.parseOneDescriptor(new u(e.buffer,0,u.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,a,d;this.configurationVersion=t.readUint8(),d=t.readUint8(),this.general_profile_space=d>>6,this.general_tier_flag=(d&32)>>5,this.general_profile_idc=d&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),d=t.readUint8(),this.constantFrameRate=d>>6,this.numTemporalLayers=(d&13)>>3,this.temporalIdNested=(d&4)>>2,this.lengthSizeMinusOne=d&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var y=[];this.nalu_arrays.push(y),d=t.readUint8(),y.completeness=(d&128)>>7,y.nalu_type=d&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};y.push(S),a=t.readUint16(),S.data=t.readUint8Array(a)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var a=0;a<n;a++){var d={};if(this.items.push(d),this.version<2)d.item_ID=t.readUint16();else if(this.version===2)d.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?d.construction_method=t.readUint16()&15:d.construction_method=0,d.data_reference_index=t.readUint16(),this.base_offset_size){case 0:d.base_offset=0;break;case 4:d.base_offset=t.readUint32();break;case 8:d.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();d.extents=[];for(var y=0;y<g;y++){var w={};if(d.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var a={};this.associations.push(a),this.version<1?a.id=t.readUint16():a.id=t.readUint32();var d=t.readUint8();for(a.props=[],n=0;n<d;n++){var g=t.readUint8(),y={};a.props.push(y),y.essential=(g&128)>>7===1,this.flags&1?y.property_index=(g&127)<<8|t.readUint8():y.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var a={};this.levels[n]=a,a.track_ID=t.readUint32();var d=t.readUint8();switch(a.padding_flag=d>>7,a.assignment_type=d&127,a.assignment_type){case 0:a.grouping_type=t.readString(4);break;case 1:a.grouping_type=t.readString(4),a.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:a.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,a;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,a=t.readUint8(),this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var d=t.readUint8();for(e=0;e<d;e++){var g=[];this.nalu_arrays.push(g),a=t.readUint8(),g.completeness=(a&128)>>7,g.nalu_type=a&63;var y=t.readUint16();for(n=0;n<y;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var a=t.readUint32();a>0&&(this.data=t.readUint8Array(a))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var a=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<a/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),a=0;a<n;a++){var d={};this.dependency.push(d),d.subSeqDirectionFlag=t.readUint8(),d.layerNumber=t.readUint8(),d.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),a.sample_count=t.readInt32(),a.group_description_index=t.readInt32()}});function A(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}A.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var a=t.readUint32(),d=t.readUint32();this.bad_pixels.push(new A(a,d))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var a=0;a<n;a++)e=t.readUint8(),this.is_leading[a]=e>>6,this.sample_depends_on[a]=e>>4&3,this.sample_is_depended_on[a]=e>>2&3,this.sample_has_redundancy[a]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a;s[this.grouping_type+"SampleGroupEntry"]?a=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):a=new s.SampleGroupEntry(this.grouping_type),this.entries.push(a),this.version===1?this.default_length===0?a.description_length=t.readUint32():a.description_length=this.default_length:a.description_length=this.default_length,a.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),a.data=t.readUint8Array(a.description_length),t.position-=a.description_length),a.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var a={};this.references.push(a);var d=t.readUint32();a.reference_type=d>>31&1,a.referenced_size=d&2147483647,a.subsegment_duration=t.readUint32(),d=t.readUint32(),a.starts_with_SAP=d>>31&1,a.SAP_type=d>>28&7,a.SAP_delta_time=d&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.subsegments.push(a),a.ranges=[];for(var d=t.readUint32(),g=0;g<d;g++){var y={};a.ranges.push(y),y.level=t.readUint8(),y.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,a,d;for(this.entries=[],a=t.readUint32(),e=1;e<=a;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(d=new s[n.type+"SampleEntry"](n.size),d.hdr_size=n.hdr_size,d.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),d=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),d.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+d.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(t)),d.parse(t),this.entries.push(d);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,a;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),a=t.readInt32(),a<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),a=1),this.sample_deltas.push(a)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var a,d;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(a=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),a.code===s.OK)d=a.box,this.boxes.push(d),this[d.type]=d;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var a=t.readUint8();this.sample_sizes[e]=a>>4&15,this.sample_sizes[e+1]=a&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,a,d;for(a=t.readUint32(),this.entries=[],e=0;e<a;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],d=t.readUint16(),d>0)for(n=0;n<d;n++){var y={};g.subsamples.push(y),this.version==1?y.size=t.readUint32():y.size=t.readUint16(),y.priority=t.readUint8(),y.discardable=t.readUint8(),y.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),a=0;a<n;a++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},a=0,d=0;this.version===1?(a=t.readUint64(),d=t.readUint64()):(a=t.readUint32(),d=t.readUint32()),n.absolute_time=a,n.absolute_duration=d,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,a={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(R){this.held_bits=R.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(R){this.held_bits=R.readUint16(),this.num_held_bits=16},extract_bits:function(R){var lt=this.held_bits>>this.num_held_bits-R&(1<<R)-1;return this.num_held_bits-=R,lt}};if(a.stream_read_1_bytes(t),a.extract_bits(5),this.lengthSizeMinusOne=a.extract_bits(2),this.ptl_present_flag=a.extract_bits(1),this.ptl_present_flag){a.stream_read_2_bytes(t),this.ols_idx=a.extract_bits(9),this.num_sublayers=a.extract_bits(3),this.constant_frame_rate=a.extract_bits(2),this.chroma_format_idc=a.extract_bits(2),a.stream_read_1_bytes(t),this.bit_depth_minus8=a.extract_bits(3),a.extract_bits(5);{if(a.stream_read_2_bytes(t),a.extract_bits(2),this.num_bytes_constraint_info=a.extract_bits(6),this.general_profile_idc=a.extract_bits(7),this.general_tier_flag=a.extract_bits(1),this.general_level_idc=t.readUint8(),a.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=a.extract_bits(1),this.ptl_multilayer_enabled_flag=a.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var d=a.extract_bits(6);a.stream_read_1_bytes(t);var g=a.extract_bits(2);this.general_constraint_info[e]=d<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=a.extract_bits(6)}else a.extract_bits(6);if(this.num_sublayers>1){for(a.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var y=a.extract_bits(1);this.ptl_sublayer_present_mask|=y<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)a.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var L=t.readUint8();for(e=0;e<L;e++){var k=[];this.nalu_arrays.push(k),a.stream_read_1_bytes(t),k.completeness=a.extract_bits(1),a.extract_bits(2),k.nalu_type=a.extract_bits(5);var F=1;for(k.nalu_type!=S&&k.nalu_type!=w&&(F=t.readUint16()),n=0;n<F;n++){var G=t.readUint16();k.push({data:t.readUint8Array(G),length:G})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,a=0;for(t=0;t<32&&(a|=n&1,t!=31);t++)a<<=1,n>>=1;e+=s.decimalToHex(a,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var d=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||d)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,d=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var a=[],d=0;d|=this.vvcC.ptl_frame_only_constraint<<7,d|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)d|=this.vvcC.general_constraint_info[t]>>2&63,a.push(d),d&&(g=t),d=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var y="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|a[t],S+=8;S>=5;){var L=w>>S-5&31;n+=y[L],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=y[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[a].pts=t[a].dts+this.sample_offsets[e],a++},s.sttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)a===0?t[a].dts=0:t[a].dts=t[a-1].dts+this.sample_deltas[e],a++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,a,d,g;for(d=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,a=0;a<this.samples_per_chunk[e];a++){if(t[d])t[d].description_index=this.sample_description_index[e],t[d].chunk_index=g;else return;d++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var a=s.DIFF_BOXES_PROP_NAMES[n];if(t[a]&&e[a]&&!s.boxEqual(t[a],e[a]))return!1}return!0};var I=function(){};I.prototype.parseSample=function(t){var e={},n;e.resources=[];var a=new h(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=a.readString(t.data.length);else if(e.documentString=a.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=a.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var B=function(){};B.prototype.parseSample=function(t){var e,n=new h(t.data.buffer);return e=n.readString(t.data.length),e},B.prototype.parseConfig=function(t){var e,n=new h(t.buffer);return n.readUint32(),e=n.readCString(),e},f.XMLSubtitlein4Parser=I,f.Textin4Parser=B;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var d={};this.fragmentedTracks.push(d),d.id=t,d.user=e,d.trak=a,a.nextSample=0,d.segmentStream=null,d.nb_samples=1e3,d.rapAlignement=!0,n&&(n.nbSamples&&(d.nb_samples=n.nbSamples),n.rapAlignement&&(d.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var a=this.fragmentedTracks[n];a.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var d={};this.extractedTracks.push(d),d.id=t,d.user=e,d.trak=a,a.nextSample=0,d.nb_samples=1e3,d.samples=[],n&&n.nbSamples&&(d.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var a=this.extractedTracks[n];a.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var a;switch(e=t.box,a=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),a){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[a]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+a+", overriding previous occurrence"),this[a]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},a,d,g,y,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=this.moov.traks[t],y=a.mdia.minf.stbl.stsd.entries[0],d={},n.tracks.push(d),d.id=a.tkhd.track_id,d.name=a.mdia.hdlr.name,d.references=[],a.tref)for(e=0;e<a.tref.boxes.length;e++)g={},d.references.push(g),g.type=a.tref.boxes[e].type,g.track_ids=a.tref.boxes[e].track_ids;a.edts&&(d.edits=a.edts.elst.entries),d.created=new Date(w+a.tkhd.creation_time*1e3),d.modified=new Date(w+a.tkhd.modification_time*1e3),d.movie_duration=a.tkhd.duration,d.movie_timescale=n.timescale,d.layer=a.tkhd.layer,d.alternate_group=a.tkhd.alternate_group,d.volume=a.tkhd.volume,d.matrix=a.tkhd.matrix,d.track_width=a.tkhd.width/65536,d.track_height=a.tkhd.height/65536,d.timescale=a.mdia.mdhd.timescale,d.cts_shift=a.mdia.minf.stbl.cslg,d.duration=a.mdia.mdhd.duration,d.samples_duration=a.samples_duration,d.codec=y.getCodec(),d.kind=a.udta&&a.udta.kinds.length?a.udta.kinds[0]:{schemeURI:"",value:""},d.language=a.mdia.elng?a.mdia.elng.extended_language:a.mdia.mdhd.languageString,d.nb_samples=a.samples.length,d.size=a.samples_size,d.bitrate=d.size*8*d.timescale/d.samples_duration,y.isAudio()?(d.type="audio",n.audioTracks.push(d),d.audio={},d.audio.sample_rate=y.getSampleRate(),d.audio.channel_count=y.getChannelCount(),d.audio.sample_size=y.getSampleSize()):y.isVideo()?(d.type="video",n.videoTracks.push(d),d.video={},d.video.width=y.getWidth(),d.video.height=y.getHeight()):y.isSubtitle()?(d.type="subtitles",n.subtitleTracks.push(d)):y.isHint()?(d.type="metadata",n.hintTracks.push(d)):y.isMetadata()?(d.type="metadata",n.metadataTracks.push(d)):(d.type="metadata",n.otherTracks.push(d))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var a=this.fragmentedTracks[e];for(n=a.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+a.id+" for sample "+n.nextSample);var d=this.createFragment(a.id,n.nextSample,a.segmentStream);if(d)a.segmentStream=d,n.nextSample++;else break;if((n.nextSample%a.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+a.id+" for samples ["+Math.max(0,n.nextSample-a.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(a.id,a.user,a.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),a.segmentStream=null,a!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var y=this.getSample(n,n.nextSample);if(y)n.nextSample++,g.samples.push(y);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var a in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[a],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),a=this.getSample(n,e);return a},U.prototype.releaseUsedSamples=function(t,e){var n=0,a=this.getTrackById(t);a.lastValidSample||(a.lastValidSample=0);for(var d=a.lastValidSample;d<e;d++)n+=this.releaseSample(a,d);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),a.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var a,d,g=1/0,y=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(a=0;a<n.samples.length;a++){if(d=n.samples[a],a===0)w=0,S=d.timescale;else if(d.cts>t*d.timescale){w=a-1;break}e&&d.is_sync&&(y=a)}for(e&&(w=y),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,a,d,g,y={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)a=n.traks[g],!(t>this.getTrackDuration(a))&&(d=this.seekTrack(t,e,a),d.offset<y.offset&&(y.offset=d.offset),d.time<y.time&&(y.time=d.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(y.time,1)+" needs a buffer with a fileStart position of "+y.offset),y.offset===1/0?y={offset:this.nextParsePosition,time:0}:y.offset=this.stream.getEndFilePositionAfter(y.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+y.offset),y}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],a=t.boxes[e];if(!s.boxEqual(n,a))return!1;e++}return!0},f.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,a;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,a=this.stream.seek(e.start+e.size,!1,this.discardMdatData),a?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var a=n.add("mdia");a.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),a.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),a.add("elng").set("extended_language",e.language||"fr-FR");var d=a.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var y="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],L=0;L<S.length;L++)if(S.indexOf(e.type)>-1){y=w;break}switch(y){case"Visual":if(d.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var k=new s.avcCBox;k.parse(new h(e.avcDecoderConfigRecord)),g.addBox(k)}else if(e.hevcDecoderConfigRecord){var F=new s.hvcCBox;F.parse(new h(e.hevcDecoderConfigRecord)),g.addBox(F)}break;case"Audio":d.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":d.add("hmhd");break;case"Subtitle":switch(d.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":d.add("nmhd");break;case"System":d.add("nmhd");break;default:d.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(R){g.addBox(R)}),d.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var G=d.add("stbl");return G.add("stsd").addEntry(g),G.add("stts").set("sample_counts",[]).set("sample_deltas",[]),G.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),G.add("stco").set("chunk_offsets",[]),G.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new u;e.endianness=u.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var a=n||{},d={},g=this.getTrackById(t);if(g!==null){d.number=g.samples.length,d.track_id=g.tkhd.track_id,d.timescale=g.mdia.mdhd.timescale,d.description_index=a.sample_description_index?a.sample_description_index-1:0,d.description=g.mdia.minf.stbl.stsd.entries[d.description_index],d.data=e,d.size=e.byteLength,d.alreadyRead=d.size,d.duration=a.duration||1,d.cts=a.cts||0,d.dts=a.dts||0,d.is_sync=a.is_sync||!1,d.is_leading=a.is_leading||0,d.depends_on=a.depends_on||0,d.is_depended_on=a.is_depended_on||0,d.has_redundancy=a.has_redundancy||0,d.degradation_priority=a.degradation_priority||0,d.offset=0,d.subsamples=a.subsamples,g.samples.push(d),g.samples_size+=d.size,g.samples_duration+=d.duration,g.first_dts===void 0&&(g.first_dts=a.dts),this.processSamples();var y=this.createSingleSampleMoof(d);return this.addBox(y),y.computeSize(),y.trafs[0].truns[0].data_offset=y.size+8,this.add("mdat").data=new Uint8Array(e),d}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var a=n.add("traf"),d=this.getTrackById(t.track_id);return a.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),a.add("tfdt").set("baseMediaDecodeTime",t.dts-(d.first_dts||0)),a.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,a,d,g,y,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],a=e.mdia.minf.stbl.stsc,a.first_chunk=[],a.samples_per_chunk=[],a.sample_description_index=[],d=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,d.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],y=e.mdia.minf.stbl.ctts,y&&(y.sample_counts=[],y.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,a,d){var g,y,w,S;function L(k,F,G){this.grouping_type=k,this.grouping_type_parameter=F,this.sbgp=G,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),y=0;y<n.length;y++){for(S=n[y].grouping_type+"/"+n[y].grouping_type_parameter,w=new L(n[y].grouping_type,n[y].grouping_type_parameter,n[y]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<a.length;g++)a[g].grouping_type===n[y].grouping_type&&(w.description=a[g],w.description.used=!0);if(d)for(g=0;g<d.length;g++)d[g].grouping_type===n[y].grouping_type&&(w.fragment_description=d[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(d)for(y=0;y<d.length;y++)!d[y].used&&d[y].version>=2&&(S=d[y].grouping_type+"/0",w=new L(d[y].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(y=0;y<a.length;y++)!a[y].used&&a[y].version>=2&&(S=a[y].grouping_type+"/0",w=new L(a[y].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,a){var d,g;e.sample_groups=[];for(d in a)if(e.sample_groups[d]={},e.sample_groups[d].grouping_type=a[d].grouping_type,e.sample_groups[d].grouping_type_parameter=a[d].grouping_type_parameter,n>=a[d].last_sample_in_run&&(a[d].last_sample_in_run<0&&(a[d].last_sample_in_run=0),a[d].entry_index++,a[d].entry_index<=a[d].sbgp.entries.length-1&&(a[d].last_sample_in_run+=a[d].sbgp.entries[a[d].entry_index].sample_count)),a[d].entry_index<=a[d].sbgp.entries.length-1?e.sample_groups[d].group_description_index=a[d].sbgp.entries[a[d].entry_index].group_description_index:e.sample_groups[d].group_description_index=-1,e.sample_groups[d].group_description_index!==0){var y;a[d].fragment_description?y=a[d].fragment_description:y=a[d].description,e.sample_groups[d].group_description_index>0?(e.sample_groups[d].group_description_index>65535?g=(e.sample_groups[d].group_description_index>>16)-1:g=e.sample_groups[d].group_description_index-1,y&&g>=0&&(e.sample_groups[d].description=y.entries[g])):y&&y.version>=2&&y.default_group_description_index>0&&(e.sample_groups[d].description=y.entries[y.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,a,d,g,y,w,S,L,k,F,G,R,lt,st,bt,V,Yt,Tt,Nt,it,Y,K,at;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,a=t.mdia.minf.stbl.stsc,d=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,y=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,L=t.mdia.minf.stbl.subs,G=t.mdia.minf.stbl.stdp,k=t.mdia.minf.stbl.sbgps,F=t.mdia.minf.stbl.sgpds,Yt=-1,Tt=-1,Nt=-1,it=-1,Y=0,K=0,at=0,U.initSampleGroups(t,null,k,F),!(typeof d>"u")){for(e=0;e<d.sample_sizes.length;e++){var X={};X.number=e,X.track_id=t.tkhd.track_id,X.timescale=t.mdia.mdhd.timescale,X.alreadyRead=0,t.samples[e]=X,X.size=d.sample_sizes[e],t.samples_size+=X.size,e===0?(lt=1,R=0,X.chunk_index=lt,X.chunk_run_index=R,V=a.samples_per_chunk[R],bt=0,R+1<a.first_chunk.length?st=a.first_chunk[R+1]-1:st=1/0):e<V?(X.chunk_index=lt,X.chunk_run_index=R):(lt++,X.chunk_index=lt,bt=0,lt<=st||(R++,R+1<a.first_chunk.length?st=a.first_chunk[R+1]-1:st=1/0),X.chunk_run_index=R,V+=a.samples_per_chunk[R]),X.description_index=a.sample_description_index[X.chunk_run_index]-1,X.description=S.entries[X.description_index],X.offset=n.chunk_offsets[X.chunk_index-1]+bt,bt+=X.size,e>Yt&&(Tt++,Yt<0&&(Yt=0),Yt+=g.sample_counts[Tt]),e>0?(t.samples[e-1].duration=g.sample_deltas[Tt],t.samples_duration+=t.samples[e-1].duration,X.dts=t.samples[e-1].dts+t.samples[e-1].duration):X.dts=0,y?(e>=Nt&&(it++,Nt<0&&(Nt=0),Nt+=y.sample_counts[it]),X.cts=t.samples[e].dts+y.sample_offsets[it]):X.cts=X.dts,w?(e==w.sample_numbers[Y]-1?(X.is_sync=!0,Y++):(X.is_sync=!1,X.degradation_priority=0),L&&L.entries[K].sample_delta+at==e+1&&(X.subsamples=L.entries[K].subsamples,at+=L.entries[K].sample_delta,K++)):X.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,X,X.number),G?X.degradation_priority=G.priority[e]:X.degradation_priority=0,L&&L.entries[K].sample_delta+at==e&&(X.subsamples=L.entries[K].subsamples,at+=L.entries[K].sample_delta),(k.length>0||F.length>0)&&U.setSampleGroupProperties(t,X,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,a,d,g,y,w,S,L,k,F,G,R,lt;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(L=S,t=0;t<L.trafs.length;t++){for(k=L.trafs[t],F=this.getTrackById(k.tfhd.track_id),G=this.getTrexById(k.tfhd.track_id),k.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?a=k.tfhd.default_sample_description_index:a=G?G.default_sample_description_index:1,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?d=k.tfhd.default_sample_duration:d=G?G.default_sample_duration:0,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=k.tfhd.default_sample_size:g=G?G.default_sample_size:0,k.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?y=k.tfhd.default_sample_flags:y=G?G.default_sample_flags:0,k.sample_number=0,k.sbgps.length>0&&U.initSampleGroups(F,k,k.sbgps,F.mdia.minf.stbl.sgpds,k.sgpds),e=0;e<k.truns.length;e++){var st=k.truns[e];for(n=0;n<st.sample_count;n++){R={},R.moof_number=this.lastMoofIndex,R.number_in_traf=k.sample_number,k.sample_number++,R.number=F.samples.length,k.first_sample_index=F.samples.length,F.samples.push(R),R.track_id=F.tkhd.track_id,R.timescale=F.mdia.mdhd.timescale,R.description_index=a-1,R.description=F.mdia.minf.stbl.stsd.entries[R.description_index],R.size=g,st.flags&s.TRUN_FLAGS_SIZE&&(R.size=st.sample_size[n]),F.samples_size+=R.size,R.duration=d,st.flags&s.TRUN_FLAGS_DURATION&&(R.duration=st.sample_duration[n]),F.samples_duration+=R.duration,F.first_traf_merged||n>0?R.dts=F.samples[F.samples.length-2].dts+F.samples[F.samples.length-2].duration:(k.tfdt?R.dts=k.tfdt.baseMediaDecodeTime:R.dts=0,F.first_traf_merged=!0),R.cts=R.dts,st.flags&s.TRUN_FLAGS_CTS_OFFSET&&(R.cts=R.dts+st.sample_composition_time_offset[n]),lt=y,st.flags&s.TRUN_FLAGS_FLAGS?lt=st.sample_flags[n]:n===0&&st.flags&s.TRUN_FLAGS_FIRST_FLAG&&(lt=st.first_sample_flags),R.is_sync=!(lt>>16&1),R.is_leading=lt>>26&3,R.depends_on=lt>>24&3,R.is_depended_on=lt>>22&3,R.has_redundancy=lt>>20&3,R.degradation_priority=lt&65535;var bt=!!(k.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),V=!!(k.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Yt=!!(st.flags&s.TRUN_FLAGS_DATA_OFFSET),Tt=0;bt?Tt=k.tfhd.base_data_offset:V||e===0?Tt=L.start:Tt=w,e===0&&n===0?Yt?R.offset=Tt+st.data_offset:R.offset=Tt:R.offset=w,w=R.offset+R.size,(k.sbgps.length>0||k.sgpds.length>0||F.mdia.minf.stbl.sbgps.length>0||F.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(F,R,R.number_in_traf,k.sample_groups_info)}}if(k.subs){F.has_fragment_subsamples=!0;var Nt=k.first_sample_index;for(e=0;e<k.subs.entries.length;e++)Nt+=k.subs.entries[e].sample_delta,R=F.samples[Nt-1],R.subsamples=k.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,a=t.samples[e];if(!this.moov)return null;if(!a.data)a.data=new Uint8Array(a.size),a.alreadyRead=0,this.samplesDataSize+=a.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+a.size+" (total: "+this.samplesDataSize+")");else if(a.alreadyRead==a.size)return a;for(;;){var d=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(d>-1){n=this.stream.buffers[d];var g=n.byteLength-(a.offset+a.alreadyRead-n.fileStart);if(a.size-a.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+(a.size-a.alreadyRead)+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,a.size-a.alreadyRead),n.usedBytes+=a.size-a.alreadyRead,this.stream.logBufferLevel(),a.alreadyRead=a.size,a;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,g),a.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,a,d,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)d={},d.id=g.iinf.item_infos[n].item_ID,t[d.id]=d,d.ref_to=[],d.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(d.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?d.type=g.iinf.item_infos[n].item_type:d.type="mime",d.content_type=g.iinf.item_infos[n].content_type,d.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var y=g.iloc.items[n];switch(d=t[y.item_ID],y.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),d.source=g.dinf.boxes[y.data_reference_index-1]),y.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(d.extents=[],d.size=0,a=0;a<y.extents.length;a++)d.extents[a]={},d.extents[a].offset=y.extents[a].extent_offset+y.base_offset,d.extents[a].length=y.extents[a].extent_length,d.extents[a].alreadyRead=0,d.size+=d.extents[a].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(a=0;a<w.references.length;a++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[a]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var L=g.iprp.ipmas[S];for(n=0;n<L.associations.length;n++){var k=L.associations[n];if(d=t[k.id],d||(d=e[k.id]),d)for(d.properties===void 0&&(d.properties={},d.properties.boxes=[]),a=0;a<k.props.length;a++){var F=k.props[a];if(F.property_index>0&&F.property_index-1<g.iprp.ipco.boxes.length){var G=g.iprp.ipco.boxes[F.property_index-1];d.properties[G.type]=G,d.properties.boxes.push(G)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var a=0;a<n.extents.length;a++){var d=n.extents[a];if(d.alreadyRead!==d.length){var g=this.stream.findPosition(!0,d.offset+d.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var y=e.byteLength-(d.offset+d.alreadyRead-e.fileStart);if(d.length-d.alreadyRead<=y)l.debug("ISOFile","Getting item #"+t+" extent #"+a+" data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-e.fileStart)+" read size: "+(d.length-d.alreadyRead)+" full extent size: "+d.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,d.offset+d.alreadyRead-e.fileStart,d.length-d.alreadyRead),e.usedBytes+=d.length-d.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=d.length-d.alreadyRead,d.alreadyRead=d.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+a+" partial data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-e.fileStart)+" read size: "+y+" full extent size: "+d.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,d.offset+d.alreadyRead-e.fileStart,y),d.alreadyRead+=y,n.alreadyRead+=y,e.usedBytes+=y,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var a=e.extents[n];a.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var a=new U;a.discardMdatData=!1;var d={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(d.width=n.properties.ispe.image_width,d.height=n.properties.ispe.image_height);var g=a.addTrack(d);return g?(a.addSample(g,n.data),a):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var a=this.getTrackById(t),d=this.getSample(a,e);if(d==null)return this.setNextSeekPositionFromSample(a.samples[e]),null;var g=n||new u;g.endianness=u.BIG_ENDIAN;var y=this.createSingleSampleMoof(d);y.write(g),y.trafs[0].truns[0].data_offset=y.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+y.trafs[0].truns[0].data_offset),g.adjustUint32(y.trafs[0].truns[0].data_offset_position,y.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=d.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,a){var d;l.debug("ISOFile","Generating initialization segment");var g=new u;g.endianness=u.BIG_ENDIAN,t.write(g);var y=e.add("mvex");for(n&&y.add("mehd").set("fragment_duration",n),d=0;d<e.traks.length;d++)y.add("trex").set("track_id",e.traks[d].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",a).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new u;e.endianness=u.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new u;return t.endianness=u.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,a;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var d=new s.moovBox;d.mvhd=this.moov.mvhd,d.boxes.push(d.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),d.boxes.push(n),d.traks.push(n),a={},a.id=n.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=U.writeInitializationSegment(this.ftyp,d,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(a)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var N={};N.createFile=function(t,e){var n=t!==void 0?t:!0,a=new U(e);return a.discardMdatData=!n,a},f.createFile=N.createFile})(bc);const ls=vc(bc);var Ow=Object.defineProperty,Sc=f=>{throw TypeError(f)},Nw=(f,l,h)=>l in f?Ow(f,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):f[l]=h,gh=(f,l,h)=>Nw(f,typeof l!="symbol"?l+"":l,h),Gw=(f,l,h)=>l.has(f)||Sc("Cannot "+h),Pr=(f,l,h)=>(Gw(f,l,"read from private field"),h?h.call(f):l.get(f)),Hw=(f,l,h)=>l.has(f)?Sc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,h),Bn;let mr=class{constructor(){Hw(this,Bn,new Map),gh(this,"on",(l,h)=>{const u=Pr(this,Bn).get(l)??new Set;return u.add(h),Pr(this,Bn).has(l)||Pr(this,Bn).set(l,u),()=>{u.delete(h),u.size===0&&Pr(this,Bn).delete(l)}}),gh(this,"once",(l,h)=>{const u=this.on(l,(...p)=>{u(),h(...p)});return u}),gh(this,"emit",(l,...h)=>{const u=Pr(this,Bn).get(l);u!=null&&u.forEach(p=>p(...h))})}static forwardEvent(l,h,u){const p=u.map(_=>{const[v,s]=Array.isArray(_)?_:[_,_];return l.on(v,(...b)=>{h.emit(s,...b)})});return()=>{p.forEach(_=>_())}}destroy(){Pr(this,Bn).clear()}};Bn=new WeakMap;const Yw=()=>{let f,l=16.6;self.onmessage=h=>{h.data.event==="start"&&(self.clearInterval(f),f=self.setInterval(()=>{self.postMessage({})},l)),h.data.event==="stop"&&self.clearInterval(f)}},Vw=()=>{const f=new Blob([`(${Yw.toString()})()`]),l=URL.createObjectURL(f);return new Worker(l)},Dr=new Map;let Ah=1,es=null;globalThis.Worker!=null&&(es=Vw(),es.onmessage=()=>{Ah+=1;for(const[f,l]of Dr)if(Ah%f===0)for(const h of l)h()});const qh=(f,l)=>{const h=Math.round(l/16.6),u=Dr.get(h)??new Set;return u.add(f),Dr.set(h,u),Dr.size===1&&u.size===1&&(es==null||es.postMessage({event:"start"})),()=>{u.delete(f),u.size===0&&Dr.delete(h),Dr.size===0&&(Ah=0,es==null||es.postMessage({event:"stop"}))}};function Ww(f,l){let h=!1;async function u(){const p=f.getReader();for(;!h;){const{value:_,done:v}=await p.read();if(v){l.onDone();return}await l.onChunk(_)}p.releaseLock(),await f.cancel()}return u().catch(console.error),()=>{h=!0}}function $w(f,l,h){let u=0,p=0;const _=f.boxes;let v=!1;const s=()=>{var B;if(!v)if(_.find(t=>t.type==="moof")!=null)v=!0;else return null;if(p>=_.length)return null;const U=new ls.DataStream;U.endianness=ls.DataStream.BIG_ENDIAN;let N=p;try{for(;N<_.length;)_[N].write(U),delete _[N],N+=1}catch(t){const e=_[N];throw t instanceof Error&&e!=null?Error(`${t.message} | deltaBuf( boxType: ${e.type}, boxSize: ${e.size}, boxDataLen: ${((B=e.data)==null?void 0:B.length)??-1})`):t}return Xw(f),p=_.length,new Uint8Array(U.buffer)};let b=!1,A=!1,I=null;return{stream:new ReadableStream({start(B){u=self.setInterval(()=>{const U=s();U!=null&&!A&&B.enqueue(U)},l),I=U=>{if(clearInterval(u),f.flush(),U!=null){B.error(U);return}const N=s();N!=null&&!A&&B.enqueue(N),A||B.close()},b&&I()},cancel(){A=!0,clearInterval(u),h==null||h()}}),stop:B=>{b||(b=!0,I==null||I(B))}}}function Xw(f){if(f.moov!=null){for(var l=0;l<f.moov.traks.length;l++)f.moov.traks[l].samples=[];f.mdats=[],f.moofs=[]}}const Jh=(f,l)=>{const h=new Uint8Array(8);new DataView(h.buffer).setUint32(0,l);for(let u=0;u<4;u++)h[4+u]=f.charCodeAt(u);return h},Zw=()=>{const f=new TextEncoder,l=f.encode("mdta"),h=f.encode("mp4 handler"),u=32+h.byteLength+1,p=new Uint8Array(u),_=new DataView(p.buffer);return p.set(Jh("hdlr",u),0),_.setUint32(8,0),p.set(l,16),p.set(h,32),p},jw=f=>{const l=new TextEncoder,h=l.encode("mdta"),u=f.map(b=>{const A=l.encode(b),I=8+A.byteLength,B=new Uint8Array(I);return new DataView(B.buffer).setUint32(0,I),B.set(h,4),B.set(A,4+h.byteLength),B}),p=16+u.reduce((b,A)=>b+A.byteLength,0),_=new Uint8Array(p),v=new DataView(_.buffer);_.set(Jh("keys",p),0),v.setUint32(8,0),v.setUint32(12,f.length);let s=16;for(const b of u)_.set(b,s),s+=b.byteLength;return _},Kw=f=>{const l=new TextEncoder,h=l.encode("data"),u=Object.entries(f).map(([s,b],A)=>{const I=A+1,B=l.encode(b),U=24+B.byteLength,N=new Uint8Array(U),t=new DataView(N.buffer);return t.setUint32(0,U),t.setUint32(4,I),t.setUint32(8,16+B.byteLength),N.set(h,12),t.setUint32(16,1),N.set(B,24),N}),p=8+u.reduce((s,b)=>s+b.byteLength,0),_=new Uint8Array(p);_.set(Jh("ilst",p),0);let v=8;for(const s of u)_.set(s,v),v+=s.byteLength;return _},qw=f=>{const l=Zw(),h=jw(Object.keys(f)),u=Kw(f),p=l.length+h.length+u.length,_=new Uint8Array(p);return _.set(l,0),_.set(h,l.length),_.set(u,l.length+h.length),_};function Jw(f){return f instanceof Error?String(f):typeof f=="object"?JSON.stringify(f,(l,h)=>h instanceof Error?String(h):h):String(f)}function Qw(){const f=new Date;return`${f.getHours()}:${f.getMinutes()}:${f.getSeconds()}.${f.getMilliseconds()}`}let Uc=1;const Ec=[],Vd=["debug","info","warn","error"].reduce((f,l,h)=>Object.assign(f,{[l]:(...u)=>{Uc<=h&&(console[l](...u),Ec.push({lvName:l,timeStr:Qw(),args:u}))}}),{}),sa=new Map,zt={setLogLevel:f=>{Uc=sa.get(f)??1},...Vd,create:f=>Object.fromEntries(Object.entries(Vd).map(([l,h])=>[l,(...u)=>h(f,...u)])),async dump(){return Ec.reduce((f,{lvName:l,timeStr:h,args:u})=>f+`[${l}][${h}]  ${u.map(p=>Jw(p)).join(" ")}
`,"")}};sa.set(zt.debug,0);sa.set(zt.info,1);sa.set(zt.warn,2);sa.set(zt.error,3);(async function(){await Promise.resolve(),!(globalThis.navigator==null||globalThis.document==null)&&(zt.info(`@webav version: 1.0.11, date: ${new Date().toLocaleDateString()}`),zt.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",()=>{zt.info(`visibilitychange: ${document.visibilityState}`)}),"PressureObserver"in globalThis&&new PressureObserver(f=>{zt.info(`cpu state change: ${JSON.stringify(f.map(l=>l.state))}`)}).observe("cpu"))})();function tx(f){zt.info("recodemux opts:",f);const l=ls.createFile(),h=new mr,u=(b,A)=>{const I=b.add("udta").add("meta");I.data=qw(A),I.size=I.data.byteLength};let p=!1;const _=()=>{l.moov==null||p||(p=!0,f.metaDataTags!=null&&u(l.moov,f.metaDataTags),f.duration!=null&&(l.moov.mvhd.duration=f.duration))};h.once("VideoReady",_),h.once("AudioReady",_);let v=f.video!=null?ex(f.video,l,h):null,s=f.audio!=null?nx(f.audio,l,h):null;return f.video==null&&h.emit("VideoReady"),f.audio==null&&h.emit("AudioReady"),{encodeVideo:(b,A)=>{v==null||v.encode(b,A),b.close()},encodeAudio:b=>{if(s!=null)try{s.encode(b),b.close()}catch(A){const I=`encode audio chunk error: ${A.message}, state: ${JSON.stringify({qSize:s.encodeQueueSize,state:s.state})}`;throw zt.error(I),Error(I)}},getEncodeQueueSize:()=>(v==null?void 0:v.encodeQueueSize)??(s==null?void 0:s.encodeQueueSize)??0,flush:async()=>{await Promise.all([v==null?void 0:v.flush(),(s==null?void 0:s.state)==="configured"?s.flush():null])},close:()=>{h.destroy(),v==null||v.close(),(s==null?void 0:s.state)==="configured"&&s.close()},mp4file:l}}function ex(f,l,h){const u={timescale:1e6,width:f.width,height:f.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null,name:"Track created with WebAV"};let p=-1,_=!1;h.once("AudioReady",()=>{_=!0});const v={encoder0:[],encoder1:[]},s=(a,d,g)=>{var y;if(p===-1&&g!=null){const w=(y=g.decoderConfig)==null?void 0:y.description;ix(w),u.avcDecoderConfigRecord=w,p=l.addTrack(u),h.emit("VideoReady"),zt.info("VideoEncoder, video track ready, trackId:",p)}v[a].push(Ih(d))};let b="encoder1",A=0;const I=Math.floor(1e3/f.expectFPS*1e3);function B(){if(!_)return;const a=b==="encoder1"?"encoder0":"encoder1",d=v[b],g=v[a];if(d.length===0&&g.length===0)return;let y=d[0];if(y!=null&&(!y.is_sync||y.cts-A<I)){const S=U(d);S>A&&(A=S)}const w=g[0];if(w!=null&&w.is_sync&&w.cts-A<I){b=a,B();return}if(y!=null&&y.is_sync&&w!=null&&w.is_sync)if(y.cts<=w.cts){const S=U(d);S>A&&(A=S)}else{b=a,B();return}}function U(a){let d=-1,g=0;for(;g<a.length;g++){const y=a[g];if(g>0&&y.is_sync)break;l.addSample(p,y.data,y),d=y.cts+y.duration}return a.splice(0,g),d}const N=qh(B,15),t=Wd(f,(a,d)=>s("encoder0",a,d)),e=Wd(f,(a,d)=>s("encoder1",a,d));let n=0;return{get encodeQueueSize(){return t.encodeQueueSize+e.encodeQueueSize},encode:(a,d)=>{try{d.keyFrame&&(n+=1),(n%2===0?t:e).encode(a,d)}catch(g){const y=`encode video frame error: ${g.message}, state: ${JSON.stringify({ts:a.timestamp,keyFrame:d.keyFrame,duration:a.duration,gopId:n})}`;throw zt.error(y),Error(y)}},flush:async()=>{await Promise.all([t.state==="configured"?await t.flush():null,e.state==="configured"?await e.flush():null]),N(),B()},close:()=>{t.state==="configured"&&t.close(),e.state==="configured"&&e.close()}}}function ix(f){const l=new Uint8Array(f);l[2].toString(2).slice(-2).includes("1")&&(l[2]=0)}function Wd(f,l){const h={codec:f.codec,framerate:f.expectFPS,hardwareAcceleration:f.__unsafe_hardwareAcceleration__,bitrate:f.bitrate,width:f.width,height:f.height,alpha:"discard",avc:{format:"avc"}},u=new VideoEncoder({error:p=>{const _=`VideoEncoder error: ${p.message}, config: ${JSON.stringify(h)}, state: ${JSON.stringify({qSize:u.encodeQueueSize,state:u.state})}`;throw zt.error(_),Error(_)},output:l});return u.configure(h),u}function nx(f,l,h){const u={timescale:1e6,samplerate:f.sampleRate,channel_count:f.channelCount,hdlr:"soun",type:f.codec==="aac"?"mp4a":"Opus",name:"Track created with WebAV"};let p=-1,_=[],v=!1;h.once("VideoReady",()=>{v=!0,_.forEach(A=>{const I=Ih(A);l.addSample(p,I.data,I)}),_=[]});const s={codec:f.codec==="aac"?"mp4a.40.2":"opus",sampleRate:f.sampleRate,numberOfChannels:f.channelCount,bitrate:128e3},b=new AudioEncoder({error:A=>{const I=`AudioEncoder error: ${A.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify({qSize:b.encodeQueueSize,state:b.state})}`;throw zt.error(I),Error(I)},output:(A,I)=>{var B;if(p===-1){const U=(B=I.decoderConfig)==null?void 0:B.description;p=l.addTrack({...u,description:U==null?void 0:rx(U)}),h.emit("AudioReady"),zt.info("AudioEncoder, audio track ready, trackId:",p)}if(v){const U=Ih(A);l.addSample(p,U.data,U)}else _.push(A)}});return b.configure(s),b}function rx(f){const l=f.byteLength,h=new Uint8Array([0,0,0,0,3,23+l,0,2,0,4,18+l,64,21,0,0,0,0,0,0,0,0,0,0,0,5,l,...new Uint8Array(f instanceof ArrayBuffer?f:f.buffer),6,1,2]),u=new ls.BoxParser.esdsBox(h.byteLength);return u.hdr_size=0,u.parse(new ls.DataStream(h,0,ls.DataStream.BIG_ENDIAN)),u}function Ih(f){const l=new ArrayBuffer(f.byteLength);f.copyTo(l);const h=f.timestamp;return{duration:f.duration??0,dts:h,cts:h,is_sync:f.type==="key",data:l}}class sx{constructor(l,h,u){this.length_=l,this.scaleFactor_=(l-1)/h,this.interpolate=this.cubic,u.method==="point"?this.interpolate=this.point:u.method==="linear"?this.interpolate=this.linear:u.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,u.tension||0)),this.sincFilterSize_=u.sincFilterSize||1,this.kernel_=ox(u.sincWindow||ax)}point(l,h){return this.getClippedInput_(Math.round(this.scaleFactor_*l),h)}linear(l,h){l=this.scaleFactor_*l;let u=Math.floor(l);return l-=u,(1-l)*this.getClippedInput_(u,h)+l*this.getClippedInput_(u+1,h)}cubic(l,h){l=this.scaleFactor_*l;let u=Math.floor(l),p=[this.getTangent_(u,h),this.getTangent_(u+1,h)],_=[this.getClippedInput_(u,h),this.getClippedInput_(u+1,h)];l-=u;let v=l*l,s=l*v;return(2*s-3*v+1)*_[0]+(s-2*v+l)*p[0]+(-2*s+3*v)*_[1]+(s-v)*p[1]}sinc(l,h){l=this.scaleFactor_*l;let u=Math.floor(l),p=u-this.sincFilterSize_+1,_=u+this.sincFilterSize_,v=0;for(let s=p;s<=_;s++)v+=this.kernel_(l-s)*this.getClippedInput_(s,h);return v}getTangent_(l,h){return this.tangentFactor_*(this.getClippedInput_(l+1,h)-this.getClippedInput_(l-1,h))/2}getClippedInput_(l,h){return 0<=l&&l<this.length_?h[l]:0}}function ax(f){return Math.exp(-f/2*f/2)}function ox(f){return function(l){return lx(l)*f(l)}}function lx(f){return f===0?1:Math.sin(Math.PI*f)/(Math.PI*f)}class hx{constructor(l,h,u){let p=2*Math.PI*u/h,_=0;this.filters=[];for(let v=0;v<=l;v++)v-l/2===0?this.filters[v]=p:(this.filters[v]=Math.sin(p*(v-l/2))/(v-l/2),this.filters[v]*=.54-.46*Math.cos(2*Math.PI*v/l)),_=_+this.filters[v];for(let v=0;v<=l;v++)this.filters[v]/=_;this.z=this.initZ_()}filter(l){this.z.buf[this.z.pointer]=l;let h=0;for(let u=0,p=this.z.buf.length;u<p;u++)h+=this.filters[u]*this.z.buf[(this.z.pointer+u)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,h}reset(){this.z=this.initZ_()}initZ_(){let l=[];for(let h=0;h<this.filters.length-1;h++)l.push(0);return{buf:l,pointer:0}}}class ux{constructor(l,h,u){let p=[];for(let _=0;_<l;_++)p.push(this.getCoeffs_({Fs:h,Fc:u,Q:.5/Math.sin(Math.PI/(l*2)*(_+.5))}));this.stages=[];for(let _=0;_<p.length;_++)this.stages[_]={b0:p[_].b[0],b1:p[_].b[1],b2:p[_].b[2],a1:p[_].a[0],a2:p[_].a[1],k:p[_].k,z:[0,0]}}filter(l){let h=l;for(let u=0,p=this.stages.length;u<p;u++)h=this.runStage_(u,h);return h}getCoeffs_(l){let h={};h.z=[0,0],h.a=[],h.b=[];let u=this.preCalc_(l,h);return h.k=1,h.b.push((1-u.cw)/(2*u.a0)),h.b.push(2*h.b[0]),h.b.push(h.b[0]),h}preCalc_(l,h){let u={},p=2*Math.PI*l.Fc/l.Fs;return u.alpha=Math.sin(p)/(2*l.Q),u.cw=Math.cos(p),u.a0=1+u.alpha,h.a0=u.a0,h.a.push(-2*u.cw/u.a0),h.k=1,h.a.push((1-u.alpha)/u.a0),u}runStage_(l,h){let u=h*this.stages[l].k-this.stages[l].a1*this.stages[l].z[0]-this.stages[l].a2*this.stages[l].z[1],p=this.stages[l].b0*u+this.stages[l].b1*this.stages[l].z[0]+this.stages[l].b2*this.stages[l].z[1];return this.stages[l].z[1]=this.stages[l].z[0],this.stages[l].z[0]=u,p}reset(){for(let l=0;l<this.stages.length;l++)this.stages[l].z=[0,0]}}const fx={point:!1,linear:!1,cubic:!0,sinc:!0},$d={IIR:16,FIR:71},dx={IIR:ux,FIR:hx};function cx(f,l,h,u={}){let p=(h-l)/l+1,_=new Float64Array(f.length*p);u.method=u.method||"cubic";let v=new sx(f.length,_.length,{method:u.method,tension:u.tension||0,sincFilterSize:u.sincFilterSize||6,sincWindow:u.sincWindow||void 0});if(u.LPF===void 0&&(u.LPF=fx[u.method]),u.LPF){u.LPFType=u.LPFType||"IIR";const s=dx[u.LPFType];if(h>l){let b=new s(u.LPFOrder||$d[u.LPFType],h,l/2);px(f,_,v,b)}else{let b=new s(u.LPFOrder||$d[u.LPFType],l,h/2);_x(f,_,v,b)}}else Cc(f,_,v);return _}function Cc(f,l,h){for(let u=0,p=l.length;u<p;u++)l[u]=h.interpolate(u,f)}function px(f,l,h,u){for(let p=0,_=l.length;p<_;p++)l[p]=u.filter(h.interpolate(p,f));u.reset();for(let p=l.length-1;p>=0;p--)l[p]=u.filter(l[p])}function _x(f,l,h,u){for(let p=0,_=f.length;p<_;p++)f[p]=u.filter(f[p]);u.reset();for(let p=f.length-1;p>=0;p--)f[p]=u.filter(f[p]);Cc(f,l,h)}var Tc=f=>{throw TypeError(f)},Ac=(f,l,h)=>l.has(f)||Tc("Cannot "+h),Xt=(f,l,h)=>(Ac(f,l,"read from private field"),h?h.call(f):l.get(f)),ki=(f,l,h)=>l.has(f)?Tc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,h),wi=(f,l,h,u)=>(Ac(f,l,"write to private field"),l.set(f,h),h);const Ic="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIHUobil7aWYobj09PSIvIilyZXR1cm57cGFyZW50Om51bGwsbmFtZToiIn07Y29uc3QgZT1uLnNwbGl0KCIvIikuZmlsdGVyKGk9PmkubGVuZ3RoPjApO2lmKGUubGVuZ3RoPT09MCl0aHJvdyBFcnJvcigiSW52YWxpZCBwYXRoIik7Y29uc3QgYT1lW2UubGVuZ3RoLTFdLHI9Ii8iK2Uuc2xpY2UoMCwtMSkuam9pbigiLyIpO3JldHVybntuYW1lOmEscGFyZW50OnJ9fWFzeW5jIGZ1bmN0aW9uIHcobixlKXtjb25zdHtwYXJlbnQ6YSxuYW1lOnJ9PXUobik7aWYoYT09bnVsbClyZXR1cm4gYXdhaXQgbmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7Y29uc3QgaT1hLnNwbGl0KCIvIikuZmlsdGVyKHQ9PnQubGVuZ3RoPjApO3RyeXtsZXQgdD1hd2FpdCBuYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTtmb3IoY29uc3QgcyBvZiBpKXQ9YXdhaXQgdC5nZXREaXJlY3RvcnlIYW5kbGUocyx7Y3JlYXRlOmUuY3JlYXRlfSk7aWYoZS5pc0ZpbGUpcmV0dXJuIGF3YWl0IHQuZ2V0RmlsZUhhbmRsZShyLHtjcmVhdGU6ZS5jcmVhdGV9KX1jYXRjaCh0KXtpZih0Lm5hbWU9PT0iTm90Rm91bmRFcnJvciIpcmV0dXJuIG51bGw7dGhyb3cgdH19Y29uc3QgZj17fTtzZWxmLm9ubWVzc2FnZT1hc3luYyBuPT57dmFyIGk7Y29uc3R7ZXZ0VHlwZTplLGFyZ3M6YX09bi5kYXRhO2xldCByPWZbYS5maWxlSWRdO3RyeXtsZXQgdDtjb25zdCBzPVtdO2lmKGU9PT0icmVnaXN0ZXIiKXtjb25zdCBsPWF3YWl0IHcoYS5maWxlUGF0aCx7Y3JlYXRlOiEwLGlzRmlsZTohMH0pO2lmKGw9PW51bGwpdGhyb3cgRXJyb3IoYG5vdCBmb3VuZCBmaWxlOiAke2EuZmlsZUlkfWApO3I9YXdhaXQgbC5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKHttb2RlOmEubW9kZX0pLGZbYS5maWxlSWRdPXJ9ZWxzZSBpZihlPT09ImNsb3NlIilhd2FpdCByLmNsb3NlKCksZGVsZXRlIGZbYS5maWxlSWRdO2Vsc2UgaWYoZT09PSJ0cnVuY2F0ZSIpYXdhaXQgci50cnVuY2F0ZShhLm5ld1NpemUpO2Vsc2UgaWYoZT09PSJ3cml0ZSIpe2NvbnN0e2RhdGE6bCxvcHRzOm99PW4uZGF0YS5hcmdzO3Q9YXdhaXQgci53cml0ZShsLG8pfWVsc2UgaWYoZT09PSJyZWFkIil7Y29uc3R7b2Zmc2V0Omwsc2l6ZTpvfT1uLmRhdGEuYXJncyxnPW5ldyBVaW50OEFycmF5KG8pLGQ9YXdhaXQgci5yZWFkKGcse2F0Omx9KSxjPWcuYnVmZmVyO3Q9ZD09PW8/YzooKGk9Yy50cmFuc2Zlcik9PW51bGw/dm9pZCAwOmkuY2FsbChjLGQpKT8/Yy5zbGljZSgwLGQpLHMucHVzaCh0KX1lbHNlIGU9PT0iZ2V0U2l6ZSI/dD1hd2FpdCByLmdldFNpemUoKTplPT09ImZsdXNoIiYmYXdhaXQgci5mbHVzaCgpO3NlbGYucG9zdE1lc3NhZ2Uoe2V2dFR5cGU6ImNhbGxiYWNrIixjYklkOm4uZGF0YS5jYklkLHJldHVyblZhbDp0fSxzKX1jYXRjaCh0KXtjb25zdCBzPXQ7c2VsZi5wb3N0TWVzc2FnZSh7ZXZ0VHlwZToidGhyb3dFcnJvciIsY2JJZDpuLmRhdGEuY2JJZCxlcnJNc2c6cy5uYW1lKyI6ICIrcy5tZXNzYWdlK2AKYCtKU09OLnN0cmluZ2lmeShuLmRhdGEpfSl9fX0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPW9wZnMtd29ya2VyLUY0UldscWNfLmpzLm1hcAo=",gx=f=>Uint8Array.from(atob(f),l=>l.charCodeAt(0)),Xd=typeof self<"u"&&self.Blob&&new Blob([gx(Ic)],{type:"text/javascript;charset=utf-8"});function mx(f){let l;try{if(l=Xd&&(self.URL||self.webkitURL).createObjectURL(Xd),!l)throw"";const h=new Worker(l,{name:f==null?void 0:f.name});return h.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(l)}),h}catch{return new Worker("data:text/javascript;base64,"+Ic,{name:f==null?void 0:f.name})}finally{l&&(self.URL||self.webkitURL).revokeObjectURL(l)}}async function yx(f,l,h){const u=vx();return await u("register",{fileId:f,filePath:l,mode:h}),{read:async(p,_)=>await u("read",{fileId:f,offset:p,size:_}),write:async(p,_)=>await u("write",{fileId:f,data:p,opts:_},[ArrayBuffer.isView(p)?p.buffer:p]),close:async()=>await u("close",{fileId:f}),truncate:async p=>await u("truncate",{fileId:f,newSize:p}),getSize:async()=>await u("getSize",{fileId:f}),flush:async()=>await u("flush",{fileId:f})}}const Ka=[];let mh=0;function vx(){if(Ka.length<3){const l=f();return Ka.push(l),l}else{const l=Ka[mh];return mh=(mh+1)%Ka.length,l}function f(){const l=new mx;let h=0,u={};return l.onmessage=({data:p})=>{var _,v;p.evtType==="callback"?(_=u[p.cbId])==null||_.resolve(p.returnVal):p.evtType==="throwError"&&((v=u[p.cbId])==null||v.reject(Error(p.errMsg))),delete u[p.cbId]},async function(p,_,v=[]){h+=1;const s=new Promise((b,A)=>{u[h]={resolve:b,reject:A}});return l.postMessage({cbId:h,evtType:p,args:_},v),s}}}function Zo(f){if(f==="/")return{parent:null,name:""};const l=f.split("/").filter(p=>p.length>0);if(l.length===0)throw Error("Invalid path");const h=l[l.length-1],u="/"+l.slice(0,-1).join("/");return{name:h,parent:u}}async function Mn(f,l){const{parent:h,name:u}=Zo(f);if(h==null)return await navigator.storage.getDirectory();const p=h.split("/").filter(_=>_.length>0);try{let _=await navigator.storage.getDirectory();for(const v of p)_=await _.getDirectoryHandle(v,{create:l.create});return l.isFile?await _.getFileHandle(u,{create:l.create}):await _.getDirectoryHandle(u,{create:l.create})}catch(_){if(_.name==="NotFoundError")return null;throw _}}async function Bc(f){const{parent:l,name:h}=Zo(f);if(l==null){const p=await navigator.storage.getDirectory();for await(const _ of p.keys())await p.removeEntry(_,{recursive:!0});return}const u=await Mn(l,{create:!1,isFile:!1});u!=null&&await u.removeEntry(h,{recursive:!0})}function Bh(f,l){return`${f}/${l}`.replace("//","/")}function is(f){return new zc(f)}var Vi,eo,Ns;let zc=class{constructor(l){ki(this,Vi),ki(this,eo),ki(this,Ns),wi(this,Vi,l);const{parent:h,name:u}=Zo(l);wi(this,eo,u),wi(this,Ns,h)}get kind(){return"dir"}get name(){return Xt(this,eo)}get path(){return Xt(this,Vi)}get parent(){return Xt(this,Ns)==null?null:is(Xt(this,Ns))}async create(){return await Mn(Xt(this,Vi),{create:!0,isFile:!1}),is(Xt(this,Vi))}async exists(){return await Mn(Xt(this,Vi),{create:!1,isFile:!1})instanceof FileSystemDirectoryHandle}async remove(){for(const l of await this.children())try{await l.remove()}catch(h){console.warn(h)}try{await Bc(Xt(this,Vi))}catch(l){console.warn(l)}}async children(){const l=await Mn(Xt(this,Vi),{create:!1,isFile:!1});if(l==null)return[];const h=[];for await(const u of l.values())h.push((u.kind==="file"?ai:is)(Bh(Xt(this,Vi),u.name)));return h}async copyTo(l){if(!await this.exists())throw Error(`dir ${this.path} not exists`);const h=await l.exists()?is(Bh(l.path,this.name)):l;return await h.create(),await Promise.all((await this.children()).map(u=>u.copyTo(h))),h}async moveTo(l){const h=await this.copyTo(l);return await this.remove(),h}};Vi=new WeakMap,eo=new WeakMap,Ns=new WeakMap;const Zd=new Map;function ai(f,l="rw"){if(l==="rw"){const h=Zd.get(f)??new Po(f,l);return Zd.set(f,h),h}return new Po(f,l)}async function jo(f,l,h={overwrite:!0}){if(l instanceof Po){await jo(f,await l.stream(),h);return}const u=await(f instanceof Po?f:ai(f,"rw")).createWriter();try{if(h.overwrite&&await u.truncate(0),l instanceof ReadableStream){const p=l.getReader();for(;;){const{done:_,value:v}=await p.read();if(_)break;await u.write(v)}}else await u.write(l)}catch(p){throw p}finally{await u.close()}}let wx=0;const xx=()=>++wx;var Wi,Gs,io,Hs,no,zn,ro,Ys;const bx=class Fc{constructor(l,h){ki(this,Wi),ki(this,Gs),ki(this,io),ki(this,Hs),ki(this,no),ki(this,zn,0),ki(this,ro,(()=>{let _=null;return()=>(wi(this,zn,Xt(this,zn)+1),_??(_=new Promise(async(v,s)=>{try{const b=await yx(Xt(this,no),Xt(this,Wi),Xt(this,Hs));v([b,async()=>{wi(this,zn,Xt(this,zn)-1),!(Xt(this,zn)>0)&&(_=null,await b.close())}])}catch(b){s(b)}})))})()),ki(this,Ys,!1),wi(this,no,xx()),wi(this,Wi,l),wi(this,Hs,{r:"read-only",rw:"readwrite","rw-unsafe":"readwrite-unsafe"}[h]);const{parent:u,name:p}=Zo(l);wi(this,io,p),wi(this,Gs,u)}get kind(){return"file"}get path(){return Xt(this,Wi)}get name(){return Xt(this,io)}get parent(){return Xt(this,Gs)==null?null:is(Xt(this,Gs))}async createWriter(){if(Xt(this,Hs)==="read-only")throw Error("file is read-only");if(Xt(this,Ys))throw Error("Other writer have not been closed");wi(this,Ys,!0);const l=new TextEncoder,[h,u]=await Xt(this,ro).call(this);let p=await h.getSize(),_=!1;return{write:async(v,s={})=>{if(_)throw Error("Writer is closed");const b=typeof v=="string"?l.encode(v):v,A=s.at??p,I=b.byteLength;return p=A+I,await h.write(b,{at:A})},truncate:async v=>{if(_)throw Error("Writer is closed");await h.truncate(v),p>v&&(p=v)},flush:async()=>{if(_)throw Error("Writer is closed");await h.flush()},close:async()=>{if(_)throw Error("Writer is closed");_=!0,wi(this,Ys,!1),await u()}}}async createReader(){const[l,h]=await Xt(this,ro).call(this);let u=!1,p=0;return{read:async(_,v={})=>{if(u)throw Error("Reader is closed");const s=v.at??p,b=await l.read(s,_);return p=s+b.byteLength,b},getSize:async()=>{if(u)throw Error("Reader is closed");return await l.getSize()},close:async()=>{u||(u=!0,await h())}}}async text(){return new TextDecoder().decode(await this.arrayBuffer())}async arrayBuffer(){const l=await Mn(Xt(this,Wi),{create:!1,isFile:!0});return l==null?new ArrayBuffer(0):(await l.getFile()).arrayBuffer()}async stream(){const l=await this.getOriginFile();return l==null?new ReadableStream({pull:h=>{h.close()}}):l.stream()}async getOriginFile(){var l;return(l=await Mn(Xt(this,Wi),{create:!1,isFile:!0}))==null?void 0:l.getFile()}async getSize(){const l=await Mn(Xt(this,Wi),{create:!1,isFile:!0});return l==null?0:(await l.getFile()).size}async exists(){return await Mn(Xt(this,Wi),{create:!1,isFile:!0})instanceof FileSystemFileHandle}async remove(){if(Xt(this,zn))throw Error("exists unclosed reader/writer");await Bc(Xt(this,Wi))}async copyTo(l){if(l instanceof Fc)return l.path===this.path?this:(await jo(l.path,this),ai(l.path));if(l instanceof zc){if(!await this.exists())throw Error(`file ${this.path} not exists`);return await this.copyTo(ai(Bh(l.path,this.name)))}throw Error("Illegal target type")}async moveTo(l){const h=await this.copyTo(l);return await this.remove(),h}};Wi=new WeakMap,Gs=new WeakMap,io=new WeakMap,Hs=new WeakMap,no=new WeakMap,zn=new WeakMap,ro=new WeakMap,Ys=new WeakMap;let Po=bx;const Qh="/.opfs-tools-temp-dir";async function kc(f){try{if(f.kind==="file"){if(!await f.exists())return!0;const l=await f.createWriter();await l.truncate(0),await l.close(),await f.remove()}else await f.remove();return!0}catch(l){return console.warn(l),!1}}function Sx(){setInterval(async()=>{for(const f of await is(Qh).children()){const l=/^\d+-(\d+)$/.exec(f.name);(l==null||Date.now()-Number(l[1])>2592e5)&&await kc(f)}},60*1e3)}const zh=[];let jd=!1;async function Ux(){if(globalThis.localStorage==null)return;const f="OPFS_TOOLS_EXPIRES_TMP_FILES";jd||(jd=!0,globalThis.addEventListener("unload",()=>{zh.length!==0&&localStorage.setItem(f,`${localStorage.getItem(f)??""},${zh.join(",")}`)}));let l=localStorage.getItem(f)??"";for(const h of l.split(","))h.length!==0&&await kc(ai(`${Qh}/${h}`))&&(l=l.replace(h,""));localStorage.setItem(f,l.replace(/,{2,}/g,","))}(async function(){var f;globalThis.__opfs_tools_tmpfile_init__!==!0&&(globalThis.__opfs_tools_tmpfile_init__=!0,!(globalThis.FileSystemDirectoryHandle==null||globalThis.FileSystemFileHandle==null||((f=globalThis.navigator)==null?void 0:f.storage.getDirectory)==null)&&(Sx(),await Ux()))})();function Ex(){const f=`${Math.random().toString().slice(2)}-${Date.now()}`;return zh.push(f),ai(`${Qh}/${f}`)}var Cx=Object.defineProperty,Lc=f=>{throw TypeError(f)},Tx=(f,l,h)=>l in f?Cx(f,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):f[l]=h,de=(f,l,h)=>Tx(f,typeof l!="symbol"?l+"":l,h),tu=(f,l,h)=>l.has(f)||Lc("Cannot "+h),T=(f,l,h)=>(tu(f,l,"read from private field"),h?h.call(f):l.get(f)),rt=(f,l,h)=>l.has(f)?Lc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,h),tt=(f,l,h,u)=>(tu(f,l,"write to private field"),l.set(f,h),h),Pi=(f,l,h)=>(tu(f,l,"access private method"),h);function Ax(f){if(f.format==="f32-planar"){const l=[];for(let h=0;h<f.numberOfChannels;h+=1){const u=f.allocationSize({planeIndex:h}),p=new ArrayBuffer(u);f.copyTo(p,{planeIndex:h}),l.push(new Float32Array(p))}return l}else if(f.format==="f32"){const l=new ArrayBuffer(f.allocationSize({planeIndex:0}));return f.copyTo(l,{planeIndex:0}),Bx(new Float32Array(l),f.numberOfChannels)}else if(f.format==="s16"){const l=new ArrayBuffer(f.allocationSize({planeIndex:0}));return f.copyTo(l,{planeIndex:0}),Ix(new Int16Array(l),f.numberOfChannels)}throw Error("Unsupported audio data format")}function Ix(f,l){const h=f.length/l,u=Array.from({length:l},()=>new Float32Array(h));for(let p=0;p<h;p++)for(let _=0;_<l;_++){const v=f[p*l+_];u[_][p]=v/32768}return u}function Bx(f,l){const h=f.length/l,u=Array.from({length:l},()=>new Float32Array(h));for(let p=0;p<h;p++)for(let _=0;_<l;_++)u[_][p]=f[p*l+_];return u}function Pc(f){return Array(f.numberOfChannels).fill(0).map((l,h)=>f.getChannelData(h))}async function zx(f,l){var h;const u={type:l,data:f},p=new ImageDecoder(u);await Promise.all([p.completed,p.tracks.ready]);let _=((h=p.tracks.selectedTrack)==null?void 0:h.frameCount)??1;const v=[];for(let s=0;s<_;s+=1)v.push((await p.decode({frameIndex:s})).image);return v}async function Fx(f,l,h){const u=f.length,p=Array(h.chanCount).fill(0).map(()=>new Float32Array(0));if(u===0)return p;const _=Math.max(...f.map(A=>A.length));if(_===0)return p;if(globalThis.OfflineAudioContext==null)return f.map(A=>new Float32Array(cx(A,l,h.rate,{method:"sinc",LPF:!1})));const v=new globalThis.OfflineAudioContext(h.chanCount,_*h.rate/l,h.rate),s=v.createBufferSource(),b=v.createBuffer(u,_,l);return f.forEach((A,I)=>b.copyToChannel(A,I)),s.buffer=b,s.connect(v.destination),s.start(),Pc(await v.startRendering())}function eu(f){return new Promise(l=>{const h=qh(()=>{h(),l()},f)})}function Kd(f,l,h){const u=h-l,p=new Float32Array(u);let _=0;for(;_<u;)p[_]=f[(l+_)%f.length],_+=1;return p}function Rc(f,l){const h=Math.floor(f.length/l),u=new Float32Array(h);for(let p=0;p<h;p++){const _=p*l,v=Math.floor(_),s=_-v;v+1<f.length?u[p]=f[v]*(1-s)+f[v+1]*s:u[p]=f[v]}return u}const le={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function kx(f,l){const h=l.videoTracks[0],u={};if(h!=null){const _=Lx(f.getTrackById(h.id)).buffer,{descKey:v,type:s}=h.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:h.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};v!==""&&(u.videoTrackConf={timescale:h.timescale,duration:h.duration,width:h.video.width,height:h.video.height,brands:l.brands,type:s,[v]:_}),u.videoDecoderConf={codec:h.codec,codedHeight:h.video.height,codedWidth:h.video.width,description:_}}const p=l.audioTracks[0];if(p!=null){const _=qd(f);u.audioTrackConf={timescale:p.timescale,samplerate:p.audio.sample_rate,channel_count:p.audio.channel_count,hdlr:"soun",type:p.codec.startsWith("mp4a")?"mp4a":p.codec,description:qd(f)},u.audioDecoderConf={codec:p.codec.startsWith("mp4a")?le.codec:p.codec,numberOfChannels:p.audio.channel_count,sampleRate:p.audio.sample_rate,..._==null?{}:Px(_)}}return u}function Lx(f){for(const l of f.mdia.minf.stbl.stsd.entries){const h=l.avcC??l.hvcC??l.av1C??l.vpcC;if(h!=null){const u=new Th.DataStream(void 0,0,Th.DataStream.BIG_ENDIAN);return h.write(u),new Uint8Array(u.buffer.slice(8))}}throw Error("avcC, hvcC, av1C or VPX not found")}function qd(f,l="mp4a"){var h;const u=(h=f.moov)==null?void 0:h.traks.map(p=>p.mdia.minf.stbl.stsd.entries).flat().find(({type:p})=>p===l);return u==null?void 0:u.esds}function Px(f){var l;const h=(l=f.esd.descs[0])==null?void 0:l.descs[0];if(h==null)return{};const[u,p]=h.data,_=((u&7)<<1)+(p>>7),v=(p&127)>>3;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][_],numberOfChannels:v}}async function Rx(f,l,h){const u=Th.createFile(!1);u.onReady=_=>{var v,s;l({mp4boxFile:u,info:_});const b=(v=_.videoTracks[0])==null?void 0:v.id;b!=null&&u.setExtractionOptions(b,"video",{nbSamples:100});const A=(s=_.audioTracks[0])==null?void 0:s.id;A!=null&&u.setExtractionOptions(A,"audio",{nbSamples:100}),u.start()},u.onSamples=h,await p();async function p(){let _=0;const v=30*1024*1024;for(;;){const s=await f.read(v,{at:_});if(s.byteLength===0)break;s.fileStart=_;const b=u.appendBuffer(s);if(b==null)break;_=b}u.stop()}}let iu=0;function yh(f){return f.kind==="file"&&f.createReader instanceof Function}var Fh,so,ao,$i,ni,oo,Xi,er,Vs,Mr,un,ri,Ws;const Dx=class Or{constructor(l,h={}){if(rt(this,Fh,iu++),rt(this,so,zt.create(`MP4Clip id:${T(this,Fh)},`)),de(this,"ready"),rt(this,ao,!1),rt(this,$i,{duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0}),rt(this,ni),rt(this,oo,1),rt(this,Xi,[]),rt(this,er,[]),rt(this,Vs,null),rt(this,Mr,null),rt(this,un,{video:null,audio:null}),rt(this,ri,{audio:!0}),de(this,"tickInterceptor",async(p,_)=>_),rt(this,Ws,new AbortController),!(l instanceof ReadableStream)&&!yh(l)&&!Array.isArray(l.videoSamples))throw Error("Illegal argument");tt(this,ri,{audio:!0,...h}),tt(this,oo,typeof h.audio=="object"&&"volume"in h.audio?h.audio.volume:1);const u=async p=>(await jo(T(this,ni),p),T(this,ni));tt(this,ni,yh(l)?l:"localFile"in l?l.localFile:Ex()),this.ready=(l instanceof ReadableStream?u(l).then(p=>Jd(p,T(this,ri))):yh(l)?Jd(l,T(this,ri)):Promise.resolve(l)).then(async({videoSamples:p,audioSamples:_,decoderConf:v})=>{tt(this,Xi,p),tt(this,er,_),tt(this,un,v);const{videoFrameFinder:s,audioFrameFinder:b}=Ox({video:v.video==null?null:{...v.video,hardwareAcceleration:T(this,ri).__unsafe_hardwareAcceleration__},audio:v.audio},await T(this,ni).createReader(),p,_,T(this,ri).audio!==!1?T(this,oo):0);return tt(this,Vs,s),tt(this,Mr,b),tt(this,$i,Mx(v,p,_)),T(this,so).info("MP4Clip meta:",T(this,$i)),{...T(this,$i)}})}get meta(){return{...T(this,$i)}}async tick(l){var h,u,p;if(l>=T(this,$i).duration)return await this.tickInterceptor(l,{audio:await((h=T(this,Mr))==null?void 0:h.find(l))??[],state:"done"});const[_,v]=await Promise.all([((u=T(this,Mr))==null?void 0:u.find(l))??[],(p=T(this,Vs))==null?void 0:p.find(l)]);return v==null?await this.tickInterceptor(l,{audio:_,state:"success"}):await this.tickInterceptor(l,{video:v,audio:_,state:"success"})}async thumbnails(l=100,h){T(this,Ws).abort(),tt(this,Ws,new AbortController);const u=T(this,Ws).signal;await this.ready;const p="generate thumbnails aborted";if(u.aborted)throw Error(p);const{width:_,height:v}=T(this,$i),s=Vx(l,Math.round(v*(l/_)),{quality:.1,type:"image/png"});return new Promise(async(b,A)=>{let I=[];const B=T(this,un).video;if(B==null||T(this,Xi).length===0){U();return}u.addEventListener("abort",()=>{A(Error(p))});async function U(){u.aborted||b(await Promise.all(I.map(async a=>({ts:a.ts,img:await a.img}))))}function N(a){I.push({ts:a.timestamp,img:s(a)})}const{start:t=0,end:e=T(this,$i).duration,step:n}=h??{};if(n){let a=t;const d=new Dc(await T(this,ni).createReader(),T(this,Xi),{...B,hardwareAcceleration:T(this,ri).__unsafe_hardwareAcceleration__});for(;a<=e&&!u.aborted;){const g=await d.find(a);g&&N(g),a+=n}d.destroy(),U()}else await jx(T(this,Xi),T(this,ni),B,u,{start:t,end:e},(a,d)=>{a!=null&&N(a),d&&U()})})}async split(l){if(await this.ready,l<=0||l>=T(this,$i).duration)throw Error('"time" out of bounds');const[h,u]=Wx(T(this,Xi),l),[p,_]=$x(T(this,er),l),v=new Or({localFile:T(this,ni),videoSamples:h??[],audioSamples:p??[],decoderConf:T(this,un)},T(this,ri)),s=new Or({localFile:T(this,ni),videoSamples:u??[],audioSamples:_??[],decoderConf:T(this,un)},T(this,ri));return await Promise.all([v.ready,s.ready]),[v,s]}async clone(){await this.ready;const l=new Or({localFile:T(this,ni),videoSamples:[...T(this,Xi)],audioSamples:[...T(this,er)],decoderConf:T(this,un)},T(this,ri));return await l.ready,l.tickInterceptor=this.tickInterceptor,l}async splitTrack(){await this.ready;const l=[];if(T(this,Xi).length>0){const h=new Or({localFile:T(this,ni),videoSamples:[...T(this,Xi)],audioSamples:[],decoderConf:{video:T(this,un).video,audio:null}},T(this,ri));await h.ready,h.tickInterceptor=this.tickInterceptor,l.push(h)}if(T(this,er).length>0){const h=new Or({localFile:T(this,ni),videoSamples:[],audioSamples:[...T(this,er)],decoderConf:{audio:T(this,un).audio,video:null}},T(this,ri));await h.ready,h.tickInterceptor=this.tickInterceptor,l.push(h)}return l}destroy(){var l,h;T(this,ao)||(T(this,so).info("MP4Clip destroy"),tt(this,ao,!0),(l=T(this,Vs))==null||l.destroy(),(h=T(this,Mr))==null||h.destroy())}};Fh=new WeakMap,so=new WeakMap,ao=new WeakMap,$i=new WeakMap,ni=new WeakMap,oo=new WeakMap,Xi=new WeakMap,er=new WeakMap,Vs=new WeakMap,Mr=new WeakMap,un=new WeakMap,ri=new WeakMap,Ws=new WeakMap;let nu=Dx;function Mx(f,l,h){const u={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};f.video!=null&&l.length>0&&(u.width=f.video.codedWidth??0,u.height=f.video.codedHeight??0),f.audio!=null&&h.length>0&&(u.audioSampleRate=le.sampleRate,u.audioChanCount=le.channelCount);let p=0,_=0;if(l.length>0)for(let v=l.length-1;v>=0;v--){const s=l[v];if(!s.deleted){p=s.cts+s.duration;break}}if(h.length>0){const v=h.at(-1);_=v.cts+v.duration}return u.duration=Math.max(p,_),u}function Ox(f,l,h,u,p){return{audioFrameFinder:p===0||f.audio==null||u.length===0?null:new Gx(l,u,f.audio,{volume:p,targetSampleRate:le.sampleRate}),videoFrameFinder:f.video==null||h.length===0?null:new Dc(l,h,f.video)}}async function Jd(f,l={}){let h=null;const u={video:null,audio:null};let p=[],_=[],v=-1,s=-1;const b=await f.createReader();await Rx(b,B=>{h=B.info;let{videoDecoderConf:U,audioDecoderConf:N}=kx(B.mp4boxFile,B.info);u.video=U??null,u.audio=N??null,U==null&&N==null&&zt.error("MP4Clip no video and audio track"),zt.info("mp4BoxFile moov ready",{...B.info,tracks:null,videoTracks:null,audioTracks:null},u)},(B,U,N)=>{if(U==="video"){v===-1&&(v=N[0].dts);for(const t of N)p.push(I(t,v,"video"))}else if(U==="audio"&&l.audio){s===-1&&(s=N[0].dts);for(const t of N)_.push(I(t,s,"audio"))}}),await b.close();const A=p.at(-1)??_.at(-1);if(h==null)throw Error("MP4Clip stream is done, but not emit ready");if(A==null)throw Error("MP4Clip stream not contain any sample");return Rh(p),zt.info("mp4 stream parsed"),{videoSamples:p,audioSamples:_,decoderConf:u};function I(B,U=0,N){const t=N==="video"&&B.is_sync&&Zx(B.data,B.description.type);let e=B.offset,n=B.size;if(t){const a=Xx(B.data,B.description.type);e+=a,n-=a}return{...B,is_idr:t,offset:e,size:n,cts:(B.cts-U)/B.timescale*1e6,dts:(B.dts-U)/B.timescale*1e6,duration:B.duration/B.timescale*1e6,timescale:1e6,data:N==="video"?null:B.data}}}var Ne,Nr,Gr,lo,Hr,fn,mi,Fn,ir,Yr,$s,nr,ho,Vr,uo;class Dc{constructor(l,h,u){rt(this,Ne,null),rt(this,Nr,0),rt(this,Gr,{abort:!1,st:performance.now()}),de(this,"find",async p=>{(T(this,Ne)==null||T(this,Ne).state==="closed"||p<=T(this,Nr)||p-T(this,Nr)>3e6)&&T(this,Vr).call(this,p),T(this,Gr).abort=!0,tt(this,Nr,p),tt(this,Gr,{abort:!1,st:performance.now()});const _=await T(this,$s).call(this,p,T(this,Ne),T(this,Gr));return tt(this,Yr,0),_}),rt(this,lo,0),rt(this,Hr,!1),rt(this,fn,0),rt(this,mi,[]),rt(this,Fn,0),rt(this,ir,0),rt(this,Yr,0),rt(this,$s,async(p,_,v)=>{if(_==null||_.state==="closed"||v.abort)return null;if(T(this,mi).length>0){const s=T(this,mi)[0];return p<s.timestamp?null:(T(this,mi).shift(),p>s.timestamp+(s.duration??0)?(s.close(),await T(this,$s).call(this,p,_,v)):(T(this,mi).length<10&&T(this,ho).call(this,_).catch(b=>{throw T(this,Vr).call(this,p),b}),s))}if(T(this,nr)||T(this,Fn)<T(this,ir)&&_.decodeQueueSize>0){if(performance.now()-v.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(T(this,uo).call(this))}`);tt(this,Yr,T(this,Yr)+1),await eu(15)}else{if(T(this,fn)>=this.samples.length)return null;try{await T(this,ho).call(this,_)}catch(s){throw T(this,Vr).call(this,p),s}}return await T(this,$s).call(this,p,_,v)}),rt(this,nr,!1),rt(this,ho,async p=>{var _,v;if(T(this,nr)||p.decodeQueueSize>600)return;let s=T(this,fn)+1;if(s>this.samples.length)return;tt(this,nr,!0);let b=!1;for(;s<this.samples.length;s++){const A=this.samples[s];if(!b&&!A.deleted&&(b=!0),A.is_idr)break}if(b){const A=this.samples.slice(T(this,fn),s);if(((_=A[0])==null?void 0:_.is_idr)!==!0)zt.warn("First sample not idr frame");else{const I=performance.now(),B=await Mc(A,this.localFileReader),U=performance.now()-I;if(U>1e3){const N=A[0],t=A.at(-1),e=t.offset+t.size-N.offset;zt.warn(`Read video samples time cost: ${Math.round(U)}ms, file chunk size: ${e}`)}if(p.state==="closed")return;tt(this,lo,((v=B[0])==null?void 0:v.duration)??0),Ph(p,B,{onDecodingError:N=>{if(T(this,Hr))throw N;T(this,Fn)===0&&(tt(this,Hr,!0),zt.warn("Downgrade to software decode"),T(this,Vr).call(this))}}),tt(this,ir,T(this,ir)+B.length)}}tt(this,fn,s),tt(this,nr,!1)}),rt(this,Vr,p=>{var _,v;if(tt(this,nr,!1),T(this,mi).forEach(b=>b.close()),tt(this,mi,[]),p==null||p===0)tt(this,fn,0);else{let b=0;for(let A=0;A<this.samples.length;A++){const I=this.samples[A];if(I.is_idr&&(b=A),!(I.cts<p)){tt(this,fn,b);break}}}tt(this,ir,0),tt(this,Fn,0),((_=T(this,Ne))==null?void 0:_.state)!=="closed"&&((v=T(this,Ne))==null||v.close());const s={...this.conf,...T(this,Hr)?{hardwareAcceleration:"prefer-software"}:{}};tt(this,Ne,new VideoDecoder({output:b=>{if(tt(this,Fn,T(this,Fn)+1),b.timestamp===-1){b.close();return}let A=b;b.duration==null&&(A=new VideoFrame(b,{duration:T(this,lo)}),b.close()),T(this,mi).push(A)},error:b=>{if(b.message.includes("Codec reclaimed due to inactivity")){tt(this,Ne,null);return}const A=`VideoFinder VideoDecoder err: ${b.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify(T(this,uo).call(this))}`;throw zt.error(A),Error(A)}})),T(this,Ne).configure(s)}),rt(this,uo,()=>{var p,_;return{time:T(this,Nr),decState:(p=T(this,Ne))==null?void 0:p.state,decQSize:(_=T(this,Ne))==null?void 0:_.decodeQueueSize,decCusorIdx:T(this,fn),sampleLen:this.samples.length,inputCnt:T(this,ir),outputCnt:T(this,Fn),cacheFrameLen:T(this,mi).length,softDeocde:T(this,Hr),clipIdCnt:iu,sleepCnt:T(this,Yr),memInfo:Oc()}}),de(this,"destroy",()=>{var p,_;((p=T(this,Ne))==null?void 0:p.state)!=="closed"&&((_=T(this,Ne))==null||_.close()),tt(this,Ne,null),T(this,Gr).abort=!0,T(this,mi).forEach(v=>v.close()),tt(this,mi,[]),this.localFileReader.close()}),this.localFileReader=l,this.samples=h,this.conf=u}}Ne=new WeakMap,Nr=new WeakMap,Gr=new WeakMap,lo=new WeakMap,Hr=new WeakMap,fn=new WeakMap,mi=new WeakMap,Fn=new WeakMap,ir=new WeakMap,Yr=new WeakMap,$s=new WeakMap,nr=new WeakMap,ho=new WeakMap,Vr=new WeakMap,uo=new WeakMap;function Nx(f,l){for(let h=0;h<l.length;h++){const u=l[h];if(f>=u.cts&&f<u.cts+u.duration)return h;if(u.cts>f)break}return 0}var fo,co,Zi,Wr,dn,kn,zi,$r,po,_o,kh,Lh;class Gx{constructor(l,h,u,p){rt(this,fo,1),rt(this,co),rt(this,Zi,null),rt(this,Wr,{abort:!1,st:performance.now()}),de(this,"find",async _=>{const v=_<=T(this,dn)||_-T(this,dn)>1e5;(T(this,Zi)==null||T(this,Zi).state==="closed"||v)&&T(this,kh).call(this),v&&(tt(this,dn,_),tt(this,kn,Nx(_,this.samples))),T(this,Wr).abort=!0;const s=_-T(this,dn);tt(this,dn,_),tt(this,Wr,{abort:!1,st:performance.now()});const b=await T(this,po).call(this,Math.ceil(s*(T(this,co)/1e6)),T(this,Zi),T(this,Wr));return tt(this,$r,0),b}),rt(this,dn,0),rt(this,kn,0),rt(this,zi,{frameCnt:0,data:[]}),rt(this,$r,0),rt(this,po,async(_,v=null,s)=>{if(v==null||s.abort||v.state==="closed"||_===0)return[];const b=T(this,zi).frameCnt-_;if(b>0)return b<le.sampleRate/10&&T(this,_o).call(this,v),Qd(T(this,zi),_);if(v.decoding){if(performance.now()-s.st>3e3)throw s.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(T(this,Lh).call(this))}`);tt(this,$r,T(this,$r)+1),await eu(15)}else{if(T(this,kn)>=this.samples.length-1)return Qd(T(this,zi),T(this,zi).frameCnt);T(this,_o).call(this,v)}return T(this,po).call(this,_,v,s)}),rt(this,_o,_=>{if(_.decodeQueueSize>10)return;const v=[];let s=T(this,kn);for(;s<this.samples.length;){const b=this.samples[s];if(s+=1,!b.deleted&&(v.push(b),v.length>=10))break}tt(this,kn,s),_.decode(v.map(b=>new EncodedAudioChunk({type:"key",timestamp:b.cts,duration:b.duration,data:b.data})))}),rt(this,kh,()=>{var _;tt(this,dn,0),tt(this,kn,0),tt(this,zi,{frameCnt:0,data:[]}),(_=T(this,Zi))==null||_.close(),tt(this,Zi,Hx(this.conf,{resampleRate:le.sampleRate,volume:T(this,fo)},v=>{T(this,zi).data.push(v),T(this,zi).frameCnt+=v[0].length}))}),rt(this,Lh,()=>{var _,v;return{time:T(this,dn),decState:(_=T(this,Zi))==null?void 0:_.state,decQSize:(v=T(this,Zi))==null?void 0:v.decodeQueueSize,decCusorIdx:T(this,kn),sampleLen:this.samples.length,pcmLen:T(this,zi).frameCnt,clipIdCnt:iu,sleepCnt:T(this,$r),memInfo:Oc()}}),de(this,"destroy",()=>{tt(this,Zi,null),T(this,Wr).abort=!0,tt(this,zi,{frameCnt:0,data:[]}),this.localFileReader.close()}),this.localFileReader=l,this.samples=h,this.conf=u,tt(this,fo,p.volume),tt(this,co,p.targetSampleRate)}}fo=new WeakMap,co=new WeakMap,Zi=new WeakMap,Wr=new WeakMap,dn=new WeakMap,kn=new WeakMap,zi=new WeakMap,$r=new WeakMap,po=new WeakMap,_o=new WeakMap,kh=new WeakMap,Lh=new WeakMap;function Hx(f,l,h){let u=0,p=0;const _=I=>{if(p+=1,I.length!==0){if(l.volume!==1)for(const B of I)for(let U=0;U<B.length;U++)B[U]*=l.volume;I.length===1&&(I=[I[0],I[0]]),h(I)}},v=Yx(_),s=l.resampleRate!==f.sampleRate;let b=new AudioDecoder({output:I=>{const B=Ax(I);s?v(()=>Fx(B,I.sampleRate,{rate:l.resampleRate,chanCount:I.numberOfChannels})):_(B),I.close()},error:I=>{I.message.includes("Codec reclaimed due to inactivity")||A("MP4Clip AudioDecoder err",I)}});b.configure(f);function A(I,B){const U=`${I}: ${B.message}, state: ${JSON.stringify({qSize:b.decodeQueueSize,state:b.state,inputCnt:u,outputCnt:p})}`;throw zt.error(U),Error(U)}return{decode(I){u+=I.length;try{for(const B of I)b.decode(B)}catch(B){A("decode audio chunk error",B)}},close(){b.state!=="closed"&&b.close()},get decoding(){return u>p&&b.decodeQueueSize>0},get state(){return b.state},get decodeQueueSize(){return b.decodeQueueSize}}}function Yx(f){const l=[];let h=0;function u(v,s){l[s]=v,p()}function p(){const v=l[h];v!=null&&(f(v),h+=1,p())}let _=0;return v=>{const s=_;_+=1,v().then(b=>u(b,s)).catch(b=>u(b,s))}}function Qd(f,l){const h=[new Float32Array(l),new Float32Array(l)];let u=0,p=0;for(;p<f.data.length;){const[_,v]=f.data[p];if(u+_.length>l){const s=l-u;h[0].set(_.subarray(0,s),u),h[1].set(v.subarray(0,s),u),f.data[p][0]=_.subarray(s,_.length),f.data[p][1]=v.subarray(s,v.length);break}else h[0].set(_,u),h[1].set(v,u),u+=_.length,p++}return f.data=f.data.slice(p),f.frameCnt-=l,h}async function Mc(f,l){const h=f[0],u=f.at(-1);if(u==null)return[];const p=u.offset+u.size-h.offset;if(p<3e7){const _=new Uint8Array(await l.read(p,{at:h.offset}));return f.map(v=>{const s=v.offset-h.offset;return new EncodedVideoChunk({type:v.is_sync?"key":"delta",timestamp:v.cts,duration:v.duration,data:_.subarray(s,s+v.size)})})}return await Promise.all(f.map(async _=>new EncodedVideoChunk({type:_.is_sync?"key":"delta",timestamp:_.cts,duration:_.duration,data:await l.read(_.size,{at:_.offset})})))}function Vx(f,l,h){const u=new OffscreenCanvas(f,l),p=u.getContext("2d");return async _=>(p.drawImage(_,0,0,f,l),_.close(),await u.convertToBlob(h))}function Wx(f,l){if(f.length===0)return[];let h=0,u=0,p=-1;for(let b=0;b<f.length;b++){const A=f[b];if(p===-1&&l<A.cts&&(p=b-1),A.is_idr)if(p===-1)h=b;else{u=b;break}}const _=f[p];if(_==null)throw Error("Not found video sample by time");const v=f.slice(0,u===0?f.length:u).map(b=>({...b}));for(let b=h;b<v.length;b++){const A=v[b];l<A.cts&&(A.deleted=!0,A.cts=-1)}Rh(v);const s=f.slice(_.is_idr?p:h).map(b=>({...b,cts:b.cts-l}));for(const b of s)b.cts<0&&(b.deleted=!0,b.cts=-1);return Rh(s),[v,s]}function $x(f,l){if(f.length===0)return[];let h=-1;for(let _=0;_<f.length;_++){const v=f[_];if(!(l>v.cts)){h=_;break}}if(h===-1)throw Error("Not found audio sample by time");const u=f.slice(0,h).map(_=>({..._})),p=f.slice(h).map(_=>({..._,cts:_.cts-l}));return[u,p]}function Ph(f,l,h){let u=0;if(f.state==="configured"){for(;u<l.length;u++)f.decode(l[u]);f.flush().catch(p=>{if(!(p instanceof Error))throw p;if(p.message.includes("Decoding error")&&h.onDecodingError!=null){h.onDecodingError(p);return}if(!p.message.includes("Aborted due to close"))throw p})}}function Xx(f,l){if(l!=="avc1"&&l!=="hvc1")return 0;const h=new DataView(f.buffer);if(l==="avc1"&&(h.getUint8(4)&31)===6)return h.getUint32(0)+4;if(l==="hvc1"){const u=h.getUint8(4)>>1&63;if(u===39||u===40)return h.getUint32(0)+4}return 0}function Zx(f,l){if(l!=="avc1"&&l!=="hvc1")return!0;const h=new DataView(f.buffer);let u=0;for(;u<f.byteLength-4;){if(l==="avc1"&&(h.getUint8(u+4)&31)===5)return!0;if(l==="hvc1"){const p=h.getUint8(u+4)>>1&63;if(p===19||p===20)return!0}u+=h.getUint32(u)+4}return!1}async function jx(f,l,h,u,p,_){const v=await l.createReader(),s=await Mc(f.filter(I=>!I.deleted&&I.is_sync&&I.cts>=p.start&&I.cts<=p.end),v);if(s.length===0||u.aborted)return;let b=0;Ph(A(),s,{onDecodingError:I=>{zt.warn("thumbnailsByKeyFrame",I),b===0?Ph(A(!0),s,{onDecodingError:B=>{v.close(),zt.error("thumbnailsByKeyFrame retry soft deocde",B)}}):(_(null,!0),v.close())}});function A(I=!1){const B={...h,...I?{hardwareAcceleration:"prefer-software"}:{}},U=new VideoDecoder({output:N=>{b+=1;const t=b===s.length;_(N,t),t&&(v.close(),U.state!=="closed"&&U.close())},error:N=>{const t=`thumbnails decoder error: ${N.message}, config: ${JSON.stringify(B)}, state: ${JSON.stringify({qSize:U.decodeQueueSize,state:U.state,outputCnt:b,inputCnt:s.length})}`;throw zt.error(t),Error(t)}});return u.addEventListener("abort",()=>{v.close(),U.state!=="closed"&&U.close()}),U.configure(B),U}}function Rh(f){let l=0,h=null;for(const u of f)if(!u.deleted){if(u.is_sync&&(l+=1),l>=2)break;(h==null||u.cts<h.cts)&&(h=u)}h!=null&&h.cts<2e5&&(h.duration+=h.cts,h.cts=0)}function Oc(){try{const f=performance.memory;return{jsHeapSizeLimit:f.jsHeapSizeLimit,totalJSHeapSize:f.totalJSHeapSize,usedJSHeapSize:f.usedJSHeapSize,percentUsed:(f.usedJSHeapSize/f.jsHeapSizeLimit).toFixed(3),percentTotal:(f.totalJSHeapSize/f.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}var Xe,Fi,Pe,Dh,Nc;const Kx=class Xr{constructor(l){rt(this,Dh),de(this,"ready"),rt(this,Xe,{duration:0,width:0,height:0}),rt(this,Fi,null),rt(this,Pe,[]);const h=u=>(tt(this,Fi,u),T(this,Xe).width=u.width,T(this,Xe).height=u.height,T(this,Xe).duration=1/0,{...T(this,Xe)});if(l instanceof ReadableStream)this.ready=new Response(l).blob().then(u=>createImageBitmap(u)).then(h);else if(l instanceof ImageBitmap)this.ready=Promise.resolve(h(l));else if(Array.isArray(l)&&l.every(u=>u instanceof VideoFrame)){tt(this,Pe,l);const u=T(this,Pe)[0];if(u==null)throw Error("The frame count must be greater than 0");tt(this,Xe,{width:u.displayWidth,height:u.displayHeight,duration:T(this,Pe).reduce((p,_)=>p+(_.duration??0),0)}),this.ready=Promise.resolve({...T(this,Xe),duration:1/0})}else if("type"in l)this.ready=Pi(this,Dh,Nc).call(this,l.stream,l.type).then(()=>({width:T(this,Xe).width,height:T(this,Xe).height,duration:1/0}));else throw Error("Illegal arguments")}get meta(){return{...T(this,Xe)}}async tick(l){if(T(this,Fi)!=null)return{video:await createImageBitmap(T(this,Fi)),state:"success"};const h=l%T(this,Xe).duration;return{video:(T(this,Pe).find(u=>h>=u.timestamp&&h<=u.timestamp+(u.duration??0))??T(this,Pe)[0]).clone(),state:"success"}}async split(l){if(await this.ready,T(this,Fi)!=null)return[new Xr(await createImageBitmap(T(this,Fi))),new Xr(await createImageBitmap(T(this,Fi)))];let h=-1;for(let _=0;_<T(this,Pe).length;_++){const v=T(this,Pe)[_];if(!(l>v.timestamp)){h=_;break}}if(h===-1)throw Error("Not found frame by time");const u=T(this,Pe).slice(0,h).map(_=>new VideoFrame(_)),p=T(this,Pe).slice(h).map(_=>new VideoFrame(_,{timestamp:_.timestamp-l}));return[new Xr(u),new Xr(p)]}async clone(){await this.ready;const l=T(this,Fi)==null?T(this,Pe).map(h=>h.clone()):await createImageBitmap(T(this,Fi));return new Xr(l)}destroy(){var l;zt.info("ImgClip destroy"),(l=T(this,Fi))==null||l.close(),T(this,Pe).forEach(h=>h.close())}};Xe=new WeakMap,Fi=new WeakMap,Pe=new WeakMap,Dh=new WeakSet,Nc=async function(f,l){tt(this,Pe,await zx(f,l));const h=T(this,Pe)[0];if(h==null)throw Error("No frame available in gif");tt(this,Xe,{duration:T(this,Pe).reduce((u,p)=>u+(p.duration??0),0),width:h.codedWidth,height:h.codedHeight}),zt.info("ImgClip ready:",T(this,Xe))};let Ro=Kx;var ns,Rn,ur,_n,Mh,Gc,rr,cn;const Xs=class go{constructor(l,h={}){rt(this,Mh),de(this,"ready"),rt(this,ns,{duration:0,width:0,height:0}),rt(this,Rn,new Float32Array),rt(this,ur,new Float32Array),rt(this,_n),rt(this,rr,0),rt(this,cn,0),tt(this,_n,{loop:!1,volume:1,...h}),this.ready=Pi(this,Mh,Gc).call(this,l).then(()=>({width:0,height:0,duration:h.loop?1/0:T(this,ns).duration}))}get meta(){return{...T(this,ns),sampleRate:le.sampleRate,chanCount:2}}getPCMData(){return[T(this,Rn),T(this,ur)]}async tick(l){if(!T(this,_n).loop&&l>=T(this,ns).duration)return{audio:[],state:"done"};const h=l-T(this,rr);if(l<T(this,rr)||h>3e6)return tt(this,rr,l),tt(this,cn,Math.ceil(T(this,rr)/1e6*le.sampleRate)),{audio:[new Float32Array(0),new Float32Array(0)],state:"success"};tt(this,rr,l);const u=Math.ceil(h/1e6*le.sampleRate),p=T(this,cn)+u,_=T(this,_n).loop?[Kd(T(this,Rn),T(this,cn),p),Kd(T(this,ur),T(this,cn),p)]:[T(this,Rn).slice(T(this,cn),p),T(this,ur).slice(T(this,cn),p)];return tt(this,cn,p),{audio:_,state:"success"}}async split(l){await this.ready;const h=Math.ceil(l/1e6*le.sampleRate),u=new go(this.getPCMData().map(_=>_.slice(0,h)),T(this,_n)),p=new go(this.getPCMData().map(_=>_.slice(h)),T(this,_n));return[u,p]}async clone(){await this.ready;const l=new go(this.getPCMData(),T(this,_n));return await l.ready,l}destroy(){tt(this,Rn,new Float32Array(0)),tt(this,ur,new Float32Array(0)),zt.info("---- audioclip destroy ----")}};ns=new WeakMap,Rn=new WeakMap,ur=new WeakMap,_n=new WeakMap,Mh=new WeakSet,Gc=async function(f){Xs.ctx==null&&(Xs.ctx=new AudioContext({sampleRate:le.sampleRate}));const l=performance.now(),h=f instanceof ReadableStream?await qx(f,Xs.ctx):f;zt.info("Audio clip decoded complete:",performance.now()-l);const u=T(this,_n).volume;if(u!==1)for(const p of h)for(let _=0;_<p.length;_+=1)p[_]*=u;T(this,ns).duration=h[0].length/le.sampleRate*1e6,tt(this,Rn,h[0]),tt(this,ur,h[1]??T(this,Rn)),zt.info("Audio clip convert to AudioData, time:",performance.now()-l)},rr=new WeakMap,cn=new WeakMap,de(Xs,"ctx",null);let ru=Xs;async function qx(f,l){const h=await new Response(f).arrayBuffer();return Pc(await l.decodeAudioData(h))}var Zr,mo,jr,Zs;const Hc=class Yc{constructor(l){de(this,"ready"),rt(this,Zr,{duration:0,width:0,height:0}),rt(this,mo,()=>{}),de(this,"audioTrack"),rt(this,jr,null),rt(this,Zs),tt(this,Zs,l);const h=l.getVideoTracks()[0];if(h!=null){const{width:u,height:p}=h.getSettings();h.contentHint="motion",T(this,Zr).width=u??0,T(this,Zr).height=p??0,tt(this,jr,new OffscreenCanvas(u??0,p??0)),tt(this,mo,Qx(T(this,jr).getContext("2d"),h))}this.audioTrack=l.getAudioTracks()[0]??null,T(this,Zr).duration=1/0,this.ready=Promise.resolve(this.meta)}get meta(){return{...T(this,Zr)}}async tick(){return{video:T(this,jr)==null?null:await createImageBitmap(T(this,jr)),audio:[],state:"success"}}async split(){return[await this.clone(),await this.clone()]}async clone(){return new Yc(T(this,Zs).clone())}destroy(){T(this,Zs).getTracks().forEach(l=>l.stop()),T(this,mo).call(this)}};Zr=new WeakMap,mo=new WeakMap,jr=new WeakMap,Zs=new WeakMap,de(Hc,"ctx",null);let Jx=Hc;function Qx(f,l){return Ww(new MediaStreamTrackProcessor({track:l}).readable,{onChunk:async h=>{f.drawImage(h,0,0),h.close()},onDone:async()=>{}})}var Do,Mo,Oo,No,Go,Ho,sr,Kr,ar;const tb=class Vc{constructor(l,h,u,p,_){rt(this,sr),rt(this,Do,new mr),de(this,"on",T(this,Do).on),rt(this,Mo,0),rt(this,Oo,0),rt(this,No,0),rt(this,Go,0),rt(this,Ho,0),rt(this,ar,null),de(this,"fixedAspectRatio",!1),de(this,"fixedScaleCenter",!1),this.x=l??0,this.y=h??0,this.w=u??0,this.h=p??0,tt(this,ar,_??null)}get x(){return T(this,Mo)}set x(l){Pi(this,sr,Kr).call(this,"x",l)}get y(){return T(this,Oo)}set y(l){Pi(this,sr,Kr).call(this,"y",l)}get w(){return T(this,No)}set w(l){Pi(this,sr,Kr).call(this,"w",l)}get h(){return T(this,Go)}set h(l){Pi(this,sr,Kr).call(this,"h",l)}get angle(){return T(this,Ho)}set angle(l){Pi(this,sr,Kr).call(this,"angle",l)}get center(){const{x:l,y:h,w:u,h:p}=this;return{x:l+u/2,y:h+p/2}}clone(){const{x:l,y:h,w:u,h:p}=this,_=new Vc(l,h,u,p,T(this,ar));return _.angle=this.angle,_.fixedAspectRatio=this.fixedAspectRatio,_.fixedScaleCenter=this.fixedScaleCenter,_}checkHit(l,h){var u,p;let{angle:_,center:v,x:s,y:b,w:A,h:I}=this;const B=((u=T(this,ar))==null?void 0:u.center)??v,U=((p=T(this,ar))==null?void 0:p.angle)??_;T(this,ar)==null&&(s=s-B.x,b=b-B.y);const N=l-B.x,t=h-B.y;let e=N,n=t;return U!==0&&(e=N*Math.cos(U)+t*Math.sin(U),n=t*Math.cos(U)-N*Math.sin(U)),!(e<s||e>s+A||n<b||n>b+I)}};Do=new WeakMap,Mo=new WeakMap,Oo=new WeakMap,No=new WeakMap,Go=new WeakMap,Ho=new WeakMap,sr=new WeakSet,Kr=function(f,l){const h=this[f]!==l;switch(f){case"x":tt(this,Mo,l);break;case"y":tt(this,Oo,l);break;case"w":tt(this,No,l);break;case"h":tt(this,Go,l);break;case"angle":tt(this,Ho,l);break}h&&T(this,Do).emit("propsChange",{[f]:l})},ar=new WeakMap;let ji=tb;var yo,qr,js,or,pn;class Wc{constructor(){de(this,"rect",new ji),rt(this,yo,{offset:0,duration:0,playbackRate:1}),rt(this,qr,new mr),de(this,"on",T(this,qr).on),rt(this,js,0),de(this,"opacity",1),de(this,"flip",null),rt(this,or,null),rt(this,pn,null),de(this,"ready",Promise.resolve()),this.rect.on("propsChange",l=>{T(this,qr).emit("propsChange",{rect:l})})}get time(){return T(this,yo)}set time(l){Object.assign(T(this,yo),l)}get zIndex(){return T(this,js)}set zIndex(l){const h=T(this,js)!==l;tt(this,js,l),h&&T(this,qr).emit("propsChange",{zIndex:l})}_render(l){const{rect:{center:h,angle:u}}=this;l.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,h.x,h.y),l.rotate((this.flip==null?1:-1)*u),l.globalAlpha=this.opacity}setAnimation(l,h){tt(this,or,Object.entries(l).map(([u,p])=>{const _={from:0,to:100}[u]??Number(u.slice(0,-1));if(isNaN(_)||_>100||_<0)throw Error("keyFrame must between 0~100");return[_/100,p]})),tt(this,pn,Object.assign({},T(this,pn),{duration:h.duration,delay:h.delay??0,iterCount:h.iterCount??1/0}))}animate(l){if(T(this,or)==null||T(this,pn)==null||l<T(this,pn).delay)return;const h=eb(l,T(this,or),T(this,pn));for(const u in h)switch(u){case"opacity":this.opacity=h[u];break;case"x":case"y":case"w":case"h":case"angle":this.rect[u]=h[u];break}}copyStateTo(l){tt(l,or,T(this,or)),tt(l,pn,T(this,pn)),l.zIndex=this.zIndex,l.opacity=this.opacity,l.flip=this.flip,l.rect=this.rect.clone(),l.time={...this.time}}destroy(){T(this,qr).destroy()}}yo=new WeakMap,qr=new WeakMap,js=new WeakMap,or=new WeakMap,pn=new WeakMap;function eb(f,l,h){const u=f-h.delay;if(u/h.duration>=h.iterCount)return{};const p=u%h.duration,_=u===h.duration?1:p/h.duration,v=l.findIndex(N=>N[0]>=_);if(v===-1)return{};const s=l[v-1],b=l[v],A=b[1];if(s==null)return A;const I=s[1],B={},U=(_-s[0])/(b[0]-s[0]);for(const N in A){const t=N;I[t]!=null&&(B[t]=(A[t]-I[t])*U+I[t])}return B}var Jr,lr,vo;const ib=class $c extends Wc{constructor(l){super(),rt(this,Jr),rt(this,lr,null),rt(this,vo,!1),tt(this,Jr,l),this.ready=l.ready.then(({width:h,height:u,duration:p})=>{this.rect.w=this.rect.w===0?h:this.rect.w,this.rect.h=this.rect.h===0?u:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}async offscreenRender(l,h){var u;const p=h*this.time.playbackRate;this.animate(p),super._render(l);const{w:_,h:v}=this.rect,{video:s,audio:b,state:A}=await T(this,Jr).tick(p);let I=b??[];if(b!=null&&this.time.playbackRate!==1&&(I=b.map(U=>Rc(U,this.time.playbackRate))),A==="done")return{audio:I,done:!0};const B=s??T(this,lr);return B!=null&&l.drawImage(B,-_/2,-v/2,_,v),s!=null&&((u=T(this,lr))==null||u.close(),tt(this,lr,s)),{audio:I,done:!1}}async clone(){const l=new $c(await T(this,Jr).clone());return await l.ready,this.copyStateTo(l),l}destroy(){var l;T(this,vo)||(tt(this,vo,!0),zt.info("OffscreenSprite destroy"),super.destroy(),(l=T(this,lr))==null||l.close(),tt(this,lr,null),T(this,Jr).destroy())}};Jr=new WeakMap,lr=new WeakMap,vo=new WeakMap;let nb=ib;var rs,pr,hs,Ks,wo,Oh,xo,bo;const rb=class Xc extends Wc{constructor(l){super(),rt(this,wo),rt(this,rs),de(this,"visible",!0),rt(this,pr,null),rt(this,hs,[]),rt(this,Ks,!1),rt(this,xo,-1),rt(this,bo,!1),tt(this,rs,l),this.ready=l.ready.then(({width:h,height:u,duration:p})=>{this.rect.w=this.rect.w===0?h:this.rect.w,this.rect.h=this.rect.h===0?u:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}getClip(){return T(this,rs)}preFrame(l){Pi(this,wo,Oh).call(this,l)}render(l,h){this.animate(h),super._render(l);const{w:u,h:p}=this.rect;T(this,xo)!==h&&Pi(this,wo,Oh).call(this,h),tt(this,xo,h);const _=T(this,hs);tt(this,hs,[]);const v=T(this,pr);return v!=null&&l.drawImage(v,-u/2,-p/2,u,p),{audio:_}}copyStateTo(l){super.copyStateTo(l),l instanceof Xc&&(l.visible=this.visible)}destroy(){var l;T(this,bo)||(tt(this,bo,!0),zt.info("VisibleSprite destroy"),super.destroy(),(l=T(this,pr))==null||l.close(),tt(this,pr,null),T(this,rs).destroy())}};rs=new WeakMap,pr=new WeakMap,hs=new WeakMap,Ks=new WeakMap,wo=new WeakSet,Oh=function(f){T(this,Ks)||(tt(this,Ks,!0),T(this,rs).tick(f*this.time.playbackRate).then(({video:l,audio:h})=>{var u;l!=null&&((u=T(this,pr))==null||u.close(),tt(this,pr,l??null)),tt(this,hs,h??[]),h!=null&&this.time.playbackRate!==1&&tt(this,hs,h.map(p=>Rc(p,this.time.playbackRate)))}).finally(()=>{tt(this,Ks,!1)}))},xo=new WeakMap,bo=new WeakMap;let qa=rb,sb=0;async function Zc(f){f()>50&&(await eu(15),await Zc(f))}var gn,So,Ki,Js,Yo,Uo,ss,Qs,hr,Eo,jc,Kc;class ab{constructor(l={}){rt(this,Eo),rt(this,gn,zt.create(`id:${sb++},`)),rt(this,So,!1),rt(this,Ki,[]),rt(this,Js),rt(this,Yo),rt(this,Uo,null),rt(this,ss),rt(this,Qs),rt(this,hr,new mr),de(this,"on",T(this,hr).on);const{width:h=0,height:u=0}=l;tt(this,Js,new OffscreenCanvas(h,u));const p=T(this,Js).getContext("2d",{alpha:!1});if(p==null)throw Error("Can not create 2d offscreen context");tt(this,Yo,p),tt(this,ss,Object.assign({bgColor:"#000",width:0,height:0,videoCodec:"avc1.42E032",audio:!0,bitrate:5e6,fps:30,metaDataTags:null},l)),tt(this,Qs,h*u>0)}static async isSupported(l={}){return(self.OffscreenCanvas!=null&&self.VideoEncoder!=null&&self.VideoDecoder!=null&&self.VideoFrame!=null&&self.AudioEncoder!=null&&self.AudioDecoder!=null&&self.AudioData!=null&&((await self.VideoEncoder.isConfigSupported({codec:l.videoCodec??"avc1.42E032",width:l.width??1920,height:l.height??1080,bitrate:l.bitrate??7e6})).supported??!1)&&(await self.AudioEncoder.isConfigSupported({codec:le.codec,sampleRate:le.sampleRate,numberOfChannels:le.channelCount})).supported)??!1}async addSprite(l,h={}){const u={rect:ub(["x","y","w","h"],l.rect),time:{...l.time},zIndex:l.zIndex};T(this,gn).info("Combinator add sprite",u);const p=await l.clone();T(this,gn).info("Combinator add sprite ready"),T(this,Ki).push(Object.assign(p,{main:h.main??!1,expired:!1})),T(this,Ki).sort((_,v)=>_.zIndex-v.zIndex)}output(){if(T(this,Ki).length===0)throw Error("No sprite added");const l=T(this,Ki).find(b=>b.main),h=l!=null?l.time.offset+l.time.duration:Math.max(...T(this,Ki).map(b=>b.time.offset+b.time.duration));if(h===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");h===-1&&T(this,gn).warn("Unable to determine the end time, process value don't update"),T(this,gn).info(`start combinate video, maxTime:${h}`);const u=Pi(this,Eo,jc).call(this,h);let p=performance.now();const _=Pi(this,Eo,Kc).call(this,u,h,{onProgress:b=>{T(this,gn).debug("OutputProgress:",b),T(this,hr).emit("OutputProgress",b)},onEnded:async()=>{await u.flush(),T(this,gn).info("===== output ended =====, cost:",performance.now()-p),T(this,hr).emit("OutputProgress",1),this.destroy()},onError:b=>{T(this,hr).emit("error",b),s(b),this.destroy()}});tt(this,Uo,()=>{_(),u.close(),s()});const{stream:v,stop:s}=$w(u.mp4file,500,this.destroy);return v}destroy(){var l;T(this,So)||(tt(this,So,!0),(l=T(this,Uo))==null||l.call(this),T(this,hr).destroy())}}gn=new WeakMap,So=new WeakMap,Ki=new WeakMap,Js=new WeakMap,Yo=new WeakMap,Uo=new WeakMap,ss=new WeakMap,Qs=new WeakMap,hr=new WeakMap,Eo=new WeakSet,jc=function(f){const{fps:l,width:h,height:u,videoCodec:p,bitrate:_,audio:v,metaDataTags:s}=T(this,ss);return tx({video:T(this,Qs)?{width:h,height:u,expectFPS:l,codec:p,bitrate:_,__unsafe_hardwareAcceleration__:T(this,ss).__unsafe_hardwareAcceleration__}:null,audio:v===!1?null:{codec:"aac",sampleRate:le.sampleRate,channelCount:le.channelCount},duration:f,metaDataTags:s})},Kc=function(f,l,{onProgress:h,onEnded:u,onError:p}){let _=0;const v={aborted:!1};let s=null;(async()=>{const{fps:I,bgColor:B,audio:U}=T(this,ss),N=Math.round(1e6/I),t=T(this,Yo),e=ob({ctx:t,bgColor:B,sprites:T(this,Ki),aborter:v}),n=lb({remux:f,ctx:t,cvs:T(this,Js),outputAudio:U,hasVideoTrack:T(this,Qs),timeSlice:N});let a=0;for(;;){if(s!=null)return;if(v.aborted||l!==-1&&a>l||T(this,Ki).length===0){A(),await u();return}_=a/l;const{audios:d,mainSprDone:g}=await e(a);if(g){A(),await u();return}if(v.aborted)return;n(a,d),a+=N,await Zc(f.getEncodeQueueSize)}})().catch(I=>{s=I,T(this,gn).error(I),A(),p(I)});const b=setInterval(()=>{h(_)},500),A=()=>{v.aborted||(v.aborted=!0,clearInterval(b),T(this,Ki).forEach(I=>I.destroy()))};return A};function ob(f){const{ctx:l,bgColor:h,sprites:u,aborter:p}=f,{width:_,height:v}=l.canvas;return async s=>{l.fillStyle=h,l.fillRect(0,0,_,v);const b=[];let A=!1;for(const I of u){if(p.aborted)break;if(s<I.time.offset||I.expired)continue;l.save();const{audio:B,done:U}=await I.offscreenRender(l,s-I.time.offset);b.push(B),l.restore(),(I.time.duration>0&&s>I.time.offset+I.time.duration||U)&&(I.main&&(A=!0),I.destroy(),I.expired=!0)}return{audios:b,mainSprDone:A}}}function lb(f){const{ctx:l,cvs:h,outputAudio:u,remux:p,hasVideoTrack:_,timeSlice:v}=f,{width:s,height:b}=h;let A=0;const I=hb(1024);return(B,U)=>{if(u!==!1)for(const N of I(B,U))p.encodeAudio(N);if(_){const N=new VideoFrame(h,{duration:v,timestamp:B});p.encodeVideo(N,{keyFrame:A%150===0}),l.resetTransform(),l.clearRect(0,0,s,b),A+=1}}}function hb(f){const l=f*le.channelCount,h=new Float32Array(l*3);let u=0,p=0;const _=f/le.sampleRate*1e6,v=new Float32Array(l),s=b=>{let A=0;const I=Math.floor(u/l),B=[];for(let U=0;U<I;U++)B.push(new AudioData({timestamp:p,numberOfChannels:le.channelCount,numberOfFrames:f,sampleRate:le.sampleRate,format:"f32",data:h.subarray(A,A+l)})),A+=l,p+=_;for(h.set(h.subarray(A,u),0),u-=A;b-p>_;)B.push(new AudioData({timestamp:p,numberOfChannels:le.channelCount,numberOfFrames:f,sampleRate:le.sampleRate,format:"f32",data:v})),p+=_;return B};return(b,A)=>{var I,B;const U=Math.max(...A.map(N=>{var t;return((t=N[0])==null?void 0:t.length)??0}));for(let N=0;N<U;N++){let t=0,e=0;for(let n=0;n<A.length;n++){const a=((I=A[n][0])==null?void 0:I[N])??0,d=((B=A[n][1])==null?void 0:B[N])??a;t+=a,e+=d}h[u]=t,h[u+1]=e,u+=2}return s(b)}}function ub(f,l){return f.reduce((h,u)=>(h[u]=l[u],h),{})}var fb=Object.defineProperty,qc=f=>{throw TypeError(f)},db=(f,l,h)=>l in f?fb(f,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):f[l]=h,Co=(f,l,h)=>db(f,typeof l!="symbol"?l+"":l,h),su=(f,l,h)=>l.has(f)||qc("Cannot "+h),Q=(f,l,h)=>(su(f,l,"read from private field"),h?h.call(f):l.get(f)),be=(f,l,h)=>l.has(f)?qc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(f):l.set(f,h),si=(f,l,h,u)=>(su(f,l,"write to private field"),l.set(f,h),h),fr=(f,l,h)=>(su(f,l,"access private method"),h);const cb=["t","b","l","r","lt","lb","rt","rb","rotate"];function ds(f){return document.createElement(f)}function pb(f){let l=16;const h=new ResizeObserver(p=>{const _=p[0];_!=null&&(l=10/(_.contentRect.width/f.width))});h.observe(f);function u(p){const{w:_,h:v}=p,s=l,b=s/2,A=_/2,I=v/2,B=s*1.5,U=B/2;return{...p.fixedAspectRatio?{}:{t:new ji(-b,-I-b,s,s,p),b:new ji(-b,I-b,s,s,p),l:new ji(-A-b,-b,s,s,p),r:new ji(A-b,-b,s,s,p)},lt:new ji(-A-b,-I-b,s,s,p),lb:new ji(-A-b,I-b,s,s,p),rt:new ji(A-b,-I-b,s,s,p),rb:new ji(A-b,I-b,s,s,p),rotate:new ji(-U,-I-s*2-U,B,B,p)}}return{rectCtrlsGetter:u,destroy:()=>{h.disconnect()}}}var ea=(f=>(f.ActiveSpriteChange="activeSpriteChange",f.AddSprite="addSprite",f))(ea||{}),yi,Qr,ts,qs;class _b{constructor(){be(this,yi,[]),be(this,Qr,null),be(this,ts,new mr),Co(this,"on",Q(this,ts).on),be(this,qs,0)}get activeSprite(){return Q(this,Qr)}set activeSprite(l){l!==Q(this,Qr)&&(si(this,Qr,l),Q(this,ts).emit("activeSpriteChange",l))}async addSprite(l){await l.ready,Q(this,yi).push(l),si(this,yi,Q(this,yi).sort((h,u)=>h.zIndex-u.zIndex)),l.on("propsChange",h=>{h.zIndex!=null&&si(this,yi,Q(this,yi).sort((u,p)=>u.zIndex-p.zIndex))}),Q(this,ts).emit("addSprite",l)}removeSprite(l){Q(this,Qr)===l&&(this.activeSprite=null),si(this,yi,Q(this,yi).filter(h=>h!==l)),l.destroy()}getSprites(l={time:!0}){return Q(this,yi).filter(h=>h.visible&&(l.time?Q(this,qs)>=h.time.offset&&Q(this,qs)<=h.time.offset+h.time.duration:!0))}updateRenderTime(l){si(this,qs,l);const h=this.activeSprite;h!=null&&(l<h.time.offset||l>h.time.offset+h.time.duration)&&(this.activeSprite=null)}destroy(){Q(this,ts).destroy(),Q(this,yi).forEach(l=>l.destroy()),si(this,yi,[])}}yi=new WeakMap,Qr=new WeakMap,ts=new WeakMap,qs=new WeakMap;function gb(f,l,h,u){const p={w:l.clientWidth/l.width,h:l.clientHeight/l.height},_=new ResizeObserver(()=>{p.w=l.clientWidth/l.width,p.h=l.clientHeight/l.height,h.activeSprite!=null&&vh(h.activeSprite,v,s,p,u)});_.observe(l);const{rectEl:v,ctrlsEl:s}=mb(f),b=h.on(ea.ActiveSpriteChange,N=>{if(N==null){v.style.display="none";return}vh(N,v,s,p,u),v.style.display=""});let A=!1;const I=N=>{N.button===0&&(A=!0)},B=()=>{A=!1},U=()=>{!A||h.activeSprite==null||vh(h.activeSprite,v,s,p,u)};return l.addEventListener("mousedown",I),window.addEventListener("mouseup",B),window.addEventListener("mousemove",U),()=>{_.disconnect(),b(),v.remove(),l.removeEventListener("mousedown",I),window.removeEventListener("mouseup",B),window.removeEventListener("mousemove",U)}}function mb(f){const l=ds("div");l.style.cssText=`
    position: absolute;
    pointer-events: none;
    border: 1px solid #eee;
    box-sizing: border-box;
    display: none;
  `;const h=Object.fromEntries(cb.map(u=>{const p=ds("div");return p.style.cssText=`
        display: none;
        position: absolute;
        border: 1px solid #3ee; border-radius: 50%;
        box-sizing: border-box;
        background-color: #fff;
      `,[u,p]}));return Object.values(h).forEach(u=>l.appendChild(u)),f.appendChild(l),{rectEl:l,ctrlsEl:h}}function vh(f,l,h,u,p){const{x:_,y:v,w:s,h:b,angle:A}=f.rect;Object.assign(l.style,{left:`${_*u.w}px`,top:`${v*u.h}px`,width:`${s*u.w}px`,height:`${b*u.h}px`,rotate:`${A}rad`}),Object.entries(p(f.rect)).forEach(([I,{x:B,y:U,w:N,h:t}])=>{Object.assign(h[I].style,{display:"block",left:"50%",top:"50%",width:`${N*u.w}px`,height:`${t*u.h}px`,transform:`translate(${B*u.w}px, ${U*u.h}px)`})})}function yb(f,l,h){const u={w:f.clientWidth/f.width,h:f.clientHeight/f.height},p=new ResizeObserver(()=>{u.w=f.clientWidth/f.width,u.h=f.clientHeight/f.height});p.observe(f);const _=v=>{if(v.button!==0)return;const{offsetX:s,offsetY:b}=v,A=s/u.w,I=b/u.h;if(l.activeSprite!=null){const[B]=Object.entries(h(l.activeSprite.rect)).find(([,U])=>U.checkHit(A,I))??[];if(B!=null)return}l.activeSprite=l.getSprites().reverse().find(B=>B.visible&&B.rect.checkHit(A,I))??null};return f.addEventListener("mousedown",_),()=>{p.disconnect(),f.removeEventListener("mousedown",_)}}function vb(f,l,h,u){const p={w:f.clientWidth/f.width,h:f.clientHeight/f.height},_=new ResizeObserver(()=>{p.w=f.clientWidth/f.width,p.h=f.clientHeight/f.height});_.observe(f);let v=0,s=0,b=null;const A=Cb(f,h);let I=null;const B=t=>{if(t.button!==0||l.activeSprite==null)return;I=l.activeSprite;const{offsetX:e,offsetY:n,clientX:a,clientY:d}=t;Sb({rect:I.rect,offsetX:e,offsetY:n,clientX:a,clientY:d,cvsRatio:p,cvsEl:f,rectCtrlsGetter:u})||(b=I.rect.clone(),A.magneticEffect(I.rect.x,I.rect.y,I.rect),v=a,s=d,window.addEventListener("mousemove",U),window.addEventListener("mouseup",N))},U=t=>{if(I==null||b==null)return;const{clientX:e,clientY:n}=t;let a=b.x+(e-v)/p.w,d=b.y+(n-s)/p.h;Jc(I.rect,f,A.magneticEffect(a,d,I.rect))};f.addEventListener("mousedown",B);const N=()=>{A.hide(),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",N)};return()=>{_.disconnect(),A.destroy(),N(),f.removeEventListener("mousedown",B)}}function wb({sprRect:f,startX:l,startY:h,ctrlKey:u,cvsRatio:p,cvsEl:_}){const v=f.clone(),s=A=>{const{clientX:I,clientY:B}=A,U=(I-l)/p.w,N=(B-h)/p.h,t=u.length===1?xb:bb,{x:e,y:n,w:a,h:d}=v,g=Math.atan2(d,a),{incW:y,incH:w,incS:S,rotateAngle:L}=t({deltaX:U,deltaY:N,angle:f.angle,ctrlKey:u,diagonalAngle:g}),k=10;let F=a,G=d,R=v.fixedScaleCenter?y*2:y,lt=v.fixedScaleCenter?w*2:w,st=S;const bt=Math.sqrt(d**2+a**2),V=Math.sqrt((k*(d/a))**2+k**2);switch(u){case"l":F=Math.max(a+R,k),st=Math.min(S,a-k);break;case"r":F=Math.max(a+R,k),st=Math.max(S,k-a);break;case"b":G=Math.max(d+lt,k),st=Math.min(S,d-k);break;case"t":G=Math.max(d+lt,k),st=Math.max(S,k-d);break;case"lt":case"lb":F=Math.max(a+R,k),G=F===k?d/a*F:d+lt,st=Math.min(S,bt-V);break;case"rt":case"rb":F=Math.max(a+R,k),G=F===k?d/a*F:d+lt,st=Math.max(S,V-bt);break}let Yt=e,Tt=n;if(v.fixedScaleCenter)Yt=e+a/2-F/2,Tt=n+d/2-G/2;else{const Nt=st/2*Math.cos(L)+e+a/2,it=st/2*Math.sin(L)+n+d/2;Yt=Nt-F/2,Tt=it-G/2}Jc(f,_,{x:Yt,y:Tt,w:F,h:G})},b=()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",s),window.addEventListener("mouseup",b)}function xb({deltaX:f,deltaY:l,angle:h,ctrlKey:u}){let p=0,_=0,v=0,s=h;return u==="l"||u==="r"?(p=f*Math.cos(h)+l*Math.sin(h),_=p*(u==="l"?-1:1)):(u==="t"||u==="b")&&(s=h-Math.PI/2,p=f*Math.cos(s)+l*Math.sin(s),v=p*(u==="b"?-1:1)),{incW:_,incH:v,incS:p,rotateAngle:s}}function bb({deltaX:f,deltaY:l,angle:h,ctrlKey:u,diagonalAngle:p}){const _=(u==="lt"||u==="rb"?1:-1)*p+h,v=f*Math.cos(_)+l*Math.sin(_),s=u==="lt"||u==="lb"?-1:1,b=v*Math.cos(p)*s,A=v*Math.sin(p)*s;return{incW:b,incH:A,incS:v,rotateAngle:_}}function Sb({rect:f,cvsRatio:l,offsetX:h,offsetY:u,clientX:p,clientY:_,cvsEl:v,rectCtrlsGetter:s}){const b=h/l.w,A=u/l.h,[I]=Object.entries(s(f)).find(([,B])=>B.checkHit(b,A))??[];return I==null?!1:(I==="rotate"?Ub(f,Eb(f.center,l,v)):wb({sprRect:f,ctrlKey:I,startX:p,startY:_,cvsRatio:l,cvsEl:v}),!0)}function Ub(f,l){const h=({clientX:p,clientY:_})=>{const v=p-l.x,s=_-l.y,b=Math.atan2(s,v)+Math.PI/2;f.angle=b},u=()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",u)};window.addEventListener("mousemove",h),window.addEventListener("mouseup",u)}function Eb(f,l,h){const u=f.x*l.w,p=f.y*l.h,{left:_,top:v}=h.getBoundingClientRect();return{x:u+_,y:p+v}}function Jc(f,l,h){const u={x:f.x,y:f.y,w:f.w,h:f.h,...h},p=l.width*.05,_=l.height*.05;u.x<-u.w+p?u.x=-u.w+p:u.x>l.width-p&&(u.x=l.width-p),u.y<-u.h+_?u.y=-u.h+_:u.y>l.height-_&&(u.y=l.height-_),f.x=u.x,f.y=u.y,f.w=u.w,f.h=u.h}function Cb(f,l){const h="display: none; position: absolute;",u={w:0,h:0,x:0,y:0},p={vertMiddle:{...u,h:100,x:50,ref:{prop:"x",val:({w:b})=>(f.width-b)/2}},horMiddle:{...u,w:100,y:50,ref:{prop:"y",val:({h:b})=>(f.height-b)/2}},top:{...u,w:100,ref:{prop:"y",val:()=>0}},bottom:{...u,w:100,y:100,ref:{prop:"y",val:({h:b})=>f.height-b}},left:{...u,h:100,ref:{prop:"x",val:()=>0}},right:{...u,h:100,x:100,ref:{prop:"x",val:({w:b})=>f.width-b}}},_=ds("div");_.style.cssText=`
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    box-sizing: border-box;
  `;const v=Object.fromEntries(Object.entries(p).map(([b,{w:A,h:I,x:B,y:U}])=>{const N=ds("div");return N.style.cssText=`
        ${h}
        border-${A>0?"top":"left"}: 1px solid #3ee;
        top: ${U}%; left: ${B}%;
        ${B===100?"margin-left: -1px":""};
        ${U===100?"margin-top: -1px":""};
        width: ${A}%; height: ${I}%;
      `,_.appendChild(N),[b,N]}));l.appendChild(_);const s=6/(900/f.width);return{magneticEffect(b,A,I){const B={x:b,y:A};let U,N={x:!1,y:!1};for(U in p){const{prop:t,val:e}=p[U].ref;if(N[t])continue;const n=e(I);Math.abs(I[t]-n)<=s&&Math.abs(I[t]-(t==="x"?b:A))<=s?(B[t]=n,v[U].style.display="block",N[t]=!0):v[U].style.display="none"}return B},hide(){Object.values(v).forEach(b=>b.style.display="none")},destroy(){_.remove()}}}function Tb(f,l,h){const u={w:f.clientWidth/f.width,h:f.clientHeight/f.height},p=new ResizeObserver(()=>{u.w=f.clientWidth/f.width,u.h=f.clientHeight/f.height});p.observe(f);const _=f.style;let v=l.activeSprite;l.on(ea.ActiveSpriteChange,N=>{v=N,N==null&&(_.cursor="")});let s=!1;const b=({offsetX:N,offsetY:t})=>{s=!0;const e=N/u.w,n=t/u.h;(v==null?void 0:v.rect.checkHit(e,n))===!0&&_.cursor===""&&(_.cursor="move")},A=()=>{s=!1},I=["ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize"],B={t:0,rt:1,r:2,rb:3,b:4,lb:5,l:6,lt:7},U=N=>{if(v==null||s)return;const{offsetX:t,offsetY:e}=N,n=t/u.w,a=e/u.h,[d]=Object.entries(h(v.rect)).find(([,g])=>g.checkHit(n,a))??[];if(d!=null){if(d==="rotate"){_.cursor="crosshair";return}const g=v.rect.angle,y=g<0?g+2*Math.PI:g,w=(B[d]+Math.floor((y+Math.PI/8)/(Math.PI/4)))%8;_.cursor=I[w];return}if(v.rect.checkHit(n,a)){_.cursor="move";return}_.cursor=""};return f.addEventListener("mousemove",U),f.addEventListener("mousedown",b),window.addEventListener("mouseup",A),()=>{p.disconnect(),f.removeEventListener("mousemove",U),f.removeEventListener("mousedown",b),window.removeEventListener("mouseup",A)}}const Ab={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function Ib(f){const l=ds("canvas");return l.style.cssText=`
    width: 100%;
    height: 100%;
    display: block;
  `,l.width=f.width,l.height=f.height,l}var Ae,we,as,To,Ao,Io,Ln,Bo,Dn,yn,Vo,Wo,Ge,dr,cr,Qc,Li,zo;class Bb{constructor(l,h){be(this,yn),be(this,Ae),be(this,we),be(this,as),be(this,To,!1),be(this,Ao,[]),be(this,Io),be(this,Ln,new mr),Co(this,"on",Q(this,Ln).on),be(this,Bo),be(this,Dn,0),be(this,Ge,new AudioContext),be(this,dr,Q(this,Ge).createMediaStreamDestination()),be(this,cr,new Set),be(this,Li,{start:0,end:0,step:0,audioPlayAt:0}),be(this,zo,new WeakMap),Co(this,"addSprite",async B=>{Q(this,Ge).state==="suspended"&&Q(this,Ge).resume().catch(zt.error);const U=B.getClip();if(U instanceof Jx&&U.audioTrack!=null){const N=Q(this,Ge).createMediaStreamSource(new MediaStream([U.audioTrack]));N.connect(Q(this,dr)),Q(this,zo).set(B,N)}await Q(this,we).addSprite(B)}),Co(this,"removeSprite",B=>{var U;(U=Q(this,zo).get(B))==null||U.disconnect(),Q(this,we).removeSprite(B)}),si(this,Bo,h),si(this,Ae,Ib(h));const u=Q(this,Ae).getContext("2d",{alpha:!1});if(u==null)throw Error("canvas context is null");si(this,as,u);const p=ds("div");p.style.cssText="width: 100%; height: 100%; position: relative; overflow: hidden;",p.appendChild(Q(this,Ae)),l.appendChild(p),Fb(Q(this,Ge)).connect(Q(this,dr)),si(this,we,new _b);const{rectCtrlsGetter:_,destroy:v}=pb(Q(this,Ae));Q(this,Ao).push(v,yb(Q(this,Ae),Q(this,we),_),Tb(Q(this,Ae),Q(this,we),_),vb(Q(this,Ae),Q(this,we),p,_),gb(p,Q(this,Ae),Q(this,we),_),Q(this,we).on(ea.AddSprite,B=>{const{rect:U}=B;U.x===0&&U.y===0&&(U.x=(Q(this,Ae).width-U.w)/2,U.y=(Q(this,Ae).height-U.h)/2)}),mr.forwardEvent(Q(this,we),Q(this,Ln),[ea.ActiveSpriteChange]));let s=Q(this,Dn),b=performance.now(),A=0;const I=1e3/30;si(this,Io,qh(()=>{(performance.now()-b)/(I*A)<1||(A+=1,Q(this,as).fillStyle=h.bgColor,Q(this,as).fillRect(0,0,Q(this,Ae).width,Q(this,Ae).height),fr(this,yn,Qc).call(this),s!==Q(this,Dn)&&(s=Q(this,Dn),Q(this,Ln).emit("timeupdate",Math.round(s))))},I))}play(l){const h=Q(this,we).getSprites({time:!1}).map(p=>p.time.offset+p.time.duration),u=l.end??(h.length>0?Math.max(...h):1/0);if(l.start>=u||l.start<0)throw Error(`Invalid time parameter, ${JSON.stringify({start:l.start,end:u})}`);fr(this,yn,Vo).call(this,l.start),Q(this,we).getSprites({time:!1}).forEach(p=>{const{offset:_,duration:v}=p.time,s=Q(this,Dn)-_;p.preFrame(s>0&&s<v?s:0)}),Q(this,Li).start=l.start,Q(this,Li).end=u,Q(this,Li).step=(l.playbackRate??1)*(1e3/30)*1e3,Q(this,Ge).resume(),Q(this,Li).audioPlayAt=0,Q(this,Ln).emit("playing"),zt.info("AVCanvs play by:",Q(this,Li))}pause(){fr(this,yn,Wo).call(this)}previewFrame(l){fr(this,yn,Vo).call(this,l),fr(this,yn,Wo).call(this)}captureImage(){return Q(this,Ae).toDataURL()}get activeSprite(){return Q(this,we).activeSprite}set activeSprite(l){Q(this,we).activeSprite=l}destroy(){var l;Q(this,To)||(si(this,To,!0),Q(this,Ge).close(),Q(this,dr).disconnect(),Q(this,Ln).destroy(),Q(this,Io).call(this),(l=Q(this,Ae).parentElement)==null||l.remove(),Q(this,Ao).forEach(h=>h()),Q(this,cr).clear(),Q(this,we).destroy())}captureStream(){Q(this,Ge).state==="suspended"&&Q(this,Ge).resume().catch(zt.error);const l=new MediaStream(Q(this,Ae).captureStream().getTracks().concat(Q(this,dr).stream.getTracks()));return zt.info("AVCanvas.captureStream, tracks:",l.getTracks().map(h=>h.kind)),l}async createCombinator(l={}){zt.info("AVCanvas.createCombinator, opts:",l);const h=new ab({...Q(this,Bo),...l}),u=Q(this,we).getSprites({time:!1});if(u.length===0)throw Error("No sprite added");for(const p of u){const _=new nb(p.getClip());_.time={...p.time},p.copyStateTo(_),await h.addSprite(_)}return h}}Ae=new WeakMap,we=new WeakMap,as=new WeakMap,To=new WeakMap,Ao=new WeakMap,Io=new WeakMap,Ln=new WeakMap,Bo=new WeakMap,Dn=new WeakMap,yn=new WeakSet,Vo=function(f){si(this,Dn,f),Q(this,we).updateRenderTime(f)},Wo=function(){const f=Q(this,Li).step!==0;Q(this,Li).step=0,f&&(Q(this,Ln).emit("paused"),Q(this,Ge).suspend());for(const l of Q(this,cr))l.stop(),l.disconnect();Q(this,cr).clear()},Ge=new WeakMap,dr=new WeakMap,cr=new WeakMap,Qc=function(){var f;const l=Q(this,as);let h=Q(this,Dn);const{start:u,end:p,step:_,audioPlayAt:v}=Q(this,Li);_!==0&&h>=u&&h<p?h+=_:fr(this,yn,Wo).call(this),fr(this,yn,Vo).call(this,h);const s=[];for(const b of Q(this,we).getSprites()){l.save();const{audio:A}=b.render(l,h-b.time.offset);l.restore(),s.push(A)}if(l.resetTransform(),_!==0){const b=Math.max(Q(this,Ge).currentTime,v),A=zb(s,Q(this,Ge));let I=0;for(const B of A)B.start(b),B.connect(Q(this,Ge).destination),B.connect(Q(this,dr)),Q(this,cr).add(B),B.onended=()=>{B.disconnect(),Q(this,cr).delete(B)},I=Math.max(I,((f=B.buffer)==null?void 0:f.duration)??0);Q(this,Li).audioPlayAt=b+I}},Li=new WeakMap,zo=new WeakMap;function zb(f,l){const h=[];if(f.length===0)return h;for(const[u,p]of f){if(u==null||u.length<=0)continue;const _=l.createBuffer(2,u.length,Ab.sampleRate);_.copyToChannel(u,0),_.copyToChannel(p??u,1);const v=l.createBufferSource();v.buffer=_,h.push(v)}return h}function Fb(f){const l=f.createOscillator(),h=new Float32Array([0,0]),u=new Float32Array([0,0]),p=f.createPeriodicWave(h,u,{disableNormalization:!0});return l.setPeriodicWave(p),l.start(),l}const yr=Lw("track",{state:()=>({showContextMenu:!1,contextMenuPosition:{x:0,y:0},dragData:null,canvasSize:{width:0,height:0},currentHistoryIndex:-1,maxHistoryIndex:-1,maxHistorySize:50,clipUpdateSubscribers:new Map,activeClip:null}),getters:{getShowContextMenu:f=>f.showContextMenu,getContextMenuPosition:f=>f.contextMenuPosition,getDragData:f=>f.dragData,getCanvasSize:f=>f.canvasSize,canUndo:f=>f.currentHistoryIndex>0},actions:{subscribeToClipUpdates(f,l){this.clipUpdateSubscribers.set(f,l)},unsubscribeFromClipUpdates(f){this.clipUpdateSubscribers.delete(f)},publishClipUpdate(f,l="default"){const h=this.clipUpdateSubscribers.get(f.id);h&&h(f,l)},setShowContextMenu(f){this.showContextMenu=f},setContextMenuPosition(f){this.contextMenuPosition=f},setDragData(f){this.dragData=f},clearDragData(){this.dragData=null},setCanvasSize(f){this.canvasSize=f},async saveHistoryState(f,l){if(await Be.history.where("projectId").equals(f).and(u=>u.index>this.currentHistoryIndex).delete(),this.currentHistoryIndex++,this.maxHistoryIndex=this.currentHistoryIndex,await Be.history.add({projectId:f,tracks:JSON.parse(JSON.stringify(l)),index:this.currentHistoryIndex,timestamp:Date.now()}),await Be.history.where("projectId").equals(f).count()>this.maxHistorySize){const u=await Be.history.where("projectId").equals(f).and(p=>p.index===0).toArray();u.length>0&&(await Be.history.delete(u[0].id),this.currentHistoryIndex--,this.maxHistoryIndex--)}},async undo(f){if(!this.canUndo)return null;const l=await Be.history.where("projectId").equals(f).and(h=>h.index===this.currentHistoryIndex-1).first();return l?(this.currentHistoryIndex--,l.tracks):null},async redo(f){const l=await Be.history.where("projectId").equals(f).and(h=>h.index===this.currentHistoryIndex+1).first();return l?(this.currentHistoryIndex++,l.tracks):null},async getCanRedo(f){const l=await Be.history.where("projectId").equals(f).count();return console.log("getCanRedo",f,l,this.currentHistoryIndex),this.currentHistoryIndex<l-1},async clearHistory(f){await Be.history.where("projectId").equals(f).delete(),this.currentHistoryIndex=-1,this.maxHistoryIndex=-1},setActiveClip(f){this.activeClip=f}}});function kb(){return yr(kw)}kb();async function wh(f){return new Promise(async(l,h)=>{const u=ai(f);l(u)})}async function Lb(f){return new Promise(async(l,h)=>{try{f||h(null);let u=ai(f);if(await u.exists()){const _=await Pb(u),v=URL.createObjectURL(_);l(v)}}catch(u){console.error(u)}})}async function Pb(f){const l=await f.stream(),h=[],u=l.getReader(),p=async()=>{const{done:_,value:v}=await u.read();return _?new Blob(h):(h.push(v),p())};return p()}async function Rb(f="mp4"){return(await window.showSaveFilePicker({suggestedName:`WebAV-export-${Date.now()}.${f}`})).createWritable()}const tp=/^[a-z0-9]+(-[a-z0-9]+)*$/,Ko=(f,l,h,u="")=>{const p=f.split(":");if(f.slice(0,1)==="@"){if(p.length<2||p.length>3)return null;u=p.shift().slice(1)}if(p.length>3||!p.length)return null;if(p.length>1){const s=p.pop(),b=p.pop(),A={provider:p.length>0?p[0]:u,prefix:b,name:s};return l&&!Fo(A)?null:A}const _=p[0],v=_.split("-");if(v.length>1){const s={provider:u,prefix:v.shift(),name:v.join("-")};return l&&!Fo(s)?null:s}if(h&&u===""){const s={provider:u,prefix:"",name:_};return l&&!Fo(s,h)?null:s}return null},Fo=(f,l)=>f?!!((l&&f.prefix===""||f.prefix)&&f.name):!1,ep=Object.freeze({left:0,top:0,width:16,height:16}),$o=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),qo=Object.freeze({...ep,...$o}),Nh=Object.freeze({...qo,body:"",hidden:!1});function Db(f,l){const h={};!f.hFlip!=!l.hFlip&&(h.hFlip=!0),!f.vFlip!=!l.vFlip&&(h.vFlip=!0);const u=((f.rotate||0)+(l.rotate||0))%4;return u&&(h.rotate=u),h}function tc(f,l){const h=Db(f,l);for(const u in Nh)u in $o?u in f&&!(u in h)&&(h[u]=$o[u]):u in l?h[u]=l[u]:u in f&&(h[u]=f[u]);return h}function Mb(f,l){const h=f.icons,u=f.aliases||Object.create(null),p=Object.create(null);function _(v){if(h[v])return p[v]=[];if(!(v in p)){p[v]=null;const s=u[v]&&u[v].parent,b=s&&_(s);b&&(p[v]=[s].concat(b))}return p[v]}return Object.keys(h).concat(Object.keys(u)).forEach(_),p}function Ob(f,l,h){const u=f.icons,p=f.aliases||Object.create(null);let _={};function v(s){_=tc(u[s]||p[s],_)}return v(l),h.forEach(v),tc(f,_)}function ip(f,l){const h=[];if(typeof f!="object"||typeof f.icons!="object")return h;f.not_found instanceof Array&&f.not_found.forEach(p=>{l(p,null),h.push(p)});const u=Mb(f);for(const p in u){const _=u[p];_&&(l(p,Ob(f,p,_)),h.push(p))}return h}const Nb={provider:"",aliases:{},not_found:{},...ep};function xh(f,l){for(const h in l)if(h in f&&typeof f[h]!=typeof l[h])return!1;return!0}function np(f){if(typeof f!="object"||f===null)return null;const l=f;if(typeof l.prefix!="string"||!f.icons||typeof f.icons!="object"||!xh(f,Nb))return null;const h=l.icons;for(const p in h){const _=h[p];if(!p||typeof _.body!="string"||!xh(_,Nh))return null}const u=l.aliases||Object.create(null);for(const p in u){const _=u[p],v=_.parent;if(!p||typeof v!="string"||!h[v]&&!u[v]||!xh(_,Nh))return null}return l}const ec=Object.create(null);function Gb(f,l){return{provider:f,prefix:l,icons:Object.create(null),missing:new Set}}function cs(f,l){const h=ec[f]||(ec[f]=Object.create(null));return h[l]||(h[l]=Gb(f,l))}function rp(f,l){return np(l)?ip(l,(h,u)=>{u?f.icons[h]=u:f.missing.add(h)}):[]}function Hb(f,l,h){try{if(typeof h.body=="string")return f.icons[l]={...h},!0}catch{}return!1}let ia=!1;function sp(f){return typeof f=="boolean"&&(ia=f),ia}function Yb(f){const l=typeof f=="string"?Ko(f,!0,ia):f;if(l){const h=cs(l.provider,l.prefix),u=l.name;return h.icons[u]||(h.missing.has(u)?null:void 0)}}function Vb(f,l){const h=Ko(f,!0,ia);if(!h)return!1;const u=cs(h.provider,h.prefix);return l?Hb(u,h.name,l):(u.missing.add(h.name),!0)}function Wb(f,l){if(typeof f!="object")return!1;if(typeof l!="string"&&(l=f.provider||""),ia&&!l&&!f.prefix){let p=!1;return np(f)&&(f.prefix="",ip(f,(_,v)=>{Vb(_,v)&&(p=!0)})),p}const h=f.prefix;if(!Fo({provider:l,prefix:h,name:"a"}))return!1;const u=cs(l,h);return!!rp(u,f)}const ap=Object.freeze({width:null,height:null}),op=Object.freeze({...ap,...$o}),$b=/(-?[0-9.]*[0-9]+[0-9.]*)/g,Xb=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function ic(f,l,h){if(l===1)return f;if(h=h||100,typeof f=="number")return Math.ceil(f*l*h)/h;if(typeof f!="string")return f;const u=f.split($b);if(u===null||!u.length)return f;const p=[];let _=u.shift(),v=Xb.test(_);for(;;){if(v){const s=parseFloat(_);isNaN(s)?p.push(_):p.push(Math.ceil(s*l*h)/h)}else p.push(_);if(_=u.shift(),_===void 0)return p.join("");v=!v}}function Zb(f,l="defs"){let h="";const u=f.indexOf("<"+l);for(;u>=0;){const p=f.indexOf(">",u),_=f.indexOf("</"+l);if(p===-1||_===-1)break;const v=f.indexOf(">",_);if(v===-1)break;h+=f.slice(p+1,_).trim(),f=f.slice(0,u).trim()+f.slice(v+1)}return{defs:h,content:f}}function jb(f,l){return f?"<defs>"+f+"</defs>"+l:l}function Kb(f,l,h){const u=Zb(f);return jb(u.defs,l+u.content+h)}const qb=f=>f==="unset"||f==="undefined"||f==="none";function Jb(f,l){const h={...qo,...f},u={...op,...l},p={left:h.left,top:h.top,width:h.width,height:h.height};let _=h.body;[h,u].forEach(e=>{const n=[],a=e.hFlip,d=e.vFlip;let g=e.rotate;a?d?g+=2:(n.push("translate("+(p.width+p.left).toString()+" "+(0-p.top).toString()+")"),n.push("scale(-1 1)"),p.top=p.left=0):d&&(n.push("translate("+(0-p.left).toString()+" "+(p.height+p.top).toString()+")"),n.push("scale(1 -1)"),p.top=p.left=0);let y;switch(g<0&&(g-=Math.floor(g/4)*4),g=g%4,g){case 1:y=p.height/2+p.top,n.unshift("rotate(90 "+y.toString()+" "+y.toString()+")");break;case 2:n.unshift("rotate(180 "+(p.width/2+p.left).toString()+" "+(p.height/2+p.top).toString()+")");break;case 3:y=p.width/2+p.left,n.unshift("rotate(-90 "+y.toString()+" "+y.toString()+")");break}g%2===1&&(p.left!==p.top&&(y=p.left,p.left=p.top,p.top=y),p.width!==p.height&&(y=p.width,p.width=p.height,p.height=y)),n.length&&(_=Kb(_,'<g transform="'+n.join(" ")+'">',"</g>"))});const v=u.width,s=u.height,b=p.width,A=p.height;let I,B;v===null?(B=s===null?"1em":s==="auto"?A:s,I=ic(B,b/A)):(I=v==="auto"?b:v,B=s===null?ic(I,A/b):s==="auto"?A:s);const U={},N=(e,n)=>{qb(n)||(U[e]=n.toString())};N("width",I),N("height",B);const t=[p.left,p.top,b,A];return U.viewBox=t.join(" "),{attributes:U,viewBox:t,body:_}}const Qb=/\sid="(\S+)"/g,t1="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let e1=0;function i1(f,l=t1){const h=[];let u;for(;u=Qb.exec(f);)h.push(u[1]);if(!h.length)return f;const p="suffix"+(Math.random()*16777216|Date.now()).toString(16);return h.forEach(_=>{const v=typeof l=="function"?l(_):l+(e1++).toString(),s=_.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");f=f.replace(new RegExp('([#;"])('+s+')([")]|\\.[a-z])',"g"),"$1"+v+p+"$3")}),f=f.replace(new RegExp(p,"g"),""),f}const Gh=Object.create(null);function n1(f,l){Gh[f]=l}function Hh(f){return Gh[f]||Gh[""]}function au(f){let l;if(typeof f.resources=="string")l=[f.resources];else if(l=f.resources,!(l instanceof Array)||!l.length)return null;return{resources:l,path:f.path||"/",maxURL:f.maxURL||500,rotate:f.rotate||750,timeout:f.timeout||5e3,random:f.random===!0,index:f.index||0,dataAfterTimeout:f.dataAfterTimeout!==!1}}const ou=Object.create(null),Rs=["https://api.simplesvg.com","https://api.unisvg.com"],ko=[];for(;Rs.length>0;)Rs.length===1||Math.random()>.5?ko.push(Rs.shift()):ko.push(Rs.pop());ou[""]=au({resources:["https://api.iconify.design"].concat(ko)});function r1(f,l){const h=au(l);return h===null?!1:(ou[f]=h,!0)}function lu(f){return ou[f]}const s1=()=>{let f;try{if(f=fetch,typeof f=="function")return f}catch{}};let nc=s1();function a1(f,l){const h=lu(f);if(!h)return 0;let u;if(!h.maxURL)u=0;else{let p=0;h.resources.forEach(v=>{p=Math.max(p,v.length)});const _=l+".json?icons=";u=h.maxURL-p-h.path.length-_.length}return u}function o1(f){return f===404}const l1=(f,l,h)=>{const u=[],p=a1(f,l),_="icons";let v={type:_,provider:f,prefix:l,icons:[]},s=0;return h.forEach((b,A)=>{s+=b.length+1,s>=p&&A>0&&(u.push(v),v={type:_,provider:f,prefix:l,icons:[]},s=b.length),v.icons.push(b)}),u.push(v),u};function h1(f){if(typeof f=="string"){const l=lu(f);if(l)return l.path}return"/"}const u1=(f,l,h)=>{if(!nc){h("abort",424);return}let u=h1(l.provider);switch(l.type){case"icons":{const _=l.prefix,s=l.icons.join(","),b=new URLSearchParams({icons:s});u+=_+".json?"+b.toString();break}case"custom":{const _=l.uri;u+=_.slice(0,1)==="/"?_.slice(1):_;break}default:h("abort",400);return}let p=503;nc(f+u).then(_=>{const v=_.status;if(v!==200){setTimeout(()=>{h(o1(v)?"abort":"next",v)});return}return p=501,_.json()}).then(_=>{if(typeof _!="object"||_===null){setTimeout(()=>{_===404?h("abort",_):h("next",p)});return}setTimeout(()=>{h("success",_)})}).catch(()=>{h("next",p)})},f1={prepare:l1,send:u1};function d1(f){const l={loaded:[],missing:[],pending:[]},h=Object.create(null);f.sort((p,_)=>p.provider!==_.provider?p.provider.localeCompare(_.provider):p.prefix!==_.prefix?p.prefix.localeCompare(_.prefix):p.name.localeCompare(_.name));let u={provider:"",prefix:"",name:""};return f.forEach(p=>{if(u.name===p.name&&u.prefix===p.prefix&&u.provider===p.provider)return;u=p;const _=p.provider,v=p.prefix,s=p.name,b=h[_]||(h[_]=Object.create(null)),A=b[v]||(b[v]=cs(_,v));let I;s in A.icons?I=l.loaded:v===""||A.missing.has(s)?I=l.missing:I=l.pending;const B={provider:_,prefix:v,name:s};I.push(B)}),l}function lp(f,l){f.forEach(h=>{const u=h.loaderCallbacks;u&&(h.loaderCallbacks=u.filter(p=>p.id!==l))})}function c1(f){f.pendingCallbacksFlag||(f.pendingCallbacksFlag=!0,setTimeout(()=>{f.pendingCallbacksFlag=!1;const l=f.loaderCallbacks?f.loaderCallbacks.slice(0):[];if(!l.length)return;let h=!1;const u=f.provider,p=f.prefix;l.forEach(_=>{const v=_.icons,s=v.pending.length;v.pending=v.pending.filter(b=>{if(b.prefix!==p)return!0;const A=b.name;if(f.icons[A])v.loaded.push({provider:u,prefix:p,name:A});else if(f.missing.has(A))v.missing.push({provider:u,prefix:p,name:A});else return h=!0,!0;return!1}),v.pending.length!==s&&(h||lp([f],_.id),_.callback(v.loaded.slice(0),v.missing.slice(0),v.pending.slice(0),_.abort))})}))}let p1=0;function _1(f,l,h){const u=p1++,p=lp.bind(null,h,u);if(!l.pending.length)return p;const _={id:u,icons:l,callback:f,abort:p};return h.forEach(v=>{(v.loaderCallbacks||(v.loaderCallbacks=[])).push(_)}),p}function g1(f,l=!0,h=!1){const u=[];return f.forEach(p=>{const _=typeof p=="string"?Ko(p,l,h):p;_&&u.push(_)}),u}var m1={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function y1(f,l,h,u){const p=f.resources.length,_=f.random?Math.floor(Math.random()*p):f.index;let v;if(f.random){let S=f.resources.slice(0);for(v=[];S.length>1;){const L=Math.floor(Math.random()*S.length);v.push(S[L]),S=S.slice(0,L).concat(S.slice(L+1))}v=v.concat(S)}else v=f.resources.slice(_).concat(f.resources.slice(0,_));const s=Date.now();let b="pending",A=0,I,B=null,U=[],N=[];typeof u=="function"&&N.push(u);function t(){B&&(clearTimeout(B),B=null)}function e(){b==="pending"&&(b="aborted"),t(),U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function n(S,L){L&&(N=[]),typeof S=="function"&&N.push(S)}function a(){return{startTime:s,payload:l,status:b,queriesSent:A,queriesPending:U.length,subscribe:n,abort:e}}function d(){b="failed",N.forEach(S=>{S(void 0,I)})}function g(){U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function y(S,L,k){const F=L!=="success";switch(U=U.filter(G=>G!==S),b){case"pending":break;case"failed":if(F||!f.dataAfterTimeout)return;break;default:return}if(L==="abort"){I=k,d();return}if(F){I=k,U.length||(v.length?w():d());return}if(t(),g(),!f.random){const G=f.resources.indexOf(S.resource);G!==-1&&G!==f.index&&(f.index=G)}b="completed",N.forEach(G=>{G(k)})}function w(){if(b!=="pending")return;t();const S=v.shift();if(S===void 0){if(U.length){B=setTimeout(()=>{t(),b==="pending"&&(g(),d())},f.timeout);return}d();return}const L={status:"pending",resource:S,callback:(k,F)=>{y(L,k,F)}};U.push(L),A++,B=setTimeout(w,f.rotate),h(S,l,L.callback)}return setTimeout(w),a}function hp(f){const l={...m1,...f};let h=[];function u(){h=h.filter(s=>s().status==="pending")}function p(s,b,A){const I=y1(l,s,b,(B,U)=>{u(),A&&A(B,U)});return h.push(I),I}function _(s){return h.find(b=>s(b))||null}return{query:p,find:_,setIndex:s=>{l.index=s},getIndex:()=>l.index,cleanup:u}}function rc(){}const bh=Object.create(null);function v1(f){if(!bh[f]){const l=lu(f);if(!l)return;const h=hp(l),u={config:l,redundancy:h};bh[f]=u}return bh[f]}function w1(f,l,h){let u,p;if(typeof f=="string"){const _=Hh(f);if(!_)return h(void 0,424),rc;p=_.send;const v=v1(f);v&&(u=v.redundancy)}else{const _=au(f);if(_){u=hp(_);const v=f.resources?f.resources[0]:"",s=Hh(v);s&&(p=s.send)}}return!u||!p?(h(void 0,424),rc):u.query(l,p,h)().abort}function sc(){}function x1(f){f.iconsLoaderFlag||(f.iconsLoaderFlag=!0,setTimeout(()=>{f.iconsLoaderFlag=!1,c1(f)}))}function b1(f){const l=[],h=[];return f.forEach(u=>{(u.match(tp)?l:h).push(u)}),{valid:l,invalid:h}}function Ds(f,l,h){function u(){const p=f.pendingIcons;l.forEach(_=>{p&&p.delete(_),f.icons[_]||f.missing.add(_)})}if(h&&typeof h=="object")try{if(!rp(f,h).length){u();return}}catch(p){console.error(p)}u(),x1(f)}function ac(f,l){f instanceof Promise?f.then(h=>{l(h)}).catch(()=>{l(null)}):l(f)}function S1(f,l){f.iconsToLoad?f.iconsToLoad=f.iconsToLoad.concat(l).sort():f.iconsToLoad=l,f.iconsQueueFlag||(f.iconsQueueFlag=!0,setTimeout(()=>{f.iconsQueueFlag=!1;const{provider:h,prefix:u}=f,p=f.iconsToLoad;if(delete f.iconsToLoad,!p||!p.length)return;const _=f.loadIcon;if(f.loadIcons&&(p.length>1||!_)){ac(f.loadIcons(p,u,h),I=>{Ds(f,p,I)});return}if(_){p.forEach(I=>{const B=_(I,u,h);ac(B,U=>{const N=U?{prefix:u,icons:{[I]:U}}:null;Ds(f,[I],N)})});return}const{valid:v,invalid:s}=b1(p);if(s.length&&Ds(f,s,null),!v.length)return;const b=u.match(tp)?Hh(h):null;if(!b){Ds(f,v,null);return}b.prepare(h,u,v).forEach(I=>{w1(h,I,B=>{Ds(f,I.icons,B)})})}))}const U1=(f,l)=>{const h=g1(f,!0,sp()),u=d1(h);if(!u.pending.length){let b=!0;return l&&setTimeout(()=>{b&&l(u.loaded,u.missing,u.pending,sc)}),()=>{b=!1}}const p=Object.create(null),_=[];let v,s;return u.pending.forEach(b=>{const{provider:A,prefix:I}=b;if(I===s&&A===v)return;v=A,s=I,_.push(cs(A,I));const B=p[A]||(p[A]=Object.create(null));B[I]||(B[I]=[])}),u.pending.forEach(b=>{const{provider:A,prefix:I,name:B}=b,U=cs(A,I),N=U.pendingIcons||(U.pendingIcons=new Set);N.has(B)||(N.add(B),p[A][I].push(B))}),_.forEach(b=>{const A=p[b.provider][b.prefix];A.length&&S1(b,A)}),l?_1(l,u,_):sc};function E1(f,l){const h={...f};for(const u in l){const p=l[u],_=typeof p;u in ap?(p===null||p&&(_==="string"||_==="number"))&&(h[u]=p):_===typeof h[u]&&(h[u]=u==="rotate"?p%4:p)}return h}const C1=/[\s,]+/;function T1(f,l){l.split(C1).forEach(h=>{switch(h.trim()){case"horizontal":f.hFlip=!0;break;case"vertical":f.vFlip=!0;break}})}function A1(f,l=0){const h=f.replace(/^-?[0-9.]*/,"");function u(p){for(;p<0;)p+=4;return p%4}if(h===""){const p=parseInt(f);return isNaN(p)?0:u(p)}else if(h!==f){let p=0;switch(h){case"%":p=25;break;case"deg":p=90}if(p){let _=parseFloat(f.slice(0,f.length-h.length));return isNaN(_)?0:(_=_/p,_%1===0?u(_):0)}}return l}function I1(f,l){let h=f.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const u in l)h+=" "+u+'="'+l[u]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+h+">"+f+"</svg>"}function B1(f){return f.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function z1(f){return"data:image/svg+xml,"+B1(f)}function F1(f){return'url("'+z1(f)+'")'}const oc={...op,inline:!1},k1={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},L1={display:"inline-block"},Yh={backgroundColor:"currentColor"},up={backgroundColor:"transparent"},lc={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},hc={webkitMask:Yh,mask:Yh,background:up};for(const f in hc){const l=hc[f];for(const h in lc)l[f+h]=lc[h]}const Lo={};["horizontal","vertical"].forEach(f=>{const l=f.slice(0,1)+"Flip";Lo[f+"-flip"]=l,Lo[f.slice(0,1)+"-flip"]=l,Lo[f+"Flip"]=l});function uc(f){return f+(f.match(/^[-0-9.]+$/)?"px":"")}const fc=(f,l)=>{const h=E1(oc,l),u={...k1},p=l.mode||"svg",_={},v=l.style,s=typeof v=="object"&&!(v instanceof Array)?v:{};for(let e in l){const n=l[e];if(n!==void 0)switch(e){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":h[e]=n===!0||n==="true"||n===1;break;case"flip":typeof n=="string"&&T1(h,n);break;case"color":_.color=n;break;case"rotate":typeof n=="string"?h[e]=A1(n):typeof n=="number"&&(h[e]=n);break;case"ariaHidden":case"aria-hidden":n!==!0&&n!=="true"&&delete u["aria-hidden"];break;default:{const a=Lo[e];a?(n===!0||n==="true"||n===1)&&(h[a]=!0):oc[e]===void 0&&(u[e]=n)}}}const b=Jb(f,h),A=b.attributes;if(h.inline&&(_.verticalAlign="-0.125em"),p==="svg"){u.style={..._,...s},Object.assign(u,A);let e=0,n=l.id;return typeof n=="string"&&(n=n.replace(/-/g,"_")),u.innerHTML=i1(b.body,n?()=>n+"ID"+e++:"iconifyVue"),Gd("svg",u)}const{body:I,width:B,height:U}=f,N=p==="mask"||(p==="bg"?!1:I.indexOf("currentColor")!==-1),t=I1(I,{...A,width:B+"",height:U+""});return u.style={..._,"--svg":F1(t),width:uc(A.width),height:uc(A.height),...L1,...N?Yh:up,...s},Gd("span",u)};sp(!0);n1("",f1);if(typeof document<"u"&&typeof window<"u"){const f=window;if(f.IconifyPreload!==void 0){const l=f.IconifyPreload,h="Invalid IconifyPreload syntax.";typeof l=="object"&&l!==null&&(l instanceof Array?l:[l]).forEach(u=>{try{(typeof u!="object"||u===null||u instanceof Array||typeof u.icons!="object"||typeof u.prefix!="string"||!Wb(u))&&console.error(h)}catch{console.error(h)}})}if(f.IconifyProviders!==void 0){const l=f.IconifyProviders;if(typeof l=="object"&&l!==null)for(let h in l){const u="IconifyProviders["+h+"] is invalid.";try{const p=l[h];if(typeof p!="object"||!p||p.resources===void 0)continue;r1(h,p)||console.error(u)}catch{console.error(u)}}}}const P1={...qo,body:""},ie=Di({inheritAttrs:!1,data(){return{_name:"",_loadingIcon:null,iconMounted:!1,counter:0}},mounted(){this.iconMounted=!0},unmounted(){this.abortLoading()},methods:{abortLoading(){this._loadingIcon&&(this._loadingIcon.abort(),this._loadingIcon=null)},getIcon(f,l,h){if(typeof f=="object"&&f!==null&&typeof f.body=="string")return this._name="",this.abortLoading(),{data:f};let u;if(typeof f!="string"||(u=Ko(f,!1,!0))===null)return this.abortLoading(),null;let p=Yb(u);if(!p)return(!this._loadingIcon||this._loadingIcon.name!==f)&&(this.abortLoading(),this._name="",p!==null&&(this._loadingIcon={name:f,abort:U1([u],()=>{this.counter++})})),null;if(this.abortLoading(),this._name!==f&&(this._name=f,l&&l(f)),h){p=Object.assign({},p);const v=h(p.body,u.name,u.prefix,u.provider);typeof v=="string"&&(p.body=v)}const _=["iconify"];return u.prefix!==""&&_.push("iconify--"+u.prefix),u.provider!==""&&_.push("iconify--"+u.provider),{data:p,classes:_}}},render(){this.counter;const f=this.$attrs,l=this.iconMounted||f.ssr?this.getIcon(f.icon,f.onLoad,f.customise):null;if(!l)return fc(P1,f);let h=f;return l.classes&&(h={...f,class:(typeof f.class=="string"?f.class+" ":"")+l.classes.join(" ")}),fc({...qo,...l.data},h)}});var xe,Ue,us,Lt,_r,Ri,Wh,$h,Xh;const uu=class uu{constructor(l,h){Jn(this,Ri);Jn(this,xe);Jn(this,Ue);Jn(this,us);Nd(this,"ready");Jn(this,Lt);Jn(this,_r,{width:0,height:0,duration:1/0});Qn(this,xe,document.createElement("canvas")),Qn(this,Lt,l),Qn(this,us,h),Qn(this,Ue,ft(this,xe).getContext("2d"));const u=ft(this,Lt).content.split(`
`),{xPadding:p,yPadding:_}=tr(this,Ri,Wh).call(this);ft(this,xe).width=tr(this,Ri,$h).call(this,u)+p*2,ft(this,xe).height=tr(this,Ri,Xh).call(this,u)+_*2,this.ready=Promise.resolve({width:ft(this,xe).width,height:ft(this,xe).height,duration:1/0}),ft(this,Ue).font=`${ft(this,Lt).fontSize}px ${ft(this,Lt).fontFamily}`}get textConfig(){return ft(this,Lt)}set textConfig(l){Qn(this,Lt,l)}get meta(){return ft(this,_r)}set meta(l){Qn(this,_r,l)}async tick(l){const h=ft(this,Lt).content.split(`
`),{xPadding:u,yPadding:p}=tr(this,Ri,Wh).call(this),_=tr(this,Ri,$h).call(this,h),v=tr(this,Ri,Xh).call(this,h);ft(this,xe).width=_+u*2,ft(this,xe).height=v+p*2,ft(this,_r).width=ft(this,xe).width,ft(this,_r).height=ft(this,xe).height,ft(this,us).call(this,_+u*2,v+p*2),ft(this,Ue).clearRect(0,0,ft(this,xe).width,ft(this,xe).height),ft(this,Ue).fillStyle=ft(this,Lt).color,ft(this,Ue).font=`${ft(this,Lt).bold?"bold":""} ${ft(this,Lt).italic?"italic":""} ${ft(this,Lt).fontSize}px ${ft(this,Lt).fontFamily}`,ft(this,Ue).textBaseline="hanging",ft(this,Lt).showShadow&&(ft(this,Ue).shadowColor=ft(this,Lt).shadowColor,ft(this,Ue).shadowBlur=ft(this,Lt).shadowBlur,ft(this,Ue).shadowOffsetX=ft(this,Lt).shadowOffsetX,ft(this,Ue).shadowOffsetY=ft(this,Lt).shadowOffsetY);let s=0,b=0;for(let A=0;A<h.length;A++){let I=ft(this,Lt).fontSize*h[A].length+ft(this,Lt).letterSpacing*(h[A].length-1);switch(ft(this,Lt).align){case"left":s=0;break;case"center":s=(ft(this,xe).width-I)/2;break;case"right":s=ft(this,xe).width-I;break}for(let B=0;B<h[A].length;B++)ft(this,Lt).showStroke&&(ft(this,Ue).lineJoin="round",ft(this,Ue).strokeStyle=ft(this,Lt).strokeColor,ft(this,Ue).lineWidth=ft(this,Lt).strokeWidth,ft(this,Ue).strokeText(h[A][B],s+B*ft(this,Lt).fontSize+ft(this,Lt).letterSpacing*B,A*ft(this,Lt).fontSize+ft(this,Lt).lineSpacing*A+b)),ft(this,Ue).fillText(h[A][B],B*ft(this,Lt).fontSize+ft(this,Lt).letterSpacing*B+s,A*ft(this,Lt).fontSize+ft(this,Lt).lineSpacing*A+b)}return{state:"success",video:new VideoFrame(ft(this,xe),{timestamp:l})}}async generateImage(){const{video:l}=await this.tick(0),h=new OffscreenCanvas(l.codedWidth,l.codedHeight);h.getContext("2d").drawImage(l,0,0,l.codedWidth,l.codedHeight);const p=await h.convertToBlob(),_=document.createElement("a");_.href=URL.createObjectURL(p),_.download="text.png",_.click()}async clone(){return new uu(ft(this,Lt),ft(this,us))}destroy(){ft(this,xe).remove()}};xe=new WeakMap,Ue=new WeakMap,us=new WeakMap,Lt=new WeakMap,_r=new WeakMap,Ri=new WeakSet,Wh=function(){let l=0,h=0;const u=ft(this,Lt);return l=Math.max(u.showStroke?u.strokeWidth:0,u.showShadow?Math.max(u.shadowBlur,u.shadowOffsetX):0),h=Math.max(u.showStroke?u.strokeWidth:0,u.showShadow?Math.max(u.shadowBlur,u.shadowOffsetY):0),{xPadding:l,yPadding:h}},$h=function(l){return Math.max(...l.map(h=>ft(this,Lt).fontSize*h.length+ft(this,Lt).letterSpacing*(h.length-1)))},Xh=function(l){return ft(this,Lt).fontSize*l.length+ft(this,Lt).lineSpacing*(l.length-1)};let Vh=uu;const R1={class:"flex-1 flex items-center justify-center"},D1={class:"control-bar w-full px-4 py-4 flex items-center gap-4"},M1={class:"text-white text-base"},O1={class:"text-white text-base"},N1={class:"flex w-full items-center justify-center gap-6"},G1={class:"text-white hover:text-purple-500 transition-colors"},H1={class:"ml-auto flex items-center gap-4"},Y1=Di({__name:"Player",props:{tracks:{},currentTime:{},playerDuration:{}},emits:["prevFrame","nextFrame","timeUpdate","fullscreenChange","updateClipProps"],setup(f,{expose:l,emit:h}){const u=f,p=h,_=yr(),v=Kh("activeClip"),s=pt(!0),b=pt(!1),A=pt(100),I=pt(!1),B=pt(!1),U=pt(null),N=pt(null),t=pt(0);let e=null;Ee(()=>I.value||A.value===0?"fa-volume-mute":A.value<30?"fa:volume-off":A.value<70?"fa-volume-down":"fa-volume-up");const n=Ee(()=>_.getCanvasSize),a=Ee(()=>u.tracks.length),d=Y=>{Y?(e.play({start:u.currentTime*1e6}),b.value=!0):(e.pause(),b.value=!1)},g=()=>{b.value&&d(!1),p("timeUpdate",u.currentTime-1/30),e.previewFrame(u.currentTime*1e6)},y=()=>{b.value&&d(!1),p("timeUpdate",u.currentTime+1/30),e.previewFrame(u.currentTime*1e6)},w=()=>{B.value=!B.value,B.value?N.value&&N.value.requestFullscreen():document.exitFullscreen()},S=Y=>{const K=document.activeElement;if(!(K instanceof HTMLInputElement||K instanceof HTMLTextAreaElement||(K==null?void 0:K.getAttribute("contenteditable"))==="true"))switch(Y.code){case"Space":Y.preventDefault(),d(!b.value);break;case"ArrowLeft":Y.preventDefault(),g();break;case"ArrowRight":Y.preventDefault(),y();break}},L=()=>{e=new Bb(U.value,{bgColor:"#000",width:1920,height:1080}),console.log(e),F(),e.previewFrame(0),e.on("timeupdate",Y=>{p("timeUpdate",Y/1e6)}),e.on("playing",()=>{console.log("playing")}),e.on("paused",()=>{console.log("paused"),u.currentTime>=u.playerDuration&&(b.value=!1,p("timeUpdate",0))}),e.on("activeSpriteChange",Y=>{for(const[K,at]of k.entries())Object.is(at,Y)&&v(K)})},k=new Map,F=()=>{u.tracks.forEach(Y=>{Y.clips.forEach(K=>{lt(K)})})},G=Y=>{lt(Y)},R=Y=>{if(!Y)return e.activeSprite=null;const K=k.get(Y.id);e&&(K!=null&&K.visible)&&(e.activeSprite=K)},lt=async Y=>{if(k.has(Y.id))return;let K=null;switch(Y.type){case"video":{let at=await wh(Y.path),X=await new nu(await at.stream());X.tickInterceptor=async(Ht,he)=>{let Ke=[];for(const He of he.audio)Ke.push(He.map(ut=>ut=ut*(Y.volume/100)));return he.audio=Ke,he},Number(Y.sourceStartTime)>0&&(X=(await X.split(Number(Y.sourceStartTime)*1e6))[1]),K=new qa(X);break}case"audio":{const at=await wh(Y.path);let X=await new ru(await at.stream());if(Number(Y.sourceStartTime)>0){const Ht=await X.split(Number(Y.sourceStartTime)*1e6);Number(Y.sourceEndTime)?X=(await Ht[1].split((Number(Y.originalDuration)-Number(Y.sourceEndTime)-Number(Y.sourceStartTime))*1e6))[0]:X=Ht[1]}K=new qa(X),K.visible=!1;break}case"image":{const at=await wh(Y.path);let X=null;if(Y.isAnimateImg){const Ht=at.name.split(".").pop();X=new Ro({type:`image/${Ht}`,stream:await at.stream()})}else X=new Ro(await at.stream());K=new qa(X);break}case"text":{const at=new Vh(Y.textConfig,(X,Ht)=>{p("updateClipProps",Y.id,{w:X,h:Ht})});K=new qa(at);break}}K&&(K.time.offset=Number(Y.startTime)*1e6,K.time.duration=Number(Y.duration)*1e6,K.opacity=Number((Y.opacity/100).toFixed(2)),K.rect.fixedScaleCenter=!0,K.rect.fixedAspectRatio=!0,k.set(Y.id,K),await(e==null?void 0:e.addSprite(K)),Y.type!=="audio"&&(Y.w?(K.rect.x=Y.x,K.rect.y=Y.y,K.rect.w=Y.w,K.rect.h=Y.h,K.rect.angle=Y.angle):Y.type==="text"?p("updateClipProps",Y.id,{x:K.rect.x,y:K.rect.y,w:Y.textConfig.width,h:Y.textConfig.height,angle:K.rect.angle}):p("updateClipProps",Y.id,{x:K.rect.x,y:K.rect.y,w:K.rect.w,h:K.rect.h,angle:K.rect.angle})),K.rect.on("propsChange",at=>{Y.type==="text"?"w"in at&&Y.w&&(Y.textConfig.fontSize=at.w/Y.w*Y.textConfig.fontSize,Y.w=at.w):p("updateClipProps",Y.id,at)}),_.unsubscribeFromClipUpdates(Y.id),_.subscribeToClipUpdates(Y.id,async(at,X)=>{bt(at,X)}),t.value++)},st=()=>{let Y=0;u.tracks.forEach(K=>{K.clips.forEach(at=>{const X=k.get(at.id);!X||at.type==="text"||(X.zIndex=Y++)}),K.clips.forEach(at=>{const X=k.get(at.id);!X||at.type!=="text"||(X.zIndex=Y++)})})},bt=async(Y,K="default")=>{if(d(!1),console.log("updateClip",Y),!k.has(Y.id))return;const at=k.get(Y.id);if(K==="delete"){e==null||e.removeSprite(at),k.delete(Y.id);return}if(K==="resize"&&(Y.type==="video"||Y.type==="audio")){e==null||e.removeSprite(at),k.delete(Y.id),await lt(Y);return}if(at.time.offset=Y.startTime*1e6,at.time.duration=Number(Y.duration)*1e6,at.opacity=Number((Y.opacity/100).toFixed(2)),st(),Y.type==="text"){const X=at.getClip();X.textConfig=Y.textConfig,at.rect.w=Y.w,at.rect.h=Y.h,at.preFrame(u.currentTime*1e6)}else Y.type!=="audio"&&(at.rect.x=Y.x,at.rect.y=Y.y,at.rect.w=Y.w,at.rect.h=Y.h,at.rect.angle=Y.angle)},V=()=>{e==null||e.destroy(),k.clear(),t.value=0,ta(()=>{L()})},Yt=async()=>{const Y=await(e==null?void 0:e.createCombinator());try{const K={dangerouslyUseHTMLString:!0,showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1,showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"停止",customClass:"export-progress-dialog",beforeClose:(at,X,Ht)=>{at==="cancel"&&(Y==null||Y.destroy(),Ht())}};_h.alert(`
            <div class="flex flex-col gap-2 w-full min-w-[300px]">
                <div class="text-center text-base">0%</div>
                <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        `,"导出进度",K),await ta(),Y.on("OutputProgress",at=>{const X=Math.round(at*100),Ht=document.querySelector(".el-message-box__message");if(Ht&&(Ht.innerHTML=`
                    <div class="flex flex-col gap-2 w-full min-w-[300px]">
                        <div class="text-center text-base">${X}%</div>
                        <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: ${X}%"></div>
                        </div>
                    </div>
                `,at===1)){const he=document.querySelector(".el-message-box__cancel");he&&(he.style.display="none"),Ht.innerHTML=`
                        <div class="flex flex-col gap-2 w-full min-w-[300px]">
                            <div class="text-center text-green-500 text-base">导出完成！</div>
                            <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                            </div>
                        </div>
                    `,setTimeout(()=>{_h.close()},3e3)}}),await(Y==null?void 0:Y.output().pipeTo(await Rb()))}catch(K){_h.close(),gr.error("导出失败："+K.message)}},Tt=Y=>{const K=Math.floor(Y/60),at=Math.floor(Y%60);return`${K}:${at.toString().padStart(2,"0")}`},Nt=()=>{N.value&&new ResizeObserver(K=>{var at;for(let X of K){const{width:Ht,height:he}=X.contentRect,Ke=(at=document.querySelector(".control-bar"))==null?void 0:at.clientHeight,He=he-Ke;Ht/He>1.7777777777777777?_.setCanvasSize({width:He*16/9,height:He}):_.setCanvasSize({width:Ht,height:Ht*9/16})}}).observe(N.value)};fs(()=>{zt.setLogLevel(zt.warn),L(),Nt(),window.addEventListener("keydown",S)}),ra(()=>{e==null||e.destroy(),k.clear(),e=null,t.value=0,window.removeEventListener("keydown",S);for(const Y of k.keys())_.unsubscribeFromClipUpdates(Y)}),On(()=>t.value,Y=>{if(Y===a.value){s.value=!1,e==null||e.previewFrame(u.currentTime*1e6);for(const K of u.tracks.flatMap(at=>at.clips))st()}}),On(()=>u.currentTime,Y=>{b.value||e.previewFrame(Y*1e6)}),l({refreshPlayer:V,addClip:G,activeClip:R,handleExport:Yt});const it=document.createElement("style");return it.textContent=`
.export-progress-dialog .el-message-box__content {
    padding: 20px;
}
.export-progress-dialog .el-message-box__message {
    padding: 0;
}
.export-progress-dialog .el-message-box__message p {
    margin: 0;
}
.export-progress-dialog .el-message-box__container {
    width: 100%;
}
`,document.head.appendChild(it),(Y,K)=>{const at=Rw("loading");return Pw((mt(),Et("div",{ref_key:"playerRef",ref:N,class:"player-container w-full h-full bg-[#1b1b1b] relative flex flex-col"},[O("div",R1,[O("div",{ref_key:"avCanvas",ref:U,class:"",style:qi({width:Ct(n).width+"px",height:Ct(n).height+"px"})},null,4)]),O("div",D1,[O("div",M1,je(Tt(Y.currentTime)),1),K[2]||(K[2]=O("div",{class:"text-white text-base"},"/",-1)),O("div",O1,je(Tt(Y.playerDuration)),1),O("div",N1,[O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:g},[et(Ct(ie),{icon:"fa-step-backward"})]),O("button",G1,[Ct(b)?(mt(),mn(Ct(ie),{key:1,icon:"fa-pause",onClick:K[1]||(K[1]=X=>d(!1))})):(mt(),mn(Ct(ie),{key:0,icon:"fa-play",onClick:K[0]||(K[0]=X=>d(!0))}))]),O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:g},[et(Ct(ie),{icon:"fa-step-forward"})])]),O("div",H1,[O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:w},[et(Ct(ie),{icon:Ct(B)?"fa-compress":"fa-expand"},null,8,["icon"])])])])])),[[at,Ct(s)]])}}}),V1=ps(Y1,[["__scopeId","data-v-76d7e074"]]);let Ja;const W1=new Uint8Array(16);function $1(){if(!Ja&&(Ja=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ja))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ja(W1)}const Ie=[];for(let f=0;f<256;++f)Ie.push((f+256).toString(16).slice(1));function X1(f,l=0){return Ie[f[l+0]]+Ie[f[l+1]]+Ie[f[l+2]]+Ie[f[l+3]]+"-"+Ie[f[l+4]]+Ie[f[l+5]]+"-"+Ie[f[l+6]]+Ie[f[l+7]]+"-"+Ie[f[l+8]]+Ie[f[l+9]]+"-"+Ie[f[l+10]]+Ie[f[l+11]]+Ie[f[l+12]]+Ie[f[l+13]]+Ie[f[l+14]]+Ie[f[l+15]]}const Z1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),dc={randomUUID:Z1};function os(f,l,h){if(dc.randomUUID&&!f)return dc.randomUUID();f=f||{};const u=f.random||(f.rng||$1)();return u[6]=u[6]&15|64,u[8]=u[8]&63|128,X1(u)}const j1={class:"p-5"},K1={class:"flex items-center justify-center"},q1={class:"flex items-center justify-center"},J1={class:"h-[calc(100vh-7rem)] mt-2 overflow-y-auto"},Q1={class:"w-full grid grid-cols-2 gap-3"},tS=["onContextmenu","onMouseover","onMouseleave","onDragstart"],eS={class:"relative w-full h-full bg-[#121212]"},iS=["src"],nS=["src"],rS={key:2,class:"w-full aspect-video flex items-center justify-center"},sS={key:3,class:"absolute w-[12%] h-[12%] right-[16%] bottom-[12%] flex items-center gap-1 rounded-full"},aS={class:"text-tiny truncate mt-1"},oS=Di({__name:"mediaLibrary",emits:["add-clip"],setup(f,{emit:l}){const h=yr(),u=Kh("addClip"),p=pt([]),_=new Map,v=g=>y=>{_.set(g,y)};fs(()=>{s()});const s=()=>{Be.medias.toArray().then(async g=>{if(g){let y=[];for(const w of g){const S=await Lb(w.path);y.push({...w,filePath:S})}p.value=y}})},b=async g=>{const y=await Be.medias.where({name:g.name}).first();if(y&&y.size===g.size)return gr.warning("文件已存在"),!1;const w=g.name.split(".").pop();let S="";switch(w){case"mp4":case"mov":case"avi":case"wmv":S="video";break;case"mp3":case"wav":case"m4a":case"m4s":case"m3u8":case"aac":case"ogg":case"flac":case"webm":case"opus":S="audio";break;case"png":case"jpg":case"jpeg":case"gif":case"bmp":case"tiff":case"ico":case"svg":case"webp":case"avif":S="image";break;default:return gr.warning("请检查文件格式"),!1}let L="/"+S+"/"+g.name;const k=await ai(L);let F=!1;if(k.exists()&&(await k.remove(),F=!0),await jo(L,g.stream()),await ai(L).exists()){const G={name:g.name,size:g.size,type:S,path:L,isAnimateImg:!1};switch(S){case"video":const lt=await new nu(g.stream()).ready;lt&&(G.duration=lt.duration);break;case"audio":const bt=await new ru(await g.stream()).ready;bt&&(G.duration=bt.duration);break;case"image":try{G.duration=3e6;const V=["gif","webp","avif","webp"],Yt=g.name.split(".").pop();if(V.includes(Yt)){const Tt=new Ro({type:`image/${Yt}`,stream:await g.stream()}),Nt=await Tt.ready;console.log(Nt);const{video:it}=await Tt.tick(0),{video:Y}=await Tt.tick(1e6),at=new OffscreenCanvas(it.codedWidth,it.codedHeight).getContext("2d");at.drawImage(it,0,0);const X=at.getImageData(0,0,it.codedWidth,it.codedHeight);at.clearRect(0,0,it.codedWidth,it.height),at.drawImage(Y,0,0);const Ht=at.getImageData(0,0,Y.codedWidth,Y.codedHeight),he=A(X.data,Ht.data);G.isAnimateImg=!0}else G.isAnimateImg=!1}catch(V){console.log(V)}break}console.log(G.duration),F&&y?(G.updateTime=new Date().getTime(),await Be.medias.where({name:g.name}).modify(G)):(G.createTime=new Date().getTime(),await Be.medias.add(G)),s()}else gr.error("上传失败");return!1},A=(g,y)=>{if(g.length!==y.length)return!1;for(let w=0;w<g.length;w++)if(g[w]!==y[w])return!1;return!0},I=Ee(()=>h.getShowContextMenu),B=Ee(()=>h.getContextMenuPosition),U=pt(""),N=(g,y)=>{U.value=y.id,h.setShowContextMenu(!0);const{offsetX:w,offsetY:S}=g;h.setContextMenuPosition({x:w,y:S}),console.log(B.value)},t=(g,y)=>{g.hovered=!0;const w=_.get(y);w&&g.type==="video"&&w.play()},e=(g,y)=>{g.hovered=!1;const w=_.get(y);w&&g.type==="video"&&(w.currentTime=0,w.pause())},n=(g,y)=>{g.dataTransfer&&(g.dataTransfer.effectAllowed="move",g.dataTransfer.setData("application/json",JSON.stringify(y)),g.dataTransfer.setData("text/plain",JSON.stringify(y)),h.setDragData(y))},a=g=>{const y={id:os(),type:g.type,isAnimateImg:g.isAnimateImg,name:g.name,path:g.path,duration:g.duration?Number(g.duration)/1e6:5,startTime:0,endTime:g.duration?Number(g.duration)/1e6:5,opacity:100,angle:0};g.type==="image"&&(y.duration=5,y.endTime=5),u==null||u(y,!0)},d=g=>{Be.medias.where({id:g.id}).delete(),s()};return(g,y)=>{const w=Qt("upload-filled"),S=Qt("el-icon"),L=Qt("el-upload"),k=Qt("Headset"),F=Qt("CirclePlus"),G=Qt("DeleteFilled");return mt(),Et("div",j1,[O("div",K1,[et(L,{class:"w-full",drag:"",action:"163",multiple:"","show-file-list":!1,"before-upload":b},{tip:Gt(()=>y[1]||(y[1]=[])),default:Gt(()=>[O("div",q1,[et(S,{class:"mr-1",size:"30"},{default:Gt(()=>[et(w)]),_:1}),y[0]||(y[0]=O("div",{class:"flex flex-col items-start"},[O("div",{class:"text-tiny"}," 拖拽或上传文件 "),O("div",{class:"flex items-center justify-center text-xs"}," 支持视频、音频、图片格式 ")],-1))])]),_:1})]),O("div",J1,[O("div",Q1,[(mt(!0),Et(xi,null,Nn(p.value,(R,lt)=>(mt(),Et("div",{class:"relative flex flex-col justify-center w-full hover:bg-[#121212] p-1.5 rounded-md",onContextmenu:Ze(st=>N(st,R),["prevent"]),onMouseover:st=>t(R,lt),onMouseleave:st=>e(R,lt),onDragstart:st=>n(st,R),draggable:"true"},[O("div",eS,[R.type==="image"?(mt(),Et("img",{key:0,src:R.filePath,alt:"",class:"aspect-video object-contain rounded"},null,8,iS)):fe("",!0),R.type==="video"?(mt(),Et("video",{key:1,ref_for:!0,ref:v(lt),src:R.filePath,muted:"",loop:"",disablepictureinpicture:"",class:"aspect-video object-contain rounded"},null,8,nS)):fe("",!0),R.type==="audio"?(mt(),Et("div",rS,[et(S,null,{default:Gt(()=>[et(k)]),_:1})])):fe("",!0),R.hovered?(mt(),Et("div",sS,[et(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:Ze(st=>a(R),["stop"])},{default:Gt(()=>[et(F)]),_:2},1032,["onClick"]),et(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:Ze(st=>d(R),["stop"])},{default:Gt(()=>[et(G)]),_:2},1032,["onClick"])])):fe("",!0),Ct(I)&&R.id===U.value?(mt(),Et("div",{key:4,class:"absolute flex flex-col justify-center bg-[#121212] py-1.5 rounded-md",style:qi({left:Ct(B).x+"px",top:Ct(B).y+"px"})},y[2]||(y[2]=[O("div",{class:"px-3 py-0.5 text-tiny hover:bg-gray cursor-pointer"},"裁剪",-1)]),4)):fe("",!0)]),O("div",aS,je(R.name),1)],40,tS))),256))])])])}}}),lS=ps(oS,[["__scopeId","data-v-30c9ea77"]]),hS=""+new URL("1-DX-6C8MT.png",import.meta.url).href,uS=""+new URL("2-Bbrfykah.png",import.meta.url).href,cc=f=>new URL(Object.assign({"../assets/image/text/1.png":hS,"../assets/image/text/2.png":uS})[`../assets/image/${f}`],import.meta.url).href,fS=[{preview:cc("text/1.png"),name:"描边标题",style:{content:"描边文字效果",fontSize:48,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFFFFF",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!1,shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,showStroke:!0,strokeColor:"red",strokeWidth:3}},{preview:cc("text/2.png"),name:"阴影标题",style:{content:"阴影文字效果",fontSize:52,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFD93D",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!0,shadowColor:"rgba(59, 59, 59, 1)",shadowBlur:10,shadowOffsetX:4,shadowOffsetY:4,showStroke:!1,strokeColor:"#000000",strokeWidth:0}}],dS={class:"p-4"},cS={class:"grid grid-cols-2 gap-4"},pS={class:"text-white text-xl mb-2"},_S={class:"text-[#666] text-sm"},gS={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},mS=["onClick","onDragstart"],yS=["src"],vS={class:"absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-opacity"},wS={class:"text-white text-sm"},xS=Di({__name:"textLibrary",setup(f){const l=yr(),h=Kh("addClip"),u=pt({preview:"Aa",name:"基础文字",style:{fontSize:72,fontFamily:"Microsoft YaHei",color:"#ffffff"}}),p=s=>{const b=v(s);l.setDragData(b)},_=s=>{const b=v(s);h==null||h(b,!0)},v=s=>({id:os(),type:"text",name:s.name,duration:5,startTime:0,endTime:5,opacity:100,angle:0,textConfig:{content:s.name||"基础文字",lineSpacing:0,letterSpacing:0,showStroke:!1,strokeColor:"#ffffff",strokeWidth:0,showShadow:!1,shadowColor:"#ffffff",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,...s.style}});return(s,b)=>{const A=Qt("el-icon");return mt(),Et("div",dS,[O("div",cS,[O("div",{class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",onClick:b[0]||(b[0]=I=>_(Ct(u))),draggable:"true",onDragstart:b[1]||(b[1]=I=>p(Ct(u)))},[O("div",pS,je(Ct(u).preview),1),O("div",_S,je(Ct(u).name),1),O("div",gS,[et(A,{class:"text-white text-2xl"},{default:Gt(()=>[et(Ct(Hd))]),_:1})])],32),(mt(!0),Et(xi,null,Nn(Ct(fS),I=>(mt(),Et("div",{key:I.name,class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg aspect-video overflow-hidden",onClick:B=>_(I),draggable:"true",onDragstart:B=>p(I)},[O("img",{src:I.preview,class:"w-full h-full px-3 object-contain"},null,8,yS),O("div",vS,[et(A,{class:"text-white text-2xl mb-2"},{default:Gt(()=>[et(Ct(Hd))]),_:1}),O("span",wS,je(I.name),1)])],40,mS))),128))])])}}}),bS={class:"h-screen"},SS={class:"flex flex-col items-center justify-center"},US=Di({__name:"clipMenu",setup(f){const l=[{name:"媒体库",component:lS},{name:"文字",component:xS}];return(h,u)=>{const p=Qt("Files"),_=Qt("el-icon"),v=Qt("el-tab-pane"),s=Qt("el-tabs");return mt(),Et("div",bS,[et(s,{type:"border-card",tabPosition:"left"},{default:Gt(()=>[(mt(),Et(xi,null,Nn(l,b=>et(v,{label:"User"},{label:Gt(()=>[O("div",SS,[et(_,null,{default:Gt(()=>[et(p)]),_:1}),O("div",null,je(b.name),1)])]),default:Gt(()=>[(mt(),mn(Dw(b.component),{class:"w-full h-screen bg-[#303030]"}))]),_:2},1024)),64))]),_:1})])}}}),ES=ps(US,[["__scopeId","data-v-70893c60"]]);var vi=typeof window<"u"?window:null,hu=vi===null,na=hu?void 0:vi.document,Ti="addEventListener",Ai="removeEventListener",Sh="getBoundingClientRect",Ms="_a",Ii="_b",hn="_c",Qa="horizontal",Bi=function(){return!1},CS=hu?"calc":["","-webkit-","-moz-","-o-"].filter(function(f){var l=na.createElement("div");return l.style.cssText="width:"+f+"calc(9px)",!!l.style.length}).shift()+"calc",fp=function(f){return typeof f=="string"||f instanceof String},pc=function(f){if(fp(f)){var l=na.querySelector(f);if(!l)throw new Error("Selector "+f+" did not match a DOM element");return l}return f},Le=function(f,l,h){var u=f[l];return u!==void 0?u:h},to=function(f,l,h,u){if(l){if(u==="end")return 0;if(u==="center")return f/2}else if(h){if(u==="start")return 0;if(u==="center")return f/2}return f},TS=function(f,l){var h=na.createElement("div");return h.className="gutter gutter-"+l,h},AS=function(f,l,h){var u={};return fp(l)?u[f]=l:u[f]=CS+"("+l+"% - "+h+"px)",u},IS=function(f,l){var h;return h={},h[f]=l+"px",h},_c=function(f,l){if(l===void 0&&(l={}),hu)return{};var h=f,u,p,_,v,s,b;Array.from&&(h=Array.from(h));var A=pc(h[0]),I=A.parentNode,B=getComputedStyle?getComputedStyle(I):null,U=B?B.flexDirection:null,N=Le(l,"sizes")||h.map(function(){return 100/h.length}),t=Le(l,"minSize",100),e=Array.isArray(t)?t:h.map(function(){return t}),n=Le(l,"maxSize",1/0),a=Array.isArray(n)?n:h.map(function(){return n}),d=Le(l,"expandToMin",!1),g=Le(l,"gutterSize",10),y=Le(l,"gutterAlign","center"),w=Le(l,"snapOffset",30),S=Array.isArray(w)?w:h.map(function(){return w}),L=Le(l,"dragInterval",1),k=Le(l,"direction",Qa),F=Le(l,"cursor",k===Qa?"col-resize":"row-resize"),G=Le(l,"gutter",TS),R=Le(l,"elementStyle",AS),lt=Le(l,"gutterStyle",IS);k===Qa?(u="width",p="clientX",_="left",v="right",s="clientWidth"):k==="vertical"&&(u="height",p="clientY",_="top",v="bottom",s="clientHeight");function st(ut,J,ot,ct){var ne=R(u,J,ot,ct);Object.keys(ne).forEach(function(Zt){ut.style[Zt]=ne[Zt]})}function bt(ut,J,ot){var ct=lt(u,J,ot);Object.keys(ct).forEach(function(ne){ut.style[ne]=ct[ne]})}function V(){return b.map(function(ut){return ut.size})}function Yt(ut){return"touches"in ut?ut.touches[0][p]:ut[p]}function Tt(ut){var J=b[this.a],ot=b[this.b],ct=J.size+ot.size;J.size=ut/this.size*ct,ot.size=ct-ut/this.size*ct,st(J.element,J.size,this[Ii],J.i),st(ot.element,ot.size,this[hn],ot.i)}function Nt(ut){var J,ot=b[this.a],ct=b[this.b];this.dragging&&(J=Yt(ut)-this.start+(this[Ii]-this.dragOffset),L>1&&(J=Math.round(J/L)*L),J<=ot.minSize+ot.snapOffset+this[Ii]?J=ot.minSize+this[Ii]:J>=this.size-(ct.minSize+ct.snapOffset+this[hn])&&(J=this.size-(ct.minSize+this[hn])),J>=ot.maxSize-ot.snapOffset+this[Ii]?J=ot.maxSize+this[Ii]:J<=this.size-(ct.maxSize-ct.snapOffset+this[hn])&&(J=this.size-(ct.maxSize+this[hn])),Tt.call(this,J),Le(l,"onDrag",Bi)(V()))}function it(){var ut=b[this.a].element,J=b[this.b].element,ot=ut[Sh](),ct=J[Sh]();this.size=ot[u]+ct[u]+this[Ii]+this[hn],this.start=ot[_],this.end=ot[v]}function Y(ut){if(!getComputedStyle)return null;var J=getComputedStyle(ut);if(!J)return null;var ot=ut[s];return ot===0?null:(k===Qa?ot-=parseFloat(J.paddingLeft)+parseFloat(J.paddingRight):ot-=parseFloat(J.paddingTop)+parseFloat(J.paddingBottom),ot)}function K(ut){var J=Y(I);if(J===null||e.reduce(function(Zt,Wt){return Zt+Wt},0)>J)return ut;var ot=0,ct=[],ne=ut.map(function(Zt,Wt){var Rt=J*Zt/100,bi=to(g,Wt===0,Wt===ut.length-1,y),_e=e[Wt]+bi;return Rt<_e?(ot+=_e-Rt,ct.push(0),_e):(ct.push(Rt-_e),Rt)});return ot===0?ut:ne.map(function(Zt,Wt){var Rt=Zt;if(ot>0&&ct[Wt]-ot>0){var bi=Math.min(ot,ct[Wt]-ot);ot-=bi,Rt=Zt-bi}return Rt/J*100})}function at(){var ut=this,J=b[ut.a].element,ot=b[ut.b].element;ut.dragging&&Le(l,"onDragEnd",Bi)(V()),ut.dragging=!1,vi[Ai]("mouseup",ut.stop),vi[Ai]("touchend",ut.stop),vi[Ai]("touchcancel",ut.stop),vi[Ai]("mousemove",ut.move),vi[Ai]("touchmove",ut.move),ut.stop=null,ut.move=null,J[Ai]("selectstart",Bi),J[Ai]("dragstart",Bi),ot[Ai]("selectstart",Bi),ot[Ai]("dragstart",Bi),J.style.userSelect="",J.style.webkitUserSelect="",J.style.MozUserSelect="",J.style.pointerEvents="",ot.style.userSelect="",ot.style.webkitUserSelect="",ot.style.MozUserSelect="",ot.style.pointerEvents="",ut.gutter.style.cursor="",ut.parent.style.cursor="",na.body.style.cursor=""}function X(ut){if(!("button"in ut&&ut.button!==0)){var J=this,ot=b[J.a].element,ct=b[J.b].element;J.dragging||Le(l,"onDragStart",Bi)(V()),ut.preventDefault(),J.dragging=!0,J.move=Nt.bind(J),J.stop=at.bind(J),vi[Ti]("mouseup",J.stop),vi[Ti]("touchend",J.stop),vi[Ti]("touchcancel",J.stop),vi[Ti]("mousemove",J.move),vi[Ti]("touchmove",J.move),ot[Ti]("selectstart",Bi),ot[Ti]("dragstart",Bi),ct[Ti]("selectstart",Bi),ct[Ti]("dragstart",Bi),ot.style.userSelect="none",ot.style.webkitUserSelect="none",ot.style.MozUserSelect="none",ot.style.pointerEvents="none",ct.style.userSelect="none",ct.style.webkitUserSelect="none",ct.style.MozUserSelect="none",ct.style.pointerEvents="none",J.gutter.style.cursor=F,J.parent.style.cursor=F,na.body.style.cursor=F,it.call(J),J.dragOffset=Yt(ut)-J.end}}N=K(N);var Ht=[];b=h.map(function(ut,J){var ot={element:pc(ut),size:N[J],minSize:e[J],maxSize:a[J],snapOffset:S[J],i:J},ct;if(J>0&&(ct={a:J-1,b:J,dragging:!1,direction:k,parent:I},ct[Ii]=to(g,J-1===0,!1,y),ct[hn]=to(g,!1,J===h.length-1,y),U==="row-reverse"||U==="column-reverse")){var ne=ct.a;ct.a=ct.b,ct.b=ne}if(J>0){var Zt=G(J,k,ot.element);bt(Zt,g,J),ct[Ms]=X.bind(ct),Zt[Ti]("mousedown",ct[Ms]),Zt[Ti]("touchstart",ct[Ms]),I.insertBefore(Zt,ot.element),ct.gutter=Zt}return st(ot.element,ot.size,to(g,J===0,J===h.length-1,y),J),J>0&&Ht.push(ct),ot});function he(ut){var J=ut.i===Ht.length,ot=J?Ht[ut.i-1]:Ht[ut.i];it.call(ot);var ct=J?ot.size-ut.minSize-ot[hn]:ut.minSize+ot[Ii];Tt.call(ot,ct)}b.forEach(function(ut){var J=ut.element[Sh]()[u];J<ut.minSize&&(d?he(ut):ut.minSize=J)});function Ke(ut){var J=K(ut);J.forEach(function(ot,ct){if(ct>0){var ne=Ht[ct-1],Zt=b[ne.a],Wt=b[ne.b];Zt.size=J[ct-1],Wt.size=ot,st(Zt.element,Zt.size,ne[Ii],Zt.i),st(Wt.element,Wt.size,ne[hn],Wt.i)}})}function He(ut,J){Ht.forEach(function(ot){if(J!==!0?ot.parent.removeChild(ot.gutter):(ot.gutter[Ai]("mousedown",ot[Ms]),ot.gutter[Ai]("touchstart",ot[Ms])),ut!==!0){var ct=R(u,ot.a.size,ot[Ii]);Object.keys(ct).forEach(function(ne){b[ot.a].element.style[ne]="",b[ot.b].element.style[ne]=""})}})}return{setSizes:Ke,getSizes:V,collapse:function(J){he(b[J])},destroy:He,parent:I,pairs:Ht}};const BS={class:"ticks h-full"},zS={key:0,class:"tick-mark"},FS={key:1,class:"tick-mark-long"},kS={key:2,class:"tick-label"},Rr=3,gc=100,LS=15,PS=Di({__name:"timelineRuler",props:{duration:{type:Number,required:!0},zoom:{type:Number,default:1},currentTime:{type:Number,default:0},totalWidth:{type:Number,default:0}},emits:["timeUpdate","scroll"],setup(f,{emit:l}){const h=f,u=l,p=pt(null),_=Ee(()=>Rr*h.zoom),v=Ee(()=>Math.ceil(h.duration*10)),s=Ee(()=>h.currentTime*Rr*h.zoom*10),b=pt(!1),A=pt(0),I=pt(null);let B=null,U=pt(0);const N=y=>{const w=Math.floor(y/10),S=Math.floor(w/60),L=w%60;return`${S}:${L.toString().padStart(2,"0")}`},t=y=>{if(!p.value)return;const w=p.value.getBoundingClientRect(),L=(y.clientX-w.left)/(Rr*h.zoom*10);u("timeUpdate",Math.max(0,Math.min(L,h.duration))),n(y)},e=y=>{if(y.stopPropagation(),!p.value)return;const w=p.value.getBoundingClientRect(),S=y.clientX-w.left,L=Math.max(0,Math.min(S/(Rr*h.zoom*10),h.duration));u("timeUpdate",L),n(y)},n=y=>{b.value=!0,A.value=y.clientX,U.value=y.clientX,document.addEventListener("mousemove",d),document.addEventListener("mouseup",g)},a=()=>{if(!(!b.value||!p.value||!p.value.parentElement)&&I.value){u("scroll",I.value==="right"?LS:-15);const w=p.value.getBoundingClientRect(),S=A.value-w.left,L=Math.max(0,Math.min(S/(Rr*h.zoom*10),h.duration));u("timeUpdate",L),B=requestAnimationFrame(a)}},d=y=>{if(!b.value||!p.value)return;const w=p.value.getBoundingClientRect(),S=p.value.parentElement;if(!S)return;const L=y.clientX-w.left,k=y.clientX-U.value;if(U.value=y.clientX,k!==0){const G=S.getBoundingClientRect();k>0?y.clientX>G.right-gc?I.value!=="right"&&(I.value="right",a()):I.value=null:y.clientX<G.left+gc?I.value!=="left"&&(I.value="left",a()):I.value=null}const F=Math.max(0,Math.min(L/(Rr*h.zoom*10),h.duration));u("timeUpdate",F),A.value=y.clientX},g=()=>{b.value=!1,I.value=null,document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",g),B!==null&&(cancelAnimationFrame(B),B=null)};return ra(()=>{B!==null&&cancelAnimationFrame(B)}),(y,w)=>(mt(),Et(xi,null,[O("div",{class:"ticks-container h-10",ref_key:"rulerContainer",ref:p,style:qi({width:f.totalWidth+"px"}),onMousedown:t},[O("div",BS,[(mt(!0),Et(xi,null,Nn(Ct(v),S=>(mt(),Et("div",{key:S,class:"tick h-full",style:qi({left:S*Ct(_)+"px"})},[S%5===0?(mt(),Et("div",zS)):fe("",!0),S%50===0?(mt(),Et("div",FS)):fe("",!0),S%50===0?(mt(),Et("span",kS,je(N(S)),1)):fe("",!0)],4))),128))])],36),O("div",{class:"playhead",style:qi({left:Ct(s)+"px"}),onMousedown:e},w[0]||(w[0]=[O("div",{class:"playhead-line"},null,-1),O("div",{class:"playhead-triangle"},null,-1)]),36)],64))}}),RS=ps(PS,[["__scopeId","data-v-9b78982e"]]),DS={class:"w-full h-full p-1 flex flex-col justify-center items-center pointer-events-none select-none"},MS={key:0,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},OS=["src"],NS={key:1,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},GS=["src"],HS={key:2,class:"w-full h-full flex flex-col relative rounded"},YS={class:"absolute inset-0"},VS={key:0,class:"absolute inset-0 w-auto h-full flex items-center bg-[#ffffff] bg-opacity-10 text-[#000000]"},WS={class:"text-base inline-block truncate px-5 z-10"},$S={key:3,class:"mt-1 text-bigger pl-4 text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},XS={key:4,class:"mt-1 text-xs text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},ZS=Di({__name:"trackItem",props:{clip:{type:Object,required:!0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},hovered:{type:Boolean,default:!1}},setup(f){const l=f,h=Ee(()=>70/l.frameLength),u=pt([]),p=pt(null),_=()=>{try{if(!l.clip.thumbnail||!Array.isArray(l.clip.thumbnail)){u.value=[];return}const s=Number(l.clip.duration);if(isNaN(s)||s<=0){console.warn("Invalid clip duration:",s);return}const b=Math.ceil(s/h.value),A=[];if(l.clip.type==="image"&&l.clip.thumbnail.length>0){const I=l.clip.thumbnail[0];for(let B=0;B<b;B++)A.push(I)}else if(l.clip.type==="video"&&l.clip.thumbnail.length>0){const I=l.clip.thumbnail;let B=I[0];for(let U=0;U<b;U++){const N=U*h.value,t=I.find(e=>e.timestamp/1e6>=N)||B||I[I.length-1];t&&(A.push(t),B=t)}}u.value=A}catch(s){console.error("Error updating thumbnails:",s),u.value=[]}},v=()=>{try{if(!p.value||!l.clip.volumeData)return;const s=p.value,b=s.getContext("2d");if(!b)return;const A=s.getBoundingClientRect();if(s.width=A.width*window.devicePixelRatio,s.height=A.height*window.devicePixelRatio,b.clearRect(0,0,s.width,s.height),!l.clip.originalDuration){console.warn("Missing originalDuration for audio clip");return}const I=l.clip.volumeData.slice(l.clip.sourceStartTime/l.clip.originalDuration*l.clip.volumeData.length,(l.clip.originalDuration-l.clip.sourceEndTime)/l.clip.originalDuration*l.clip.volumeData.length);if(!I.length){console.warn("No volume data available");return}const B=2,U=2,N=Math.floor(s.width/(B+U)),t=s.height*.8,e=I.length/N;b.fillStyle="#ffffff80";for(let n=0;n<N;n++){const a=Math.floor(n*e),g=(I[a]||0)*t,y=n*(B+U),w=(s.height-g)/2;b.fillRect(y,w,B,g)}}catch(s){console.error("Error drawing waveform:",s)}};return On([()=>l.frameLength,()=>l.zoom,()=>l.clip.duration,()=>l.clip.sourceStartTime,()=>l.clip.sourceEndTime,()=>l.clip.thumbnail],()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&ta(()=>{_()})},{deep:!0,immediate:!0}),On(()=>l.clip.thumbnail,()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&ta(()=>{_()})},{deep:!0,immediate:!0}),fs(()=>{if(l.clip.type==="audio"){const s=new ResizeObserver(()=>{v()});p.value&&(s.observe(p.value),v())}}),(s,b)=>(mt(),Et("div",DS,[f.clip.type==="video"?(mt(),Et("div",MS,[u.value.length>0?(mt(!0),Et(xi,{key:0},Nn(u.value,A=>(mt(),Et("img",{key:A.timestamp,src:A.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,OS))),128)):fe("",!0)])):fe("",!0),f.clip.type==="image"?(mt(),Et("div",NS,[u.value.length>0?(mt(!0),Et(xi,{key:0},Nn(u.value,A=>(mt(),Et("img",{key:A.timestamp,src:A.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,GS))),128)):fe("",!0)])):f.clip.type==="audio"?(mt(),Et("div",HS,[O("div",YS,[O("canvas",{ref_key:"waveformCanvas",ref:p,class:"w-full h-full"},null,512)]),f.hovered?(mt(),Et("div",VS,[O("span",WS,je(f.clip.name),1)])):fe("",!0)])):f.clip.type==="text"?(mt(),Et("div",$S,je(f.clip.textConfig.content),1)):f.clip.type==="sticker"?(mt(),Et("div",XS,je(f.clip.name),1)):fe("",!0)]))}}),jS=ps(ZS,[["__scopeId","data-v-4096df5f"]]),KS=["data-track","onDragenter","onDragleave"],qS=["data-clip","onMousedown","onMouseover","onMouseleave"],JS=["onMousedown"],QS=["onMousedown"],tU=Di({__name:"tracksList",props:{tracks:{type:Array,required:!0},hoveredTrack:{type:Number,default:-1},dragPreview:{type:Boolean,default:!1},dragPreviewPosition:{type:Number,default:0},dragPreviewWidth:{type:Number,default:0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},isReplaceMode:{type:Boolean,default:!1}},emits:["track-drag-enter","track-drag-leave","clip-mouse-down","background-click","save-history-state","clip-hover","start-resize","delete-clip"],setup(f,{expose:l,emit:h}){const u=f,p=h,_=pt(void 0),v=pt(void 0),s=()=>{u.tracks.forEach(w=>{w.clips.forEach(S=>{S.selected=!1})}),v.value=void 0},b=w=>{s(),w&&(w.selected=!0,v.value=w)},A=w=>{w.preventDefault()},I=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect();w.clientX-S.left;const L=w.clientY-S.top,k=S.height/u.tracks.length,F=Math.floor(L/k);F>=0&&F<u.tracks.length&&p("track-drag-enter",F)},B=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect(),L=w.clientX,k=w.clientY;(L<S.left||L>S.right||k<S.top||k>S.bottom)&&p("track-drag-leave",u.hoveredTrack)},U=w=>{p("track-drag-enter",w)},N=w=>{p("track-drag-leave",w)},t=(w,S,L)=>{w.stopPropagation(),w.preventDefault(),u.tracks.forEach(F=>{F.clips.forEach(G=>{G!==S&&(G.selected=!1)})}),S.selected=!0,v.value=S,_.value=void 0;const k=w.target;!k.classList.contains("resize-handle")&&!k.closest(".resize-handle")&&p("clip-mouse-down",S,L,w)},e=w=>{v.value||(_.value=w,w.selected=!0),p("clip-hover",w)},n=w=>{_.value===w&&!v.value&&(_.value=void 0,w.selected=!1)},a=(w,S,L)=>{p("start-resize",w,S,L)},d=w=>{s(),p("background-click"),_.value=void 0},g=w=>{const S=document.activeElement;(S==null?void 0:S.tagName)==="INPUT"||(S==null?void 0:S.tagName)==="TEXTAREA"||(S==null?void 0:S.getAttribute("contenteditable"))==="true"||S!=null&&S.classList.contains("el-input__inner")||S!=null&&S.classList.contains("el-textarea__inner")||(w.key==="Delete"||w.key==="Backspace")&&(u.tracks.forEach((k,F)=>{k.clips.filter(R=>R.selected||R===v.value).forEach(R=>{p("delete-clip",R,F)})}),y())},y=()=>{p("save-history-state")};return fs(()=>{window.addEventListener("keydown",g);const w=document.querySelector(".tracks-list");w&&w.focus()}),ra(()=>{window.removeEventListener("keydown",g)}),l({activeClip:b}),(w,S)=>(mt(),Et("div",{class:"w-full h-full bg-[#252525] tracks-list select-none",onDragenter:Ze(A,["prevent"]),onDragover:Ze(I,["prevent"]),onDragleave:Ze(B,["prevent"]),onMousedown:d,onKeydown:g,tabindex:"0"},[(mt(!0),Et(xi,null,Nn(f.tracks,(L,k)=>(mt(),Et("div",{key:L.id,class:"relative h-15 my-3 bg-[#252525]","data-track":L.id,onDragenter:Ze(F=>U(k),["prevent"]),onDragleave:Ze(F=>N(k),["prevent"])},[(mt(!0),Et(xi,null,Nn(L.clips,F=>(mt(),Et("div",{key:F.id,class:Pn(["absolute top-0 h-full flex items-center bg-[#444] rounded-xl cursor-pointer select-none min-w-[30px]",{"ring-2 ring-[#b534cf]":F.selected||_.value&&_.value.id===F.id||v.value&&v.value.id===F.id,"bg-[#631975]":F.type==="video","bg-[#6ab7ff]":F.type==="audio","bg-[#722ed133]":F.type==="image","bg-[#a85201]":F.type==="text","bg-[#eb2f9633]":F.type==="sticker"}]),style:qi({left:`${F.startTime*f.frameLength}px`,width:`${F.duration*f.frameLength}px`}),"data-clip":F.id,onMousedown:Ze(G=>t(G,F,L.id),["stop"]),onMouseover:G=>e(F),onMouseleave:G=>n(F)},[et(jS,{clip:F,zoom:f.zoom,frameLength:f.frameLength,hovered:F.selected||_.value&&_.value.id===F.id||v.value&&v.value.id===F.id},null,8,["clip","zoom","frameLength","hovered"]),F.selected||_.value&&_.value.id===F.id||v.value&&v.value.id===F.id?(mt(),Et("div",{key:0,class:"absolute left-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-l-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:Ze(G=>a(G,F,"left"),["stop"])},S[0]||(S[0]=[O("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,JS)):fe("",!0),F.selected||_.value&&_.value.id===F.id||v.value&&v.value.id===F.id?(mt(),Et("div",{key:1,class:"absolute right-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-r-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:Ze(G=>a(G,F,"right"),["stop"])},S[1]||(S[1]=[O("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,QS)):fe("",!0)],46,qS))),128))],40,KS))),128))],32))}}),eU=ps(tU,[["__scopeId","data-v-0d1785fd"]]);function iU(f){let l=0;for(let u=0;u<f.length;u++)l+=f[u]*f[u];return Math.sqrt(l/f.length)}const Zh=async f=>new Promise(async l=>{if(f.type==="image"){const h=await ai(f.path),u=new Ro(await h.stream());if(await u.ready){const{video:_}=await u.tick(0);if(_ instanceof ImageBitmap){const v=new OffscreenCanvas(_.width,_.height);v.getContext("2d").drawImage(_,0,0,_.width,_.height);const b=await v.convertToBlob();l({type:"image",data:b})}}}else if(f.type==="video"){const h=await ai(f.path),u=new nu(h);if(await u.ready){let _=performance.now();u.thumbnails().then(v=>{let s=[];v.forEach(b=>{s.push({url:URL.createObjectURL(b.img),timestamp:b.ts})}),console.log("get video frame",(performance.now()-_)/1e3+"s"),l({type:"video",data:s})})}}}),jh=async f=>new Promise(async(l,h)=>{var b;const u=await ai(f.path),p=new ru(await u.stream());await p.ready,performance.now();let _=!1,v=0,s=[];for(;!_;){const{audio:A,state:I}=await p.tick(v);if(I==="done"){_=!0;continue}if(v+=33333,A.length===0||((b=A[0])==null?void 0:b.length)===0){s.push(0);continue}else{const B=iU(A[0]);s.push(B)}}l({type:"audio",data:s})});var Xo={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */Xo.exports;(function(f,l){(function(){var h,u="4.17.21",p=200,_="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",v="Expected a function",s="Invalid `variable` option passed into `_.template`",b="__lodash_hash_undefined__",A=500,I="__lodash_placeholder__",B=1,U=2,N=4,t=1,e=2,n=1,a=2,d=4,g=8,y=16,w=32,S=64,L=128,k=256,F=512,G=30,R="...",lt=800,st=16,bt=1,V=2,Yt=3,Tt=1/0,Nt=9007199254740991,it=17976931348623157e292,Y=NaN,K=4294967295,at=K-1,X=K>>>1,Ht=[["ary",L],["bind",n],["bindKey",a],["curry",g],["curryRight",y],["flip",F],["partial",w],["partialRight",S],["rearg",k]],he="[object Arguments]",Ke="[object Array]",He="[object AsyncFunction]",ut="[object Boolean]",J="[object Date]",ot="[object DOMException]",ct="[object Error]",ne="[object Function]",Zt="[object GeneratorFunction]",Wt="[object Map]",Rt="[object Number]",bi="[object Null]",_e="[object Object]",Mi="[object Promise]",Jo="[object Proxy]",oi="[object RegExp]",Re="[object Set]",Ji="[object String]",vr="[object Symbol]",Qo="[object Undefined]",jt="[object WeakMap]",tl="[object WeakSet]",Gn="[object ArrayBuffer]",li="[object DataView]",wr="[object Float32Array]",Hn="[object Float64Array]",_s="[object Int8Array]",gs="[object Int16Array]",ms="[object Int32Array]",Oi="[object Uint8Array]",ys="[object Uint8ClampedArray]",vn="[object Uint16Array]",vs="[object Uint32Array]",el=/\b__p \+= '';/g,il=/\b(__p \+=) '' \+/g,nl=/(__e\(.*?\)|\b__t\)) \+\n'';/g,aa=/&(?:amp|lt|gt|quot|#39);/g,$=/[&<>"']/g,nt=RegExp(aa.source),vt=RegExp($.source),yt=/<%-([\s\S]+?)%>/g,_t=/<%([\s\S]+?)%>/g,wt=/<%=([\s\S]+?)%>/g,At=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,qt=/^\w*$/,ge=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,me=/[\\^$.*+?()[\]{}|]/g,se=RegExp(me.source),ae=/^\s+/,ze=/\s/,Ni=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,oa=/\{\n\/\* \[wrapped with (.+)\] \*/,fu=/,? & /,cp=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,pp=/[()=,{}\[\]\/\s]/,_p=/\\(\\)?/g,gp=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,du=/\w*$/,mp=/^[-+]0x[0-9a-f]+$/i,yp=/^0b[01]+$/i,vp=/^\[object .+?Constructor\]$/,wp=/^0o[0-7]+$/i,xp=/^(?:0|[1-9]\d*)$/,bp=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,la=/($^)/,Sp=/['\n\r\u2028\u2029\\]/g,ha="\\ud800-\\udfff",Up="\\u0300-\\u036f",Ep="\\ufe20-\\ufe2f",Cp="\\u20d0-\\u20ff",cu=Up+Ep+Cp,pu="\\u2700-\\u27bf",_u="a-z\\xdf-\\xf6\\xf8-\\xff",Tp="\\xac\\xb1\\xd7\\xf7",Ap="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",Ip="\\u2000-\\u206f",Bp=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",gu="A-Z\\xc0-\\xd6\\xd8-\\xde",mu="\\ufe0e\\ufe0f",yu=Tp+Ap+Ip+Bp,rl="['’]",zp="["+ha+"]",vu="["+yu+"]",ua="["+cu+"]",wu="\\d+",Fp="["+pu+"]",xu="["+_u+"]",bu="[^"+ha+yu+wu+pu+_u+gu+"]",sl="\\ud83c[\\udffb-\\udfff]",kp="(?:"+ua+"|"+sl+")",Su="[^"+ha+"]",al="(?:\\ud83c[\\udde6-\\uddff]){2}",ol="[\\ud800-\\udbff][\\udc00-\\udfff]",xr="["+gu+"]",Uu="\\u200d",Eu="(?:"+xu+"|"+bu+")",Lp="(?:"+xr+"|"+bu+")",Cu="(?:"+rl+"(?:d|ll|m|re|s|t|ve))?",Tu="(?:"+rl+"(?:D|LL|M|RE|S|T|VE))?",Au=kp+"?",Iu="["+mu+"]?",Pp="(?:"+Uu+"(?:"+[Su,al,ol].join("|")+")"+Iu+Au+")*",Rp="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Dp="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",Bu=Iu+Au+Pp,Mp="(?:"+[Fp,al,ol].join("|")+")"+Bu,Op="(?:"+[Su+ua+"?",ua,al,ol,zp].join("|")+")",Np=RegExp(rl,"g"),Gp=RegExp(ua,"g"),ll=RegExp(sl+"(?="+sl+")|"+Op+Bu,"g"),Hp=RegExp([xr+"?"+xu+"+"+Cu+"(?="+[vu,xr,"$"].join("|")+")",Lp+"+"+Tu+"(?="+[vu,xr+Eu,"$"].join("|")+")",xr+"?"+Eu+"+"+Cu,xr+"+"+Tu,Dp,Rp,wu,Mp].join("|"),"g"),Yp=RegExp("["+Uu+ha+cu+mu+"]"),Vp=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,Wp=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],$p=-1,ee={};ee[wr]=ee[Hn]=ee[_s]=ee[gs]=ee[ms]=ee[Oi]=ee[ys]=ee[vn]=ee[vs]=!0,ee[he]=ee[Ke]=ee[Gn]=ee[ut]=ee[li]=ee[J]=ee[ct]=ee[ne]=ee[Wt]=ee[Rt]=ee[_e]=ee[oi]=ee[Re]=ee[Ji]=ee[jt]=!1;var te={};te[he]=te[Ke]=te[Gn]=te[li]=te[ut]=te[J]=te[wr]=te[Hn]=te[_s]=te[gs]=te[ms]=te[Wt]=te[Rt]=te[_e]=te[oi]=te[Re]=te[Ji]=te[vr]=te[Oi]=te[ys]=te[vn]=te[vs]=!0,te[ct]=te[ne]=te[jt]=!1;var Xp={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},Zp={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},jp={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Kp={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},qp=parseFloat,Jp=parseInt,zu=typeof Ps=="object"&&Ps&&Ps.Object===Object&&Ps,Qp=typeof self=="object"&&self&&self.Object===Object&&self,Ce=zu||Qp||Function("return this")(),hl=l&&!l.nodeType&&l,Yn=hl&&!0&&f&&!f.nodeType&&f,Fu=Yn&&Yn.exports===hl,ul=Fu&&zu.process,hi=function(){try{var D=Yn&&Yn.require&&Yn.require("util").types;return D||ul&&ul.binding&&ul.binding("util")}catch{}}(),ku=hi&&hi.isArrayBuffer,Lu=hi&&hi.isDate,Pu=hi&&hi.isMap,Ru=hi&&hi.isRegExp,Du=hi&&hi.isSet,Mu=hi&&hi.isTypedArray;function qe(D,W,H){switch(H.length){case 0:return D.call(W);case 1:return D.call(W,H[0]);case 2:return D.call(W,H[0],H[1]);case 3:return D.call(W,H[0],H[1],H[2])}return D.apply(W,H)}function t_(D,W,H,dt){for(var It=-1,Vt=D==null?0:D.length;++It<Vt;){var ye=D[It];W(dt,ye,H(ye),D)}return dt}function ui(D,W){for(var H=-1,dt=D==null?0:D.length;++H<dt&&W(D[H],H,D)!==!1;);return D}function e_(D,W){for(var H=D==null?0:D.length;H--&&W(D[H],H,D)!==!1;);return D}function Ou(D,W){for(var H=-1,dt=D==null?0:D.length;++H<dt;)if(!W(D[H],H,D))return!1;return!0}function wn(D,W){for(var H=-1,dt=D==null?0:D.length,It=0,Vt=[];++H<dt;){var ye=D[H];W(ye,H,D)&&(Vt[It++]=ye)}return Vt}function fa(D,W){var H=D==null?0:D.length;return!!H&&br(D,W,0)>-1}function fl(D,W,H){for(var dt=-1,It=D==null?0:D.length;++dt<It;)if(H(W,D[dt]))return!0;return!1}function re(D,W){for(var H=-1,dt=D==null?0:D.length,It=Array(dt);++H<dt;)It[H]=W(D[H],H,D);return It}function xn(D,W){for(var H=-1,dt=W.length,It=D.length;++H<dt;)D[It+H]=W[H];return D}function dl(D,W,H,dt){var It=-1,Vt=D==null?0:D.length;for(dt&&Vt&&(H=D[++It]);++It<Vt;)H=W(H,D[It],It,D);return H}function i_(D,W,H,dt){var It=D==null?0:D.length;for(dt&&It&&(H=D[--It]);It--;)H=W(H,D[It],It,D);return H}function cl(D,W){for(var H=-1,dt=D==null?0:D.length;++H<dt;)if(W(D[H],H,D))return!0;return!1}var n_=pl("length");function r_(D){return D.split("")}function s_(D){return D.match(cp)||[]}function Nu(D,W,H){var dt;return H(D,function(It,Vt,ye){if(W(It,Vt,ye))return dt=Vt,!1}),dt}function da(D,W,H,dt){for(var It=D.length,Vt=H+(dt?1:-1);dt?Vt--:++Vt<It;)if(W(D[Vt],Vt,D))return Vt;return-1}function br(D,W,H){return W===W?m_(D,W,H):da(D,Gu,H)}function a_(D,W,H,dt){for(var It=H-1,Vt=D.length;++It<Vt;)if(dt(D[It],W))return It;return-1}function Gu(D){return D!==D}function Hu(D,W){var H=D==null?0:D.length;return H?gl(D,W)/H:Y}function pl(D){return function(W){return W==null?h:W[D]}}function _l(D){return function(W){return D==null?h:D[W]}}function Yu(D,W,H,dt,It){return It(D,function(Vt,ye,Jt){H=dt?(dt=!1,Vt):W(H,Vt,ye,Jt)}),H}function o_(D,W){var H=D.length;for(D.sort(W);H--;)D[H]=D[H].value;return D}function gl(D,W){for(var H,dt=-1,It=D.length;++dt<It;){var Vt=W(D[dt]);Vt!==h&&(H=H===h?Vt:H+Vt)}return H}function ml(D,W){for(var H=-1,dt=Array(D);++H<D;)dt[H]=W(H);return dt}function l_(D,W){return re(W,function(H){return[H,D[H]]})}function Vu(D){return D&&D.slice(0,Zu(D)+1).replace(ae,"")}function Je(D){return function(W){return D(W)}}function yl(D,W){return re(W,function(H){return D[H]})}function ws(D,W){return D.has(W)}function Wu(D,W){for(var H=-1,dt=D.length;++H<dt&&br(W,D[H],0)>-1;);return H}function $u(D,W){for(var H=D.length;H--&&br(W,D[H],0)>-1;);return H}function h_(D,W){for(var H=D.length,dt=0;H--;)D[H]===W&&++dt;return dt}var u_=_l(Xp),f_=_l(Zp);function d_(D){return"\\"+Kp[D]}function c_(D,W){return D==null?h:D[W]}function Sr(D){return Yp.test(D)}function p_(D){return Vp.test(D)}function __(D){for(var W,H=[];!(W=D.next()).done;)H.push(W.value);return H}function vl(D){var W=-1,H=Array(D.size);return D.forEach(function(dt,It){H[++W]=[It,dt]}),H}function Xu(D,W){return function(H){return D(W(H))}}function bn(D,W){for(var H=-1,dt=D.length,It=0,Vt=[];++H<dt;){var ye=D[H];(ye===W||ye===I)&&(D[H]=I,Vt[It++]=H)}return Vt}function ca(D){var W=-1,H=Array(D.size);return D.forEach(function(dt){H[++W]=dt}),H}function g_(D){var W=-1,H=Array(D.size);return D.forEach(function(dt){H[++W]=[dt,dt]}),H}function m_(D,W,H){for(var dt=H-1,It=D.length;++dt<It;)if(D[dt]===W)return dt;return-1}function y_(D,W,H){for(var dt=H+1;dt--;)if(D[dt]===W)return dt;return dt}function Ur(D){return Sr(D)?w_(D):n_(D)}function Si(D){return Sr(D)?x_(D):r_(D)}function Zu(D){for(var W=D.length;W--&&ze.test(D.charAt(W)););return W}var v_=_l(jp);function w_(D){for(var W=ll.lastIndex=0;ll.test(D);)++W;return W}function x_(D){return D.match(ll)||[]}function b_(D){return D.match(Hp)||[]}var S_=function D(W){W=W==null?Ce:Er.defaults(Ce.Object(),W,Er.pick(Ce,Wp));var H=W.Array,dt=W.Date,It=W.Error,Vt=W.Function,ye=W.Math,Jt=W.Object,wl=W.RegExp,U_=W.String,fi=W.TypeError,pa=H.prototype,E_=Vt.prototype,Cr=Jt.prototype,_a=W["__core-js_shared__"],ga=E_.toString,Kt=Cr.hasOwnProperty,C_=0,ju=function(){var r=/[^.]+$/.exec(_a&&_a.keys&&_a.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}(),ma=Cr.toString,T_=ga.call(Jt),A_=Ce._,I_=wl("^"+ga.call(Kt).replace(me,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ya=Fu?W.Buffer:h,Sn=W.Symbol,va=W.Uint8Array,Ku=ya?ya.allocUnsafe:h,wa=Xu(Jt.getPrototypeOf,Jt),qu=Jt.create,Ju=Cr.propertyIsEnumerable,xa=pa.splice,Qu=Sn?Sn.isConcatSpreadable:h,xs=Sn?Sn.iterator:h,Vn=Sn?Sn.toStringTag:h,ba=function(){try{var r=jn(Jt,"defineProperty");return r({},"",{}),r}catch{}}(),B_=W.clearTimeout!==Ce.clearTimeout&&W.clearTimeout,z_=dt&&dt.now!==Ce.Date.now&&dt.now,F_=W.setTimeout!==Ce.setTimeout&&W.setTimeout,Sa=ye.ceil,Ua=ye.floor,xl=Jt.getOwnPropertySymbols,k_=ya?ya.isBuffer:h,tf=W.isFinite,L_=pa.join,P_=Xu(Jt.keys,Jt),ve=ye.max,Fe=ye.min,R_=dt.now,D_=W.parseInt,ef=ye.random,M_=pa.reverse,bl=jn(W,"DataView"),bs=jn(W,"Map"),Sl=jn(W,"Promise"),Tr=jn(W,"Set"),Ss=jn(W,"WeakMap"),Us=jn(Jt,"create"),Ea=Ss&&new Ss,Ar={},O_=Kn(bl),N_=Kn(bs),G_=Kn(Sl),H_=Kn(Tr),Y_=Kn(Ss),Ca=Sn?Sn.prototype:h,Es=Ca?Ca.valueOf:h,nf=Ca?Ca.toString:h;function E(r){if(ue(r)&&!Bt(r)&&!(r instanceof Mt)){if(r instanceof di)return r;if(Kt.call(r,"__wrapped__"))return rd(r)}return new di(r)}var Ir=function(){function r(){}return function(o){if(!oe(o))return{};if(qu)return qu(o);r.prototype=o;var c=new r;return r.prototype=h,c}}();function Ta(){}function di(r,o){this.__wrapped__=r,this.__actions__=[],this.__chain__=!!o,this.__index__=0,this.__values__=h}E.templateSettings={escape:yt,evaluate:_t,interpolate:wt,variable:"",imports:{_:E}},E.prototype=Ta.prototype,E.prototype.constructor=E,di.prototype=Ir(Ta.prototype),di.prototype.constructor=di;function Mt(r){this.__wrapped__=r,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=K,this.__views__=[]}function V_(){var r=new Mt(this.__wrapped__);return r.__actions__=Ye(this.__actions__),r.__dir__=this.__dir__,r.__filtered__=this.__filtered__,r.__iteratees__=Ye(this.__iteratees__),r.__takeCount__=this.__takeCount__,r.__views__=Ye(this.__views__),r}function W_(){if(this.__filtered__){var r=new Mt(this);r.__dir__=-1,r.__filtered__=!0}else r=this.clone(),r.__dir__*=-1;return r}function $_(){var r=this.__wrapped__.value(),o=this.__dir__,c=Bt(r),m=o<0,x=c?r.length:0,C=rm(0,x,this.__views__),z=C.start,P=C.end,M=P-z,Z=m?P:z-1,j=this.__iteratees__,q=j.length,ht=0,gt=Fe(M,this.__takeCount__);if(!c||!m&&x==M&&gt==M)return Tf(r,this.__actions__);var St=[];t:for(;M--&&ht<gt;){Z+=o;for(var kt=-1,Ut=r[Z];++kt<q;){var Dt=j[kt],Ot=Dt.iteratee,ei=Dt.type,Oe=Ot(Ut);if(ei==V)Ut=Oe;else if(!Oe){if(ei==bt)continue t;break t}}St[ht++]=Ut}return St}Mt.prototype=Ir(Ta.prototype),Mt.prototype.constructor=Mt;function Wn(r){var o=-1,c=r==null?0:r.length;for(this.clear();++o<c;){var m=r[o];this.set(m[0],m[1])}}function X_(){this.__data__=Us?Us(null):{},this.size=0}function Z_(r){var o=this.has(r)&&delete this.__data__[r];return this.size-=o?1:0,o}function j_(r){var o=this.__data__;if(Us){var c=o[r];return c===b?h:c}return Kt.call(o,r)?o[r]:h}function K_(r){var o=this.__data__;return Us?o[r]!==h:Kt.call(o,r)}function q_(r,o){var c=this.__data__;return this.size+=this.has(r)?0:1,c[r]=Us&&o===h?b:o,this}Wn.prototype.clear=X_,Wn.prototype.delete=Z_,Wn.prototype.get=j_,Wn.prototype.has=K_,Wn.prototype.set=q_;function Qi(r){var o=-1,c=r==null?0:r.length;for(this.clear();++o<c;){var m=r[o];this.set(m[0],m[1])}}function J_(){this.__data__=[],this.size=0}function Q_(r){var o=this.__data__,c=Aa(o,r);if(c<0)return!1;var m=o.length-1;return c==m?o.pop():xa.call(o,c,1),--this.size,!0}function tg(r){var o=this.__data__,c=Aa(o,r);return c<0?h:o[c][1]}function eg(r){return Aa(this.__data__,r)>-1}function ig(r,o){var c=this.__data__,m=Aa(c,r);return m<0?(++this.size,c.push([r,o])):c[m][1]=o,this}Qi.prototype.clear=J_,Qi.prototype.delete=Q_,Qi.prototype.get=tg,Qi.prototype.has=eg,Qi.prototype.set=ig;function tn(r){var o=-1,c=r==null?0:r.length;for(this.clear();++o<c;){var m=r[o];this.set(m[0],m[1])}}function ng(){this.size=0,this.__data__={hash:new Wn,map:new(bs||Qi),string:new Wn}}function rg(r){var o=Na(this,r).delete(r);return this.size-=o?1:0,o}function sg(r){return Na(this,r).get(r)}function ag(r){return Na(this,r).has(r)}function og(r,o){var c=Na(this,r),m=c.size;return c.set(r,o),this.size+=c.size==m?0:1,this}tn.prototype.clear=ng,tn.prototype.delete=rg,tn.prototype.get=sg,tn.prototype.has=ag,tn.prototype.set=og;function $n(r){var o=-1,c=r==null?0:r.length;for(this.__data__=new tn;++o<c;)this.add(r[o])}function lg(r){return this.__data__.set(r,b),this}function hg(r){return this.__data__.has(r)}$n.prototype.add=$n.prototype.push=lg,$n.prototype.has=hg;function Ui(r){var o=this.__data__=new Qi(r);this.size=o.size}function ug(){this.__data__=new Qi,this.size=0}function fg(r){var o=this.__data__,c=o.delete(r);return this.size=o.size,c}function dg(r){return this.__data__.get(r)}function cg(r){return this.__data__.has(r)}function pg(r,o){var c=this.__data__;if(c instanceof Qi){var m=c.__data__;if(!bs||m.length<p-1)return m.push([r,o]),this.size=++c.size,this;c=this.__data__=new tn(m)}return c.set(r,o),this.size=c.size,this}Ui.prototype.clear=ug,Ui.prototype.delete=fg,Ui.prototype.get=dg,Ui.prototype.has=cg,Ui.prototype.set=pg;function rf(r,o){var c=Bt(r),m=!c&&qn(r),x=!c&&!m&&An(r),C=!c&&!m&&!x&&kr(r),z=c||m||x||C,P=z?ml(r.length,U_):[],M=P.length;for(var Z in r)(o||Kt.call(r,Z))&&!(z&&(Z=="length"||x&&(Z=="offset"||Z=="parent")||C&&(Z=="buffer"||Z=="byteLength"||Z=="byteOffset")||sn(Z,M)))&&P.push(Z);return P}function sf(r){var o=r.length;return o?r[Ll(0,o-1)]:h}function _g(r,o){return Ga(Ye(r),Xn(o,0,r.length))}function gg(r){return Ga(Ye(r))}function Ul(r,o,c){(c!==h&&!Ei(r[o],c)||c===h&&!(o in r))&&en(r,o,c)}function Cs(r,o,c){var m=r[o];(!(Kt.call(r,o)&&Ei(m,c))||c===h&&!(o in r))&&en(r,o,c)}function Aa(r,o){for(var c=r.length;c--;)if(Ei(r[c][0],o))return c;return-1}function mg(r,o,c,m){return Un(r,function(x,C,z){o(m,x,c(x),z)}),m}function af(r,o){return r&&Hi(o,Se(o),r)}function yg(r,o){return r&&Hi(o,We(o),r)}function en(r,o,c){o=="__proto__"&&ba?ba(r,o,{configurable:!0,enumerable:!0,value:c,writable:!0}):r[o]=c}function El(r,o){for(var c=-1,m=o.length,x=H(m),C=r==null;++c<m;)x[c]=C?h:sh(r,o[c]);return x}function Xn(r,o,c){return r===r&&(c!==h&&(r=r<=c?r:c),o!==h&&(r=r>=o?r:o)),r}function ci(r,o,c,m,x,C){var z,P=o&B,M=o&U,Z=o&N;if(c&&(z=x?c(r,m,x,C):c(r)),z!==h)return z;if(!oe(r))return r;var j=Bt(r);if(j){if(z=am(r),!P)return Ye(r,z)}else{var q=ke(r),ht=q==ne||q==Zt;if(An(r))return Bf(r,P);if(q==_e||q==he||ht&&!x){if(z=M||ht?{}:jf(r),!P)return M?jg(r,yg(z,r)):Zg(r,af(z,r))}else{if(!te[q])return x?r:{};z=om(r,q,P)}}C||(C=new Ui);var gt=C.get(r);if(gt)return gt;C.set(r,z),Ud(r)?r.forEach(function(Ut){z.add(ci(Ut,o,c,Ut,r,C))}):bd(r)&&r.forEach(function(Ut,Dt){z.set(Dt,ci(Ut,o,c,Dt,r,C))});var St=Z?M?Wl:Vl:M?We:Se,kt=j?h:St(r);return ui(kt||r,function(Ut,Dt){kt&&(Dt=Ut,Ut=r[Dt]),Cs(z,Dt,ci(Ut,o,c,Dt,r,C))}),z}function vg(r){var o=Se(r);return function(c){return of(c,r,o)}}function of(r,o,c){var m=c.length;if(r==null)return!m;for(r=Jt(r);m--;){var x=c[m],C=o[x],z=r[x];if(z===h&&!(x in r)||!C(z))return!1}return!0}function lf(r,o,c){if(typeof r!="function")throw new fi(v);return ks(function(){r.apply(h,c)},o)}function Ts(r,o,c,m){var x=-1,C=fa,z=!0,P=r.length,M=[],Z=o.length;if(!P)return M;c&&(o=re(o,Je(c))),m?(C=fl,z=!1):o.length>=p&&(C=ws,z=!1,o=new $n(o));t:for(;++x<P;){var j=r[x],q=c==null?j:c(j);if(j=m||j!==0?j:0,z&&q===q){for(var ht=Z;ht--;)if(o[ht]===q)continue t;M.push(j)}else C(o,q,m)||M.push(j)}return M}var Un=Pf(Gi),hf=Pf(Tl,!0);function wg(r,o){var c=!0;return Un(r,function(m,x,C){return c=!!o(m,x,C),c}),c}function Ia(r,o,c){for(var m=-1,x=r.length;++m<x;){var C=r[m],z=o(C);if(z!=null&&(P===h?z===z&&!ti(z):c(z,P)))var P=z,M=C}return M}function xg(r,o,c,m){var x=r.length;for(c=Ft(c),c<0&&(c=-c>x?0:x+c),m=m===h||m>x?x:Ft(m),m<0&&(m+=x),m=c>m?0:Cd(m);c<m;)r[c++]=o;return r}function uf(r,o){var c=[];return Un(r,function(m,x,C){o(m,x,C)&&c.push(m)}),c}function Te(r,o,c,m,x){var C=-1,z=r.length;for(c||(c=hm),x||(x=[]);++C<z;){var P=r[C];o>0&&c(P)?o>1?Te(P,o-1,c,m,x):xn(x,P):m||(x[x.length]=P)}return x}var Cl=Rf(),ff=Rf(!0);function Gi(r,o){return r&&Cl(r,o,Se)}function Tl(r,o){return r&&ff(r,o,Se)}function Ba(r,o){return wn(o,function(c){return an(r[c])})}function Zn(r,o){o=Cn(o,r);for(var c=0,m=o.length;r!=null&&c<m;)r=r[Yi(o[c++])];return c&&c==m?r:h}function df(r,o,c){var m=o(r);return Bt(r)?m:xn(m,c(r))}function De(r){return r==null?r===h?Qo:bi:Vn&&Vn in Jt(r)?nm(r):gm(r)}function Al(r,o){return r>o}function bg(r,o){return r!=null&&Kt.call(r,o)}function Sg(r,o){return r!=null&&o in Jt(r)}function Ug(r,o,c){return r>=Fe(o,c)&&r<ve(o,c)}function Il(r,o,c){for(var m=c?fl:fa,x=r[0].length,C=r.length,z=C,P=H(C),M=1/0,Z=[];z--;){var j=r[z];z&&o&&(j=re(j,Je(o))),M=Fe(j.length,M),P[z]=!c&&(o||x>=120&&j.length>=120)?new $n(z&&j):h}j=r[0];var q=-1,ht=P[0];t:for(;++q<x&&Z.length<M;){var gt=j[q],St=o?o(gt):gt;if(gt=c||gt!==0?gt:0,!(ht?ws(ht,St):m(Z,St,c))){for(z=C;--z;){var kt=P[z];if(!(kt?ws(kt,St):m(r[z],St,c)))continue t}ht&&ht.push(St),Z.push(gt)}}return Z}function Eg(r,o,c,m){return Gi(r,function(x,C,z){o(m,c(x),C,z)}),m}function As(r,o,c){o=Cn(o,r),r=Qf(r,o);var m=r==null?r:r[Yi(_i(o))];return m==null?h:qe(m,r,c)}function cf(r){return ue(r)&&De(r)==he}function Cg(r){return ue(r)&&De(r)==Gn}function Tg(r){return ue(r)&&De(r)==J}function Is(r,o,c,m,x){return r===o?!0:r==null||o==null||!ue(r)&&!ue(o)?r!==r&&o!==o:Ag(r,o,c,m,Is,x)}function Ag(r,o,c,m,x,C){var z=Bt(r),P=Bt(o),M=z?Ke:ke(r),Z=P?Ke:ke(o);M=M==he?_e:M,Z=Z==he?_e:Z;var j=M==_e,q=Z==_e,ht=M==Z;if(ht&&An(r)){if(!An(o))return!1;z=!0,j=!1}if(ht&&!j)return C||(C=new Ui),z||kr(r)?$f(r,o,c,m,x,C):em(r,o,M,c,m,x,C);if(!(c&t)){var gt=j&&Kt.call(r,"__wrapped__"),St=q&&Kt.call(o,"__wrapped__");if(gt||St){var kt=gt?r.value():r,Ut=St?o.value():o;return C||(C=new Ui),x(kt,Ut,c,m,C)}}return ht?(C||(C=new Ui),im(r,o,c,m,x,C)):!1}function Ig(r){return ue(r)&&ke(r)==Wt}function Bl(r,o,c,m){var x=c.length,C=x,z=!m;if(r==null)return!C;for(r=Jt(r);x--;){var P=c[x];if(z&&P[2]?P[1]!==r[P[0]]:!(P[0]in r))return!1}for(;++x<C;){P=c[x];var M=P[0],Z=r[M],j=P[1];if(z&&P[2]){if(Z===h&&!(M in r))return!1}else{var q=new Ui;if(m)var ht=m(Z,j,M,r,o,q);if(!(ht===h?Is(j,Z,t|e,m,q):ht))return!1}}return!0}function pf(r){if(!oe(r)||fm(r))return!1;var o=an(r)?I_:vp;return o.test(Kn(r))}function Bg(r){return ue(r)&&De(r)==oi}function zg(r){return ue(r)&&ke(r)==Re}function Fg(r){return ue(r)&&Xa(r.length)&&!!ee[De(r)]}function _f(r){return typeof r=="function"?r:r==null?$e:typeof r=="object"?Bt(r)?yf(r[0],r[1]):mf(r):Dd(r)}function zl(r){if(!Fs(r))return P_(r);var o=[];for(var c in Jt(r))Kt.call(r,c)&&c!="constructor"&&o.push(c);return o}function kg(r){if(!oe(r))return _m(r);var o=Fs(r),c=[];for(var m in r)m=="constructor"&&(o||!Kt.call(r,m))||c.push(m);return c}function Fl(r,o){return r<o}function gf(r,o){var c=-1,m=Ve(r)?H(r.length):[];return Un(r,function(x,C,z){m[++c]=o(x,C,z)}),m}function mf(r){var o=Xl(r);return o.length==1&&o[0][2]?qf(o[0][0],o[0][1]):function(c){return c===r||Bl(c,r,o)}}function yf(r,o){return jl(r)&&Kf(o)?qf(Yi(r),o):function(c){var m=sh(c,r);return m===h&&m===o?ah(c,r):Is(o,m,t|e)}}function za(r,o,c,m,x){r!==o&&Cl(o,function(C,z){if(x||(x=new Ui),oe(C))Lg(r,o,z,c,za,m,x);else{var P=m?m(ql(r,z),C,z+"",r,o,x):h;P===h&&(P=C),Ul(r,z,P)}},We)}function Lg(r,o,c,m,x,C,z){var P=ql(r,c),M=ql(o,c),Z=z.get(M);if(Z){Ul(r,c,Z);return}var j=C?C(P,M,c+"",r,o,z):h,q=j===h;if(q){var ht=Bt(M),gt=!ht&&An(M),St=!ht&&!gt&&kr(M);j=M,ht||gt||St?Bt(P)?j=P:ce(P)?j=Ye(P):gt?(q=!1,j=Bf(M,!0)):St?(q=!1,j=zf(M,!0)):j=[]:Ls(M)||qn(M)?(j=P,qn(P)?j=Td(P):(!oe(P)||an(P))&&(j=jf(M))):q=!1}q&&(z.set(M,j),x(j,M,m,C,z),z.delete(M)),Ul(r,c,j)}function vf(r,o){var c=r.length;if(c)return o+=o<0?c:0,sn(o,c)?r[o]:h}function wf(r,o,c){o.length?o=re(o,function(C){return Bt(C)?function(z){return Zn(z,C.length===1?C[0]:C)}:C}):o=[$e];var m=-1;o=re(o,Je(xt()));var x=gf(r,function(C,z,P){var M=re(o,function(Z){return Z(C)});return{criteria:M,index:++m,value:C}});return o_(x,function(C,z){return Xg(C,z,c)})}function Pg(r,o){return xf(r,o,function(c,m){return ah(r,m)})}function xf(r,o,c){for(var m=-1,x=o.length,C={};++m<x;){var z=o[m],P=Zn(r,z);c(P,z)&&Bs(C,Cn(z,r),P)}return C}function Rg(r){return function(o){return Zn(o,r)}}function kl(r,o,c,m){var x=m?a_:br,C=-1,z=o.length,P=r;for(r===o&&(o=Ye(o)),c&&(P=re(r,Je(c)));++C<z;)for(var M=0,Z=o[C],j=c?c(Z):Z;(M=x(P,j,M,m))>-1;)P!==r&&xa.call(P,M,1),xa.call(r,M,1);return r}function bf(r,o){for(var c=r?o.length:0,m=c-1;c--;){var x=o[c];if(c==m||x!==C){var C=x;sn(x)?xa.call(r,x,1):Dl(r,x)}}return r}function Ll(r,o){return r+Ua(ef()*(o-r+1))}function Dg(r,o,c,m){for(var x=-1,C=ve(Sa((o-r)/(c||1)),0),z=H(C);C--;)z[m?C:++x]=r,r+=c;return z}function Pl(r,o){var c="";if(!r||o<1||o>Nt)return c;do o%2&&(c+=r),o=Ua(o/2),o&&(r+=r);while(o);return c}function Pt(r,o){return Jl(Jf(r,o,$e),r+"")}function Mg(r){return sf(Lr(r))}function Og(r,o){var c=Lr(r);return Ga(c,Xn(o,0,c.length))}function Bs(r,o,c,m){if(!oe(r))return r;o=Cn(o,r);for(var x=-1,C=o.length,z=C-1,P=r;P!=null&&++x<C;){var M=Yi(o[x]),Z=c;if(M==="__proto__"||M==="constructor"||M==="prototype")return r;if(x!=z){var j=P[M];Z=m?m(j,M,P):h,Z===h&&(Z=oe(j)?j:sn(o[x+1])?[]:{})}Cs(P,M,Z),P=P[M]}return r}var Sf=Ea?function(r,o){return Ea.set(r,o),r}:$e,Ng=ba?function(r,o){return ba(r,"toString",{configurable:!0,enumerable:!1,value:lh(o),writable:!0})}:$e;function Gg(r){return Ga(Lr(r))}function pi(r,o,c){var m=-1,x=r.length;o<0&&(o=-o>x?0:x+o),c=c>x?x:c,c<0&&(c+=x),x=o>c?0:c-o>>>0,o>>>=0;for(var C=H(x);++m<x;)C[m]=r[m+o];return C}function Hg(r,o){var c;return Un(r,function(m,x,C){return c=o(m,x,C),!c}),!!c}function Fa(r,o,c){var m=0,x=r==null?m:r.length;if(typeof o=="number"&&o===o&&x<=X){for(;m<x;){var C=m+x>>>1,z=r[C];z!==null&&!ti(z)&&(c?z<=o:z<o)?m=C+1:x=C}return x}return Rl(r,o,$e,c)}function Rl(r,o,c,m){var x=0,C=r==null?0:r.length;if(C===0)return 0;o=c(o);for(var z=o!==o,P=o===null,M=ti(o),Z=o===h;x<C;){var j=Ua((x+C)/2),q=c(r[j]),ht=q!==h,gt=q===null,St=q===q,kt=ti(q);if(z)var Ut=m||St;else Z?Ut=St&&(m||ht):P?Ut=St&&ht&&(m||!gt):M?Ut=St&&ht&&!gt&&(m||!kt):gt||kt?Ut=!1:Ut=m?q<=o:q<o;Ut?x=j+1:C=j}return Fe(C,at)}function Uf(r,o){for(var c=-1,m=r.length,x=0,C=[];++c<m;){var z=r[c],P=o?o(z):z;if(!c||!Ei(P,M)){var M=P;C[x++]=z===0?0:z}}return C}function Ef(r){return typeof r=="number"?r:ti(r)?Y:+r}function Qe(r){if(typeof r=="string")return r;if(Bt(r))return re(r,Qe)+"";if(ti(r))return nf?nf.call(r):"";var o=r+"";return o=="0"&&1/r==-1/0?"-0":o}function En(r,o,c){var m=-1,x=fa,C=r.length,z=!0,P=[],M=P;if(c)z=!1,x=fl;else if(C>=p){var Z=o?null:Qg(r);if(Z)return ca(Z);z=!1,x=ws,M=new $n}else M=o?[]:P;t:for(;++m<C;){var j=r[m],q=o?o(j):j;if(j=c||j!==0?j:0,z&&q===q){for(var ht=M.length;ht--;)if(M[ht]===q)continue t;o&&M.push(q),P.push(j)}else x(M,q,c)||(M!==P&&M.push(q),P.push(j))}return P}function Dl(r,o){return o=Cn(o,r),r=Qf(r,o),r==null||delete r[Yi(_i(o))]}function Cf(r,o,c,m){return Bs(r,o,c(Zn(r,o)),m)}function ka(r,o,c,m){for(var x=r.length,C=m?x:-1;(m?C--:++C<x)&&o(r[C],C,r););return c?pi(r,m?0:C,m?C+1:x):pi(r,m?C+1:0,m?x:C)}function Tf(r,o){var c=r;return c instanceof Mt&&(c=c.value()),dl(o,function(m,x){return x.func.apply(x.thisArg,xn([m],x.args))},c)}function Ml(r,o,c){var m=r.length;if(m<2)return m?En(r[0]):[];for(var x=-1,C=H(m);++x<m;)for(var z=r[x],P=-1;++P<m;)P!=x&&(C[x]=Ts(C[x]||z,r[P],o,c));return En(Te(C,1),o,c)}function Af(r,o,c){for(var m=-1,x=r.length,C=o.length,z={};++m<x;){var P=m<C?o[m]:h;c(z,r[m],P)}return z}function Ol(r){return ce(r)?r:[]}function Nl(r){return typeof r=="function"?r:$e}function Cn(r,o){return Bt(r)?r:jl(r,o)?[r]:nd($t(r))}var Yg=Pt;function Tn(r,o,c){var m=r.length;return c=c===h?m:c,!o&&c>=m?r:pi(r,o,c)}var If=B_||function(r){return Ce.clearTimeout(r)};function Bf(r,o){if(o)return r.slice();var c=r.length,m=Ku?Ku(c):new r.constructor(c);return r.copy(m),m}function Gl(r){var o=new r.constructor(r.byteLength);return new va(o).set(new va(r)),o}function Vg(r,o){var c=o?Gl(r.buffer):r.buffer;return new r.constructor(c,r.byteOffset,r.byteLength)}function Wg(r){var o=new r.constructor(r.source,du.exec(r));return o.lastIndex=r.lastIndex,o}function $g(r){return Es?Jt(Es.call(r)):{}}function zf(r,o){var c=o?Gl(r.buffer):r.buffer;return new r.constructor(c,r.byteOffset,r.length)}function Ff(r,o){if(r!==o){var c=r!==h,m=r===null,x=r===r,C=ti(r),z=o!==h,P=o===null,M=o===o,Z=ti(o);if(!P&&!Z&&!C&&r>o||C&&z&&M&&!P&&!Z||m&&z&&M||!c&&M||!x)return 1;if(!m&&!C&&!Z&&r<o||Z&&c&&x&&!m&&!C||P&&c&&x||!z&&x||!M)return-1}return 0}function Xg(r,o,c){for(var m=-1,x=r.criteria,C=o.criteria,z=x.length,P=c.length;++m<z;){var M=Ff(x[m],C[m]);if(M){if(m>=P)return M;var Z=c[m];return M*(Z=="desc"?-1:1)}}return r.index-o.index}function kf(r,o,c,m){for(var x=-1,C=r.length,z=c.length,P=-1,M=o.length,Z=ve(C-z,0),j=H(M+Z),q=!m;++P<M;)j[P]=o[P];for(;++x<z;)(q||x<C)&&(j[c[x]]=r[x]);for(;Z--;)j[P++]=r[x++];return j}function Lf(r,o,c,m){for(var x=-1,C=r.length,z=-1,P=c.length,M=-1,Z=o.length,j=ve(C-P,0),q=H(j+Z),ht=!m;++x<j;)q[x]=r[x];for(var gt=x;++M<Z;)q[gt+M]=o[M];for(;++z<P;)(ht||x<C)&&(q[gt+c[z]]=r[x++]);return q}function Ye(r,o){var c=-1,m=r.length;for(o||(o=H(m));++c<m;)o[c]=r[c];return o}function Hi(r,o,c,m){var x=!c;c||(c={});for(var C=-1,z=o.length;++C<z;){var P=o[C],M=m?m(c[P],r[P],P,c,r):h;M===h&&(M=r[P]),x?en(c,P,M):Cs(c,P,M)}return c}function Zg(r,o){return Hi(r,Zl(r),o)}function jg(r,o){return Hi(r,Xf(r),o)}function La(r,o){return function(c,m){var x=Bt(c)?t_:mg,C=o?o():{};return x(c,r,xt(m,2),C)}}function Br(r){return Pt(function(o,c){var m=-1,x=c.length,C=x>1?c[x-1]:h,z=x>2?c[2]:h;for(C=r.length>3&&typeof C=="function"?(x--,C):h,z&&Me(c[0],c[1],z)&&(C=x<3?h:C,x=1),o=Jt(o);++m<x;){var P=c[m];P&&r(o,P,m,C)}return o})}function Pf(r,o){return function(c,m){if(c==null)return c;if(!Ve(c))return r(c,m);for(var x=c.length,C=o?x:-1,z=Jt(c);(o?C--:++C<x)&&m(z[C],C,z)!==!1;);return c}}function Rf(r){return function(o,c,m){for(var x=-1,C=Jt(o),z=m(o),P=z.length;P--;){var M=z[r?P:++x];if(c(C[M],M,C)===!1)break}return o}}function Kg(r,o,c){var m=o&n,x=zs(r);function C(){var z=this&&this!==Ce&&this instanceof C?x:r;return z.apply(m?c:this,arguments)}return C}function Df(r){return function(o){o=$t(o);var c=Sr(o)?Si(o):h,m=c?c[0]:o.charAt(0),x=c?Tn(c,1).join(""):o.slice(1);return m[r]()+x}}function zr(r){return function(o){return dl(Pd(Ld(o).replace(Np,"")),r,"")}}function zs(r){return function(){var o=arguments;switch(o.length){case 0:return new r;case 1:return new r(o[0]);case 2:return new r(o[0],o[1]);case 3:return new r(o[0],o[1],o[2]);case 4:return new r(o[0],o[1],o[2],o[3]);case 5:return new r(o[0],o[1],o[2],o[3],o[4]);case 6:return new r(o[0],o[1],o[2],o[3],o[4],o[5]);case 7:return new r(o[0],o[1],o[2],o[3],o[4],o[5],o[6])}var c=Ir(r.prototype),m=r.apply(c,o);return oe(m)?m:c}}function qg(r,o,c){var m=zs(r);function x(){for(var C=arguments.length,z=H(C),P=C,M=Fr(x);P--;)z[P]=arguments[P];var Z=C<3&&z[0]!==M&&z[C-1]!==M?[]:bn(z,M);if(C-=Z.length,C<c)return Hf(r,o,Pa,x.placeholder,h,z,Z,h,h,c-C);var j=this&&this!==Ce&&this instanceof x?m:r;return qe(j,this,z)}return x}function Mf(r){return function(o,c,m){var x=Jt(o);if(!Ve(o)){var C=xt(c,3);o=Se(o),c=function(P){return C(x[P],P,x)}}var z=r(o,c,m);return z>-1?x[C?o[z]:z]:h}}function Of(r){return rn(function(o){var c=o.length,m=c,x=di.prototype.thru;for(r&&o.reverse();m--;){var C=o[m];if(typeof C!="function")throw new fi(v);if(x&&!z&&Oa(C)=="wrapper")var z=new di([],!0)}for(m=z?m:c;++m<c;){C=o[m];var P=Oa(C),M=P=="wrapper"?$l(C):h;M&&Kl(M[0])&&M[1]==(L|g|w|k)&&!M[4].length&&M[9]==1?z=z[Oa(M[0])].apply(z,M[3]):z=C.length==1&&Kl(C)?z[P]():z.thru(C)}return function(){var Z=arguments,j=Z[0];if(z&&Z.length==1&&Bt(j))return z.plant(j).value();for(var q=0,ht=c?o[q].apply(this,Z):j;++q<c;)ht=o[q].call(this,ht);return ht}})}function Pa(r,o,c,m,x,C,z,P,M,Z){var j=o&L,q=o&n,ht=o&a,gt=o&(g|y),St=o&F,kt=ht?h:zs(r);function Ut(){for(var Dt=arguments.length,Ot=H(Dt),ei=Dt;ei--;)Ot[ei]=arguments[ei];if(gt)var Oe=Fr(Ut),ii=h_(Ot,Oe);if(m&&(Ot=kf(Ot,m,x,gt)),C&&(Ot=Lf(Ot,C,z,gt)),Dt-=ii,gt&&Dt<Z){var pe=bn(Ot,Oe);return Hf(r,o,Pa,Ut.placeholder,c,Ot,pe,P,M,Z-Dt)}var Ci=q?c:this,ln=ht?Ci[r]:r;return Dt=Ot.length,P?Ot=mm(Ot,P):St&&Dt>1&&Ot.reverse(),j&&M<Dt&&(Ot.length=M),this&&this!==Ce&&this instanceof Ut&&(ln=kt||zs(ln)),ln.apply(Ci,Ot)}return Ut}function Nf(r,o){return function(c,m){return Eg(c,r,o(m),{})}}function Ra(r,o){return function(c,m){var x;if(c===h&&m===h)return o;if(c!==h&&(x=c),m!==h){if(x===h)return m;typeof c=="string"||typeof m=="string"?(c=Qe(c),m=Qe(m)):(c=Ef(c),m=Ef(m)),x=r(c,m)}return x}}function Hl(r){return rn(function(o){return o=re(o,Je(xt())),Pt(function(c){var m=this;return r(o,function(x){return qe(x,m,c)})})})}function Da(r,o){o=o===h?" ":Qe(o);var c=o.length;if(c<2)return c?Pl(o,r):o;var m=Pl(o,Sa(r/Ur(o)));return Sr(o)?Tn(Si(m),0,r).join(""):m.slice(0,r)}function Jg(r,o,c,m){var x=o&n,C=zs(r);function z(){for(var P=-1,M=arguments.length,Z=-1,j=m.length,q=H(j+M),ht=this&&this!==Ce&&this instanceof z?C:r;++Z<j;)q[Z]=m[Z];for(;M--;)q[Z++]=arguments[++P];return qe(ht,x?c:this,q)}return z}function Gf(r){return function(o,c,m){return m&&typeof m!="number"&&Me(o,c,m)&&(c=m=h),o=on(o),c===h?(c=o,o=0):c=on(c),m=m===h?o<c?1:-1:on(m),Dg(o,c,m,r)}}function Ma(r){return function(o,c){return typeof o=="string"&&typeof c=="string"||(o=gi(o),c=gi(c)),r(o,c)}}function Hf(r,o,c,m,x,C,z,P,M,Z){var j=o&g,q=j?z:h,ht=j?h:z,gt=j?C:h,St=j?h:C;o|=j?w:S,o&=~(j?S:w),o&d||(o&=-4);var kt=[r,o,x,gt,q,St,ht,P,M,Z],Ut=c.apply(h,kt);return Kl(r)&&td(Ut,kt),Ut.placeholder=m,ed(Ut,r,o)}function Yl(r){var o=ye[r];return function(c,m){if(c=gi(c),m=m==null?0:Fe(Ft(m),292),m&&tf(c)){var x=($t(c)+"e").split("e"),C=o(x[0]+"e"+(+x[1]+m));return x=($t(C)+"e").split("e"),+(x[0]+"e"+(+x[1]-m))}return o(c)}}var Qg=Tr&&1/ca(new Tr([,-0]))[1]==Tt?function(r){return new Tr(r)}:fh;function Yf(r){return function(o){var c=ke(o);return c==Wt?vl(o):c==Re?g_(o):l_(o,r(o))}}function nn(r,o,c,m,x,C,z,P){var M=o&a;if(!M&&typeof r!="function")throw new fi(v);var Z=m?m.length:0;if(Z||(o&=-97,m=x=h),z=z===h?z:ve(Ft(z),0),P=P===h?P:Ft(P),Z-=x?x.length:0,o&S){var j=m,q=x;m=x=h}var ht=M?h:$l(r),gt=[r,o,c,m,x,j,q,C,z,P];if(ht&&pm(gt,ht),r=gt[0],o=gt[1],c=gt[2],m=gt[3],x=gt[4],P=gt[9]=gt[9]===h?M?0:r.length:ve(gt[9]-Z,0),!P&&o&(g|y)&&(o&=-25),!o||o==n)var St=Kg(r,o,c);else o==g||o==y?St=qg(r,o,P):(o==w||o==(n|w))&&!x.length?St=Jg(r,o,c,m):St=Pa.apply(h,gt);var kt=ht?Sf:td;return ed(kt(St,gt),r,o)}function Vf(r,o,c,m){return r===h||Ei(r,Cr[c])&&!Kt.call(m,c)?o:r}function Wf(r,o,c,m,x,C){return oe(r)&&oe(o)&&(C.set(o,r),za(r,o,h,Wf,C),C.delete(o)),r}function tm(r){return Ls(r)?h:r}function $f(r,o,c,m,x,C){var z=c&t,P=r.length,M=o.length;if(P!=M&&!(z&&M>P))return!1;var Z=C.get(r),j=C.get(o);if(Z&&j)return Z==o&&j==r;var q=-1,ht=!0,gt=c&e?new $n:h;for(C.set(r,o),C.set(o,r);++q<P;){var St=r[q],kt=o[q];if(m)var Ut=z?m(kt,St,q,o,r,C):m(St,kt,q,r,o,C);if(Ut!==h){if(Ut)continue;ht=!1;break}if(gt){if(!cl(o,function(Dt,Ot){if(!ws(gt,Ot)&&(St===Dt||x(St,Dt,c,m,C)))return gt.push(Ot)})){ht=!1;break}}else if(!(St===kt||x(St,kt,c,m,C))){ht=!1;break}}return C.delete(r),C.delete(o),ht}function em(r,o,c,m,x,C,z){switch(c){case li:if(r.byteLength!=o.byteLength||r.byteOffset!=o.byteOffset)return!1;r=r.buffer,o=o.buffer;case Gn:return!(r.byteLength!=o.byteLength||!C(new va(r),new va(o)));case ut:case J:case Rt:return Ei(+r,+o);case ct:return r.name==o.name&&r.message==o.message;case oi:case Ji:return r==o+"";case Wt:var P=vl;case Re:var M=m&t;if(P||(P=ca),r.size!=o.size&&!M)return!1;var Z=z.get(r);if(Z)return Z==o;m|=e,z.set(r,o);var j=$f(P(r),P(o),m,x,C,z);return z.delete(r),j;case vr:if(Es)return Es.call(r)==Es.call(o)}return!1}function im(r,o,c,m,x,C){var z=c&t,P=Vl(r),M=P.length,Z=Vl(o),j=Z.length;if(M!=j&&!z)return!1;for(var q=M;q--;){var ht=P[q];if(!(z?ht in o:Kt.call(o,ht)))return!1}var gt=C.get(r),St=C.get(o);if(gt&&St)return gt==o&&St==r;var kt=!0;C.set(r,o),C.set(o,r);for(var Ut=z;++q<M;){ht=P[q];var Dt=r[ht],Ot=o[ht];if(m)var ei=z?m(Ot,Dt,ht,o,r,C):m(Dt,Ot,ht,r,o,C);if(!(ei===h?Dt===Ot||x(Dt,Ot,c,m,C):ei)){kt=!1;break}Ut||(Ut=ht=="constructor")}if(kt&&!Ut){var Oe=r.constructor,ii=o.constructor;Oe!=ii&&"constructor"in r&&"constructor"in o&&!(typeof Oe=="function"&&Oe instanceof Oe&&typeof ii=="function"&&ii instanceof ii)&&(kt=!1)}return C.delete(r),C.delete(o),kt}function rn(r){return Jl(Jf(r,h,od),r+"")}function Vl(r){return df(r,Se,Zl)}function Wl(r){return df(r,We,Xf)}var $l=Ea?function(r){return Ea.get(r)}:fh;function Oa(r){for(var o=r.name+"",c=Ar[o],m=Kt.call(Ar,o)?c.length:0;m--;){var x=c[m],C=x.func;if(C==null||C==r)return x.name}return o}function Fr(r){var o=Kt.call(E,"placeholder")?E:r;return o.placeholder}function xt(){var r=E.iteratee||hh;return r=r===hh?_f:r,arguments.length?r(arguments[0],arguments[1]):r}function Na(r,o){var c=r.__data__;return um(o)?c[typeof o=="string"?"string":"hash"]:c.map}function Xl(r){for(var o=Se(r),c=o.length;c--;){var m=o[c],x=r[m];o[c]=[m,x,Kf(x)]}return o}function jn(r,o){var c=c_(r,o);return pf(c)?c:h}function nm(r){var o=Kt.call(r,Vn),c=r[Vn];try{r[Vn]=h;var m=!0}catch{}var x=ma.call(r);return m&&(o?r[Vn]=c:delete r[Vn]),x}var Zl=xl?function(r){return r==null?[]:(r=Jt(r),wn(xl(r),function(o){return Ju.call(r,o)}))}:dh,Xf=xl?function(r){for(var o=[];r;)xn(o,Zl(r)),r=wa(r);return o}:dh,ke=De;(bl&&ke(new bl(new ArrayBuffer(1)))!=li||bs&&ke(new bs)!=Wt||Sl&&ke(Sl.resolve())!=Mi||Tr&&ke(new Tr)!=Re||Ss&&ke(new Ss)!=jt)&&(ke=function(r){var o=De(r),c=o==_e?r.constructor:h,m=c?Kn(c):"";if(m)switch(m){case O_:return li;case N_:return Wt;case G_:return Mi;case H_:return Re;case Y_:return jt}return o});function rm(r,o,c){for(var m=-1,x=c.length;++m<x;){var C=c[m],z=C.size;switch(C.type){case"drop":r+=z;break;case"dropRight":o-=z;break;case"take":o=Fe(o,r+z);break;case"takeRight":r=ve(r,o-z);break}}return{start:r,end:o}}function sm(r){var o=r.match(oa);return o?o[1].split(fu):[]}function Zf(r,o,c){o=Cn(o,r);for(var m=-1,x=o.length,C=!1;++m<x;){var z=Yi(o[m]);if(!(C=r!=null&&c(r,z)))break;r=r[z]}return C||++m!=x?C:(x=r==null?0:r.length,!!x&&Xa(x)&&sn(z,x)&&(Bt(r)||qn(r)))}function am(r){var o=r.length,c=new r.constructor(o);return o&&typeof r[0]=="string"&&Kt.call(r,"index")&&(c.index=r.index,c.input=r.input),c}function jf(r){return typeof r.constructor=="function"&&!Fs(r)?Ir(wa(r)):{}}function om(r,o,c){var m=r.constructor;switch(o){case Gn:return Gl(r);case ut:case J:return new m(+r);case li:return Vg(r,c);case wr:case Hn:case _s:case gs:case ms:case Oi:case ys:case vn:case vs:return zf(r,c);case Wt:return new m;case Rt:case Ji:return new m(r);case oi:return Wg(r);case Re:return new m;case vr:return $g(r)}}function lm(r,o){var c=o.length;if(!c)return r;var m=c-1;return o[m]=(c>1?"& ":"")+o[m],o=o.join(c>2?", ":" "),r.replace(Ni,`{
/* [wrapped with `+o+`] */
`)}function hm(r){return Bt(r)||qn(r)||!!(Qu&&r&&r[Qu])}function sn(r,o){var c=typeof r;return o=o??Nt,!!o&&(c=="number"||c!="symbol"&&xp.test(r))&&r>-1&&r%1==0&&r<o}function Me(r,o,c){if(!oe(c))return!1;var m=typeof o;return(m=="number"?Ve(c)&&sn(o,c.length):m=="string"&&o in c)?Ei(c[o],r):!1}function jl(r,o){if(Bt(r))return!1;var c=typeof r;return c=="number"||c=="symbol"||c=="boolean"||r==null||ti(r)?!0:qt.test(r)||!At.test(r)||o!=null&&r in Jt(o)}function um(r){var o=typeof r;return o=="string"||o=="number"||o=="symbol"||o=="boolean"?r!=="__proto__":r===null}function Kl(r){var o=Oa(r),c=E[o];if(typeof c!="function"||!(o in Mt.prototype))return!1;if(r===c)return!0;var m=$l(c);return!!m&&r===m[0]}function fm(r){return!!ju&&ju in r}var dm=_a?an:ch;function Fs(r){var o=r&&r.constructor,c=typeof o=="function"&&o.prototype||Cr;return r===c}function Kf(r){return r===r&&!oe(r)}function qf(r,o){return function(c){return c==null?!1:c[r]===o&&(o!==h||r in Jt(c))}}function cm(r){var o=Wa(r,function(m){return c.size===A&&c.clear(),m}),c=o.cache;return o}function pm(r,o){var c=r[1],m=o[1],x=c|m,C=x<(n|a|L),z=m==L&&c==g||m==L&&c==k&&r[7].length<=o[8]||m==(L|k)&&o[7].length<=o[8]&&c==g;if(!(C||z))return r;m&n&&(r[2]=o[2],x|=c&n?0:d);var P=o[3];if(P){var M=r[3];r[3]=M?kf(M,P,o[4]):P,r[4]=M?bn(r[3],I):o[4]}return P=o[5],P&&(M=r[5],r[5]=M?Lf(M,P,o[6]):P,r[6]=M?bn(r[5],I):o[6]),P=o[7],P&&(r[7]=P),m&L&&(r[8]=r[8]==null?o[8]:Fe(r[8],o[8])),r[9]==null&&(r[9]=o[9]),r[0]=o[0],r[1]=x,r}function _m(r){var o=[];if(r!=null)for(var c in Jt(r))o.push(c);return o}function gm(r){return ma.call(r)}function Jf(r,o,c){return o=ve(o===h?r.length-1:o,0),function(){for(var m=arguments,x=-1,C=ve(m.length-o,0),z=H(C);++x<C;)z[x]=m[o+x];x=-1;for(var P=H(o+1);++x<o;)P[x]=m[x];return P[o]=c(z),qe(r,this,P)}}function Qf(r,o){return o.length<2?r:Zn(r,pi(o,0,-1))}function mm(r,o){for(var c=r.length,m=Fe(o.length,c),x=Ye(r);m--;){var C=o[m];r[m]=sn(C,c)?x[C]:h}return r}function ql(r,o){if(!(o==="constructor"&&typeof r[o]=="function")&&o!="__proto__")return r[o]}var td=id(Sf),ks=F_||function(r,o){return Ce.setTimeout(r,o)},Jl=id(Ng);function ed(r,o,c){var m=o+"";return Jl(r,lm(m,ym(sm(m),c)))}function id(r){var o=0,c=0;return function(){var m=R_(),x=st-(m-c);if(c=m,x>0){if(++o>=lt)return arguments[0]}else o=0;return r.apply(h,arguments)}}function Ga(r,o){var c=-1,m=r.length,x=m-1;for(o=o===h?m:o;++c<o;){var C=Ll(c,x),z=r[C];r[C]=r[c],r[c]=z}return r.length=o,r}var nd=cm(function(r){var o=[];return r.charCodeAt(0)===46&&o.push(""),r.replace(ge,function(c,m,x,C){o.push(x?C.replace(_p,"$1"):m||c)}),o});function Yi(r){if(typeof r=="string"||ti(r))return r;var o=r+"";return o=="0"&&1/r==-1/0?"-0":o}function Kn(r){if(r!=null){try{return ga.call(r)}catch{}try{return r+""}catch{}}return""}function ym(r,o){return ui(Ht,function(c){var m="_."+c[0];o&c[1]&&!fa(r,m)&&r.push(m)}),r.sort()}function rd(r){if(r instanceof Mt)return r.clone();var o=new di(r.__wrapped__,r.__chain__);return o.__actions__=Ye(r.__actions__),o.__index__=r.__index__,o.__values__=r.__values__,o}function vm(r,o,c){(c?Me(r,o,c):o===h)?o=1:o=ve(Ft(o),0);var m=r==null?0:r.length;if(!m||o<1)return[];for(var x=0,C=0,z=H(Sa(m/o));x<m;)z[C++]=pi(r,x,x+=o);return z}function wm(r){for(var o=-1,c=r==null?0:r.length,m=0,x=[];++o<c;){var C=r[o];C&&(x[m++]=C)}return x}function xm(){var r=arguments.length;if(!r)return[];for(var o=H(r-1),c=arguments[0],m=r;m--;)o[m-1]=arguments[m];return xn(Bt(c)?Ye(c):[c],Te(o,1))}var bm=Pt(function(r,o){return ce(r)?Ts(r,Te(o,1,ce,!0)):[]}),Sm=Pt(function(r,o){var c=_i(o);return ce(c)&&(c=h),ce(r)?Ts(r,Te(o,1,ce,!0),xt(c,2)):[]}),Um=Pt(function(r,o){var c=_i(o);return ce(c)&&(c=h),ce(r)?Ts(r,Te(o,1,ce,!0),h,c):[]});function Em(r,o,c){var m=r==null?0:r.length;return m?(o=c||o===h?1:Ft(o),pi(r,o<0?0:o,m)):[]}function Cm(r,o,c){var m=r==null?0:r.length;return m?(o=c||o===h?1:Ft(o),o=m-o,pi(r,0,o<0?0:o)):[]}function Tm(r,o){return r&&r.length?ka(r,xt(o,3),!0,!0):[]}function Am(r,o){return r&&r.length?ka(r,xt(o,3),!0):[]}function Im(r,o,c,m){var x=r==null?0:r.length;return x?(c&&typeof c!="number"&&Me(r,o,c)&&(c=0,m=x),xg(r,o,c,m)):[]}function sd(r,o,c){var m=r==null?0:r.length;if(!m)return-1;var x=c==null?0:Ft(c);return x<0&&(x=ve(m+x,0)),da(r,xt(o,3),x)}function ad(r,o,c){var m=r==null?0:r.length;if(!m)return-1;var x=m-1;return c!==h&&(x=Ft(c),x=c<0?ve(m+x,0):Fe(x,m-1)),da(r,xt(o,3),x,!0)}function od(r){var o=r==null?0:r.length;return o?Te(r,1):[]}function Bm(r){var o=r==null?0:r.length;return o?Te(r,Tt):[]}function zm(r,o){var c=r==null?0:r.length;return c?(o=o===h?1:Ft(o),Te(r,o)):[]}function Fm(r){for(var o=-1,c=r==null?0:r.length,m={};++o<c;){var x=r[o];m[x[0]]=x[1]}return m}function ld(r){return r&&r.length?r[0]:h}function km(r,o,c){var m=r==null?0:r.length;if(!m)return-1;var x=c==null?0:Ft(c);return x<0&&(x=ve(m+x,0)),br(r,o,x)}function Lm(r){var o=r==null?0:r.length;return o?pi(r,0,-1):[]}var Pm=Pt(function(r){var o=re(r,Ol);return o.length&&o[0]===r[0]?Il(o):[]}),Rm=Pt(function(r){var o=_i(r),c=re(r,Ol);return o===_i(c)?o=h:c.pop(),c.length&&c[0]===r[0]?Il(c,xt(o,2)):[]}),Dm=Pt(function(r){var o=_i(r),c=re(r,Ol);return o=typeof o=="function"?o:h,o&&c.pop(),c.length&&c[0]===r[0]?Il(c,h,o):[]});function Mm(r,o){return r==null?"":L_.call(r,o)}function _i(r){var o=r==null?0:r.length;return o?r[o-1]:h}function Om(r,o,c){var m=r==null?0:r.length;if(!m)return-1;var x=m;return c!==h&&(x=Ft(c),x=x<0?ve(m+x,0):Fe(x,m-1)),o===o?y_(r,o,x):da(r,Gu,x,!0)}function Nm(r,o){return r&&r.length?vf(r,Ft(o)):h}var Gm=Pt(hd);function hd(r,o){return r&&r.length&&o&&o.length?kl(r,o):r}function Hm(r,o,c){return r&&r.length&&o&&o.length?kl(r,o,xt(c,2)):r}function Ym(r,o,c){return r&&r.length&&o&&o.length?kl(r,o,h,c):r}var Vm=rn(function(r,o){var c=r==null?0:r.length,m=El(r,o);return bf(r,re(o,function(x){return sn(x,c)?+x:x}).sort(Ff)),m});function Wm(r,o){var c=[];if(!(r&&r.length))return c;var m=-1,x=[],C=r.length;for(o=xt(o,3);++m<C;){var z=r[m];o(z,m,r)&&(c.push(z),x.push(m))}return bf(r,x),c}function Ql(r){return r==null?r:M_.call(r)}function $m(r,o,c){var m=r==null?0:r.length;return m?(c&&typeof c!="number"&&Me(r,o,c)?(o=0,c=m):(o=o==null?0:Ft(o),c=c===h?m:Ft(c)),pi(r,o,c)):[]}function Xm(r,o){return Fa(r,o)}function Zm(r,o,c){return Rl(r,o,xt(c,2))}function jm(r,o){var c=r==null?0:r.length;if(c){var m=Fa(r,o);if(m<c&&Ei(r[m],o))return m}return-1}function Km(r,o){return Fa(r,o,!0)}function qm(r,o,c){return Rl(r,o,xt(c,2),!0)}function Jm(r,o){var c=r==null?0:r.length;if(c){var m=Fa(r,o,!0)-1;if(Ei(r[m],o))return m}return-1}function Qm(r){return r&&r.length?Uf(r):[]}function ty(r,o){return r&&r.length?Uf(r,xt(o,2)):[]}function ey(r){var o=r==null?0:r.length;return o?pi(r,1,o):[]}function iy(r,o,c){return r&&r.length?(o=c||o===h?1:Ft(o),pi(r,0,o<0?0:o)):[]}function ny(r,o,c){var m=r==null?0:r.length;return m?(o=c||o===h?1:Ft(o),o=m-o,pi(r,o<0?0:o,m)):[]}function ry(r,o){return r&&r.length?ka(r,xt(o,3),!1,!0):[]}function sy(r,o){return r&&r.length?ka(r,xt(o,3)):[]}var ay=Pt(function(r){return En(Te(r,1,ce,!0))}),oy=Pt(function(r){var o=_i(r);return ce(o)&&(o=h),En(Te(r,1,ce,!0),xt(o,2))}),ly=Pt(function(r){var o=_i(r);return o=typeof o=="function"?o:h,En(Te(r,1,ce,!0),h,o)});function hy(r){return r&&r.length?En(r):[]}function uy(r,o){return r&&r.length?En(r,xt(o,2)):[]}function fy(r,o){return o=typeof o=="function"?o:h,r&&r.length?En(r,h,o):[]}function th(r){if(!(r&&r.length))return[];var o=0;return r=wn(r,function(c){if(ce(c))return o=ve(c.length,o),!0}),ml(o,function(c){return re(r,pl(c))})}function ud(r,o){if(!(r&&r.length))return[];var c=th(r);return o==null?c:re(c,function(m){return qe(o,h,m)})}var dy=Pt(function(r,o){return ce(r)?Ts(r,o):[]}),cy=Pt(function(r){return Ml(wn(r,ce))}),py=Pt(function(r){var o=_i(r);return ce(o)&&(o=h),Ml(wn(r,ce),xt(o,2))}),_y=Pt(function(r){var o=_i(r);return o=typeof o=="function"?o:h,Ml(wn(r,ce),h,o)}),gy=Pt(th);function my(r,o){return Af(r||[],o||[],Cs)}function yy(r,o){return Af(r||[],o||[],Bs)}var vy=Pt(function(r){var o=r.length,c=o>1?r[o-1]:h;return c=typeof c=="function"?(r.pop(),c):h,ud(r,c)});function fd(r){var o=E(r);return o.__chain__=!0,o}function wy(r,o){return o(r),r}function Ha(r,o){return o(r)}var xy=rn(function(r){var o=r.length,c=o?r[0]:0,m=this.__wrapped__,x=function(C){return El(C,r)};return o>1||this.__actions__.length||!(m instanceof Mt)||!sn(c)?this.thru(x):(m=m.slice(c,+c+(o?1:0)),m.__actions__.push({func:Ha,args:[x],thisArg:h}),new di(m,this.__chain__).thru(function(C){return o&&!C.length&&C.push(h),C}))});function by(){return fd(this)}function Sy(){return new di(this.value(),this.__chain__)}function Uy(){this.__values__===h&&(this.__values__=Ed(this.value()));var r=this.__index__>=this.__values__.length,o=r?h:this.__values__[this.__index__++];return{done:r,value:o}}function Ey(){return this}function Cy(r){for(var o,c=this;c instanceof Ta;){var m=rd(c);m.__index__=0,m.__values__=h,o?x.__wrapped__=m:o=m;var x=m;c=c.__wrapped__}return x.__wrapped__=r,o}function Ty(){var r=this.__wrapped__;if(r instanceof Mt){var o=r;return this.__actions__.length&&(o=new Mt(this)),o=o.reverse(),o.__actions__.push({func:Ha,args:[Ql],thisArg:h}),new di(o,this.__chain__)}return this.thru(Ql)}function Ay(){return Tf(this.__wrapped__,this.__actions__)}var Iy=La(function(r,o,c){Kt.call(r,c)?++r[c]:en(r,c,1)});function By(r,o,c){var m=Bt(r)?Ou:wg;return c&&Me(r,o,c)&&(o=h),m(r,xt(o,3))}function zy(r,o){var c=Bt(r)?wn:uf;return c(r,xt(o,3))}var Fy=Mf(sd),ky=Mf(ad);function Ly(r,o){return Te(Ya(r,o),1)}function Py(r,o){return Te(Ya(r,o),Tt)}function Ry(r,o,c){return c=c===h?1:Ft(c),Te(Ya(r,o),c)}function dd(r,o){var c=Bt(r)?ui:Un;return c(r,xt(o,3))}function cd(r,o){var c=Bt(r)?e_:hf;return c(r,xt(o,3))}var Dy=La(function(r,o,c){Kt.call(r,c)?r[c].push(o):en(r,c,[o])});function My(r,o,c,m){r=Ve(r)?r:Lr(r),c=c&&!m?Ft(c):0;var x=r.length;return c<0&&(c=ve(x+c,0)),Za(r)?c<=x&&r.indexOf(o,c)>-1:!!x&&br(r,o,c)>-1}var Oy=Pt(function(r,o,c){var m=-1,x=typeof o=="function",C=Ve(r)?H(r.length):[];return Un(r,function(z){C[++m]=x?qe(o,z,c):As(z,o,c)}),C}),Ny=La(function(r,o,c){en(r,c,o)});function Ya(r,o){var c=Bt(r)?re:gf;return c(r,xt(o,3))}function Gy(r,o,c,m){return r==null?[]:(Bt(o)||(o=o==null?[]:[o]),c=m?h:c,Bt(c)||(c=c==null?[]:[c]),wf(r,o,c))}var Hy=La(function(r,o,c){r[c?0:1].push(o)},function(){return[[],[]]});function Yy(r,o,c){var m=Bt(r)?dl:Yu,x=arguments.length<3;return m(r,xt(o,4),c,x,Un)}function Vy(r,o,c){var m=Bt(r)?i_:Yu,x=arguments.length<3;return m(r,xt(o,4),c,x,hf)}function Wy(r,o){var c=Bt(r)?wn:uf;return c(r,$a(xt(o,3)))}function $y(r){var o=Bt(r)?sf:Mg;return o(r)}function Xy(r,o,c){(c?Me(r,o,c):o===h)?o=1:o=Ft(o);var m=Bt(r)?_g:Og;return m(r,o)}function Zy(r){var o=Bt(r)?gg:Gg;return o(r)}function jy(r){if(r==null)return 0;if(Ve(r))return Za(r)?Ur(r):r.length;var o=ke(r);return o==Wt||o==Re?r.size:zl(r).length}function Ky(r,o,c){var m=Bt(r)?cl:Hg;return c&&Me(r,o,c)&&(o=h),m(r,xt(o,3))}var qy=Pt(function(r,o){if(r==null)return[];var c=o.length;return c>1&&Me(r,o[0],o[1])?o=[]:c>2&&Me(o[0],o[1],o[2])&&(o=[o[0]]),wf(r,Te(o,1),[])}),Va=z_||function(){return Ce.Date.now()};function Jy(r,o){if(typeof o!="function")throw new fi(v);return r=Ft(r),function(){if(--r<1)return o.apply(this,arguments)}}function pd(r,o,c){return o=c?h:o,o=r&&o==null?r.length:o,nn(r,L,h,h,h,h,o)}function _d(r,o){var c;if(typeof o!="function")throw new fi(v);return r=Ft(r),function(){return--r>0&&(c=o.apply(this,arguments)),r<=1&&(o=h),c}}var eh=Pt(function(r,o,c){var m=n;if(c.length){var x=bn(c,Fr(eh));m|=w}return nn(r,m,o,c,x)}),gd=Pt(function(r,o,c){var m=n|a;if(c.length){var x=bn(c,Fr(gd));m|=w}return nn(o,m,r,c,x)});function md(r,o,c){o=c?h:o;var m=nn(r,g,h,h,h,h,h,o);return m.placeholder=md.placeholder,m}function yd(r,o,c){o=c?h:o;var m=nn(r,y,h,h,h,h,h,o);return m.placeholder=yd.placeholder,m}function vd(r,o,c){var m,x,C,z,P,M,Z=0,j=!1,q=!1,ht=!0;if(typeof r!="function")throw new fi(v);o=gi(o)||0,oe(c)&&(j=!!c.leading,q="maxWait"in c,C=q?ve(gi(c.maxWait)||0,o):C,ht="trailing"in c?!!c.trailing:ht);function gt(pe){var Ci=m,ln=x;return m=x=h,Z=pe,z=r.apply(ln,Ci),z}function St(pe){return Z=pe,P=ks(Dt,o),j?gt(pe):z}function kt(pe){var Ci=pe-M,ln=pe-Z,Md=o-Ci;return q?Fe(Md,C-ln):Md}function Ut(pe){var Ci=pe-M,ln=pe-Z;return M===h||Ci>=o||Ci<0||q&&ln>=C}function Dt(){var pe=Va();if(Ut(pe))return Ot(pe);P=ks(Dt,kt(pe))}function Ot(pe){return P=h,ht&&m?gt(pe):(m=x=h,z)}function ei(){P!==h&&If(P),Z=0,m=M=x=P=h}function Oe(){return P===h?z:Ot(Va())}function ii(){var pe=Va(),Ci=Ut(pe);if(m=arguments,x=this,M=pe,Ci){if(P===h)return St(M);if(q)return If(P),P=ks(Dt,o),gt(M)}return P===h&&(P=ks(Dt,o)),z}return ii.cancel=ei,ii.flush=Oe,ii}var Qy=Pt(function(r,o){return lf(r,1,o)}),tv=Pt(function(r,o,c){return lf(r,gi(o)||0,c)});function ev(r){return nn(r,F)}function Wa(r,o){if(typeof r!="function"||o!=null&&typeof o!="function")throw new fi(v);var c=function(){var m=arguments,x=o?o.apply(this,m):m[0],C=c.cache;if(C.has(x))return C.get(x);var z=r.apply(this,m);return c.cache=C.set(x,z)||C,z};return c.cache=new(Wa.Cache||tn),c}Wa.Cache=tn;function $a(r){if(typeof r!="function")throw new fi(v);return function(){var o=arguments;switch(o.length){case 0:return!r.call(this);case 1:return!r.call(this,o[0]);case 2:return!r.call(this,o[0],o[1]);case 3:return!r.call(this,o[0],o[1],o[2])}return!r.apply(this,o)}}function iv(r){return _d(2,r)}var nv=Yg(function(r,o){o=o.length==1&&Bt(o[0])?re(o[0],Je(xt())):re(Te(o,1),Je(xt()));var c=o.length;return Pt(function(m){for(var x=-1,C=Fe(m.length,c);++x<C;)m[x]=o[x].call(this,m[x]);return qe(r,this,m)})}),ih=Pt(function(r,o){var c=bn(o,Fr(ih));return nn(r,w,h,o,c)}),wd=Pt(function(r,o){var c=bn(o,Fr(wd));return nn(r,S,h,o,c)}),rv=rn(function(r,o){return nn(r,k,h,h,h,o)});function sv(r,o){if(typeof r!="function")throw new fi(v);return o=o===h?o:Ft(o),Pt(r,o)}function av(r,o){if(typeof r!="function")throw new fi(v);return o=o==null?0:ve(Ft(o),0),Pt(function(c){var m=c[o],x=Tn(c,0,o);return m&&xn(x,m),qe(r,this,x)})}function ov(r,o,c){var m=!0,x=!0;if(typeof r!="function")throw new fi(v);return oe(c)&&(m="leading"in c?!!c.leading:m,x="trailing"in c?!!c.trailing:x),vd(r,o,{leading:m,maxWait:o,trailing:x})}function lv(r){return pd(r,1)}function hv(r,o){return ih(Nl(o),r)}function uv(){if(!arguments.length)return[];var r=arguments[0];return Bt(r)?r:[r]}function fv(r){return ci(r,N)}function dv(r,o){return o=typeof o=="function"?o:h,ci(r,N,o)}function cv(r){return ci(r,B|N)}function pv(r,o){return o=typeof o=="function"?o:h,ci(r,B|N,o)}function _v(r,o){return o==null||of(r,o,Se(o))}function Ei(r,o){return r===o||r!==r&&o!==o}var gv=Ma(Al),mv=Ma(function(r,o){return r>=o}),qn=cf(function(){return arguments}())?cf:function(r){return ue(r)&&Kt.call(r,"callee")&&!Ju.call(r,"callee")},Bt=H.isArray,yv=ku?Je(ku):Cg;function Ve(r){return r!=null&&Xa(r.length)&&!an(r)}function ce(r){return ue(r)&&Ve(r)}function vv(r){return r===!0||r===!1||ue(r)&&De(r)==ut}var An=k_||ch,wv=Lu?Je(Lu):Tg;function xv(r){return ue(r)&&r.nodeType===1&&!Ls(r)}function bv(r){if(r==null)return!0;if(Ve(r)&&(Bt(r)||typeof r=="string"||typeof r.splice=="function"||An(r)||kr(r)||qn(r)))return!r.length;var o=ke(r);if(o==Wt||o==Re)return!r.size;if(Fs(r))return!zl(r).length;for(var c in r)if(Kt.call(r,c))return!1;return!0}function Sv(r,o){return Is(r,o)}function Uv(r,o,c){c=typeof c=="function"?c:h;var m=c?c(r,o):h;return m===h?Is(r,o,h,c):!!m}function nh(r){if(!ue(r))return!1;var o=De(r);return o==ct||o==ot||typeof r.message=="string"&&typeof r.name=="string"&&!Ls(r)}function Ev(r){return typeof r=="number"&&tf(r)}function an(r){if(!oe(r))return!1;var o=De(r);return o==ne||o==Zt||o==He||o==Jo}function xd(r){return typeof r=="number"&&r==Ft(r)}function Xa(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Nt}function oe(r){var o=typeof r;return r!=null&&(o=="object"||o=="function")}function ue(r){return r!=null&&typeof r=="object"}var bd=Pu?Je(Pu):Ig;function Cv(r,o){return r===o||Bl(r,o,Xl(o))}function Tv(r,o,c){return c=typeof c=="function"?c:h,Bl(r,o,Xl(o),c)}function Av(r){return Sd(r)&&r!=+r}function Iv(r){if(dm(r))throw new It(_);return pf(r)}function Bv(r){return r===null}function zv(r){return r==null}function Sd(r){return typeof r=="number"||ue(r)&&De(r)==Rt}function Ls(r){if(!ue(r)||De(r)!=_e)return!1;var o=wa(r);if(o===null)return!0;var c=Kt.call(o,"constructor")&&o.constructor;return typeof c=="function"&&c instanceof c&&ga.call(c)==T_}var rh=Ru?Je(Ru):Bg;function Fv(r){return xd(r)&&r>=-9007199254740991&&r<=Nt}var Ud=Du?Je(Du):zg;function Za(r){return typeof r=="string"||!Bt(r)&&ue(r)&&De(r)==Ji}function ti(r){return typeof r=="symbol"||ue(r)&&De(r)==vr}var kr=Mu?Je(Mu):Fg;function kv(r){return r===h}function Lv(r){return ue(r)&&ke(r)==jt}function Pv(r){return ue(r)&&De(r)==tl}var Rv=Ma(Fl),Dv=Ma(function(r,o){return r<=o});function Ed(r){if(!r)return[];if(Ve(r))return Za(r)?Si(r):Ye(r);if(xs&&r[xs])return __(r[xs]());var o=ke(r),c=o==Wt?vl:o==Re?ca:Lr;return c(r)}function on(r){if(!r)return r===0?r:0;if(r=gi(r),r===Tt||r===-1/0){var o=r<0?-1:1;return o*it}return r===r?r:0}function Ft(r){var o=on(r),c=o%1;return o===o?c?o-c:o:0}function Cd(r){return r?Xn(Ft(r),0,K):0}function gi(r){if(typeof r=="number")return r;if(ti(r))return Y;if(oe(r)){var o=typeof r.valueOf=="function"?r.valueOf():r;r=oe(o)?o+"":o}if(typeof r!="string")return r===0?r:+r;r=Vu(r);var c=yp.test(r);return c||wp.test(r)?Jp(r.slice(2),c?2:8):mp.test(r)?Y:+r}function Td(r){return Hi(r,We(r))}function Mv(r){return r?Xn(Ft(r),-9007199254740991,Nt):r===0?r:0}function $t(r){return r==null?"":Qe(r)}var Ov=Br(function(r,o){if(Fs(o)||Ve(o)){Hi(o,Se(o),r);return}for(var c in o)Kt.call(o,c)&&Cs(r,c,o[c])}),Ad=Br(function(r,o){Hi(o,We(o),r)}),ja=Br(function(r,o,c,m){Hi(o,We(o),r,m)}),Nv=Br(function(r,o,c,m){Hi(o,Se(o),r,m)}),Gv=rn(El);function Hv(r,o){var c=Ir(r);return o==null?c:af(c,o)}var Yv=Pt(function(r,o){r=Jt(r);var c=-1,m=o.length,x=m>2?o[2]:h;for(x&&Me(o[0],o[1],x)&&(m=1);++c<m;)for(var C=o[c],z=We(C),P=-1,M=z.length;++P<M;){var Z=z[P],j=r[Z];(j===h||Ei(j,Cr[Z])&&!Kt.call(r,Z))&&(r[Z]=C[Z])}return r}),Vv=Pt(function(r){return r.push(h,Wf),qe(Id,h,r)});function Wv(r,o){return Nu(r,xt(o,3),Gi)}function $v(r,o){return Nu(r,xt(o,3),Tl)}function Xv(r,o){return r==null?r:Cl(r,xt(o,3),We)}function Zv(r,o){return r==null?r:ff(r,xt(o,3),We)}function jv(r,o){return r&&Gi(r,xt(o,3))}function Kv(r,o){return r&&Tl(r,xt(o,3))}function qv(r){return r==null?[]:Ba(r,Se(r))}function Jv(r){return r==null?[]:Ba(r,We(r))}function sh(r,o,c){var m=r==null?h:Zn(r,o);return m===h?c:m}function Qv(r,o){return r!=null&&Zf(r,o,bg)}function ah(r,o){return r!=null&&Zf(r,o,Sg)}var t0=Nf(function(r,o,c){o!=null&&typeof o.toString!="function"&&(o=ma.call(o)),r[o]=c},lh($e)),e0=Nf(function(r,o,c){o!=null&&typeof o.toString!="function"&&(o=ma.call(o)),Kt.call(r,o)?r[o].push(c):r[o]=[c]},xt),i0=Pt(As);function Se(r){return Ve(r)?rf(r):zl(r)}function We(r){return Ve(r)?rf(r,!0):kg(r)}function n0(r,o){var c={};return o=xt(o,3),Gi(r,function(m,x,C){en(c,o(m,x,C),m)}),c}function r0(r,o){var c={};return o=xt(o,3),Gi(r,function(m,x,C){en(c,x,o(m,x,C))}),c}var s0=Br(function(r,o,c){za(r,o,c)}),Id=Br(function(r,o,c,m){za(r,o,c,m)}),a0=rn(function(r,o){var c={};if(r==null)return c;var m=!1;o=re(o,function(C){return C=Cn(C,r),m||(m=C.length>1),C}),Hi(r,Wl(r),c),m&&(c=ci(c,B|U|N,tm));for(var x=o.length;x--;)Dl(c,o[x]);return c});function o0(r,o){return Bd(r,$a(xt(o)))}var l0=rn(function(r,o){return r==null?{}:Pg(r,o)});function Bd(r,o){if(r==null)return{};var c=re(Wl(r),function(m){return[m]});return o=xt(o),xf(r,c,function(m,x){return o(m,x[0])})}function h0(r,o,c){o=Cn(o,r);var m=-1,x=o.length;for(x||(x=1,r=h);++m<x;){var C=r==null?h:r[Yi(o[m])];C===h&&(m=x,C=c),r=an(C)?C.call(r):C}return r}function u0(r,o,c){return r==null?r:Bs(r,o,c)}function f0(r,o,c,m){return m=typeof m=="function"?m:h,r==null?r:Bs(r,o,c,m)}var zd=Yf(Se),Fd=Yf(We);function d0(r,o,c){var m=Bt(r),x=m||An(r)||kr(r);if(o=xt(o,4),c==null){var C=r&&r.constructor;x?c=m?new C:[]:oe(r)?c=an(C)?Ir(wa(r)):{}:c={}}return(x?ui:Gi)(r,function(z,P,M){return o(c,z,P,M)}),c}function c0(r,o){return r==null?!0:Dl(r,o)}function p0(r,o,c){return r==null?r:Cf(r,o,Nl(c))}function _0(r,o,c,m){return m=typeof m=="function"?m:h,r==null?r:Cf(r,o,Nl(c),m)}function Lr(r){return r==null?[]:yl(r,Se(r))}function g0(r){return r==null?[]:yl(r,We(r))}function m0(r,o,c){return c===h&&(c=o,o=h),c!==h&&(c=gi(c),c=c===c?c:0),o!==h&&(o=gi(o),o=o===o?o:0),Xn(gi(r),o,c)}function y0(r,o,c){return o=on(o),c===h?(c=o,o=0):c=on(c),r=gi(r),Ug(r,o,c)}function v0(r,o,c){if(c&&typeof c!="boolean"&&Me(r,o,c)&&(o=c=h),c===h&&(typeof o=="boolean"?(c=o,o=h):typeof r=="boolean"&&(c=r,r=h)),r===h&&o===h?(r=0,o=1):(r=on(r),o===h?(o=r,r=0):o=on(o)),r>o){var m=r;r=o,o=m}if(c||r%1||o%1){var x=ef();return Fe(r+x*(o-r+qp("1e-"+((x+"").length-1))),o)}return Ll(r,o)}var w0=zr(function(r,o,c){return o=o.toLowerCase(),r+(c?kd(o):o)});function kd(r){return oh($t(r).toLowerCase())}function Ld(r){return r=$t(r),r&&r.replace(bp,u_).replace(Gp,"")}function x0(r,o,c){r=$t(r),o=Qe(o);var m=r.length;c=c===h?m:Xn(Ft(c),0,m);var x=c;return c-=o.length,c>=0&&r.slice(c,x)==o}function b0(r){return r=$t(r),r&&vt.test(r)?r.replace($,f_):r}function S0(r){return r=$t(r),r&&se.test(r)?r.replace(me,"\\$&"):r}var U0=zr(function(r,o,c){return r+(c?"-":"")+o.toLowerCase()}),E0=zr(function(r,o,c){return r+(c?" ":"")+o.toLowerCase()}),C0=Df("toLowerCase");function T0(r,o,c){r=$t(r),o=Ft(o);var m=o?Ur(r):0;if(!o||m>=o)return r;var x=(o-m)/2;return Da(Ua(x),c)+r+Da(Sa(x),c)}function A0(r,o,c){r=$t(r),o=Ft(o);var m=o?Ur(r):0;return o&&m<o?r+Da(o-m,c):r}function I0(r,o,c){r=$t(r),o=Ft(o);var m=o?Ur(r):0;return o&&m<o?Da(o-m,c)+r:r}function B0(r,o,c){return c||o==null?o=0:o&&(o=+o),D_($t(r).replace(ae,""),o||0)}function z0(r,o,c){return(c?Me(r,o,c):o===h)?o=1:o=Ft(o),Pl($t(r),o)}function F0(){var r=arguments,o=$t(r[0]);return r.length<3?o:o.replace(r[1],r[2])}var k0=zr(function(r,o,c){return r+(c?"_":"")+o.toLowerCase()});function L0(r,o,c){return c&&typeof c!="number"&&Me(r,o,c)&&(o=c=h),c=c===h?K:c>>>0,c?(r=$t(r),r&&(typeof o=="string"||o!=null&&!rh(o))&&(o=Qe(o),!o&&Sr(r))?Tn(Si(r),0,c):r.split(o,c)):[]}var P0=zr(function(r,o,c){return r+(c?" ":"")+oh(o)});function R0(r,o,c){return r=$t(r),c=c==null?0:Xn(Ft(c),0,r.length),o=Qe(o),r.slice(c,c+o.length)==o}function D0(r,o,c){var m=E.templateSettings;c&&Me(r,o,c)&&(o=h),r=$t(r),o=ja({},o,m,Vf);var x=ja({},o.imports,m.imports,Vf),C=Se(x),z=yl(x,C),P,M,Z=0,j=o.interpolate||la,q="__p += '",ht=wl((o.escape||la).source+"|"+j.source+"|"+(j===wt?gp:la).source+"|"+(o.evaluate||la).source+"|$","g"),gt="//# sourceURL="+(Kt.call(o,"sourceURL")?(o.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++$p+"]")+`
`;r.replace(ht,function(Ut,Dt,Ot,ei,Oe,ii){return Ot||(Ot=ei),q+=r.slice(Z,ii).replace(Sp,d_),Dt&&(P=!0,q+=`' +
__e(`+Dt+`) +
'`),Oe&&(M=!0,q+=`';
`+Oe+`;
__p += '`),Ot&&(q+=`' +
((__t = (`+Ot+`)) == null ? '' : __t) +
'`),Z=ii+Ut.length,Ut}),q+=`';
`;var St=Kt.call(o,"variable")&&o.variable;if(!St)q=`with (obj) {
`+q+`
}
`;else if(pp.test(St))throw new It(s);q=(M?q.replace(el,""):q).replace(il,"$1").replace(nl,"$1;"),q="function("+(St||"obj")+`) {
`+(St?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(P?", __e = _.escape":"")+(M?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+q+`return __p
}`;var kt=Rd(function(){return Vt(C,gt+"return "+q).apply(h,z)});if(kt.source=q,nh(kt))throw kt;return kt}function M0(r){return $t(r).toLowerCase()}function O0(r){return $t(r).toUpperCase()}function N0(r,o,c){if(r=$t(r),r&&(c||o===h))return Vu(r);if(!r||!(o=Qe(o)))return r;var m=Si(r),x=Si(o),C=Wu(m,x),z=$u(m,x)+1;return Tn(m,C,z).join("")}function G0(r,o,c){if(r=$t(r),r&&(c||o===h))return r.slice(0,Zu(r)+1);if(!r||!(o=Qe(o)))return r;var m=Si(r),x=$u(m,Si(o))+1;return Tn(m,0,x).join("")}function H0(r,o,c){if(r=$t(r),r&&(c||o===h))return r.replace(ae,"");if(!r||!(o=Qe(o)))return r;var m=Si(r),x=Wu(m,Si(o));return Tn(m,x).join("")}function Y0(r,o){var c=G,m=R;if(oe(o)){var x="separator"in o?o.separator:x;c="length"in o?Ft(o.length):c,m="omission"in o?Qe(o.omission):m}r=$t(r);var C=r.length;if(Sr(r)){var z=Si(r);C=z.length}if(c>=C)return r;var P=c-Ur(m);if(P<1)return m;var M=z?Tn(z,0,P).join(""):r.slice(0,P);if(x===h)return M+m;if(z&&(P+=M.length-P),rh(x)){if(r.slice(P).search(x)){var Z,j=M;for(x.global||(x=wl(x.source,$t(du.exec(x))+"g")),x.lastIndex=0;Z=x.exec(j);)var q=Z.index;M=M.slice(0,q===h?P:q)}}else if(r.indexOf(Qe(x),P)!=P){var ht=M.lastIndexOf(x);ht>-1&&(M=M.slice(0,ht))}return M+m}function V0(r){return r=$t(r),r&&nt.test(r)?r.replace(aa,v_):r}var W0=zr(function(r,o,c){return r+(c?" ":"")+o.toUpperCase()}),oh=Df("toUpperCase");function Pd(r,o,c){return r=$t(r),o=c?h:o,o===h?p_(r)?b_(r):s_(r):r.match(o)||[]}var Rd=Pt(function(r,o){try{return qe(r,h,o)}catch(c){return nh(c)?c:new It(c)}}),$0=rn(function(r,o){return ui(o,function(c){c=Yi(c),en(r,c,eh(r[c],r))}),r});function X0(r){var o=r==null?0:r.length,c=xt();return r=o?re(r,function(m){if(typeof m[1]!="function")throw new fi(v);return[c(m[0]),m[1]]}):[],Pt(function(m){for(var x=-1;++x<o;){var C=r[x];if(qe(C[0],this,m))return qe(C[1],this,m)}})}function Z0(r){return vg(ci(r,B))}function lh(r){return function(){return r}}function j0(r,o){return r==null||r!==r?o:r}var K0=Of(),q0=Of(!0);function $e(r){return r}function hh(r){return _f(typeof r=="function"?r:ci(r,B))}function J0(r){return mf(ci(r,B))}function Q0(r,o){return yf(r,ci(o,B))}var tw=Pt(function(r,o){return function(c){return As(c,r,o)}}),ew=Pt(function(r,o){return function(c){return As(r,c,o)}});function uh(r,o,c){var m=Se(o),x=Ba(o,m);c==null&&!(oe(o)&&(x.length||!m.length))&&(c=o,o=r,r=this,x=Ba(o,Se(o)));var C=!(oe(c)&&"chain"in c)||!!c.chain,z=an(r);return ui(x,function(P){var M=o[P];r[P]=M,z&&(r.prototype[P]=function(){var Z=this.__chain__;if(C||Z){var j=r(this.__wrapped__),q=j.__actions__=Ye(this.__actions__);return q.push({func:M,args:arguments,thisArg:r}),j.__chain__=Z,j}return M.apply(r,xn([this.value()],arguments))})}),r}function iw(){return Ce._===this&&(Ce._=A_),this}function fh(){}function nw(r){return r=Ft(r),Pt(function(o){return vf(o,r)})}var rw=Hl(re),sw=Hl(Ou),aw=Hl(cl);function Dd(r){return jl(r)?pl(Yi(r)):Rg(r)}function ow(r){return function(o){return r==null?h:Zn(r,o)}}var lw=Gf(),hw=Gf(!0);function dh(){return[]}function ch(){return!1}function uw(){return{}}function fw(){return""}function dw(){return!0}function cw(r,o){if(r=Ft(r),r<1||r>Nt)return[];var c=K,m=Fe(r,K);o=xt(o),r-=K;for(var x=ml(m,o);++c<r;)o(c);return x}function pw(r){return Bt(r)?re(r,Yi):ti(r)?[r]:Ye(nd($t(r)))}function _w(r){var o=++C_;return $t(r)+o}var gw=Ra(function(r,o){return r+o},0),mw=Yl("ceil"),yw=Ra(function(r,o){return r/o},1),vw=Yl("floor");function ww(r){return r&&r.length?Ia(r,$e,Al):h}function xw(r,o){return r&&r.length?Ia(r,xt(o,2),Al):h}function bw(r){return Hu(r,$e)}function Sw(r,o){return Hu(r,xt(o,2))}function Uw(r){return r&&r.length?Ia(r,$e,Fl):h}function Ew(r,o){return r&&r.length?Ia(r,xt(o,2),Fl):h}var Cw=Ra(function(r,o){return r*o},1),Tw=Yl("round"),Aw=Ra(function(r,o){return r-o},0);function Iw(r){return r&&r.length?gl(r,$e):0}function Bw(r,o){return r&&r.length?gl(r,xt(o,2)):0}return E.after=Jy,E.ary=pd,E.assign=Ov,E.assignIn=Ad,E.assignInWith=ja,E.assignWith=Nv,E.at=Gv,E.before=_d,E.bind=eh,E.bindAll=$0,E.bindKey=gd,E.castArray=uv,E.chain=fd,E.chunk=vm,E.compact=wm,E.concat=xm,E.cond=X0,E.conforms=Z0,E.constant=lh,E.countBy=Iy,E.create=Hv,E.curry=md,E.curryRight=yd,E.debounce=vd,E.defaults=Yv,E.defaultsDeep=Vv,E.defer=Qy,E.delay=tv,E.difference=bm,E.differenceBy=Sm,E.differenceWith=Um,E.drop=Em,E.dropRight=Cm,E.dropRightWhile=Tm,E.dropWhile=Am,E.fill=Im,E.filter=zy,E.flatMap=Ly,E.flatMapDeep=Py,E.flatMapDepth=Ry,E.flatten=od,E.flattenDeep=Bm,E.flattenDepth=zm,E.flip=ev,E.flow=K0,E.flowRight=q0,E.fromPairs=Fm,E.functions=qv,E.functionsIn=Jv,E.groupBy=Dy,E.initial=Lm,E.intersection=Pm,E.intersectionBy=Rm,E.intersectionWith=Dm,E.invert=t0,E.invertBy=e0,E.invokeMap=Oy,E.iteratee=hh,E.keyBy=Ny,E.keys=Se,E.keysIn=We,E.map=Ya,E.mapKeys=n0,E.mapValues=r0,E.matches=J0,E.matchesProperty=Q0,E.memoize=Wa,E.merge=s0,E.mergeWith=Id,E.method=tw,E.methodOf=ew,E.mixin=uh,E.negate=$a,E.nthArg=nw,E.omit=a0,E.omitBy=o0,E.once=iv,E.orderBy=Gy,E.over=rw,E.overArgs=nv,E.overEvery=sw,E.overSome=aw,E.partial=ih,E.partialRight=wd,E.partition=Hy,E.pick=l0,E.pickBy=Bd,E.property=Dd,E.propertyOf=ow,E.pull=Gm,E.pullAll=hd,E.pullAllBy=Hm,E.pullAllWith=Ym,E.pullAt=Vm,E.range=lw,E.rangeRight=hw,E.rearg=rv,E.reject=Wy,E.remove=Wm,E.rest=sv,E.reverse=Ql,E.sampleSize=Xy,E.set=u0,E.setWith=f0,E.shuffle=Zy,E.slice=$m,E.sortBy=qy,E.sortedUniq=Qm,E.sortedUniqBy=ty,E.split=L0,E.spread=av,E.tail=ey,E.take=iy,E.takeRight=ny,E.takeRightWhile=ry,E.takeWhile=sy,E.tap=wy,E.throttle=ov,E.thru=Ha,E.toArray=Ed,E.toPairs=zd,E.toPairsIn=Fd,E.toPath=pw,E.toPlainObject=Td,E.transform=d0,E.unary=lv,E.union=ay,E.unionBy=oy,E.unionWith=ly,E.uniq=hy,E.uniqBy=uy,E.uniqWith=fy,E.unset=c0,E.unzip=th,E.unzipWith=ud,E.update=p0,E.updateWith=_0,E.values=Lr,E.valuesIn=g0,E.without=dy,E.words=Pd,E.wrap=hv,E.xor=cy,E.xorBy=py,E.xorWith=_y,E.zip=gy,E.zipObject=my,E.zipObjectDeep=yy,E.zipWith=vy,E.entries=zd,E.entriesIn=Fd,E.extend=Ad,E.extendWith=ja,uh(E,E),E.add=gw,E.attempt=Rd,E.camelCase=w0,E.capitalize=kd,E.ceil=mw,E.clamp=m0,E.clone=fv,E.cloneDeep=cv,E.cloneDeepWith=pv,E.cloneWith=dv,E.conformsTo=_v,E.deburr=Ld,E.defaultTo=j0,E.divide=yw,E.endsWith=x0,E.eq=Ei,E.escape=b0,E.escapeRegExp=S0,E.every=By,E.find=Fy,E.findIndex=sd,E.findKey=Wv,E.findLast=ky,E.findLastIndex=ad,E.findLastKey=$v,E.floor=vw,E.forEach=dd,E.forEachRight=cd,E.forIn=Xv,E.forInRight=Zv,E.forOwn=jv,E.forOwnRight=Kv,E.get=sh,E.gt=gv,E.gte=mv,E.has=Qv,E.hasIn=ah,E.head=ld,E.identity=$e,E.includes=My,E.indexOf=km,E.inRange=y0,E.invoke=i0,E.isArguments=qn,E.isArray=Bt,E.isArrayBuffer=yv,E.isArrayLike=Ve,E.isArrayLikeObject=ce,E.isBoolean=vv,E.isBuffer=An,E.isDate=wv,E.isElement=xv,E.isEmpty=bv,E.isEqual=Sv,E.isEqualWith=Uv,E.isError=nh,E.isFinite=Ev,E.isFunction=an,E.isInteger=xd,E.isLength=Xa,E.isMap=bd,E.isMatch=Cv,E.isMatchWith=Tv,E.isNaN=Av,E.isNative=Iv,E.isNil=zv,E.isNull=Bv,E.isNumber=Sd,E.isObject=oe,E.isObjectLike=ue,E.isPlainObject=Ls,E.isRegExp=rh,E.isSafeInteger=Fv,E.isSet=Ud,E.isString=Za,E.isSymbol=ti,E.isTypedArray=kr,E.isUndefined=kv,E.isWeakMap=Lv,E.isWeakSet=Pv,E.join=Mm,E.kebabCase=U0,E.last=_i,E.lastIndexOf=Om,E.lowerCase=E0,E.lowerFirst=C0,E.lt=Rv,E.lte=Dv,E.max=ww,E.maxBy=xw,E.mean=bw,E.meanBy=Sw,E.min=Uw,E.minBy=Ew,E.stubArray=dh,E.stubFalse=ch,E.stubObject=uw,E.stubString=fw,E.stubTrue=dw,E.multiply=Cw,E.nth=Nm,E.noConflict=iw,E.noop=fh,E.now=Va,E.pad=T0,E.padEnd=A0,E.padStart=I0,E.parseInt=B0,E.random=v0,E.reduce=Yy,E.reduceRight=Vy,E.repeat=z0,E.replace=F0,E.result=h0,E.round=Tw,E.runInContext=D,E.sample=$y,E.size=jy,E.snakeCase=k0,E.some=Ky,E.sortedIndex=Xm,E.sortedIndexBy=Zm,E.sortedIndexOf=jm,E.sortedLastIndex=Km,E.sortedLastIndexBy=qm,E.sortedLastIndexOf=Jm,E.startCase=P0,E.startsWith=R0,E.subtract=Aw,E.sum=Iw,E.sumBy=Bw,E.template=D0,E.times=cw,E.toFinite=on,E.toInteger=Ft,E.toLength=Cd,E.toLower=M0,E.toNumber=gi,E.toSafeInteger=Mv,E.toString=$t,E.toUpper=O0,E.trim=N0,E.trimEnd=G0,E.trimStart=H0,E.truncate=Y0,E.unescape=V0,E.uniqueId=_w,E.upperCase=W0,E.upperFirst=oh,E.each=dd,E.eachRight=cd,E.first=ld,uh(E,function(){var r={};return Gi(E,function(o,c){Kt.call(E.prototype,c)||(r[c]=o)}),r}(),{chain:!1}),E.VERSION=u,ui(["bind","bindKey","curry","curryRight","partial","partialRight"],function(r){E[r].placeholder=E}),ui(["drop","take"],function(r,o){Mt.prototype[r]=function(c){c=c===h?1:ve(Ft(c),0);var m=this.__filtered__&&!o?new Mt(this):this.clone();return m.__filtered__?m.__takeCount__=Fe(c,m.__takeCount__):m.__views__.push({size:Fe(c,K),type:r+(m.__dir__<0?"Right":"")}),m},Mt.prototype[r+"Right"]=function(c){return this.reverse()[r](c).reverse()}}),ui(["filter","map","takeWhile"],function(r,o){var c=o+1,m=c==bt||c==Yt;Mt.prototype[r]=function(x){var C=this.clone();return C.__iteratees__.push({iteratee:xt(x,3),type:c}),C.__filtered__=C.__filtered__||m,C}}),ui(["head","last"],function(r,o){var c="take"+(o?"Right":"");Mt.prototype[r]=function(){return this[c](1).value()[0]}}),ui(["initial","tail"],function(r,o){var c="drop"+(o?"":"Right");Mt.prototype[r]=function(){return this.__filtered__?new Mt(this):this[c](1)}}),Mt.prototype.compact=function(){return this.filter($e)},Mt.prototype.find=function(r){return this.filter(r).head()},Mt.prototype.findLast=function(r){return this.reverse().find(r)},Mt.prototype.invokeMap=Pt(function(r,o){return typeof r=="function"?new Mt(this):this.map(function(c){return As(c,r,o)})}),Mt.prototype.reject=function(r){return this.filter($a(xt(r)))},Mt.prototype.slice=function(r,o){r=Ft(r);var c=this;return c.__filtered__&&(r>0||o<0)?new Mt(c):(r<0?c=c.takeRight(-r):r&&(c=c.drop(r)),o!==h&&(o=Ft(o),c=o<0?c.dropRight(-o):c.take(o-r)),c)},Mt.prototype.takeRightWhile=function(r){return this.reverse().takeWhile(r).reverse()},Mt.prototype.toArray=function(){return this.take(K)},Gi(Mt.prototype,function(r,o){var c=/^(?:filter|find|map|reject)|While$/.test(o),m=/^(?:head|last)$/.test(o),x=E[m?"take"+(o=="last"?"Right":""):o],C=m||/^find/.test(o);x&&(E.prototype[o]=function(){var z=this.__wrapped__,P=m?[1]:arguments,M=z instanceof Mt,Z=P[0],j=M||Bt(z),q=function(Dt){var Ot=x.apply(E,xn([Dt],P));return m&&ht?Ot[0]:Ot};j&&c&&typeof Z=="function"&&Z.length!=1&&(M=j=!1);var ht=this.__chain__,gt=!!this.__actions__.length,St=C&&!ht,kt=M&&!gt;if(!C&&j){z=kt?z:new Mt(this);var Ut=r.apply(z,P);return Ut.__actions__.push({func:Ha,args:[q],thisArg:h}),new di(Ut,ht)}return St&&kt?r.apply(this,P):(Ut=this.thru(q),St?m?Ut.value()[0]:Ut.value():Ut)})}),ui(["pop","push","shift","sort","splice","unshift"],function(r){var o=pa[r],c=/^(?:push|sort|unshift)$/.test(r)?"tap":"thru",m=/^(?:pop|shift)$/.test(r);E.prototype[r]=function(){var x=arguments;if(m&&!this.__chain__){var C=this.value();return o.apply(Bt(C)?C:[],x)}return this[c](function(z){return o.apply(Bt(z)?z:[],x)})}}),Gi(Mt.prototype,function(r,o){var c=E[o];if(c){var m=c.name+"";Kt.call(Ar,m)||(Ar[m]=[]),Ar[m].push({name:o,func:c})}}),Ar[Pa(h,a).name]=[{name:"wrapper",func:h}],Mt.prototype.clone=V_,Mt.prototype.reverse=W_,Mt.prototype.value=$_,E.prototype.at=xy,E.prototype.chain=by,E.prototype.commit=Sy,E.prototype.next=Uy,E.prototype.plant=Cy,E.prototype.reverse=Ty,E.prototype.toJSON=E.prototype.valueOf=E.prototype.value=Ay,E.prototype.first=E.prototype.head,xs&&(E.prototype[xs]=Ey),E},Er=S_();Yn?((Yn.exports=Er)._=Er,hl._=Er):Ce._=Er}).call(Ps)})(Xo,Xo.exports);var dp=Xo.exports;const nU={class:"w-full h-full bg-[#201f20] relative overflow-hidden select-none"},rU={class:"flex justify-between items-center px-4 py-2"},sU={class:"flex items-center gap-4"},aU={class:"text-white hover:text-purple-500 transition-colors"},oU={class:"flex items-center gap-2"},lU={class:"text-white min-w-[50px] text-center"},hU={class:"flex items-center gap-2"},uU={key:0,class:"absolute w-[10%] left-0 top-0 inset-0 flex flex-col items-center justify-center"},Uh="track-zoom-value",mc=3,In=150,fU=30,yc=5,Eh=15,dU=Di({__name:"clipTrack",props:{tracks:{},maxTracksNum:{},currentTime:{},timelineDuration:{}},emits:["resetTrack","timeUpdate","refreshPlayer","add-clip","activeClip","delete-empty-track","handleExport","update:tracks"],setup(f,{expose:l,emit:h}){const u=f,p=h,_=Ee(()=>mc*v.value*10),v=pt(parseFloat(localStorage.getItem(Uh)||"1")),s=()=>{v.value<5&&(v.value<1?v.value=Math.min(5,Math.round((v.value+.1)*10)/10):v.value=Math.min(5,Math.floor(v.value+1)),localStorage.setItem(Uh,v.value.toString()))},b=()=>{v.value>.3&&(v.value<=1?v.value=Math.max(.3,Math.round((v.value-.1)*10)/10):v.value=Math.max(1,Math.floor(v.value-1)),localStorage.setItem(Uh,v.value.toString()))},A=Ee(()=>u.timelineDuration*_.value),I=pt(null),B=pt(-1),U=pt(!1),N=pt(0),t=pt(0),e=pt(null),n=pt(0),a=pt(0),d=pt(null),g=pt(15),y=pt(null),w=pt([]),S=pt(!1),L=pt(null),k=pt(null),F=yr(),G=$=>{$.preventDefault();const nt=$.currentTarget.getBoundingClientRect(),vt=$.clientX-nt.left,_t=$.target.closest("[data-track]"),wt=_t==null?void 0:_t.getAttribute("data-track");if(!F.getDragData)return;const qt=vt/_.value;try{if(wt){const ge=u.tracks.find(me=>me.id===wt);if(ge){const me=u.tracks.indexOf(ge),se=ge.clips.find(ae=>qt>=ae.startTime&&qt<=ae.endTime);se?(S.value=!0,k.value=se,N.value=se.startTime*_.value,B.value=me):(k.value=null,N.value=qt*_.value,B.value=me)}}else k.value=null,N.value=qt*_.value,B.value=-1}catch(ge){console.error("DragOver error:",ge)}},R=$=>{const nt=$.currentTarget.getBoundingClientRect(),vt=$.clientX,yt=$.clientY;(vt<nt.left||vt>nt.right||yt<nt.top||yt>nt.bottom)&&(lt(),U.value=!1,B.value=-1)},lt=()=>{y.value&&B.value>=0&&(u.tracks[B.value].clips.forEach(nt=>{const vt=y.value.find(yt=>yt.id===nt.id);vt&&(nt.startTime=vt.startTime)}),y.value=null,w.value=[])},st=async $=>{$.preventDefault();const nt=$.currentTarget.getBoundingClientRect(),yt=($.clientX-nt.left)/_.value,_t=F.getDragData;if(!_t)return;const wt={..._t,id:os(),rect:null,opacity:100,volume:100,startTime:S.value&&k.value?Number(k.value.startTime):yt,duration:Number((_t.duration||5*1e6)/1e6),selected:!1,sourceStartTime:0,sourceEndTime:0,originalDuration:Number((_t.duration||5*1e6)/1e6)};if(wt.endTime=wt.startTime+wt.duration,wt.type==="video"||wt.type==="image"){const At=await Zh(wt);At.type==="video"?wt.thumbnail=At.data:At.type==="image"&&(wt.thumbnail=[{timestamp:0,url:URL.createObjectURL(At.data)}])}else if(wt.type==="audio"){const At=await jh(wt);At.type==="audio"&&(wt.volumeData=At.data)}else wt.type==="text"&&(wt.textConfig={content:"Hello, World!",fontSize:24,fontFamily:"Arial",color:"#000000",x:10,y:10,width:100,height:100});if(B.value>=0){const At=u.tracks[B.value];At.clips.push(wt),At.clips.sort((qt,ge)=>qt.startTime-ge.startTime)}else if(u.tracks.length<u.maxTracksNum)u.tracks.push({id:os(),clips:[wt]});else{gr.warning("轨道数量已达到最大限制("+u.maxTracksNum+")");return}bt(u.tracks[B.value],wt),p("add-clip",wt),Yt(),Oi(),F.clearDragData()},bt=($,nt)=>{if(!$||($==null?void 0:$.clips.length)===0)return;const vt=$.clips.filter(_t=>_t.endTime>nt.startTime&&_t.startTime<nt.startTime);if(vt.length!==0&&Wt.value==="other")nt.startTime=vt[0].endTime,nt.endTime=nt.startTime+nt.duration;else if(vt.length!==0&&Wt.value==="same")if(u.tracks.length<u.maxTracksNum){const _t={id:os(),clips:[nt]},wt=u.tracks.findIndex(At=>At.id===$.id);u.tracks.splice(wt+1,0,_t),$.clips=$.clips.filter(At=>At.id!==nt.id)}else return nt.startTime=vt[0].endTime,nt.endTime=nt.startTime+nt.duration,gr.warning(`轨道数量已达到最大限制(${u.maxTracksNum})`);const yt=$.clips.filter(_t=>_t.id!==nt.id&&_t.startTime>=nt.startTime).sort((_t,wt)=>_t.startTime-wt.startTime);if(yt.length!==0&&yt[0].startTime<nt.endTime){let _t=nt.endTime;yt.forEach(wt=>{const At=wt.endTime-wt.startTime;wt.startTime=_t,wt.endTime=wt.startTime+At,_t=wt.endTime})}},V=$=>{var nt;(nt=I.value)==null||nt.activeClip($),it.value=$},Yt=()=>{S.value=!1,L.value=null,k.value=null,U.value=!1,B.value=-1,N.value=0},Tt=$=>{B.value=$},Nt=$=>{B.value===$&&(B.value=-1)},it=pt(null),Y=pt(!1),K=pt(null),at=pt(0),X=pt(0),Ht=pt(0),he=$=>{it.value||(it.value=$)},Ke=($,nt,vt)=>{$.stopPropagation(),Y.value=!0,K.value=vt,it.value=nt,at.value=$.clientX,X.value=Number(nt.startTime),Ht.value=Number(nt.endTime),nt.originalDuration||(nt.originalDuration=nt.duration),document.addEventListener("mousemove",ut),document.addEventListener("mouseup",J)},He=Ee(()=>fU/_.value),ut=$=>{if(!Y.value||!it.value)return;$.preventDefault(),$.stopPropagation();const nt=jt.value.getBoundingClientRect(),yt=($.clientX-nt.left+jt.value.scrollLeft)/_.value;if(it.value.type==="video"||it.value.type==="audio"){const _t=Number(it.value.originalDuration);if(K.value==="left"){const wt=Number(it.value.endTime),At=Number(it.value.sourceEndTime),qt=wt-He.value,ge=Math.min(Math.max(0,yt),qt),me=wt-ge,se=_t-(At+me);se>=0&&se+At<=_t&&(it.value.startTime=ge,it.value.duration=me,it.value.sourceStartTime=se)}else if(K.value==="right"){const wt=Number(it.value.startTime),At=Number(it.value.sourceStartTime),qt=wt+He.value,ge=wt+(_t-At),me=Math.min(Math.max(qt,yt),ge),se=me-wt,ae=_t-(At+se);ae>=0&&At+se<=_t&&(it.value.endTime=me,it.value.duration=se,it.value.sourceEndTime=ae)}}else if(K.value==="left"){const _t=Number(it.value.endTime),wt=_t-He.value,At=Math.min(Math.max(0,yt),wt),qt=_t-At;it.value.startTime=At,it.value.duration=qt}else if(K.value==="right"){const _t=Number(it.value.startTime),wt=_t+He.value,At=Math.max(wt,yt),qt=At-_t;it.value.endTime=At,it.value.duration=qt}},J=()=>{if(Y.value&&it.value){const $=Number(it.value.startTime),nt=Number(it.value.duration);it.value.endTime=$+nt,it.value.startTime=$,it.value.duration=nt,it.value.sourceStartTime=Number(it.value.sourceStartTime),it.value.sourceEndTime=Number(it.value.sourceEndTime),it.value.originalDuration=Number(it.value.originalDuration),F.publishClipUpdate(it.value,"resize")}Y.value=!1,K.value=null,Oi(),document.removeEventListener("mousemove",ut),document.removeEventListener("mouseup",J)},ot=pt({x:0,y:0}),ct=pt(""),ne=($,nt,vt)=>{if(Y.value)return;vt.preventDefault(),vt.stopPropagation(),it.value=$;const yt=jt.value.getBoundingClientRect(),wt=(vt.clientX-yt.left+jt.value.scrollLeft)/_.value;ot.value={x:vt.clientX,y:vt.clientY},ct.value=nt;const At=ge=>{const me=Math.abs(ge.clientX-ot.value.x),se=Math.abs(ge.clientY-ot.value.y);(me>yc||se>yc)&&(document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",qt),Jo($,vt))},qt=()=>{document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",qt),console.log("handleClipMouseDown",$),p("activeClip",$),p("timeUpdate",wt)};document.addEventListener("mousemove",At),document.addEventListener("mouseup",qt)},Zt=pt(!1),Wt=pt(null),Rt=pt(null),bi=pt(0),_e=pt(!1),Mi=pt(null),Jo=($,nt)=>{if(!jt.value)return;Zt.value=!0,Rt.value=$,it.value=$,$.selected=!0;const vt=jt.value.getBoundingClientRect(),yt=Number($.startTime)*_.value+vt.left-jt.value.scrollLeft;bi.value=nt.clientX-yt,n.value=nt.clientX,window.addEventListener("mousemove",Re,{capture:!0,passive:!1}),window.addEventListener("mouseup",Ji,{capture:!0}),oi()},oi=()=>{if(!Zt.value||!Rt.value||!jt.value)return;const $=jt.value.getBoundingClientRect();let nt=0,vt=!1;if(e.value==="right"){const _t=1-($.right-n.value)/In;nt=Math.max(1,Math.round(g.value*_t)),jt.value.scrollLeft+=nt,vt=!0}else if(e.value==="left"){const _t=1-(n.value-$.left)/In;nt=Math.max(1,Math.round(g.value*_t)),jt.value.scrollLeft-=nt,vt=!0}else if(e.value==="up"){const _t=1-(a.value-$.top)/In;nt=Math.max(1,Math.round(g.value*_t)),jt.value.scrollTop-=nt,vt=!0}else if(e.value==="down"){const _t=1-($.bottom-a.value)/In;nt=Math.max(1,Math.round(g.value*_t)),jt.value.scrollTop+=nt,vt=!0}if(vt){const _t=n.value-$.left+jt.value.scrollLeft-bi.value,wt=Math.max(0,_t/_.value),At=Number(Rt.value.duration);Rt.value.startTime=wt,Rt.value.endTime=wt+At}if(e.value){const yt=requestAnimationFrame(oi);d.value=yt}},Re=$=>{var me;if(!Zt.value||!Rt.value||!jt.value)return;$.preventDefault(),$.stopPropagation(),n.value=$.clientX,a.value=$.clientY;const nt=document.elementFromPoint($.clientX,$.clientY),vt=nt==null?void 0:nt.getAttribute("data-clip");let yt=null;vt?yt=(me=nt==null?void 0:nt.parentElement)==null?void 0:me.getAttribute("data-track"):yt=nt==null?void 0:nt.getAttribute("data-track");const _t=jt.value.getBoundingClientRect(),At=$.clientX-_t.left+jt.value.scrollLeft-bi.value,qt=Number(Rt.value.duration),ge=yt?u.tracks.find(se=>se.id===yt):null;if(ge){const se=ge.clips.filter(ae=>ae.id!==Rt.value.id).sort((ae,ze)=>Number(ae.startTime)-Number(ze.startTime));if(_e.value&&Mi.value!==null)if(Math.abs(At-Mi.value)>Eh/2)_e.value=!1,Mi.value=null;else{const ze=Mi.value/_.value;Rt.value.startTime=ze,Rt.value.endTime=ze+qt;return}for(const ae of se){const ze=Number(ae.startTime)*_.value,Ni=Number(ae.endTime)*_.value;if(Math.abs(At-Ni)<=Eh){_e.value=!0,Mi.value=Ni,Rt.value.startTime=Ni/_.value,Rt.value.endTime=Ni/_.value+qt;return}if(Math.abs(At+qt*_.value-ze)<=Eh){_e.value=!0,Mi.value=ze-qt*_.value,Rt.value.startTime=ze/_.value-qt,Rt.value.endTime=ze/_.value;return}}}if(Rt.value.startTime=Math.max(0,At/_.value),Rt.value.endTime=Math.max(qt,At/_.value+qt),yt&&yt!==ct.value){const se=u.tracks.findIndex(ae=>ae.id===yt);if(se!==-1){const ae=u.tracks.find(ze=>ze.id===ct.value);if(ae){const ze=ae.clips.findIndex(Ni=>Ni.id===Rt.value.id);ze!==-1&&(ae.clips.splice(ze,1),u.tracks[se].clips.push(Rt.value),u.tracks[se].clips.sort((Ni,oa)=>Number(Ni.startTime)-Number(oa.startTime)),ct.value=yt)}}Wt.value="other"}else Wt.value="same";$.clientX>_t.right-In?e.value!=="right"&&(e.value="right",oi()):$.clientX<_t.left+In?e.value!=="left"&&(e.value="left",oi()):$.clientY<_t.top+In?e.value!=="up"&&(e.value="up",oi()):$.clientY>_t.bottom-In?e.value!=="down"&&(e.value="down",oi()):e.value!==null&&(e.value=null)},Ji=$=>{if(!Zt.value||!Rt.value)return;$&&($.preventDefault(),$.stopPropagation()),_e.value=!1,Mi.value=null,d.value!==null&&(cancelAnimationFrame(d.value),d.value=null),Rt.value.selected=!0,it.value=Rt.value;const nt=u.tracks.find(vt=>vt.id===ct.value);bt(nt,Rt.value),F.publishClipUpdate(Rt.value),Zt.value=!1,e.value=null,Rt.value=null,ct.value="",bi.value=0,Oi(),window.removeEventListener("mousemove",Re,{capture:!0}),window.removeEventListener("mouseup",Ji,{capture:!0})};ra(()=>{d.value!==null&&cancelAnimationFrame(d.value),window.removeEventListener("mousemove",Re,{capture:!0}),window.removeEventListener("mouseup",Ji,{capture:!0})});const vr=$=>{p("timeUpdate",$)},Qo=($,nt)=>{const vt=u.tracks[nt],yt=vt.clips.findIndex(_t=>_t.id===$.id);yt!==-1&&(vt.clips.splice(yt,1),F.publishClipUpdate($,"delete"),vt.clips.length===0&&u.tracks.splice(nt,1))},jt=pt(null),tl=$=>{if(console.log("handleRulerScroll",$),jt.value){const nt=jt.value.scrollWidth-jt.value.clientWidth,vt=Math.max(0,Math.min(jt.value.scrollLeft+$,nt));jt.value.scrollLeft=vt}},Gn=wc(),li=Number(Gn.params.id),wr=Ee(()=>F.canUndo),Hn=pt(!1);On(()=>u.tracks,async()=>{Hn.value=await F.getCanRedo(li)});const _s=async()=>{if(!wr.value)return;const $=await F.undo(li);$&&(p("update:tracks",$),p("refreshPlayer"))},gs=async()=>{if(!Hn.value)return;const $=await F.redo(li);$&&(p("update:tracks",$),p("refreshPlayer"))},ms=async()=>{p("update:tracks",[]),await F.clearHistory(li),p("refreshPlayer")},Oi=async()=>{F.saveHistoryState&&(ys(),await F.saveHistoryState(li,JSON.parse(JSON.stringify(u.tracks))))},ys=()=>{p("delete-empty-track")},vn=pt(!1),vs=()=>{vn.value=!1,p("activeClip",null)};On([()=>it.value,()=>u.currentTime],()=>{if(!it.value){vn.value=!1;return}const nt=["video","audio","image"].includes(it.value.type),vt=u.currentTime>Number(it.value.startTime)&&u.currentTime<Number(it.value.endTime);vn.value=nt&&vt});const el=async()=>{const $=dp.cloneDeep(it.value);$.id=os(),$.startTime=u.currentTime,$.endTime=Number($.endTime),$.type==="text"?($.duration=Number(it.value.duration)-(u.currentTime-Number(it.value.startTime)),it.value.endTime=u.currentTime,it.value.duration=u.currentTime-Number(it.value.startTime)):($.sourceStartTime=u.currentTime-Number(it.value.startTime)+Number($.sourceStartTime),$.duration=Number(it.value.duration)-$.startTime+it.value.startTime,it.value.endTime=u.currentTime,it.value.duration=u.currentTime-Number(it.value.startTime),it.value.sourceEndTime=Number(it.value.sourceEndTime)-(u.currentTime-Number(it.value.startTime))),console.log($),il(it.value).clips.push($),F.publishClipUpdate(it.value),p("add-clip",$),Oi()},il=$=>u.tracks.find(nt=>nt.clips.some(vt=>vt.id===$.id)),nl=()=>{var nt,vt;const $=it.value;$&&(F.publishClipUpdate($,"delete"),(vt=u.tracks.find(yt=>yt.clips.some(_t=>_t.id===$.id)))==null||vt.clips.splice((nt=u.tracks.find(yt=>yt.clips.some(_t=>_t.id===$.id)))==null?void 0:nt.clips.findIndex(yt=>yt.id===$.id),1),Oi())},aa=()=>{p("handleExport")};return l({activeClip:V}),($,nt)=>{const vt=Qt("el-popconfirm"),yt=Qt("el-tooltip"),_t=Qt("el-button");return mt(),Et("div",nU,[O("div",rU,[O("div",sU,[et(vt,{id:"reset-button",title:"确定要重置轨道吗？","confirm-button-text":"确定","cancel-button-text":"取消",onConfirm:ms},{reference:Gt(()=>[O("button",aU,[et(Ct(ie),{icon:"mdi:restore",width:"20"})])]),_:1}),et(yt,{content:"撤销",placement:"top"},{default:Gt(()=>[O("button",{id:"undo-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!wr.value}]),onClick:_s},[et(Ct(ie),{icon:"mdi:undo",width:"20"})],2)]),_:1}),et(yt,{content:"恢复",placement:"top"},{default:Gt(()=>[O("button",{id:"redo-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!Hn.value}]),onClick:gs},[et(Ct(ie),{icon:"mdi:redo",width:"20"})],2)]),_:1}),et(yt,{content:"分割",placement:"top"},{default:Gt(()=>[O("button",{id:"split-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!vn.value}]),onClick:el},[et(Ct(ie),{icon:"material-symbols-light:split-scene-outline",width:"20"})],2)]),_:1}),et(yt,{content:"删除",placement:"top"},{default:Gt(()=>[O("button",{id:"delete-button",class:"text-white hover:text-purple-500 transition-colors",onClick:nl},[et(Ct(ie),{icon:"mdi:delete",width:"20"})])]),_:1})]),O("div",oU,[et(yt,{content:"缩小",placement:"top"},{default:Gt(()=>[O("button",{id:"zoom-out-button",class:Pn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":v.value<=.3}]),onClick:b},[et(Ct(ie),{icon:"mdi:minus",width:"20"})],2)]),_:1}),O("span",lU,je(Math.round(v.value*100))+"%",1),et(yt,{content:"放大",placement:"top"},{default:Gt(()=>[O("button",{id:"zoom-in-button",class:Pn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":v.value>=5}]),onClick:s},[et(Ct(ie),{icon:"mdi:plus",width:"20"})],2)]),_:1}),et(_t,{id:"export-button",class:"text-white",type:"primary",size:"small",onClick:aa},{default:Gt(()=>[O("div",hU,[et(Ct(ie),{icon:"mdi:export",width:"20"}),nt[0]||(nt[0]=Mw(" 导出 "))])]),_:1})])]),O("div",{class:"h-[calc(100%-36px)] relative overflow-x-scroll",ref_key:"trackContainer",ref:jt},[et(RS,{duration:$.timelineDuration,zoom:v.value,"current-time":$.currentTime,"total-width":A.value,onScroll:tl,onTimeUpdate:vr},null,8,["duration","zoom","current-time","total-width"]),O("div",{class:"relative h-[calc(100%-36px)] overflow-x-hidden overflow-y-auto",style:qi({width:A.value+"px"}),onDragover:Ze(G,["prevent"]),onDragleave:Ze(R,["prevent"]),onDrop:Ze(st,["prevent"])},[$.tracks.length?fe("",!0):(mt(),Et("div",uU,nt[1]||(nt[1]=[O("div",{class:"text-[#666] text-lg mb-4"},"拖拽素材到此处",-1),O("div",{class:"w-[200px] h-[40px] bg-purple-500/20 border-2 border-dashed border-purple-500 rounded"},null,-1)]))),et(eU,{ref_key:"tracksListRef",ref:I,tracks:$.tracks,hoveredTrack:B.value,dragPreview:U.value,dragPreviewPosition:N.value,dragPreviewWidth:t.value,zoom:v.value,frameLength:mc*v.value*10,onStartResize:Ke,onTrackDragEnter:Tt,onTrackDragLeave:Nt,onClipMouseDown:ne,onClipHover:he,onDeleteClip:Qo,onBackgroundClick:vs,onSaveHistoryState:Oi},null,8,["tracks","hoveredTrack","dragPreview","dragPreviewPosition","dragPreviewWidth","zoom","frameLength"])],36)],512)])}}}),cU={class:"p-6 text-white"},pU={key:0,class:"mb-6"},_U={class:"grid grid-cols-2 gap-3 mb-4"},gU={class:"mb-4"},mU={class:"flex items-center gap-4"},yU={class:"w-full"},vU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},wU={class:"flex gap-3 mb-3"},xU={class:"flex-1"},bU={class:"flex-1"},SU={class:"flex items-center gap-3 mb-3"},UU={class:"flex-1"},EU={class:"flex items-center gap-3"},CU={class:"flex items-center gap-3"},TU={class:"flex-1"},AU={class:"flex items-center gap-3"},IU={class:"w-12 text-right"},BU={key:1,class:"mb-6"},zU={class:"flex gap-3 mb-3"},FU={class:"flex-1"},kU={class:"flex-1"},LU={class:"flex items-center gap-3"},PU={class:"flex-1"},RU={class:"flex items-center gap-3"},DU={key:2,class:"mb-6"},MU={class:"grid grid-cols-2 gap-3 mb-4"},OU={class:"mb-4"},NU={class:"flex items-center gap-4"},GU={class:"w-full"},HU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},YU={class:"flex items-center gap-3"},VU={class:"flex-1"},WU={class:"flex items-center gap-3"},$U={class:"w-12 text-right"},XU={key:3,class:"mb-6"},ZU={class:"mb-2"},jU={class:"mb-4"},KU={class:"flex items-center gap-4 mb-3"},qU={class:"w-full"},JU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},QU={class:"flex justify-start items-center gap-1"},t2={class:"py-2"},e2={class:"flex justify-between items-center mb-2"},i2={class:"flex-1 mx-4"},n2={class:"flex justify-between items-center mb-2"},r2={class:"flex justify-between items-center mb-2"},s2={class:"flex justify-between items-center mb-2"},a2={class:"flex justify-between items-center mb-2 pl-4"},o2={class:"flex justify-between items-center mb-2 pl-4"},l2={class:"flex justify-between items-center mb-2"},h2={class:"flex justify-between items-center mb-2 pl-4"},u2={class:"flex justify-between items-center mb-2 pl-4"},f2={class:"flex justify-between items-center mb-2 pl-4"},d2={class:"flex justify-between items-center mb-2 pl-4"},c2={key:1,class:"text-center text-[#999] text-base"},p2=Di({__name:"ClipProperties",props:{clip:{}},setup(f){const l=f,h=yr(),u=pt([]),p=pt(!1),_=n=>{let a=n*(180/Math.PI);return a=a%360,a<0&&(a+=360),Math.round(a)},v=n=>n*(Math.PI/180),s=Ee(()=>{var a;if(((a=l.clip)==null?void 0:a.angle)===void 0)return 0;let n=_(l.clip.angle);return n=(n+180)%360,n}),b=Ee({get:()=>{var n;return((n=l.clip)==null?void 0:n.angle)===void 0?0:_(l.clip.angle)},set:n=>{l.clip&&(l.clip.angle=v(n))}}),A=n=>{if(!l.clip)return;if(n===null||isNaN(n)){l.clip.angle=0;return}let a=n%360;a<0&&(a+=360),l.clip.angle=v(a)},I=Ee(()=>{var n,a;switch((a=(n=l.clip)==null?void 0:n.textConfig)==null?void 0:a.align){case"center":return"material-symbols:format-align-center";case"right":return"material-symbols:format-align-right";default:return"material-symbols:format-align-left"}}),B=n=>{l.clip&&(l.clip.textConfig.align=n)},U=n=>{p.value=!0},N=n=>{if(!p.value||!l.clip)return;const a=n.currentTarget.getBoundingClientRect(),d=a.left+a.width/2,g=a.top+a.height/2;let y=Math.atan2(n.clientY-g,n.clientX-d);y=y+Math.PI/2,y<0&&(y+=Math.PI*2),l.clip.angle=y},t=()=>{p.value=!1},e=(n,a)=>{l.clip&&(n===null||isNaN(n))&&(l.clip[a]=0)};return On(()=>l.clip,n=>{n&&h.publishClipUpdate(n)},{deep:!0}),(n,a)=>{const d=Qt("el-input-number"),g=Qt("el-slider"),y=Qt("el-input"),w=Qt("el-option"),S=Qt("el-select"),L=Qt("el-button"),k=Qt("el-dropdown-item"),F=Qt("el-dropdown-menu"),G=Qt("el-dropdown"),R=Qt("el-color-picker"),lt=Qt("el-switch"),st=Qt("el-collapse-item"),bt=Qt("el-collapse");return mt(),Et("div",cU,[n.clip?(mt(),Et(xi,{key:0},[n.clip.type==="video"?(mt(),Et("div",pU,[a[54]||(a[54]=O("div",{class:"text-base font-medium text-white mb-4"},"视频属性",-1)),O("div",_U,[O("div",null,[a[46]||(a[46]=O("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),et(d,{class:"w-30",modelValue:n.clip.x,"onUpdate:modelValue":a[0]||(a[0]=V=>n.clip.x=V),size:"small",placeholder:"X",precision:0,onChange:a[1]||(a[1]=V=>e(V,"x"))},null,8,["modelValue"])]),O("div",null,[a[47]||(a[47]=O("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),et(d,{class:"w-30",modelValue:n.clip.y,"onUpdate:modelValue":a[2]||(a[2]=V=>n.clip.y=V),size:"small",placeholder:"Y",precision:0,onChange:a[3]||(a[3]=V=>e(V,"y"))},null,8,["modelValue"])])]),O("div",gU,[a[49]||(a[49]=O("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),O("div",mU,[O("div",yU,[et(d,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[4]||(a[4]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:A},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:N,onMouseup:t,onMouseleave:t},[O("div",vU,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:qi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[48]||(a[48]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),O("div",wU,[O("div",xU,[a[50]||(a[50]=O("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),et(d,{class:"w-30",modelValue:n.clip.sourceStartTime,"onUpdate:modelValue":a[5]||(a[5]=V=>n.clip.sourceStartTime=V),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:a[6]||(a[6]=V=>e(V,"sourceStartTime"))},null,8,["modelValue"])]),O("div",bU,[a[51]||(a[51]=O("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),et(d,{class:"w-30",modelValue:n.clip.sourceEndTime,"onUpdate:modelValue":a[7]||(a[7]=V=>n.clip.sourceEndTime=V),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:a[8]||(a[8]=V=>e(V,"sourceEndTime"))},null,8,["modelValue"])])]),O("div",SU,[O("div",UU,[a[52]||(a[52]=O("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),O("div",EU,[et(g,{modelValue:n.clip.volume,"onUpdate:modelValue":a[9]||(a[9]=V=>n.clip.volume=V),min:0,max:100,step:1},null,8,["modelValue"]),n.clip.volume===100?(mt(),mn(Ct(ie),{key:0,icon:"material-symbols:volume-up",onClick:a[10]||(a[10]=V=>n.clip.volume=0)})):n.clip.volume!==0?(mt(),mn(Ct(ie),{key:1,icon:"material-symbols:volume-down",onClick:a[11]||(a[11]=V=>n.clip.volume=0)})):(mt(),mn(Ct(ie),{key:2,icon:"material-symbols:volume-off",onClick:a[12]||(a[12]=V=>n.clip.volume=100)}))])])]),O("div",CU,[O("div",TU,[a[53]||(a[53]=O("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),O("div",AU,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[13]||(a[13]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"]),O("div",IU,je(Math.round(n.clip.opacity))+"%",1)])])])])):fe("",!0),n.clip.type==="audio"?(mt(),Et("div",BU,[a[58]||(a[58]=O("div",{class:"text-base font-medium text-white mb-4"},"音频属性",-1)),O("div",zU,[O("div",FU,[a[55]||(a[55]=O("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),et(d,{class:"w-30",modelValue:n.clip.sourceStartTime,"onUpdate:modelValue":a[14]||(a[14]=V=>n.clip.sourceStartTime=V),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:a[15]||(a[15]=V=>e(V,"sourceStartTime"))},null,8,["modelValue"])]),O("div",kU,[a[56]||(a[56]=O("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),et(d,{class:"w-30",modelValue:n.clip.sourceEndTime,"onUpdate:modelValue":a[16]||(a[16]=V=>n.clip.sourceEndTime=V),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:a[17]||(a[17]=V=>e(V,"sourceEndTime"))},null,8,["modelValue"])])]),O("div",LU,[O("div",PU,[a[57]||(a[57]=O("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),O("div",RU,[et(g,{modelValue:n.clip.volume,"onUpdate:modelValue":a[18]||(a[18]=V=>n.clip.volume=V),min:0,max:100,step:1},null,8,["modelValue"]),n.clip.volume===100?(mt(),mn(Ct(ie),{key:0,icon:"material-symbols:volume-up",onClick:a[19]||(a[19]=V=>n.clip.volume=0)})):n.clip.volume!==0?(mt(),mn(Ct(ie),{key:1,icon:"material-symbols:volume-down",onClick:a[20]||(a[20]=V=>n.clip.volume=0)})):(mt(),mn(Ct(ie),{key:2,icon:"material-symbols:volume-off",onClick:a[21]||(a[21]=V=>n.clip.volume=100)}))])])])])):fe("",!0),n.clip.type==="image"?(mt(),Et("div",DU,[a[64]||(a[64]=O("div",{class:"text-base font-medium text-white mb-4"},"图片属性",-1)),O("div",MU,[O("div",null,[a[59]||(a[59]=O("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),et(d,{class:"w-30",modelValue:n.clip.x,"onUpdate:modelValue":a[22]||(a[22]=V=>n.clip.x=V),size:"small",placeholder:"X",precision:0,onChange:a[23]||(a[23]=V=>e(V,"x"))},null,8,["modelValue"])]),O("div",null,[a[60]||(a[60]=O("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),et(d,{class:"w-30",modelValue:n.clip.y,"onUpdate:modelValue":a[24]||(a[24]=V=>n.clip.y=V),size:"small",placeholder:"Y",precision:0,onChange:a[25]||(a[25]=V=>e(V,"y"))},null,8,["modelValue"])])]),O("div",OU,[a[62]||(a[62]=O("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),O("div",NU,[O("div",GU,[et(d,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[26]||(a[26]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:A},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:N,onMouseup:t,onMouseleave:t},[O("div",HU,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:qi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[61]||(a[61]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),O("div",YU,[O("div",VU,[a[63]||(a[63]=O("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),O("div",WU,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[27]||(a[27]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"]),O("div",$U,je(Math.round(n.clip.opacity))+"%",1)])])])])):fe("",!0),n.clip.type==="text"?(mt(),Et("div",XU,[a[83]||(a[83]=O("div",{class:"text-base font-medium text-white mb-4"},"文字属性",-1)),O("div",ZU,[et(y,{modelValue:n.clip.textConfig.content,"onUpdate:modelValue":a[28]||(a[28]=V=>n.clip.textConfig.content=V),type:"textarea",rows:3,placeholder:"请输入文字内容"},null,8,["modelValue"])]),O("div",jU,[a[69]||(a[69]=O("div",{class:"text-base text-white mb-2"},"字体",-1)),et(S,{modelValue:n.clip.textConfig.fontFamily,"onUpdate:modelValue":a[29]||(a[29]=V=>n.clip.textConfig.fontFamily=V),class:"w-full mb-2"},{default:Gt(()=>[et(w,{label:"DM Sans",value:"DM Sans"}),et(w,{label:"微软雅黑",value:"Microsoft YaHei"}),et(w,{label:"宋体",value:"SimSun"}),et(w,{label:"黑体",value:"SimHei"})]),_:1},8,["modelValue"]),a[70]||(a[70]=O("div",{class:"text-base text-white mb-2"},"旋转角度",-1)),O("div",KU,[O("div",qU,[et(d,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[30]||(a[30]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:A},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:N,onMouseup:t,onMouseleave:t},[O("div",JU,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:qi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[65]||(a[65]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)]),O("div",QU,[et(L,{class:Pn({"text-purple-500":n.clip.textConfig.bold}),size:"small",onClick:a[31]||(a[31]=V=>n.clip.textConfig.bold=!n.clip.textConfig.bold)},{default:Gt(()=>[et(Ct(ie),{icon:"material-symbols:format-bold"})]),_:1},8,["class"]),et(L,{class:Pn(["!ml-0",{"text-purple-500":n.clip.textConfig.italic}]),size:"small",onClick:a[32]||(a[32]=V=>n.clip.textConfig.italic=!n.clip.textConfig.italic)},{default:Gt(()=>[et(Ct(ie),{icon:"material-symbols:format-italic"})]),_:1},8,["class"]),et(G,{trigger:"click",onCommand:B},{dropdown:Gt(()=>[et(F,null,{default:Gt(()=>[et(k,{command:"left"},{default:Gt(()=>[et(Ct(ie),{icon:"material-symbols:format-align-left"}),a[66]||(a[66]=O("span",{class:"text-sm text-white ml-2"},"左对齐",-1))]),_:1}),et(k,{command:"center"},{default:Gt(()=>[et(Ct(ie),{icon:"material-symbols:format-align-center"}),a[67]||(a[67]=O("span",{class:"text-sm text-white ml-2"},"居中",-1))]),_:1}),et(k,{command:"right"},{default:Gt(()=>[et(Ct(ie),{icon:"material-symbols:format-align-right"}),a[68]||(a[68]=O("span",{class:"text-sm text-white ml-2"},"右对齐",-1))]),_:1})]),_:1})]),default:Gt(()=>[et(L,{size:"small"},{default:Gt(()=>[et(Ct(ie),{icon:I.value},null,8,["icon"])]),_:1})]),_:1}),et(R,{modelValue:n.clip.textConfig.color,"onUpdate:modelValue":a[33]||(a[33]=V=>n.clip.textConfig.color=V),size:"small","show-alpha":""},null,8,["modelValue"])])]),et(bt,{modelValue:u.value,"onUpdate:modelValue":a[45]||(a[45]=V=>u.value=V)},{default:Gt(()=>[et(st,{name:"advanced"},{title:Gt(()=>a[71]||(a[71]=[O("span",{class:"text-base text-white"},"高级",-1)])),default:Gt(()=>[O("div",t2,[O("div",e2,[a[72]||(a[72]=O("span",{class:"text-base text-white"},"透明度",-1)),O("div",i2,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[34]||(a[34]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"])])]),O("div",n2,[a[73]||(a[73]=O("span",{class:"text-base text-white"},"行高",-1)),et(d,{modelValue:n.clip.textConfig.lineSpacing,"onUpdate:modelValue":a[35]||(a[35]=V=>n.clip.textConfig.lineSpacing=V),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",r2,[a[74]||(a[74]=O("span",{class:"text-base text-white"},"字间距",-1)),et(d,{modelValue:n.clip.textConfig.letterSpacing,"onUpdate:modelValue":a[36]||(a[36]=V=>n.clip.textConfig.letterSpacing=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",s2,[a[75]||(a[75]=O("span",{class:"text-base text-white"},"边框",-1)),et(lt,{modelValue:n.clip.textConfig.showStroke,"onUpdate:modelValue":a[37]||(a[37]=V=>n.clip.textConfig.showStroke=V)},null,8,["modelValue"])]),n.clip.textConfig.showStroke?(mt(),Et(xi,{key:0},[O("div",a2,[a[76]||(a[76]=O("span",{class:"text-base text-white"},"边框颜色",-1)),et(R,{modelValue:n.clip.textConfig.strokeColor,"onUpdate:modelValue":a[38]||(a[38]=V=>n.clip.textConfig.strokeColor=V),"show-alpha":"",size:"small"},null,8,["modelValue"])]),O("div",o2,[a[77]||(a[77]=O("span",{class:"text-base text-white"},"边框宽度",-1)),et(d,{modelValue:n.clip.textConfig.strokeWidth,"onUpdate:modelValue":a[39]||(a[39]=V=>n.clip.textConfig.strokeWidth=V),min:0,step:.5,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):fe("",!0),O("div",l2,[a[78]||(a[78]=O("span",{class:"text-base text-white"},"阴影",-1)),et(lt,{modelValue:n.clip.textConfig.showShadow,"onUpdate:modelValue":a[40]||(a[40]=V=>n.clip.textConfig.showShadow=V)},null,8,["modelValue"])]),n.clip.textConfig.showShadow?(mt(),Et(xi,{key:1},[O("div",h2,[a[79]||(a[79]=O("span",{class:"text-base text-white"},"阴影颜色",-1)),et(R,{modelValue:n.clip.textConfig.shadowColor,"onUpdate:modelValue":a[41]||(a[41]=V=>n.clip.textConfig.shadowColor=V),"show-alpha":"",size:"small"},null,8,["modelValue"])]),O("div",u2,[a[80]||(a[80]=O("span",{class:"text-base text-white"},"阴影模糊",-1)),et(d,{modelValue:n.clip.textConfig.shadowBlur,"onUpdate:modelValue":a[42]||(a[42]=V=>n.clip.textConfig.shadowBlur=V),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",f2,[a[81]||(a[81]=O("span",{class:"text-base text-white"},"水平偏移",-1)),et(d,{modelValue:n.clip.textConfig.shadowOffsetX,"onUpdate:modelValue":a[43]||(a[43]=V=>n.clip.textConfig.shadowOffsetX=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",d2,[a[82]||(a[82]=O("span",{class:"text-base text-white"},"垂直偏移",-1)),et(d,{modelValue:n.clip.textConfig.shadowOffsetY,"onUpdate:modelValue":a[44]||(a[44]=V=>n.clip.textConfig.shadowOffsetY=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):fe("",!0)])]),_:1})]),_:1},8,["modelValue"])])):fe("",!0)],64)):(mt(),Et("div",c2," 请选择一个片段 "))])}}}),_2={id:"left",class:"h-screen"},g2={id:"right",class:"h-screen overflow-hidden"},m2={id:"top",class:"flex justify-between"},y2={id:"topLeft",class:"w-4/5"},v2={id:"topRight",class:"w-1/5 bg-[#303030]"},w2={id:"bottom",class:"bg-[#201f20]"},Ch=10,x2=300,b2=5,Os="split-sizes",A2=Di({__name:"index",setup(f){const l=F=>{F.ctrlKey&&F.preventDefault()};fs(()=>{window.addEventListener("wheel",l,{passive:!1})}),ra(()=>{window.removeEventListener("wheel",l)});const h=wc(),u=yr(),p=Number(h.params.id),_=[25,75],v=[65,35],s=pt([]),b=pt(0),A=Ee(()=>Math.max(I.value+b2,x2)),I=Ee(()=>{let F=0;return s.value.forEach(G=>{G.clips.forEach(R=>{const lt=Number(R.endTime);lt>F&&(F=lt)})}),F}),B=pt(null),U=pt(null),N=F=>{b.value=F},t=()=>{b.value-=30/1e3/1e3},e=()=>{b.value+=30/1e3/1e3};Yd("addClip",async(F,G)=>{if(F.startTime=b.value,F.endTime=b.value+F.duration,F.type==="video"&&(F.sourceStartTime=0,F.sourceEndTime=0,F.originalDuration=F.duration),F.type==="video"||F.type==="image"){const R=await Zh(F);R.type==="video"?F.thumbnail=R.data:R.type==="image"&&(F.thumbnail=[{timestamp:0,url:URL.createObjectURL(R.data)}])}if(F.type==="audio"){const R=await jh(F);R.type==="audio"&&(F.volumeData=R.data)}if(G){if(s.value.length>=Ch){gr.warning(`轨道数量已达到最大限制(${Ch})`);return}const R={id:String(s.value.length),clips:[F]};s.value.push(R)}else s.value.length===0&&s.value.push({id:"0",clips:[]}),s.value[s.value.length-1].clips.push(F);ta(()=>{var R;(R=B.value)==null||R.refreshPlayer()})}),Yd("activeClip",F=>{var G,R,lt;if(F){const st=(G=s.value.find(bt=>bt.clips.some(V=>V.id===F)))==null?void 0:G.clips.find(bt=>bt.id===F);st&&((R=U.value)==null||R.activeClip(st),g.value=st)}else(lt=U.value)==null||lt.activeClip(null),g.value=null}),pt(0),pt(0),fs(async()=>{const F=localStorage.getItem(Os),{horizontalSizes:G,verticalSizes:R}=F?JSON.parse(F):{horizontalSizes:_,verticalSizes:v};_c(["#left","#right"],{sizes:G,minSize:[250,500],snapOffset:0,onDragEnd:st=>{const bt=localStorage.getItem(Os),V=bt?JSON.parse(bt):{};localStorage.setItem(Os,JSON.stringify({...V,horizontalSizes:st}))}}),_c(["#top","#bottom"],{direction:"vertical",sizes:R,minSize:[250,150],snapOffset:0,onDragEnd:st=>{const bt=localStorage.getItem(Os),V=bt?JSON.parse(bt):{};localStorage.setItem(Os,JSON.stringify({...V,verticalSizes:st}))}});const lt=await Be.projects.where({id:p}).first();lt&&(s.value=lt.tracks,S(),s.value.forEach(st=>{st.clips.forEach(bt=>{bt.type==="audio"?jh(bt).then(V=>{V.type==="audio"&&(bt.volumeData=V.data)}):(bt.type==="video"||bt.type==="image")&&Zh(bt).then(V=>{V.type==="video"?bt.thumbnail=V.data:V.type==="image"&&(bt.thumbnail=[{timestamp:0,url:URL.createObjectURL(V.data)}])})})}),u.clearHistory(p),u.saveHistoryState(p,s.value),L())});const n=()=>{u.setShowContextMenu(!1)},a=(F,G)=>{for(const R of s.value)for(const lt of R.clips)if(lt.id===F){Object.assign(lt,G);break}};On(()=>s.value,async F=>{await d()},{deep:!0});const d=async()=>{const F=await Be.projects.where({id:p}).first();if(F){const G=dp.cloneDeep(s.value);G.forEach(R=>{R.clips.forEach(lt=>{lt.thumbnail=null})}),await Be.projects.update(F,{tracks:G})}},g=pt(null),y=F=>{var G;g.value=F,(G=B.value)==null||G.activeClip(F)},w=F=>{var G;(G=B.value)==null||G.addClip(F)},S=()=>{s.value=s.value.filter(F=>F.clips.length>0)},L=()=>{var F;(F=B.value)==null||F.refreshPlayer()},k=()=>{var F;(F=B.value)==null||F.handleExport()};return(F,G)=>(mt(),Et("div",{class:"w-full h-full flex bg-[#1b1b1d] overflow-hidden",onClick:n},[O("div",_2,[et(ES)]),O("div",g2,[O("div",m2,[O("div",y2,[et(V1,{ref_key:"playerRef",ref:B,currentTime:b.value,tracks:s.value,timelineDuration:Ct(A),playerDuration:Ct(I),onPrevFrame:t,onNextFrame:e,onTimeUpdate:N,onUpdateClipProps:a},null,8,["currentTime","tracks","timelineDuration","playerDuration"])]),O("div",v2,[et(p2,{clip:g.value},null,8,["clip"])])]),O("div",w2,[et(dU,{ref_key:"clipTrackRef",ref:U,tracks:s.value,"onUpdate:tracks":G[0]||(G[0]=R=>s.value=R),maxTracksNum:Ch,currentTime:b.value,timelineDuration:Ct(A),onTimeUpdate:N,onAddClip:w,onRefreshPlayer:L,onDeleteEmptyTrack:S,onActiveClip:y,onHandleExport:k},null,8,["tracks","currentTime","timelineDuration"])])])]))}});export{A2 as default};
