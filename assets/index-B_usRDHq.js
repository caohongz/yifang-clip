var J0=Object.defineProperty;var gd=c=>{throw TypeError(c)};var Q0=(c,l,h)=>l in c?J0(c,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):c[l]=h;var md=(c,l,h)=>Q0(c,typeof l!="symbol"?l+"":l,h),ql=(c,l,h)=>l.has(c)||gd("Cannot "+h);var ft=(c,l,h)=>(ql(c,l,"read from private field"),h?h.call(c):l.get(c)),Vn=(c,l,h)=>l.has(c)?gd("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(c):l.set(c,h),Wn=(c,l,h,u)=>(ql(c,l,"write to private field"),u?u.call(c,h):l.set(c,h),h),$n=(c,l,h)=>(ql(c,l,"access private method"),h);import{m as Xd,d as Fi,q as vd,r as pt,s as Ue,o as es,x as $s,y as zn,z as tw,i as Et,c as Ut,a as N,A as Wi,t as Xe,b as et,B as fn,C as Ah,n as Gs,D as jl,E as lr,G as ew,g as mt,f as Jt,w as Ht,F as mi,e as Fn,j as $e,H as ue,p as yd,I as iw,J as Tn,K as Cs,L as qd,h as nw,M as wd}from"./index-5mSe0SiC.js";import{t as rw,J as Th,u as rs,a as Kl,c as sw,_ as ss,d as Vi,g as aw,y as Hs,b as ow}from"./_plugin-vue_export-helper-BMowjyKT.js";var jd={};(function(c){var l=function(){var t=new Date,e=4,n=3,a=2,f=1,g=e,v={setLogLevel:function(w){w==this.debug?g=f:w==this.info?g=a:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),f>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){a>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return v}();l.getDurationString=function(t,e){var n;function a(L,F){for(var P=""+L,M=P.split(".");M[0].length<F;)M[0]="0"+M[0];return M.join(".")}t<0?(n=!0,t=-t):n=!1;var f=e||1,g=t/f,v=Math.floor(g/3600);g-=v*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+v+":"+a(w,2)+":"+a(g,2)+"."+a(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",a=0;a<e;a++)a>0&&(n+=","),n+="["+l.getDurationString(t.start(a))+","+l.getDurationString(t.end(a))+"]";return n}else return"(empty)"},c.Log=l;var h=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};h.prototype.getPosition=function(){return this.position},h.prototype.getEndPosition=function(){return this.buffer.byteLength},h.prototype.getLength=function(){return this.buffer.byteLength},h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},h.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},h.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},h.prototype.readUint8=function(){return this.readAnyInt(1,!1)},h.prototype.readUint16=function(){return this.readAnyInt(2,!1)},h.prototype.readUint24=function(){return this.readAnyInt(3,!1)},h.prototype.readUint32=function(){return this.readAnyInt(4,!1)},h.prototype.readUint64=function(){return this.readAnyInt(8,!1)},h.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},h.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},h.prototype.readInt8=function(){return this.readAnyInt(1,!0)},h.prototype.readInt16=function(){return this.readAnyInt(2,!0)},h.prototype.readInt32=function(){return this.readAnyInt(4,!0)},h.prototype.readInt64=function(){return this.readAnyInt(8,!1)},h.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},h.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},h.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},h.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},h.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},c.MP4BoxStream=h;var u=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??u.LITTLE_ENDIAN};u.prototype={},u.prototype.getPosition=function(){return this.position},u.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var a=new ArrayBuffer(n),f=new Uint8Array(this._buffer),g=new Uint8Array(a,0,f.length);g.set(f),this.buffer=a,this._byteLength=e}},u.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},u.BIG_ENDIAN=!1,u.LITTLE_ENDIAN=!0,u.prototype._byteLength=0,Object.defineProperty(u.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(u.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},u.prototype.isEof=function(){return this.position>=this._byteLength},u.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},u.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},u.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},u.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,u.memcpy=function(t,e,n,a,f){var g=new Uint8Array(t,e,f),v=new Uint8Array(n,a,f);g.set(v)},u.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},u.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},u.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var a=n+t.BYTES_PER_ELEMENT-1,f=n;a>f;a--,f++){var g=e[f];e[f]=e[a],e[a]=g}return t},u.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},u.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},u.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),a=e;t!=null&&(a=Math.min(t,e));for(var f=0;f<a&&n[f]!==0;f++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(f)]);return t!=null?this.position+=a-f:f!=e&&(this.position+=1),g};var p=Math.pow(2,32);u.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},u.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},c.DataStream=u,u.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",n),a.setAttribute("download",t),a.setAttribute("target","_self"),a.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},u.prototype._dynamicSize=!0,Object.defineProperty(u.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),u.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),a=new Uint8Array(this._buffer,t,n.length);n.set(a),this.buffer=e,this.position-=t},u.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},u.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},u.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},u.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},u.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},u.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},u.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},u.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},u.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},u.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},u.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},u.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var a=0;a<t.length&&a<n;a++)this.writeUint16(t.charCodeAt(a),e);for(;a<n;a++)this.writeUint16(0)},u.prototype.writeString=function(t,e,n){var a=0;if(e==null||e=="ASCII")if(n!=null){var f=Math.min(t.length,n);for(a=0;a<f;a++)this.writeUint8(t.charCodeAt(a));for(;a<n;a++)this.writeUint8(0)}else for(a=0;a<t.length;a++)this.writeUint8(t.charCodeAt(a));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},u.prototype.writeCString=function(t,e){var n=0;if(e!=null){var a=Math.min(t.length,e);for(n=0;n<a;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},u.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var a=t[n+1];this.writeType(a,e[t[n]],e)}},u.prototype.writeType=function(t,e,n){var a;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var f=null,g="ASCII",v=this.position;switch(typeof t=="string"&&/:/.test(t)&&(a=t.split(":"),t=a[0],f=parseInt(a[1])),typeof t=="string"&&/,/.test(t)&&(a=t.split(","),t=a[0],g=parseInt(a[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,u.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,u.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,u.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,u.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,u.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,u.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,u.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,u.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,u.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,u.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,u.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,u.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,f);break;case"string":this.writeString(e,g,f);break;case"u16string":this.writeUCS2String(e,this.endianness,f);break;case"u16stringle":this.writeUCS2String(e,u.LITTLE_ENDIAN,f);break;case"u16stringbe":this.writeUCS2String(e,u.BIG_ENDIAN,f);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}f!=null&&(this.position=v,this._realloc(f),this.position=v+f)},u.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},u.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},u.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},u.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*8,n},u.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new u(new ArrayBuffer,0,u.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var a;return a=new Uint8Array(n),a.set(new Uint8Array(t,e,n)),a.buffer.fileStart=t.fileStart+e,a.buffer.usedBytes=0,a.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var a=this.buffers[n];if(t.fileStart<=a.fileStart){if(t.fileStart===a.fileStart)if(t.byteLength>a.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=a.fileStart||(t=this.reduceBuffer(t,0,a.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<a.fileStart+a.byteLength){var f=a.fileStart+a.byteLength-t.fileStart,g=t.byteLength-f;if(g>0)t=this.reduceBuffer(t,f,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,a,f,g=[],v,w="";for(a=0,f=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(v={},g.push(v),v.start=n.fileStart,v.end=n.fileStart+n.byteLength,w+="["+v.start+"-"):v.end===n.fileStart?v.end=n.fileStart+n.byteLength:(v={},v.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+v.start+"-",v.end=n.fileStart+n.byteLength,g.push(v)),a+=n.usedBytes,f+=n.byteLength;g.length>0&&(w+=v.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+a+"/"+f+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,a=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=a,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var a,f=null,g=-1;for(t===!0?a=0:a=this.bufferIndex;a<this.buffers.length&&(f=this.buffers[a],f.fileStart<=e);){g=a,n&&(f.fileStart+f.byteLength<=e?f.usedBytes=f.byteLength:f.usedBytes=e-f.fileStart,this.logBufferLevel());a++}return g!==-1?(f=this.buffers[g],f.fileStart+f.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,a,f=t!==void 0?t:this.bufferIndex;if(n=this.buffers[f],this.buffers.length>f+1)for(e=f+1;e<this.buffers.length&&(a=this.buffers[e],a.fileStart===n.fileStart+n.byteLength);e++)n=a;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var a;return a=this.findPosition(e,t,n),a!==-1?(this.buffer=this.buffers[a],this.bufferIndex=a,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},c.MultiBufferStream=_;var y=function(){var t=3,e=4,n=5,a=6,f=[];f[t]="ES_Descriptor",f[e]="DecoderConfigDescriptor",f[n]="DecoderSpecificInfo",f[a]="SLConfigDescriptor",this.getDescriptorName=function(w){return f[w]};var g=this,v={};return this.parseOneDescriptor=function(w){var S=0,L,F,P;for(L=w.readUint8(),P=w.readUint8();P&128;)S=(P&127)<<7,P=w.readUint8();return S+=P&127,l.debug("MPEG4DescriptorParser","Found "+(f[L]||"Descriptor "+L)+", size "+S+" at position "+w.getPosition()),f[L]?F=new v[f[L]](S):F=new v.Descriptor(S),F.parse(w),F},v.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},v.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},v.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},v.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var L=g.parseOneDescriptor(w);this.descs.push(L)}},v.ES_Descriptor=function(w){v.Descriptor.call(this,t,w)},v.ES_Descriptor.prototype=new v.Descriptor,v.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},v.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},v.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var L=S.findDescriptor(n);if(L&&L.data){var F=(L.data[0]&248)>>3;return F===31&&L.data.length>=2&&(F=32+((L.data[0]&7)<<3)+((L.data[1]&224)>>5)),F}else return null},v.DecoderConfigDescriptor=function(w){v.Descriptor.call(this,e,w)},v.DecoderConfigDescriptor.prototype=new v.Descriptor,v.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},v.DecoderSpecificInfo=function(w){v.Descriptor.call(this,n,w)},v.DecoderSpecificInfo.prototype=new v.Descriptor,v.SLConfigDescriptor=function(w){v.Descriptor.call(this,a,w)},v.SLConfigDescriptor.prototype=new v.Descriptor,this};c.MPEG4DescriptorParser=y;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,a){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=a},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(a){s.ContainerBox.call(this,t,a),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(a,f){s.SampleEntry.call(this,a,f),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,a){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(f){s[t+"SampleEntry"].call(this,e,f),s.addSubBoxArrays.call(this,a)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,a){s.UUIDs.push(t),s.UUIDBoxes[t]=function(f){e?s.FullBox.call(this,"uuid",f,t):n?s.ContainerBox.call(this,"uuid",f,t):s.Box.call(this,"uuid",f,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,a&&(e?s.UUIDBoxes[t].prototype.parse=function(f){this.parseFullHeader(f),a&&a.call(this,f)}:s.UUIDBoxes[t].prototype.parse=a)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},c.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var a=t.readUint8().toString(16);e+=a.length===1?"0"+a:a}return e},s.parseOneBox=function(t,e,n){var a,f=t.getPosition(),g=0,v,w;if(t.getEndPosition()-f<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),L=t.readString(4),F=L;if(l.debug("BoxParser","Found box of type '"+L+"' and size "+S+" at position "+f),g=8,L=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(f),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,F=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(f),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+L+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(L!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+L+"'"),a=new s.Box(L,S),{code:s.OK,box:a,size:a.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+L+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+L+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):S!==0&&f+S>t.getEndPosition()?(t.seek(f),l.info("BoxParser","Not enough data in stream to parse the entire '"+L+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):e?{code:s.OK,type:L,size:S,hdr_size:g,start:f}:(s[L+"Box"]?a=new s[L+"Box"](S):L!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+L+"'"),a=new s.Box(L,S),a.has_unparsed_data=!0):s.UUIDBoxes[w]?a=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),a=new s.Box(L,S),a.uuid=w,a.has_unparsed_data=!0),a.hdr_size=g,a.start=f,a.write===s.Box.prototype.write&&a.type!=="mdat"&&(l.info("BoxParser","'"+F+"' box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),v=t.getPosition()-(a.start+a.size),v<0?(l.warn("BoxParser","Parsing of box '"+F+"' did not read the entire indicated box data size (missing "+-v+" bytes), seeking forward"),t.seek(a.start+a.size)):v>0&&(l.error("BoxParser","Parsing of box '"+F+"' read "+v+" more bytes than the indicated box data size, seeking backwards"),a.size!==0&&t.seek(a.start+a.size)),{code:s.OK,box:a,size:a.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var a=n.type!=="uuid"?n.type:n.uuid;this[a]?l.warn("Box of type "+a+" already stored in field of this type"):this[a]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var a=0;a<3;a++)n==16?this.layer_size[a]=t.readUint16():this.layer_size[a]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var a=t.readInt32();a<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(a)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),a=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|a>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var a={};this.ind_subs.push(a);var f=t.readUint8(),g=t.readUint8(),v=t.readUint8();a.fscod=f>>6,a.bsid=f>>1&31,a.bsmod=(f&1)<<4|g>>4&15,a.acmod=g>>1&7,a.lfeon=g&1,a.num_dep_sub=v>>1&15,a.num_dep_sub>0&&(a.chan_loc=(v&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,a=[],f=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),v=Math.min(g&e,f.length-1);if(v?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),a.push(f[v]),g&n)break}while(!0);this.numMetadataBlocks=a.length+" ("+a.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var a=t.readUint32(),f=0;f<a;f++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),this.version===1?(a.segment_duration=t.readUint64(),a.media_time=t.readInt64()):(a.segment_duration=t.readUint32(),a.media_time=t.readInt32()),a.media_rate_integer=t.readInt16(),a.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var a=n.readUint32();this.entity_ids.push(a)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof y<"u"){var n=new y;this.esd=n.parseOneDescriptor(new u(e.buffer,0,u.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,a,f;this.configurationVersion=t.readUint8(),f=t.readUint8(),this.general_profile_space=f>>6,this.general_tier_flag=(f&32)>>5,this.general_profile_idc=f&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),f=t.readUint8(),this.constantFrameRate=f>>6,this.numTemporalLayers=(f&13)>>3,this.temporalIdNested=(f&4)>>2,this.lengthSizeMinusOne=f&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var v=[];this.nalu_arrays.push(v),f=t.readUint8(),v.completeness=(f&128)>>7,v.nalu_type=f&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};v.push(S),a=t.readUint16(),S.data=t.readUint8Array(a)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var a=0;a<n;a++){var f={};if(this.items.push(f),this.version<2)f.item_ID=t.readUint16();else if(this.version===2)f.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?f.construction_method=t.readUint16()&15:f.construction_method=0,f.data_reference_index=t.readUint16(),this.base_offset_size){case 0:f.base_offset=0;break;case 4:f.base_offset=t.readUint32();break;case 8:f.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();f.extents=[];for(var v=0;v<g;v++){var w={};if(f.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var a={};this.associations.push(a),this.version<1?a.id=t.readUint16():a.id=t.readUint32();var f=t.readUint8();for(a.props=[],n=0;n<f;n++){var g=t.readUint8(),v={};a.props.push(v),v.essential=(g&128)>>7===1,this.flags&1?v.property_index=(g&127)<<8|t.readUint8():v.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var a={};this.levels[n]=a,a.track_ID=t.readUint32();var f=t.readUint8();switch(a.padding_flag=f>>7,a.assignment_type=f&127,a.assignment_type){case 0:a.grouping_type=t.readString(4);break;case 1:a.grouping_type=t.readString(4),a.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:a.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,a;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,a=t.readUint8(),this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var f=t.readUint8();for(e=0;e<f;e++){var g=[];this.nalu_arrays.push(g),a=t.readUint8(),g.completeness=(a&128)>>7,g.nalu_type=a&63;var v=t.readUint16();for(n=0;n<v;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var a=t.readUint32();a>0&&(this.data=t.readUint8Array(a))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var a=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<a/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),a=0;a<n;a++){var f={};this.dependency.push(f),f.subSeqDirectionFlag=t.readUint8(),f.layerNumber=t.readUint8(),f.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),a.sample_count=t.readInt32(),a.group_description_index=t.readInt32()}});function I(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}I.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var a=t.readUint32(),f=t.readUint32();this.bad_pixels.push(new I(a,f))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var a=0;a<n;a++)e=t.readUint8(),this.is_leading[a]=e>>6,this.sample_depends_on[a]=e>>4&3,this.sample_is_depended_on[a]=e>>2&3,this.sample_has_redundancy[a]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a;s[this.grouping_type+"SampleGroupEntry"]?a=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):a=new s.SampleGroupEntry(this.grouping_type),this.entries.push(a),this.version===1?this.default_length===0?a.description_length=t.readUint32():a.description_length=this.default_length:a.description_length=this.default_length,a.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),a.data=t.readUint8Array(a.description_length),t.position-=a.description_length),a.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var a={};this.references.push(a);var f=t.readUint32();a.reference_type=f>>31&1,a.referenced_size=f&2147483647,a.subsegment_duration=t.readUint32(),f=t.readUint32(),a.starts_with_SAP=f>>31&1,a.SAP_type=f>>28&7,a.SAP_delta_time=f&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.subsegments.push(a),a.ranges=[];for(var f=t.readUint32(),g=0;g<f;g++){var v={};a.ranges.push(v),v.level=t.readUint8(),v.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,a,f;for(this.entries=[],a=t.readUint32(),e=1;e<=a;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(f=new s[n.type+"SampleEntry"](n.size),f.hdr_size=n.hdr_size,f.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),f=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),f.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+f.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),f.parseDataAndRewind(t)),f.parse(t),this.entries.push(f);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,a;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),a=t.readInt32(),a<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),a=1),this.sample_deltas.push(a)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var a,f;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(a=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),a.code===s.OK)f=a.box,this.boxes.push(f),this[f.type]=f;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var a=t.readUint8();this.sample_sizes[e]=a>>4&15,this.sample_sizes[e+1]=a&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,a,f;for(a=t.readUint32(),this.entries=[],e=0;e<a;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],f=t.readUint16(),f>0)for(n=0;n<f;n++){var v={};g.subsamples.push(v),this.version==1?v.size=t.readUint32():v.size=t.readUint16(),v.priority=t.readUint8(),v.discardable=t.readUint8(),v.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),a=0;a<n;a++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},a=0,f=0;this.version===1?(a=t.readUint64(),f=t.readUint64()):(a=t.readUint32(),f=t.readUint32()),n.absolute_time=a,n.absolute_duration=f,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,a={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(D){this.held_bits=D.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(D){this.held_bits=D.readUint16(),this.num_held_bits=16},extract_bits:function(D){var it=this.held_bits>>this.num_held_bits-D&(1<<D)-1;return this.num_held_bits-=D,it}};if(a.stream_read_1_bytes(t),a.extract_bits(5),this.lengthSizeMinusOne=a.extract_bits(2),this.ptl_present_flag=a.extract_bits(1),this.ptl_present_flag){a.stream_read_2_bytes(t),this.ols_idx=a.extract_bits(9),this.num_sublayers=a.extract_bits(3),this.constant_frame_rate=a.extract_bits(2),this.chroma_format_idc=a.extract_bits(2),a.stream_read_1_bytes(t),this.bit_depth_minus8=a.extract_bits(3),a.extract_bits(5);{if(a.stream_read_2_bytes(t),a.extract_bits(2),this.num_bytes_constraint_info=a.extract_bits(6),this.general_profile_idc=a.extract_bits(7),this.general_tier_flag=a.extract_bits(1),this.general_level_idc=t.readUint8(),a.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=a.extract_bits(1),this.ptl_multilayer_enabled_flag=a.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var f=a.extract_bits(6);a.stream_read_1_bytes(t);var g=a.extract_bits(2);this.general_constraint_info[e]=f<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=a.extract_bits(6)}else a.extract_bits(6);if(this.num_sublayers>1){for(a.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var v=a.extract_bits(1);this.ptl_sublayer_present_mask|=v<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)a.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var L=t.readUint8();for(e=0;e<L;e++){var F=[];this.nalu_arrays.push(F),a.stream_read_1_bytes(t),F.completeness=a.extract_bits(1),a.extract_bits(2),F.nalu_type=a.extract_bits(5);var P=1;for(F.nalu_type!=S&&F.nalu_type!=w&&(P=t.readUint16()),n=0;n<P;n++){var M=t.readUint16();F.push({data:t.readUint8Array(M),length:M})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,a=0;for(t=0;t<32&&(a|=n&1,t!=31);t++)a<<=1,n>>=1;e+=s.decimalToHex(a,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var f=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||f)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,f=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var a=[],f=0;f|=this.vvcC.ptl_frame_only_constraint<<7,f|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)f|=this.vvcC.general_constraint_info[t]>>2&63,a.push(f),f&&(g=t),f=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var v="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|a[t],S+=8;S>=5;){var L=w>>S-5&31;n+=v[L],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=v[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[a].pts=t[a].dts+this.sample_offsets[e],a++},s.sttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)a===0?t[a].dts=0:t[a].dts=t[a-1].dts+this.sample_deltas[e],a++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,a,f,g;for(f=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,a=0;a<this.samples_per_chunk[e];a++){if(t[f])t[f].description_index=this.sample_description_index[e],t[f].chunk_index=g;else return;f++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var a=s.DIFF_BOXES_PROP_NAMES[n];if(t[a]&&e[a]&&!s.boxEqual(t[a],e[a]))return!1}return!0};var B=function(){};B.prototype.parseSample=function(t){var e={},n;e.resources=[];var a=new h(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=a.readString(t.data.length);else if(e.documentString=a.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=a.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var T=function(){};T.prototype.parseSample=function(t){var e,n=new h(t.data.buffer);return e=n.readString(t.data.length),e},T.prototype.parseConfig=function(t){var e,n=new h(t.buffer);return n.readUint32(),e=n.readCString(),e},c.XMLSubtitlein4Parser=B,c.Textin4Parser=T;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var f={};this.fragmentedTracks.push(f),f.id=t,f.user=e,f.trak=a,a.nextSample=0,f.segmentStream=null,f.nb_samples=1e3,f.rapAlignement=!0,n&&(n.nbSamples&&(f.nb_samples=n.nbSamples),n.rapAlignement&&(f.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var a=this.fragmentedTracks[n];a.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var f={};this.extractedTracks.push(f),f.id=t,f.user=e,f.trak=a,a.nextSample=0,f.nb_samples=1e3,f.samples=[],n&&n.nbSamples&&(f.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var a=this.extractedTracks[n];a.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var a;switch(e=t.box,a=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),a){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[a]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+a+", overriding previous occurrence"),this[a]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},a,f,g,v,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=this.moov.traks[t],v=a.mdia.minf.stbl.stsd.entries[0],f={},n.tracks.push(f),f.id=a.tkhd.track_id,f.name=a.mdia.hdlr.name,f.references=[],a.tref)for(e=0;e<a.tref.boxes.length;e++)g={},f.references.push(g),g.type=a.tref.boxes[e].type,g.track_ids=a.tref.boxes[e].track_ids;a.edts&&(f.edits=a.edts.elst.entries),f.created=new Date(w+a.tkhd.creation_time*1e3),f.modified=new Date(w+a.tkhd.modification_time*1e3),f.movie_duration=a.tkhd.duration,f.movie_timescale=n.timescale,f.layer=a.tkhd.layer,f.alternate_group=a.tkhd.alternate_group,f.volume=a.tkhd.volume,f.matrix=a.tkhd.matrix,f.track_width=a.tkhd.width/65536,f.track_height=a.tkhd.height/65536,f.timescale=a.mdia.mdhd.timescale,f.cts_shift=a.mdia.minf.stbl.cslg,f.duration=a.mdia.mdhd.duration,f.samples_duration=a.samples_duration,f.codec=v.getCodec(),f.kind=a.udta&&a.udta.kinds.length?a.udta.kinds[0]:{schemeURI:"",value:""},f.language=a.mdia.elng?a.mdia.elng.extended_language:a.mdia.mdhd.languageString,f.nb_samples=a.samples.length,f.size=a.samples_size,f.bitrate=f.size*8*f.timescale/f.samples_duration,v.isAudio()?(f.type="audio",n.audioTracks.push(f),f.audio={},f.audio.sample_rate=v.getSampleRate(),f.audio.channel_count=v.getChannelCount(),f.audio.sample_size=v.getSampleSize()):v.isVideo()?(f.type="video",n.videoTracks.push(f),f.video={},f.video.width=v.getWidth(),f.video.height=v.getHeight()):v.isSubtitle()?(f.type="subtitles",n.subtitleTracks.push(f)):v.isHint()?(f.type="metadata",n.hintTracks.push(f)):v.isMetadata()?(f.type="metadata",n.metadataTracks.push(f)):(f.type="metadata",n.otherTracks.push(f))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var a=this.fragmentedTracks[e];for(n=a.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+a.id+" for sample "+n.nextSample);var f=this.createFragment(a.id,n.nextSample,a.segmentStream);if(f)a.segmentStream=f,n.nextSample++;else break;if((n.nextSample%a.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+a.id+" for samples ["+Math.max(0,n.nextSample-a.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(a.id,a.user,a.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),a.segmentStream=null,a!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var v=this.getSample(n,n.nextSample);if(v)n.nextSample++,g.samples.push(v);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var a in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[a],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),a=this.getSample(n,e);return a},U.prototype.releaseUsedSamples=function(t,e){var n=0,a=this.getTrackById(t);a.lastValidSample||(a.lastValidSample=0);for(var f=a.lastValidSample;f<e;f++)n+=this.releaseSample(a,f);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),a.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var a,f,g=1/0,v=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(a=0;a<n.samples.length;a++){if(f=n.samples[a],a===0)w=0,S=f.timescale;else if(f.cts>t*f.timescale){w=a-1;break}e&&f.is_sync&&(v=a)}for(e&&(w=v),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,a,f,g,v={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)a=n.traks[g],!(t>this.getTrackDuration(a))&&(f=this.seekTrack(t,e,a),f.offset<v.offset&&(v.offset=f.offset),f.time<v.time&&(v.time=f.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(v.time,1)+" needs a buffer with a fileStart position of "+v.offset),v.offset===1/0?v={offset:this.nextParsePosition,time:0}:v.offset=this.stream.getEndFilePositionAfter(v.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+v.offset),v}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],a=t.boxes[e];if(!s.boxEqual(n,a))return!1;e++}return!0},c.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,a;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,a=this.stream.seek(e.start+e.size,!1,this.discardMdatData),a?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var a=n.add("mdia");a.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),a.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),a.add("elng").set("extended_language",e.language||"fr-FR");var f=a.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var v="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],L=0;L<S.length;L++)if(S.indexOf(e.type)>-1){v=w;break}switch(v){case"Visual":if(f.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var F=new s.avcCBox;F.parse(new h(e.avcDecoderConfigRecord)),g.addBox(F)}else if(e.hevcDecoderConfigRecord){var P=new s.hvcCBox;P.parse(new h(e.hevcDecoderConfigRecord)),g.addBox(P)}break;case"Audio":f.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":f.add("hmhd");break;case"Subtitle":switch(f.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":f.add("nmhd");break;case"System":f.add("nmhd");break;default:f.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(D){g.addBox(D)}),f.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var M=f.add("stbl");return M.add("stsd").addEntry(g),M.add("stts").set("sample_counts",[]).set("sample_deltas",[]),M.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),M.add("stco").set("chunk_offsets",[]),M.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new u;e.endianness=u.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var a=n||{},f={},g=this.getTrackById(t);if(g!==null){f.number=g.samples.length,f.track_id=g.tkhd.track_id,f.timescale=g.mdia.mdhd.timescale,f.description_index=a.sample_description_index?a.sample_description_index-1:0,f.description=g.mdia.minf.stbl.stsd.entries[f.description_index],f.data=e,f.size=e.byteLength,f.alreadyRead=f.size,f.duration=a.duration||1,f.cts=a.cts||0,f.dts=a.dts||0,f.is_sync=a.is_sync||!1,f.is_leading=a.is_leading||0,f.depends_on=a.depends_on||0,f.is_depended_on=a.is_depended_on||0,f.has_redundancy=a.has_redundancy||0,f.degradation_priority=a.degradation_priority||0,f.offset=0,f.subsamples=a.subsamples,g.samples.push(f),g.samples_size+=f.size,g.samples_duration+=f.duration,g.first_dts===void 0&&(g.first_dts=a.dts),this.processSamples();var v=this.createSingleSampleMoof(f);return this.addBox(v),v.computeSize(),v.trafs[0].truns[0].data_offset=v.size+8,this.add("mdat").data=new Uint8Array(e),f}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var a=n.add("traf"),f=this.getTrackById(t.track_id);return a.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),a.add("tfdt").set("baseMediaDecodeTime",t.dts-(f.first_dts||0)),a.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,a,f,g,v,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],a=e.mdia.minf.stbl.stsc,a.first_chunk=[],a.samples_per_chunk=[],a.sample_description_index=[],f=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,f.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],v=e.mdia.minf.stbl.ctts,v&&(v.sample_counts=[],v.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,a,f){var g,v,w,S;function L(F,P,M){this.grouping_type=F,this.grouping_type_parameter=P,this.sbgp=M,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),v=0;v<n.length;v++){for(S=n[v].grouping_type+"/"+n[v].grouping_type_parameter,w=new L(n[v].grouping_type,n[v].grouping_type_parameter,n[v]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<a.length;g++)a[g].grouping_type===n[v].grouping_type&&(w.description=a[g],w.description.used=!0);if(f)for(g=0;g<f.length;g++)f[g].grouping_type===n[v].grouping_type&&(w.fragment_description=f[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(f)for(v=0;v<f.length;v++)!f[v].used&&f[v].version>=2&&(S=f[v].grouping_type+"/0",w=new L(f[v].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(v=0;v<a.length;v++)!a[v].used&&a[v].version>=2&&(S=a[v].grouping_type+"/0",w=new L(a[v].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,a){var f,g;e.sample_groups=[];for(f in a)if(e.sample_groups[f]={},e.sample_groups[f].grouping_type=a[f].grouping_type,e.sample_groups[f].grouping_type_parameter=a[f].grouping_type_parameter,n>=a[f].last_sample_in_run&&(a[f].last_sample_in_run<0&&(a[f].last_sample_in_run=0),a[f].entry_index++,a[f].entry_index<=a[f].sbgp.entries.length-1&&(a[f].last_sample_in_run+=a[f].sbgp.entries[a[f].entry_index].sample_count)),a[f].entry_index<=a[f].sbgp.entries.length-1?e.sample_groups[f].group_description_index=a[f].sbgp.entries[a[f].entry_index].group_description_index:e.sample_groups[f].group_description_index=-1,e.sample_groups[f].group_description_index!==0){var v;a[f].fragment_description?v=a[f].fragment_description:v=a[f].description,e.sample_groups[f].group_description_index>0?(e.sample_groups[f].group_description_index>65535?g=(e.sample_groups[f].group_description_index>>16)-1:g=e.sample_groups[f].group_description_index-1,v&&g>=0&&(e.sample_groups[f].description=v.entries[g])):v&&v.version>=2&&v.default_group_description_index>0&&(e.sample_groups[f].description=v.entries[v.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,a,f,g,v,w,S,L,F,P,M,D,it,at,Ft,V,Ct,At,Gt,nt,Y,K,ot;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,a=t.mdia.minf.stbl.stsc,f=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,v=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,L=t.mdia.minf.stbl.subs,M=t.mdia.minf.stbl.stdp,F=t.mdia.minf.stbl.sbgps,P=t.mdia.minf.stbl.sgpds,Ct=-1,At=-1,Gt=-1,nt=-1,Y=0,K=0,ot=0,U.initSampleGroups(t,null,F,P),!(typeof f>"u")){for(e=0;e<f.sample_sizes.length;e++){var X={};X.number=e,X.track_id=t.tkhd.track_id,X.timescale=t.mdia.mdhd.timescale,X.alreadyRead=0,t.samples[e]=X,X.size=f.sample_sizes[e],t.samples_size+=X.size,e===0?(it=1,D=0,X.chunk_index=it,X.chunk_run_index=D,V=a.samples_per_chunk[D],Ft=0,D+1<a.first_chunk.length?at=a.first_chunk[D+1]-1:at=1/0):e<V?(X.chunk_index=it,X.chunk_run_index=D):(it++,X.chunk_index=it,Ft=0,it<=at||(D++,D+1<a.first_chunk.length?at=a.first_chunk[D+1]-1:at=1/0),X.chunk_run_index=D,V+=a.samples_per_chunk[D]),X.description_index=a.sample_description_index[X.chunk_run_index]-1,X.description=S.entries[X.description_index],X.offset=n.chunk_offsets[X.chunk_index-1]+Ft,Ft+=X.size,e>Ct&&(At++,Ct<0&&(Ct=0),Ct+=g.sample_counts[At]),e>0?(t.samples[e-1].duration=g.sample_deltas[At],t.samples_duration+=t.samples[e-1].duration,X.dts=t.samples[e-1].dts+t.samples[e-1].duration):X.dts=0,v?(e>=Gt&&(nt++,Gt<0&&(Gt=0),Gt+=v.sample_counts[nt]),X.cts=t.samples[e].dts+v.sample_offsets[nt]):X.cts=X.dts,w?(e==w.sample_numbers[Y]-1?(X.is_sync=!0,Y++):(X.is_sync=!1,X.degradation_priority=0),L&&L.entries[K].sample_delta+ot==e+1&&(X.subsamples=L.entries[K].subsamples,ot+=L.entries[K].sample_delta,K++)):X.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,X,X.number),M?X.degradation_priority=M.priority[e]:X.degradation_priority=0,L&&L.entries[K].sample_delta+ot==e&&(X.subsamples=L.entries[K].subsamples,ot+=L.entries[K].sample_delta),(F.length>0||P.length>0)&&U.setSampleGroupProperties(t,X,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,a,f,g,v,w,S,L,F,P,M,D,it;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(L=S,t=0;t<L.trafs.length;t++){for(F=L.trafs[t],P=this.getTrackById(F.tfhd.track_id),M=this.getTrexById(F.tfhd.track_id),F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?a=F.tfhd.default_sample_description_index:a=M?M.default_sample_description_index:1,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?f=F.tfhd.default_sample_duration:f=M?M.default_sample_duration:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=F.tfhd.default_sample_size:g=M?M.default_sample_size:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?v=F.tfhd.default_sample_flags:v=M?M.default_sample_flags:0,F.sample_number=0,F.sbgps.length>0&&U.initSampleGroups(P,F,F.sbgps,P.mdia.minf.stbl.sgpds,F.sgpds),e=0;e<F.truns.length;e++){var at=F.truns[e];for(n=0;n<at.sample_count;n++){D={},D.moof_number=this.lastMoofIndex,D.number_in_traf=F.sample_number,F.sample_number++,D.number=P.samples.length,F.first_sample_index=P.samples.length,P.samples.push(D),D.track_id=P.tkhd.track_id,D.timescale=P.mdia.mdhd.timescale,D.description_index=a-1,D.description=P.mdia.minf.stbl.stsd.entries[D.description_index],D.size=g,at.flags&s.TRUN_FLAGS_SIZE&&(D.size=at.sample_size[n]),P.samples_size+=D.size,D.duration=f,at.flags&s.TRUN_FLAGS_DURATION&&(D.duration=at.sample_duration[n]),P.samples_duration+=D.duration,P.first_traf_merged||n>0?D.dts=P.samples[P.samples.length-2].dts+P.samples[P.samples.length-2].duration:(F.tfdt?D.dts=F.tfdt.baseMediaDecodeTime:D.dts=0,P.first_traf_merged=!0),D.cts=D.dts,at.flags&s.TRUN_FLAGS_CTS_OFFSET&&(D.cts=D.dts+at.sample_composition_time_offset[n]),it=v,at.flags&s.TRUN_FLAGS_FLAGS?it=at.sample_flags[n]:n===0&&at.flags&s.TRUN_FLAGS_FIRST_FLAG&&(it=at.first_sample_flags),D.is_sync=!(it>>16&1),D.is_leading=it>>26&3,D.depends_on=it>>24&3,D.is_depended_on=it>>22&3,D.has_redundancy=it>>20&3,D.degradation_priority=it&65535;var Ft=!!(F.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),V=!!(F.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Ct=!!(at.flags&s.TRUN_FLAGS_DATA_OFFSET),At=0;Ft?At=F.tfhd.base_data_offset:V||e===0?At=L.start:At=w,e===0&&n===0?Ct?D.offset=At+at.data_offset:D.offset=At:D.offset=w,w=D.offset+D.size,(F.sbgps.length>0||F.sgpds.length>0||P.mdia.minf.stbl.sbgps.length>0||P.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(P,D,D.number_in_traf,F.sample_groups_info)}}if(F.subs){P.has_fragment_subsamples=!0;var Gt=F.first_sample_index;for(e=0;e<F.subs.entries.length;e++)Gt+=F.subs.entries[e].sample_delta,D=P.samples[Gt-1],D.subsamples=F.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,a=t.samples[e];if(!this.moov)return null;if(!a.data)a.data=new Uint8Array(a.size),a.alreadyRead=0,this.samplesDataSize+=a.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+a.size+" (total: "+this.samplesDataSize+")");else if(a.alreadyRead==a.size)return a;for(;;){var f=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(f>-1){n=this.stream.buffers[f];var g=n.byteLength-(a.offset+a.alreadyRead-n.fileStart);if(a.size-a.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+(a.size-a.alreadyRead)+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,a.size-a.alreadyRead),n.usedBytes+=a.size-a.alreadyRead,this.stream.logBufferLevel(),a.alreadyRead=a.size,a;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,g),a.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,a,f,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)f={},f.id=g.iinf.item_infos[n].item_ID,t[f.id]=f,f.ref_to=[],f.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(f.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?f.type=g.iinf.item_infos[n].item_type:f.type="mime",f.content_type=g.iinf.item_infos[n].content_type,f.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var v=g.iloc.items[n];switch(f=t[v.item_ID],v.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),f.source=g.dinf.boxes[v.data_reference_index-1]),v.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(f.extents=[],f.size=0,a=0;a<v.extents.length;a++)f.extents[a]={},f.extents[a].offset=v.extents[a].extent_offset+v.base_offset,f.extents[a].length=v.extents[a].extent_length,f.extents[a].alreadyRead=0,f.size+=f.extents[a].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(a=0;a<w.references.length;a++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[a]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var L=g.iprp.ipmas[S];for(n=0;n<L.associations.length;n++){var F=L.associations[n];if(f=t[F.id],f||(f=e[F.id]),f)for(f.properties===void 0&&(f.properties={},f.properties.boxes=[]),a=0;a<F.props.length;a++){var P=F.props[a];if(P.property_index>0&&P.property_index-1<g.iprp.ipco.boxes.length){var M=g.iprp.ipco.boxes[P.property_index-1];f.properties[M.type]=M,f.properties.boxes.push(M)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var a=0;a<n.extents.length;a++){var f=n.extents[a];if(f.alreadyRead!==f.length){var g=this.stream.findPosition(!0,f.offset+f.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var v=e.byteLength-(f.offset+f.alreadyRead-e.fileStart);if(f.length-f.alreadyRead<=v)l.debug("ISOFile","Getting item #"+t+" extent #"+a+" data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+(f.length-f.alreadyRead)+" full extent size: "+f.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,f.length-f.alreadyRead),e.usedBytes+=f.length-f.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=f.length-f.alreadyRead,f.alreadyRead=f.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+a+" partial data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+v+" full extent size: "+f.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,v),f.alreadyRead+=v,n.alreadyRead+=v,e.usedBytes+=v,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var a=e.extents[n];a.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var a=new U;a.discardMdatData=!1;var f={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(f.width=n.properties.ispe.image_width,f.height=n.properties.ispe.image_height);var g=a.addTrack(f);return g?(a.addSample(g,n.data),a):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var a=this.getTrackById(t),f=this.getSample(a,e);if(f==null)return this.setNextSeekPositionFromSample(a.samples[e]),null;var g=n||new u;g.endianness=u.BIG_ENDIAN;var v=this.createSingleSampleMoof(f);v.write(g),v.trafs[0].truns[0].data_offset=v.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+v.trafs[0].truns[0].data_offset),g.adjustUint32(v.trafs[0].truns[0].data_offset_position,v.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=f.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,a){var f;l.debug("ISOFile","Generating initialization segment");var g=new u;g.endianness=u.BIG_ENDIAN,t.write(g);var v=e.add("mvex");for(n&&v.add("mehd").set("fragment_duration",n),f=0;f<e.traks.length;f++)v.add("trex").set("track_id",e.traks[f].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",a).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new u;e.endianness=u.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new u;return t.endianness=u.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,a;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var f=new s.moovBox;f.mvhd=this.moov.mvhd,f.boxes.push(f.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),f.boxes.push(n),f.traks.push(n),a={},a.id=n.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=U.writeInitializationSegment(this.ftyp,f,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(a)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var G={};G.createFile=function(t,e){var n=t!==void 0?t:!0,a=new U(e);return a.discardMdatData=!n,a},c.createFile=G.createFile})(jd);const ah=Xd(jd);var Kd={};(function(c){var l=function(){var t=new Date,e=4,n=3,a=2,f=1,g=e,v={setLogLevel:function(w){w==this.debug?g=f:w==this.info?g=a:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),f>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){a>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return v}();l.getDurationString=function(t,e){var n;function a(L,F){for(var P=""+L,M=P.split(".");M[0].length<F;)M[0]="0"+M[0];return M.join(".")}t<0?(n=!0,t=-t):n=!1;var f=e||1,g=t/f,v=Math.floor(g/3600);g-=v*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+v+":"+a(w,2)+":"+a(g,2)+"."+a(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",a=0;a<e;a++)a>0&&(n+=","),n+="["+l.getDurationString(t.start(a))+","+l.getDurationString(t.end(a))+"]";return n}else return"(empty)"},c.Log=l;var h=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};h.prototype.getPosition=function(){return this.position},h.prototype.getEndPosition=function(){return this.buffer.byteLength},h.prototype.getLength=function(){return this.buffer.byteLength},h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},h.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},h.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},h.prototype.readUint8=function(){return this.readAnyInt(1,!1)},h.prototype.readUint16=function(){return this.readAnyInt(2,!1)},h.prototype.readUint24=function(){return this.readAnyInt(3,!1)},h.prototype.readUint32=function(){return this.readAnyInt(4,!1)},h.prototype.readUint64=function(){return this.readAnyInt(8,!1)},h.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},h.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},h.prototype.readInt8=function(){return this.readAnyInt(1,!0)},h.prototype.readInt16=function(){return this.readAnyInt(2,!0)},h.prototype.readInt32=function(){return this.readAnyInt(4,!0)},h.prototype.readInt64=function(){return this.readAnyInt(8,!1)},h.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},h.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},h.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},h.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},h.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},c.MP4BoxStream=h;var u=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??u.LITTLE_ENDIAN};u.prototype={},u.prototype.getPosition=function(){return this.position},u.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var a=new ArrayBuffer(n),f=new Uint8Array(this._buffer),g=new Uint8Array(a,0,f.length);g.set(f),this.buffer=a,this._byteLength=e}},u.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},u.BIG_ENDIAN=!1,u.LITTLE_ENDIAN=!0,u.prototype._byteLength=0,Object.defineProperty(u.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(u.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(u.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},u.prototype.isEof=function(){return this.position>=this._byteLength},u.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return u.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},u.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return u.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),u.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},u.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},u.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},u.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},u.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},u.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},u.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,u.memcpy=function(t,e,n,a,f){var g=new Uint8Array(t,e,f),v=new Uint8Array(n,a,f);g.set(v)},u.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},u.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},u.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var a=n+t.BYTES_PER_ELEMENT-1,f=n;a>f;a--,f++){var g=e[f];e[f]=e[a],e[a]=g}return t},u.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},u.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},u.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),a=e;t!=null&&(a=Math.min(t,e));for(var f=0;f<a&&n[f]!==0;f++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(f)]);return t!=null?this.position+=a-f:f!=e&&(this.position+=1),g};var p=Math.pow(2,32);u.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},u.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},u.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},c.DataStream=u,u.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",n),a.setAttribute("download",t),a.setAttribute("target","_self"),a.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},u.prototype._dynamicSize=!0,Object.defineProperty(u.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),u.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),a=new Uint8Array(this._buffer,t,n.length);n.set(a),this.buffer=e,this.position-=t},u.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},u.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},u.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},u.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},u.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},u.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},u.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},u.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)u.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},u.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},u.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},u.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},u.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},u.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},u.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var a=0;a<t.length&&a<n;a++)this.writeUint16(t.charCodeAt(a),e);for(;a<n;a++)this.writeUint16(0)},u.prototype.writeString=function(t,e,n){var a=0;if(e==null||e=="ASCII")if(n!=null){var f=Math.min(t.length,n);for(a=0;a<f;a++)this.writeUint8(t.charCodeAt(a));for(;a<n;a++)this.writeUint8(0)}else for(a=0;a<t.length;a++)this.writeUint8(t.charCodeAt(a));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},u.prototype.writeCString=function(t,e){var n=0;if(e!=null){var a=Math.min(t.length,e);for(n=0;n<a;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},u.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var a=t[n+1];this.writeType(a,e[t[n]],e)}},u.prototype.writeType=function(t,e,n){var a;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var f=null,g="ASCII",v=this.position;switch(typeof t=="string"&&/:/.test(t)&&(a=t.split(":"),t=a[0],f=parseInt(a[1])),typeof t=="string"&&/,/.test(t)&&(a=t.split(","),t=a[0],g=parseInt(a[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,u.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,u.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,u.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,u.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,u.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,u.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,u.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,u.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,u.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,u.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,u.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,u.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,f);break;case"string":this.writeString(e,g,f);break;case"u16string":this.writeUCS2String(e,this.endianness,f);break;case"u16stringle":this.writeUCS2String(e,u.LITTLE_ENDIAN,f);break;case"u16stringbe":this.writeUCS2String(e,u.BIG_ENDIAN,f);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}f!=null&&(this.position=v,this._realloc(f),this.position=v+f)},u.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},u.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},u.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},u.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},u.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n},u.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*2,n},u.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*8,n},u.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return u.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new u(new ArrayBuffer,0,u.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var a;return a=new Uint8Array(n),a.set(new Uint8Array(t,e,n)),a.buffer.fileStart=t.fileStart+e,a.buffer.usedBytes=0,a.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var a=this.buffers[n];if(t.fileStart<=a.fileStart){if(t.fileStart===a.fileStart)if(t.byteLength>a.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=a.fileStart||(t=this.reduceBuffer(t,0,a.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<a.fileStart+a.byteLength){var f=a.fileStart+a.byteLength-t.fileStart,g=t.byteLength-f;if(g>0)t=this.reduceBuffer(t,f,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,a,f,g=[],v,w="";for(a=0,f=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(v={},g.push(v),v.start=n.fileStart,v.end=n.fileStart+n.byteLength,w+="["+v.start+"-"):v.end===n.fileStart?v.end=n.fileStart+n.byteLength:(v={},v.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+v.start+"-",v.end=n.fileStart+n.byteLength,g.push(v)),a+=n.usedBytes,f+=n.byteLength;g.length>0&&(w+=v.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+a+"/"+f+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,a=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=a,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var a,f=null,g=-1;for(t===!0?a=0:a=this.bufferIndex;a<this.buffers.length&&(f=this.buffers[a],f.fileStart<=e);){g=a,n&&(f.fileStart+f.byteLength<=e?f.usedBytes=f.byteLength:f.usedBytes=e-f.fileStart,this.logBufferLevel());a++}return g!==-1?(f=this.buffers[g],f.fileStart+f.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,a,f=t!==void 0?t:this.bufferIndex;if(n=this.buffers[f],this.buffers.length>f+1)for(e=f+1;e<this.buffers.length&&(a=this.buffers[e],a.fileStart===n.fileStart+n.byteLength);e++)n=a;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var a;return a=this.findPosition(e,t,n),a!==-1?(this.buffer=this.buffers[a],this.bufferIndex=a,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},c.MultiBufferStream=_;var y=function(){var t=3,e=4,n=5,a=6,f=[];f[t]="ES_Descriptor",f[e]="DecoderConfigDescriptor",f[n]="DecoderSpecificInfo",f[a]="SLConfigDescriptor",this.getDescriptorName=function(w){return f[w]};var g=this,v={};return this.parseOneDescriptor=function(w){var S=0,L,F,P;for(L=w.readUint8(),P=w.readUint8();P&128;)S=(P&127)<<7,P=w.readUint8();return S+=P&127,l.debug("MPEG4DescriptorParser","Found "+(f[L]||"Descriptor "+L)+", size "+S+" at position "+w.getPosition()),f[L]?F=new v[f[L]](S):F=new v.Descriptor(S),F.parse(w),F},v.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},v.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},v.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},v.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var L=g.parseOneDescriptor(w);this.descs.push(L)}},v.ES_Descriptor=function(w){v.Descriptor.call(this,t,w)},v.ES_Descriptor.prototype=new v.Descriptor,v.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},v.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},v.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var L=S.findDescriptor(n);if(L&&L.data){var F=(L.data[0]&248)>>3;return F===31&&L.data.length>=2&&(F=32+((L.data[0]&7)<<3)+((L.data[1]&224)>>5)),F}else return null},v.DecoderConfigDescriptor=function(w){v.Descriptor.call(this,e,w)},v.DecoderConfigDescriptor.prototype=new v.Descriptor,v.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},v.DecoderSpecificInfo=function(w){v.Descriptor.call(this,n,w)},v.DecoderSpecificInfo.prototype=new v.Descriptor,v.SLConfigDescriptor=function(w){v.Descriptor.call(this,a,w)},v.SLConfigDescriptor.prototype=new v.Descriptor,this};c.MPEG4DescriptorParser=y;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,a){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=a},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(a){s.ContainerBox.call(this,t,a),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(a,f){s.SampleEntry.call(this,a,f),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,a){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(f){s[t+"SampleEntry"].call(this,e,f),s.addSubBoxArrays.call(this,a)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,a){s.UUIDs.push(t),s.UUIDBoxes[t]=function(f){e?s.FullBox.call(this,"uuid",f,t):n?s.ContainerBox.call(this,"uuid",f,t):s.Box.call(this,"uuid",f,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,a&&(e?s.UUIDBoxes[t].prototype.parse=function(f){this.parseFullHeader(f),a&&a.call(this,f)}:s.UUIDBoxes[t].prototype.parse=a)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},c.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var a=t.readUint8().toString(16);e+=a.length===1?"0"+a:a}return e},s.parseOneBox=function(t,e,n){var a,f=t.getPosition(),g=0,v,w;if(t.getEndPosition()-f<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),L=t.readString(4),F=L;if(l.debug("BoxParser","Found box of type '"+L+"' and size "+S+" at position "+f),g=8,L=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(f),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,F=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(f),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+L+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(L!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+L+"'"),a=new s.Box(L,S),{code:s.OK,box:a,size:a.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+L+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+L+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):S!==0&&f+S>t.getEndPosition()?(t.seek(f),l.info("BoxParser","Not enough data in stream to parse the entire '"+L+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:L,size:S,hdr_size:g,start:f}):e?{code:s.OK,type:L,size:S,hdr_size:g,start:f}:(s[L+"Box"]?a=new s[L+"Box"](S):L!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+L+"'"),a=new s.Box(L,S),a.has_unparsed_data=!0):s.UUIDBoxes[w]?a=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),a=new s.Box(L,S),a.uuid=w,a.has_unparsed_data=!0),a.hdr_size=g,a.start=f,a.write===s.Box.prototype.write&&a.type!=="mdat"&&(l.info("BoxParser","'"+F+"' box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),v=t.getPosition()-(a.start+a.size),v<0?(l.warn("BoxParser","Parsing of box '"+F+"' did not read the entire indicated box data size (missing "+-v+" bytes), seeking forward"),t.seek(a.start+a.size)):v>0&&(l.error("BoxParser","Parsing of box '"+F+"' read "+v+" more bytes than the indicated box data size, seeking backwards"),a.size!==0&&t.seek(a.start+a.size)),{code:s.OK,box:a,size:a.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var a=n.type!=="uuid"?n.type:n.uuid;this[a]?l.warn("Box of type "+a+" already stored in field of this type"):this[a]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var a=0;a<3;a++)n==16?this.layer_size[a]=t.readUint16():this.layer_size[a]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var a=t.readInt32();a<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(a)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),a=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|a>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var a={};this.ind_subs.push(a);var f=t.readUint8(),g=t.readUint8(),v=t.readUint8();a.fscod=f>>6,a.bsid=f>>1&31,a.bsmod=(f&1)<<4|g>>4&15,a.acmod=g>>1&7,a.lfeon=g&1,a.num_dep_sub=v>>1&15,a.num_dep_sub>0&&(a.chan_loc=(v&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,a=[],f=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),v=Math.min(g&e,f.length-1);if(v?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),a.push(f[v]),g&n)break}while(!0);this.numMetadataBlocks=a.length+" ("+a.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var a=t.readUint32(),f=0;f<a;f++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),this.version===1?(a.segment_duration=t.readUint64(),a.media_time=t.readInt64()):(a.segment_duration=t.readUint32(),a.media_time=t.readInt32()),a.media_rate_integer=t.readInt16(),a.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var a=n.readUint32();this.entity_ids.push(a)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof y<"u"){var n=new y;this.esd=n.parseOneDescriptor(new u(e.buffer,0,u.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,a,f;this.configurationVersion=t.readUint8(),f=t.readUint8(),this.general_profile_space=f>>6,this.general_tier_flag=(f&32)>>5,this.general_profile_idc=f&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),f=t.readUint8(),this.constantFrameRate=f>>6,this.numTemporalLayers=(f&13)>>3,this.temporalIdNested=(f&4)>>2,this.lengthSizeMinusOne=f&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var v=[];this.nalu_arrays.push(v),f=t.readUint8(),v.completeness=(f&128)>>7,v.nalu_type=f&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};v.push(S),a=t.readUint16(),S.data=t.readUint8Array(a)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var a=0;a<n;a++){var f={};if(this.items.push(f),this.version<2)f.item_ID=t.readUint16();else if(this.version===2)f.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?f.construction_method=t.readUint16()&15:f.construction_method=0,f.data_reference_index=t.readUint16(),this.base_offset_size){case 0:f.base_offset=0;break;case 4:f.base_offset=t.readUint32();break;case 8:f.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();f.extents=[];for(var v=0;v<g;v++){var w={};if(f.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var a={};this.associations.push(a),this.version<1?a.id=t.readUint16():a.id=t.readUint32();var f=t.readUint8();for(a.props=[],n=0;n<f;n++){var g=t.readUint8(),v={};a.props.push(v),v.essential=(g&128)>>7===1,this.flags&1?v.property_index=(g&127)<<8|t.readUint8():v.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var a={};this.levels[n]=a,a.track_ID=t.readUint32();var f=t.readUint8();switch(a.padding_flag=f>>7,a.assignment_type=f&127,a.assignment_type){case 0:a.grouping_type=t.readString(4);break;case 1:a.grouping_type=t.readString(4),a.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:a.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,a;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,a=t.readUint8(),this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var f=t.readUint8();for(e=0;e<f;e++){var g=[];this.nalu_arrays.push(g),a=t.readUint8(),g.completeness=(a&128)>>7,g.nalu_type=a&63;var v=t.readUint16();for(n=0;n<v;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var a=t.readUint32();a>0&&(this.data=t.readUint8Array(a))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var a=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<a/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),a=0;a<n;a++){var f={};this.dependency.push(f),f.subSeqDirectionFlag=t.readUint8(),f.layerNumber=t.readUint8(),f.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.entries.push(a),a.sample_count=t.readInt32(),a.group_description_index=t.readInt32()}});function I(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}I.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var a=t.readUint32(),f=t.readUint32();this.bad_pixels.push(new I(a,f))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var a=0;a<n;a++)e=t.readUint8(),this.is_leading[a]=e>>6,this.sample_depends_on[a]=e>>4&3,this.sample_is_depended_on[a]=e>>2&3,this.sample_has_redundancy[a]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var a;s[this.grouping_type+"SampleGroupEntry"]?a=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):a=new s.SampleGroupEntry(this.grouping_type),this.entries.push(a),this.version===1?this.default_length===0?a.description_length=t.readUint32():a.description_length=this.default_length:a.description_length=this.default_length,a.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),a.data=t.readUint8Array(a.description_length),t.position-=a.description_length),a.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var a={};this.references.push(a);var f=t.readUint32();a.reference_type=f>>31&1,a.referenced_size=f&2147483647,a.subsegment_duration=t.readUint32(),f=t.readUint32(),a.starts_with_SAP=f>>31&1,a.SAP_type=f>>28&7,a.SAP_delta_time=f&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var a={};this.subsegments.push(a),a.ranges=[];for(var f=t.readUint32(),g=0;g<f;g++){var v={};a.ranges.push(v),v.level=t.readUint8(),v.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,a,f;for(this.entries=[],a=t.readUint32(),e=1;e<=a;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(f=new s[n.type+"SampleEntry"](n.size),f.hdr_size=n.hdr_size,f.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),f=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),f.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+f.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),f.parseDataAndRewind(t)),f.parse(t),this.entries.push(f);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,a;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),a=t.readInt32(),a<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),a=1),this.sample_deltas.push(a)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var a,f;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(a=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),a.code===s.OK)f=a.box,this.boxes.push(f),this[f.type]=f;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var a=t.readUint8();this.sample_sizes[e]=a>>4&15,this.sample_sizes[e+1]=a&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,a,f;for(a=t.readUint32(),this.entries=[],e=0;e<a;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],f=t.readUint16(),f>0)for(n=0;n<f;n++){var v={};g.subsamples.push(v),this.version==1?v.size=t.readUint32():v.size=t.readUint16(),v.priority=t.readUint8(),v.discardable=t.readUint8(),v.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),a=0;a<n;a++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,a){s.Box.call(this,t,e),this.hdr_size=n,this.start=a},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},a=0,f=0;this.version===1?(a=t.readUint64(),f=t.readUint64()):(a=t.readUint32(),f=t.readUint32()),n.absolute_time=a,n.absolute_duration=f,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,a={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(D){this.held_bits=D.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(D){this.held_bits=D.readUint16(),this.num_held_bits=16},extract_bits:function(D){var it=this.held_bits>>this.num_held_bits-D&(1<<D)-1;return this.num_held_bits-=D,it}};if(a.stream_read_1_bytes(t),a.extract_bits(5),this.lengthSizeMinusOne=a.extract_bits(2),this.ptl_present_flag=a.extract_bits(1),this.ptl_present_flag){a.stream_read_2_bytes(t),this.ols_idx=a.extract_bits(9),this.num_sublayers=a.extract_bits(3),this.constant_frame_rate=a.extract_bits(2),this.chroma_format_idc=a.extract_bits(2),a.stream_read_1_bytes(t),this.bit_depth_minus8=a.extract_bits(3),a.extract_bits(5);{if(a.stream_read_2_bytes(t),a.extract_bits(2),this.num_bytes_constraint_info=a.extract_bits(6),this.general_profile_idc=a.extract_bits(7),this.general_tier_flag=a.extract_bits(1),this.general_level_idc=t.readUint8(),a.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=a.extract_bits(1),this.ptl_multilayer_enabled_flag=a.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var f=a.extract_bits(6);a.stream_read_1_bytes(t);var g=a.extract_bits(2);this.general_constraint_info[e]=f<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=a.extract_bits(6)}else a.extract_bits(6);if(this.num_sublayers>1){for(a.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var v=a.extract_bits(1);this.ptl_sublayer_present_mask|=v<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)a.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var L=t.readUint8();for(e=0;e<L;e++){var F=[];this.nalu_arrays.push(F),a.stream_read_1_bytes(t),F.completeness=a.extract_bits(1),a.extract_bits(2),F.nalu_type=a.extract_bits(5);var P=1;for(F.nalu_type!=S&&F.nalu_type!=w&&(P=t.readUint16()),n=0;n<P;n++){var M=t.readUint16();F.push({data:t.readUint8Array(M),length:M})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,a=0;for(t=0;t<32&&(a|=n&1,t!=31);t++)a<<=1,n>>=1;e+=s.decimalToHex(a,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var f=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||f)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,f=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var a=[],f=0;f|=this.vvcC.ptl_frame_only_constraint<<7,f|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)f|=this.vvcC.general_constraint_info[t]>>2&63,a.push(f),f&&(g=t),f=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var v="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|a[t],S+=8;S>=5;){var L=w>>S-5&31;n+=v[L],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=v[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[a].pts=t[a].dts+this.sample_offsets[e],a++},s.sttsBox.prototype.unpack=function(t){var e,n,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)a===0?t[a].dts=0:t[a].dts=t[a-1].dts+this.sample_deltas[e],a++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,a,f,g;for(f=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,a=0;a<this.samples_per_chunk[e];a++){if(t[f])t[f].description_index=this.sample_description_index[e],t[f].chunk_index=g;else return;f++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var a=s.DIFF_BOXES_PROP_NAMES[n];if(t[a]&&e[a]&&!s.boxEqual(t[a],e[a]))return!1}return!0};var B=function(){};B.prototype.parseSample=function(t){var e={},n;e.resources=[];var a=new h(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=a.readString(t.data.length);else if(e.documentString=a.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=a.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var T=function(){};T.prototype.parseSample=function(t){var e,n=new h(t.data.buffer);return e=n.readString(t.data.length),e},T.prototype.parseConfig=function(t){var e,n=new h(t.buffer);return n.readUint32(),e=n.readCString(),e},c.XMLSubtitlein4Parser=B,c.Textin4Parser=T;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var f={};this.fragmentedTracks.push(f),f.id=t,f.user=e,f.trak=a,a.nextSample=0,f.segmentStream=null,f.nb_samples=1e3,f.rapAlignement=!0,n&&(n.nbSamples&&(f.nb_samples=n.nbSamples),n.rapAlignement&&(f.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var a=this.fragmentedTracks[n];a.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var a=this.getTrackById(t);if(a){var f={};this.extractedTracks.push(f),f.id=t,f.user=e,f.trak=a,a.nextSample=0,f.nb_samples=1e3,f.samples=[],n&&n.nbSamples&&(f.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var a=this.extractedTracks[n];a.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var a;switch(e=t.box,a=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),a){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[a]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+a+", overriding previous occurrence"),this[a]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},a,f,g,v,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=this.moov.traks[t],v=a.mdia.minf.stbl.stsd.entries[0],f={},n.tracks.push(f),f.id=a.tkhd.track_id,f.name=a.mdia.hdlr.name,f.references=[],a.tref)for(e=0;e<a.tref.boxes.length;e++)g={},f.references.push(g),g.type=a.tref.boxes[e].type,g.track_ids=a.tref.boxes[e].track_ids;a.edts&&(f.edits=a.edts.elst.entries),f.created=new Date(w+a.tkhd.creation_time*1e3),f.modified=new Date(w+a.tkhd.modification_time*1e3),f.movie_duration=a.tkhd.duration,f.movie_timescale=n.timescale,f.layer=a.tkhd.layer,f.alternate_group=a.tkhd.alternate_group,f.volume=a.tkhd.volume,f.matrix=a.tkhd.matrix,f.track_width=a.tkhd.width/65536,f.track_height=a.tkhd.height/65536,f.timescale=a.mdia.mdhd.timescale,f.cts_shift=a.mdia.minf.stbl.cslg,f.duration=a.mdia.mdhd.duration,f.samples_duration=a.samples_duration,f.codec=v.getCodec(),f.kind=a.udta&&a.udta.kinds.length?a.udta.kinds[0]:{schemeURI:"",value:""},f.language=a.mdia.elng?a.mdia.elng.extended_language:a.mdia.mdhd.languageString,f.nb_samples=a.samples.length,f.size=a.samples_size,f.bitrate=f.size*8*f.timescale/f.samples_duration,v.isAudio()?(f.type="audio",n.audioTracks.push(f),f.audio={},f.audio.sample_rate=v.getSampleRate(),f.audio.channel_count=v.getChannelCount(),f.audio.sample_size=v.getSampleSize()):v.isVideo()?(f.type="video",n.videoTracks.push(f),f.video={},f.video.width=v.getWidth(),f.video.height=v.getHeight()):v.isSubtitle()?(f.type="subtitles",n.subtitleTracks.push(f)):v.isHint()?(f.type="metadata",n.hintTracks.push(f)):v.isMetadata()?(f.type="metadata",n.metadataTracks.push(f)):(f.type="metadata",n.otherTracks.push(f))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var a=this.fragmentedTracks[e];for(n=a.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+a.id+" for sample "+n.nextSample);var f=this.createFragment(a.id,n.nextSample,a.segmentStream);if(f)a.segmentStream=f,n.nextSample++;else break;if((n.nextSample%a.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+a.id+" for samples ["+Math.max(0,n.nextSample-a.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(a.id,a.user,a.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),a.segmentStream=null,a!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var v=this.getSample(n,n.nextSample);if(v)n.nextSample++,g.samples.push(v);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var a in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[a],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),a=this.getSample(n,e);return a},U.prototype.releaseUsedSamples=function(t,e){var n=0,a=this.getTrackById(t);a.lastValidSample||(a.lastValidSample=0);for(var f=a.lastValidSample;f<e;f++)n+=this.releaseSample(a,f);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),a.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var a,f,g=1/0,v=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(a=0;a<n.samples.length;a++){if(f=n.samples[a],a===0)w=0,S=f.timescale;else if(f.cts>t*f.timescale){w=a-1;break}e&&f.is_sync&&(v=a)}for(e&&(w=v),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,a,f,g,v={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)a=n.traks[g],!(t>this.getTrackDuration(a))&&(f=this.seekTrack(t,e,a),f.offset<v.offset&&(v.offset=f.offset),f.time<v.time&&(v.time=f.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(v.time,1)+" needs a buffer with a fileStart position of "+v.offset),v.offset===1/0?v={offset:this.nextParsePosition,time:0}:v.offset=this.stream.getEndFilePositionAfter(v.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+v.offset),v}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],a=t.boxes[e];if(!s.boxEqual(n,a))return!1;e++}return!0},c.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,a;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,a=this.stream.seek(e.start+e.size,!1,this.discardMdatData),a?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var a=n.add("mdia");a.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),a.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),a.add("elng").set("extended_language",e.language||"fr-FR");var f=a.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var v="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],L=0;L<S.length;L++)if(S.indexOf(e.type)>-1){v=w;break}switch(v){case"Visual":if(f.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var F=new s.avcCBox;F.parse(new h(e.avcDecoderConfigRecord)),g.addBox(F)}else if(e.hevcDecoderConfigRecord){var P=new s.hvcCBox;P.parse(new h(e.hevcDecoderConfigRecord)),g.addBox(P)}break;case"Audio":f.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":f.add("hmhd");break;case"Subtitle":switch(f.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":f.add("nmhd");break;case"System":f.add("nmhd");break;default:f.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(D){g.addBox(D)}),f.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var M=f.add("stbl");return M.add("stsd").addEntry(g),M.add("stts").set("sample_counts",[]).set("sample_deltas",[]),M.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),M.add("stco").set("chunk_offsets",[]),M.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new u;e.endianness=u.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var a=n||{},f={},g=this.getTrackById(t);if(g!==null){f.number=g.samples.length,f.track_id=g.tkhd.track_id,f.timescale=g.mdia.mdhd.timescale,f.description_index=a.sample_description_index?a.sample_description_index-1:0,f.description=g.mdia.minf.stbl.stsd.entries[f.description_index],f.data=e,f.size=e.byteLength,f.alreadyRead=f.size,f.duration=a.duration||1,f.cts=a.cts||0,f.dts=a.dts||0,f.is_sync=a.is_sync||!1,f.is_leading=a.is_leading||0,f.depends_on=a.depends_on||0,f.is_depended_on=a.is_depended_on||0,f.has_redundancy=a.has_redundancy||0,f.degradation_priority=a.degradation_priority||0,f.offset=0,f.subsamples=a.subsamples,g.samples.push(f),g.samples_size+=f.size,g.samples_duration+=f.duration,g.first_dts===void 0&&(g.first_dts=a.dts),this.processSamples();var v=this.createSingleSampleMoof(f);return this.addBox(v),v.computeSize(),v.trafs[0].truns[0].data_offset=v.size+8,this.add("mdat").data=new Uint8Array(e),f}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var a=n.add("traf"),f=this.getTrackById(t.track_id);return a.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),a.add("tfdt").set("baseMediaDecodeTime",t.dts-(f.first_dts||0)),a.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,a,f,g,v,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],a=e.mdia.minf.stbl.stsc,a.first_chunk=[],a.samples_per_chunk=[],a.sample_description_index=[],f=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,f.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],v=e.mdia.minf.stbl.ctts,v&&(v.sample_counts=[],v.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,a,f){var g,v,w,S;function L(F,P,M){this.grouping_type=F,this.grouping_type_parameter=P,this.sbgp=M,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),v=0;v<n.length;v++){for(S=n[v].grouping_type+"/"+n[v].grouping_type_parameter,w=new L(n[v].grouping_type,n[v].grouping_type_parameter,n[v]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<a.length;g++)a[g].grouping_type===n[v].grouping_type&&(w.description=a[g],w.description.used=!0);if(f)for(g=0;g<f.length;g++)f[g].grouping_type===n[v].grouping_type&&(w.fragment_description=f[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(f)for(v=0;v<f.length;v++)!f[v].used&&f[v].version>=2&&(S=f[v].grouping_type+"/0",w=new L(f[v].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(v=0;v<a.length;v++)!a[v].used&&a[v].version>=2&&(S=a[v].grouping_type+"/0",w=new L(a[v].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,a){var f,g;e.sample_groups=[];for(f in a)if(e.sample_groups[f]={},e.sample_groups[f].grouping_type=a[f].grouping_type,e.sample_groups[f].grouping_type_parameter=a[f].grouping_type_parameter,n>=a[f].last_sample_in_run&&(a[f].last_sample_in_run<0&&(a[f].last_sample_in_run=0),a[f].entry_index++,a[f].entry_index<=a[f].sbgp.entries.length-1&&(a[f].last_sample_in_run+=a[f].sbgp.entries[a[f].entry_index].sample_count)),a[f].entry_index<=a[f].sbgp.entries.length-1?e.sample_groups[f].group_description_index=a[f].sbgp.entries[a[f].entry_index].group_description_index:e.sample_groups[f].group_description_index=-1,e.sample_groups[f].group_description_index!==0){var v;a[f].fragment_description?v=a[f].fragment_description:v=a[f].description,e.sample_groups[f].group_description_index>0?(e.sample_groups[f].group_description_index>65535?g=(e.sample_groups[f].group_description_index>>16)-1:g=e.sample_groups[f].group_description_index-1,v&&g>=0&&(e.sample_groups[f].description=v.entries[g])):v&&v.version>=2&&v.default_group_description_index>0&&(e.sample_groups[f].description=v.entries[v.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,a,f,g,v,w,S,L,F,P,M,D,it,at,Ft,V,Ct,At,Gt,nt,Y,K,ot;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,a=t.mdia.minf.stbl.stsc,f=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,v=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,L=t.mdia.minf.stbl.subs,M=t.mdia.minf.stbl.stdp,F=t.mdia.minf.stbl.sbgps,P=t.mdia.minf.stbl.sgpds,Ct=-1,At=-1,Gt=-1,nt=-1,Y=0,K=0,ot=0,U.initSampleGroups(t,null,F,P),!(typeof f>"u")){for(e=0;e<f.sample_sizes.length;e++){var X={};X.number=e,X.track_id=t.tkhd.track_id,X.timescale=t.mdia.mdhd.timescale,X.alreadyRead=0,t.samples[e]=X,X.size=f.sample_sizes[e],t.samples_size+=X.size,e===0?(it=1,D=0,X.chunk_index=it,X.chunk_run_index=D,V=a.samples_per_chunk[D],Ft=0,D+1<a.first_chunk.length?at=a.first_chunk[D+1]-1:at=1/0):e<V?(X.chunk_index=it,X.chunk_run_index=D):(it++,X.chunk_index=it,Ft=0,it<=at||(D++,D+1<a.first_chunk.length?at=a.first_chunk[D+1]-1:at=1/0),X.chunk_run_index=D,V+=a.samples_per_chunk[D]),X.description_index=a.sample_description_index[X.chunk_run_index]-1,X.description=S.entries[X.description_index],X.offset=n.chunk_offsets[X.chunk_index-1]+Ft,Ft+=X.size,e>Ct&&(At++,Ct<0&&(Ct=0),Ct+=g.sample_counts[At]),e>0?(t.samples[e-1].duration=g.sample_deltas[At],t.samples_duration+=t.samples[e-1].duration,X.dts=t.samples[e-1].dts+t.samples[e-1].duration):X.dts=0,v?(e>=Gt&&(nt++,Gt<0&&(Gt=0),Gt+=v.sample_counts[nt]),X.cts=t.samples[e].dts+v.sample_offsets[nt]):X.cts=X.dts,w?(e==w.sample_numbers[Y]-1?(X.is_sync=!0,Y++):(X.is_sync=!1,X.degradation_priority=0),L&&L.entries[K].sample_delta+ot==e+1&&(X.subsamples=L.entries[K].subsamples,ot+=L.entries[K].sample_delta,K++)):X.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,X,X.number),M?X.degradation_priority=M.priority[e]:X.degradation_priority=0,L&&L.entries[K].sample_delta+ot==e&&(X.subsamples=L.entries[K].subsamples,ot+=L.entries[K].sample_delta),(F.length>0||P.length>0)&&U.setSampleGroupProperties(t,X,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,a,f,g,v,w,S,L,F,P,M,D,it;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(L=S,t=0;t<L.trafs.length;t++){for(F=L.trafs[t],P=this.getTrackById(F.tfhd.track_id),M=this.getTrexById(F.tfhd.track_id),F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?a=F.tfhd.default_sample_description_index:a=M?M.default_sample_description_index:1,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?f=F.tfhd.default_sample_duration:f=M?M.default_sample_duration:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=F.tfhd.default_sample_size:g=M?M.default_sample_size:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?v=F.tfhd.default_sample_flags:v=M?M.default_sample_flags:0,F.sample_number=0,F.sbgps.length>0&&U.initSampleGroups(P,F,F.sbgps,P.mdia.minf.stbl.sgpds,F.sgpds),e=0;e<F.truns.length;e++){var at=F.truns[e];for(n=0;n<at.sample_count;n++){D={},D.moof_number=this.lastMoofIndex,D.number_in_traf=F.sample_number,F.sample_number++,D.number=P.samples.length,F.first_sample_index=P.samples.length,P.samples.push(D),D.track_id=P.tkhd.track_id,D.timescale=P.mdia.mdhd.timescale,D.description_index=a-1,D.description=P.mdia.minf.stbl.stsd.entries[D.description_index],D.size=g,at.flags&s.TRUN_FLAGS_SIZE&&(D.size=at.sample_size[n]),P.samples_size+=D.size,D.duration=f,at.flags&s.TRUN_FLAGS_DURATION&&(D.duration=at.sample_duration[n]),P.samples_duration+=D.duration,P.first_traf_merged||n>0?D.dts=P.samples[P.samples.length-2].dts+P.samples[P.samples.length-2].duration:(F.tfdt?D.dts=F.tfdt.baseMediaDecodeTime:D.dts=0,P.first_traf_merged=!0),D.cts=D.dts,at.flags&s.TRUN_FLAGS_CTS_OFFSET&&(D.cts=D.dts+at.sample_composition_time_offset[n]),it=v,at.flags&s.TRUN_FLAGS_FLAGS?it=at.sample_flags[n]:n===0&&at.flags&s.TRUN_FLAGS_FIRST_FLAG&&(it=at.first_sample_flags),D.is_sync=!(it>>16&1),D.is_leading=it>>26&3,D.depends_on=it>>24&3,D.is_depended_on=it>>22&3,D.has_redundancy=it>>20&3,D.degradation_priority=it&65535;var Ft=!!(F.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),V=!!(F.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Ct=!!(at.flags&s.TRUN_FLAGS_DATA_OFFSET),At=0;Ft?At=F.tfhd.base_data_offset:V||e===0?At=L.start:At=w,e===0&&n===0?Ct?D.offset=At+at.data_offset:D.offset=At:D.offset=w,w=D.offset+D.size,(F.sbgps.length>0||F.sgpds.length>0||P.mdia.minf.stbl.sbgps.length>0||P.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(P,D,D.number_in_traf,F.sample_groups_info)}}if(F.subs){P.has_fragment_subsamples=!0;var Gt=F.first_sample_index;for(e=0;e<F.subs.entries.length;e++)Gt+=F.subs.entries[e].sample_delta,D=P.samples[Gt-1],D.subsamples=F.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,a=t.samples[e];if(!this.moov)return null;if(!a.data)a.data=new Uint8Array(a.size),a.alreadyRead=0,this.samplesDataSize+=a.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+a.size+" (total: "+this.samplesDataSize+")");else if(a.alreadyRead==a.size)return a;for(;;){var f=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(f>-1){n=this.stream.buffers[f];var g=n.byteLength-(a.offset+a.alreadyRead-n.fileStart);if(a.size-a.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+(a.size-a.alreadyRead)+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,a.size-a.alreadyRead),n.usedBytes+=a.size-a.alreadyRead,this.stream.logBufferLevel(),a.alreadyRead=a.size,a;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+a.size+")"),u.memcpy(a.data.buffer,a.alreadyRead,n,a.offset+a.alreadyRead-n.fileStart,g),a.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,a,f,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)f={},f.id=g.iinf.item_infos[n].item_ID,t[f.id]=f,f.ref_to=[],f.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(f.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?f.type=g.iinf.item_infos[n].item_type:f.type="mime",f.content_type=g.iinf.item_infos[n].content_type,f.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var v=g.iloc.items[n];switch(f=t[v.item_ID],v.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),f.source=g.dinf.boxes[v.data_reference_index-1]),v.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(f.extents=[],f.size=0,a=0;a<v.extents.length;a++)f.extents[a]={},f.extents[a].offset=v.extents[a].extent_offset+v.base_offset,f.extents[a].length=v.extents[a].extent_length,f.extents[a].alreadyRead=0,f.size+=f.extents[a].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(a=0;a<w.references.length;a++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[a]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var L=g.iprp.ipmas[S];for(n=0;n<L.associations.length;n++){var F=L.associations[n];if(f=t[F.id],f||(f=e[F.id]),f)for(f.properties===void 0&&(f.properties={},f.properties.boxes=[]),a=0;a<F.props.length;a++){var P=F.props[a];if(P.property_index>0&&P.property_index-1<g.iprp.ipco.boxes.length){var M=g.iprp.ipco.boxes[P.property_index-1];f.properties[M.type]=M,f.properties.boxes.push(M)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var a=0;a<n.extents.length;a++){var f=n.extents[a];if(f.alreadyRead!==f.length){var g=this.stream.findPosition(!0,f.offset+f.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var v=e.byteLength-(f.offset+f.alreadyRead-e.fileStart);if(f.length-f.alreadyRead<=v)l.debug("ISOFile","Getting item #"+t+" extent #"+a+" data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+(f.length-f.alreadyRead)+" full extent size: "+f.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,f.length-f.alreadyRead),e.usedBytes+=f.length-f.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=f.length-f.alreadyRead,f.alreadyRead=f.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+a+" partial data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+v+" full extent size: "+f.length+" full item size: "+n.size+")"),u.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,v),f.alreadyRead+=v,n.alreadyRead+=v,e.usedBytes+=v,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var a=e.extents[n];a.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var a=new U;a.discardMdatData=!1;var f={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(f.width=n.properties.ispe.image_width,f.height=n.properties.ispe.image_height);var g=a.addTrack(f);return g?(a.addSample(g,n.data),a):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var a=this.getTrackById(t),f=this.getSample(a,e);if(f==null)return this.setNextSeekPositionFromSample(a.samples[e]),null;var g=n||new u;g.endianness=u.BIG_ENDIAN;var v=this.createSingleSampleMoof(f);v.write(g),v.trafs[0].truns[0].data_offset=v.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+v.trafs[0].truns[0].data_offset),g.adjustUint32(v.trafs[0].truns[0].data_offset_position,v.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=f.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,a){var f;l.debug("ISOFile","Generating initialization segment");var g=new u;g.endianness=u.BIG_ENDIAN,t.write(g);var v=e.add("mvex");for(n&&v.add("mehd").set("fragment_duration",n),f=0;f<e.traks.length;f++)v.add("trex").set("track_id",e.traks[f].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",a).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new u;e.endianness=u.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new u;return t.endianness=u.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,a;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var f=new s.moovBox;f.mvhd=this.moov.mvhd,f.boxes.push(f.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),f.boxes.push(n),f.traks.push(n),a={},a.id=n.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=U.writeInitializationSegment(this.ftyp,f,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(a)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var G={};G.createFile=function(t,e){var n=t!==void 0?t:!0,a=new U(e);return a.discardMdatData=!n,a},c.createFile=G.createFile})(Kd);const Jr=Xd(Kd);var lw=Object.defineProperty,Zd=c=>{throw TypeError(c)},hw=(c,l,h)=>l in c?lw(c,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):c[l]=h,Zl=(c,l,h)=>hw(c,typeof l!="symbol"?l+"":l,h),uw=(c,l,h)=>l.has(c)||Zd("Cannot "+h),Cr=(c,l,h)=>(uw(c,l,"read from private field"),h?h.call(c):l.get(c)),fw=(c,l,h)=>l.has(c)?Zd("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(c):l.set(c,h),Un;class hr{constructor(){fw(this,Un,new Map),Zl(this,"on",(l,h)=>{const u=Cr(this,Un).get(l)??new Set;return u.add(h),Cr(this,Un).has(l)||Cr(this,Un).set(l,u),()=>{u.delete(h),u.size===0&&Cr(this,Un).delete(l)}}),Zl(this,"once",(l,h)=>{const u=this.on(l,(...p)=>{u(),h(...p)});return u}),Zl(this,"emit",(l,...h)=>{const u=Cr(this,Un).get(l);u!=null&&u.forEach(p=>p(...h))})}static forwardEvent(l,h,u){const p=u.map(_=>{const[y,s]=Array.isArray(_)?_:[_,_];return l.on(y,(...b)=>{h.emit(s,...b)})});return()=>{p.forEach(_=>_())}}destroy(){Cr(this,Un).clear()}}Un=new WeakMap;const dw=()=>{let c,l=16.6;self.onmessage=h=>{h.data.event==="start"&&(self.clearInterval(c),c=self.setInterval(()=>{self.postMessage({})},l)),h.data.event==="stop"&&self.clearInterval(c)}},cw=()=>{const c=new Blob([`(${dw.toString()})()`]),l=URL.createObjectURL(c);return new Worker(l)},Tr=new Map;let oh=1,$r=null;globalThis.Worker!=null&&($r=cw(),$r.onmessage=()=>{oh+=1;for(const[c,l]of Tr)if(oh%c===0)for(const h of l)h()});const Ih=(c,l)=>{const h=Math.round(l/16.6),u=Tr.get(h)??new Set;return u.add(c),Tr.set(h,u),Tr.size===1&&u.size===1&&($r==null||$r.postMessage({event:"start"})),()=>{u.delete(c),u.size===0&&Tr.delete(h),Tr.size===0&&(oh=0,$r==null||$r.postMessage({event:"stop"}))}};function pw(c,l){let h=!1;async function u(){const p=c.getReader();for(;!h;){const{value:_,done:y}=await p.read();if(y){l.onDone();return}await l.onChunk(_)}p.releaseLock(),await c.cancel()}return u().catch(console.error),()=>{h=!0}}function _w(c,l,h){let u=0,p=0;const _=c.boxes;let y=!1;const s=()=>{var T;if(!y)if(_.find(t=>t.type==="moof")!=null)y=!0;else return null;if(p>=_.length)return null;const U=new Jr.DataStream;U.endianness=Jr.DataStream.BIG_ENDIAN;let G=p;try{for(;G<_.length;)_[G].write(U),delete _[G],G+=1}catch(t){const e=_[G];throw t instanceof Error&&e!=null?Error(`${t.message} | deltaBuf( boxType: ${e.type}, boxSize: ${e.size}, boxDataLen: ${((T=e.data)==null?void 0:T.length)??-1})`):t}return gw(c),p=_.length,new Uint8Array(U.buffer)};let b=!1,I=!1,B=null;return{stream:new ReadableStream({start(T){u=self.setInterval(()=>{const U=s();U!=null&&!I&&T.enqueue(U)},l),B=U=>{if(clearInterval(u),c.flush(),U!=null){T.error(U);return}const G=s();G!=null&&!I&&T.enqueue(G),I||T.close()},b&&B()},cancel(){I=!0,clearInterval(u),h==null||h()}}),stop:T=>{b||(b=!0,B==null||B(T))}}}function gw(c){if(c.moov!=null){for(var l=0;l<c.moov.traks.length;l++)c.moov.traks[l].samples=[];c.mdats=[],c.moofs=[]}}const Bh=(c,l)=>{const h=new Uint8Array(8);new DataView(h.buffer).setUint32(0,l);for(let u=0;u<4;u++)h[4+u]=c.charCodeAt(u);return h},mw=()=>{const c=new TextEncoder,l=c.encode("mdta"),h=c.encode("mp4 handler"),u=32+h.byteLength+1,p=new Uint8Array(u),_=new DataView(p.buffer);return p.set(Bh("hdlr",u),0),_.setUint32(8,0),p.set(l,16),p.set(h,32),p},vw=c=>{const l=new TextEncoder,h=l.encode("mdta"),u=c.map(b=>{const I=l.encode(b),B=8+I.byteLength,T=new Uint8Array(B);return new DataView(T.buffer).setUint32(0,B),T.set(h,4),T.set(I,4+h.byteLength),T}),p=16+u.reduce((b,I)=>b+I.byteLength,0),_=new Uint8Array(p),y=new DataView(_.buffer);_.set(Bh("keys",p),0),y.setUint32(8,0),y.setUint32(12,c.length);let s=16;for(const b of u)_.set(b,s),s+=b.byteLength;return _},yw=c=>{const l=new TextEncoder,h=l.encode("data"),u=Object.entries(c).map(([s,b],I)=>{const B=I+1,T=l.encode(b),U=24+T.byteLength,G=new Uint8Array(U),t=new DataView(G.buffer);return t.setUint32(0,U),t.setUint32(4,B),t.setUint32(8,16+T.byteLength),G.set(h,12),t.setUint32(16,1),G.set(T,24),G}),p=8+u.reduce((s,b)=>s+b.byteLength,0),_=new Uint8Array(p);_.set(Bh("ilst",p),0);let y=8;for(const s of u)_.set(s,y),y+=s.byteLength;return _},ww=c=>{const l=mw(),h=vw(Object.keys(c)),u=yw(c),p=l.length+h.length+u.length,_=new Uint8Array(p);return _.set(l,0),_.set(h,l.length),_.set(u,l.length+h.length),_};function xw(c){return c instanceof Error?String(c):typeof c=="object"?JSON.stringify(c,(l,h)=>h instanceof Error?String(h):h):String(c)}function bw(){const c=new Date;return`${c.getHours()}:${c.getMinutes()}:${c.getSeconds()}.${c.getMilliseconds()}`}let Jd=1;const Qd=[],xd=["debug","info","warn","error"].reduce((c,l,h)=>Object.assign(c,{[l]:(...u)=>{Jd<=h&&(console[l](...u),Qd.push({lvName:l,timeStr:bw(),args:u}))}}),{}),Xs=new Map,zt={setLogLevel:c=>{Jd=Xs.get(c)??1},...xd,create:c=>Object.fromEntries(Object.entries(xd).map(([l,h])=>[l,(...u)=>h(c,...u)])),async dump(){return Qd.reduce((c,{lvName:l,timeStr:h,args:u})=>c+`[${l}][${h}]  ${u.map(p=>xw(p)).join(" ")}
`,"")}};Xs.set(zt.debug,0);Xs.set(zt.info,1);Xs.set(zt.warn,2);Xs.set(zt.error,3);(async function(){await Promise.resolve(),!(globalThis.navigator==null||globalThis.document==null)&&(zt.info(`@webav version: 1.0.11, date: ${new Date().toLocaleDateString()}`),zt.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",()=>{zt.info(`visibilitychange: ${document.visibilityState}`)}),"PressureObserver"in globalThis&&new PressureObserver(c=>{zt.info(`cpu state change: ${JSON.stringify(c.map(l=>l.state))}`)}).observe("cpu"))})();function Sw(c){zt.info("recodemux opts:",c);const l=Jr.createFile(),h=new hr,u=(b,I)=>{const B=b.add("udta").add("meta");B.data=ww(I),B.size=B.data.byteLength};let p=!1;const _=()=>{l.moov==null||p||(p=!0,c.metaDataTags!=null&&u(l.moov,c.metaDataTags),c.duration!=null&&(l.moov.mvhd.duration=c.duration))};h.once("VideoReady",_),h.once("AudioReady",_);let y=c.video!=null?Uw(c.video,l,h):null,s=c.audio!=null?Cw(c.audio,l,h):null;return c.video==null&&h.emit("VideoReady"),c.audio==null&&h.emit("AudioReady"),{encodeVideo:(b,I)=>{y==null||y.encode(b,I),b.close()},encodeAudio:b=>{if(s!=null)try{s.encode(b),b.close()}catch(I){const B=`encode audio chunk error: ${I.message}, state: ${JSON.stringify({qSize:s.encodeQueueSize,state:s.state})}`;throw zt.error(B),Error(B)}},getEncodeQueueSize:()=>(y==null?void 0:y.encodeQueueSize)??(s==null?void 0:s.encodeQueueSize)??0,flush:async()=>{await Promise.all([y==null?void 0:y.flush(),(s==null?void 0:s.state)==="configured"?s.flush():null])},close:()=>{h.destroy(),y==null||y.close(),(s==null?void 0:s.state)==="configured"&&s.close()},mp4file:l}}function Uw(c,l,h){const u={timescale:1e6,width:c.width,height:c.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null,name:"Track created with WebAV"};let p=-1,_=!1;h.once("AudioReady",()=>{_=!0});const y={encoder0:[],encoder1:[]},s=(a,f,g)=>{var v;if(p===-1&&g!=null){const w=(v=g.decoderConfig)==null?void 0:v.description;Ew(w),u.avcDecoderConfigRecord=w,p=l.addTrack(u),h.emit("VideoReady"),zt.info("VideoEncoder, video track ready, trackId:",p)}y[a].push(lh(f))};let b="encoder1",I=0;const B=Math.floor(1e3/c.expectFPS*1e3);function T(){if(!_)return;const a=b==="encoder1"?"encoder0":"encoder1",f=y[b],g=y[a];if(f.length===0&&g.length===0)return;let v=f[0];if(v!=null&&(!v.is_sync||v.cts-I<B)){const S=U(f);S>I&&(I=S)}const w=g[0];if(w!=null&&w.is_sync&&w.cts-I<B){b=a,T();return}if(v!=null&&v.is_sync&&w!=null&&w.is_sync)if(v.cts<=w.cts){const S=U(f);S>I&&(I=S)}else{b=a,T();return}}function U(a){let f=-1,g=0;for(;g<a.length;g++){const v=a[g];if(g>0&&v.is_sync)break;l.addSample(p,v.data,v),f=v.cts+v.duration}return a.splice(0,g),f}const G=Ih(T,15),t=bd(c,(a,f)=>s("encoder0",a,f)),e=bd(c,(a,f)=>s("encoder1",a,f));let n=0;return{get encodeQueueSize(){return t.encodeQueueSize+e.encodeQueueSize},encode:(a,f)=>{try{f.keyFrame&&(n+=1),(n%2===0?t:e).encode(a,f)}catch(g){const v=`encode video frame error: ${g.message}, state: ${JSON.stringify({ts:a.timestamp,keyFrame:f.keyFrame,duration:a.duration,gopId:n})}`;throw zt.error(v),Error(v)}},flush:async()=>{await Promise.all([t.state==="configured"?await t.flush():null,e.state==="configured"?await e.flush():null]),G(),T()},close:()=>{t.state==="configured"&&t.close(),e.state==="configured"&&e.close()}}}function Ew(c){const l=new Uint8Array(c);l[2].toString(2).slice(-2).includes("1")&&(l[2]=0)}function bd(c,l){const h={codec:c.codec,framerate:c.expectFPS,hardwareAcceleration:c.__unsafe_hardwareAcceleration__,bitrate:c.bitrate,width:c.width,height:c.height,alpha:"discard",avc:{format:"avc"}},u=new VideoEncoder({error:p=>{const _=`VideoEncoder error: ${p.message}, config: ${JSON.stringify(h)}, state: ${JSON.stringify({qSize:u.encodeQueueSize,state:u.state})}`;throw zt.error(_),Error(_)},output:l});return u.configure(h),u}function Cw(c,l,h){const u={timescale:1e6,samplerate:c.sampleRate,channel_count:c.channelCount,hdlr:"soun",type:c.codec==="aac"?"mp4a":"Opus",name:"Track created with WebAV"};let p=-1,_=[],y=!1;h.once("VideoReady",()=>{y=!0,_.forEach(I=>{const B=lh(I);l.addSample(p,B.data,B)}),_=[]});const s={codec:c.codec==="aac"?"mp4a.40.2":"opus",sampleRate:c.sampleRate,numberOfChannels:c.channelCount,bitrate:128e3},b=new AudioEncoder({error:I=>{const B=`AudioEncoder error: ${I.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify({qSize:b.encodeQueueSize,state:b.state})}`;throw zt.error(B),Error(B)},output:(I,B)=>{var T;if(p===-1){const U=(T=B.decoderConfig)==null?void 0:T.description;p=l.addTrack({...u,description:U==null?void 0:Aw(U)}),h.emit("AudioReady"),zt.info("AudioEncoder, audio track ready, trackId:",p)}if(y){const U=lh(I);l.addSample(p,U.data,U)}else _.push(I)}});return b.configure(s),b}function Aw(c){const l=c.byteLength,h=new Uint8Array([0,0,0,0,3,23+l,0,2,0,4,18+l,64,21,0,0,0,0,0,0,0,0,0,0,0,5,l,...new Uint8Array(c instanceof ArrayBuffer?c:c.buffer),6,1,2]),u=new Jr.BoxParser.esdsBox(h.byteLength);return u.hdr_size=0,u.parse(new Jr.DataStream(h,0,Jr.DataStream.BIG_ENDIAN)),u}function lh(c){const l=new ArrayBuffer(c.byteLength);c.copyTo(l);const h=c.timestamp;return{duration:c.duration??0,dts:h,cts:h,is_sync:c.type==="key",data:l}}class Tw{constructor(l,h,u){this.length_=l,this.scaleFactor_=(l-1)/h,this.interpolate=this.cubic,u.method==="point"?this.interpolate=this.point:u.method==="linear"?this.interpolate=this.linear:u.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,u.tension||0)),this.sincFilterSize_=u.sincFilterSize||1,this.kernel_=Bw(u.sincWindow||Iw)}point(l,h){return this.getClippedInput_(Math.round(this.scaleFactor_*l),h)}linear(l,h){l=this.scaleFactor_*l;let u=Math.floor(l);return l-=u,(1-l)*this.getClippedInput_(u,h)+l*this.getClippedInput_(u+1,h)}cubic(l,h){l=this.scaleFactor_*l;let u=Math.floor(l),p=[this.getTangent_(u,h),this.getTangent_(u+1,h)],_=[this.getClippedInput_(u,h),this.getClippedInput_(u+1,h)];l-=u;let y=l*l,s=l*y;return(2*s-3*y+1)*_[0]+(s-2*y+l)*p[0]+(-2*s+3*y)*_[1]+(s-y)*p[1]}sinc(l,h){l=this.scaleFactor_*l;let u=Math.floor(l),p=u-this.sincFilterSize_+1,_=u+this.sincFilterSize_,y=0;for(let s=p;s<=_;s++)y+=this.kernel_(l-s)*this.getClippedInput_(s,h);return y}getTangent_(l,h){return this.tangentFactor_*(this.getClippedInput_(l+1,h)-this.getClippedInput_(l-1,h))/2}getClippedInput_(l,h){return 0<=l&&l<this.length_?h[l]:0}}function Iw(c){return Math.exp(-c/2*c/2)}function Bw(c){return function(l){return zw(l)*c(l)}}function zw(c){return c===0?1:Math.sin(Math.PI*c)/(Math.PI*c)}class Fw{constructor(l,h,u){let p=2*Math.PI*u/h,_=0;this.filters=[];for(let y=0;y<=l;y++)y-l/2===0?this.filters[y]=p:(this.filters[y]=Math.sin(p*(y-l/2))/(y-l/2),this.filters[y]*=.54-.46*Math.cos(2*Math.PI*y/l)),_=_+this.filters[y];for(let y=0;y<=l;y++)this.filters[y]/=_;this.z=this.initZ_()}filter(l){this.z.buf[this.z.pointer]=l;let h=0;for(let u=0,p=this.z.buf.length;u<p;u++)h+=this.filters[u]*this.z.buf[(this.z.pointer+u)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,h}reset(){this.z=this.initZ_()}initZ_(){let l=[];for(let h=0;h<this.filters.length-1;h++)l.push(0);return{buf:l,pointer:0}}}class Lw{constructor(l,h,u){let p=[];for(let _=0;_<l;_++)p.push(this.getCoeffs_({Fs:h,Fc:u,Q:.5/Math.sin(Math.PI/(l*2)*(_+.5))}));this.stages=[];for(let _=0;_<p.length;_++)this.stages[_]={b0:p[_].b[0],b1:p[_].b[1],b2:p[_].b[2],a1:p[_].a[0],a2:p[_].a[1],k:p[_].k,z:[0,0]}}filter(l){let h=l;for(let u=0,p=this.stages.length;u<p;u++)h=this.runStage_(u,h);return h}getCoeffs_(l){let h={};h.z=[0,0],h.a=[],h.b=[];let u=this.preCalc_(l,h);return h.k=1,h.b.push((1-u.cw)/(2*u.a0)),h.b.push(2*h.b[0]),h.b.push(h.b[0]),h}preCalc_(l,h){let u={},p=2*Math.PI*l.Fc/l.Fs;return u.alpha=Math.sin(p)/(2*l.Q),u.cw=Math.cos(p),u.a0=1+u.alpha,h.a0=u.a0,h.a.push(-2*u.cw/u.a0),h.k=1,h.a.push((1-u.alpha)/u.a0),u}runStage_(l,h){let u=h*this.stages[l].k-this.stages[l].a1*this.stages[l].z[0]-this.stages[l].a2*this.stages[l].z[1],p=this.stages[l].b0*u+this.stages[l].b1*this.stages[l].z[0]+this.stages[l].b2*this.stages[l].z[1];return this.stages[l].z[1]=this.stages[l].z[0],this.stages[l].z[0]=u,p}reset(){for(let l=0;l<this.stages.length;l++)this.stages[l].z=[0,0]}}const kw={point:!1,linear:!1,cubic:!0,sinc:!0},Sd={IIR:16,FIR:71},Pw={IIR:Lw,FIR:Fw};function Dw(c,l,h,u={}){let p=(h-l)/l+1,_=new Float64Array(c.length*p);u.method=u.method||"cubic";let y=new Tw(c.length,_.length,{method:u.method,tension:u.tension||0,sincFilterSize:u.sincFilterSize||6,sincWindow:u.sincWindow||void 0});if(u.LPF===void 0&&(u.LPF=kw[u.method]),u.LPF){u.LPFType=u.LPFType||"IIR";const s=Pw[u.LPFType];if(h>l){let b=new s(u.LPFOrder||Sd[u.LPFType],h,l/2);Rw(c,_,y,b)}else{let b=new s(u.LPFOrder||Sd[u.LPFType],l,h/2);Mw(c,_,y,b)}}else tc(c,_,y);return _}function tc(c,l,h){for(let u=0,p=l.length;u<p;u++)l[u]=h.interpolate(u,c)}function Rw(c,l,h,u){for(let p=0,_=l.length;p<_;p++)l[p]=u.filter(h.interpolate(p,c));u.reset();for(let p=l.length-1;p>=0;p--)l[p]=u.filter(l[p])}function Mw(c,l,h,u){for(let p=0,_=c.length;p<_;p++)c[p]=u.filter(c[p]);u.reset();for(let p=c.length-1;p>=0;p--)c[p]=u.filter(c[p]);tc(c,l,h)}var Ow=Object.defineProperty,ec=c=>{throw TypeError(c)},Nw=(c,l,h)=>l in c?Ow(c,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):c[l]=h,fe=(c,l,h)=>Nw(c,typeof l!="symbol"?l+"":l,h),zh=(c,l,h)=>l.has(c)||ec("Cannot "+h),A=(c,l,h)=>(zh(c,l,"read from private field"),h?h.call(c):l.get(c)),st=(c,l,h)=>l.has(c)?ec("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(c):l.set(c,h),tt=(c,l,h,u)=>(zh(c,l,"write to private field"),l.set(c,h),h),Bi=(c,l,h)=>(zh(c,l,"access private method"),h);function Gw(c){if(c.format==="f32-planar"){const l=[];for(let h=0;h<c.numberOfChannels;h+=1){const u=c.allocationSize({planeIndex:h}),p=new ArrayBuffer(u);c.copyTo(p,{planeIndex:h}),l.push(new Float32Array(p))}return l}else if(c.format==="f32"){const l=new ArrayBuffer(c.allocationSize({planeIndex:0}));return c.copyTo(l,{planeIndex:0}),Yw(new Float32Array(l),c.numberOfChannels)}else if(c.format==="s16"){const l=new ArrayBuffer(c.allocationSize({planeIndex:0}));return c.copyTo(l,{planeIndex:0}),Hw(new Int16Array(l),c.numberOfChannels)}throw Error("Unsupported audio data format")}function Hw(c,l){const h=c.length/l,u=Array.from({length:l},()=>new Float32Array(h));for(let p=0;p<h;p++)for(let _=0;_<l;_++){const y=c[p*l+_];u[_][p]=y/32768}return u}function Yw(c,l){const h=c.length/l,u=Array.from({length:l},()=>new Float32Array(h));for(let p=0;p<h;p++)for(let _=0;_<l;_++)u[_][p]=c[p*l+_];return u}function ic(c){return Array(c.numberOfChannels).fill(0).map((l,h)=>c.getChannelData(h))}async function Vw(c,l){var h;const u={type:l,data:c},p=new ImageDecoder(u);await Promise.all([p.completed,p.tracks.ready]);let _=((h=p.tracks.selectedTrack)==null?void 0:h.frameCount)??1;const y=[];for(let s=0;s<_;s+=1)y.push((await p.decode({frameIndex:s})).image);return y}async function Ww(c,l,h){const u=c.length,p=Array(h.chanCount).fill(0).map(()=>new Float32Array(0));if(u===0)return p;const _=Math.max(...c.map(I=>I.length));if(_===0)return p;if(globalThis.OfflineAudioContext==null)return c.map(I=>new Float32Array(Dw(I,l,h.rate,{method:"sinc",LPF:!1})));const y=new globalThis.OfflineAudioContext(h.chanCount,_*h.rate/l,h.rate),s=y.createBufferSource(),b=y.createBuffer(u,_,l);return c.forEach((I,B)=>b.copyToChannel(I,B)),s.buffer=b,s.connect(y.destination),s.start(),ic(await y.startRendering())}function Fh(c){return new Promise(l=>{const h=Ih(()=>{h(),l()},c)})}function Ud(c,l,h){const u=h-l,p=new Float32Array(u);let _=0;for(;_<u;)p[_]=c[(l+_)%c.length],_+=1;return p}function nc(c,l){const h=Math.floor(c.length/l),u=new Float32Array(h);for(let p=0;p<h;p++){const _=p*l,y=Math.floor(_),s=_-y;y+1<c.length?u[p]=c[y]*(1-s)+c[y+1]*s:u[p]=c[y]}return u}const oe={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function $w(c,l){const h=l.videoTracks[0],u={};if(h!=null){const _=Xw(c.getTrackById(h.id)).buffer,{descKey:y,type:s}=h.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:h.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};y!==""&&(u.videoTrackConf={timescale:h.timescale,duration:h.duration,width:h.video.width,height:h.video.height,brands:l.brands,type:s,[y]:_}),u.videoDecoderConf={codec:h.codec,codedHeight:h.video.height,codedWidth:h.video.width,description:_}}const p=l.audioTracks[0];if(p!=null){const _=Ed(c);u.audioTrackConf={timescale:p.timescale,samplerate:p.audio.sample_rate,channel_count:p.audio.channel_count,hdlr:"soun",type:p.codec.startsWith("mp4a")?"mp4a":p.codec,description:Ed(c)},u.audioDecoderConf={codec:p.codec.startsWith("mp4a")?oe.codec:p.codec,numberOfChannels:p.audio.channel_count,sampleRate:p.audio.sample_rate,..._==null?{}:qw(_)}}return u}function Xw(c){for(const l of c.mdia.minf.stbl.stsd.entries){const h=l.avcC??l.hvcC??l.av1C??l.vpcC;if(h!=null){const u=new ah.DataStream(void 0,0,ah.DataStream.BIG_ENDIAN);return h.write(u),new Uint8Array(u.buffer.slice(8))}}throw Error("avcC, hvcC, av1C or VPX not found")}function Ed(c,l="mp4a"){var h;const u=(h=c.moov)==null?void 0:h.traks.map(p=>p.mdia.minf.stbl.stsd.entries).flat().find(({type:p})=>p===l);return u==null?void 0:u.esds}function qw(c){var l;const h=(l=c.esd.descs[0])==null?void 0:l.descs[0];if(h==null)return{};const[u,p]=h.data,_=((u&7)<<1)+(p>>7),y=(p&127)>>3;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][_],numberOfChannels:y}}async function jw(c,l,h){const u=ah.createFile(!1);u.onReady=_=>{var y,s;l({mp4boxFile:u,info:_});const b=(y=_.videoTracks[0])==null?void 0:y.id;b!=null&&u.setExtractionOptions(b,"video",{nbSamples:100});const I=(s=_.audioTracks[0])==null?void 0:s.id;I!=null&&u.setExtractionOptions(I,"audio",{nbSamples:100}),u.start()},u.onSamples=h,await p();async function p(){let _=0;const y=30*1024*1024;for(;;){const s=await c.read(y,{at:_});if(s.byteLength===0)break;s.fileStart=_;const b=u.appendBuffer(s);if(b==null)break;_=b}u.stop()}}let Lh=0;function Jl(c){return c.kind==="file"&&c.createReader instanceof Function}var hh,Ha,Ya,Oi,ei,Va,Ni,Xn,zs,Ir,rn,ii,Fs;const Kw=class Br{constructor(l,h={}){if(st(this,hh,Lh++),st(this,Ha,zt.create(`MP4Clip id:${A(this,hh)},`)),fe(this,"ready"),st(this,Ya,!1),st(this,Oi,{duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0}),st(this,ei),st(this,Va,1),st(this,Ni,[]),st(this,Xn,[]),st(this,zs,null),st(this,Ir,null),st(this,rn,{video:null,audio:null}),st(this,ii,{audio:!0}),fe(this,"tickInterceptor",async(p,_)=>_),st(this,Fs,new AbortController),!(l instanceof ReadableStream)&&!Jl(l)&&!Array.isArray(l.videoSamples))throw Error("Illegal argument");tt(this,ii,{audio:!0,...h}),tt(this,Va,typeof h.audio=="object"&&"volume"in h.audio?h.audio.volume:1);const u=async p=>(await Th(A(this,ei),p),A(this,ei));tt(this,ei,Jl(l)?l:"localFile"in l?l.localFile:rw()),this.ready=(l instanceof ReadableStream?u(l).then(p=>Cd(p,A(this,ii))):Jl(l)?Cd(l,A(this,ii)):Promise.resolve(l)).then(async({videoSamples:p,audioSamples:_,decoderConf:y})=>{tt(this,Ni,p),tt(this,Xn,_),tt(this,rn,y);const{videoFrameFinder:s,audioFrameFinder:b}=Jw({video:y.video==null?null:{...y.video,hardwareAcceleration:A(this,ii).__unsafe_hardwareAcceleration__},audio:y.audio},await A(this,ei).createReader(),p,_,A(this,ii).audio!==!1?A(this,Va):0);return tt(this,zs,s),tt(this,Ir,b),tt(this,Oi,Zw(y,p,_)),A(this,Ha).info("MP4Clip meta:",A(this,Oi)),{...A(this,Oi)}})}get meta(){return{...A(this,Oi)}}async tick(l){var h,u,p;if(l>=A(this,Oi).duration)return await this.tickInterceptor(l,{audio:await((h=A(this,Ir))==null?void 0:h.find(l))??[],state:"done"});const[_,y]=await Promise.all([((u=A(this,Ir))==null?void 0:u.find(l))??[],(p=A(this,zs))==null?void 0:p.find(l)]);return y==null?await this.tickInterceptor(l,{audio:_,state:"success"}):await this.tickInterceptor(l,{video:y,audio:_,state:"success"})}async thumbnails(l=100,h){A(this,Fs).abort(),tt(this,Fs,new AbortController);const u=A(this,Fs).signal;await this.ready;const p="generate thumbnails aborted";if(u.aborted)throw Error(p);const{width:_,height:y}=A(this,Oi),s=nx(l,Math.round(y*(l/_)),{quality:.1,type:"image/png"});return new Promise(async(b,I)=>{let B=[];const T=A(this,rn).video;if(T==null||A(this,Ni).length===0){U();return}u.addEventListener("abort",()=>{I(Error(p))});async function U(){u.aborted||b(await Promise.all(B.map(async a=>({ts:a.ts,img:await a.img}))))}function G(a){B.push({ts:a.timestamp,img:s(a)})}const{start:t=0,end:e=A(this,Oi).duration,step:n}=h??{};if(n){let a=t;const f=new rc(await A(this,ei).createReader(),A(this,Ni),{...T,hardwareAcceleration:A(this,ii).__unsafe_hardwareAcceleration__});for(;a<=e&&!u.aborted;){const g=await f.find(a);g&&G(g),a+=n}f.destroy(),U()}else await lx(A(this,Ni),A(this,ei),T,u,{start:t,end:e},(a,f)=>{a!=null&&G(a),f&&U()})})}async split(l){if(await this.ready,l<=0||l>=A(this,Oi).duration)throw Error('"time" out of bounds');const[h,u]=rx(A(this,Ni),l),[p,_]=sx(A(this,Xn),l),y=new Br({localFile:A(this,ei),videoSamples:h??[],audioSamples:p??[],decoderConf:A(this,rn)},A(this,ii)),s=new Br({localFile:A(this,ei),videoSamples:u??[],audioSamples:_??[],decoderConf:A(this,rn)},A(this,ii));return await Promise.all([y.ready,s.ready]),[y,s]}async clone(){await this.ready;const l=new Br({localFile:A(this,ei),videoSamples:[...A(this,Ni)],audioSamples:[...A(this,Xn)],decoderConf:A(this,rn)},A(this,ii));return await l.ready,l.tickInterceptor=this.tickInterceptor,l}async splitTrack(){await this.ready;const l=[];if(A(this,Ni).length>0){const h=new Br({localFile:A(this,ei),videoSamples:[...A(this,Ni)],audioSamples:[],decoderConf:{video:A(this,rn).video,audio:null}},A(this,ii));await h.ready,h.tickInterceptor=this.tickInterceptor,l.push(h)}if(A(this,Xn).length>0){const h=new Br({localFile:A(this,ei),videoSamples:[],audioSamples:[...A(this,Xn)],decoderConf:{audio:A(this,rn).audio,video:null}},A(this,ii));await h.ready,h.tickInterceptor=this.tickInterceptor,l.push(h)}return l}destroy(){var l,h;A(this,Ya)||(A(this,Ha).info("MP4Clip destroy"),tt(this,Ya,!0),(l=A(this,zs))==null||l.destroy(),(h=A(this,Ir))==null||h.destroy())}};hh=new WeakMap,Ha=new WeakMap,Ya=new WeakMap,Oi=new WeakMap,ei=new WeakMap,Va=new WeakMap,Ni=new WeakMap,Xn=new WeakMap,zs=new WeakMap,Ir=new WeakMap,rn=new WeakMap,ii=new WeakMap,Fs=new WeakMap;let kh=Kw;function Zw(c,l,h){const u={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};c.video!=null&&l.length>0&&(u.width=c.video.codedWidth??0,u.height=c.video.codedHeight??0),c.audio!=null&&h.length>0&&(u.audioSampleRate=oe.sampleRate,u.audioChanCount=oe.channelCount);let p=0,_=0;if(l.length>0)for(let y=l.length-1;y>=0;y--){const s=l[y];if(!s.deleted){p=s.cts+s.duration;break}}if(h.length>0){const y=h.at(-1);_=y.cts+y.duration}return u.duration=Math.max(p,_),u}function Jw(c,l,h,u,p){return{audioFrameFinder:p===0||c.audio==null||u.length===0?null:new tx(l,u,c.audio,{volume:p,targetSampleRate:oe.sampleRate}),videoFrameFinder:c.video==null||h.length===0?null:new rc(l,h,c.video)}}async function Cd(c,l={}){let h=null;const u={video:null,audio:null};let p=[],_=[],y=-1,s=-1;const b=await c.createReader();await jw(b,T=>{h=T.info;let{videoDecoderConf:U,audioDecoderConf:G}=$w(T.mp4boxFile,T.info);u.video=U??null,u.audio=G??null,U==null&&G==null&&zt.error("MP4Clip no video and audio track"),zt.info("mp4BoxFile moov ready",{...T.info,tracks:null,videoTracks:null,audioTracks:null},u)},(T,U,G)=>{if(U==="video"){y===-1&&(y=G[0].dts);for(const t of G)p.push(B(t,y,"video"))}else if(U==="audio"&&l.audio){s===-1&&(s=G[0].dts);for(const t of G)_.push(B(t,s,"audio"))}}),await b.close();const I=p.at(-1)??_.at(-1);if(h==null)throw Error("MP4Clip stream is done, but not emit ready");if(I==null)throw Error("MP4Clip stream not contain any sample");return ch(p),zt.info("mp4 stream parsed"),{videoSamples:p,audioSamples:_,decoderConf:u};function B(T,U=0,G){const t=G==="video"&&T.is_sync&&ox(T.data,T.description.type);let e=T.offset,n=T.size;if(t){const a=ax(T.data,T.description.type);e+=a,n-=a}return{...T,is_idr:t,offset:e,size:n,cts:(T.cts-U)/T.timescale*1e6,dts:(T.dts-U)/T.timescale*1e6,duration:T.duration/T.timescale*1e6,timescale:1e6,data:G==="video"?null:T.data}}}var Me,zr,Fr,Wa,Lr,sn,pi,En,qn,kr,Ls,jn,$a,Pr,Xa;class rc{constructor(l,h,u){st(this,Me,null),st(this,zr,0),st(this,Fr,{abort:!1,st:performance.now()}),fe(this,"find",async p=>{(A(this,Me)==null||A(this,Me).state==="closed"||p<=A(this,zr)||p-A(this,zr)>3e6)&&A(this,Pr).call(this,p),A(this,Fr).abort=!0,tt(this,zr,p),tt(this,Fr,{abort:!1,st:performance.now()});const _=await A(this,Ls).call(this,p,A(this,Me),A(this,Fr));return tt(this,kr,0),_}),st(this,Wa,0),st(this,Lr,!1),st(this,sn,0),st(this,pi,[]),st(this,En,0),st(this,qn,0),st(this,kr,0),st(this,Ls,async(p,_,y)=>{if(_==null||_.state==="closed"||y.abort)return null;if(A(this,pi).length>0){const s=A(this,pi)[0];return p<s.timestamp?null:(A(this,pi).shift(),p>s.timestamp+(s.duration??0)?(s.close(),await A(this,Ls).call(this,p,_,y)):(A(this,pi).length<10&&A(this,$a).call(this,_).catch(b=>{throw A(this,Pr).call(this,p),b}),s))}if(A(this,jn)||A(this,En)<A(this,qn)&&_.decodeQueueSize>0){if(performance.now()-y.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(A(this,Xa).call(this))}`);tt(this,kr,A(this,kr)+1),await Fh(15)}else{if(A(this,sn)>=this.samples.length)return null;try{await A(this,$a).call(this,_)}catch(s){throw A(this,Pr).call(this,p),s}}return await A(this,Ls).call(this,p,_,y)}),st(this,jn,!1),st(this,$a,async p=>{var _,y;if(A(this,jn)||p.decodeQueueSize>600)return;let s=A(this,sn)+1;if(s>this.samples.length)return;tt(this,jn,!0);let b=!1;for(;s<this.samples.length;s++){const I=this.samples[s];if(!b&&!I.deleted&&(b=!0),I.is_idr)break}if(b){const I=this.samples.slice(A(this,sn),s);if(((_=I[0])==null?void 0:_.is_idr)!==!0)zt.warn("First sample not idr frame");else{const B=performance.now(),T=await sc(I,this.localFileReader),U=performance.now()-B;if(U>1e3){const G=I[0],t=I.at(-1),e=t.offset+t.size-G.offset;zt.warn(`Read video samples time cost: ${Math.round(U)}ms, file chunk size: ${e}`)}if(p.state==="closed")return;tt(this,Wa,((y=T[0])==null?void 0:y.duration)??0),dh(p,T,{onDecodingError:G=>{if(A(this,Lr))throw G;A(this,En)===0&&(tt(this,Lr,!0),zt.warn("Downgrade to software decode"),A(this,Pr).call(this))}}),tt(this,qn,A(this,qn)+T.length)}}tt(this,sn,s),tt(this,jn,!1)}),st(this,Pr,p=>{var _,y;if(tt(this,jn,!1),A(this,pi).forEach(b=>b.close()),tt(this,pi,[]),p==null||p===0)tt(this,sn,0);else{let b=0;for(let I=0;I<this.samples.length;I++){const B=this.samples[I];if(B.is_idr&&(b=I),!(B.cts<p)){tt(this,sn,b);break}}}tt(this,qn,0),tt(this,En,0),((_=A(this,Me))==null?void 0:_.state)!=="closed"&&((y=A(this,Me))==null||y.close());const s={...this.conf,...A(this,Lr)?{hardwareAcceleration:"prefer-software"}:{}};tt(this,Me,new VideoDecoder({output:b=>{if(tt(this,En,A(this,En)+1),b.timestamp===-1){b.close();return}let I=b;b.duration==null&&(I=new VideoFrame(b,{duration:A(this,Wa)}),b.close()),A(this,pi).push(I)},error:b=>{if(b.message.includes("Codec reclaimed due to inactivity")){tt(this,Me,null);return}const I=`VideoFinder VideoDecoder err: ${b.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify(A(this,Xa).call(this))}`;throw zt.error(I),Error(I)}})),A(this,Me).configure(s)}),st(this,Xa,()=>{var p,_;return{time:A(this,zr),decState:(p=A(this,Me))==null?void 0:p.state,decQSize:(_=A(this,Me))==null?void 0:_.decodeQueueSize,decCusorIdx:A(this,sn),sampleLen:this.samples.length,inputCnt:A(this,qn),outputCnt:A(this,En),cacheFrameLen:A(this,pi).length,softDeocde:A(this,Lr),clipIdCnt:Lh,sleepCnt:A(this,kr),memInfo:ac()}}),fe(this,"destroy",()=>{var p,_;((p=A(this,Me))==null?void 0:p.state)!=="closed"&&((_=A(this,Me))==null||_.close()),tt(this,Me,null),A(this,Fr).abort=!0,A(this,pi).forEach(y=>y.close()),tt(this,pi,[]),this.localFileReader.close()}),this.localFileReader=l,this.samples=h,this.conf=u}}Me=new WeakMap,zr=new WeakMap,Fr=new WeakMap,Wa=new WeakMap,Lr=new WeakMap,sn=new WeakMap,pi=new WeakMap,En=new WeakMap,qn=new WeakMap,kr=new WeakMap,Ls=new WeakMap,jn=new WeakMap,$a=new WeakMap,Pr=new WeakMap,Xa=new WeakMap;function Qw(c,l){for(let h=0;h<l.length;h++){const u=l[h];if(c>=u.cts&&c<u.cts+u.duration)return h;if(u.cts>c)break}return 0}var qa,ja,Gi,Dr,an,Cn,Ai,Rr,Ka,Za,uh,fh;class tx{constructor(l,h,u,p){st(this,qa,1),st(this,ja),st(this,Gi,null),st(this,Dr,{abort:!1,st:performance.now()}),fe(this,"find",async _=>{const y=_<=A(this,an)||_-A(this,an)>1e5;(A(this,Gi)==null||A(this,Gi).state==="closed"||y)&&A(this,uh).call(this),y&&(tt(this,an,_),tt(this,Cn,Qw(_,this.samples))),A(this,Dr).abort=!0;const s=_-A(this,an);tt(this,an,_),tt(this,Dr,{abort:!1,st:performance.now()});const b=await A(this,Ka).call(this,Math.ceil(s*(A(this,ja)/1e6)),A(this,Gi),A(this,Dr));return tt(this,Rr,0),b}),st(this,an,0),st(this,Cn,0),st(this,Ai,{frameCnt:0,data:[]}),st(this,Rr,0),st(this,Ka,async(_,y=null,s)=>{if(y==null||s.abort||y.state==="closed"||_===0)return[];const b=A(this,Ai).frameCnt-_;if(b>0)return b<oe.sampleRate/10&&A(this,Za).call(this,y),Ad(A(this,Ai),_);if(y.decoding){if(performance.now()-s.st>3e3)throw s.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(A(this,fh).call(this))}`);tt(this,Rr,A(this,Rr)+1),await Fh(15)}else{if(A(this,Cn)>=this.samples.length-1)return Ad(A(this,Ai),A(this,Ai).frameCnt);A(this,Za).call(this,y)}return A(this,Ka).call(this,_,y,s)}),st(this,Za,_=>{if(_.decodeQueueSize>10)return;const y=[];let s=A(this,Cn);for(;s<this.samples.length;){const b=this.samples[s];if(s+=1,!b.deleted&&(y.push(b),y.length>=10))break}tt(this,Cn,s),_.decode(y.map(b=>new EncodedAudioChunk({type:"key",timestamp:b.cts,duration:b.duration,data:b.data})))}),st(this,uh,()=>{var _;tt(this,an,0),tt(this,Cn,0),tt(this,Ai,{frameCnt:0,data:[]}),(_=A(this,Gi))==null||_.close(),tt(this,Gi,ex(this.conf,{resampleRate:oe.sampleRate,volume:A(this,qa)},y=>{A(this,Ai).data.push(y),A(this,Ai).frameCnt+=y[0].length}))}),st(this,fh,()=>{var _,y;return{time:A(this,an),decState:(_=A(this,Gi))==null?void 0:_.state,decQSize:(y=A(this,Gi))==null?void 0:y.decodeQueueSize,decCusorIdx:A(this,Cn),sampleLen:this.samples.length,pcmLen:A(this,Ai).frameCnt,clipIdCnt:Lh,sleepCnt:A(this,Rr),memInfo:ac()}}),fe(this,"destroy",()=>{tt(this,Gi,null),A(this,Dr).abort=!0,tt(this,Ai,{frameCnt:0,data:[]}),this.localFileReader.close()}),this.localFileReader=l,this.samples=h,this.conf=u,tt(this,qa,p.volume),tt(this,ja,p.targetSampleRate)}}qa=new WeakMap,ja=new WeakMap,Gi=new WeakMap,Dr=new WeakMap,an=new WeakMap,Cn=new WeakMap,Ai=new WeakMap,Rr=new WeakMap,Ka=new WeakMap,Za=new WeakMap,uh=new WeakMap,fh=new WeakMap;function ex(c,l,h){let u=0,p=0;const _=B=>{if(p+=1,B.length!==0){if(l.volume!==1)for(const T of B)for(let U=0;U<T.length;U++)T[U]*=l.volume;B.length===1&&(B=[B[0],B[0]]),h(B)}},y=ix(_),s=l.resampleRate!==c.sampleRate;let b=new AudioDecoder({output:B=>{const T=Gw(B);s?y(()=>Ww(T,B.sampleRate,{rate:l.resampleRate,chanCount:B.numberOfChannels})):_(T),B.close()},error:B=>{B.message.includes("Codec reclaimed due to inactivity")||I("MP4Clip AudioDecoder err",B)}});b.configure(c);function I(B,T){const U=`${B}: ${T.message}, state: ${JSON.stringify({qSize:b.decodeQueueSize,state:b.state,inputCnt:u,outputCnt:p})}`;throw zt.error(U),Error(U)}return{decode(B){u+=B.length;try{for(const T of B)b.decode(T)}catch(T){I("decode audio chunk error",T)}},close(){b.state!=="closed"&&b.close()},get decoding(){return u>p&&b.decodeQueueSize>0},get state(){return b.state},get decodeQueueSize(){return b.decodeQueueSize}}}function ix(c){const l=[];let h=0;function u(y,s){l[s]=y,p()}function p(){const y=l[h];y!=null&&(c(y),h+=1,p())}let _=0;return y=>{const s=_;_+=1,y().then(b=>u(b,s)).catch(b=>u(b,s))}}function Ad(c,l){const h=[new Float32Array(l),new Float32Array(l)];let u=0,p=0;for(;p<c.data.length;){const[_,y]=c.data[p];if(u+_.length>l){const s=l-u;h[0].set(_.subarray(0,s),u),h[1].set(y.subarray(0,s),u),c.data[p][0]=_.subarray(s,_.length),c.data[p][1]=y.subarray(s,y.length);break}else h[0].set(_,u),h[1].set(y,u),u+=_.length,p++}return c.data=c.data.slice(p),c.frameCnt-=l,h}async function sc(c,l){const h=c[0],u=c.at(-1);if(u==null)return[];const p=u.offset+u.size-h.offset;if(p<3e7){const _=new Uint8Array(await l.read(p,{at:h.offset}));return c.map(y=>{const s=y.offset-h.offset;return new EncodedVideoChunk({type:y.is_sync?"key":"delta",timestamp:y.cts,duration:y.duration,data:_.subarray(s,s+y.size)})})}return await Promise.all(c.map(async _=>new EncodedVideoChunk({type:_.is_sync?"key":"delta",timestamp:_.cts,duration:_.duration,data:await l.read(_.size,{at:_.offset})})))}function nx(c,l,h){const u=new OffscreenCanvas(c,l),p=u.getContext("2d");return async _=>(p.drawImage(_,0,0,c,l),_.close(),await u.convertToBlob(h))}function rx(c,l){if(c.length===0)return[];let h=0,u=0,p=-1;for(let b=0;b<c.length;b++){const I=c[b];if(p===-1&&l<I.cts&&(p=b-1),I.is_idr)if(p===-1)h=b;else{u=b;break}}const _=c[p];if(_==null)throw Error("Not found video sample by time");const y=c.slice(0,u===0?c.length:u).map(b=>({...b}));for(let b=h;b<y.length;b++){const I=y[b];l<I.cts&&(I.deleted=!0,I.cts=-1)}ch(y);const s=c.slice(_.is_idr?p:h).map(b=>({...b,cts:b.cts-l}));for(const b of s)b.cts<0&&(b.deleted=!0,b.cts=-1);return ch(s),[y,s]}function sx(c,l){if(c.length===0)return[];let h=-1;for(let _=0;_<c.length;_++){const y=c[_];if(!(l>y.cts)){h=_;break}}if(h===-1)throw Error("Not found audio sample by time");const u=c.slice(0,h).map(_=>({..._})),p=c.slice(h).map(_=>({..._,cts:_.cts-l}));return[u,p]}function dh(c,l,h){let u=0;if(c.state==="configured"){for(;u<l.length;u++)c.decode(l[u]);c.flush().catch(p=>{if(!(p instanceof Error))throw p;if(p.message.includes("Decoding error")&&h.onDecodingError!=null){h.onDecodingError(p);return}if(!p.message.includes("Aborted due to close"))throw p})}}function ax(c,l){if(l!=="avc1"&&l!=="hvc1")return 0;const h=new DataView(c.buffer);if(l==="avc1"&&(h.getUint8(4)&31)===6)return h.getUint32(0)+4;if(l==="hvc1"){const u=h.getUint8(4)>>1&63;if(u===39||u===40)return h.getUint32(0)+4}return 0}function ox(c,l){if(l!=="avc1"&&l!=="hvc1")return!0;const h=new DataView(c.buffer);let u=0;for(;u<c.byteLength-4;){if(l==="avc1"&&(h.getUint8(u+4)&31)===5)return!0;if(l==="hvc1"){const p=h.getUint8(u+4)>>1&63;if(p===19||p===20)return!0}u+=h.getUint32(u)+4}return!1}async function lx(c,l,h,u,p,_){const y=await l.createReader(),s=await sc(c.filter(B=>!B.deleted&&B.is_sync&&B.cts>=p.start&&B.cts<=p.end),y);if(s.length===0||u.aborted)return;let b=0;dh(I(),s,{onDecodingError:B=>{zt.warn("thumbnailsByKeyFrame",B),b===0?dh(I(!0),s,{onDecodingError:T=>{y.close(),zt.error("thumbnailsByKeyFrame retry soft deocde",T)}}):(_(null,!0),y.close())}});function I(B=!1){const T={...h,...B?{hardwareAcceleration:"prefer-software"}:{}},U=new VideoDecoder({output:G=>{b+=1;const t=b===s.length;_(G,t),t&&(y.close(),U.state!=="closed"&&U.close())},error:G=>{const t=`thumbnails decoder error: ${G.message}, config: ${JSON.stringify(T)}, state: ${JSON.stringify({qSize:U.decodeQueueSize,state:U.state,outputCnt:b,inputCnt:s.length})}`;throw zt.error(t),Error(t)}});return u.addEventListener("abort",()=>{y.close(),U.state!=="closed"&&U.close()}),U.configure(T),U}}function ch(c){let l=0,h=null;for(const u of c)if(!u.deleted){if(u.is_sync&&(l+=1),l>=2)break;(h==null||u.cts<h.cts)&&(h=u)}h!=null&&h.cts<2e5&&(h.duration+=h.cts,h.cts=0)}function ac(){try{const c=performance.memory;return{jsHeapSizeLimit:c.jsHeapSizeLimit,totalJSHeapSize:c.totalJSHeapSize,usedJSHeapSize:c.usedJSHeapSize,percentUsed:(c.usedJSHeapSize/c.jsHeapSizeLimit).toFixed(3),percentTotal:(c.totalJSHeapSize/c.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}var We,Ti,Le,ph,oc;const hx=class Mr{constructor(l){st(this,ph),fe(this,"ready"),st(this,We,{duration:0,width:0,height:0}),st(this,Ti,null),st(this,Le,[]);const h=u=>(tt(this,Ti,u),A(this,We).width=u.width,A(this,We).height=u.height,A(this,We).duration=1/0,{...A(this,We)});if(l instanceof ReadableStream)this.ready=new Response(l).blob().then(u=>createImageBitmap(u)).then(h);else if(l instanceof ImageBitmap)this.ready=Promise.resolve(h(l));else if(Array.isArray(l)&&l.every(u=>u instanceof VideoFrame)){tt(this,Le,l);const u=A(this,Le)[0];if(u==null)throw Error("The frame count must be greater than 0");tt(this,We,{width:u.displayWidth,height:u.displayHeight,duration:A(this,Le).reduce((p,_)=>p+(_.duration??0),0)}),this.ready=Promise.resolve({...A(this,We),duration:1/0})}else if("type"in l)this.ready=Bi(this,ph,oc).call(this,l.stream,l.type).then(()=>({width:A(this,We).width,height:A(this,We).height,duration:1/0}));else throw Error("Illegal arguments")}get meta(){return{...A(this,We)}}async tick(l){if(A(this,Ti)!=null)return{video:await createImageBitmap(A(this,Ti)),state:"success"};const h=l%A(this,We).duration;return{video:(A(this,Le).find(u=>h>=u.timestamp&&h<=u.timestamp+(u.duration??0))??A(this,Le)[0]).clone(),state:"success"}}async split(l){if(await this.ready,A(this,Ti)!=null)return[new Mr(await createImageBitmap(A(this,Ti))),new Mr(await createImageBitmap(A(this,Ti)))];let h=-1;for(let _=0;_<A(this,Le).length;_++){const y=A(this,Le)[_];if(!(l>y.timestamp)){h=_;break}}if(h===-1)throw Error("Not found frame by time");const u=A(this,Le).slice(0,h).map(_=>new VideoFrame(_)),p=A(this,Le).slice(h).map(_=>new VideoFrame(_,{timestamp:_.timestamp-l}));return[new Mr(u),new Mr(p)]}async clone(){await this.ready;const l=A(this,Ti)==null?A(this,Le).map(h=>h.clone()):await createImageBitmap(A(this,Ti));return new Mr(l)}destroy(){var l;zt.info("ImgClip destroy"),(l=A(this,Ti))==null||l.close(),A(this,Le).forEach(h=>h.close())}};We=new WeakMap,Ti=new WeakMap,Le=new WeakMap,ph=new WeakSet,oc=async function(c,l){tt(this,Le,await Vw(c,l));const h=A(this,Le)[0];if(h==null)throw Error("No frame available in gif");tt(this,We,{duration:A(this,Le).reduce((u,p)=>u+(p.duration??0),0),width:h.codedWidth,height:h.codedHeight}),zt.info("ImgClip ready:",A(this,We))};let vo=hx;var Xr,In,ir,hn,_h,lc,Kn,on;const ks=class Ja{constructor(l,h={}){st(this,_h),fe(this,"ready"),st(this,Xr,{duration:0,width:0,height:0}),st(this,In,new Float32Array),st(this,ir,new Float32Array),st(this,hn),st(this,Kn,0),st(this,on,0),tt(this,hn,{loop:!1,volume:1,...h}),this.ready=Bi(this,_h,lc).call(this,l).then(()=>({width:0,height:0,duration:h.loop?1/0:A(this,Xr).duration}))}get meta(){return{...A(this,Xr),sampleRate:oe.sampleRate,chanCount:2}}getPCMData(){return[A(this,In),A(this,ir)]}async tick(l){if(!A(this,hn).loop&&l>=A(this,Xr).duration)return{audio:[],state:"done"};const h=l-A(this,Kn);if(l<A(this,Kn)||h>3e6)return tt(this,Kn,l),tt(this,on,Math.ceil(A(this,Kn)/1e6*oe.sampleRate)),{audio:[new Float32Array(0),new Float32Array(0)],state:"success"};tt(this,Kn,l);const u=Math.ceil(h/1e6*oe.sampleRate),p=A(this,on)+u,_=A(this,hn).loop?[Ud(A(this,In),A(this,on),p),Ud(A(this,ir),A(this,on),p)]:[A(this,In).slice(A(this,on),p),A(this,ir).slice(A(this,on),p)];return tt(this,on,p),{audio:_,state:"success"}}async split(l){await this.ready;const h=Math.ceil(l/1e6*oe.sampleRate),u=new Ja(this.getPCMData().map(_=>_.slice(0,h)),A(this,hn)),p=new Ja(this.getPCMData().map(_=>_.slice(h)),A(this,hn));return[u,p]}async clone(){await this.ready;const l=new Ja(this.getPCMData(),A(this,hn));return await l.ready,l}destroy(){tt(this,In,new Float32Array(0)),tt(this,ir,new Float32Array(0)),zt.info("---- audioclip destroy ----")}};Xr=new WeakMap,In=new WeakMap,ir=new WeakMap,hn=new WeakMap,_h=new WeakSet,lc=async function(c){ks.ctx==null&&(ks.ctx=new AudioContext({sampleRate:oe.sampleRate}));const l=performance.now(),h=c instanceof ReadableStream?await ux(c,ks.ctx):c;zt.info("Audio clip decoded complete:",performance.now()-l);const u=A(this,hn).volume;if(u!==1)for(const p of h)for(let _=0;_<p.length;_+=1)p[_]*=u;A(this,Xr).duration=h[0].length/oe.sampleRate*1e6,tt(this,In,h[0]),tt(this,ir,h[1]??A(this,In)),zt.info("Audio clip convert to AudioData, time:",performance.now()-l)},Kn=new WeakMap,on=new WeakMap,fe(ks,"ctx",null);let Ph=ks;async function ux(c,l){const h=await new Response(c).arrayBuffer();return ic(await l.decodeAudioData(h))}var Or,Qa,Nr,Ps;const hc=class uc{constructor(l){fe(this,"ready"),st(this,Or,{duration:0,width:0,height:0}),st(this,Qa,()=>{}),fe(this,"audioTrack"),st(this,Nr,null),st(this,Ps),tt(this,Ps,l);const h=l.getVideoTracks()[0];if(h!=null){const{width:u,height:p}=h.getSettings();h.contentHint="motion",A(this,Or).width=u??0,A(this,Or).height=p??0,tt(this,Nr,new OffscreenCanvas(u??0,p??0)),tt(this,Qa,dx(A(this,Nr).getContext("2d"),h))}this.audioTrack=l.getAudioTracks()[0]??null,A(this,Or).duration=1/0,this.ready=Promise.resolve(this.meta)}get meta(){return{...A(this,Or)}}async tick(){return{video:A(this,Nr)==null?null:await createImageBitmap(A(this,Nr)),audio:[],state:"success"}}async split(){return[await this.clone(),await this.clone()]}async clone(){return new uc(A(this,Ps).clone())}destroy(){A(this,Ps).getTracks().forEach(l=>l.stop()),A(this,Qa).call(this)}};Or=new WeakMap,Qa=new WeakMap,Nr=new WeakMap,Ps=new WeakMap,fe(hc,"ctx",null);let fx=hc;function dx(c,l){return pw(new MediaStreamTrackProcessor({track:l}).readable,{onChunk:async h=>{c.drawImage(h,0,0),h.close()},onDone:async()=>{}})}var yo,wo,xo,bo,So,Uo,Zn,Gr,Jn;const cx=class fc{constructor(l,h,u,p,_){st(this,Zn),st(this,yo,new hr),fe(this,"on",A(this,yo).on),st(this,wo,0),st(this,xo,0),st(this,bo,0),st(this,So,0),st(this,Uo,0),st(this,Jn,null),fe(this,"fixedAspectRatio",!1),fe(this,"fixedScaleCenter",!1),this.x=l??0,this.y=h??0,this.w=u??0,this.h=p??0,tt(this,Jn,_??null)}get x(){return A(this,wo)}set x(l){Bi(this,Zn,Gr).call(this,"x",l)}get y(){return A(this,xo)}set y(l){Bi(this,Zn,Gr).call(this,"y",l)}get w(){return A(this,bo)}set w(l){Bi(this,Zn,Gr).call(this,"w",l)}get h(){return A(this,So)}set h(l){Bi(this,Zn,Gr).call(this,"h",l)}get angle(){return A(this,Uo)}set angle(l){Bi(this,Zn,Gr).call(this,"angle",l)}get center(){const{x:l,y:h,w:u,h:p}=this;return{x:l+u/2,y:h+p/2}}clone(){const{x:l,y:h,w:u,h:p}=this,_=new fc(l,h,u,p,A(this,Jn));return _.angle=this.angle,_.fixedAspectRatio=this.fixedAspectRatio,_.fixedScaleCenter=this.fixedScaleCenter,_}checkHit(l,h){var u,p;let{angle:_,center:y,x:s,y:b,w:I,h:B}=this;const T=((u=A(this,Jn))==null?void 0:u.center)??y,U=((p=A(this,Jn))==null?void 0:p.angle)??_;A(this,Jn)==null&&(s=s-T.x,b=b-T.y);const G=l-T.x,t=h-T.y;let e=G,n=t;return U!==0&&(e=G*Math.cos(U)+t*Math.sin(U),n=t*Math.cos(U)-G*Math.sin(U)),!(e<s||e>s+I||n<b||n>b+B)}};yo=new WeakMap,wo=new WeakMap,xo=new WeakMap,bo=new WeakMap,So=new WeakMap,Uo=new WeakMap,Zn=new WeakSet,Gr=function(c,l){const h=this[c]!==l;switch(c){case"x":tt(this,wo,l);break;case"y":tt(this,xo,l);break;case"w":tt(this,bo,l);break;case"h":tt(this,So,l);break;case"angle":tt(this,Uo,l);break}h&&A(this,yo).emit("propsChange",{[c]:l})},Jn=new WeakMap;let Hi=cx;var to,Hr,Ds,Qn,ln;class dc{constructor(){fe(this,"rect",new Hi),st(this,to,{offset:0,duration:0,playbackRate:1}),st(this,Hr,new hr),fe(this,"on",A(this,Hr).on),st(this,Ds,0),fe(this,"opacity",1),fe(this,"flip",null),st(this,Qn,null),st(this,ln,null),fe(this,"ready",Promise.resolve()),this.rect.on("propsChange",l=>{A(this,Hr).emit("propsChange",{rect:l})})}get time(){return A(this,to)}set time(l){Object.assign(A(this,to),l)}get zIndex(){return A(this,Ds)}set zIndex(l){const h=A(this,Ds)!==l;tt(this,Ds,l),h&&A(this,Hr).emit("propsChange",{zIndex:l})}_render(l){const{rect:{center:h,angle:u}}=this;l.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,h.x,h.y),l.rotate((this.flip==null?1:-1)*u),l.globalAlpha=this.opacity}setAnimation(l,h){tt(this,Qn,Object.entries(l).map(([u,p])=>{const _={from:0,to:100}[u]??Number(u.slice(0,-1));if(isNaN(_)||_>100||_<0)throw Error("keyFrame must between 0~100");return[_/100,p]})),tt(this,ln,Object.assign({},A(this,ln),{duration:h.duration,delay:h.delay??0,iterCount:h.iterCount??1/0}))}animate(l){if(A(this,Qn)==null||A(this,ln)==null||l<A(this,ln).delay)return;const h=px(l,A(this,Qn),A(this,ln));for(const u in h)switch(u){case"opacity":this.opacity=h[u];break;case"x":case"y":case"w":case"h":case"angle":this.rect[u]=h[u];break}}copyStateTo(l){tt(l,Qn,A(this,Qn)),tt(l,ln,A(this,ln)),l.zIndex=this.zIndex,l.opacity=this.opacity,l.flip=this.flip,l.rect=this.rect.clone(),l.time={...this.time}}destroy(){A(this,Hr).destroy()}}to=new WeakMap,Hr=new WeakMap,Ds=new WeakMap,Qn=new WeakMap,ln=new WeakMap;function px(c,l,h){const u=c-h.delay;if(u/h.duration>=h.iterCount)return{};const p=u%h.duration,_=u===h.duration?1:p/h.duration,y=l.findIndex(G=>G[0]>=_);if(y===-1)return{};const s=l[y-1],b=l[y],I=b[1];if(s==null)return I;const B=s[1],T={},U=(_-s[0])/(b[0]-s[0]);for(const G in I){const t=G;B[t]!=null&&(T[t]=(I[t]-B[t])*U+B[t])}return T}var Yr,tr,eo;const _x=class cc extends dc{constructor(l){super(),st(this,Yr),st(this,tr,null),st(this,eo,!1),tt(this,Yr,l),this.ready=l.ready.then(({width:h,height:u,duration:p})=>{this.rect.w=this.rect.w===0?h:this.rect.w,this.rect.h=this.rect.h===0?u:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}async offscreenRender(l,h){var u;const p=h*this.time.playbackRate;this.animate(p),super._render(l);const{w:_,h:y}=this.rect,{video:s,audio:b,state:I}=await A(this,Yr).tick(p);let B=b??[];if(b!=null&&this.time.playbackRate!==1&&(B=b.map(U=>nc(U,this.time.playbackRate))),I==="done")return{audio:B,done:!0};const T=s??A(this,tr);return T!=null&&l.drawImage(T,-_/2,-y/2,_,y),s!=null&&((u=A(this,tr))==null||u.close(),tt(this,tr,s)),{audio:B,done:!1}}async clone(){const l=new cc(await A(this,Yr).clone());return await l.ready,this.copyStateTo(l),l}destroy(){var l;A(this,eo)||(tt(this,eo,!0),zt.info("OffscreenSprite destroy"),super.destroy(),(l=A(this,tr))==null||l.close(),tt(this,tr,null),A(this,Yr).destroy())}};Yr=new WeakMap,tr=new WeakMap,eo=new WeakMap;let gx=_x;var qr,ar,Qr,Rs,io,gh,no,ro;const mx=class pc extends dc{constructor(l){super(),st(this,io),st(this,qr),fe(this,"visible",!0),st(this,ar,null),st(this,Qr,[]),st(this,Rs,!1),st(this,no,-1),st(this,ro,!1),tt(this,qr,l),this.ready=l.ready.then(({width:h,height:u,duration:p})=>{this.rect.w=this.rect.w===0?h:this.rect.w,this.rect.h=this.rect.h===0?u:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}getClip(){return A(this,qr)}preFrame(l){Bi(this,io,gh).call(this,l)}render(l,h){this.animate(h),super._render(l);const{w:u,h:p}=this.rect;A(this,no)!==h&&Bi(this,io,gh).call(this,h),tt(this,no,h);const _=A(this,Qr);tt(this,Qr,[]);const y=A(this,ar);return y!=null&&l.drawImage(y,-u/2,-p/2,u,p),{audio:_}}copyStateTo(l){super.copyStateTo(l),l instanceof pc&&(l.visible=this.visible)}destroy(){var l;A(this,ro)||(tt(this,ro,!0),zt.info("VisibleSprite destroy"),super.destroy(),(l=A(this,ar))==null||l.close(),tt(this,ar,null),A(this,qr).destroy())}};qr=new WeakMap,ar=new WeakMap,Qr=new WeakMap,Rs=new WeakMap,io=new WeakSet,gh=function(c){A(this,Rs)||(tt(this,Rs,!0),A(this,qr).tick(c*this.time.playbackRate).then(({video:l,audio:h})=>{var u;l!=null&&((u=A(this,ar))==null||u.close(),tt(this,ar,l??null)),tt(this,Qr,h??[]),h!=null&&this.time.playbackRate!==1&&tt(this,Qr,h.map(p=>nc(p,this.time.playbackRate)))}).finally(()=>{tt(this,Rs,!1)}))},no=new WeakMap,ro=new WeakMap;let Ma=mx,vx=0;async function _c(c){c()>50&&(await Fh(15),await _c(c))}var un,so,Yi,Os,Eo,ao,jr,Ns,er,oo,gc,mc;class yx{constructor(l={}){st(this,oo),st(this,un,zt.create(`id:${vx++},`)),st(this,so,!1),st(this,Yi,[]),st(this,Os),st(this,Eo),st(this,ao,null),st(this,jr),st(this,Ns),st(this,er,new hr),fe(this,"on",A(this,er).on);const{width:h=0,height:u=0}=l;tt(this,Os,new OffscreenCanvas(h,u));const p=A(this,Os).getContext("2d",{alpha:!1});if(p==null)throw Error("Can not create 2d offscreen context");tt(this,Eo,p),tt(this,jr,Object.assign({bgColor:"#000",width:0,height:0,videoCodec:"avc1.42E032",audio:!0,bitrate:5e6,fps:30,metaDataTags:null},l)),tt(this,Ns,h*u>0)}static async isSupported(l={}){return(self.OffscreenCanvas!=null&&self.VideoEncoder!=null&&self.VideoDecoder!=null&&self.VideoFrame!=null&&self.AudioEncoder!=null&&self.AudioDecoder!=null&&self.AudioData!=null&&((await self.VideoEncoder.isConfigSupported({codec:l.videoCodec??"avc1.42E032",width:l.width??1920,height:l.height??1080,bitrate:l.bitrate??7e6})).supported??!1)&&(await self.AudioEncoder.isConfigSupported({codec:oe.codec,sampleRate:oe.sampleRate,numberOfChannels:oe.channelCount})).supported)??!1}async addSprite(l,h={}){const u={rect:Sx(["x","y","w","h"],l.rect),time:{...l.time},zIndex:l.zIndex};A(this,un).info("Combinator add sprite",u);const p=await l.clone();A(this,un).info("Combinator add sprite ready"),A(this,Yi).push(Object.assign(p,{main:h.main??!1,expired:!1})),A(this,Yi).sort((_,y)=>_.zIndex-y.zIndex)}output(){if(A(this,Yi).length===0)throw Error("No sprite added");const l=A(this,Yi).find(b=>b.main),h=l!=null?l.time.offset+l.time.duration:Math.max(...A(this,Yi).map(b=>b.time.offset+b.time.duration));if(h===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");h===-1&&A(this,un).warn("Unable to determine the end time, process value don't update"),A(this,un).info(`start combinate video, maxTime:${h}`);const u=Bi(this,oo,gc).call(this,h);let p=performance.now();const _=Bi(this,oo,mc).call(this,u,h,{onProgress:b=>{A(this,un).debug("OutputProgress:",b),A(this,er).emit("OutputProgress",b)},onEnded:async()=>{await u.flush(),A(this,un).info("===== output ended =====, cost:",performance.now()-p),A(this,er).emit("OutputProgress",1),this.destroy()},onError:b=>{A(this,er).emit("error",b),s(b),this.destroy()}});tt(this,ao,()=>{_(),u.close(),s()});const{stream:y,stop:s}=_w(u.mp4file,500,this.destroy);return y}destroy(){var l;A(this,so)||(tt(this,so,!0),(l=A(this,ao))==null||l.call(this),A(this,er).destroy())}}un=new WeakMap,so=new WeakMap,Yi=new WeakMap,Os=new WeakMap,Eo=new WeakMap,ao=new WeakMap,jr=new WeakMap,Ns=new WeakMap,er=new WeakMap,oo=new WeakSet,gc=function(c){const{fps:l,width:h,height:u,videoCodec:p,bitrate:_,audio:y,metaDataTags:s}=A(this,jr);return Sw({video:A(this,Ns)?{width:h,height:u,expectFPS:l,codec:p,bitrate:_,__unsafe_hardwareAcceleration__:A(this,jr).__unsafe_hardwareAcceleration__}:null,audio:y===!1?null:{codec:"aac",sampleRate:oe.sampleRate,channelCount:oe.channelCount},duration:c,metaDataTags:s})},mc=function(c,l,{onProgress:h,onEnded:u,onError:p}){let _=0;const y={aborted:!1};let s=null;(async()=>{const{fps:B,bgColor:T,audio:U}=A(this,jr),G=Math.round(1e6/B),t=A(this,Eo),e=wx({ctx:t,bgColor:T,sprites:A(this,Yi),aborter:y}),n=xx({remux:c,ctx:t,cvs:A(this,Os),outputAudio:U,hasVideoTrack:A(this,Ns),timeSlice:G});let a=0;for(;;){if(s!=null)return;if(y.aborted||l!==-1&&a>l||A(this,Yi).length===0){I(),await u();return}_=a/l;const{audios:f,mainSprDone:g}=await e(a);if(g){I(),await u();return}if(y.aborted)return;n(a,f),a+=G,await _c(c.getEncodeQueueSize)}})().catch(B=>{s=B,A(this,un).error(B),I(),p(B)});const b=setInterval(()=>{h(_)},500),I=()=>{y.aborted||(y.aborted=!0,clearInterval(b),A(this,Yi).forEach(B=>B.destroy()))};return I};function wx(c){const{ctx:l,bgColor:h,sprites:u,aborter:p}=c,{width:_,height:y}=l.canvas;return async s=>{l.fillStyle=h,l.fillRect(0,0,_,y);const b=[];let I=!1;for(const B of u){if(p.aborted)break;if(s<B.time.offset||B.expired)continue;l.save();const{audio:T,done:U}=await B.offscreenRender(l,s-B.time.offset);b.push(T),l.restore(),(B.time.duration>0&&s>B.time.offset+B.time.duration||U)&&(B.main&&(I=!0),B.destroy(),B.expired=!0)}return{audios:b,mainSprDone:I}}}function xx(c){const{ctx:l,cvs:h,outputAudio:u,remux:p,hasVideoTrack:_,timeSlice:y}=c,{width:s,height:b}=h;let I=0;const B=bx(1024);return(T,U)=>{if(u!==!1)for(const G of B(T,U))p.encodeAudio(G);if(_){const G=new VideoFrame(h,{duration:y,timestamp:T});p.encodeVideo(G,{keyFrame:I%150===0}),l.resetTransform(),l.clearRect(0,0,s,b),I+=1}}}function bx(c){const l=c*oe.channelCount,h=new Float32Array(l*3);let u=0,p=0;const _=c/oe.sampleRate*1e6,y=new Float32Array(l),s=b=>{let I=0;const B=Math.floor(u/l),T=[];for(let U=0;U<B;U++)T.push(new AudioData({timestamp:p,numberOfChannels:oe.channelCount,numberOfFrames:c,sampleRate:oe.sampleRate,format:"f32",data:h.subarray(I,I+l)})),I+=l,p+=_;for(h.set(h.subarray(I,u),0),u-=I;b-p>_;)T.push(new AudioData({timestamp:p,numberOfChannels:oe.channelCount,numberOfFrames:c,sampleRate:oe.sampleRate,format:"f32",data:y})),p+=_;return T};return(b,I)=>{var B,T;const U=Math.max(...I.map(G=>{var t;return((t=G[0])==null?void 0:t.length)??0}));for(let G=0;G<U;G++){let t=0,e=0;for(let n=0;n<I.length;n++){const a=((B=I[n][0])==null?void 0:B[G])??0,f=((T=I[n][1])==null?void 0:T[G])??a;t+=a,e+=f}h[u]=t,h[u+1]=e,u+=2}return s(b)}}function Sx(c,l){return c.reduce((h,u)=>(h[u]=l[u],h),{})}var Ux=Object.defineProperty,vc=c=>{throw TypeError(c)},Ex=(c,l,h)=>l in c?Ux(c,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):c[l]=h,lo=(c,l,h)=>Ex(c,typeof l!="symbol"?l+"":l,h),Dh=(c,l,h)=>l.has(c)||vc("Cannot "+h),Q=(c,l,h)=>(Dh(c,l,"read from private field"),h?h.call(c):l.get(c)),xe=(c,l,h)=>l.has(c)?vc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(c):l.set(c,h),ni=(c,l,h,u)=>(Dh(c,l,"write to private field"),l.set(c,h),h),nr=(c,l,h)=>(Dh(c,l,"access private method"),h);const Cx=["t","b","l","r","lt","lb","rt","rb","rotate"];function is(c){return document.createElement(c)}function Ax(c){let l=16;const h=new ResizeObserver(p=>{const _=p[0];_!=null&&(l=10/(_.contentRect.width/c.width))});h.observe(c);function u(p){const{w:_,h:y}=p,s=l,b=s/2,I=_/2,B=y/2,T=s*1.5,U=T/2;return{...p.fixedAspectRatio?{}:{t:new Hi(-b,-B-b,s,s,p),b:new Hi(-b,B-b,s,s,p),l:new Hi(-I-b,-b,s,s,p),r:new Hi(I-b,-b,s,s,p)},lt:new Hi(-I-b,-B-b,s,s,p),lb:new Hi(-I-b,B-b,s,s,p),rt:new Hi(I-b,-B-b,s,s,p),rb:new Hi(I-b,B-b,s,s,p),rotate:new Hi(-U,-B-s*2-U,T,T,p)}}return{rectCtrlsGetter:u,destroy:()=>{h.disconnect()}}}var Ys=(c=>(c.ActiveSpriteChange="activeSpriteChange",c.AddSprite="addSprite",c))(Ys||{}),_i,Vr,Wr,Ms;class Tx{constructor(){xe(this,_i,[]),xe(this,Vr,null),xe(this,Wr,new hr),lo(this,"on",Q(this,Wr).on),xe(this,Ms,0)}get activeSprite(){return Q(this,Vr)}set activeSprite(l){l!==Q(this,Vr)&&(ni(this,Vr,l),Q(this,Wr).emit("activeSpriteChange",l))}async addSprite(l){await l.ready,Q(this,_i).push(l),ni(this,_i,Q(this,_i).sort((h,u)=>h.zIndex-u.zIndex)),l.on("propsChange",h=>{h.zIndex!=null&&ni(this,_i,Q(this,_i).sort((u,p)=>u.zIndex-p.zIndex))}),Q(this,Wr).emit("addSprite",l)}removeSprite(l){Q(this,Vr)===l&&(this.activeSprite=null),ni(this,_i,Q(this,_i).filter(h=>h!==l)),l.destroy()}getSprites(l={time:!0}){return Q(this,_i).filter(h=>h.visible&&(l.time?Q(this,Ms)>=h.time.offset&&Q(this,Ms)<=h.time.offset+h.time.duration:!0))}updateRenderTime(l){ni(this,Ms,l);const h=this.activeSprite;h!=null&&(l<h.time.offset||l>h.time.offset+h.time.duration)&&(this.activeSprite=null)}destroy(){Q(this,Wr).destroy(),Q(this,_i).forEach(l=>l.destroy()),ni(this,_i,[])}}_i=new WeakMap,Vr=new WeakMap,Wr=new WeakMap,Ms=new WeakMap;function Ix(c,l,h,u){const p={w:l.clientWidth/l.width,h:l.clientHeight/l.height},_=new ResizeObserver(()=>{p.w=l.clientWidth/l.width,p.h=l.clientHeight/l.height,h.activeSprite!=null&&Ql(h.activeSprite,y,s,p,u)});_.observe(l);const{rectEl:y,ctrlsEl:s}=Bx(c),b=h.on(Ys.ActiveSpriteChange,G=>{if(G==null){y.style.display="none";return}Ql(G,y,s,p,u),y.style.display=""});let I=!1;const B=G=>{G.button===0&&(I=!0)},T=()=>{I=!1},U=()=>{!I||h.activeSprite==null||Ql(h.activeSprite,y,s,p,u)};return l.addEventListener("mousedown",B),window.addEventListener("mouseup",T),window.addEventListener("mousemove",U),()=>{_.disconnect(),b(),y.remove(),l.removeEventListener("mousedown",B),window.removeEventListener("mouseup",T),window.removeEventListener("mousemove",U)}}function Bx(c){const l=is("div");l.style.cssText=`
    position: absolute;
    pointer-events: none;
    border: 1px solid #eee;
    box-sizing: border-box;
    display: none;
  `;const h=Object.fromEntries(Cx.map(u=>{const p=is("div");return p.style.cssText=`
        display: none;
        position: absolute;
        border: 1px solid #3ee; border-radius: 50%;
        box-sizing: border-box;
        background-color: #fff;
      `,[u,p]}));return Object.values(h).forEach(u=>l.appendChild(u)),c.appendChild(l),{rectEl:l,ctrlsEl:h}}function Ql(c,l,h,u,p){const{x:_,y,w:s,h:b,angle:I}=c.rect;Object.assign(l.style,{left:`${_*u.w}px`,top:`${y*u.h}px`,width:`${s*u.w}px`,height:`${b*u.h}px`,rotate:`${I}rad`}),Object.entries(p(c.rect)).forEach(([B,{x:T,y:U,w:G,h:t}])=>{Object.assign(h[B].style,{display:"block",left:"50%",top:"50%",width:`${G*u.w}px`,height:`${t*u.h}px`,transform:`translate(${T*u.w}px, ${U*u.h}px)`})})}function zx(c,l,h){const u={w:c.clientWidth/c.width,h:c.clientHeight/c.height},p=new ResizeObserver(()=>{u.w=c.clientWidth/c.width,u.h=c.clientHeight/c.height});p.observe(c);const _=y=>{if(y.button!==0)return;const{offsetX:s,offsetY:b}=y,I=s/u.w,B=b/u.h;if(l.activeSprite!=null){const[T]=Object.entries(h(l.activeSprite.rect)).find(([,U])=>U.checkHit(I,B))??[];if(T!=null)return}l.activeSprite=l.getSprites().reverse().find(T=>T.visible&&T.rect.checkHit(I,B))??null};return c.addEventListener("mousedown",_),()=>{p.disconnect(),c.removeEventListener("mousedown",_)}}function Fx(c,l,h,u){const p={w:c.clientWidth/c.width,h:c.clientHeight/c.height},_=new ResizeObserver(()=>{p.w=c.clientWidth/c.width,p.h=c.clientHeight/c.height});_.observe(c);let y=0,s=0,b=null;const I=Ox(c,h);let B=null;const T=t=>{if(t.button!==0||l.activeSprite==null)return;B=l.activeSprite;const{offsetX:e,offsetY:n,clientX:a,clientY:f}=t;Dx({rect:B.rect,offsetX:e,offsetY:n,clientX:a,clientY:f,cvsRatio:p,cvsEl:c,rectCtrlsGetter:u})||(b=B.rect.clone(),I.magneticEffect(B.rect.x,B.rect.y,B.rect),y=a,s=f,window.addEventListener("mousemove",U),window.addEventListener("mouseup",G))},U=t=>{if(B==null||b==null)return;const{clientX:e,clientY:n}=t;let a=b.x+(e-y)/p.w,f=b.y+(n-s)/p.h;yc(B.rect,c,I.magneticEffect(a,f,B.rect))};c.addEventListener("mousedown",T);const G=()=>{I.hide(),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",G)};return()=>{_.disconnect(),I.destroy(),G(),c.removeEventListener("mousedown",T)}}function Lx({sprRect:c,startX:l,startY:h,ctrlKey:u,cvsRatio:p,cvsEl:_}){const y=c.clone(),s=I=>{const{clientX:B,clientY:T}=I,U=(B-l)/p.w,G=(T-h)/p.h,t=u.length===1?kx:Px,{x:e,y:n,w:a,h:f}=y,g=Math.atan2(f,a),{incW:v,incH:w,incS:S,rotateAngle:L}=t({deltaX:U,deltaY:G,angle:c.angle,ctrlKey:u,diagonalAngle:g}),F=10;let P=a,M=f,D=y.fixedScaleCenter?v*2:v,it=y.fixedScaleCenter?w*2:w,at=S;const Ft=Math.sqrt(f**2+a**2),V=Math.sqrt((F*(f/a))**2+F**2);switch(u){case"l":P=Math.max(a+D,F),at=Math.min(S,a-F);break;case"r":P=Math.max(a+D,F),at=Math.max(S,F-a);break;case"b":M=Math.max(f+it,F),at=Math.min(S,f-F);break;case"t":M=Math.max(f+it,F),at=Math.max(S,F-f);break;case"lt":case"lb":P=Math.max(a+D,F),M=P===F?f/a*P:f+it,at=Math.min(S,Ft-V);break;case"rt":case"rb":P=Math.max(a+D,F),M=P===F?f/a*P:f+it,at=Math.max(S,V-Ft);break}let Ct=e,At=n;if(y.fixedScaleCenter)Ct=e+a/2-P/2,At=n+f/2-M/2;else{const Gt=at/2*Math.cos(L)+e+a/2,nt=at/2*Math.sin(L)+n+f/2;Ct=Gt-P/2,At=nt-M/2}yc(c,_,{x:Ct,y:At,w:P,h:M})},b=()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",s),window.addEventListener("mouseup",b)}function kx({deltaX:c,deltaY:l,angle:h,ctrlKey:u}){let p=0,_=0,y=0,s=h;return u==="l"||u==="r"?(p=c*Math.cos(h)+l*Math.sin(h),_=p*(u==="l"?-1:1)):(u==="t"||u==="b")&&(s=h-Math.PI/2,p=c*Math.cos(s)+l*Math.sin(s),y=p*(u==="b"?-1:1)),{incW:_,incH:y,incS:p,rotateAngle:s}}function Px({deltaX:c,deltaY:l,angle:h,ctrlKey:u,diagonalAngle:p}){const _=(u==="lt"||u==="rb"?1:-1)*p+h,y=c*Math.cos(_)+l*Math.sin(_),s=u==="lt"||u==="lb"?-1:1,b=y*Math.cos(p)*s,I=y*Math.sin(p)*s;return{incW:b,incH:I,incS:y,rotateAngle:_}}function Dx({rect:c,cvsRatio:l,offsetX:h,offsetY:u,clientX:p,clientY:_,cvsEl:y,rectCtrlsGetter:s}){const b=h/l.w,I=u/l.h,[B]=Object.entries(s(c)).find(([,T])=>T.checkHit(b,I))??[];return B==null?!1:(B==="rotate"?Rx(c,Mx(c.center,l,y)):Lx({sprRect:c,ctrlKey:B,startX:p,startY:_,cvsRatio:l,cvsEl:y}),!0)}function Rx(c,l){const h=({clientX:p,clientY:_})=>{const y=p-l.x,s=_-l.y,b=Math.atan2(s,y)+Math.PI/2;c.angle=b},u=()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",u)};window.addEventListener("mousemove",h),window.addEventListener("mouseup",u)}function Mx(c,l,h){const u=c.x*l.w,p=c.y*l.h,{left:_,top:y}=h.getBoundingClientRect();return{x:u+_,y:p+y}}function yc(c,l,h){const u={x:c.x,y:c.y,w:c.w,h:c.h,...h},p=l.width*.05,_=l.height*.05;u.x<-u.w+p?u.x=-u.w+p:u.x>l.width-p&&(u.x=l.width-p),u.y<-u.h+_?u.y=-u.h+_:u.y>l.height-_&&(u.y=l.height-_),c.x=u.x,c.y=u.y,c.w=u.w,c.h=u.h}function Ox(c,l){const h="display: none; position: absolute;",u={w:0,h:0,x:0,y:0},p={vertMiddle:{...u,h:100,x:50,ref:{prop:"x",val:({w:b})=>(c.width-b)/2}},horMiddle:{...u,w:100,y:50,ref:{prop:"y",val:({h:b})=>(c.height-b)/2}},top:{...u,w:100,ref:{prop:"y",val:()=>0}},bottom:{...u,w:100,y:100,ref:{prop:"y",val:({h:b})=>c.height-b}},left:{...u,h:100,ref:{prop:"x",val:()=>0}},right:{...u,h:100,x:100,ref:{prop:"x",val:({w:b})=>c.width-b}}},_=is("div");_.style.cssText=`
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    box-sizing: border-box;
  `;const y=Object.fromEntries(Object.entries(p).map(([b,{w:I,h:B,x:T,y:U}])=>{const G=is("div");return G.style.cssText=`
        ${h}
        border-${I>0?"top":"left"}: 1px solid #3ee;
        top: ${U}%; left: ${T}%;
        ${T===100?"margin-left: -1px":""};
        ${U===100?"margin-top: -1px":""};
        width: ${I}%; height: ${B}%;
      `,_.appendChild(G),[b,G]}));l.appendChild(_);const s=6/(900/c.width);return{magneticEffect(b,I,B){const T={x:b,y:I};let U,G={x:!1,y:!1};for(U in p){const{prop:t,val:e}=p[U].ref;if(G[t])continue;const n=e(B);Math.abs(B[t]-n)<=s&&Math.abs(B[t]-(t==="x"?b:I))<=s?(T[t]=n,y[U].style.display="block",G[t]=!0):y[U].style.display="none"}return T},hide(){Object.values(y).forEach(b=>b.style.display="none")},destroy(){_.remove()}}}function Nx(c,l,h){const u={w:c.clientWidth/c.width,h:c.clientHeight/c.height},p=new ResizeObserver(()=>{u.w=c.clientWidth/c.width,u.h=c.clientHeight/c.height});p.observe(c);const _=c.style;let y=l.activeSprite;l.on(Ys.ActiveSpriteChange,G=>{y=G,G==null&&(_.cursor="")});let s=!1;const b=({offsetX:G,offsetY:t})=>{s=!0;const e=G/u.w,n=t/u.h;(y==null?void 0:y.rect.checkHit(e,n))===!0&&_.cursor===""&&(_.cursor="move")},I=()=>{s=!1},B=["ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize"],T={t:0,rt:1,r:2,rb:3,b:4,lb:5,l:6,lt:7},U=G=>{if(y==null||s)return;const{offsetX:t,offsetY:e}=G,n=t/u.w,a=e/u.h,[f]=Object.entries(h(y.rect)).find(([,g])=>g.checkHit(n,a))??[];if(f!=null){if(f==="rotate"){_.cursor="crosshair";return}const g=y.rect.angle,v=g<0?g+2*Math.PI:g,w=(T[f]+Math.floor((v+Math.PI/8)/(Math.PI/4)))%8;_.cursor=B[w];return}if(y.rect.checkHit(n,a)){_.cursor="move";return}_.cursor=""};return c.addEventListener("mousemove",U),c.addEventListener("mousedown",b),window.addEventListener("mouseup",I),()=>{p.disconnect(),c.removeEventListener("mousemove",U),c.removeEventListener("mousedown",b),window.removeEventListener("mouseup",I)}}const Gx={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function Hx(c){const l=is("canvas");return l.style.cssText=`
    width: 100%;
    height: 100%;
    display: block;
  `,l.width=c.width,l.height=c.height,l}var Ae,ye,Kr,ho,uo,fo,An,co,Bn,dn,Co,Ao,Oe,rr,sr,wc,Ii,po;class Yx{constructor(l,h){xe(this,dn),xe(this,Ae),xe(this,ye),xe(this,Kr),xe(this,ho,!1),xe(this,uo,[]),xe(this,fo),xe(this,An,new hr),lo(this,"on",Q(this,An).on),xe(this,co),xe(this,Bn,0),xe(this,Oe,new AudioContext),xe(this,rr,Q(this,Oe).createMediaStreamDestination()),xe(this,sr,new Set),xe(this,Ii,{start:0,end:0,step:0,audioPlayAt:0}),xe(this,po,new WeakMap),lo(this,"addSprite",async T=>{Q(this,Oe).state==="suspended"&&Q(this,Oe).resume().catch(zt.error);const U=T.getClip();if(U instanceof fx&&U.audioTrack!=null){const G=Q(this,Oe).createMediaStreamSource(new MediaStream([U.audioTrack]));G.connect(Q(this,rr)),Q(this,po).set(T,G)}await Q(this,ye).addSprite(T)}),lo(this,"removeSprite",T=>{var U;(U=Q(this,po).get(T))==null||U.disconnect(),Q(this,ye).removeSprite(T)}),ni(this,co,h),ni(this,Ae,Hx(h));const u=Q(this,Ae).getContext("2d",{alpha:!1});if(u==null)throw Error("canvas context is null");ni(this,Kr,u);const p=is("div");p.style.cssText="width: 100%; height: 100%; position: relative; overflow: hidden;",p.appendChild(Q(this,Ae)),l.appendChild(p),Wx(Q(this,Oe)).connect(Q(this,rr)),ni(this,ye,new Tx);const{rectCtrlsGetter:_,destroy:y}=Ax(Q(this,Ae));Q(this,uo).push(y,zx(Q(this,Ae),Q(this,ye),_),Nx(Q(this,Ae),Q(this,ye),_),Fx(Q(this,Ae),Q(this,ye),p,_),Ix(p,Q(this,Ae),Q(this,ye),_),Q(this,ye).on(Ys.AddSprite,T=>{const{rect:U}=T;U.x===0&&U.y===0&&(U.x=(Q(this,Ae).width-U.w)/2,U.y=(Q(this,Ae).height-U.h)/2)}),hr.forwardEvent(Q(this,ye),Q(this,An),[Ys.ActiveSpriteChange]));let s=Q(this,Bn),b=performance.now(),I=0;const B=1e3/30;ni(this,fo,Ih(()=>{(performance.now()-b)/(B*I)<1||(I+=1,Q(this,Kr).fillStyle=h.bgColor,Q(this,Kr).fillRect(0,0,Q(this,Ae).width,Q(this,Ae).height),nr(this,dn,wc).call(this),s!==Q(this,Bn)&&(s=Q(this,Bn),Q(this,An).emit("timeupdate",Math.round(s))))},B))}play(l){const h=Q(this,ye).getSprites({time:!1}).map(p=>p.time.offset+p.time.duration),u=l.end??(h.length>0?Math.max(...h):1/0);if(l.start>=u||l.start<0)throw Error(`Invalid time parameter, ${JSON.stringify({start:l.start,end:u})}`);nr(this,dn,Co).call(this,l.start),Q(this,ye).getSprites({time:!1}).forEach(p=>{const{offset:_,duration:y}=p.time,s=Q(this,Bn)-_;p.preFrame(s>0&&s<y?s:0)}),Q(this,Ii).start=l.start,Q(this,Ii).end=u,Q(this,Ii).step=(l.playbackRate??1)*(1e3/30)*1e3,Q(this,Oe).resume(),Q(this,Ii).audioPlayAt=0,Q(this,An).emit("playing"),zt.info("AVCanvs play by:",Q(this,Ii))}pause(){nr(this,dn,Ao).call(this)}previewFrame(l){nr(this,dn,Co).call(this,l),nr(this,dn,Ao).call(this)}captureImage(){return Q(this,Ae).toDataURL()}get activeSprite(){return Q(this,ye).activeSprite}set activeSprite(l){Q(this,ye).activeSprite=l}destroy(){var l;Q(this,ho)||(ni(this,ho,!0),Q(this,Oe).close(),Q(this,rr).disconnect(),Q(this,An).destroy(),Q(this,fo).call(this),(l=Q(this,Ae).parentElement)==null||l.remove(),Q(this,uo).forEach(h=>h()),Q(this,sr).clear(),Q(this,ye).destroy())}captureStream(){Q(this,Oe).state==="suspended"&&Q(this,Oe).resume().catch(zt.error);const l=new MediaStream(Q(this,Ae).captureStream().getTracks().concat(Q(this,rr).stream.getTracks()));return zt.info("AVCanvas.captureStream, tracks:",l.getTracks().map(h=>h.kind)),l}async createCombinator(l={}){zt.info("AVCanvas.createCombinator, opts:",l);const h=new yx({...Q(this,co),...l}),u=Q(this,ye).getSprites({time:!1});if(u.length===0)throw Error("No sprite added");for(const p of u){const _=new gx(p.getClip());_.time={...p.time},p.copyStateTo(_),await h.addSprite(_)}return h}}Ae=new WeakMap,ye=new WeakMap,Kr=new WeakMap,ho=new WeakMap,uo=new WeakMap,fo=new WeakMap,An=new WeakMap,co=new WeakMap,Bn=new WeakMap,dn=new WeakSet,Co=function(c){ni(this,Bn,c),Q(this,ye).updateRenderTime(c)},Ao=function(){const c=Q(this,Ii).step!==0;Q(this,Ii).step=0,c&&(Q(this,An).emit("paused"),Q(this,Oe).suspend());for(const l of Q(this,sr))l.stop(),l.disconnect();Q(this,sr).clear()},Oe=new WeakMap,rr=new WeakMap,sr=new WeakMap,wc=function(){var c;const l=Q(this,Kr);let h=Q(this,Bn);const{start:u,end:p,step:_,audioPlayAt:y}=Q(this,Ii);_!==0&&h>=u&&h<p?h+=_:nr(this,dn,Ao).call(this),nr(this,dn,Co).call(this,h);const s=[];for(const b of Q(this,ye).getSprites()){l.save();const{audio:I}=b.render(l,h-b.time.offset);l.restore(),s.push(I)}if(l.resetTransform(),_!==0){const b=Math.max(Q(this,Oe).currentTime,y),I=Vx(s,Q(this,Oe));let B=0;for(const T of I)T.start(b),T.connect(Q(this,Oe).destination),T.connect(Q(this,rr)),Q(this,sr).add(T),T.onended=()=>{T.disconnect(),Q(this,sr).delete(T)},B=Math.max(B,((c=T.buffer)==null?void 0:c.duration)??0);Q(this,Ii).audioPlayAt=b+B}},Ii=new WeakMap,po=new WeakMap;function Vx(c,l){const h=[];if(c.length===0)return h;for(const[u,p]of c){if(u==null||u.length<=0)continue;const _=l.createBuffer(2,u.length,Gx.sampleRate);_.copyToChannel(u,0),_.copyToChannel(p??u,1);const y=l.createBufferSource();y.buffer=_,h.push(y)}return h}function Wx(c){const l=c.createOscillator(),h=new Float32Array([0,0]),u=new Float32Array([0,0]),p=c.createPeriodicWave(h,u,{disableNormalization:!0});return l.setPeriodicWave(p),l.start(),l}const xc=/^[a-z0-9]+(-[a-z0-9]+)*$/,Bo=(c,l,h,u="")=>{const p=c.split(":");if(c.slice(0,1)==="@"){if(p.length<2||p.length>3)return null;u=p.shift().slice(1)}if(p.length>3||!p.length)return null;if(p.length>1){const s=p.pop(),b=p.pop(),I={provider:p.length>0?p[0]:u,prefix:b,name:s};return l&&!_o(I)?null:I}const _=p[0],y=_.split("-");if(y.length>1){const s={provider:u,prefix:y.shift(),name:y.join("-")};return l&&!_o(s)?null:s}if(h&&u===""){const s={provider:u,prefix:"",name:_};return l&&!_o(s,h)?null:s}return null},_o=(c,l)=>c?!!((l&&c.prefix===""||c.prefix)&&c.name):!1,bc=Object.freeze({left:0,top:0,width:16,height:16}),To=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),zo=Object.freeze({...bc,...To}),mh=Object.freeze({...zo,body:"",hidden:!1});function $x(c,l){const h={};!c.hFlip!=!l.hFlip&&(h.hFlip=!0),!c.vFlip!=!l.vFlip&&(h.vFlip=!0);const u=((c.rotate||0)+(l.rotate||0))%4;return u&&(h.rotate=u),h}function Td(c,l){const h=$x(c,l);for(const u in mh)u in To?u in c&&!(u in h)&&(h[u]=To[u]):u in l?h[u]=l[u]:u in c&&(h[u]=c[u]);return h}function Xx(c,l){const h=c.icons,u=c.aliases||Object.create(null),p=Object.create(null);function _(y){if(h[y])return p[y]=[];if(!(y in p)){p[y]=null;const s=u[y]&&u[y].parent,b=s&&_(s);b&&(p[y]=[s].concat(b))}return p[y]}return Object.keys(h).concat(Object.keys(u)).forEach(_),p}function qx(c,l,h){const u=c.icons,p=c.aliases||Object.create(null);let _={};function y(s){_=Td(u[s]||p[s],_)}return y(l),h.forEach(y),Td(c,_)}function Sc(c,l){const h=[];if(typeof c!="object"||typeof c.icons!="object")return h;c.not_found instanceof Array&&c.not_found.forEach(p=>{l(p,null),h.push(p)});const u=Xx(c);for(const p in u){const _=u[p];_&&(l(p,qx(c,p,_)),h.push(p))}return h}const jx={provider:"",aliases:{},not_found:{},...bc};function th(c,l){for(const h in l)if(h in c&&typeof c[h]!=typeof l[h])return!1;return!0}function Uc(c){if(typeof c!="object"||c===null)return null;const l=c;if(typeof l.prefix!="string"||!c.icons||typeof c.icons!="object"||!th(c,jx))return null;const h=l.icons;for(const p in h){const _=h[p];if(!p||typeof _.body!="string"||!th(_,mh))return null}const u=l.aliases||Object.create(null);for(const p in u){const _=u[p],y=_.parent;if(!p||typeof y!="string"||!h[y]&&!u[y]||!th(_,mh))return null}return l}const Id=Object.create(null);function Kx(c,l){return{provider:c,prefix:l,icons:Object.create(null),missing:new Set}}function ns(c,l){const h=Id[c]||(Id[c]=Object.create(null));return h[l]||(h[l]=Kx(c,l))}function Ec(c,l){return Uc(l)?Sc(l,(h,u)=>{u?c.icons[h]=u:c.missing.add(h)}):[]}function Zx(c,l,h){try{if(typeof h.body=="string")return c.icons[l]={...h},!0}catch{}return!1}let Vs=!1;function Cc(c){return typeof c=="boolean"&&(Vs=c),Vs}function Jx(c){const l=typeof c=="string"?Bo(c,!0,Vs):c;if(l){const h=ns(l.provider,l.prefix),u=l.name;return h.icons[u]||(h.missing.has(u)?null:void 0)}}function Qx(c,l){const h=Bo(c,!0,Vs);if(!h)return!1;const u=ns(h.provider,h.prefix);return l?Zx(u,h.name,l):(u.missing.add(h.name),!0)}function tb(c,l){if(typeof c!="object")return!1;if(typeof l!="string"&&(l=c.provider||""),Vs&&!l&&!c.prefix){let p=!1;return Uc(c)&&(c.prefix="",Sc(c,(_,y)=>{Qx(_,y)&&(p=!0)})),p}const h=c.prefix;if(!_o({provider:l,prefix:h,name:"a"}))return!1;const u=ns(l,h);return!!Ec(u,c)}const Ac=Object.freeze({width:null,height:null}),Tc=Object.freeze({...Ac,...To}),eb=/(-?[0-9.]*[0-9]+[0-9.]*)/g,ib=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function Bd(c,l,h){if(l===1)return c;if(h=h||100,typeof c=="number")return Math.ceil(c*l*h)/h;if(typeof c!="string")return c;const u=c.split(eb);if(u===null||!u.length)return c;const p=[];let _=u.shift(),y=ib.test(_);for(;;){if(y){const s=parseFloat(_);isNaN(s)?p.push(_):p.push(Math.ceil(s*l*h)/h)}else p.push(_);if(_=u.shift(),_===void 0)return p.join("");y=!y}}function nb(c,l="defs"){let h="";const u=c.indexOf("<"+l);for(;u>=0;){const p=c.indexOf(">",u),_=c.indexOf("</"+l);if(p===-1||_===-1)break;const y=c.indexOf(">",_);if(y===-1)break;h+=c.slice(p+1,_).trim(),c=c.slice(0,u).trim()+c.slice(y+1)}return{defs:h,content:c}}function rb(c,l){return c?"<defs>"+c+"</defs>"+l:l}function sb(c,l,h){const u=nb(c);return rb(u.defs,l+u.content+h)}const ab=c=>c==="unset"||c==="undefined"||c==="none";function ob(c,l){const h={...zo,...c},u={...Tc,...l},p={left:h.left,top:h.top,width:h.width,height:h.height};let _=h.body;[h,u].forEach(e=>{const n=[],a=e.hFlip,f=e.vFlip;let g=e.rotate;a?f?g+=2:(n.push("translate("+(p.width+p.left).toString()+" "+(0-p.top).toString()+")"),n.push("scale(-1 1)"),p.top=p.left=0):f&&(n.push("translate("+(0-p.left).toString()+" "+(p.height+p.top).toString()+")"),n.push("scale(1 -1)"),p.top=p.left=0);let v;switch(g<0&&(g-=Math.floor(g/4)*4),g=g%4,g){case 1:v=p.height/2+p.top,n.unshift("rotate(90 "+v.toString()+" "+v.toString()+")");break;case 2:n.unshift("rotate(180 "+(p.width/2+p.left).toString()+" "+(p.height/2+p.top).toString()+")");break;case 3:v=p.width/2+p.left,n.unshift("rotate(-90 "+v.toString()+" "+v.toString()+")");break}g%2===1&&(p.left!==p.top&&(v=p.left,p.left=p.top,p.top=v),p.width!==p.height&&(v=p.width,p.width=p.height,p.height=v)),n.length&&(_=sb(_,'<g transform="'+n.join(" ")+'">',"</g>"))});const y=u.width,s=u.height,b=p.width,I=p.height;let B,T;y===null?(T=s===null?"1em":s==="auto"?I:s,B=Bd(T,b/I)):(B=y==="auto"?b:y,T=s===null?Bd(B,I/b):s==="auto"?I:s);const U={},G=(e,n)=>{ab(n)||(U[e]=n.toString())};G("width",B),G("height",T);const t=[p.left,p.top,b,I];return U.viewBox=t.join(" "),{attributes:U,viewBox:t,body:_}}const lb=/\sid="(\S+)"/g,hb="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let ub=0;function fb(c,l=hb){const h=[];let u;for(;u=lb.exec(c);)h.push(u[1]);if(!h.length)return c;const p="suffix"+(Math.random()*16777216|Date.now()).toString(16);return h.forEach(_=>{const y=typeof l=="function"?l(_):l+(ub++).toString(),s=_.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");c=c.replace(new RegExp('([#;"])('+s+')([")]|\\.[a-z])',"g"),"$1"+y+p+"$3")}),c=c.replace(new RegExp(p,"g"),""),c}const vh=Object.create(null);function db(c,l){vh[c]=l}function yh(c){return vh[c]||vh[""]}function Rh(c){let l;if(typeof c.resources=="string")l=[c.resources];else if(l=c.resources,!(l instanceof Array)||!l.length)return null;return{resources:l,path:c.path||"/",maxURL:c.maxURL||500,rotate:c.rotate||750,timeout:c.timeout||5e3,random:c.random===!0,index:c.index||0,dataAfterTimeout:c.dataAfterTimeout!==!1}}const Mh=Object.create(null),As=["https://api.simplesvg.com","https://api.unisvg.com"],go=[];for(;As.length>0;)As.length===1||Math.random()>.5?go.push(As.shift()):go.push(As.pop());Mh[""]=Rh({resources:["https://api.iconify.design"].concat(go)});function cb(c,l){const h=Rh(l);return h===null?!1:(Mh[c]=h,!0)}function Oh(c){return Mh[c]}const pb=()=>{let c;try{if(c=fetch,typeof c=="function")return c}catch{}};let zd=pb();function _b(c,l){const h=Oh(c);if(!h)return 0;let u;if(!h.maxURL)u=0;else{let p=0;h.resources.forEach(y=>{p=Math.max(p,y.length)});const _=l+".json?icons=";u=h.maxURL-p-h.path.length-_.length}return u}function gb(c){return c===404}const mb=(c,l,h)=>{const u=[],p=_b(c,l),_="icons";let y={type:_,provider:c,prefix:l,icons:[]},s=0;return h.forEach((b,I)=>{s+=b.length+1,s>=p&&I>0&&(u.push(y),y={type:_,provider:c,prefix:l,icons:[]},s=b.length),y.icons.push(b)}),u.push(y),u};function vb(c){if(typeof c=="string"){const l=Oh(c);if(l)return l.path}return"/"}const yb=(c,l,h)=>{if(!zd){h("abort",424);return}let u=vb(l.provider);switch(l.type){case"icons":{const _=l.prefix,s=l.icons.join(","),b=new URLSearchParams({icons:s});u+=_+".json?"+b.toString();break}case"custom":{const _=l.uri;u+=_.slice(0,1)==="/"?_.slice(1):_;break}default:h("abort",400);return}let p=503;zd(c+u).then(_=>{const y=_.status;if(y!==200){setTimeout(()=>{h(gb(y)?"abort":"next",y)});return}return p=501,_.json()}).then(_=>{if(typeof _!="object"||_===null){setTimeout(()=>{_===404?h("abort",_):h("next",p)});return}setTimeout(()=>{h("success",_)})}).catch(()=>{h("next",p)})},wb={prepare:mb,send:yb};function xb(c){const l={loaded:[],missing:[],pending:[]},h=Object.create(null);c.sort((p,_)=>p.provider!==_.provider?p.provider.localeCompare(_.provider):p.prefix!==_.prefix?p.prefix.localeCompare(_.prefix):p.name.localeCompare(_.name));let u={provider:"",prefix:"",name:""};return c.forEach(p=>{if(u.name===p.name&&u.prefix===p.prefix&&u.provider===p.provider)return;u=p;const _=p.provider,y=p.prefix,s=p.name,b=h[_]||(h[_]=Object.create(null)),I=b[y]||(b[y]=ns(_,y));let B;s in I.icons?B=l.loaded:y===""||I.missing.has(s)?B=l.missing:B=l.pending;const T={provider:_,prefix:y,name:s};B.push(T)}),l}function Ic(c,l){c.forEach(h=>{const u=h.loaderCallbacks;u&&(h.loaderCallbacks=u.filter(p=>p.id!==l))})}function bb(c){c.pendingCallbacksFlag||(c.pendingCallbacksFlag=!0,setTimeout(()=>{c.pendingCallbacksFlag=!1;const l=c.loaderCallbacks?c.loaderCallbacks.slice(0):[];if(!l.length)return;let h=!1;const u=c.provider,p=c.prefix;l.forEach(_=>{const y=_.icons,s=y.pending.length;y.pending=y.pending.filter(b=>{if(b.prefix!==p)return!0;const I=b.name;if(c.icons[I])y.loaded.push({provider:u,prefix:p,name:I});else if(c.missing.has(I))y.missing.push({provider:u,prefix:p,name:I});else return h=!0,!0;return!1}),y.pending.length!==s&&(h||Ic([c],_.id),_.callback(y.loaded.slice(0),y.missing.slice(0),y.pending.slice(0),_.abort))})}))}let Sb=0;function Ub(c,l,h){const u=Sb++,p=Ic.bind(null,h,u);if(!l.pending.length)return p;const _={id:u,icons:l,callback:c,abort:p};return h.forEach(y=>{(y.loaderCallbacks||(y.loaderCallbacks=[])).push(_)}),p}function Eb(c,l=!0,h=!1){const u=[];return c.forEach(p=>{const _=typeof p=="string"?Bo(p,l,h):p;_&&u.push(_)}),u}var Cb={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function Ab(c,l,h,u){const p=c.resources.length,_=c.random?Math.floor(Math.random()*p):c.index;let y;if(c.random){let S=c.resources.slice(0);for(y=[];S.length>1;){const L=Math.floor(Math.random()*S.length);y.push(S[L]),S=S.slice(0,L).concat(S.slice(L+1))}y=y.concat(S)}else y=c.resources.slice(_).concat(c.resources.slice(0,_));const s=Date.now();let b="pending",I=0,B,T=null,U=[],G=[];typeof u=="function"&&G.push(u);function t(){T&&(clearTimeout(T),T=null)}function e(){b==="pending"&&(b="aborted"),t(),U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function n(S,L){L&&(G=[]),typeof S=="function"&&G.push(S)}function a(){return{startTime:s,payload:l,status:b,queriesSent:I,queriesPending:U.length,subscribe:n,abort:e}}function f(){b="failed",G.forEach(S=>{S(void 0,B)})}function g(){U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function v(S,L,F){const P=L!=="success";switch(U=U.filter(M=>M!==S),b){case"pending":break;case"failed":if(P||!c.dataAfterTimeout)return;break;default:return}if(L==="abort"){B=F,f();return}if(P){B=F,U.length||(y.length?w():f());return}if(t(),g(),!c.random){const M=c.resources.indexOf(S.resource);M!==-1&&M!==c.index&&(c.index=M)}b="completed",G.forEach(M=>{M(F)})}function w(){if(b!=="pending")return;t();const S=y.shift();if(S===void 0){if(U.length){T=setTimeout(()=>{t(),b==="pending"&&(g(),f())},c.timeout);return}f();return}const L={status:"pending",resource:S,callback:(F,P)=>{v(L,F,P)}};U.push(L),I++,T=setTimeout(w,c.rotate),h(S,l,L.callback)}return setTimeout(w),a}function Bc(c){const l={...Cb,...c};let h=[];function u(){h=h.filter(s=>s().status==="pending")}function p(s,b,I){const B=Ab(l,s,b,(T,U)=>{u(),I&&I(T,U)});return h.push(B),B}function _(s){return h.find(b=>s(b))||null}return{query:p,find:_,setIndex:s=>{l.index=s},getIndex:()=>l.index,cleanup:u}}function Fd(){}const eh=Object.create(null);function Tb(c){if(!eh[c]){const l=Oh(c);if(!l)return;const h=Bc(l),u={config:l,redundancy:h};eh[c]=u}return eh[c]}function Ib(c,l,h){let u,p;if(typeof c=="string"){const _=yh(c);if(!_)return h(void 0,424),Fd;p=_.send;const y=Tb(c);y&&(u=y.redundancy)}else{const _=Rh(c);if(_){u=Bc(_);const y=c.resources?c.resources[0]:"",s=yh(y);s&&(p=s.send)}}return!u||!p?(h(void 0,424),Fd):u.query(l,p,h)().abort}function Ld(){}function Bb(c){c.iconsLoaderFlag||(c.iconsLoaderFlag=!0,setTimeout(()=>{c.iconsLoaderFlag=!1,bb(c)}))}function zb(c){const l=[],h=[];return c.forEach(u=>{(u.match(xc)?l:h).push(u)}),{valid:l,invalid:h}}function Ts(c,l,h){function u(){const p=c.pendingIcons;l.forEach(_=>{p&&p.delete(_),c.icons[_]||c.missing.add(_)})}if(h&&typeof h=="object")try{if(!Ec(c,h).length){u();return}}catch(p){console.error(p)}u(),Bb(c)}function kd(c,l){c instanceof Promise?c.then(h=>{l(h)}).catch(()=>{l(null)}):l(c)}function Fb(c,l){c.iconsToLoad?c.iconsToLoad=c.iconsToLoad.concat(l).sort():c.iconsToLoad=l,c.iconsQueueFlag||(c.iconsQueueFlag=!0,setTimeout(()=>{c.iconsQueueFlag=!1;const{provider:h,prefix:u}=c,p=c.iconsToLoad;if(delete c.iconsToLoad,!p||!p.length)return;const _=c.loadIcon;if(c.loadIcons&&(p.length>1||!_)){kd(c.loadIcons(p,u,h),B=>{Ts(c,p,B)});return}if(_){p.forEach(B=>{const T=_(B,u,h);kd(T,U=>{const G=U?{prefix:u,icons:{[B]:U}}:null;Ts(c,[B],G)})});return}const{valid:y,invalid:s}=zb(p);if(s.length&&Ts(c,s,null),!y.length)return;const b=u.match(xc)?yh(h):null;if(!b){Ts(c,y,null);return}b.prepare(h,u,y).forEach(B=>{Ib(h,B,T=>{Ts(c,B.icons,T)})})}))}const Lb=(c,l)=>{const h=Eb(c,!0,Cc()),u=xb(h);if(!u.pending.length){let b=!0;return l&&setTimeout(()=>{b&&l(u.loaded,u.missing,u.pending,Ld)}),()=>{b=!1}}const p=Object.create(null),_=[];let y,s;return u.pending.forEach(b=>{const{provider:I,prefix:B}=b;if(B===s&&I===y)return;y=I,s=B,_.push(ns(I,B));const T=p[I]||(p[I]=Object.create(null));T[B]||(T[B]=[])}),u.pending.forEach(b=>{const{provider:I,prefix:B,name:T}=b,U=ns(I,B),G=U.pendingIcons||(U.pendingIcons=new Set);G.has(T)||(G.add(T),p[I][B].push(T))}),_.forEach(b=>{const I=p[b.provider][b.prefix];I.length&&Fb(b,I)}),l?Ub(l,u,_):Ld};function kb(c,l){const h={...c};for(const u in l){const p=l[u],_=typeof p;u in Ac?(p===null||p&&(_==="string"||_==="number"))&&(h[u]=p):_===typeof h[u]&&(h[u]=u==="rotate"?p%4:p)}return h}const Pb=/[\s,]+/;function Db(c,l){l.split(Pb).forEach(h=>{switch(h.trim()){case"horizontal":c.hFlip=!0;break;case"vertical":c.vFlip=!0;break}})}function Rb(c,l=0){const h=c.replace(/^-?[0-9.]*/,"");function u(p){for(;p<0;)p+=4;return p%4}if(h===""){const p=parseInt(c);return isNaN(p)?0:u(p)}else if(h!==c){let p=0;switch(h){case"%":p=25;break;case"deg":p=90}if(p){let _=parseFloat(c.slice(0,c.length-h.length));return isNaN(_)?0:(_=_/p,_%1===0?u(_):0)}}return l}function Mb(c,l){let h=c.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const u in l)h+=" "+u+'="'+l[u]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+h+">"+c+"</svg>"}function Ob(c){return c.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function Nb(c){return"data:image/svg+xml,"+Ob(c)}function Gb(c){return'url("'+Nb(c)+'")'}const Pd={...Tc,inline:!1},Hb={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},Yb={display:"inline-block"},wh={backgroundColor:"currentColor"},zc={backgroundColor:"transparent"},Dd={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},Rd={webkitMask:wh,mask:wh,background:zc};for(const c in Rd){const l=Rd[c];for(const h in Dd)l[c+h]=Dd[h]}const mo={};["horizontal","vertical"].forEach(c=>{const l=c.slice(0,1)+"Flip";mo[c+"-flip"]=l,mo[c.slice(0,1)+"-flip"]=l,mo[c+"Flip"]=l});function Md(c){return c+(c.match(/^[-0-9.]+$/)?"px":"")}const Od=(c,l)=>{const h=kb(Pd,l),u={...Hb},p=l.mode||"svg",_={},y=l.style,s=typeof y=="object"&&!(y instanceof Array)?y:{};for(let e in l){const n=l[e];if(n!==void 0)switch(e){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":h[e]=n===!0||n==="true"||n===1;break;case"flip":typeof n=="string"&&Db(h,n);break;case"color":_.color=n;break;case"rotate":typeof n=="string"?h[e]=Rb(n):typeof n=="number"&&(h[e]=n);break;case"ariaHidden":case"aria-hidden":n!==!0&&n!=="true"&&delete u["aria-hidden"];break;default:{const a=mo[e];a?(n===!0||n==="true"||n===1)&&(h[a]=!0):Pd[e]===void 0&&(u[e]=n)}}}const b=ob(c,h),I=b.attributes;if(h.inline&&(_.verticalAlign="-0.125em"),p==="svg"){u.style={..._,...s},Object.assign(u,I);let e=0,n=l.id;return typeof n=="string"&&(n=n.replace(/-/g,"_")),u.innerHTML=fb(b.body,n?()=>n+"ID"+e++:"iconifyVue"),vd("svg",u)}const{body:B,width:T,height:U}=c,G=p==="mask"||(p==="bg"?!1:B.indexOf("currentColor")!==-1),t=Mb(B,{...I,width:T+"",height:U+""});return u.style={..._,"--svg":Gb(t),width:Md(I.width),height:Md(I.height),...Yb,...G?wh:zc,...s},vd("span",u)};Cc(!0);db("",wb);if(typeof document<"u"&&typeof window<"u"){const c=window;if(c.IconifyPreload!==void 0){const l=c.IconifyPreload,h="Invalid IconifyPreload syntax.";typeof l=="object"&&l!==null&&(l instanceof Array?l:[l]).forEach(u=>{try{(typeof u!="object"||u===null||u instanceof Array||typeof u.icons!="object"||typeof u.prefix!="string"||!tb(u))&&console.error(h)}catch{console.error(h)}})}if(c.IconifyProviders!==void 0){const l=c.IconifyProviders;if(typeof l=="object"&&l!==null)for(let h in l){const u="IconifyProviders["+h+"] is invalid.";try{const p=l[h];if(typeof p!="object"||!p||p.resources===void 0)continue;cb(h,p)||console.error(u)}catch{console.error(u)}}}}const Vb={...zo,body:""},ee=Fi({inheritAttrs:!1,data(){return{_name:"",_loadingIcon:null,iconMounted:!1,counter:0}},mounted(){this.iconMounted=!0},unmounted(){this.abortLoading()},methods:{abortLoading(){this._loadingIcon&&(this._loadingIcon.abort(),this._loadingIcon=null)},getIcon(c,l,h){if(typeof c=="object"&&c!==null&&typeof c.body=="string")return this._name="",this.abortLoading(),{data:c};let u;if(typeof c!="string"||(u=Bo(c,!1,!0))===null)return this.abortLoading(),null;let p=Jx(u);if(!p)return(!this._loadingIcon||this._loadingIcon.name!==c)&&(this.abortLoading(),this._name="",p!==null&&(this._loadingIcon={name:c,abort:Lb([u],()=>{this.counter++})})),null;if(this.abortLoading(),this._name!==c&&(this._name=c,l&&l(c)),h){p=Object.assign({},p);const y=h(p.body,u.name,u.prefix,u.provider);typeof y=="string"&&(p.body=y)}const _=["iconify"];return u.prefix!==""&&_.push("iconify--"+u.prefix),u.provider!==""&&_.push("iconify--"+u.provider),{data:p,classes:_}}},render(){this.counter;const c=this.$attrs,l=this.iconMounted||c.ssr?this.getIcon(c.icon,c.onLoad,c.customise):null;if(!l)return Od(Vb,c);let h=c;return l.classes&&(h={...c,class:(typeof c.class=="string"?c.class+" ":"")+l.classes.join(" ")}),Od({...zo,...l.data},h)}});var we,Se,ts,Pt,or,zi,bh,Sh,Uh;const Gh=class Gh{constructor(l,h){Vn(this,zi);Vn(this,we);Vn(this,Se);Vn(this,ts);md(this,"ready");Vn(this,Pt);Vn(this,or,{width:0,height:0,duration:1/0});Wn(this,we,document.createElement("canvas")),Wn(this,Pt,l),Wn(this,ts,h),Wn(this,Se,ft(this,we).getContext("2d"));const u=ft(this,Pt).content.split(`
`),{xPadding:p,yPadding:_}=$n(this,zi,bh).call(this);ft(this,we).width=$n(this,zi,Sh).call(this,u)+p*2,ft(this,we).height=$n(this,zi,Uh).call(this,u)+_*2,this.ready=Promise.resolve({width:ft(this,we).width,height:ft(this,we).height,duration:1/0}),ft(this,Se).font=`${ft(this,Pt).fontSize}px ${ft(this,Pt).fontFamily}`}get textConfig(){return ft(this,Pt)}set textConfig(l){Wn(this,Pt,l)}get meta(){return ft(this,or)}set meta(l){Wn(this,or,l)}async tick(l){const h=ft(this,Pt).content.split(`
`),{xPadding:u,yPadding:p}=$n(this,zi,bh).call(this),_=$n(this,zi,Sh).call(this,h),y=$n(this,zi,Uh).call(this,h);ft(this,we).width=_+u*2,ft(this,we).height=y+p*2,ft(this,or).width=ft(this,we).width,ft(this,or).height=ft(this,we).height,ft(this,ts).call(this,_+u*2,y+p*2),ft(this,Se).clearRect(0,0,ft(this,we).width,ft(this,we).height),ft(this,Se).fillStyle=ft(this,Pt).color,ft(this,Se).font=`${ft(this,Pt).bold?"bold":""} ${ft(this,Pt).italic?"italic":""} ${ft(this,Pt).fontSize}px ${ft(this,Pt).fontFamily}`,ft(this,Se).textBaseline="hanging",ft(this,Pt).showShadow&&(ft(this,Se).shadowColor=ft(this,Pt).shadowColor,ft(this,Se).shadowBlur=ft(this,Pt).shadowBlur,ft(this,Se).shadowOffsetX=ft(this,Pt).shadowOffsetX,ft(this,Se).shadowOffsetY=ft(this,Pt).shadowOffsetY);let s=0,b=0;for(let I=0;I<h.length;I++){let B=ft(this,Pt).fontSize*h[I].length+ft(this,Pt).letterSpacing*(h[I].length-1);switch(ft(this,Pt).align){case"left":s=0;break;case"center":s=(ft(this,we).width-B)/2;break;case"right":s=ft(this,we).width-B;break}for(let T=0;T<h[I].length;T++)ft(this,Pt).showStroke&&(ft(this,Se).lineJoin="round",ft(this,Se).strokeStyle=ft(this,Pt).strokeColor,ft(this,Se).lineWidth=ft(this,Pt).strokeWidth,ft(this,Se).strokeText(h[I][T],s+T*ft(this,Pt).fontSize+ft(this,Pt).letterSpacing*T,I*ft(this,Pt).fontSize+ft(this,Pt).lineSpacing*I+b)),ft(this,Se).fillText(h[I][T],T*ft(this,Pt).fontSize+ft(this,Pt).letterSpacing*T+s,I*ft(this,Pt).fontSize+ft(this,Pt).lineSpacing*I+b)}return{state:"success",video:new VideoFrame(ft(this,we),{timestamp:l})}}async generateImage(){const{video:l}=await this.tick(0),h=new OffscreenCanvas(l.codedWidth,l.codedHeight);h.getContext("2d").drawImage(l,0,0,l.codedWidth,l.codedHeight);const p=await h.convertToBlob(),_=document.createElement("a");_.href=URL.createObjectURL(p),_.download="text.png",_.click()}async clone(){return new Gh(ft(this,Pt),ft(this,ts))}destroy(){ft(this,we).remove()}};we=new WeakMap,Se=new WeakMap,ts=new WeakMap,Pt=new WeakMap,or=new WeakMap,zi=new WeakSet,bh=function(){let l=0,h=0;const u=ft(this,Pt);return l=Math.max(u.showStroke?u.strokeWidth:0,u.showShadow?Math.max(u.shadowBlur,u.shadowOffsetX):0),h=Math.max(u.showStroke?u.strokeWidth:0,u.showShadow?Math.max(u.shadowBlur,u.shadowOffsetY):0),{xPadding:l,yPadding:h}},Sh=function(l){return Math.max(...l.map(h=>ft(this,Pt).fontSize*h.length+ft(this,Pt).letterSpacing*(h.length-1)))},Uh=function(l){return ft(this,Pt).fontSize*l.length+ft(this,Pt).lineSpacing*(l.length-1)};let xh=Gh;const Wb={class:"flex-1 flex items-center justify-center"},$b={class:"control-bar w-full px-4 py-4 flex items-center gap-4"},Xb={class:"text-white text-base"},qb={class:"text-white text-base"},jb={class:"flex w-full items-center justify-center gap-6"},Kb={class:"text-white hover:text-purple-500 transition-colors"},Zb={class:"ml-auto flex items-center gap-4"},Jb=Fi({__name:"Player",props:{tracks:{},currentTime:{},playerDuration:{}},emits:["prevFrame","nextFrame","timeUpdate","captureImage","fullscreenChange","updateClipProps"],setup(c,{expose:l,emit:h}){const u=c,p=h,_=rs(),y=Ah("activeClip"),s=pt(!0),b=pt(!1),I=pt(100),B=pt(!1),T=pt(!1),U=pt(null),G=pt(null),t=pt(0);let e=null;Ue(()=>B.value||I.value===0?"fa-volume-mute":I.value<30?"fa:volume-off":I.value<70?"fa-volume-down":"fa-volume-up");const n=Ue(()=>_.getCanvasSize),a=Ue(()=>{let Y=0;return u.tracks.forEach(K=>{K.clips.forEach(ot=>{Y++})}),Y}),f=Y=>{Y?(e.play({start:u.currentTime*1e6}),b.value=!0):(e.pause(),b.value=!1)},g=()=>{b.value&&f(!1),p("timeUpdate",u.currentTime-1/30),e.previewFrame(u.currentTime*1e6)},v=()=>{b.value&&f(!1),p("timeUpdate",u.currentTime+1/30),e.previewFrame(u.currentTime*1e6)},w=()=>{T.value=!T.value,T.value?G.value&&G.value.requestFullscreen():document.exitFullscreen()},S=Y=>{const K=document.activeElement;if(!(K instanceof HTMLInputElement||K instanceof HTMLTextAreaElement||(K==null?void 0:K.getAttribute("contenteditable"))==="true"))switch(Y.code){case"Space":Y.preventDefault(),f(!b.value);break;case"ArrowLeft":Y.preventDefault(),g();break;case"ArrowRight":Y.preventDefault(),v();break}},L=()=>{e=new Yx(U.value,{bgColor:"#000",width:1920,height:1080}),console.log(e),P(),e.previewFrame(0),e.on("timeupdate",Y=>{p("timeUpdate",Y/1e6)}),e.on("playing",()=>{console.log("playing")}),e.on("paused",()=>{console.log("paused"),u.currentTime>=u.playerDuration&&(b.value=!1,p("timeUpdate",0))}),e.on("activeSpriteChange",Y=>{for(const[K,ot]of F.entries())Object.is(ot,Y)&&y(K)})},F=new Map,P=()=>{u.tracks.forEach(Y=>{Y.clips.forEach(K=>{it(K)})})},M=Y=>{it(Y)},D=Y=>{if(!Y)return e.activeSprite=null;const K=F.get(Y.id);e&&(K!=null&&K.visible)&&(e.activeSprite=K)},it=async Y=>{if(F.has(Y.id))return;let K=null;switch(Y.type){case"video":{let ot=await Kl(Y.path),X=await new kh(await ot.stream());X.tickInterceptor=async(Yt,le)=>{let qe=[];for(const Ne of le.audio)qe.push(Ne.map(ut=>ut=ut*(Y.volume/100)));return le.audio=qe,le},Number(Y.sourceStartTime)>0&&(X=(await X.split(Number(Y.sourceStartTime)*1e6))[1]),K=new Ma(X);break}case"audio":{const ot=await Kl(Y.path);let X=await new Ph(await ot.stream());if(Number(Y.sourceStartTime)>0){const Yt=await X.split(Number(Y.sourceStartTime)*1e6);Number(Y.sourceEndTime)?X=(await Yt[1].split((Number(Y.originalDuration)-Number(Y.sourceEndTime)-Number(Y.sourceStartTime))*1e6))[0]:X=Yt[1]}K=new Ma(X),K.visible=!1;break}case"image":{const ot=await Kl(Y.path);let X=null;if(Y.isAnimateImg){const Yt=ot.name.split(".").pop();X=new vo({type:`image/${Yt}`,stream:await ot.stream()})}else X=new vo(await ot.stream());K=new Ma(X);break}case"text":{const ot=new xh(Y.textConfig,(X,Yt)=>{p("updateClipProps",Y.id,{w:X,h:Yt})});K=new Ma(ot);break}}K&&(K.time.offset=Number(Y.startTime)*1e6,K.time.duration=Number(Y.duration)*1e6,K.opacity=Number((Y.opacity/100).toFixed(2)),K.rect.fixedScaleCenter=!0,K.rect.fixedAspectRatio=!0,F.set(Y.id,K),await(e==null?void 0:e.addSprite(K)),t.value++,Y.type!=="audio"&&(Y.w?(K.rect.x=Y.x,K.rect.y=Y.y,K.rect.w=Y.w,K.rect.h=Y.h,K.rect.angle=Y.angle):Y.type==="text"?p("updateClipProps",Y.id,{x:K.rect.x,y:K.rect.y,w:Y.textConfig.width,h:Y.textConfig.height,angle:K.rect.angle}):p("updateClipProps",Y.id,{x:K.rect.x,y:K.rect.y,w:K.rect.w,h:K.rect.h,angle:K.rect.angle})),K.rect.on("propsChange",ot=>{Y.type==="text"?"w"in ot&&Y.w&&(Y.textConfig.fontSize=ot.w/Y.w*Y.textConfig.fontSize,Y.w=ot.w):p("updateClipProps",Y.id,ot)}),_.unsubscribeFromClipUpdates(Y.id),_.subscribeToClipUpdates(Y.id,async(ot,X)=>{Ft(ot,X)}))},at=()=>{let Y=0;u.tracks.forEach(K=>{K.clips.forEach(ot=>{const X=F.get(ot.id);!X||ot.type==="text"||(X.zIndex=Y++)}),K.clips.forEach(ot=>{const X=F.get(ot.id);!X||ot.type!=="text"||(X.zIndex=Y++)})})},Ft=async(Y,K="default")=>{if(f(!1),console.log("updateClip",Y),!F.has(Y.id))return;const ot=F.get(Y.id);if(K==="delete"){e==null||e.removeSprite(ot),F.delete(Y.id);return}if(K==="resize"&&(Y.type==="video"||Y.type==="audio")){e==null||e.removeSprite(ot),F.delete(Y.id),await it(Y);return}if(ot.time.offset=Y.startTime*1e6,ot.time.duration=Number(Y.duration)*1e6,ot.opacity=Number((Y.opacity/100).toFixed(2)),at(),Y.type==="text"){const X=ot.getClip();X.textConfig=Y.textConfig,ot.rect.w=Y.w,ot.rect.h=Y.h,ot.preFrame(u.currentTime*1e6)}else Y.type!=="audio"&&(ot.rect.x=Y.x,ot.rect.y=Y.y,ot.rect.w=Y.w,ot.rect.h=Y.h,ot.rect.angle=Y.angle)},V=()=>{e==null||e.destroy(),F.clear(),t.value=0,Gs(()=>{L()})},Ct=async()=>{const Y=await(e==null?void 0:e.createCombinator());try{const K={dangerouslyUseHTMLString:!0,showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1,showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"停止",customClass:"export-progress-dialog",beforeClose:(ot,X,Yt)=>{ot==="cancel"&&(Y==null||Y.destroy(),Yt())}};jl.alert(`
            <div class="flex flex-col gap-2 w-full min-w-[300px]">
                <div class="text-center text-base">0%</div>
                <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        `,"导出进度",K),await Gs(),Y.on("OutputProgress",ot=>{const X=Math.round(ot*100),Yt=document.querySelector(".el-message-box__message");if(Yt&&(Yt.innerHTML=`
                    <div class="flex flex-col gap-2 w-full min-w-[300px]">
                        <div class="text-center text-base">${X}%</div>
                        <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: ${X}%"></div>
                        </div>
                    </div>
                `,ot===1)){const le=document.querySelector(".el-message-box__cancel");le&&(le.style.display="none"),Yt.innerHTML=`
                        <div class="flex flex-col gap-2 w-full min-w-[300px]">
                            <div class="text-center text-green-500 text-base">导出完成！</div>
                            <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                            </div>
                        </div>
                    `,setTimeout(()=>{jl.close()},3e3)}}),await(Y==null?void 0:Y.output().pipeTo(await sw()))}catch(K){jl.close(),lr.error("导出失败："+K.message)}},At=Y=>{const K=Math.floor(Y/60),ot=Math.floor(Y%60);return`${K}:${ot.toString().padStart(2,"0")}`},Gt=()=>{G.value&&new ResizeObserver(K=>{var ot;for(let X of K){const{width:Yt,height:le}=X.contentRect,qe=(ot=document.querySelector(".control-bar"))==null?void 0:ot.clientHeight,Ne=le-qe;Yt/Ne>1.7777777777777777?_.setCanvasSize({width:Ne*16/9,height:Ne}):_.setCanvasSize({width:Yt,height:Yt*9/16})}}).observe(G.value)};es(()=>{zt.setLogLevel(zt.warn),L(),Gt(),window.addEventListener("keydown",S)}),$s(()=>{e==null||e.destroy(),F.clear(),e=null,t.value=0,window.removeEventListener("keydown",S);for(const Y of F.keys())_.unsubscribeFromClipUpdates(Y)}),zn(()=>t.value,Y=>{if(Y===a.value){s.value=!1,e==null||e.previewFrame(u.currentTime*1e6);for(const K of u.tracks.flatMap(ot=>ot.clips))at();setTimeout(()=>{const K=e==null?void 0:e.captureImage();p("captureImage",K)},500)}}),zn(()=>u.currentTime,Y=>{b.value||e.previewFrame(Y*1e6)}),l({refreshPlayer:V,addClip:M,activeClip:D,handleExport:Ct});const nt=document.createElement("style");return nt.textContent=`
.export-progress-dialog .el-message-box__content {
    padding: 20px;
}
.export-progress-dialog .el-message-box__message {
    padding: 0;
}
.export-progress-dialog .el-message-box__message p {
    margin: 0;
}
.export-progress-dialog .el-message-box__container {
    width: 100%;
}
`,document.head.appendChild(nt),(Y,K)=>{const ot=ew("loading");return tw((mt(),Ut("div",{ref_key:"playerRef",ref:G,class:"player-container w-full h-full bg-[#1b1b1b] relative flex flex-col"},[N("div",Wb,[N("div",{ref_key:"avCanvas",ref:U,class:"",style:Wi({width:Et(n).width+"px",height:Et(n).height+"px"})},null,4)]),N("div",$b,[N("div",Xb,Xe(At(Y.currentTime)),1),K[2]||(K[2]=N("div",{class:"text-white text-base"},"/",-1)),N("div",qb,Xe(At(Y.playerDuration)),1),N("div",jb,[N("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:g},[et(Et(ee),{icon:"fa-step-backward"})]),N("button",Kb,[Et(b)?(mt(),fn(Et(ee),{key:1,icon:"fa-pause",onClick:K[1]||(K[1]=X=>f(!1))})):(mt(),fn(Et(ee),{key:0,icon:"fa-play",onClick:K[0]||(K[0]=X=>f(!0))}))]),N("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:g},[et(Et(ee),{icon:"fa-step-forward"})])]),N("div",Zb,[N("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:w},[et(Et(ee),{icon:Et(T)?"fa-compress":"fa-expand"},null,8,["icon"])])])])])),[[ot,Et(s)]])}}}),Qb=ss(Jb,[["__scopeId","data-v-d616b200"]]);let Oa;const t1=new Uint8Array(16);function e1(){if(!Oa&&(Oa=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Oa))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Oa(t1)}const Te=[];for(let c=0;c<256;++c)Te.push((c+256).toString(16).slice(1));function i1(c,l=0){return Te[c[l+0]]+Te[c[l+1]]+Te[c[l+2]]+Te[c[l+3]]+"-"+Te[c[l+4]]+Te[c[l+5]]+"-"+Te[c[l+6]]+Te[c[l+7]]+"-"+Te[c[l+8]]+Te[c[l+9]]+"-"+Te[c[l+10]]+Te[c[l+11]]+Te[c[l+12]]+Te[c[l+13]]+Te[c[l+14]]+Te[c[l+15]]}const n1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Nd={randomUUID:n1};function Zr(c,l,h){if(Nd.randomUUID&&!c)return Nd.randomUUID();c=c||{};const u=c.random||(c.rng||e1)();return u[6]=u[6]&15|64,u[8]=u[8]&63|128,i1(u)}const r1={class:"p-5"},s1={class:"flex items-center justify-center"},a1={class:"flex items-center justify-center"},o1={class:"h-[calc(100vh-7rem)] mt-2 overflow-y-auto"},l1={class:"w-full grid grid-cols-2 gap-3"},h1=["onContextmenu","onMouseover","onMouseleave","onDragstart"],u1={class:"relative w-full h-full bg-[#121212]"},f1=["src"],d1=["src"],c1={key:2,class:"w-full aspect-video flex items-center justify-center"},p1={key:3,class:"absolute w-[12%] h-[12%] right-[16%] bottom-[12%] flex items-center gap-1 rounded-full"},_1={class:"text-tiny truncate mt-1"},g1=Fi({__name:"mediaLibrary",emits:["add-clip"],setup(c,{emit:l}){const h=rs(),u=Ah("addClip"),p=pt([]),_=new Map,y=g=>v=>{_.set(g,v)};es(()=>{s()});const s=()=>{Vi.medias.toArray().then(async g=>{if(g){let v=[];for(const w of g){const S=await aw(w.path);v.push({...w,filePath:S})}p.value=v}})},b=async g=>{const v=await Vi.medias.where({name:g.name}).first();if(v&&v.size===g.size)return lr.warning("文件已存在"),!1;const w=g.name.split(".").pop();let S="";switch(w){case"mp4":case"mov":case"avi":case"wmv":S="video";break;case"mp3":case"wav":case"m4a":case"m4s":case"m3u8":case"aac":case"ogg":case"flac":case"webm":case"opus":S="audio";break;case"png":case"jpg":case"jpeg":case"gif":case"bmp":case"tiff":case"ico":case"svg":case"webp":case"avif":S="image";break;default:return lr.warning("请检查文件格式"),!1}let L="/"+S+"/"+g.name;const F=await Hs(L);let P=!1;if(F.exists()&&(await F.remove(),P=!0),await Th(L,g.stream()),await Hs(L).exists()){const M={name:g.name,size:g.size,type:S,path:L,isAnimateImg:!1};switch(S){case"video":const it=await new kh(g.stream()).ready;it&&(M.duration=it.duration);break;case"audio":const Ft=await new Ph(await g.stream()).ready;Ft&&(M.duration=Ft.duration);break;case"image":try{M.duration=3e6;const V=["gif","webp","avif","webp"],Ct=g.name.split(".").pop();if(V.includes(Ct)){const At=new vo({type:`image/${Ct}`,stream:await g.stream()}),Gt=await At.ready;console.log(Gt);const{video:nt}=await At.tick(0),{video:Y}=await At.tick(1e6),ot=new OffscreenCanvas(nt.codedWidth,nt.codedHeight).getContext("2d");ot.drawImage(nt,0,0);const X=ot.getImageData(0,0,nt.codedWidth,nt.codedHeight);ot.clearRect(0,0,nt.codedWidth,nt.height),ot.drawImage(Y,0,0);const Yt=ot.getImageData(0,0,Y.codedWidth,Y.codedHeight),le=I(X.data,Yt.data);M.isAnimateImg=!0}else M.isAnimateImg=!1}catch(V){console.log(V)}break}console.log(M.duration),P&&v?(M.updateTime=new Date().getTime(),await Vi.medias.where({name:g.name}).modify(M)):(M.createTime=new Date().getTime(),await Vi.medias.add(M)),s()}else lr.error("上传失败");return!1},I=(g,v)=>{if(g.length!==v.length)return!1;for(let w=0;w<g.length;w++)if(g[w]!==v[w])return!1;return!0},B=Ue(()=>h.getShowContextMenu),T=Ue(()=>h.getContextMenuPosition),U=pt(""),G=(g,v)=>{U.value=v.id,h.setShowContextMenu(!0);const{offsetX:w,offsetY:S}=g;h.setContextMenuPosition({x:w,y:S}),console.log(T.value)},t=(g,v)=>{g.hovered=!0;const w=_.get(v);w&&g.type==="video"&&w.play()},e=(g,v)=>{g.hovered=!1;const w=_.get(v);w&&g.type==="video"&&(w.currentTime=0,w.pause())},n=(g,v)=>{g.dataTransfer&&(g.dataTransfer.effectAllowed="move",g.dataTransfer.setData("application/json",JSON.stringify(v)),g.dataTransfer.setData("text/plain",JSON.stringify(v)),h.setDragData(v))},a=g=>{const v={id:Zr(),type:g.type,isAnimateImg:g.isAnimateImg,name:g.name,path:g.path,duration:g.duration?Number(g.duration)/1e6:5,startTime:0,endTime:g.duration?Number(g.duration)/1e6:5,opacity:100,angle:0};g.type==="image"&&(v.duration=5,v.endTime=5),u==null||u(v,!0)},f=g=>{Vi.medias.where({id:g.id}).delete(),s()};return(g,v)=>{const w=Jt("upload-filled"),S=Jt("el-icon"),L=Jt("el-upload"),F=Jt("Headset"),P=Jt("CirclePlus"),M=Jt("DeleteFilled");return mt(),Ut("div",r1,[N("div",s1,[et(L,{class:"w-full",drag:"",action:"163",multiple:"","show-file-list":!1,"before-upload":b},{tip:Ht(()=>v[1]||(v[1]=[])),default:Ht(()=>[N("div",a1,[et(S,{class:"mr-1",size:"30"},{default:Ht(()=>[et(w)]),_:1}),v[0]||(v[0]=N("div",{class:"flex flex-col items-start"},[N("div",{class:"text-tiny"}," 拖拽或上传文件 "),N("div",{class:"flex items-center justify-center text-xs"}," 支持视频、音频、图片格式 ")],-1))])]),_:1})]),N("div",o1,[N("div",l1,[(mt(!0),Ut(mi,null,Fn(p.value,(D,it)=>(mt(),Ut("div",{class:"relative flex flex-col justify-center w-full hover:bg-[#121212] p-1.5 rounded-md",onContextmenu:$e(at=>G(at,D),["prevent"]),onMouseover:at=>t(D,it),onMouseleave:at=>e(D,it),onDragstart:at=>n(at,D),draggable:"true"},[N("div",u1,[D.type==="image"?(mt(),Ut("img",{key:0,src:D.filePath,alt:"",class:"aspect-video object-contain rounded"},null,8,f1)):ue("",!0),D.type==="video"?(mt(),Ut("video",{key:1,ref_for:!0,ref:y(it),src:D.filePath,muted:"",loop:"",disablepictureinpicture:"",class:"aspect-video object-contain rounded"},null,8,d1)):ue("",!0),D.type==="audio"?(mt(),Ut("div",c1,[et(S,null,{default:Ht(()=>[et(F)]),_:1})])):ue("",!0),D.hovered?(mt(),Ut("div",p1,[et(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:$e(at=>a(D),["stop"])},{default:Ht(()=>[et(P)]),_:2},1032,["onClick"]),et(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:$e(at=>f(D),["stop"])},{default:Ht(()=>[et(M)]),_:2},1032,["onClick"])])):ue("",!0),Et(B)&&D.id===U.value?(mt(),Ut("div",{key:4,class:"absolute flex flex-col justify-center bg-[#121212] py-1.5 rounded-md",style:Wi({left:Et(T).x+"px",top:Et(T).y+"px"})},v[2]||(v[2]=[N("div",{class:"px-3 py-0.5 text-tiny hover:bg-gray cursor-pointer"},"裁剪",-1)]),4)):ue("",!0)]),N("div",_1,Xe(D.name),1)],40,h1))),256))])])])}}}),m1=ss(g1,[["__scopeId","data-v-30c9ea77"]]),v1=""+new URL("1-DX-6C8MT.png",import.meta.url).href,y1=""+new URL("2-Bbrfykah.png",import.meta.url).href,Gd=c=>new URL(Object.assign({"../assets/image/text/1.png":v1,"../assets/image/text/2.png":y1})[`../assets/image/${c}`],import.meta.url).href,w1=[{preview:Gd("text/1.png"),name:"描边标题",style:{content:"描边文字效果",fontSize:48,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFFFFF",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!1,shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,showStroke:!0,strokeColor:"red",strokeWidth:3}},{preview:Gd("text/2.png"),name:"阴影标题",style:{content:"阴影文字效果",fontSize:52,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFD93D",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!0,shadowColor:"rgba(59, 59, 59, 1)",shadowBlur:10,shadowOffsetX:4,shadowOffsetY:4,showStroke:!1,strokeColor:"#000000",strokeWidth:0}}],x1={class:"p-4"},b1={class:"grid grid-cols-2 gap-4"},S1={class:"h-8 text-white text-xl mb-2"},U1={class:"text-[#666] text-sm"},E1={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},C1=["onClick","onDragstart"],A1={class:"h-8 text-white text-xl mb-2"},T1=["src"],I1={class:"text-[#666] text-sm"},B1={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},z1=Fi({__name:"textLibrary",setup(c){const l=rs(),h=Ah("addClip"),u=pt({preview:"Aa",name:"基础文字",style:{fontSize:72,fontFamily:"Microsoft YaHei",color:"#ffffff"}}),p=s=>{const b=y(s);l.setDragData(b)},_=s=>{const b=y(s);h==null||h(b,!0)},y=s=>({id:Zr(),type:"text",name:s.name,duration:5,startTime:0,endTime:5,opacity:100,angle:0,textConfig:{content:s.name||"基础文字",lineSpacing:0,letterSpacing:0,showStroke:!1,strokeColor:"#ffffff",strokeWidth:0,showShadow:!1,shadowColor:"#ffffff",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,...s.style}});return(s,b)=>{const I=Jt("el-icon");return mt(),Ut("div",x1,[N("div",b1,[N("div",{class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",onClick:b[0]||(b[0]=B=>_(Et(u))),draggable:"true",onDragstart:b[1]||(b[1]=B=>p(Et(u)))},[N("div",S1,Xe(Et(u).preview),1),N("div",U1,Xe(Et(u).name),1),N("div",E1,[et(I,{class:"text-white text-2xl"},{default:Ht(()=>[et(Et(yd))]),_:1})])],32),(mt(!0),Ut(mi,null,Fn(Et(w1),B=>(mt(),Ut("div",{key:B.name,class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",onClick:T=>_(B),draggable:"true",onDragstart:T=>p(B)},[N("div",A1,[N("img",{src:B.preview,class:"w-full h-full object-contain"},null,8,T1)]),N("div",I1,Xe(Et(u).name),1),N("div",B1,[et(I,{class:"text-white text-2xl"},{default:Ht(()=>[et(Et(yd))]),_:1})])],40,C1))),128))])])}}}),F1={class:"h-screen"},L1={class:"flex flex-col items-center justify-center"},k1=Fi({__name:"clipMenu",setup(c){const l=[{name:"媒体库",component:m1},{name:"文字",component:z1}];return(h,u)=>{const p=Jt("Files"),_=Jt("el-icon"),y=Jt("el-tab-pane"),s=Jt("el-tabs");return mt(),Ut("div",F1,[et(s,{type:"border-card",tabPosition:"left"},{default:Ht(()=>[(mt(),Ut(mi,null,Fn(l,b=>et(y,{label:"User"},{label:Ht(()=>[N("div",L1,[et(_,null,{default:Ht(()=>[et(p)]),_:1}),N("div",null,Xe(b.name),1)])]),default:Ht(()=>[(mt(),fn(iw(b.component),{class:"w-full h-screen bg-[#303030]"}))]),_:2},1024)),64))]),_:1})])}}}),P1=ss(k1,[["__scopeId","data-v-70893c60"]]);var gi=typeof window<"u"?window:null,Nh=gi===null,Ws=Nh?void 0:gi.document,Si="addEventListener",Ui="removeEventListener",ih="getBoundingClientRect",Is="_a",Ei="_b",nn="_c",Na="horizontal",Ci=function(){return!1},D1=Nh?"calc":["","-webkit-","-moz-","-o-"].filter(function(c){var l=Ws.createElement("div");return l.style.cssText="width:"+c+"calc(9px)",!!l.style.length}).shift()+"calc",Fc=function(c){return typeof c=="string"||c instanceof String},Hd=function(c){if(Fc(c)){var l=Ws.querySelector(c);if(!l)throw new Error("Selector "+c+" did not match a DOM element");return l}return c},Fe=function(c,l,h){var u=c[l];return u!==void 0?u:h},Ga=function(c,l,h,u){if(l){if(u==="end")return 0;if(u==="center")return c/2}else if(h){if(u==="start")return 0;if(u==="center")return c/2}return c},R1=function(c,l){var h=Ws.createElement("div");return h.className="gutter gutter-"+l,h},M1=function(c,l,h){var u={};return Fc(l)?u[c]=l:u[c]=D1+"("+l+"% - "+h+"px)",u},O1=function(c,l){var h;return h={},h[c]=l+"px",h},Yd=function(c,l){if(l===void 0&&(l={}),Nh)return{};var h=c,u,p,_,y,s,b;Array.from&&(h=Array.from(h));var I=Hd(h[0]),B=I.parentNode,T=getComputedStyle?getComputedStyle(B):null,U=T?T.flexDirection:null,G=Fe(l,"sizes")||h.map(function(){return 100/h.length}),t=Fe(l,"minSize",100),e=Array.isArray(t)?t:h.map(function(){return t}),n=Fe(l,"maxSize",1/0),a=Array.isArray(n)?n:h.map(function(){return n}),f=Fe(l,"expandToMin",!1),g=Fe(l,"gutterSize",10),v=Fe(l,"gutterAlign","center"),w=Fe(l,"snapOffset",30),S=Array.isArray(w)?w:h.map(function(){return w}),L=Fe(l,"dragInterval",1),F=Fe(l,"direction",Na),P=Fe(l,"cursor",F===Na?"col-resize":"row-resize"),M=Fe(l,"gutter",R1),D=Fe(l,"elementStyle",M1),it=Fe(l,"gutterStyle",O1);F===Na?(u="width",p="clientX",_="left",y="right",s="clientWidth"):F==="vertical"&&(u="height",p="clientY",_="top",y="bottom",s="clientHeight");function at(ut,J,lt,ct){var ie=D(u,J,lt,ct);Object.keys(ie).forEach(function(Xt){ut.style[Xt]=ie[Xt]})}function Ft(ut,J,lt){var ct=it(u,J,lt);Object.keys(ct).forEach(function(ie){ut.style[ie]=ct[ie]})}function V(){return b.map(function(ut){return ut.size})}function Ct(ut){return"touches"in ut?ut.touches[0][p]:ut[p]}function At(ut){var J=b[this.a],lt=b[this.b],ct=J.size+lt.size;J.size=ut/this.size*ct,lt.size=ct-ut/this.size*ct,at(J.element,J.size,this[Ei],J.i),at(lt.element,lt.size,this[nn],lt.i)}function Gt(ut){var J,lt=b[this.a],ct=b[this.b];this.dragging&&(J=Ct(ut)-this.start+(this[Ei]-this.dragOffset),L>1&&(J=Math.round(J/L)*L),J<=lt.minSize+lt.snapOffset+this[Ei]?J=lt.minSize+this[Ei]:J>=this.size-(ct.minSize+ct.snapOffset+this[nn])&&(J=this.size-(ct.minSize+this[nn])),J>=lt.maxSize-lt.snapOffset+this[Ei]?J=lt.maxSize+this[Ei]:J<=this.size-(ct.maxSize-ct.snapOffset+this[nn])&&(J=this.size-(ct.maxSize+this[nn])),At.call(this,J),Fe(l,"onDrag",Ci)(V()))}function nt(){var ut=b[this.a].element,J=b[this.b].element,lt=ut[ih](),ct=J[ih]();this.size=lt[u]+ct[u]+this[Ei]+this[nn],this.start=lt[_],this.end=lt[y]}function Y(ut){if(!getComputedStyle)return null;var J=getComputedStyle(ut);if(!J)return null;var lt=ut[s];return lt===0?null:(F===Na?lt-=parseFloat(J.paddingLeft)+parseFloat(J.paddingRight):lt-=parseFloat(J.paddingTop)+parseFloat(J.paddingBottom),lt)}function K(ut){var J=Y(B);if(J===null||e.reduce(function(Xt,Wt){return Xt+Wt},0)>J)return ut;var lt=0,ct=[],ie=ut.map(function(Xt,Wt){var Rt=J*Xt/100,vi=Ga(g,Wt===0,Wt===ut.length-1,v),pe=e[Wt]+vi;return Rt<pe?(lt+=pe-Rt,ct.push(0),pe):(ct.push(Rt-pe),Rt)});return lt===0?ut:ie.map(function(Xt,Wt){var Rt=Xt;if(lt>0&&ct[Wt]-lt>0){var vi=Math.min(lt,ct[Wt]-lt);lt-=vi,Rt=Xt-vi}return Rt/J*100})}function ot(){var ut=this,J=b[ut.a].element,lt=b[ut.b].element;ut.dragging&&Fe(l,"onDragEnd",Ci)(V()),ut.dragging=!1,gi[Ui]("mouseup",ut.stop),gi[Ui]("touchend",ut.stop),gi[Ui]("touchcancel",ut.stop),gi[Ui]("mousemove",ut.move),gi[Ui]("touchmove",ut.move),ut.stop=null,ut.move=null,J[Ui]("selectstart",Ci),J[Ui]("dragstart",Ci),lt[Ui]("selectstart",Ci),lt[Ui]("dragstart",Ci),J.style.userSelect="",J.style.webkitUserSelect="",J.style.MozUserSelect="",J.style.pointerEvents="",lt.style.userSelect="",lt.style.webkitUserSelect="",lt.style.MozUserSelect="",lt.style.pointerEvents="",ut.gutter.style.cursor="",ut.parent.style.cursor="",Ws.body.style.cursor=""}function X(ut){if(!("button"in ut&&ut.button!==0)){var J=this,lt=b[J.a].element,ct=b[J.b].element;J.dragging||Fe(l,"onDragStart",Ci)(V()),ut.preventDefault(),J.dragging=!0,J.move=Gt.bind(J),J.stop=ot.bind(J),gi[Si]("mouseup",J.stop),gi[Si]("touchend",J.stop),gi[Si]("touchcancel",J.stop),gi[Si]("mousemove",J.move),gi[Si]("touchmove",J.move),lt[Si]("selectstart",Ci),lt[Si]("dragstart",Ci),ct[Si]("selectstart",Ci),ct[Si]("dragstart",Ci),lt.style.userSelect="none",lt.style.webkitUserSelect="none",lt.style.MozUserSelect="none",lt.style.pointerEvents="none",ct.style.userSelect="none",ct.style.webkitUserSelect="none",ct.style.MozUserSelect="none",ct.style.pointerEvents="none",J.gutter.style.cursor=P,J.parent.style.cursor=P,Ws.body.style.cursor=P,nt.call(J),J.dragOffset=Ct(ut)-J.end}}G=K(G);var Yt=[];b=h.map(function(ut,J){var lt={element:Hd(ut),size:G[J],minSize:e[J],maxSize:a[J],snapOffset:S[J],i:J},ct;if(J>0&&(ct={a:J-1,b:J,dragging:!1,direction:F,parent:B},ct[Ei]=Ga(g,J-1===0,!1,v),ct[nn]=Ga(g,!1,J===h.length-1,v),U==="row-reverse"||U==="column-reverse")){var ie=ct.a;ct.a=ct.b,ct.b=ie}if(J>0){var Xt=M(J,F,lt.element);Ft(Xt,g,J),ct[Is]=X.bind(ct),Xt[Si]("mousedown",ct[Is]),Xt[Si]("touchstart",ct[Is]),B.insertBefore(Xt,lt.element),ct.gutter=Xt}return at(lt.element,lt.size,Ga(g,J===0,J===h.length-1,v),J),J>0&&Yt.push(ct),lt});function le(ut){var J=ut.i===Yt.length,lt=J?Yt[ut.i-1]:Yt[ut.i];nt.call(lt);var ct=J?lt.size-ut.minSize-lt[nn]:ut.minSize+lt[Ei];At.call(lt,ct)}b.forEach(function(ut){var J=ut.element[ih]()[u];J<ut.minSize&&(f?le(ut):ut.minSize=J)});function qe(ut){var J=K(ut);J.forEach(function(lt,ct){if(ct>0){var ie=Yt[ct-1],Xt=b[ie.a],Wt=b[ie.b];Xt.size=J[ct-1],Wt.size=lt,at(Xt.element,Xt.size,ie[Ei],Xt.i),at(Wt.element,Wt.size,ie[nn],Wt.i)}})}function Ne(ut,J){Yt.forEach(function(lt){if(J!==!0?lt.parent.removeChild(lt.gutter):(lt.gutter[Ui]("mousedown",lt[Is]),lt.gutter[Ui]("touchstart",lt[Is])),ut!==!0){var ct=D(u,lt.a.size,lt[Ei]);Object.keys(ct).forEach(function(ie){b[lt.a].element.style[ie]="",b[lt.b].element.style[ie]=""})}})}return{setSizes:qe,getSizes:V,collapse:function(J){le(b[J])},destroy:Ne,parent:B,pairs:Yt}};const N1={class:"ticks h-full"},G1={key:0,class:"tick-mark"},H1={key:1,class:"tick-mark-long"},Y1={key:2,class:"tick-label"},Ar=3,Vd=100,V1=15,W1=Fi({__name:"timelineRuler",props:{duration:{type:Number,required:!0},zoom:{type:Number,default:1},currentTime:{type:Number,default:0},totalWidth:{type:Number,default:0}},emits:["timeUpdate","scroll"],setup(c,{emit:l}){const h=c,u=l,p=pt(null),_=Ue(()=>Ar*h.zoom),y=Ue(()=>Math.ceil(h.duration*10)),s=Ue(()=>h.currentTime*Ar*h.zoom*10),b=pt(!1),I=pt(0),B=pt(null);let T=null,U=pt(0);const G=v=>{const w=Math.floor(v/10),S=Math.floor(w/60),L=w%60;return`${S}:${L.toString().padStart(2,"0")}`},t=v=>{if(!p.value)return;const w=p.value.getBoundingClientRect(),L=(v.clientX-w.left)/(Ar*h.zoom*10);u("timeUpdate",Math.max(0,Math.min(L,h.duration))),n(v)},e=v=>{if(v.stopPropagation(),!p.value)return;const w=p.value.getBoundingClientRect(),S=v.clientX-w.left,L=Math.max(0,Math.min(S/(Ar*h.zoom*10),h.duration));u("timeUpdate",L),n(v)},n=v=>{b.value=!0,I.value=v.clientX,U.value=v.clientX,document.addEventListener("mousemove",f),document.addEventListener("mouseup",g)},a=()=>{if(!(!b.value||!p.value||!p.value.parentElement)&&B.value){u("scroll",B.value==="right"?V1:-15);const w=p.value.getBoundingClientRect(),S=I.value-w.left,L=Math.max(0,Math.min(S/(Ar*h.zoom*10),h.duration));u("timeUpdate",L),T=requestAnimationFrame(a)}},f=v=>{if(!b.value||!p.value)return;const w=p.value.getBoundingClientRect(),S=p.value.parentElement;if(!S)return;const L=v.clientX-w.left,F=v.clientX-U.value;if(U.value=v.clientX,F!==0){const M=S.getBoundingClientRect();F>0?v.clientX>M.right-Vd?B.value!=="right"&&(B.value="right",a()):B.value=null:v.clientX<M.left+Vd?B.value!=="left"&&(B.value="left",a()):B.value=null}const P=Math.max(0,Math.min(L/(Ar*h.zoom*10),h.duration));u("timeUpdate",P),I.value=v.clientX},g=()=>{b.value=!1,B.value=null,document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",g),T!==null&&(cancelAnimationFrame(T),T=null)};return $s(()=>{T!==null&&cancelAnimationFrame(T)}),(v,w)=>(mt(),Ut(mi,null,[N("div",{class:"ticks-container h-10",ref_key:"rulerContainer",ref:p,style:Wi({width:c.totalWidth+"px"}),onMousedown:t},[N("div",N1,[(mt(!0),Ut(mi,null,Fn(Et(y),S=>(mt(),Ut("div",{key:S,class:"tick h-full",style:Wi({left:S*Et(_)+"px"})},[S%5===0?(mt(),Ut("div",G1)):ue("",!0),S%50===0?(mt(),Ut("div",H1)):ue("",!0),S%50===0?(mt(),Ut("span",Y1,Xe(G(S)),1)):ue("",!0)],4))),128))])],36),N("div",{class:"playhead",style:Wi({left:Et(s)+"px"}),onMousedown:e},w[0]||(w[0]=[N("div",{class:"playhead-line"},null,-1),N("div",{class:"playhead-triangle"},null,-1)]),36)],64))}}),$1=ss(W1,[["__scopeId","data-v-9b78982e"]]),X1={class:"w-full h-full p-1 flex flex-col justify-center items-center pointer-events-none select-none"},q1={key:0,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},j1=["src"],K1={key:1,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},Z1=["src"],J1={key:2,class:"w-full h-full flex flex-col relative rounded"},Q1={class:"absolute inset-0"},tS={key:0,class:"absolute inset-0 w-auto h-full flex items-center bg-[#ffffff] bg-opacity-10 text-[#000000]"},eS={class:"text-base inline-block truncate px-5 z-10"},iS={key:3,class:"mt-1 text-bigger pl-4 text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},nS={key:4,class:"mt-1 text-xs text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},rS=Fi({__name:"trackItem",props:{clip:{type:Object,required:!0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},hovered:{type:Boolean,default:!1}},setup(c){const l=c,h=Ue(()=>70/l.frameLength),u=pt([]),p=pt(null),_=()=>{try{if(!l.clip.thumbnail||!Array.isArray(l.clip.thumbnail)){u.value=[];return}const s=Number(l.clip.duration);if(isNaN(s)||s<=0){console.warn("Invalid clip duration:",s);return}const b=Math.ceil(s/h.value),I=[];if(l.clip.type==="image"&&l.clip.thumbnail.length>0){const B=l.clip.thumbnail[0];for(let T=0;T<b;T++)I.push(B)}else if(l.clip.type==="video"&&l.clip.thumbnail.length>0){const B=l.clip.thumbnail;let T=B[0];for(let U=0;U<b;U++){const G=U*h.value,t=B.find(e=>e.timestamp/1e6>=G)||T||B[B.length-1];t&&(I.push(t),T=t)}}u.value=I}catch(s){console.error("Error updating thumbnails:",s),u.value=[]}},y=()=>{try{if(!p.value||!l.clip.volumeData)return;const s=p.value,b=s.getContext("2d");if(!b)return;const I=s.getBoundingClientRect();if(s.width=I.width*window.devicePixelRatio,s.height=I.height*window.devicePixelRatio,b.clearRect(0,0,s.width,s.height),!l.clip.originalDuration){console.warn("Missing originalDuration for audio clip");return}const B=l.clip.volumeData.slice(l.clip.sourceStartTime/l.clip.originalDuration*l.clip.volumeData.length,(l.clip.originalDuration-l.clip.sourceEndTime)/l.clip.originalDuration*l.clip.volumeData.length);if(!B.length){console.warn("No volume data available");return}const T=2,U=2,G=Math.floor(s.width/(T+U)),t=s.height*.8,e=B.length/G;b.fillStyle="#ffffff80";for(let n=0;n<G;n++){const a=Math.floor(n*e),g=(B[a]||0)*t,v=n*(T+U),w=(s.height-g)/2;b.fillRect(v,w,T,g)}}catch(s){console.error("Error drawing waveform:",s)}};return zn([()=>l.frameLength,()=>l.zoom,()=>l.clip.duration,()=>l.clip.sourceStartTime,()=>l.clip.sourceEndTime,()=>l.clip.thumbnail],()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&Gs(()=>{_()})},{deep:!0,immediate:!0}),zn(()=>l.clip.thumbnail,()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&Gs(()=>{_()})},{deep:!0,immediate:!0}),es(()=>{if(l.clip.type==="audio"){const s=new ResizeObserver(()=>{y()});p.value&&(s.observe(p.value),y())}}),(s,b)=>(mt(),Ut("div",X1,[c.clip.type==="video"?(mt(),Ut("div",q1,[u.value.length>0?(mt(!0),Ut(mi,{key:0},Fn(u.value,I=>(mt(),Ut("img",{key:I.timestamp,src:I.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,j1))),128)):ue("",!0)])):ue("",!0),c.clip.type==="image"?(mt(),Ut("div",K1,[u.value.length>0?(mt(!0),Ut(mi,{key:0},Fn(u.value,I=>(mt(),Ut("img",{key:I.timestamp,src:I.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,Z1))),128)):ue("",!0)])):c.clip.type==="audio"?(mt(),Ut("div",J1,[N("div",Q1,[N("canvas",{ref_key:"waveformCanvas",ref:p,class:"w-full h-full"},null,512)]),c.hovered?(mt(),Ut("div",tS,[N("span",eS,Xe(c.clip.name),1)])):ue("",!0)])):c.clip.type==="text"?(mt(),Ut("div",iS,Xe(c.clip.textConfig.content),1)):c.clip.type==="sticker"?(mt(),Ut("div",nS,Xe(c.clip.name),1)):ue("",!0)]))}}),sS=ss(rS,[["__scopeId","data-v-4096df5f"]]),aS=["data-track","onDragenter","onDragleave"],oS=["data-clip","onMousedown","onMouseover","onMouseleave"],lS=["onMousedown"],hS=["onMousedown"],uS=Fi({__name:"tracksList",props:{tracks:{type:Array,required:!0},hoveredTrack:{type:Number,default:-1},dragPreview:{type:Boolean,default:!1},dragPreviewPosition:{type:Number,default:0},dragPreviewWidth:{type:Number,default:0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},isReplaceMode:{type:Boolean,default:!1}},emits:["track-drag-enter","track-drag-leave","clip-mouse-down","background-click","save-history-state","clip-hover","start-resize","delete-clip"],setup(c,{expose:l,emit:h}){const u=c,p=h,_=pt(void 0),y=pt(void 0),s=()=>{u.tracks.forEach(w=>{w.clips.forEach(S=>{S.selected=!1})}),y.value=void 0},b=w=>{s(),w&&(w.selected=!0,y.value=w)},I=w=>{w.preventDefault()},B=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect();w.clientX-S.left;const L=w.clientY-S.top,F=S.height/u.tracks.length,P=Math.floor(L/F);P>=0&&P<u.tracks.length&&p("track-drag-enter",P)},T=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect(),L=w.clientX,F=w.clientY;(L<S.left||L>S.right||F<S.top||F>S.bottom)&&p("track-drag-leave",u.hoveredTrack)},U=w=>{p("track-drag-enter",w)},G=w=>{p("track-drag-leave",w)},t=(w,S,L)=>{w.stopPropagation(),w.preventDefault(),u.tracks.forEach(P=>{P.clips.forEach(M=>{M!==S&&(M.selected=!1)})}),S.selected=!0,y.value=S,_.value=void 0;const F=w.target;!F.classList.contains("resize-handle")&&!F.closest(".resize-handle")&&p("clip-mouse-down",S,L,w)},e=w=>{y.value||(_.value=w,w.selected=!0),p("clip-hover",w)},n=w=>{_.value===w&&!y.value&&(_.value=void 0,w.selected=!1)},a=(w,S,L)=>{p("start-resize",w,S,L)},f=w=>{s(),p("background-click"),_.value=void 0},g=w=>{const S=document.activeElement;(S==null?void 0:S.tagName)==="INPUT"||(S==null?void 0:S.tagName)==="TEXTAREA"||(S==null?void 0:S.getAttribute("contenteditable"))==="true"||S!=null&&S.classList.contains("el-input__inner")||S!=null&&S.classList.contains("el-textarea__inner")||(w.key==="Delete"||w.key==="Backspace")&&(u.tracks.forEach((F,P)=>{F.clips.filter(D=>D.selected||D===y.value).forEach(D=>{p("delete-clip",D,P)})}),v())},v=()=>{p("save-history-state")};return es(()=>{window.addEventListener("keydown",g);const w=document.querySelector(".tracks-list");w&&w.focus()}),$s(()=>{window.removeEventListener("keydown",g)}),l({activeClip:b}),(w,S)=>(mt(),Ut("div",{class:"w-full h-full bg-[#252525] tracks-list select-none",onDragenter:$e(I,["prevent"]),onDragover:$e(B,["prevent"]),onDragleave:$e(T,["prevent"]),onMousedown:f,onKeydown:g,tabindex:"0"},[(mt(!0),Ut(mi,null,Fn(c.tracks,(L,F)=>(mt(),Ut("div",{key:L.id,class:"relative h-15 my-3 bg-[#252525]","data-track":L.id,onDragenter:$e(P=>U(F),["prevent"]),onDragleave:$e(P=>G(F),["prevent"])},[(mt(!0),Ut(mi,null,Fn(L.clips,P=>(mt(),Ut("div",{key:P.id,class:Tn(["absolute top-0 h-full flex items-center bg-[#444] rounded-xl cursor-pointer select-none min-w-[30px]",{"ring-2 ring-[#b534cf]":P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id,"bg-[#631975]":P.type==="video","bg-[#6ab7ff]":P.type==="audio","bg-[#722ed133]":P.type==="image","bg-[#a85201]":P.type==="text","bg-[#eb2f9633]":P.type==="sticker"}]),style:Wi({left:`${P.startTime*c.frameLength}px`,width:`${P.duration*c.frameLength}px`}),"data-clip":P.id,onMousedown:$e(M=>t(M,P,L.id),["stop"]),onMouseover:M=>e(P),onMouseleave:M=>n(P)},[et(sS,{clip:P,zoom:c.zoom,frameLength:c.frameLength,hovered:P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id},null,8,["clip","zoom","frameLength","hovered"]),P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id?(mt(),Ut("div",{key:0,class:"absolute left-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-l-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:$e(M=>a(M,P,"left"),["stop"])},S[0]||(S[0]=[N("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,lS)):ue("",!0),P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id?(mt(),Ut("div",{key:1,class:"absolute right-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-r-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:$e(M=>a(M,P,"right"),["stop"])},S[1]||(S[1]=[N("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,hS)):ue("",!0)],46,oS))),128))],40,aS))),128))],32))}}),fS=ss(uS,[["__scopeId","data-v-0d1785fd"]]);function dS(c){let l=0;for(let u=0;u<c.length;u++)l+=c[u]*c[u];return Math.sqrt(l/c.length)}const Eh=async c=>new Promise(async l=>{if(c.type==="image"){const h=await Hs(c.path),u=new vo(await h.stream());if(await u.ready){const{video:_}=await u.tick(0);if(_ instanceof ImageBitmap){const y=new OffscreenCanvas(_.width,_.height);y.getContext("2d").drawImage(_,0,0,_.width,_.height);const b=await y.convertToBlob();l({type:"image",data:b})}}}else if(c.type==="video"){const h=await Hs(c.path),u=new kh(h);if(await u.ready){let _=performance.now();u.thumbnails().then(y=>{let s=[];y.forEach(b=>{s.push({url:URL.createObjectURL(b.img),timestamp:b.ts})}),console.log("get video frame",(performance.now()-_)/1e3+"s"),l({type:"video",data:s})})}}}),Ch=async c=>new Promise(async(l,h)=>{var b;const u=await Hs(c.path),p=new Ph(await u.stream());await p.ready,performance.now();let _=!1,y=0,s=[];for(;!_;){const{audio:I,state:B}=await p.tick(y);if(B==="done"){_=!0;continue}if(y+=33333,I.length===0||((b=I[0])==null?void 0:b.length)===0){s.push(0);continue}else{const T=dS(I[0]);s.push(T)}}l({type:"audio",data:s})});var Io={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */Io.exports;(function(c,l){(function(){var h,u="4.17.21",p=200,_="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",y="Expected a function",s="Invalid `variable` option passed into `_.template`",b="__lodash_hash_undefined__",I=500,B="__lodash_placeholder__",T=1,U=2,G=4,t=1,e=2,n=1,a=2,f=4,g=8,v=16,w=32,S=64,L=128,F=256,P=512,M=30,D="...",it=800,at=16,Ft=1,V=2,Ct=3,At=1/0,Gt=9007199254740991,nt=17976931348623157e292,Y=NaN,K=4294967295,ot=K-1,X=K>>>1,Yt=[["ary",L],["bind",n],["bindKey",a],["curry",g],["curryRight",v],["flip",P],["partial",w],["partialRight",S],["rearg",F]],le="[object Arguments]",qe="[object Array]",Ne="[object AsyncFunction]",ut="[object Boolean]",J="[object Date]",lt="[object DOMException]",ct="[object Error]",ie="[object Function]",Xt="[object GeneratorFunction]",Wt="[object Map]",Rt="[object Number]",vi="[object Null]",pe="[object Object]",Li="[object Promise]",Fo="[object Proxy]",ri="[object RegExp]",ke="[object Set]",$i="[object String]",ur="[object Symbol]",Lo="[object Undefined]",qt="[object WeakMap]",ko="[object WeakSet]",Ln="[object ArrayBuffer]",si="[object DataView]",fr="[object Float32Array]",kn="[object Float64Array]",as="[object Int8Array]",os="[object Int16Array]",ls="[object Int32Array]",ki="[object Uint8Array]",hs="[object Uint8ClampedArray]",cn="[object Uint16Array]",us="[object Uint32Array]",Po=/\b__p \+= '';/g,Do=/\b(__p \+=) '' \+/g,Ro=/(__e\(.*?\)|\b__t\)) \+\n'';/g,qs=/&(?:amp|lt|gt|quot|#39);/g,$=/[&<>"']/g,rt=RegExp(qs.source),yt=RegExp($.source),vt=/<%-([\s\S]+?)%>/g,_t=/<%([\s\S]+?)%>/g,wt=/<%=([\s\S]+?)%>/g,Tt=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Kt=/^\w*$/,_e=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ge=/[\\^$.*+?()[\]{}|]/g,re=RegExp(ge.source),se=/^\s+/,Ie=/\s/,Pi=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,js=/\{\n\/\* \[wrapped with (.+)\] \*/,Hh=/,? & /,kc=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Pc=/[()=,{}\[\]\/\s]/,Dc=/\\(\\)?/g,Rc=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Yh=/\w*$/,Mc=/^[-+]0x[0-9a-f]+$/i,Oc=/^0b[01]+$/i,Nc=/^\[object .+?Constructor\]$/,Gc=/^0o[0-7]+$/i,Hc=/^(?:0|[1-9]\d*)$/,Yc=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Ks=/($^)/,Vc=/['\n\r\u2028\u2029\\]/g,Zs="\\ud800-\\udfff",Wc="\\u0300-\\u036f",$c="\\ufe20-\\ufe2f",Xc="\\u20d0-\\u20ff",Vh=Wc+$c+Xc,Wh="\\u2700-\\u27bf",$h="a-z\\xdf-\\xf6\\xf8-\\xff",qc="\\xac\\xb1\\xd7\\xf7",jc="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",Kc="\\u2000-\\u206f",Zc=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Xh="A-Z\\xc0-\\xd6\\xd8-\\xde",qh="\\ufe0e\\ufe0f",jh=qc+jc+Kc+Zc,Mo="['’]",Jc="["+Zs+"]",Kh="["+jh+"]",Js="["+Vh+"]",Zh="\\d+",Qc="["+Wh+"]",Jh="["+$h+"]",Qh="[^"+Zs+jh+Zh+Wh+$h+Xh+"]",Oo="\\ud83c[\\udffb-\\udfff]",tp="(?:"+Js+"|"+Oo+")",tu="[^"+Zs+"]",No="(?:\\ud83c[\\udde6-\\uddff]){2}",Go="[\\ud800-\\udbff][\\udc00-\\udfff]",dr="["+Xh+"]",eu="\\u200d",iu="(?:"+Jh+"|"+Qh+")",ep="(?:"+dr+"|"+Qh+")",nu="(?:"+Mo+"(?:d|ll|m|re|s|t|ve))?",ru="(?:"+Mo+"(?:D|LL|M|RE|S|T|VE))?",su=tp+"?",au="["+qh+"]?",ip="(?:"+eu+"(?:"+[tu,No,Go].join("|")+")"+au+su+")*",np="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",rp="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",ou=au+su+ip,sp="(?:"+[Qc,No,Go].join("|")+")"+ou,ap="(?:"+[tu+Js+"?",Js,No,Go,Jc].join("|")+")",op=RegExp(Mo,"g"),lp=RegExp(Js,"g"),Ho=RegExp(Oo+"(?="+Oo+")|"+ap+ou,"g"),hp=RegExp([dr+"?"+Jh+"+"+nu+"(?="+[Kh,dr,"$"].join("|")+")",ep+"+"+ru+"(?="+[Kh,dr+iu,"$"].join("|")+")",dr+"?"+iu+"+"+nu,dr+"+"+ru,rp,np,Zh,sp].join("|"),"g"),up=RegExp("["+eu+Zs+Vh+qh+"]"),fp=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,dp=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],cp=-1,te={};te[fr]=te[kn]=te[as]=te[os]=te[ls]=te[ki]=te[hs]=te[cn]=te[us]=!0,te[le]=te[qe]=te[Ln]=te[ut]=te[si]=te[J]=te[ct]=te[ie]=te[Wt]=te[Rt]=te[pe]=te[ri]=te[ke]=te[$i]=te[qt]=!1;var Qt={};Qt[le]=Qt[qe]=Qt[Ln]=Qt[si]=Qt[ut]=Qt[J]=Qt[fr]=Qt[kn]=Qt[as]=Qt[os]=Qt[ls]=Qt[Wt]=Qt[Rt]=Qt[pe]=Qt[ri]=Qt[ke]=Qt[$i]=Qt[ur]=Qt[ki]=Qt[hs]=Qt[cn]=Qt[us]=!0,Qt[ct]=Qt[ie]=Qt[qt]=!1;var pp={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},_p={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},gp={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},mp={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},vp=parseFloat,yp=parseInt,lu=typeof Cs=="object"&&Cs&&Cs.Object===Object&&Cs,wp=typeof self=="object"&&self&&self.Object===Object&&self,Ee=lu||wp||Function("return this")(),Yo=l&&!l.nodeType&&l,Pn=Yo&&!0&&c&&!c.nodeType&&c,hu=Pn&&Pn.exports===Yo,Vo=hu&&lu.process,ai=function(){try{var R=Pn&&Pn.require&&Pn.require("util").types;return R||Vo&&Vo.binding&&Vo.binding("util")}catch{}}(),uu=ai&&ai.isArrayBuffer,fu=ai&&ai.isDate,du=ai&&ai.isMap,cu=ai&&ai.isRegExp,pu=ai&&ai.isSet,_u=ai&&ai.isTypedArray;function je(R,W,H){switch(H.length){case 0:return R.call(W);case 1:return R.call(W,H[0]);case 2:return R.call(W,H[0],H[1]);case 3:return R.call(W,H[0],H[1],H[2])}return R.apply(W,H)}function xp(R,W,H,dt){for(var It=-1,Vt=R==null?0:R.length;++It<Vt;){var me=R[It];W(dt,me,H(me),R)}return dt}function oi(R,W){for(var H=-1,dt=R==null?0:R.length;++H<dt&&W(R[H],H,R)!==!1;);return R}function bp(R,W){for(var H=R==null?0:R.length;H--&&W(R[H],H,R)!==!1;);return R}function gu(R,W){for(var H=-1,dt=R==null?0:R.length;++H<dt;)if(!W(R[H],H,R))return!1;return!0}function pn(R,W){for(var H=-1,dt=R==null?0:R.length,It=0,Vt=[];++H<dt;){var me=R[H];W(me,H,R)&&(Vt[It++]=me)}return Vt}function Qs(R,W){var H=R==null?0:R.length;return!!H&&cr(R,W,0)>-1}function Wo(R,W,H){for(var dt=-1,It=R==null?0:R.length;++dt<It;)if(H(W,R[dt]))return!0;return!1}function ne(R,W){for(var H=-1,dt=R==null?0:R.length,It=Array(dt);++H<dt;)It[H]=W(R[H],H,R);return It}function _n(R,W){for(var H=-1,dt=W.length,It=R.length;++H<dt;)R[It+H]=W[H];return R}function $o(R,W,H,dt){var It=-1,Vt=R==null?0:R.length;for(dt&&Vt&&(H=R[++It]);++It<Vt;)H=W(H,R[It],It,R);return H}function Sp(R,W,H,dt){var It=R==null?0:R.length;for(dt&&It&&(H=R[--It]);It--;)H=W(H,R[It],It,R);return H}function Xo(R,W){for(var H=-1,dt=R==null?0:R.length;++H<dt;)if(W(R[H],H,R))return!0;return!1}var Up=qo("length");function Ep(R){return R.split("")}function Cp(R){return R.match(kc)||[]}function mu(R,W,H){var dt;return H(R,function(It,Vt,me){if(W(It,Vt,me))return dt=Vt,!1}),dt}function ta(R,W,H,dt){for(var It=R.length,Vt=H+(dt?1:-1);dt?Vt--:++Vt<It;)if(W(R[Vt],Vt,R))return Vt;return-1}function cr(R,W,H){return W===W?Mp(R,W,H):ta(R,vu,H)}function Ap(R,W,H,dt){for(var It=H-1,Vt=R.length;++It<Vt;)if(dt(R[It],W))return It;return-1}function vu(R){return R!==R}function yu(R,W){var H=R==null?0:R.length;return H?Ko(R,W)/H:Y}function qo(R){return function(W){return W==null?h:W[R]}}function jo(R){return function(W){return R==null?h:R[W]}}function wu(R,W,H,dt,It){return It(R,function(Vt,me,Zt){H=dt?(dt=!1,Vt):W(H,Vt,me,Zt)}),H}function Tp(R,W){var H=R.length;for(R.sort(W);H--;)R[H]=R[H].value;return R}function Ko(R,W){for(var H,dt=-1,It=R.length;++dt<It;){var Vt=W(R[dt]);Vt!==h&&(H=H===h?Vt:H+Vt)}return H}function Zo(R,W){for(var H=-1,dt=Array(R);++H<R;)dt[H]=W(H);return dt}function Ip(R,W){return ne(W,function(H){return[H,R[H]]})}function xu(R){return R&&R.slice(0,Eu(R)+1).replace(se,"")}function Ke(R){return function(W){return R(W)}}function Jo(R,W){return ne(W,function(H){return R[H]})}function fs(R,W){return R.has(W)}function bu(R,W){for(var H=-1,dt=R.length;++H<dt&&cr(W,R[H],0)>-1;);return H}function Su(R,W){for(var H=R.length;H--&&cr(W,R[H],0)>-1;);return H}function Bp(R,W){for(var H=R.length,dt=0;H--;)R[H]===W&&++dt;return dt}var zp=jo(pp),Fp=jo(_p);function Lp(R){return"\\"+mp[R]}function kp(R,W){return R==null?h:R[W]}function pr(R){return up.test(R)}function Pp(R){return fp.test(R)}function Dp(R){for(var W,H=[];!(W=R.next()).done;)H.push(W.value);return H}function Qo(R){var W=-1,H=Array(R.size);return R.forEach(function(dt,It){H[++W]=[It,dt]}),H}function Uu(R,W){return function(H){return R(W(H))}}function gn(R,W){for(var H=-1,dt=R.length,It=0,Vt=[];++H<dt;){var me=R[H];(me===W||me===B)&&(R[H]=B,Vt[It++]=H)}return Vt}function ea(R){var W=-1,H=Array(R.size);return R.forEach(function(dt){H[++W]=dt}),H}function Rp(R){var W=-1,H=Array(R.size);return R.forEach(function(dt){H[++W]=[dt,dt]}),H}function Mp(R,W,H){for(var dt=H-1,It=R.length;++dt<It;)if(R[dt]===W)return dt;return-1}function Op(R,W,H){for(var dt=H+1;dt--;)if(R[dt]===W)return dt;return dt}function _r(R){return pr(R)?Gp(R):Up(R)}function yi(R){return pr(R)?Hp(R):Ep(R)}function Eu(R){for(var W=R.length;W--&&Ie.test(R.charAt(W)););return W}var Np=jo(gp);function Gp(R){for(var W=Ho.lastIndex=0;Ho.test(R);)++W;return W}function Hp(R){return R.match(Ho)||[]}function Yp(R){return R.match(hp)||[]}var Vp=function R(W){W=W==null?Ee:gr.defaults(Ee.Object(),W,gr.pick(Ee,dp));var H=W.Array,dt=W.Date,It=W.Error,Vt=W.Function,me=W.Math,Zt=W.Object,tl=W.RegExp,Wp=W.String,li=W.TypeError,ia=H.prototype,$p=Vt.prototype,mr=Zt.prototype,na=W["__core-js_shared__"],ra=$p.toString,jt=mr.hasOwnProperty,Xp=0,Cu=function(){var r=/[^.]+$/.exec(na&&na.keys&&na.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}(),sa=mr.toString,qp=ra.call(Zt),jp=Ee._,Kp=tl("^"+ra.call(jt).replace(ge,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),aa=hu?W.Buffer:h,mn=W.Symbol,oa=W.Uint8Array,Au=aa?aa.allocUnsafe:h,la=Uu(Zt.getPrototypeOf,Zt),Tu=Zt.create,Iu=mr.propertyIsEnumerable,ha=ia.splice,Bu=mn?mn.isConcatSpreadable:h,ds=mn?mn.iterator:h,Dn=mn?mn.toStringTag:h,ua=function(){try{var r=Gn(Zt,"defineProperty");return r({},"",{}),r}catch{}}(),Zp=W.clearTimeout!==Ee.clearTimeout&&W.clearTimeout,Jp=dt&&dt.now!==Ee.Date.now&&dt.now,Qp=W.setTimeout!==Ee.setTimeout&&W.setTimeout,fa=me.ceil,da=me.floor,el=Zt.getOwnPropertySymbols,t_=aa?aa.isBuffer:h,zu=W.isFinite,e_=ia.join,i_=Uu(Zt.keys,Zt),ve=me.max,Be=me.min,n_=dt.now,r_=W.parseInt,Fu=me.random,s_=ia.reverse,il=Gn(W,"DataView"),cs=Gn(W,"Map"),nl=Gn(W,"Promise"),vr=Gn(W,"Set"),ps=Gn(W,"WeakMap"),_s=Gn(Zt,"create"),ca=ps&&new ps,yr={},a_=Hn(il),o_=Hn(cs),l_=Hn(nl),h_=Hn(vr),u_=Hn(ps),pa=mn?mn.prototype:h,gs=pa?pa.valueOf:h,Lu=pa?pa.toString:h;function E(r){if(he(r)&&!Bt(r)&&!(r instanceof Ot)){if(r instanceof hi)return r;if(jt.call(r,"__wrapped__"))return Pf(r)}return new hi(r)}var wr=function(){function r(){}return function(o){if(!ae(o))return{};if(Tu)return Tu(o);r.prototype=o;var d=new r;return r.prototype=h,d}}();function _a(){}function hi(r,o){this.__wrapped__=r,this.__actions__=[],this.__chain__=!!o,this.__index__=0,this.__values__=h}E.templateSettings={escape:vt,evaluate:_t,interpolate:wt,variable:"",imports:{_:E}},E.prototype=_a.prototype,E.prototype.constructor=E,hi.prototype=wr(_a.prototype),hi.prototype.constructor=hi;function Ot(r){this.__wrapped__=r,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=K,this.__views__=[]}function f_(){var r=new Ot(this.__wrapped__);return r.__actions__=Ge(this.__actions__),r.__dir__=this.__dir__,r.__filtered__=this.__filtered__,r.__iteratees__=Ge(this.__iteratees__),r.__takeCount__=this.__takeCount__,r.__views__=Ge(this.__views__),r}function d_(){if(this.__filtered__){var r=new Ot(this);r.__dir__=-1,r.__filtered__=!0}else r=this.clone(),r.__dir__*=-1;return r}function c_(){var r=this.__wrapped__.value(),o=this.__dir__,d=Bt(r),m=o<0,x=d?r.length:0,C=Eg(0,x,this.__views__),z=C.start,k=C.end,O=k-z,q=m?k:z-1,j=this.__iteratees__,Z=j.length,ht=0,gt=Be(O,this.__takeCount__);if(!d||!m&&x==O&&gt==O)return rf(r,this.__actions__);var bt=[];t:for(;O--&&ht<gt;){q+=o;for(var kt=-1,St=r[q];++kt<Z;){var Mt=j[kt],Nt=Mt.iteratee,Qe=Mt.type,Re=Nt(St);if(Qe==V)St=Re;else if(!Re){if(Qe==Ft)continue t;break t}}bt[ht++]=St}return bt}Ot.prototype=wr(_a.prototype),Ot.prototype.constructor=Ot;function Rn(r){var o=-1,d=r==null?0:r.length;for(this.clear();++o<d;){var m=r[o];this.set(m[0],m[1])}}function p_(){this.__data__=_s?_s(null):{},this.size=0}function __(r){var o=this.has(r)&&delete this.__data__[r];return this.size-=o?1:0,o}function g_(r){var o=this.__data__;if(_s){var d=o[r];return d===b?h:d}return jt.call(o,r)?o[r]:h}function m_(r){var o=this.__data__;return _s?o[r]!==h:jt.call(o,r)}function v_(r,o){var d=this.__data__;return this.size+=this.has(r)?0:1,d[r]=_s&&o===h?b:o,this}Rn.prototype.clear=p_,Rn.prototype.delete=__,Rn.prototype.get=g_,Rn.prototype.has=m_,Rn.prototype.set=v_;function Xi(r){var o=-1,d=r==null?0:r.length;for(this.clear();++o<d;){var m=r[o];this.set(m[0],m[1])}}function y_(){this.__data__=[],this.size=0}function w_(r){var o=this.__data__,d=ga(o,r);if(d<0)return!1;var m=o.length-1;return d==m?o.pop():ha.call(o,d,1),--this.size,!0}function x_(r){var o=this.__data__,d=ga(o,r);return d<0?h:o[d][1]}function b_(r){return ga(this.__data__,r)>-1}function S_(r,o){var d=this.__data__,m=ga(d,r);return m<0?(++this.size,d.push([r,o])):d[m][1]=o,this}Xi.prototype.clear=y_,Xi.prototype.delete=w_,Xi.prototype.get=x_,Xi.prototype.has=b_,Xi.prototype.set=S_;function qi(r){var o=-1,d=r==null?0:r.length;for(this.clear();++o<d;){var m=r[o];this.set(m[0],m[1])}}function U_(){this.size=0,this.__data__={hash:new Rn,map:new(cs||Xi),string:new Rn}}function E_(r){var o=Ta(this,r).delete(r);return this.size-=o?1:0,o}function C_(r){return Ta(this,r).get(r)}function A_(r){return Ta(this,r).has(r)}function T_(r,o){var d=Ta(this,r),m=d.size;return d.set(r,o),this.size+=d.size==m?0:1,this}qi.prototype.clear=U_,qi.prototype.delete=E_,qi.prototype.get=C_,qi.prototype.has=A_,qi.prototype.set=T_;function Mn(r){var o=-1,d=r==null?0:r.length;for(this.__data__=new qi;++o<d;)this.add(r[o])}function I_(r){return this.__data__.set(r,b),this}function B_(r){return this.__data__.has(r)}Mn.prototype.add=Mn.prototype.push=I_,Mn.prototype.has=B_;function wi(r){var o=this.__data__=new Xi(r);this.size=o.size}function z_(){this.__data__=new Xi,this.size=0}function F_(r){var o=this.__data__,d=o.delete(r);return this.size=o.size,d}function L_(r){return this.__data__.get(r)}function k_(r){return this.__data__.has(r)}function P_(r,o){var d=this.__data__;if(d instanceof Xi){var m=d.__data__;if(!cs||m.length<p-1)return m.push([r,o]),this.size=++d.size,this;d=this.__data__=new qi(m)}return d.set(r,o),this.size=d.size,this}wi.prototype.clear=z_,wi.prototype.delete=F_,wi.prototype.get=L_,wi.prototype.has=k_,wi.prototype.set=P_;function ku(r,o){var d=Bt(r),m=!d&&Yn(r),x=!d&&!m&&bn(r),C=!d&&!m&&!x&&Ur(r),z=d||m||x||C,k=z?Zo(r.length,Wp):[],O=k.length;for(var q in r)(o||jt.call(r,q))&&!(z&&(q=="length"||x&&(q=="offset"||q=="parent")||C&&(q=="buffer"||q=="byteLength"||q=="byteOffset")||Ji(q,O)))&&k.push(q);return k}function Pu(r){var o=r.length;return o?r[pl(0,o-1)]:h}function D_(r,o){return Ia(Ge(r),On(o,0,r.length))}function R_(r){return Ia(Ge(r))}function rl(r,o,d){(d!==h&&!xi(r[o],d)||d===h&&!(o in r))&&ji(r,o,d)}function ms(r,o,d){var m=r[o];(!(jt.call(r,o)&&xi(m,d))||d===h&&!(o in r))&&ji(r,o,d)}function ga(r,o){for(var d=r.length;d--;)if(xi(r[d][0],o))return d;return-1}function M_(r,o,d,m){return vn(r,function(x,C,z){o(m,x,d(x),z)}),m}function Du(r,o){return r&&Ri(o,be(o),r)}function O_(r,o){return r&&Ri(o,Ye(o),r)}function ji(r,o,d){o=="__proto__"&&ua?ua(r,o,{configurable:!0,enumerable:!0,value:d,writable:!0}):r[o]=d}function sl(r,o){for(var d=-1,m=o.length,x=H(m),C=r==null;++d<m;)x[d]=C?h:Ol(r,o[d]);return x}function On(r,o,d){return r===r&&(d!==h&&(r=r<=d?r:d),o!==h&&(r=r>=o?r:o)),r}function ui(r,o,d,m,x,C){var z,k=o&T,O=o&U,q=o&G;if(d&&(z=x?d(r,m,x,C):d(r)),z!==h)return z;if(!ae(r))return r;var j=Bt(r);if(j){if(z=Ag(r),!k)return Ge(r,z)}else{var Z=ze(r),ht=Z==ie||Z==Xt;if(bn(r))return of(r,k);if(Z==pe||Z==le||ht&&!x){if(z=O||ht?{}:Cf(r),!k)return O?gg(r,O_(z,r)):_g(r,Du(z,r))}else{if(!Qt[Z])return x?r:{};z=Tg(r,Z,k)}}C||(C=new wi);var gt=C.get(r);if(gt)return gt;C.set(r,z),ed(r)?r.forEach(function(St){z.add(ui(St,o,d,St,r,C))}):Qf(r)&&r.forEach(function(St,Mt){z.set(Mt,ui(St,o,d,Mt,r,C))});var bt=q?O?El:Ul:O?Ye:be,kt=j?h:bt(r);return oi(kt||r,function(St,Mt){kt&&(Mt=St,St=r[Mt]),ms(z,Mt,ui(St,o,d,Mt,r,C))}),z}function N_(r){var o=be(r);return function(d){return Ru(d,r,o)}}function Ru(r,o,d){var m=d.length;if(r==null)return!m;for(r=Zt(r);m--;){var x=d[m],C=o[x],z=r[x];if(z===h&&!(x in r)||!C(z))return!1}return!0}function Mu(r,o,d){if(typeof r!="function")throw new li(y);return Us(function(){r.apply(h,d)},o)}function vs(r,o,d,m){var x=-1,C=Qs,z=!0,k=r.length,O=[],q=o.length;if(!k)return O;d&&(o=ne(o,Ke(d))),m?(C=Wo,z=!1):o.length>=p&&(C=fs,z=!1,o=new Mn(o));t:for(;++x<k;){var j=r[x],Z=d==null?j:d(j);if(j=m||j!==0?j:0,z&&Z===Z){for(var ht=q;ht--;)if(o[ht]===Z)continue t;O.push(j)}else C(o,Z,m)||O.push(j)}return O}var vn=df(Di),Ou=df(ol,!0);function G_(r,o){var d=!0;return vn(r,function(m,x,C){return d=!!o(m,x,C),d}),d}function ma(r,o,d){for(var m=-1,x=r.length;++m<x;){var C=r[m],z=o(C);if(z!=null&&(k===h?z===z&&!Je(z):d(z,k)))var k=z,O=C}return O}function H_(r,o,d,m){var x=r.length;for(d=Lt(d),d<0&&(d=-d>x?0:x+d),m=m===h||m>x?x:Lt(m),m<0&&(m+=x),m=d>m?0:nd(m);d<m;)r[d++]=o;return r}function Nu(r,o){var d=[];return vn(r,function(m,x,C){o(m,x,C)&&d.push(m)}),d}function Ce(r,o,d,m,x){var C=-1,z=r.length;for(d||(d=Bg),x||(x=[]);++C<z;){var k=r[C];o>0&&d(k)?o>1?Ce(k,o-1,d,m,x):_n(x,k):m||(x[x.length]=k)}return x}var al=cf(),Gu=cf(!0);function Di(r,o){return r&&al(r,o,be)}function ol(r,o){return r&&Gu(r,o,be)}function va(r,o){return pn(o,function(d){return Qi(r[d])})}function Nn(r,o){o=wn(o,r);for(var d=0,m=o.length;r!=null&&d<m;)r=r[Mi(o[d++])];return d&&d==m?r:h}function Hu(r,o,d){var m=o(r);return Bt(r)?m:_n(m,d(r))}function Pe(r){return r==null?r===h?Lo:vi:Dn&&Dn in Zt(r)?Ug(r):Rg(r)}function ll(r,o){return r>o}function Y_(r,o){return r!=null&&jt.call(r,o)}function V_(r,o){return r!=null&&o in Zt(r)}function W_(r,o,d){return r>=Be(o,d)&&r<ve(o,d)}function hl(r,o,d){for(var m=d?Wo:Qs,x=r[0].length,C=r.length,z=C,k=H(C),O=1/0,q=[];z--;){var j=r[z];z&&o&&(j=ne(j,Ke(o))),O=Be(j.length,O),k[z]=!d&&(o||x>=120&&j.length>=120)?new Mn(z&&j):h}j=r[0];var Z=-1,ht=k[0];t:for(;++Z<x&&q.length<O;){var gt=j[Z],bt=o?o(gt):gt;if(gt=d||gt!==0?gt:0,!(ht?fs(ht,bt):m(q,bt,d))){for(z=C;--z;){var kt=k[z];if(!(kt?fs(kt,bt):m(r[z],bt,d)))continue t}ht&&ht.push(bt),q.push(gt)}}return q}function $_(r,o,d,m){return Di(r,function(x,C,z){o(m,d(x),C,z)}),m}function ys(r,o,d){o=wn(o,r),r=Bf(r,o);var m=r==null?r:r[Mi(di(o))];return m==null?h:je(m,r,d)}function Yu(r){return he(r)&&Pe(r)==le}function X_(r){return he(r)&&Pe(r)==Ln}function q_(r){return he(r)&&Pe(r)==J}function ws(r,o,d,m,x){return r===o?!0:r==null||o==null||!he(r)&&!he(o)?r!==r&&o!==o:j_(r,o,d,m,ws,x)}function j_(r,o,d,m,x,C){var z=Bt(r),k=Bt(o),O=z?qe:ze(r),q=k?qe:ze(o);O=O==le?pe:O,q=q==le?pe:q;var j=O==pe,Z=q==pe,ht=O==q;if(ht&&bn(r)){if(!bn(o))return!1;z=!0,j=!1}if(ht&&!j)return C||(C=new wi),z||Ur(r)?Sf(r,o,d,m,x,C):bg(r,o,O,d,m,x,C);if(!(d&t)){var gt=j&&jt.call(r,"__wrapped__"),bt=Z&&jt.call(o,"__wrapped__");if(gt||bt){var kt=gt?r.value():r,St=bt?o.value():o;return C||(C=new wi),x(kt,St,d,m,C)}}return ht?(C||(C=new wi),Sg(r,o,d,m,x,C)):!1}function K_(r){return he(r)&&ze(r)==Wt}function ul(r,o,d,m){var x=d.length,C=x,z=!m;if(r==null)return!C;for(r=Zt(r);x--;){var k=d[x];if(z&&k[2]?k[1]!==r[k[0]]:!(k[0]in r))return!1}for(;++x<C;){k=d[x];var O=k[0],q=r[O],j=k[1];if(z&&k[2]){if(q===h&&!(O in r))return!1}else{var Z=new wi;if(m)var ht=m(q,j,O,r,o,Z);if(!(ht===h?ws(j,q,t|e,m,Z):ht))return!1}}return!0}function Vu(r){if(!ae(r)||Fg(r))return!1;var o=Qi(r)?Kp:Nc;return o.test(Hn(r))}function Z_(r){return he(r)&&Pe(r)==ri}function J_(r){return he(r)&&ze(r)==ke}function Q_(r){return he(r)&&Pa(r.length)&&!!te[Pe(r)]}function Wu(r){return typeof r=="function"?r:r==null?Ve:typeof r=="object"?Bt(r)?qu(r[0],r[1]):Xu(r):pd(r)}function fl(r){if(!Ss(r))return i_(r);var o=[];for(var d in Zt(r))jt.call(r,d)&&d!="constructor"&&o.push(d);return o}function tg(r){if(!ae(r))return Dg(r);var o=Ss(r),d=[];for(var m in r)m=="constructor"&&(o||!jt.call(r,m))||d.push(m);return d}function dl(r,o){return r<o}function $u(r,o){var d=-1,m=He(r)?H(r.length):[];return vn(r,function(x,C,z){m[++d]=o(x,C,z)}),m}function Xu(r){var o=Al(r);return o.length==1&&o[0][2]?Tf(o[0][0],o[0][1]):function(d){return d===r||ul(d,r,o)}}function qu(r,o){return Il(r)&&Af(o)?Tf(Mi(r),o):function(d){var m=Ol(d,r);return m===h&&m===o?Nl(d,r):ws(o,m,t|e)}}function ya(r,o,d,m,x){r!==o&&al(o,function(C,z){if(x||(x=new wi),ae(C))eg(r,o,z,d,ya,m,x);else{var k=m?m(zl(r,z),C,z+"",r,o,x):h;k===h&&(k=C),rl(r,z,k)}},Ye)}function eg(r,o,d,m,x,C,z){var k=zl(r,d),O=zl(o,d),q=z.get(O);if(q){rl(r,d,q);return}var j=C?C(k,O,d+"",r,o,z):h,Z=j===h;if(Z){var ht=Bt(O),gt=!ht&&bn(O),bt=!ht&&!gt&&Ur(O);j=O,ht||gt||bt?Bt(k)?j=k:de(k)?j=Ge(k):gt?(Z=!1,j=of(O,!0)):bt?(Z=!1,j=lf(O,!0)):j=[]:Es(O)||Yn(O)?(j=k,Yn(k)?j=rd(k):(!ae(k)||Qi(k))&&(j=Cf(O))):Z=!1}Z&&(z.set(O,j),x(j,O,m,C,z),z.delete(O)),rl(r,d,j)}function ju(r,o){var d=r.length;if(d)return o+=o<0?d:0,Ji(o,d)?r[o]:h}function Ku(r,o,d){o.length?o=ne(o,function(C){return Bt(C)?function(z){return Nn(z,C.length===1?C[0]:C)}:C}):o=[Ve];var m=-1;o=ne(o,Ke(xt()));var x=$u(r,function(C,z,k){var O=ne(o,function(q){return q(C)});return{criteria:O,index:++m,value:C}});return Tp(x,function(C,z){return pg(C,z,d)})}function ig(r,o){return Zu(r,o,function(d,m){return Nl(r,m)})}function Zu(r,o,d){for(var m=-1,x=o.length,C={};++m<x;){var z=o[m],k=Nn(r,z);d(k,z)&&xs(C,wn(z,r),k)}return C}function ng(r){return function(o){return Nn(o,r)}}function cl(r,o,d,m){var x=m?Ap:cr,C=-1,z=o.length,k=r;for(r===o&&(o=Ge(o)),d&&(k=ne(r,Ke(d)));++C<z;)for(var O=0,q=o[C],j=d?d(q):q;(O=x(k,j,O,m))>-1;)k!==r&&ha.call(k,O,1),ha.call(r,O,1);return r}function Ju(r,o){for(var d=r?o.length:0,m=d-1;d--;){var x=o[d];if(d==m||x!==C){var C=x;Ji(x)?ha.call(r,x,1):ml(r,x)}}return r}function pl(r,o){return r+da(Fu()*(o-r+1))}function rg(r,o,d,m){for(var x=-1,C=ve(fa((o-r)/(d||1)),0),z=H(C);C--;)z[m?C:++x]=r,r+=d;return z}function _l(r,o){var d="";if(!r||o<1||o>Gt)return d;do o%2&&(d+=r),o=da(o/2),o&&(r+=r);while(o);return d}function Dt(r,o){return Fl(If(r,o,Ve),r+"")}function sg(r){return Pu(Er(r))}function ag(r,o){var d=Er(r);return Ia(d,On(o,0,d.length))}function xs(r,o,d,m){if(!ae(r))return r;o=wn(o,r);for(var x=-1,C=o.length,z=C-1,k=r;k!=null&&++x<C;){var O=Mi(o[x]),q=d;if(O==="__proto__"||O==="constructor"||O==="prototype")return r;if(x!=z){var j=k[O];q=m?m(j,O,k):h,q===h&&(q=ae(j)?j:Ji(o[x+1])?[]:{})}ms(k,O,q),k=k[O]}return r}var Qu=ca?function(r,o){return ca.set(r,o),r}:Ve,og=ua?function(r,o){return ua(r,"toString",{configurable:!0,enumerable:!1,value:Hl(o),writable:!0})}:Ve;function lg(r){return Ia(Er(r))}function fi(r,o,d){var m=-1,x=r.length;o<0&&(o=-o>x?0:x+o),d=d>x?x:d,d<0&&(d+=x),x=o>d?0:d-o>>>0,o>>>=0;for(var C=H(x);++m<x;)C[m]=r[m+o];return C}function hg(r,o){var d;return vn(r,function(m,x,C){return d=o(m,x,C),!d}),!!d}function wa(r,o,d){var m=0,x=r==null?m:r.length;if(typeof o=="number"&&o===o&&x<=X){for(;m<x;){var C=m+x>>>1,z=r[C];z!==null&&!Je(z)&&(d?z<=o:z<o)?m=C+1:x=C}return x}return gl(r,o,Ve,d)}function gl(r,o,d,m){var x=0,C=r==null?0:r.length;if(C===0)return 0;o=d(o);for(var z=o!==o,k=o===null,O=Je(o),q=o===h;x<C;){var j=da((x+C)/2),Z=d(r[j]),ht=Z!==h,gt=Z===null,bt=Z===Z,kt=Je(Z);if(z)var St=m||bt;else q?St=bt&&(m||ht):k?St=bt&&ht&&(m||!gt):O?St=bt&&ht&&!gt&&(m||!kt):gt||kt?St=!1:St=m?Z<=o:Z<o;St?x=j+1:C=j}return Be(C,ot)}function tf(r,o){for(var d=-1,m=r.length,x=0,C=[];++d<m;){var z=r[d],k=o?o(z):z;if(!d||!xi(k,O)){var O=k;C[x++]=z===0?0:z}}return C}function ef(r){return typeof r=="number"?r:Je(r)?Y:+r}function Ze(r){if(typeof r=="string")return r;if(Bt(r))return ne(r,Ze)+"";if(Je(r))return Lu?Lu.call(r):"";var o=r+"";return o=="0"&&1/r==-1/0?"-0":o}function yn(r,o,d){var m=-1,x=Qs,C=r.length,z=!0,k=[],O=k;if(d)z=!1,x=Wo;else if(C>=p){var q=o?null:wg(r);if(q)return ea(q);z=!1,x=fs,O=new Mn}else O=o?[]:k;t:for(;++m<C;){var j=r[m],Z=o?o(j):j;if(j=d||j!==0?j:0,z&&Z===Z){for(var ht=O.length;ht--;)if(O[ht]===Z)continue t;o&&O.push(Z),k.push(j)}else x(O,Z,d)||(O!==k&&O.push(Z),k.push(j))}return k}function ml(r,o){return o=wn(o,r),r=Bf(r,o),r==null||delete r[Mi(di(o))]}function nf(r,o,d,m){return xs(r,o,d(Nn(r,o)),m)}function xa(r,o,d,m){for(var x=r.length,C=m?x:-1;(m?C--:++C<x)&&o(r[C],C,r););return d?fi(r,m?0:C,m?C+1:x):fi(r,m?C+1:0,m?x:C)}function rf(r,o){var d=r;return d instanceof Ot&&(d=d.value()),$o(o,function(m,x){return x.func.apply(x.thisArg,_n([m],x.args))},d)}function vl(r,o,d){var m=r.length;if(m<2)return m?yn(r[0]):[];for(var x=-1,C=H(m);++x<m;)for(var z=r[x],k=-1;++k<m;)k!=x&&(C[x]=vs(C[x]||z,r[k],o,d));return yn(Ce(C,1),o,d)}function sf(r,o,d){for(var m=-1,x=r.length,C=o.length,z={};++m<x;){var k=m<C?o[m]:h;d(z,r[m],k)}return z}function yl(r){return de(r)?r:[]}function wl(r){return typeof r=="function"?r:Ve}function wn(r,o){return Bt(r)?r:Il(r,o)?[r]:kf($t(r))}var ug=Dt;function xn(r,o,d){var m=r.length;return d=d===h?m:d,!o&&d>=m?r:fi(r,o,d)}var af=Zp||function(r){return Ee.clearTimeout(r)};function of(r,o){if(o)return r.slice();var d=r.length,m=Au?Au(d):new r.constructor(d);return r.copy(m),m}function xl(r){var o=new r.constructor(r.byteLength);return new oa(o).set(new oa(r)),o}function fg(r,o){var d=o?xl(r.buffer):r.buffer;return new r.constructor(d,r.byteOffset,r.byteLength)}function dg(r){var o=new r.constructor(r.source,Yh.exec(r));return o.lastIndex=r.lastIndex,o}function cg(r){return gs?Zt(gs.call(r)):{}}function lf(r,o){var d=o?xl(r.buffer):r.buffer;return new r.constructor(d,r.byteOffset,r.length)}function hf(r,o){if(r!==o){var d=r!==h,m=r===null,x=r===r,C=Je(r),z=o!==h,k=o===null,O=o===o,q=Je(o);if(!k&&!q&&!C&&r>o||C&&z&&O&&!k&&!q||m&&z&&O||!d&&O||!x)return 1;if(!m&&!C&&!q&&r<o||q&&d&&x&&!m&&!C||k&&d&&x||!z&&x||!O)return-1}return 0}function pg(r,o,d){for(var m=-1,x=r.criteria,C=o.criteria,z=x.length,k=d.length;++m<z;){var O=hf(x[m],C[m]);if(O){if(m>=k)return O;var q=d[m];return O*(q=="desc"?-1:1)}}return r.index-o.index}function uf(r,o,d,m){for(var x=-1,C=r.length,z=d.length,k=-1,O=o.length,q=ve(C-z,0),j=H(O+q),Z=!m;++k<O;)j[k]=o[k];for(;++x<z;)(Z||x<C)&&(j[d[x]]=r[x]);for(;q--;)j[k++]=r[x++];return j}function ff(r,o,d,m){for(var x=-1,C=r.length,z=-1,k=d.length,O=-1,q=o.length,j=ve(C-k,0),Z=H(j+q),ht=!m;++x<j;)Z[x]=r[x];for(var gt=x;++O<q;)Z[gt+O]=o[O];for(;++z<k;)(ht||x<C)&&(Z[gt+d[z]]=r[x++]);return Z}function Ge(r,o){var d=-1,m=r.length;for(o||(o=H(m));++d<m;)o[d]=r[d];return o}function Ri(r,o,d,m){var x=!d;d||(d={});for(var C=-1,z=o.length;++C<z;){var k=o[C],O=m?m(d[k],r[k],k,d,r):h;O===h&&(O=r[k]),x?ji(d,k,O):ms(d,k,O)}return d}function _g(r,o){return Ri(r,Tl(r),o)}function gg(r,o){return Ri(r,Uf(r),o)}function ba(r,o){return function(d,m){var x=Bt(d)?xp:M_,C=o?o():{};return x(d,r,xt(m,2),C)}}function xr(r){return Dt(function(o,d){var m=-1,x=d.length,C=x>1?d[x-1]:h,z=x>2?d[2]:h;for(C=r.length>3&&typeof C=="function"?(x--,C):h,z&&De(d[0],d[1],z)&&(C=x<3?h:C,x=1),o=Zt(o);++m<x;){var k=d[m];k&&r(o,k,m,C)}return o})}function df(r,o){return function(d,m){if(d==null)return d;if(!He(d))return r(d,m);for(var x=d.length,C=o?x:-1,z=Zt(d);(o?C--:++C<x)&&m(z[C],C,z)!==!1;);return d}}function cf(r){return function(o,d,m){for(var x=-1,C=Zt(o),z=m(o),k=z.length;k--;){var O=z[r?k:++x];if(d(C[O],O,C)===!1)break}return o}}function mg(r,o,d){var m=o&n,x=bs(r);function C(){var z=this&&this!==Ee&&this instanceof C?x:r;return z.apply(m?d:this,arguments)}return C}function pf(r){return function(o){o=$t(o);var d=pr(o)?yi(o):h,m=d?d[0]:o.charAt(0),x=d?xn(d,1).join(""):o.slice(1);return m[r]()+x}}function br(r){return function(o){return $o(dd(fd(o).replace(op,"")),r,"")}}function bs(r){return function(){var o=arguments;switch(o.length){case 0:return new r;case 1:return new r(o[0]);case 2:return new r(o[0],o[1]);case 3:return new r(o[0],o[1],o[2]);case 4:return new r(o[0],o[1],o[2],o[3]);case 5:return new r(o[0],o[1],o[2],o[3],o[4]);case 6:return new r(o[0],o[1],o[2],o[3],o[4],o[5]);case 7:return new r(o[0],o[1],o[2],o[3],o[4],o[5],o[6])}var d=wr(r.prototype),m=r.apply(d,o);return ae(m)?m:d}}function vg(r,o,d){var m=bs(r);function x(){for(var C=arguments.length,z=H(C),k=C,O=Sr(x);k--;)z[k]=arguments[k];var q=C<3&&z[0]!==O&&z[C-1]!==O?[]:gn(z,O);if(C-=q.length,C<d)return yf(r,o,Sa,x.placeholder,h,z,q,h,h,d-C);var j=this&&this!==Ee&&this instanceof x?m:r;return je(j,this,z)}return x}function _f(r){return function(o,d,m){var x=Zt(o);if(!He(o)){var C=xt(d,3);o=be(o),d=function(k){return C(x[k],k,x)}}var z=r(o,d,m);return z>-1?x[C?o[z]:z]:h}}function gf(r){return Zi(function(o){var d=o.length,m=d,x=hi.prototype.thru;for(r&&o.reverse();m--;){var C=o[m];if(typeof C!="function")throw new li(y);if(x&&!z&&Aa(C)=="wrapper")var z=new hi([],!0)}for(m=z?m:d;++m<d;){C=o[m];var k=Aa(C),O=k=="wrapper"?Cl(C):h;O&&Bl(O[0])&&O[1]==(L|g|w|F)&&!O[4].length&&O[9]==1?z=z[Aa(O[0])].apply(z,O[3]):z=C.length==1&&Bl(C)?z[k]():z.thru(C)}return function(){var q=arguments,j=q[0];if(z&&q.length==1&&Bt(j))return z.plant(j).value();for(var Z=0,ht=d?o[Z].apply(this,q):j;++Z<d;)ht=o[Z].call(this,ht);return ht}})}function Sa(r,o,d,m,x,C,z,k,O,q){var j=o&L,Z=o&n,ht=o&a,gt=o&(g|v),bt=o&P,kt=ht?h:bs(r);function St(){for(var Mt=arguments.length,Nt=H(Mt),Qe=Mt;Qe--;)Nt[Qe]=arguments[Qe];if(gt)var Re=Sr(St),ti=Bp(Nt,Re);if(m&&(Nt=uf(Nt,m,x,gt)),C&&(Nt=ff(Nt,C,z,gt)),Mt-=ti,gt&&Mt<q){var ce=gn(Nt,Re);return yf(r,o,Sa,St.placeholder,d,Nt,ce,k,O,q-Mt)}var bi=Z?d:this,en=ht?bi[r]:r;return Mt=Nt.length,k?Nt=Mg(Nt,k):bt&&Mt>1&&Nt.reverse(),j&&O<Mt&&(Nt.length=O),this&&this!==Ee&&this instanceof St&&(en=kt||bs(en)),en.apply(bi,Nt)}return St}function mf(r,o){return function(d,m){return $_(d,r,o(m),{})}}function Ua(r,o){return function(d,m){var x;if(d===h&&m===h)return o;if(d!==h&&(x=d),m!==h){if(x===h)return m;typeof d=="string"||typeof m=="string"?(d=Ze(d),m=Ze(m)):(d=ef(d),m=ef(m)),x=r(d,m)}return x}}function bl(r){return Zi(function(o){return o=ne(o,Ke(xt())),Dt(function(d){var m=this;return r(o,function(x){return je(x,m,d)})})})}function Ea(r,o){o=o===h?" ":Ze(o);var d=o.length;if(d<2)return d?_l(o,r):o;var m=_l(o,fa(r/_r(o)));return pr(o)?xn(yi(m),0,r).join(""):m.slice(0,r)}function yg(r,o,d,m){var x=o&n,C=bs(r);function z(){for(var k=-1,O=arguments.length,q=-1,j=m.length,Z=H(j+O),ht=this&&this!==Ee&&this instanceof z?C:r;++q<j;)Z[q]=m[q];for(;O--;)Z[q++]=arguments[++k];return je(ht,x?d:this,Z)}return z}function vf(r){return function(o,d,m){return m&&typeof m!="number"&&De(o,d,m)&&(d=m=h),o=tn(o),d===h?(d=o,o=0):d=tn(d),m=m===h?o<d?1:-1:tn(m),rg(o,d,m,r)}}function Ca(r){return function(o,d){return typeof o=="string"&&typeof d=="string"||(o=ci(o),d=ci(d)),r(o,d)}}function yf(r,o,d,m,x,C,z,k,O,q){var j=o&g,Z=j?z:h,ht=j?h:z,gt=j?C:h,bt=j?h:C;o|=j?w:S,o&=~(j?S:w),o&f||(o&=-4);var kt=[r,o,x,gt,Z,bt,ht,k,O,q],St=d.apply(h,kt);return Bl(r)&&zf(St,kt),St.placeholder=m,Ff(St,r,o)}function Sl(r){var o=me[r];return function(d,m){if(d=ci(d),m=m==null?0:Be(Lt(m),292),m&&zu(d)){var x=($t(d)+"e").split("e"),C=o(x[0]+"e"+(+x[1]+m));return x=($t(C)+"e").split("e"),+(x[0]+"e"+(+x[1]-m))}return o(d)}}var wg=vr&&1/ea(new vr([,-0]))[1]==At?function(r){return new vr(r)}:Wl;function wf(r){return function(o){var d=ze(o);return d==Wt?Qo(o):d==ke?Rp(o):Ip(o,r(o))}}function Ki(r,o,d,m,x,C,z,k){var O=o&a;if(!O&&typeof r!="function")throw new li(y);var q=m?m.length:0;if(q||(o&=-97,m=x=h),z=z===h?z:ve(Lt(z),0),k=k===h?k:Lt(k),q-=x?x.length:0,o&S){var j=m,Z=x;m=x=h}var ht=O?h:Cl(r),gt=[r,o,d,m,x,j,Z,C,z,k];if(ht&&Pg(gt,ht),r=gt[0],o=gt[1],d=gt[2],m=gt[3],x=gt[4],k=gt[9]=gt[9]===h?O?0:r.length:ve(gt[9]-q,0),!k&&o&(g|v)&&(o&=-25),!o||o==n)var bt=mg(r,o,d);else o==g||o==v?bt=vg(r,o,k):(o==w||o==(n|w))&&!x.length?bt=yg(r,o,d,m):bt=Sa.apply(h,gt);var kt=ht?Qu:zf;return Ff(kt(bt,gt),r,o)}function xf(r,o,d,m){return r===h||xi(r,mr[d])&&!jt.call(m,d)?o:r}function bf(r,o,d,m,x,C){return ae(r)&&ae(o)&&(C.set(o,r),ya(r,o,h,bf,C),C.delete(o)),r}function xg(r){return Es(r)?h:r}function Sf(r,o,d,m,x,C){var z=d&t,k=r.length,O=o.length;if(k!=O&&!(z&&O>k))return!1;var q=C.get(r),j=C.get(o);if(q&&j)return q==o&&j==r;var Z=-1,ht=!0,gt=d&e?new Mn:h;for(C.set(r,o),C.set(o,r);++Z<k;){var bt=r[Z],kt=o[Z];if(m)var St=z?m(kt,bt,Z,o,r,C):m(bt,kt,Z,r,o,C);if(St!==h){if(St)continue;ht=!1;break}if(gt){if(!Xo(o,function(Mt,Nt){if(!fs(gt,Nt)&&(bt===Mt||x(bt,Mt,d,m,C)))return gt.push(Nt)})){ht=!1;break}}else if(!(bt===kt||x(bt,kt,d,m,C))){ht=!1;break}}return C.delete(r),C.delete(o),ht}function bg(r,o,d,m,x,C,z){switch(d){case si:if(r.byteLength!=o.byteLength||r.byteOffset!=o.byteOffset)return!1;r=r.buffer,o=o.buffer;case Ln:return!(r.byteLength!=o.byteLength||!C(new oa(r),new oa(o)));case ut:case J:case Rt:return xi(+r,+o);case ct:return r.name==o.name&&r.message==o.message;case ri:case $i:return r==o+"";case Wt:var k=Qo;case ke:var O=m&t;if(k||(k=ea),r.size!=o.size&&!O)return!1;var q=z.get(r);if(q)return q==o;m|=e,z.set(r,o);var j=Sf(k(r),k(o),m,x,C,z);return z.delete(r),j;case ur:if(gs)return gs.call(r)==gs.call(o)}return!1}function Sg(r,o,d,m,x,C){var z=d&t,k=Ul(r),O=k.length,q=Ul(o),j=q.length;if(O!=j&&!z)return!1;for(var Z=O;Z--;){var ht=k[Z];if(!(z?ht in o:jt.call(o,ht)))return!1}var gt=C.get(r),bt=C.get(o);if(gt&&bt)return gt==o&&bt==r;var kt=!0;C.set(r,o),C.set(o,r);for(var St=z;++Z<O;){ht=k[Z];var Mt=r[ht],Nt=o[ht];if(m)var Qe=z?m(Nt,Mt,ht,o,r,C):m(Mt,Nt,ht,r,o,C);if(!(Qe===h?Mt===Nt||x(Mt,Nt,d,m,C):Qe)){kt=!1;break}St||(St=ht=="constructor")}if(kt&&!St){var Re=r.constructor,ti=o.constructor;Re!=ti&&"constructor"in r&&"constructor"in o&&!(typeof Re=="function"&&Re instanceof Re&&typeof ti=="function"&&ti instanceof ti)&&(kt=!1)}return C.delete(r),C.delete(o),kt}function Zi(r){return Fl(If(r,h,Mf),r+"")}function Ul(r){return Hu(r,be,Tl)}function El(r){return Hu(r,Ye,Uf)}var Cl=ca?function(r){return ca.get(r)}:Wl;function Aa(r){for(var o=r.name+"",d=yr[o],m=jt.call(yr,o)?d.length:0;m--;){var x=d[m],C=x.func;if(C==null||C==r)return x.name}return o}function Sr(r){var o=jt.call(E,"placeholder")?E:r;return o.placeholder}function xt(){var r=E.iteratee||Yl;return r=r===Yl?Wu:r,arguments.length?r(arguments[0],arguments[1]):r}function Ta(r,o){var d=r.__data__;return zg(o)?d[typeof o=="string"?"string":"hash"]:d.map}function Al(r){for(var o=be(r),d=o.length;d--;){var m=o[d],x=r[m];o[d]=[m,x,Af(x)]}return o}function Gn(r,o){var d=kp(r,o);return Vu(d)?d:h}function Ug(r){var o=jt.call(r,Dn),d=r[Dn];try{r[Dn]=h;var m=!0}catch{}var x=sa.call(r);return m&&(o?r[Dn]=d:delete r[Dn]),x}var Tl=el?function(r){return r==null?[]:(r=Zt(r),pn(el(r),function(o){return Iu.call(r,o)}))}:$l,Uf=el?function(r){for(var o=[];r;)_n(o,Tl(r)),r=la(r);return o}:$l,ze=Pe;(il&&ze(new il(new ArrayBuffer(1)))!=si||cs&&ze(new cs)!=Wt||nl&&ze(nl.resolve())!=Li||vr&&ze(new vr)!=ke||ps&&ze(new ps)!=qt)&&(ze=function(r){var o=Pe(r),d=o==pe?r.constructor:h,m=d?Hn(d):"";if(m)switch(m){case a_:return si;case o_:return Wt;case l_:return Li;case h_:return ke;case u_:return qt}return o});function Eg(r,o,d){for(var m=-1,x=d.length;++m<x;){var C=d[m],z=C.size;switch(C.type){case"drop":r+=z;break;case"dropRight":o-=z;break;case"take":o=Be(o,r+z);break;case"takeRight":r=ve(r,o-z);break}}return{start:r,end:o}}function Cg(r){var o=r.match(js);return o?o[1].split(Hh):[]}function Ef(r,o,d){o=wn(o,r);for(var m=-1,x=o.length,C=!1;++m<x;){var z=Mi(o[m]);if(!(C=r!=null&&d(r,z)))break;r=r[z]}return C||++m!=x?C:(x=r==null?0:r.length,!!x&&Pa(x)&&Ji(z,x)&&(Bt(r)||Yn(r)))}function Ag(r){var o=r.length,d=new r.constructor(o);return o&&typeof r[0]=="string"&&jt.call(r,"index")&&(d.index=r.index,d.input=r.input),d}function Cf(r){return typeof r.constructor=="function"&&!Ss(r)?wr(la(r)):{}}function Tg(r,o,d){var m=r.constructor;switch(o){case Ln:return xl(r);case ut:case J:return new m(+r);case si:return fg(r,d);case fr:case kn:case as:case os:case ls:case ki:case hs:case cn:case us:return lf(r,d);case Wt:return new m;case Rt:case $i:return new m(r);case ri:return dg(r);case ke:return new m;case ur:return cg(r)}}function Ig(r,o){var d=o.length;if(!d)return r;var m=d-1;return o[m]=(d>1?"& ":"")+o[m],o=o.join(d>2?", ":" "),r.replace(Pi,`{
/* [wrapped with `+o+`] */
`)}function Bg(r){return Bt(r)||Yn(r)||!!(Bu&&r&&r[Bu])}function Ji(r,o){var d=typeof r;return o=o??Gt,!!o&&(d=="number"||d!="symbol"&&Hc.test(r))&&r>-1&&r%1==0&&r<o}function De(r,o,d){if(!ae(d))return!1;var m=typeof o;return(m=="number"?He(d)&&Ji(o,d.length):m=="string"&&o in d)?xi(d[o],r):!1}function Il(r,o){if(Bt(r))return!1;var d=typeof r;return d=="number"||d=="symbol"||d=="boolean"||r==null||Je(r)?!0:Kt.test(r)||!Tt.test(r)||o!=null&&r in Zt(o)}function zg(r){var o=typeof r;return o=="string"||o=="number"||o=="symbol"||o=="boolean"?r!=="__proto__":r===null}function Bl(r){var o=Aa(r),d=E[o];if(typeof d!="function"||!(o in Ot.prototype))return!1;if(r===d)return!0;var m=Cl(d);return!!m&&r===m[0]}function Fg(r){return!!Cu&&Cu in r}var Lg=na?Qi:Xl;function Ss(r){var o=r&&r.constructor,d=typeof o=="function"&&o.prototype||mr;return r===d}function Af(r){return r===r&&!ae(r)}function Tf(r,o){return function(d){return d==null?!1:d[r]===o&&(o!==h||r in Zt(d))}}function kg(r){var o=La(r,function(m){return d.size===I&&d.clear(),m}),d=o.cache;return o}function Pg(r,o){var d=r[1],m=o[1],x=d|m,C=x<(n|a|L),z=m==L&&d==g||m==L&&d==F&&r[7].length<=o[8]||m==(L|F)&&o[7].length<=o[8]&&d==g;if(!(C||z))return r;m&n&&(r[2]=o[2],x|=d&n?0:f);var k=o[3];if(k){var O=r[3];r[3]=O?uf(O,k,o[4]):k,r[4]=O?gn(r[3],B):o[4]}return k=o[5],k&&(O=r[5],r[5]=O?ff(O,k,o[6]):k,r[6]=O?gn(r[5],B):o[6]),k=o[7],k&&(r[7]=k),m&L&&(r[8]=r[8]==null?o[8]:Be(r[8],o[8])),r[9]==null&&(r[9]=o[9]),r[0]=o[0],r[1]=x,r}function Dg(r){var o=[];if(r!=null)for(var d in Zt(r))o.push(d);return o}function Rg(r){return sa.call(r)}function If(r,o,d){return o=ve(o===h?r.length-1:o,0),function(){for(var m=arguments,x=-1,C=ve(m.length-o,0),z=H(C);++x<C;)z[x]=m[o+x];x=-1;for(var k=H(o+1);++x<o;)k[x]=m[x];return k[o]=d(z),je(r,this,k)}}function Bf(r,o){return o.length<2?r:Nn(r,fi(o,0,-1))}function Mg(r,o){for(var d=r.length,m=Be(o.length,d),x=Ge(r);m--;){var C=o[m];r[m]=Ji(C,d)?x[C]:h}return r}function zl(r,o){if(!(o==="constructor"&&typeof r[o]=="function")&&o!="__proto__")return r[o]}var zf=Lf(Qu),Us=Qp||function(r,o){return Ee.setTimeout(r,o)},Fl=Lf(og);function Ff(r,o,d){var m=o+"";return Fl(r,Ig(m,Og(Cg(m),d)))}function Lf(r){var o=0,d=0;return function(){var m=n_(),x=at-(m-d);if(d=m,x>0){if(++o>=it)return arguments[0]}else o=0;return r.apply(h,arguments)}}function Ia(r,o){var d=-1,m=r.length,x=m-1;for(o=o===h?m:o;++d<o;){var C=pl(d,x),z=r[C];r[C]=r[d],r[d]=z}return r.length=o,r}var kf=kg(function(r){var o=[];return r.charCodeAt(0)===46&&o.push(""),r.replace(_e,function(d,m,x,C){o.push(x?C.replace(Dc,"$1"):m||d)}),o});function Mi(r){if(typeof r=="string"||Je(r))return r;var o=r+"";return o=="0"&&1/r==-1/0?"-0":o}function Hn(r){if(r!=null){try{return ra.call(r)}catch{}try{return r+""}catch{}}return""}function Og(r,o){return oi(Yt,function(d){var m="_."+d[0];o&d[1]&&!Qs(r,m)&&r.push(m)}),r.sort()}function Pf(r){if(r instanceof Ot)return r.clone();var o=new hi(r.__wrapped__,r.__chain__);return o.__actions__=Ge(r.__actions__),o.__index__=r.__index__,o.__values__=r.__values__,o}function Ng(r,o,d){(d?De(r,o,d):o===h)?o=1:o=ve(Lt(o),0);var m=r==null?0:r.length;if(!m||o<1)return[];for(var x=0,C=0,z=H(fa(m/o));x<m;)z[C++]=fi(r,x,x+=o);return z}function Gg(r){for(var o=-1,d=r==null?0:r.length,m=0,x=[];++o<d;){var C=r[o];C&&(x[m++]=C)}return x}function Hg(){var r=arguments.length;if(!r)return[];for(var o=H(r-1),d=arguments[0],m=r;m--;)o[m-1]=arguments[m];return _n(Bt(d)?Ge(d):[d],Ce(o,1))}var Yg=Dt(function(r,o){return de(r)?vs(r,Ce(o,1,de,!0)):[]}),Vg=Dt(function(r,o){var d=di(o);return de(d)&&(d=h),de(r)?vs(r,Ce(o,1,de,!0),xt(d,2)):[]}),Wg=Dt(function(r,o){var d=di(o);return de(d)&&(d=h),de(r)?vs(r,Ce(o,1,de,!0),h,d):[]});function $g(r,o,d){var m=r==null?0:r.length;return m?(o=d||o===h?1:Lt(o),fi(r,o<0?0:o,m)):[]}function Xg(r,o,d){var m=r==null?0:r.length;return m?(o=d||o===h?1:Lt(o),o=m-o,fi(r,0,o<0?0:o)):[]}function qg(r,o){return r&&r.length?xa(r,xt(o,3),!0,!0):[]}function jg(r,o){return r&&r.length?xa(r,xt(o,3),!0):[]}function Kg(r,o,d,m){var x=r==null?0:r.length;return x?(d&&typeof d!="number"&&De(r,o,d)&&(d=0,m=x),H_(r,o,d,m)):[]}function Df(r,o,d){var m=r==null?0:r.length;if(!m)return-1;var x=d==null?0:Lt(d);return x<0&&(x=ve(m+x,0)),ta(r,xt(o,3),x)}function Rf(r,o,d){var m=r==null?0:r.length;if(!m)return-1;var x=m-1;return d!==h&&(x=Lt(d),x=d<0?ve(m+x,0):Be(x,m-1)),ta(r,xt(o,3),x,!0)}function Mf(r){var o=r==null?0:r.length;return o?Ce(r,1):[]}function Zg(r){var o=r==null?0:r.length;return o?Ce(r,At):[]}function Jg(r,o){var d=r==null?0:r.length;return d?(o=o===h?1:Lt(o),Ce(r,o)):[]}function Qg(r){for(var o=-1,d=r==null?0:r.length,m={};++o<d;){var x=r[o];m[x[0]]=x[1]}return m}function Of(r){return r&&r.length?r[0]:h}function tm(r,o,d){var m=r==null?0:r.length;if(!m)return-1;var x=d==null?0:Lt(d);return x<0&&(x=ve(m+x,0)),cr(r,o,x)}function em(r){var o=r==null?0:r.length;return o?fi(r,0,-1):[]}var im=Dt(function(r){var o=ne(r,yl);return o.length&&o[0]===r[0]?hl(o):[]}),nm=Dt(function(r){var o=di(r),d=ne(r,yl);return o===di(d)?o=h:d.pop(),d.length&&d[0]===r[0]?hl(d,xt(o,2)):[]}),rm=Dt(function(r){var o=di(r),d=ne(r,yl);return o=typeof o=="function"?o:h,o&&d.pop(),d.length&&d[0]===r[0]?hl(d,h,o):[]});function sm(r,o){return r==null?"":e_.call(r,o)}function di(r){var o=r==null?0:r.length;return o?r[o-1]:h}function am(r,o,d){var m=r==null?0:r.length;if(!m)return-1;var x=m;return d!==h&&(x=Lt(d),x=x<0?ve(m+x,0):Be(x,m-1)),o===o?Op(r,o,x):ta(r,vu,x,!0)}function om(r,o){return r&&r.length?ju(r,Lt(o)):h}var lm=Dt(Nf);function Nf(r,o){return r&&r.length&&o&&o.length?cl(r,o):r}function hm(r,o,d){return r&&r.length&&o&&o.length?cl(r,o,xt(d,2)):r}function um(r,o,d){return r&&r.length&&o&&o.length?cl(r,o,h,d):r}var fm=Zi(function(r,o){var d=r==null?0:r.length,m=sl(r,o);return Ju(r,ne(o,function(x){return Ji(x,d)?+x:x}).sort(hf)),m});function dm(r,o){var d=[];if(!(r&&r.length))return d;var m=-1,x=[],C=r.length;for(o=xt(o,3);++m<C;){var z=r[m];o(z,m,r)&&(d.push(z),x.push(m))}return Ju(r,x),d}function Ll(r){return r==null?r:s_.call(r)}function cm(r,o,d){var m=r==null?0:r.length;return m?(d&&typeof d!="number"&&De(r,o,d)?(o=0,d=m):(o=o==null?0:Lt(o),d=d===h?m:Lt(d)),fi(r,o,d)):[]}function pm(r,o){return wa(r,o)}function _m(r,o,d){return gl(r,o,xt(d,2))}function gm(r,o){var d=r==null?0:r.length;if(d){var m=wa(r,o);if(m<d&&xi(r[m],o))return m}return-1}function mm(r,o){return wa(r,o,!0)}function vm(r,o,d){return gl(r,o,xt(d,2),!0)}function ym(r,o){var d=r==null?0:r.length;if(d){var m=wa(r,o,!0)-1;if(xi(r[m],o))return m}return-1}function wm(r){return r&&r.length?tf(r):[]}function xm(r,o){return r&&r.length?tf(r,xt(o,2)):[]}function bm(r){var o=r==null?0:r.length;return o?fi(r,1,o):[]}function Sm(r,o,d){return r&&r.length?(o=d||o===h?1:Lt(o),fi(r,0,o<0?0:o)):[]}function Um(r,o,d){var m=r==null?0:r.length;return m?(o=d||o===h?1:Lt(o),o=m-o,fi(r,o<0?0:o,m)):[]}function Em(r,o){return r&&r.length?xa(r,xt(o,3),!1,!0):[]}function Cm(r,o){return r&&r.length?xa(r,xt(o,3)):[]}var Am=Dt(function(r){return yn(Ce(r,1,de,!0))}),Tm=Dt(function(r){var o=di(r);return de(o)&&(o=h),yn(Ce(r,1,de,!0),xt(o,2))}),Im=Dt(function(r){var o=di(r);return o=typeof o=="function"?o:h,yn(Ce(r,1,de,!0),h,o)});function Bm(r){return r&&r.length?yn(r):[]}function zm(r,o){return r&&r.length?yn(r,xt(o,2)):[]}function Fm(r,o){return o=typeof o=="function"?o:h,r&&r.length?yn(r,h,o):[]}function kl(r){if(!(r&&r.length))return[];var o=0;return r=pn(r,function(d){if(de(d))return o=ve(d.length,o),!0}),Zo(o,function(d){return ne(r,qo(d))})}function Gf(r,o){if(!(r&&r.length))return[];var d=kl(r);return o==null?d:ne(d,function(m){return je(o,h,m)})}var Lm=Dt(function(r,o){return de(r)?vs(r,o):[]}),km=Dt(function(r){return vl(pn(r,de))}),Pm=Dt(function(r){var o=di(r);return de(o)&&(o=h),vl(pn(r,de),xt(o,2))}),Dm=Dt(function(r){var o=di(r);return o=typeof o=="function"?o:h,vl(pn(r,de),h,o)}),Rm=Dt(kl);function Mm(r,o){return sf(r||[],o||[],ms)}function Om(r,o){return sf(r||[],o||[],xs)}var Nm=Dt(function(r){var o=r.length,d=o>1?r[o-1]:h;return d=typeof d=="function"?(r.pop(),d):h,Gf(r,d)});function Hf(r){var o=E(r);return o.__chain__=!0,o}function Gm(r,o){return o(r),r}function Ba(r,o){return o(r)}var Hm=Zi(function(r){var o=r.length,d=o?r[0]:0,m=this.__wrapped__,x=function(C){return sl(C,r)};return o>1||this.__actions__.length||!(m instanceof Ot)||!Ji(d)?this.thru(x):(m=m.slice(d,+d+(o?1:0)),m.__actions__.push({func:Ba,args:[x],thisArg:h}),new hi(m,this.__chain__).thru(function(C){return o&&!C.length&&C.push(h),C}))});function Ym(){return Hf(this)}function Vm(){return new hi(this.value(),this.__chain__)}function Wm(){this.__values__===h&&(this.__values__=id(this.value()));var r=this.__index__>=this.__values__.length,o=r?h:this.__values__[this.__index__++];return{done:r,value:o}}function $m(){return this}function Xm(r){for(var o,d=this;d instanceof _a;){var m=Pf(d);m.__index__=0,m.__values__=h,o?x.__wrapped__=m:o=m;var x=m;d=d.__wrapped__}return x.__wrapped__=r,o}function qm(){var r=this.__wrapped__;if(r instanceof Ot){var o=r;return this.__actions__.length&&(o=new Ot(this)),o=o.reverse(),o.__actions__.push({func:Ba,args:[Ll],thisArg:h}),new hi(o,this.__chain__)}return this.thru(Ll)}function jm(){return rf(this.__wrapped__,this.__actions__)}var Km=ba(function(r,o,d){jt.call(r,d)?++r[d]:ji(r,d,1)});function Zm(r,o,d){var m=Bt(r)?gu:G_;return d&&De(r,o,d)&&(o=h),m(r,xt(o,3))}function Jm(r,o){var d=Bt(r)?pn:Nu;return d(r,xt(o,3))}var Qm=_f(Df),tv=_f(Rf);function ev(r,o){return Ce(za(r,o),1)}function iv(r,o){return Ce(za(r,o),At)}function nv(r,o,d){return d=d===h?1:Lt(d),Ce(za(r,o),d)}function Yf(r,o){var d=Bt(r)?oi:vn;return d(r,xt(o,3))}function Vf(r,o){var d=Bt(r)?bp:Ou;return d(r,xt(o,3))}var rv=ba(function(r,o,d){jt.call(r,d)?r[d].push(o):ji(r,d,[o])});function sv(r,o,d,m){r=He(r)?r:Er(r),d=d&&!m?Lt(d):0;var x=r.length;return d<0&&(d=ve(x+d,0)),Da(r)?d<=x&&r.indexOf(o,d)>-1:!!x&&cr(r,o,d)>-1}var av=Dt(function(r,o,d){var m=-1,x=typeof o=="function",C=He(r)?H(r.length):[];return vn(r,function(z){C[++m]=x?je(o,z,d):ys(z,o,d)}),C}),ov=ba(function(r,o,d){ji(r,d,o)});function za(r,o){var d=Bt(r)?ne:$u;return d(r,xt(o,3))}function lv(r,o,d,m){return r==null?[]:(Bt(o)||(o=o==null?[]:[o]),d=m?h:d,Bt(d)||(d=d==null?[]:[d]),Ku(r,o,d))}var hv=ba(function(r,o,d){r[d?0:1].push(o)},function(){return[[],[]]});function uv(r,o,d){var m=Bt(r)?$o:wu,x=arguments.length<3;return m(r,xt(o,4),d,x,vn)}function fv(r,o,d){var m=Bt(r)?Sp:wu,x=arguments.length<3;return m(r,xt(o,4),d,x,Ou)}function dv(r,o){var d=Bt(r)?pn:Nu;return d(r,ka(xt(o,3)))}function cv(r){var o=Bt(r)?Pu:sg;return o(r)}function pv(r,o,d){(d?De(r,o,d):o===h)?o=1:o=Lt(o);var m=Bt(r)?D_:ag;return m(r,o)}function _v(r){var o=Bt(r)?R_:lg;return o(r)}function gv(r){if(r==null)return 0;if(He(r))return Da(r)?_r(r):r.length;var o=ze(r);return o==Wt||o==ke?r.size:fl(r).length}function mv(r,o,d){var m=Bt(r)?Xo:hg;return d&&De(r,o,d)&&(o=h),m(r,xt(o,3))}var vv=Dt(function(r,o){if(r==null)return[];var d=o.length;return d>1&&De(r,o[0],o[1])?o=[]:d>2&&De(o[0],o[1],o[2])&&(o=[o[0]]),Ku(r,Ce(o,1),[])}),Fa=Jp||function(){return Ee.Date.now()};function yv(r,o){if(typeof o!="function")throw new li(y);return r=Lt(r),function(){if(--r<1)return o.apply(this,arguments)}}function Wf(r,o,d){return o=d?h:o,o=r&&o==null?r.length:o,Ki(r,L,h,h,h,h,o)}function $f(r,o){var d;if(typeof o!="function")throw new li(y);return r=Lt(r),function(){return--r>0&&(d=o.apply(this,arguments)),r<=1&&(o=h),d}}var Pl=Dt(function(r,o,d){var m=n;if(d.length){var x=gn(d,Sr(Pl));m|=w}return Ki(r,m,o,d,x)}),Xf=Dt(function(r,o,d){var m=n|a;if(d.length){var x=gn(d,Sr(Xf));m|=w}return Ki(o,m,r,d,x)});function qf(r,o,d){o=d?h:o;var m=Ki(r,g,h,h,h,h,h,o);return m.placeholder=qf.placeholder,m}function jf(r,o,d){o=d?h:o;var m=Ki(r,v,h,h,h,h,h,o);return m.placeholder=jf.placeholder,m}function Kf(r,o,d){var m,x,C,z,k,O,q=0,j=!1,Z=!1,ht=!0;if(typeof r!="function")throw new li(y);o=ci(o)||0,ae(d)&&(j=!!d.leading,Z="maxWait"in d,C=Z?ve(ci(d.maxWait)||0,o):C,ht="trailing"in d?!!d.trailing:ht);function gt(ce){var bi=m,en=x;return m=x=h,q=ce,z=r.apply(en,bi),z}function bt(ce){return q=ce,k=Us(Mt,o),j?gt(ce):z}function kt(ce){var bi=ce-O,en=ce-q,_d=o-bi;return Z?Be(_d,C-en):_d}function St(ce){var bi=ce-O,en=ce-q;return O===h||bi>=o||bi<0||Z&&en>=C}function Mt(){var ce=Fa();if(St(ce))return Nt(ce);k=Us(Mt,kt(ce))}function Nt(ce){return k=h,ht&&m?gt(ce):(m=x=h,z)}function Qe(){k!==h&&af(k),q=0,m=O=x=k=h}function Re(){return k===h?z:Nt(Fa())}function ti(){var ce=Fa(),bi=St(ce);if(m=arguments,x=this,O=ce,bi){if(k===h)return bt(O);if(Z)return af(k),k=Us(Mt,o),gt(O)}return k===h&&(k=Us(Mt,o)),z}return ti.cancel=Qe,ti.flush=Re,ti}var wv=Dt(function(r,o){return Mu(r,1,o)}),xv=Dt(function(r,o,d){return Mu(r,ci(o)||0,d)});function bv(r){return Ki(r,P)}function La(r,o){if(typeof r!="function"||o!=null&&typeof o!="function")throw new li(y);var d=function(){var m=arguments,x=o?o.apply(this,m):m[0],C=d.cache;if(C.has(x))return C.get(x);var z=r.apply(this,m);return d.cache=C.set(x,z)||C,z};return d.cache=new(La.Cache||qi),d}La.Cache=qi;function ka(r){if(typeof r!="function")throw new li(y);return function(){var o=arguments;switch(o.length){case 0:return!r.call(this);case 1:return!r.call(this,o[0]);case 2:return!r.call(this,o[0],o[1]);case 3:return!r.call(this,o[0],o[1],o[2])}return!r.apply(this,o)}}function Sv(r){return $f(2,r)}var Uv=ug(function(r,o){o=o.length==1&&Bt(o[0])?ne(o[0],Ke(xt())):ne(Ce(o,1),Ke(xt()));var d=o.length;return Dt(function(m){for(var x=-1,C=Be(m.length,d);++x<C;)m[x]=o[x].call(this,m[x]);return je(r,this,m)})}),Dl=Dt(function(r,o){var d=gn(o,Sr(Dl));return Ki(r,w,h,o,d)}),Zf=Dt(function(r,o){var d=gn(o,Sr(Zf));return Ki(r,S,h,o,d)}),Ev=Zi(function(r,o){return Ki(r,F,h,h,h,o)});function Cv(r,o){if(typeof r!="function")throw new li(y);return o=o===h?o:Lt(o),Dt(r,o)}function Av(r,o){if(typeof r!="function")throw new li(y);return o=o==null?0:ve(Lt(o),0),Dt(function(d){var m=d[o],x=xn(d,0,o);return m&&_n(x,m),je(r,this,x)})}function Tv(r,o,d){var m=!0,x=!0;if(typeof r!="function")throw new li(y);return ae(d)&&(m="leading"in d?!!d.leading:m,x="trailing"in d?!!d.trailing:x),Kf(r,o,{leading:m,maxWait:o,trailing:x})}function Iv(r){return Wf(r,1)}function Bv(r,o){return Dl(wl(o),r)}function zv(){if(!arguments.length)return[];var r=arguments[0];return Bt(r)?r:[r]}function Fv(r){return ui(r,G)}function Lv(r,o){return o=typeof o=="function"?o:h,ui(r,G,o)}function kv(r){return ui(r,T|G)}function Pv(r,o){return o=typeof o=="function"?o:h,ui(r,T|G,o)}function Dv(r,o){return o==null||Ru(r,o,be(o))}function xi(r,o){return r===o||r!==r&&o!==o}var Rv=Ca(ll),Mv=Ca(function(r,o){return r>=o}),Yn=Yu(function(){return arguments}())?Yu:function(r){return he(r)&&jt.call(r,"callee")&&!Iu.call(r,"callee")},Bt=H.isArray,Ov=uu?Ke(uu):X_;function He(r){return r!=null&&Pa(r.length)&&!Qi(r)}function de(r){return he(r)&&He(r)}function Nv(r){return r===!0||r===!1||he(r)&&Pe(r)==ut}var bn=t_||Xl,Gv=fu?Ke(fu):q_;function Hv(r){return he(r)&&r.nodeType===1&&!Es(r)}function Yv(r){if(r==null)return!0;if(He(r)&&(Bt(r)||typeof r=="string"||typeof r.splice=="function"||bn(r)||Ur(r)||Yn(r)))return!r.length;var o=ze(r);if(o==Wt||o==ke)return!r.size;if(Ss(r))return!fl(r).length;for(var d in r)if(jt.call(r,d))return!1;return!0}function Vv(r,o){return ws(r,o)}function Wv(r,o,d){d=typeof d=="function"?d:h;var m=d?d(r,o):h;return m===h?ws(r,o,h,d):!!m}function Rl(r){if(!he(r))return!1;var o=Pe(r);return o==ct||o==lt||typeof r.message=="string"&&typeof r.name=="string"&&!Es(r)}function $v(r){return typeof r=="number"&&zu(r)}function Qi(r){if(!ae(r))return!1;var o=Pe(r);return o==ie||o==Xt||o==Ne||o==Fo}function Jf(r){return typeof r=="number"&&r==Lt(r)}function Pa(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Gt}function ae(r){var o=typeof r;return r!=null&&(o=="object"||o=="function")}function he(r){return r!=null&&typeof r=="object"}var Qf=du?Ke(du):K_;function Xv(r,o){return r===o||ul(r,o,Al(o))}function qv(r,o,d){return d=typeof d=="function"?d:h,ul(r,o,Al(o),d)}function jv(r){return td(r)&&r!=+r}function Kv(r){if(Lg(r))throw new It(_);return Vu(r)}function Zv(r){return r===null}function Jv(r){return r==null}function td(r){return typeof r=="number"||he(r)&&Pe(r)==Rt}function Es(r){if(!he(r)||Pe(r)!=pe)return!1;var o=la(r);if(o===null)return!0;var d=jt.call(o,"constructor")&&o.constructor;return typeof d=="function"&&d instanceof d&&ra.call(d)==qp}var Ml=cu?Ke(cu):Z_;function Qv(r){return Jf(r)&&r>=-9007199254740991&&r<=Gt}var ed=pu?Ke(pu):J_;function Da(r){return typeof r=="string"||!Bt(r)&&he(r)&&Pe(r)==$i}function Je(r){return typeof r=="symbol"||he(r)&&Pe(r)==ur}var Ur=_u?Ke(_u):Q_;function ty(r){return r===h}function ey(r){return he(r)&&ze(r)==qt}function iy(r){return he(r)&&Pe(r)==ko}var ny=Ca(dl),ry=Ca(function(r,o){return r<=o});function id(r){if(!r)return[];if(He(r))return Da(r)?yi(r):Ge(r);if(ds&&r[ds])return Dp(r[ds]());var o=ze(r),d=o==Wt?Qo:o==ke?ea:Er;return d(r)}function tn(r){if(!r)return r===0?r:0;if(r=ci(r),r===At||r===-1/0){var o=r<0?-1:1;return o*nt}return r===r?r:0}function Lt(r){var o=tn(r),d=o%1;return o===o?d?o-d:o:0}function nd(r){return r?On(Lt(r),0,K):0}function ci(r){if(typeof r=="number")return r;if(Je(r))return Y;if(ae(r)){var o=typeof r.valueOf=="function"?r.valueOf():r;r=ae(o)?o+"":o}if(typeof r!="string")return r===0?r:+r;r=xu(r);var d=Oc.test(r);return d||Gc.test(r)?yp(r.slice(2),d?2:8):Mc.test(r)?Y:+r}function rd(r){return Ri(r,Ye(r))}function sy(r){return r?On(Lt(r),-9007199254740991,Gt):r===0?r:0}function $t(r){return r==null?"":Ze(r)}var ay=xr(function(r,o){if(Ss(o)||He(o)){Ri(o,be(o),r);return}for(var d in o)jt.call(o,d)&&ms(r,d,o[d])}),sd=xr(function(r,o){Ri(o,Ye(o),r)}),Ra=xr(function(r,o,d,m){Ri(o,Ye(o),r,m)}),oy=xr(function(r,o,d,m){Ri(o,be(o),r,m)}),ly=Zi(sl);function hy(r,o){var d=wr(r);return o==null?d:Du(d,o)}var uy=Dt(function(r,o){r=Zt(r);var d=-1,m=o.length,x=m>2?o[2]:h;for(x&&De(o[0],o[1],x)&&(m=1);++d<m;)for(var C=o[d],z=Ye(C),k=-1,O=z.length;++k<O;){var q=z[k],j=r[q];(j===h||xi(j,mr[q])&&!jt.call(r,q))&&(r[q]=C[q])}return r}),fy=Dt(function(r){return r.push(h,bf),je(ad,h,r)});function dy(r,o){return mu(r,xt(o,3),Di)}function cy(r,o){return mu(r,xt(o,3),ol)}function py(r,o){return r==null?r:al(r,xt(o,3),Ye)}function _y(r,o){return r==null?r:Gu(r,xt(o,3),Ye)}function gy(r,o){return r&&Di(r,xt(o,3))}function my(r,o){return r&&ol(r,xt(o,3))}function vy(r){return r==null?[]:va(r,be(r))}function yy(r){return r==null?[]:va(r,Ye(r))}function Ol(r,o,d){var m=r==null?h:Nn(r,o);return m===h?d:m}function wy(r,o){return r!=null&&Ef(r,o,Y_)}function Nl(r,o){return r!=null&&Ef(r,o,V_)}var xy=mf(function(r,o,d){o!=null&&typeof o.toString!="function"&&(o=sa.call(o)),r[o]=d},Hl(Ve)),by=mf(function(r,o,d){o!=null&&typeof o.toString!="function"&&(o=sa.call(o)),jt.call(r,o)?r[o].push(d):r[o]=[d]},xt),Sy=Dt(ys);function be(r){return He(r)?ku(r):fl(r)}function Ye(r){return He(r)?ku(r,!0):tg(r)}function Uy(r,o){var d={};return o=xt(o,3),Di(r,function(m,x,C){ji(d,o(m,x,C),m)}),d}function Ey(r,o){var d={};return o=xt(o,3),Di(r,function(m,x,C){ji(d,x,o(m,x,C))}),d}var Cy=xr(function(r,o,d){ya(r,o,d)}),ad=xr(function(r,o,d,m){ya(r,o,d,m)}),Ay=Zi(function(r,o){var d={};if(r==null)return d;var m=!1;o=ne(o,function(C){return C=wn(C,r),m||(m=C.length>1),C}),Ri(r,El(r),d),m&&(d=ui(d,T|U|G,xg));for(var x=o.length;x--;)ml(d,o[x]);return d});function Ty(r,o){return od(r,ka(xt(o)))}var Iy=Zi(function(r,o){return r==null?{}:ig(r,o)});function od(r,o){if(r==null)return{};var d=ne(El(r),function(m){return[m]});return o=xt(o),Zu(r,d,function(m,x){return o(m,x[0])})}function By(r,o,d){o=wn(o,r);var m=-1,x=o.length;for(x||(x=1,r=h);++m<x;){var C=r==null?h:r[Mi(o[m])];C===h&&(m=x,C=d),r=Qi(C)?C.call(r):C}return r}function zy(r,o,d){return r==null?r:xs(r,o,d)}function Fy(r,o,d,m){return m=typeof m=="function"?m:h,r==null?r:xs(r,o,d,m)}var ld=wf(be),hd=wf(Ye);function Ly(r,o,d){var m=Bt(r),x=m||bn(r)||Ur(r);if(o=xt(o,4),d==null){var C=r&&r.constructor;x?d=m?new C:[]:ae(r)?d=Qi(C)?wr(la(r)):{}:d={}}return(x?oi:Di)(r,function(z,k,O){return o(d,z,k,O)}),d}function ky(r,o){return r==null?!0:ml(r,o)}function Py(r,o,d){return r==null?r:nf(r,o,wl(d))}function Dy(r,o,d,m){return m=typeof m=="function"?m:h,r==null?r:nf(r,o,wl(d),m)}function Er(r){return r==null?[]:Jo(r,be(r))}function Ry(r){return r==null?[]:Jo(r,Ye(r))}function My(r,o,d){return d===h&&(d=o,o=h),d!==h&&(d=ci(d),d=d===d?d:0),o!==h&&(o=ci(o),o=o===o?o:0),On(ci(r),o,d)}function Oy(r,o,d){return o=tn(o),d===h?(d=o,o=0):d=tn(d),r=ci(r),W_(r,o,d)}function Ny(r,o,d){if(d&&typeof d!="boolean"&&De(r,o,d)&&(o=d=h),d===h&&(typeof o=="boolean"?(d=o,o=h):typeof r=="boolean"&&(d=r,r=h)),r===h&&o===h?(r=0,o=1):(r=tn(r),o===h?(o=r,r=0):o=tn(o)),r>o){var m=r;r=o,o=m}if(d||r%1||o%1){var x=Fu();return Be(r+x*(o-r+vp("1e-"+((x+"").length-1))),o)}return pl(r,o)}var Gy=br(function(r,o,d){return o=o.toLowerCase(),r+(d?ud(o):o)});function ud(r){return Gl($t(r).toLowerCase())}function fd(r){return r=$t(r),r&&r.replace(Yc,zp).replace(lp,"")}function Hy(r,o,d){r=$t(r),o=Ze(o);var m=r.length;d=d===h?m:On(Lt(d),0,m);var x=d;return d-=o.length,d>=0&&r.slice(d,x)==o}function Yy(r){return r=$t(r),r&&yt.test(r)?r.replace($,Fp):r}function Vy(r){return r=$t(r),r&&re.test(r)?r.replace(ge,"\\$&"):r}var Wy=br(function(r,o,d){return r+(d?"-":"")+o.toLowerCase()}),$y=br(function(r,o,d){return r+(d?" ":"")+o.toLowerCase()}),Xy=pf("toLowerCase");function qy(r,o,d){r=$t(r),o=Lt(o);var m=o?_r(r):0;if(!o||m>=o)return r;var x=(o-m)/2;return Ea(da(x),d)+r+Ea(fa(x),d)}function jy(r,o,d){r=$t(r),o=Lt(o);var m=o?_r(r):0;return o&&m<o?r+Ea(o-m,d):r}function Ky(r,o,d){r=$t(r),o=Lt(o);var m=o?_r(r):0;return o&&m<o?Ea(o-m,d)+r:r}function Zy(r,o,d){return d||o==null?o=0:o&&(o=+o),r_($t(r).replace(se,""),o||0)}function Jy(r,o,d){return(d?De(r,o,d):o===h)?o=1:o=Lt(o),_l($t(r),o)}function Qy(){var r=arguments,o=$t(r[0]);return r.length<3?o:o.replace(r[1],r[2])}var t0=br(function(r,o,d){return r+(d?"_":"")+o.toLowerCase()});function e0(r,o,d){return d&&typeof d!="number"&&De(r,o,d)&&(o=d=h),d=d===h?K:d>>>0,d?(r=$t(r),r&&(typeof o=="string"||o!=null&&!Ml(o))&&(o=Ze(o),!o&&pr(r))?xn(yi(r),0,d):r.split(o,d)):[]}var i0=br(function(r,o,d){return r+(d?" ":"")+Gl(o)});function n0(r,o,d){return r=$t(r),d=d==null?0:On(Lt(d),0,r.length),o=Ze(o),r.slice(d,d+o.length)==o}function r0(r,o,d){var m=E.templateSettings;d&&De(r,o,d)&&(o=h),r=$t(r),o=Ra({},o,m,xf);var x=Ra({},o.imports,m.imports,xf),C=be(x),z=Jo(x,C),k,O,q=0,j=o.interpolate||Ks,Z="__p += '",ht=tl((o.escape||Ks).source+"|"+j.source+"|"+(j===wt?Rc:Ks).source+"|"+(o.evaluate||Ks).source+"|$","g"),gt="//# sourceURL="+(jt.call(o,"sourceURL")?(o.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++cp+"]")+`
`;r.replace(ht,function(St,Mt,Nt,Qe,Re,ti){return Nt||(Nt=Qe),Z+=r.slice(q,ti).replace(Vc,Lp),Mt&&(k=!0,Z+=`' +
__e(`+Mt+`) +
'`),Re&&(O=!0,Z+=`';
`+Re+`;
__p += '`),Nt&&(Z+=`' +
((__t = (`+Nt+`)) == null ? '' : __t) +
'`),q=ti+St.length,St}),Z+=`';
`;var bt=jt.call(o,"variable")&&o.variable;if(!bt)Z=`with (obj) {
`+Z+`
}
`;else if(Pc.test(bt))throw new It(s);Z=(O?Z.replace(Po,""):Z).replace(Do,"$1").replace(Ro,"$1;"),Z="function("+(bt||"obj")+`) {
`+(bt?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(k?", __e = _.escape":"")+(O?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+Z+`return __p
}`;var kt=cd(function(){return Vt(C,gt+"return "+Z).apply(h,z)});if(kt.source=Z,Rl(kt))throw kt;return kt}function s0(r){return $t(r).toLowerCase()}function a0(r){return $t(r).toUpperCase()}function o0(r,o,d){if(r=$t(r),r&&(d||o===h))return xu(r);if(!r||!(o=Ze(o)))return r;var m=yi(r),x=yi(o),C=bu(m,x),z=Su(m,x)+1;return xn(m,C,z).join("")}function l0(r,o,d){if(r=$t(r),r&&(d||o===h))return r.slice(0,Eu(r)+1);if(!r||!(o=Ze(o)))return r;var m=yi(r),x=Su(m,yi(o))+1;return xn(m,0,x).join("")}function h0(r,o,d){if(r=$t(r),r&&(d||o===h))return r.replace(se,"");if(!r||!(o=Ze(o)))return r;var m=yi(r),x=bu(m,yi(o));return xn(m,x).join("")}function u0(r,o){var d=M,m=D;if(ae(o)){var x="separator"in o?o.separator:x;d="length"in o?Lt(o.length):d,m="omission"in o?Ze(o.omission):m}r=$t(r);var C=r.length;if(pr(r)){var z=yi(r);C=z.length}if(d>=C)return r;var k=d-_r(m);if(k<1)return m;var O=z?xn(z,0,k).join(""):r.slice(0,k);if(x===h)return O+m;if(z&&(k+=O.length-k),Ml(x)){if(r.slice(k).search(x)){var q,j=O;for(x.global||(x=tl(x.source,$t(Yh.exec(x))+"g")),x.lastIndex=0;q=x.exec(j);)var Z=q.index;O=O.slice(0,Z===h?k:Z)}}else if(r.indexOf(Ze(x),k)!=k){var ht=O.lastIndexOf(x);ht>-1&&(O=O.slice(0,ht))}return O+m}function f0(r){return r=$t(r),r&&rt.test(r)?r.replace(qs,Np):r}var d0=br(function(r,o,d){return r+(d?" ":"")+o.toUpperCase()}),Gl=pf("toUpperCase");function dd(r,o,d){return r=$t(r),o=d?h:o,o===h?Pp(r)?Yp(r):Cp(r):r.match(o)||[]}var cd=Dt(function(r,o){try{return je(r,h,o)}catch(d){return Rl(d)?d:new It(d)}}),c0=Zi(function(r,o){return oi(o,function(d){d=Mi(d),ji(r,d,Pl(r[d],r))}),r});function p0(r){var o=r==null?0:r.length,d=xt();return r=o?ne(r,function(m){if(typeof m[1]!="function")throw new li(y);return[d(m[0]),m[1]]}):[],Dt(function(m){for(var x=-1;++x<o;){var C=r[x];if(je(C[0],this,m))return je(C[1],this,m)}})}function _0(r){return N_(ui(r,T))}function Hl(r){return function(){return r}}function g0(r,o){return r==null||r!==r?o:r}var m0=gf(),v0=gf(!0);function Ve(r){return r}function Yl(r){return Wu(typeof r=="function"?r:ui(r,T))}function y0(r){return Xu(ui(r,T))}function w0(r,o){return qu(r,ui(o,T))}var x0=Dt(function(r,o){return function(d){return ys(d,r,o)}}),b0=Dt(function(r,o){return function(d){return ys(r,d,o)}});function Vl(r,o,d){var m=be(o),x=va(o,m);d==null&&!(ae(o)&&(x.length||!m.length))&&(d=o,o=r,r=this,x=va(o,be(o)));var C=!(ae(d)&&"chain"in d)||!!d.chain,z=Qi(r);return oi(x,function(k){var O=o[k];r[k]=O,z&&(r.prototype[k]=function(){var q=this.__chain__;if(C||q){var j=r(this.__wrapped__),Z=j.__actions__=Ge(this.__actions__);return Z.push({func:O,args:arguments,thisArg:r}),j.__chain__=q,j}return O.apply(r,_n([this.value()],arguments))})}),r}function S0(){return Ee._===this&&(Ee._=jp),this}function Wl(){}function U0(r){return r=Lt(r),Dt(function(o){return ju(o,r)})}var E0=bl(ne),C0=bl(gu),A0=bl(Xo);function pd(r){return Il(r)?qo(Mi(r)):ng(r)}function T0(r){return function(o){return r==null?h:Nn(r,o)}}var I0=vf(),B0=vf(!0);function $l(){return[]}function Xl(){return!1}function z0(){return{}}function F0(){return""}function L0(){return!0}function k0(r,o){if(r=Lt(r),r<1||r>Gt)return[];var d=K,m=Be(r,K);o=xt(o),r-=K;for(var x=Zo(m,o);++d<r;)o(d);return x}function P0(r){return Bt(r)?ne(r,Mi):Je(r)?[r]:Ge(kf($t(r)))}function D0(r){var o=++Xp;return $t(r)+o}var R0=Ua(function(r,o){return r+o},0),M0=Sl("ceil"),O0=Ua(function(r,o){return r/o},1),N0=Sl("floor");function G0(r){return r&&r.length?ma(r,Ve,ll):h}function H0(r,o){return r&&r.length?ma(r,xt(o,2),ll):h}function Y0(r){return yu(r,Ve)}function V0(r,o){return yu(r,xt(o,2))}function W0(r){return r&&r.length?ma(r,Ve,dl):h}function $0(r,o){return r&&r.length?ma(r,xt(o,2),dl):h}var X0=Ua(function(r,o){return r*o},1),q0=Sl("round"),j0=Ua(function(r,o){return r-o},0);function K0(r){return r&&r.length?Ko(r,Ve):0}function Z0(r,o){return r&&r.length?Ko(r,xt(o,2)):0}return E.after=yv,E.ary=Wf,E.assign=ay,E.assignIn=sd,E.assignInWith=Ra,E.assignWith=oy,E.at=ly,E.before=$f,E.bind=Pl,E.bindAll=c0,E.bindKey=Xf,E.castArray=zv,E.chain=Hf,E.chunk=Ng,E.compact=Gg,E.concat=Hg,E.cond=p0,E.conforms=_0,E.constant=Hl,E.countBy=Km,E.create=hy,E.curry=qf,E.curryRight=jf,E.debounce=Kf,E.defaults=uy,E.defaultsDeep=fy,E.defer=wv,E.delay=xv,E.difference=Yg,E.differenceBy=Vg,E.differenceWith=Wg,E.drop=$g,E.dropRight=Xg,E.dropRightWhile=qg,E.dropWhile=jg,E.fill=Kg,E.filter=Jm,E.flatMap=ev,E.flatMapDeep=iv,E.flatMapDepth=nv,E.flatten=Mf,E.flattenDeep=Zg,E.flattenDepth=Jg,E.flip=bv,E.flow=m0,E.flowRight=v0,E.fromPairs=Qg,E.functions=vy,E.functionsIn=yy,E.groupBy=rv,E.initial=em,E.intersection=im,E.intersectionBy=nm,E.intersectionWith=rm,E.invert=xy,E.invertBy=by,E.invokeMap=av,E.iteratee=Yl,E.keyBy=ov,E.keys=be,E.keysIn=Ye,E.map=za,E.mapKeys=Uy,E.mapValues=Ey,E.matches=y0,E.matchesProperty=w0,E.memoize=La,E.merge=Cy,E.mergeWith=ad,E.method=x0,E.methodOf=b0,E.mixin=Vl,E.negate=ka,E.nthArg=U0,E.omit=Ay,E.omitBy=Ty,E.once=Sv,E.orderBy=lv,E.over=E0,E.overArgs=Uv,E.overEvery=C0,E.overSome=A0,E.partial=Dl,E.partialRight=Zf,E.partition=hv,E.pick=Iy,E.pickBy=od,E.property=pd,E.propertyOf=T0,E.pull=lm,E.pullAll=Nf,E.pullAllBy=hm,E.pullAllWith=um,E.pullAt=fm,E.range=I0,E.rangeRight=B0,E.rearg=Ev,E.reject=dv,E.remove=dm,E.rest=Cv,E.reverse=Ll,E.sampleSize=pv,E.set=zy,E.setWith=Fy,E.shuffle=_v,E.slice=cm,E.sortBy=vv,E.sortedUniq=wm,E.sortedUniqBy=xm,E.split=e0,E.spread=Av,E.tail=bm,E.take=Sm,E.takeRight=Um,E.takeRightWhile=Em,E.takeWhile=Cm,E.tap=Gm,E.throttle=Tv,E.thru=Ba,E.toArray=id,E.toPairs=ld,E.toPairsIn=hd,E.toPath=P0,E.toPlainObject=rd,E.transform=Ly,E.unary=Iv,E.union=Am,E.unionBy=Tm,E.unionWith=Im,E.uniq=Bm,E.uniqBy=zm,E.uniqWith=Fm,E.unset=ky,E.unzip=kl,E.unzipWith=Gf,E.update=Py,E.updateWith=Dy,E.values=Er,E.valuesIn=Ry,E.without=Lm,E.words=dd,E.wrap=Bv,E.xor=km,E.xorBy=Pm,E.xorWith=Dm,E.zip=Rm,E.zipObject=Mm,E.zipObjectDeep=Om,E.zipWith=Nm,E.entries=ld,E.entriesIn=hd,E.extend=sd,E.extendWith=Ra,Vl(E,E),E.add=R0,E.attempt=cd,E.camelCase=Gy,E.capitalize=ud,E.ceil=M0,E.clamp=My,E.clone=Fv,E.cloneDeep=kv,E.cloneDeepWith=Pv,E.cloneWith=Lv,E.conformsTo=Dv,E.deburr=fd,E.defaultTo=g0,E.divide=O0,E.endsWith=Hy,E.eq=xi,E.escape=Yy,E.escapeRegExp=Vy,E.every=Zm,E.find=Qm,E.findIndex=Df,E.findKey=dy,E.findLast=tv,E.findLastIndex=Rf,E.findLastKey=cy,E.floor=N0,E.forEach=Yf,E.forEachRight=Vf,E.forIn=py,E.forInRight=_y,E.forOwn=gy,E.forOwnRight=my,E.get=Ol,E.gt=Rv,E.gte=Mv,E.has=wy,E.hasIn=Nl,E.head=Of,E.identity=Ve,E.includes=sv,E.indexOf=tm,E.inRange=Oy,E.invoke=Sy,E.isArguments=Yn,E.isArray=Bt,E.isArrayBuffer=Ov,E.isArrayLike=He,E.isArrayLikeObject=de,E.isBoolean=Nv,E.isBuffer=bn,E.isDate=Gv,E.isElement=Hv,E.isEmpty=Yv,E.isEqual=Vv,E.isEqualWith=Wv,E.isError=Rl,E.isFinite=$v,E.isFunction=Qi,E.isInteger=Jf,E.isLength=Pa,E.isMap=Qf,E.isMatch=Xv,E.isMatchWith=qv,E.isNaN=jv,E.isNative=Kv,E.isNil=Jv,E.isNull=Zv,E.isNumber=td,E.isObject=ae,E.isObjectLike=he,E.isPlainObject=Es,E.isRegExp=Ml,E.isSafeInteger=Qv,E.isSet=ed,E.isString=Da,E.isSymbol=Je,E.isTypedArray=Ur,E.isUndefined=ty,E.isWeakMap=ey,E.isWeakSet=iy,E.join=sm,E.kebabCase=Wy,E.last=di,E.lastIndexOf=am,E.lowerCase=$y,E.lowerFirst=Xy,E.lt=ny,E.lte=ry,E.max=G0,E.maxBy=H0,E.mean=Y0,E.meanBy=V0,E.min=W0,E.minBy=$0,E.stubArray=$l,E.stubFalse=Xl,E.stubObject=z0,E.stubString=F0,E.stubTrue=L0,E.multiply=X0,E.nth=om,E.noConflict=S0,E.noop=Wl,E.now=Fa,E.pad=qy,E.padEnd=jy,E.padStart=Ky,E.parseInt=Zy,E.random=Ny,E.reduce=uv,E.reduceRight=fv,E.repeat=Jy,E.replace=Qy,E.result=By,E.round=q0,E.runInContext=R,E.sample=cv,E.size=gv,E.snakeCase=t0,E.some=mv,E.sortedIndex=pm,E.sortedIndexBy=_m,E.sortedIndexOf=gm,E.sortedLastIndex=mm,E.sortedLastIndexBy=vm,E.sortedLastIndexOf=ym,E.startCase=i0,E.startsWith=n0,E.subtract=j0,E.sum=K0,E.sumBy=Z0,E.template=r0,E.times=k0,E.toFinite=tn,E.toInteger=Lt,E.toLength=nd,E.toLower=s0,E.toNumber=ci,E.toSafeInteger=sy,E.toString=$t,E.toUpper=a0,E.trim=o0,E.trimEnd=l0,E.trimStart=h0,E.truncate=u0,E.unescape=f0,E.uniqueId=D0,E.upperCase=d0,E.upperFirst=Gl,E.each=Yf,E.eachRight=Vf,E.first=Of,Vl(E,function(){var r={};return Di(E,function(o,d){jt.call(E.prototype,d)||(r[d]=o)}),r}(),{chain:!1}),E.VERSION=u,oi(["bind","bindKey","curry","curryRight","partial","partialRight"],function(r){E[r].placeholder=E}),oi(["drop","take"],function(r,o){Ot.prototype[r]=function(d){d=d===h?1:ve(Lt(d),0);var m=this.__filtered__&&!o?new Ot(this):this.clone();return m.__filtered__?m.__takeCount__=Be(d,m.__takeCount__):m.__views__.push({size:Be(d,K),type:r+(m.__dir__<0?"Right":"")}),m},Ot.prototype[r+"Right"]=function(d){return this.reverse()[r](d).reverse()}}),oi(["filter","map","takeWhile"],function(r,o){var d=o+1,m=d==Ft||d==Ct;Ot.prototype[r]=function(x){var C=this.clone();return C.__iteratees__.push({iteratee:xt(x,3),type:d}),C.__filtered__=C.__filtered__||m,C}}),oi(["head","last"],function(r,o){var d="take"+(o?"Right":"");Ot.prototype[r]=function(){return this[d](1).value()[0]}}),oi(["initial","tail"],function(r,o){var d="drop"+(o?"":"Right");Ot.prototype[r]=function(){return this.__filtered__?new Ot(this):this[d](1)}}),Ot.prototype.compact=function(){return this.filter(Ve)},Ot.prototype.find=function(r){return this.filter(r).head()},Ot.prototype.findLast=function(r){return this.reverse().find(r)},Ot.prototype.invokeMap=Dt(function(r,o){return typeof r=="function"?new Ot(this):this.map(function(d){return ys(d,r,o)})}),Ot.prototype.reject=function(r){return this.filter(ka(xt(r)))},Ot.prototype.slice=function(r,o){r=Lt(r);var d=this;return d.__filtered__&&(r>0||o<0)?new Ot(d):(r<0?d=d.takeRight(-r):r&&(d=d.drop(r)),o!==h&&(o=Lt(o),d=o<0?d.dropRight(-o):d.take(o-r)),d)},Ot.prototype.takeRightWhile=function(r){return this.reverse().takeWhile(r).reverse()},Ot.prototype.toArray=function(){return this.take(K)},Di(Ot.prototype,function(r,o){var d=/^(?:filter|find|map|reject)|While$/.test(o),m=/^(?:head|last)$/.test(o),x=E[m?"take"+(o=="last"?"Right":""):o],C=m||/^find/.test(o);x&&(E.prototype[o]=function(){var z=this.__wrapped__,k=m?[1]:arguments,O=z instanceof Ot,q=k[0],j=O||Bt(z),Z=function(Mt){var Nt=x.apply(E,_n([Mt],k));return m&&ht?Nt[0]:Nt};j&&d&&typeof q=="function"&&q.length!=1&&(O=j=!1);var ht=this.__chain__,gt=!!this.__actions__.length,bt=C&&!ht,kt=O&&!gt;if(!C&&j){z=kt?z:new Ot(this);var St=r.apply(z,k);return St.__actions__.push({func:Ba,args:[Z],thisArg:h}),new hi(St,ht)}return bt&&kt?r.apply(this,k):(St=this.thru(Z),bt?m?St.value()[0]:St.value():St)})}),oi(["pop","push","shift","sort","splice","unshift"],function(r){var o=ia[r],d=/^(?:push|sort|unshift)$/.test(r)?"tap":"thru",m=/^(?:pop|shift)$/.test(r);E.prototype[r]=function(){var x=arguments;if(m&&!this.__chain__){var C=this.value();return o.apply(Bt(C)?C:[],x)}return this[d](function(z){return o.apply(Bt(z)?z:[],x)})}}),Di(Ot.prototype,function(r,o){var d=E[o];if(d){var m=d.name+"";jt.call(yr,m)||(yr[m]=[]),yr[m].push({name:o,func:d})}}),yr[Sa(h,a).name]=[{name:"wrapper",func:h}],Ot.prototype.clone=f_,Ot.prototype.reverse=d_,Ot.prototype.value=c_,E.prototype.at=Hm,E.prototype.chain=Ym,E.prototype.commit=Vm,E.prototype.next=Wm,E.prototype.plant=Xm,E.prototype.reverse=qm,E.prototype.toJSON=E.prototype.valueOf=E.prototype.value=jm,E.prototype.first=E.prototype.head,ds&&(E.prototype[ds]=$m),E},gr=Vp();Pn?((Pn.exports=gr)._=gr,Yo._=gr):Ee._=gr}).call(Cs)})(Io,Io.exports);var Lc=Io.exports;const cS={class:"w-full h-full bg-[#201f20] relative overflow-hidden select-none"},pS={class:"flex justify-between items-center px-4 py-2"},_S={class:"flex items-center gap-4"},gS={class:"text-white hover:text-purple-500 transition-colors"},mS={class:"flex items-center gap-2"},vS={class:"text-white min-w-[50px] text-center"},yS={class:"flex items-center gap-2"},wS={key:0,class:"absolute w-[10%] left-0 top-0 inset-0 flex flex-col items-center justify-center"},nh="track-zoom-value",Wd=3,Sn=150,xS=30,$d=5,rh=15,bS=Fi({__name:"clipTrack",props:{tracks:{},maxTracksNum:{},currentTime:{},timelineDuration:{}},emits:["resetTrack","timeUpdate","refreshPlayer","add-clip","activeClip","delete-empty-track","handleExport","update:tracks"],setup(c,{expose:l,emit:h}){const u=c,p=h,_=Ue(()=>Wd*y.value*10),y=pt(parseFloat(localStorage.getItem(nh)||"1")),s=()=>{y.value<5&&(y.value<1?y.value=Math.min(5,Math.round((y.value+.1)*10)/10):y.value=Math.min(5,Math.floor(y.value+1)),localStorage.setItem(nh,y.value.toString()))},b=()=>{y.value>.3&&(y.value<=1?y.value=Math.max(.3,Math.round((y.value-.1)*10)/10):y.value=Math.max(1,Math.floor(y.value-1)),localStorage.setItem(nh,y.value.toString()))},I=Ue(()=>u.timelineDuration*_.value),B=pt(null),T=pt(-1),U=pt(!1),G=pt(0),t=pt(0),e=pt(null),n=pt(0),a=pt(0),f=pt(null),g=pt(15),v=pt(null),w=pt([]),S=pt(!1),L=pt(null),F=pt(null),P=rs(),M=$=>{$.preventDefault();const rt=$.currentTarget.getBoundingClientRect(),yt=$.clientX-rt.left,_t=$.target.closest("[data-track]"),wt=_t==null?void 0:_t.getAttribute("data-track");if(!P.getDragData)return;const Kt=yt/_.value;try{if(wt){const _e=u.tracks.find(ge=>ge.id===wt);if(_e){const ge=u.tracks.indexOf(_e),re=_e.clips.find(se=>Kt>=se.startTime&&Kt<=se.endTime);re?(S.value=!0,F.value=re,G.value=re.startTime*_.value,T.value=ge):(F.value=null,G.value=Kt*_.value,T.value=ge)}}else F.value=null,G.value=Kt*_.value,T.value=-1}catch(_e){console.error("DragOver error:",_e)}},D=$=>{const rt=$.currentTarget.getBoundingClientRect(),yt=$.clientX,vt=$.clientY;(yt<rt.left||yt>rt.right||vt<rt.top||vt>rt.bottom)&&(it(),U.value=!1,T.value=-1)},it=()=>{v.value&&T.value>=0&&(u.tracks[T.value].clips.forEach(rt=>{const yt=v.value.find(vt=>vt.id===rt.id);yt&&(rt.startTime=yt.startTime)}),v.value=null,w.value=[])},at=async $=>{$.preventDefault();const rt=$.currentTarget.getBoundingClientRect(),vt=($.clientX-rt.left)/_.value,_t=P.getDragData;if(!_t)return;const wt={..._t,id:Zr(),rect:null,opacity:100,volume:100,startTime:S.value&&F.value?Number(F.value.startTime):vt,duration:Number((_t.duration||5*1e6)/1e6),selected:!1,sourceStartTime:0,sourceEndTime:0,originalDuration:Number((_t.duration||5*1e6)/1e6)};if(wt.endTime=wt.startTime+wt.duration,wt.type==="video"||wt.type==="image"){const Tt=await Eh(wt);Tt.type==="video"?wt.thumbnail=Tt.data:Tt.type==="image"&&(wt.thumbnail=[{timestamp:0,url:URL.createObjectURL(Tt.data)}])}else if(wt.type==="audio"){const Tt=await Ch(wt);Tt.type==="audio"&&(wt.volumeData=Tt.data)}else wt.type==="text"&&(wt.textConfig={content:"Hello, World!",fontSize:24,fontFamily:"Arial",color:"#000000",x:10,y:10,width:100,height:100});if(T.value>=0){const Tt=u.tracks[T.value];Tt.clips.push(wt),Tt.clips.sort((Kt,_e)=>Kt.startTime-_e.startTime)}else if(u.tracks.length<u.maxTracksNum)u.tracks.push({id:Zr(),clips:[wt]});else{lr.warning("轨道数量已达到最大限制("+u.maxTracksNum+")");return}Ft(u.tracks[T.value],wt),p("add-clip",wt),Ct(),ki(),P.clearDragData()},Ft=($,rt)=>{if(!$||($==null?void 0:$.clips.length)===0)return;const yt=$.clips.filter(_t=>_t.endTime>rt.startTime&&_t.startTime<rt.startTime);if(yt.length!==0&&Wt.value==="other")rt.startTime=yt[0].endTime,rt.endTime=rt.startTime+rt.duration;else if(yt.length!==0&&Wt.value==="same")if(u.tracks.length<u.maxTracksNum){const _t={id:Zr(),clips:[rt]},wt=u.tracks.findIndex(Tt=>Tt.id===$.id);u.tracks.splice(wt+1,0,_t),$.clips=$.clips.filter(Tt=>Tt.id!==rt.id)}else return rt.startTime=yt[0].endTime,rt.endTime=rt.startTime+rt.duration,lr.warning(`轨道数量已达到最大限制(${u.maxTracksNum})`);const vt=$.clips.filter(_t=>_t.id!==rt.id&&_t.startTime>=rt.startTime).sort((_t,wt)=>_t.startTime-wt.startTime);if(vt.length!==0&&vt[0].startTime<rt.endTime){let _t=rt.endTime;vt.forEach(wt=>{const Tt=wt.endTime-wt.startTime;wt.startTime=_t,wt.endTime=wt.startTime+Tt,_t=wt.endTime})}},V=$=>{var rt;(rt=B.value)==null||rt.activeClip($),nt.value=$},Ct=()=>{S.value=!1,L.value=null,F.value=null,U.value=!1,T.value=-1,G.value=0},At=$=>{T.value=$},Gt=$=>{T.value===$&&(T.value=-1)},nt=pt(null),Y=pt(!1),K=pt(null),ot=pt(0),X=pt(0),Yt=pt(0),le=$=>{nt.value||(nt.value=$)},qe=($,rt,yt)=>{$.stopPropagation(),Y.value=!0,K.value=yt,nt.value=rt,ot.value=$.clientX,X.value=Number(rt.startTime),Yt.value=Number(rt.endTime),rt.originalDuration||(rt.originalDuration=rt.duration),document.addEventListener("mousemove",ut),document.addEventListener("mouseup",J)},Ne=Ue(()=>xS/_.value),ut=$=>{if(!Y.value||!nt.value)return;$.preventDefault(),$.stopPropagation();const rt=qt.value.getBoundingClientRect(),vt=($.clientX-rt.left+qt.value.scrollLeft)/_.value;if(nt.value.type==="video"||nt.value.type==="audio"){const _t=Number(nt.value.originalDuration);if(K.value==="left"){const wt=Number(nt.value.endTime),Tt=Number(nt.value.sourceEndTime),Kt=wt-Ne.value,_e=Math.min(Math.max(0,vt),Kt),ge=wt-_e,re=_t-(Tt+ge);re>=0&&re+Tt<=_t&&(nt.value.startTime=_e,nt.value.duration=ge,nt.value.sourceStartTime=re)}else if(K.value==="right"){const wt=Number(nt.value.startTime),Tt=Number(nt.value.sourceStartTime),Kt=wt+Ne.value,_e=wt+(_t-Tt),ge=Math.min(Math.max(Kt,vt),_e),re=ge-wt,se=_t-(Tt+re);se>=0&&Tt+re<=_t&&(nt.value.endTime=ge,nt.value.duration=re,nt.value.sourceEndTime=se)}}else if(K.value==="left"){const _t=Number(nt.value.endTime),wt=_t-Ne.value,Tt=Math.min(Math.max(0,vt),wt),Kt=_t-Tt;nt.value.startTime=Tt,nt.value.duration=Kt}else if(K.value==="right"){const _t=Number(nt.value.startTime),wt=_t+Ne.value,Tt=Math.max(wt,vt),Kt=Tt-_t;nt.value.endTime=Tt,nt.value.duration=Kt}},J=()=>{if(Y.value&&nt.value){const $=Number(nt.value.startTime),rt=Number(nt.value.duration);nt.value.endTime=$+rt,nt.value.startTime=$,nt.value.duration=rt,nt.value.sourceStartTime=Number(nt.value.sourceStartTime),nt.value.sourceEndTime=Number(nt.value.sourceEndTime),nt.value.originalDuration=Number(nt.value.originalDuration),P.publishClipUpdate(nt.value,"resize")}Y.value=!1,K.value=null,ki(),document.removeEventListener("mousemove",ut),document.removeEventListener("mouseup",J)},lt=pt({x:0,y:0}),ct=pt(""),ie=($,rt,yt)=>{if(Y.value)return;yt.preventDefault(),yt.stopPropagation(),nt.value=$;const vt=qt.value.getBoundingClientRect(),wt=(yt.clientX-vt.left+qt.value.scrollLeft)/_.value;lt.value={x:yt.clientX,y:yt.clientY},ct.value=rt;const Tt=_e=>{const ge=Math.abs(_e.clientX-lt.value.x),re=Math.abs(_e.clientY-lt.value.y);(ge>$d||re>$d)&&(document.removeEventListener("mousemove",Tt),document.removeEventListener("mouseup",Kt),Fo($,yt))},Kt=()=>{document.removeEventListener("mousemove",Tt),document.removeEventListener("mouseup",Kt),console.log("handleClipMouseDown",$),p("activeClip",$),p("timeUpdate",wt)};document.addEventListener("mousemove",Tt),document.addEventListener("mouseup",Kt)},Xt=pt(!1),Wt=pt(null),Rt=pt(null),vi=pt(0),pe=pt(!1),Li=pt(null),Fo=($,rt)=>{if(!qt.value)return;Xt.value=!0,Rt.value=$,nt.value=$,$.selected=!0;const yt=qt.value.getBoundingClientRect(),vt=Number($.startTime)*_.value+yt.left-qt.value.scrollLeft;vi.value=rt.clientX-vt,n.value=rt.clientX,window.addEventListener("mousemove",ke,{capture:!0,passive:!1}),window.addEventListener("mouseup",$i,{capture:!0}),ri()},ri=()=>{if(!Xt.value||!Rt.value||!qt.value)return;const $=qt.value.getBoundingClientRect();let rt=0,yt=!1;if(e.value==="right"){const _t=1-($.right-n.value)/Sn;rt=Math.max(1,Math.round(g.value*_t)),qt.value.scrollLeft+=rt,yt=!0}else if(e.value==="left"){const _t=1-(n.value-$.left)/Sn;rt=Math.max(1,Math.round(g.value*_t)),qt.value.scrollLeft-=rt,yt=!0}else if(e.value==="up"){const _t=1-(a.value-$.top)/Sn;rt=Math.max(1,Math.round(g.value*_t)),qt.value.scrollTop-=rt,yt=!0}else if(e.value==="down"){const _t=1-($.bottom-a.value)/Sn;rt=Math.max(1,Math.round(g.value*_t)),qt.value.scrollTop+=rt,yt=!0}if(yt){const _t=n.value-$.left+qt.value.scrollLeft-vi.value,wt=Math.max(0,_t/_.value),Tt=Number(Rt.value.duration);Rt.value.startTime=wt,Rt.value.endTime=wt+Tt}if(e.value){const vt=requestAnimationFrame(ri);f.value=vt}},ke=$=>{var ge;if(!Xt.value||!Rt.value||!qt.value)return;$.preventDefault(),$.stopPropagation(),n.value=$.clientX,a.value=$.clientY;const rt=document.elementFromPoint($.clientX,$.clientY),yt=rt==null?void 0:rt.getAttribute("data-clip");let vt=null;yt?vt=(ge=rt==null?void 0:rt.parentElement)==null?void 0:ge.getAttribute("data-track"):vt=rt==null?void 0:rt.getAttribute("data-track");const _t=qt.value.getBoundingClientRect(),Tt=$.clientX-_t.left+qt.value.scrollLeft-vi.value,Kt=Number(Rt.value.duration),_e=vt?u.tracks.find(re=>re.id===vt):null;if(_e){const re=_e.clips.filter(se=>se.id!==Rt.value.id).sort((se,Ie)=>Number(se.startTime)-Number(Ie.startTime));if(pe.value&&Li.value!==null)if(Math.abs(Tt-Li.value)>rh/2)pe.value=!1,Li.value=null;else{const Ie=Li.value/_.value;Rt.value.startTime=Ie,Rt.value.endTime=Ie+Kt;return}for(const se of re){const Ie=Number(se.startTime)*_.value,Pi=Number(se.endTime)*_.value;if(Math.abs(Tt-Pi)<=rh){pe.value=!0,Li.value=Pi,Rt.value.startTime=Pi/_.value,Rt.value.endTime=Pi/_.value+Kt;return}if(Math.abs(Tt+Kt*_.value-Ie)<=rh){pe.value=!0,Li.value=Ie-Kt*_.value,Rt.value.startTime=Ie/_.value-Kt,Rt.value.endTime=Ie/_.value;return}}}if(Rt.value.startTime=Math.max(0,Tt/_.value),Rt.value.endTime=Math.max(Kt,Tt/_.value+Kt),vt&&vt!==ct.value){const re=u.tracks.findIndex(se=>se.id===vt);if(re!==-1){const se=u.tracks.find(Ie=>Ie.id===ct.value);if(se){const Ie=se.clips.findIndex(Pi=>Pi.id===Rt.value.id);Ie!==-1&&(se.clips.splice(Ie,1),u.tracks[re].clips.push(Rt.value),u.tracks[re].clips.sort((Pi,js)=>Number(Pi.startTime)-Number(js.startTime)),ct.value=vt)}}Wt.value="other"}else Wt.value="same";$.clientX>_t.right-Sn?e.value!=="right"&&(e.value="right",ri()):$.clientX<_t.left+Sn?e.value!=="left"&&(e.value="left",ri()):$.clientY<_t.top+Sn?e.value!=="up"&&(e.value="up",ri()):$.clientY>_t.bottom-Sn?e.value!=="down"&&(e.value="down",ri()):e.value!==null&&(e.value=null)},$i=$=>{if(!Xt.value||!Rt.value)return;$&&($.preventDefault(),$.stopPropagation()),pe.value=!1,Li.value=null,f.value!==null&&(cancelAnimationFrame(f.value),f.value=null),Rt.value.selected=!0,nt.value=Rt.value;const rt=u.tracks.find(yt=>yt.id===ct.value);Ft(rt,Rt.value),P.publishClipUpdate(Rt.value),Xt.value=!1,e.value=null,Rt.value=null,ct.value="",vi.value=0,ki(),window.removeEventListener("mousemove",ke,{capture:!0}),window.removeEventListener("mouseup",$i,{capture:!0})};$s(()=>{f.value!==null&&cancelAnimationFrame(f.value),window.removeEventListener("mousemove",ke,{capture:!0}),window.removeEventListener("mouseup",$i,{capture:!0})});const ur=$=>{p("timeUpdate",$)},Lo=($,rt)=>{const yt=u.tracks[rt],vt=yt.clips.findIndex(_t=>_t.id===$.id);vt!==-1&&(yt.clips.splice(vt,1),P.publishClipUpdate($,"delete"),yt.clips.length===0&&u.tracks.splice(rt,1))},qt=pt(null),ko=$=>{if(console.log("handleRulerScroll",$),qt.value){const rt=qt.value.scrollWidth-qt.value.clientWidth,yt=Math.max(0,Math.min(qt.value.scrollLeft+$,rt));qt.value.scrollLeft=yt}},Ln=qd(),si=Number(Ln.params.id),fr=Ue(()=>P.canUndo),kn=pt(!1);zn(()=>u.tracks,async()=>{kn.value=await P.getCanRedo(si)});const as=async()=>{if(!fr.value)return;const $=await P.undo(si);$&&(p("update:tracks",$),p("refreshPlayer"))},os=async()=>{if(!kn.value)return;const $=await P.redo(si);$&&(p("update:tracks",$),p("refreshPlayer"))},ls=async()=>{p("update:tracks",[]),await P.clearHistory(si),p("refreshPlayer")},ki=async()=>{P.saveHistoryState&&(hs(),await P.saveHistoryState(si,JSON.parse(JSON.stringify(u.tracks))))},hs=()=>{p("delete-empty-track")},cn=pt(!1),us=()=>{cn.value=!1,p("activeClip",null)};zn([()=>nt.value,()=>u.currentTime],()=>{if(!nt.value){cn.value=!1;return}const rt=["video","audio","image"].includes(nt.value.type),yt=u.currentTime>Number(nt.value.startTime)&&u.currentTime<Number(nt.value.endTime);cn.value=rt&&yt});const Po=async()=>{const $=Lc.cloneDeep(nt.value);$.id=Zr(),$.startTime=u.currentTime,$.endTime=Number($.endTime),$.type==="text"?($.duration=Number(nt.value.duration)-(u.currentTime-Number(nt.value.startTime)),nt.value.endTime=u.currentTime,nt.value.duration=u.currentTime-Number(nt.value.startTime)):($.sourceStartTime=u.currentTime-Number(nt.value.startTime)+Number($.sourceStartTime),$.duration=Number(nt.value.duration)-$.startTime+nt.value.startTime,nt.value.endTime=u.currentTime,nt.value.duration=u.currentTime-Number(nt.value.startTime),nt.value.sourceEndTime=Number(nt.value.sourceEndTime)-(u.currentTime-Number(nt.value.startTime))),console.log($),Do(nt.value).clips.push($),P.publishClipUpdate(nt.value),p("add-clip",$),ki()},Do=$=>u.tracks.find(rt=>rt.clips.some(yt=>yt.id===$.id)),Ro=()=>{var rt,yt;const $=nt.value;$&&(P.publishClipUpdate($,"delete"),(yt=u.tracks.find(vt=>vt.clips.some(_t=>_t.id===$.id)))==null||yt.clips.splice((rt=u.tracks.find(vt=>vt.clips.some(_t=>_t.id===$.id)))==null?void 0:rt.clips.findIndex(vt=>vt.id===$.id),1),ki())},qs=()=>{p("handleExport")};return l({activeClip:V}),($,rt)=>{const yt=Jt("el-popconfirm"),vt=Jt("el-tooltip"),_t=Jt("el-button");return mt(),Ut("div",cS,[N("div",pS,[N("div",_S,[et(yt,{id:"reset-button",title:"确定要重置轨道吗？","confirm-button-text":"确定","cancel-button-text":"取消",onConfirm:ls},{reference:Ht(()=>[N("button",gS,[et(Et(ee),{icon:"mdi:restore",width:"20"})])]),_:1}),et(vt,{content:"撤销",placement:"top"},{default:Ht(()=>[N("button",{id:"undo-button",class:Tn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!fr.value}]),onClick:as},[et(Et(ee),{icon:"mdi:undo",width:"20"})],2)]),_:1}),et(vt,{content:"恢复",placement:"top"},{default:Ht(()=>[N("button",{id:"redo-button",class:Tn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!kn.value}]),onClick:os},[et(Et(ee),{icon:"mdi:redo",width:"20"})],2)]),_:1}),et(vt,{content:"分割",placement:"top"},{default:Ht(()=>[N("button",{id:"split-button",class:Tn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!cn.value}]),onClick:Po},[et(Et(ee),{icon:"material-symbols-light:split-scene-outline",width:"20"})],2)]),_:1}),et(vt,{content:"删除",placement:"top"},{default:Ht(()=>[N("button",{id:"delete-button",class:"text-white hover:text-purple-500 transition-colors",onClick:Ro},[et(Et(ee),{icon:"mdi:delete",width:"20"})])]),_:1})]),N("div",mS,[et(vt,{content:"缩小",placement:"top"},{default:Ht(()=>[N("button",{id:"zoom-out-button",class:Tn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":y.value<=.3}]),onClick:b},[et(Et(ee),{icon:"mdi:minus",width:"20"})],2)]),_:1}),N("span",vS,Xe(Math.round(y.value*100))+"%",1),et(vt,{content:"放大",placement:"top"},{default:Ht(()=>[N("button",{id:"zoom-in-button",class:Tn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":y.value>=5}]),onClick:s},[et(Et(ee),{icon:"mdi:plus",width:"20"})],2)]),_:1}),et(_t,{id:"export-button",class:"text-white",type:"primary",size:"small",onClick:qs},{default:Ht(()=>[N("div",yS,[et(Et(ee),{icon:"mdi:export",width:"20"}),rt[0]||(rt[0]=nw(" 导出 "))])]),_:1})])]),N("div",{class:"h-[calc(100%-36px)] relative overflow-x-scroll",ref_key:"trackContainer",ref:qt},[et($1,{duration:$.timelineDuration,zoom:y.value,"current-time":$.currentTime,"total-width":I.value,onScroll:ko,onTimeUpdate:ur},null,8,["duration","zoom","current-time","total-width"]),N("div",{class:"relative h-[calc(100%-36px)] overflow-x-hidden overflow-y-auto",style:Wi({width:I.value+"px"}),onDragover:$e(M,["prevent"]),onDragleave:$e(D,["prevent"]),onDrop:$e(at,["prevent"])},[$.tracks.length?ue("",!0):(mt(),Ut("div",wS,rt[1]||(rt[1]=[N("div",{class:"text-[#666] text-lg mb-4"},"拖拽素材到此处",-1),N("div",{class:"w-[200px] h-[40px] bg-purple-500/20 border-2 border-dashed border-purple-500 rounded"},null,-1)]))),et(fS,{ref_key:"tracksListRef",ref:B,tracks:$.tracks,hoveredTrack:T.value,dragPreview:U.value,dragPreviewPosition:G.value,dragPreviewWidth:t.value,zoom:y.value,frameLength:Wd*y.value*10,onStartResize:qe,onTrackDragEnter:At,onTrackDragLeave:Gt,onClipMouseDown:ie,onClipHover:le,onDeleteClip:Lo,onBackgroundClick:us,onSaveHistoryState:ki},null,8,["tracks","hoveredTrack","dragPreview","dragPreviewPosition","dragPreviewWidth","zoom","frameLength"])],36)],512)])}}}),SS={class:"p-6 text-white"},US={key:0,class:"mb-6"},ES={class:"grid grid-cols-2 gap-3 mb-4"},CS={class:"mb-4"},AS={class:"flex items-center gap-4"},TS={class:"w-full"},IS={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},BS={class:"flex gap-3 mb-3"},zS={class:"flex-1"},FS={class:"flex-1"},LS={class:"flex items-center gap-3 mb-3"},kS={class:"flex-1"},PS={class:"flex items-center gap-3"},DS={class:"flex items-center gap-3"},RS={class:"flex-1"},MS={class:"flex items-center gap-3"},OS={class:"w-12 text-right"},NS={key:1,class:"mb-6"},GS={class:"flex gap-3 mb-3"},HS={class:"flex-1"},YS={class:"flex-1"},VS={class:"flex items-center gap-3"},WS={class:"flex-1"},$S={class:"flex items-center gap-3"},XS={key:2,class:"mb-6"},qS={class:"grid grid-cols-2 gap-3 mb-4"},jS={class:"mb-4"},KS={class:"flex items-center gap-4"},ZS={class:"w-full"},JS={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},QS={class:"flex items-center gap-3"},tU={class:"flex-1"},eU={class:"flex items-center gap-3"},iU={class:"w-12 text-right"},nU={key:3,class:"mb-6"},rU={class:"mb-2"},sU={class:"mb-4"},aU={class:"flex items-center gap-4 mb-3"},oU={class:"w-full"},lU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},hU={class:"flex justify-start items-center gap-1"},uU={class:"py-2"},fU={class:"flex justify-between items-center mb-2"},dU={class:"flex-1 mx-4"},cU={class:"flex justify-between items-center mb-2"},pU={class:"flex justify-between items-center mb-2"},_U={class:"flex justify-between items-center mb-2"},gU={class:"flex justify-between items-center mb-2 pl-4"},mU={class:"flex justify-between items-center mb-2 pl-4"},vU={class:"flex justify-between items-center mb-2"},yU={class:"flex justify-between items-center mb-2 pl-4"},wU={class:"flex justify-between items-center mb-2 pl-4"},xU={class:"flex justify-between items-center mb-2 pl-4"},bU={class:"flex justify-between items-center mb-2 pl-4"},SU={key:1,class:"text-center text-[#999] text-base"},UU=Fi({__name:"ClipProperties",props:{clip:{}},setup(c){const l=c,h=rs(),u=pt([]),p=pt(!1),_=n=>{let a=n*(180/Math.PI);return a=a%360,a<0&&(a+=360),Math.round(a)},y=n=>n*(Math.PI/180),s=Ue(()=>{var a;if(((a=l.clip)==null?void 0:a.angle)===void 0)return 0;let n=_(l.clip.angle);return n=(n+180)%360,n}),b=Ue({get:()=>{var n;return((n=l.clip)==null?void 0:n.angle)===void 0?0:_(l.clip.angle)},set:n=>{l.clip&&(l.clip.angle=y(n))}}),I=n=>{if(!l.clip)return;if(n===null||isNaN(n)){l.clip.angle=0;return}let a=n%360;a<0&&(a+=360),l.clip.angle=y(a)},B=Ue(()=>{var n,a;switch((a=(n=l.clip)==null?void 0:n.textConfig)==null?void 0:a.align){case"center":return"material-symbols:format-align-center";case"right":return"material-symbols:format-align-right";default:return"material-symbols:format-align-left"}}),T=n=>{l.clip&&(l.clip.textConfig.align=n)},U=n=>{p.value=!0},G=n=>{if(!p.value||!l.clip)return;const a=n.currentTarget.getBoundingClientRect(),f=a.left+a.width/2,g=a.top+a.height/2;let v=Math.atan2(n.clientY-g,n.clientX-f);v=v+Math.PI/2,v<0&&(v+=Math.PI*2),l.clip.angle=v},t=()=>{p.value=!1},e=(n,a)=>{l.clip&&(n===null||isNaN(n))&&(l.clip[a]=0)};return zn(()=>l.clip,n=>{n&&h.publishClipUpdate(n)},{deep:!0}),(n,a)=>{const f=Jt("el-input-number"),g=Jt("el-slider"),v=Jt("el-input"),w=Jt("el-option"),S=Jt("el-select"),L=Jt("el-button"),F=Jt("el-dropdown-item"),P=Jt("el-dropdown-menu"),M=Jt("el-dropdown"),D=Jt("el-color-picker"),it=Jt("el-switch"),at=Jt("el-collapse-item"),Ft=Jt("el-collapse");return mt(),Ut("div",SS,[n.clip?(mt(),Ut(mi,{key:0},[n.clip.type==="video"?(mt(),Ut("div",US,[a[54]||(a[54]=N("div",{class:"text-base font-medium text-white mb-4"},"视频属性",-1)),N("div",ES,[N("div",null,[a[46]||(a[46]=N("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),et(f,{class:"w-30",modelValue:n.clip.x,"onUpdate:modelValue":a[0]||(a[0]=V=>n.clip.x=V),size:"small",placeholder:"X",precision:0,onChange:a[1]||(a[1]=V=>e(V,"x"))},null,8,["modelValue"])]),N("div",null,[a[47]||(a[47]=N("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),et(f,{class:"w-30",modelValue:n.clip.y,"onUpdate:modelValue":a[2]||(a[2]=V=>n.clip.y=V),size:"small",placeholder:"Y",precision:0,onChange:a[3]||(a[3]=V=>e(V,"y"))},null,8,["modelValue"])])]),N("div",CS,[a[49]||(a[49]=N("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),N("div",AS,[N("div",TS,[et(f,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[4]||(a[4]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:I},null,8,["modelValue"])]),N("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:G,onMouseup:t,onMouseleave:t},[N("div",IS,[N("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Wi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[48]||(a[48]=[N("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),N("div",BS,[N("div",zS,[a[50]||(a[50]=N("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),et(f,{class:"w-30",modelValue:n.clip.sourceStartTime,"onUpdate:modelValue":a[5]||(a[5]=V=>n.clip.sourceStartTime=V),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:a[6]||(a[6]=V=>e(V,"sourceStartTime"))},null,8,["modelValue"])]),N("div",FS,[a[51]||(a[51]=N("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),et(f,{class:"w-30",modelValue:n.clip.sourceEndTime,"onUpdate:modelValue":a[7]||(a[7]=V=>n.clip.sourceEndTime=V),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:a[8]||(a[8]=V=>e(V,"sourceEndTime"))},null,8,["modelValue"])])]),N("div",LS,[N("div",kS,[a[52]||(a[52]=N("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),N("div",PS,[et(g,{modelValue:n.clip.volume,"onUpdate:modelValue":a[9]||(a[9]=V=>n.clip.volume=V),min:0,max:100,step:1},null,8,["modelValue"]),n.clip.volume===100?(mt(),fn(Et(ee),{key:0,icon:"material-symbols:volume-up",onClick:a[10]||(a[10]=V=>n.clip.volume=0)})):n.clip.volume!==0?(mt(),fn(Et(ee),{key:1,icon:"material-symbols:volume-down",onClick:a[11]||(a[11]=V=>n.clip.volume=0)})):(mt(),fn(Et(ee),{key:2,icon:"material-symbols:volume-off",onClick:a[12]||(a[12]=V=>n.clip.volume=100)}))])])]),N("div",DS,[N("div",RS,[a[53]||(a[53]=N("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),N("div",MS,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[13]||(a[13]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"]),N("div",OS,Xe(Math.round(n.clip.opacity))+"%",1)])])])])):ue("",!0),n.clip.type==="audio"?(mt(),Ut("div",NS,[a[58]||(a[58]=N("div",{class:"text-base font-medium text-white mb-4"},"音频属性",-1)),N("div",GS,[N("div",HS,[a[55]||(a[55]=N("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),et(f,{class:"w-30",modelValue:n.clip.sourceStartTime,"onUpdate:modelValue":a[14]||(a[14]=V=>n.clip.sourceStartTime=V),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:a[15]||(a[15]=V=>e(V,"sourceStartTime"))},null,8,["modelValue"])]),N("div",YS,[a[56]||(a[56]=N("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),et(f,{class:"w-30",modelValue:n.clip.sourceEndTime,"onUpdate:modelValue":a[16]||(a[16]=V=>n.clip.sourceEndTime=V),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:a[17]||(a[17]=V=>e(V,"sourceEndTime"))},null,8,["modelValue"])])]),N("div",VS,[N("div",WS,[a[57]||(a[57]=N("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),N("div",$S,[et(g,{modelValue:n.clip.volume,"onUpdate:modelValue":a[18]||(a[18]=V=>n.clip.volume=V),min:0,max:100,step:1},null,8,["modelValue"]),n.clip.volume===100?(mt(),fn(Et(ee),{key:0,icon:"material-symbols:volume-up",onClick:a[19]||(a[19]=V=>n.clip.volume=0)})):n.clip.volume!==0?(mt(),fn(Et(ee),{key:1,icon:"material-symbols:volume-down",onClick:a[20]||(a[20]=V=>n.clip.volume=0)})):(mt(),fn(Et(ee),{key:2,icon:"material-symbols:volume-off",onClick:a[21]||(a[21]=V=>n.clip.volume=100)}))])])])])):ue("",!0),n.clip.type==="image"?(mt(),Ut("div",XS,[a[64]||(a[64]=N("div",{class:"text-base font-medium text-white mb-4"},"图片属性",-1)),N("div",qS,[N("div",null,[a[59]||(a[59]=N("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),et(f,{class:"w-30",modelValue:n.clip.x,"onUpdate:modelValue":a[22]||(a[22]=V=>n.clip.x=V),size:"small",placeholder:"X",precision:0,onChange:a[23]||(a[23]=V=>e(V,"x"))},null,8,["modelValue"])]),N("div",null,[a[60]||(a[60]=N("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),et(f,{class:"w-30",modelValue:n.clip.y,"onUpdate:modelValue":a[24]||(a[24]=V=>n.clip.y=V),size:"small",placeholder:"Y",precision:0,onChange:a[25]||(a[25]=V=>e(V,"y"))},null,8,["modelValue"])])]),N("div",jS,[a[62]||(a[62]=N("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),N("div",KS,[N("div",ZS,[et(f,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[26]||(a[26]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:I},null,8,["modelValue"])]),N("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:G,onMouseup:t,onMouseleave:t},[N("div",JS,[N("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Wi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[61]||(a[61]=[N("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),N("div",QS,[N("div",tU,[a[63]||(a[63]=N("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),N("div",eU,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[27]||(a[27]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"]),N("div",iU,Xe(Math.round(n.clip.opacity))+"%",1)])])])])):ue("",!0),n.clip.type==="text"?(mt(),Ut("div",nU,[a[83]||(a[83]=N("div",{class:"text-base font-medium text-white mb-4"},"文字属性",-1)),N("div",rU,[et(v,{modelValue:n.clip.textConfig.content,"onUpdate:modelValue":a[28]||(a[28]=V=>n.clip.textConfig.content=V),type:"textarea",rows:3,placeholder:"请输入文字内容"},null,8,["modelValue"])]),N("div",sU,[a[69]||(a[69]=N("div",{class:"text-base text-white mb-2"},"字体",-1)),et(S,{modelValue:n.clip.textConfig.fontFamily,"onUpdate:modelValue":a[29]||(a[29]=V=>n.clip.textConfig.fontFamily=V),class:"w-full mb-2"},{default:Ht(()=>[et(w,{label:"DM Sans",value:"DM Sans"}),et(w,{label:"微软雅黑",value:"Microsoft YaHei"}),et(w,{label:"宋体",value:"SimSun"}),et(w,{label:"黑体",value:"SimHei"})]),_:1},8,["modelValue"]),a[70]||(a[70]=N("div",{class:"text-base text-white mb-2"},"旋转角度",-1)),N("div",aU,[N("div",oU,[et(f,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":a[30]||(a[30]=V=>b.value=V),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:I},null,8,["modelValue"])]),N("div",{class:"relative flex items-center justify-center",onMousedown:U,onMousemove:G,onMouseup:t,onMouseleave:t},[N("div",lU,[N("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Wi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},a[65]||(a[65]=[N("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)]),N("div",hU,[et(L,{class:Tn({"text-purple-500":n.clip.textConfig.bold}),size:"small",onClick:a[31]||(a[31]=V=>n.clip.textConfig.bold=!n.clip.textConfig.bold)},{default:Ht(()=>[et(Et(ee),{icon:"material-symbols:format-bold"})]),_:1},8,["class"]),et(L,{class:Tn(["!ml-0",{"text-purple-500":n.clip.textConfig.italic}]),size:"small",onClick:a[32]||(a[32]=V=>n.clip.textConfig.italic=!n.clip.textConfig.italic)},{default:Ht(()=>[et(Et(ee),{icon:"material-symbols:format-italic"})]),_:1},8,["class"]),et(M,{trigger:"click",onCommand:T},{dropdown:Ht(()=>[et(P,null,{default:Ht(()=>[et(F,{command:"left"},{default:Ht(()=>[et(Et(ee),{icon:"material-symbols:format-align-left"}),a[66]||(a[66]=N("span",{class:"text-sm text-white ml-2"},"左对齐",-1))]),_:1}),et(F,{command:"center"},{default:Ht(()=>[et(Et(ee),{icon:"material-symbols:format-align-center"}),a[67]||(a[67]=N("span",{class:"text-sm text-white ml-2"},"居中",-1))]),_:1}),et(F,{command:"right"},{default:Ht(()=>[et(Et(ee),{icon:"material-symbols:format-align-right"}),a[68]||(a[68]=N("span",{class:"text-sm text-white ml-2"},"右对齐",-1))]),_:1})]),_:1})]),default:Ht(()=>[et(L,{size:"small"},{default:Ht(()=>[et(Et(ee),{icon:B.value},null,8,["icon"])]),_:1})]),_:1}),et(D,{modelValue:n.clip.textConfig.color,"onUpdate:modelValue":a[33]||(a[33]=V=>n.clip.textConfig.color=V),size:"small","show-alpha":""},null,8,["modelValue"])])]),et(Ft,{modelValue:u.value,"onUpdate:modelValue":a[45]||(a[45]=V=>u.value=V)},{default:Ht(()=>[et(at,{name:"advanced"},{title:Ht(()=>a[71]||(a[71]=[N("span",{class:"text-base text-white"},"高级",-1)])),default:Ht(()=>[N("div",uU,[N("div",fU,[a[72]||(a[72]=N("span",{class:"text-base text-white"},"透明度",-1)),N("div",dU,[et(g,{modelValue:n.clip.opacity,"onUpdate:modelValue":a[34]||(a[34]=V=>n.clip.opacity=V),min:0,max:100,step:1},null,8,["modelValue"])])]),N("div",cU,[a[73]||(a[73]=N("span",{class:"text-base text-white"},"行高",-1)),et(f,{modelValue:n.clip.textConfig.lineSpacing,"onUpdate:modelValue":a[35]||(a[35]=V=>n.clip.textConfig.lineSpacing=V),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),N("div",pU,[a[74]||(a[74]=N("span",{class:"text-base text-white"},"字间距",-1)),et(f,{modelValue:n.clip.textConfig.letterSpacing,"onUpdate:modelValue":a[36]||(a[36]=V=>n.clip.textConfig.letterSpacing=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),N("div",_U,[a[75]||(a[75]=N("span",{class:"text-base text-white"},"边框",-1)),et(it,{modelValue:n.clip.textConfig.showStroke,"onUpdate:modelValue":a[37]||(a[37]=V=>n.clip.textConfig.showStroke=V)},null,8,["modelValue"])]),n.clip.textConfig.showStroke?(mt(),Ut(mi,{key:0},[N("div",gU,[a[76]||(a[76]=N("span",{class:"text-base text-white"},"边框颜色",-1)),et(D,{modelValue:n.clip.textConfig.strokeColor,"onUpdate:modelValue":a[38]||(a[38]=V=>n.clip.textConfig.strokeColor=V),"show-alpha":"",size:"small"},null,8,["modelValue"])]),N("div",mU,[a[77]||(a[77]=N("span",{class:"text-base text-white"},"边框宽度",-1)),et(f,{modelValue:n.clip.textConfig.strokeWidth,"onUpdate:modelValue":a[39]||(a[39]=V=>n.clip.textConfig.strokeWidth=V),min:0,step:.5,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):ue("",!0),N("div",vU,[a[78]||(a[78]=N("span",{class:"text-base text-white"},"阴影",-1)),et(it,{modelValue:n.clip.textConfig.showShadow,"onUpdate:modelValue":a[40]||(a[40]=V=>n.clip.textConfig.showShadow=V)},null,8,["modelValue"])]),n.clip.textConfig.showShadow?(mt(),Ut(mi,{key:1},[N("div",yU,[a[79]||(a[79]=N("span",{class:"text-base text-white"},"阴影颜色",-1)),et(D,{modelValue:n.clip.textConfig.shadowColor,"onUpdate:modelValue":a[41]||(a[41]=V=>n.clip.textConfig.shadowColor=V),"show-alpha":"",size:"small"},null,8,["modelValue"])]),N("div",wU,[a[80]||(a[80]=N("span",{class:"text-base text-white"},"阴影模糊",-1)),et(f,{modelValue:n.clip.textConfig.shadowBlur,"onUpdate:modelValue":a[42]||(a[42]=V=>n.clip.textConfig.shadowBlur=V),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),N("div",xU,[a[81]||(a[81]=N("span",{class:"text-base text-white"},"水平偏移",-1)),et(f,{modelValue:n.clip.textConfig.shadowOffsetX,"onUpdate:modelValue":a[43]||(a[43]=V=>n.clip.textConfig.shadowOffsetX=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),N("div",bU,[a[82]||(a[82]=N("span",{class:"text-base text-white"},"垂直偏移",-1)),et(f,{modelValue:n.clip.textConfig.shadowOffsetY,"onUpdate:modelValue":a[44]||(a[44]=V=>n.clip.textConfig.shadowOffsetY=V),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):ue("",!0)])]),_:1})]),_:1},8,["modelValue"])])):ue("",!0)],64)):(mt(),Ut("div",SU," 请选择一个片段 "))])}}}),EU={id:"left",class:"h-screen"},CU={id:"right",class:"h-screen overflow-hidden"},AU={id:"top",class:"flex justify-between"},TU={id:"topLeft",class:"w-4/5"},IU={id:"topRight",class:"w-1/5 bg-[#303030]"},BU={id:"bottom",class:"bg-[#201f20]"},sh=10,zU=300,FU=5,Bs="split-sizes",DU=Fi({__name:"index",setup(c){const l=M=>{M.ctrlKey&&M.preventDefault()};es(()=>{window.addEventListener("wheel",l,{passive:!1})}),$s(()=>{window.removeEventListener("wheel",l)});const h=qd(),u=rs(),p=Number(h.params.id),_=[25,75],y=[65,35],s=pt([]),b=pt(0),I=Ue(()=>Math.max(B.value+FU,zU)),B=Ue(()=>{let M=0;return s.value.forEach(D=>{D.clips.forEach(it=>{const at=Number(it.endTime);at>M&&(M=at)})}),M}),T=pt(null),U=pt(null),G=M=>{b.value=M},t=async M=>{const D=ow(M);await Th("/capture/"+p+".png",D,{overwrite:!0});const it=await Vi.projects.where({id:p}).first();it&&Vi.projects.update(it,{thumbnail:"/capture/"+p+".png"})},e=()=>{b.value-=30/1e3/1e3},n=()=>{b.value+=30/1e3/1e3};wd("addClip",async(M,D)=>{if(M.startTime=b.value,M.endTime=b.value+M.duration,M.type==="video"&&(M.sourceStartTime=0,M.sourceEndTime=0,M.originalDuration=M.duration),M.type==="video"||M.type==="image"){const it=await Eh(M);it.type==="video"?M.thumbnail=it.data:it.type==="image"&&(M.thumbnail=[{timestamp:0,url:URL.createObjectURL(it.data)}])}if(M.type==="audio"){const it=await Ch(M);it.type==="audio"&&(M.volumeData=it.data)}if(D){if(s.value.length>=sh){lr.warning(`轨道数量已达到最大限制(${sh})`);return}const it={id:String(s.value.length),clips:[M]};s.value.push(it)}else s.value.length===0&&s.value.push({id:"0",clips:[]}),s.value[s.value.length-1].clips.push(M);Gs(()=>{var it;(it=T.value)==null||it.refreshPlayer()})}),wd("activeClip",M=>{var D,it,at;if(M){const Ft=(D=s.value.find(V=>V.clips.some(Ct=>Ct.id===M)))==null?void 0:D.clips.find(V=>V.id===M);Ft&&((it=U.value)==null||it.activeClip(Ft),v.value=Ft)}else(at=U.value)==null||at.activeClip(null),v.value=null}),pt(0),pt(0),es(async()=>{const M=localStorage.getItem(Bs),{horizontalSizes:D,verticalSizes:it}=M?JSON.parse(M):{horizontalSizes:_,verticalSizes:y};Yd(["#left","#right"],{sizes:D,minSize:[250,500],snapOffset:0,onDragEnd:Ft=>{const V=localStorage.getItem(Bs),Ct=V?JSON.parse(V):{};localStorage.setItem(Bs,JSON.stringify({...Ct,horizontalSizes:Ft}))}}),Yd(["#top","#bottom"],{direction:"vertical",sizes:it,minSize:[250,150],snapOffset:0,onDragEnd:Ft=>{const V=localStorage.getItem(Bs),Ct=V?JSON.parse(V):{};localStorage.setItem(Bs,JSON.stringify({...Ct,verticalSizes:Ft}))}});const at=await Vi.projects.where({id:p}).first();at&&(s.value=at.tracks,L(),s.value.forEach(Ft=>{Ft.clips.forEach(V=>{V.type==="audio"?Ch(V).then(Ct=>{Ct.type==="audio"&&(V.volumeData=Ct.data)}):(V.type==="video"||V.type==="image")&&Eh(V).then(Ct=>{Ct.type==="video"?V.thumbnail=Ct.data:Ct.type==="image"&&(V.thumbnail=[{timestamp:0,url:URL.createObjectURL(Ct.data)}])})})}),u.clearHistory(p),u.saveHistoryState(p,s.value),F())});const a=()=>{u.setShowContextMenu(!1)},f=(M,D)=>{for(const it of s.value)for(const at of it.clips)if(at.id===M){Object.assign(at,D);break}};zn(()=>s.value,async M=>{await g()},{deep:!0});const g=async()=>{const M=await Vi.projects.where({id:p}).first();if(M){const D=Lc.cloneDeep(s.value);D.forEach(it=>{it.clips.forEach(at=>{at.thumbnail=null})}),await Vi.projects.update(M,{tracks:D})}},v=pt(null),w=M=>{var D;v.value=M,(D=T.value)==null||D.activeClip(M)},S=M=>{var D;(D=T.value)==null||D.addClip(M)},L=()=>{s.value=s.value.filter(M=>M.clips.length>0)},F=()=>{var M;(M=T.value)==null||M.refreshPlayer()},P=()=>{var M;(M=T.value)==null||M.handleExport()};return(M,D)=>(mt(),Ut("div",{class:"w-full h-full flex bg-[#1b1b1d] overflow-hidden",onClick:a},[N("div",EU,[et(P1)]),N("div",CU,[N("div",AU,[N("div",TU,[et(Qb,{ref_key:"playerRef",ref:T,currentTime:b.value,tracks:s.value,timelineDuration:Et(I),playerDuration:Et(B),onPrevFrame:e,onNextFrame:n,onTimeUpdate:G,onCaptureImage:t,onUpdateClipProps:f},null,8,["currentTime","tracks","timelineDuration","playerDuration"])]),N("div",IU,[et(UU,{clip:v.value},null,8,["clip"])])]),N("div",BU,[et(bS,{ref_key:"clipTrackRef",ref:U,tracks:s.value,"onUpdate:tracks":D[0]||(D[0]=it=>s.value=it),maxTracksNum:sh,currentTime:b.value,timelineDuration:Et(I),onTimeUpdate:G,onAddClip:S,onRefreshPlayer:F,onDeleteEmptyTrack:L,onActiveClip:w,onHandleExport:P},null,8,["tracks","currentTime","timelineDuration"])])])]))}});export{DU as default};
