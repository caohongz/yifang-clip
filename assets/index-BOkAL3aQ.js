var ew=Object.defineProperty;var xd=d=>{throw TypeError(d)};var iw=(d,l,u)=>l in d?ew(d,l,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[l]=u;var jl=(d,l,u)=>iw(d,typeof l!="symbol"?l+"":l,u),Kl=(d,l,u)=>l.has(d)||xd("Cannot "+u);var dt=(d,l,u)=>(Kl(d,l,"read from private field"),u?u.call(d):l.get(d)),An=(d,l,u)=>l.has(d)?xd("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(d):l.set(d,u),In=(d,l,u,h)=>(Kl(d,l,"write to private field"),h?h.call(d,u):l.set(d,u),u),Zn=(d,l,u)=>(Kl(d,l,"access private method"),u);import{m as Kd,q as nw,d as Re,s as bd,r as _t,x as ge,o as os,y as Zs,z as Mn,A as rw,i as Ct,c as yt,a as O,B as Mi,t as De,b as J,C as ei,D as zu,n as Ws,G as Zl,E as cr,H as sw,g as ct,f as $t,w as Xt,F as fi,e as gn,j as ti,I as oe,p as lu,J as aw,K as Pn,L as Bs,M as Zd,h as ow,N as Sd}from"./index-NKyLJqUA.js";import{t as lw,J as Fu,d as Ce,a as Jl,c as uw,_ as Ei,g as hw,y as Xs,b as fw}from"./_plugin-vue_export-helper-CrET3Vpg.js";var Jd={};(function(d){var l=function(){var t=new Date,e=4,n=3,o=2,f=1,g=e,v={setLogLevel:function(w){w==this.debug?g=f:w==this.info?g=o:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),f>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){o>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return v}();l.getDurationString=function(t,e){var n;function o(k,F){for(var P=""+k,M=P.split(".");M[0].length<F;)M[0]="0"+M[0];return M.join(".")}t<0?(n=!0,t=-t):n=!1;var f=e||1,g=t/f,v=Math.floor(g/3600);g-=v*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+v+":"+o(w,2)+":"+o(g,2)+"."+o(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",o=0;o<e;o++)o>0&&(n+=","),n+="["+l.getDurationString(t.start(o))+","+l.getDurationString(t.end(o))+"]";return n}else return"(empty)"},d.Log=l;var u=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};u.prototype.getPosition=function(){return this.position},u.prototype.getEndPosition=function(){return this.buffer.byteLength},u.prototype.getLength=function(){return this.buffer.byteLength},u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},u.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},u.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},u.prototype.readUint8=function(){return this.readAnyInt(1,!1)},u.prototype.readUint16=function(){return this.readAnyInt(2,!1)},u.prototype.readUint24=function(){return this.readAnyInt(3,!1)},u.prototype.readUint32=function(){return this.readAnyInt(4,!1)},u.prototype.readUint64=function(){return this.readAnyInt(8,!1)},u.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},u.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},u.prototype.readInt8=function(){return this.readAnyInt(1,!0)},u.prototype.readInt16=function(){return this.readAnyInt(2,!0)},u.prototype.readInt32=function(){return this.readAnyInt(4,!0)},u.prototype.readInt64=function(){return this.readAnyInt(8,!1)},u.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},u.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},u.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},u.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},u.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},d.MP4BoxStream=u;var h=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??h.LITTLE_ENDIAN};h.prototype={},h.prototype.getPosition=function(){return this.position},h.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var o=new ArrayBuffer(n),f=new Uint8Array(this._buffer),g=new Uint8Array(o,0,f.length);g.set(f),this.buffer=o,this._byteLength=e}},h.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},h.BIG_ENDIAN=!1,h.LITTLE_ENDIAN=!0,h.prototype._byteLength=0,Object.defineProperty(h.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(h.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},h.prototype.isEof=function(){return this.position>=this._byteLength},h.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},h.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},h.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},h.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},h.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},h.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,h.memcpy=function(t,e,n,o,f){var g=new Uint8Array(t,e,f),v=new Uint8Array(n,o,f);g.set(v)},h.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},h.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},h.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var o=n+t.BYTES_PER_ELEMENT-1,f=n;o>f;o--,f++){var g=e[f];e[f]=e[o],e[o]=g}return t},h.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},h.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},h.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),o=e;t!=null&&(o=Math.min(t,e));for(var f=0;f<o&&n[f]!==0;f++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(f)]);return t!=null?this.position+=o-f:f!=e&&(this.position+=1),g};var p=Math.pow(2,32);h.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},h.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},h.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},h.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},d.DataStream=h,h.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("href",n),o.setAttribute("download",t),o.setAttribute("target","_self"),o.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},h.prototype._dynamicSize=!0,Object.defineProperty(h.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),h.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),o=new Uint8Array(this._buffer,t,n.length);n.set(o),this.buffer=e,this.position-=t},h.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},h.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},h.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},h.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},h.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},h.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},h.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},h.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},h.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},h.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},h.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},h.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},h.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},h.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var o=0;o<t.length&&o<n;o++)this.writeUint16(t.charCodeAt(o),e);for(;o<n;o++)this.writeUint16(0)},h.prototype.writeString=function(t,e,n){var o=0;if(e==null||e=="ASCII")if(n!=null){var f=Math.min(t.length,n);for(o=0;o<f;o++)this.writeUint8(t.charCodeAt(o));for(;o<n;o++)this.writeUint8(0)}else for(o=0;o<t.length;o++)this.writeUint8(t.charCodeAt(o));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},h.prototype.writeCString=function(t,e){var n=0;if(e!=null){var o=Math.min(t.length,e);for(n=0;n<o;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},h.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var o=t[n+1];this.writeType(o,e[t[n]],e)}},h.prototype.writeType=function(t,e,n){var o;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var f=null,g="ASCII",v=this.position;switch(typeof t=="string"&&/:/.test(t)&&(o=t.split(":"),t=o[0],f=parseInt(o[1])),typeof t=="string"&&/,/.test(t)&&(o=t.split(","),t=o[0],g=parseInt(o[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,h.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,h.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,h.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,h.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,h.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,h.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,h.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,h.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,h.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,h.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,h.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,h.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,f);break;case"string":this.writeString(e,g,f);break;case"u16string":this.writeUCS2String(e,this.endianness,f);break;case"u16stringle":this.writeUCS2String(e,h.LITTLE_ENDIAN,f);break;case"u16stringbe":this.writeUCS2String(e,h.BIG_ENDIAN,f);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}f!=null&&(this.position=v,this._realloc(f),this.position=v+f)},h.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},h.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},h.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},h.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n},h.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*2,n},h.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n},h.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*2,n},h.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*8,n},h.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new h(new ArrayBuffer,0,h.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var o;return o=new Uint8Array(n),o.set(new Uint8Array(t,e,n)),o.buffer.fileStart=t.fileStart+e,o.buffer.usedBytes=0,o.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var o=this.buffers[n];if(t.fileStart<=o.fileStart){if(t.fileStart===o.fileStart)if(t.byteLength>o.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=o.fileStart||(t=this.reduceBuffer(t,0,o.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<o.fileStart+o.byteLength){var f=o.fileStart+o.byteLength-t.fileStart,g=t.byteLength-f;if(g>0)t=this.reduceBuffer(t,f,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,o,f,g=[],v,w="";for(o=0,f=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(v={},g.push(v),v.start=n.fileStart,v.end=n.fileStart+n.byteLength,w+="["+v.start+"-"):v.end===n.fileStart?v.end=n.fileStart+n.byteLength:(v={},v.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+v.start+"-",v.end=n.fileStart+n.byteLength,g.push(v)),o+=n.usedBytes,f+=n.byteLength;g.length>0&&(w+=v.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+o+"/"+f+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,o=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=o,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var o,f=null,g=-1;for(t===!0?o=0:o=this.bufferIndex;o<this.buffers.length&&(f=this.buffers[o],f.fileStart<=e);){g=o,n&&(f.fileStart+f.byteLength<=e?f.usedBytes=f.byteLength:f.usedBytes=e-f.fileStart,this.logBufferLevel());o++}return g!==-1?(f=this.buffers[g],f.fileStart+f.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,o,f=t!==void 0?t:this.bufferIndex;if(n=this.buffers[f],this.buffers.length>f+1)for(e=f+1;e<this.buffers.length&&(o=this.buffers[e],o.fileStart===n.fileStart+n.byteLength);e++)n=o;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var o;return o=this.findPosition(e,t,n),o!==-1?(this.buffer=this.buffers[o],this.bufferIndex=o,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},d.MultiBufferStream=_;var y=function(){var t=3,e=4,n=5,o=6,f=[];f[t]="ES_Descriptor",f[e]="DecoderConfigDescriptor",f[n]="DecoderSpecificInfo",f[o]="SLConfigDescriptor",this.getDescriptorName=function(w){return f[w]};var g=this,v={};return this.parseOneDescriptor=function(w){var S=0,k,F,P;for(k=w.readUint8(),P=w.readUint8();P&128;)S=(P&127)<<7,P=w.readUint8();return S+=P&127,l.debug("MPEG4DescriptorParser","Found "+(f[k]||"Descriptor "+k)+", size "+S+" at position "+w.getPosition()),f[k]?F=new v[f[k]](S):F=new v.Descriptor(S),F.parse(w),F},v.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},v.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},v.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},v.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var k=g.parseOneDescriptor(w);this.descs.push(k)}},v.ES_Descriptor=function(w){v.Descriptor.call(this,t,w)},v.ES_Descriptor.prototype=new v.Descriptor,v.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},v.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},v.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var k=S.findDescriptor(n);if(k&&k.data){var F=(k.data[0]&248)>>3;return F===31&&k.data.length>=2&&(F=32+((k.data[0]&7)<<3)+((k.data[1]&224)>>5)),F}else return null},v.DecoderConfigDescriptor=function(w){v.Descriptor.call(this,e,w)},v.DecoderConfigDescriptor.prototype=new v.Descriptor,v.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},v.DecoderSpecificInfo=function(w){v.Descriptor.call(this,n,w)},v.DecoderSpecificInfo.prototype=new v.Descriptor,v.SLConfigDescriptor=function(w){v.Descriptor.call(this,o,w)},v.SLConfigDescriptor.prototype=new v.Descriptor,this};d.MPEG4DescriptorParser=y;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,o){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=o},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(o){s.ContainerBox.call(this,t,o),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(o,f){s.SampleEntry.call(this,o,f),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,o){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(f){s[t+"SampleEntry"].call(this,e,f),s.addSubBoxArrays.call(this,o)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,o){s.UUIDs.push(t),s.UUIDBoxes[t]=function(f){e?s.FullBox.call(this,"uuid",f,t):n?s.ContainerBox.call(this,"uuid",f,t):s.Box.call(this,"uuid",f,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,o&&(e?s.UUIDBoxes[t].prototype.parse=function(f){this.parseFullHeader(f),o&&o.call(this,f)}:s.UUIDBoxes[t].prototype.parse=o)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},d.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var o=t.readUint8().toString(16);e+=o.length===1?"0"+o:o}return e},s.parseOneBox=function(t,e,n){var o,f=t.getPosition(),g=0,v,w;if(t.getEndPosition()-f<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),k=t.readString(4),F=k;if(l.debug("BoxParser","Found box of type '"+k+"' and size "+S+" at position "+f),g=8,k=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(f),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,F=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(f),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+k+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(k!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+k+"'"),o=new s.Box(k,S),{code:s.OK,box:o,size:o.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+k+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+k+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):S!==0&&f+S>t.getEndPosition()?(t.seek(f),l.info("BoxParser","Not enough data in stream to parse the entire '"+k+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):e?{code:s.OK,type:k,size:S,hdr_size:g,start:f}:(s[k+"Box"]?o=new s[k+"Box"](S):k!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+k+"'"),o=new s.Box(k,S),o.has_unparsed_data=!0):s.UUIDBoxes[w]?o=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),o=new s.Box(k,S),o.uuid=w,o.has_unparsed_data=!0),o.hdr_size=g,o.start=f,o.write===s.Box.prototype.write&&o.type!=="mdat"&&(l.info("BoxParser","'"+F+"' box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(t)),o.parse(t),v=t.getPosition()-(o.start+o.size),v<0?(l.warn("BoxParser","Parsing of box '"+F+"' did not read the entire indicated box data size (missing "+-v+" bytes), seeking forward"),t.seek(o.start+o.size)):v>0&&(l.error("BoxParser","Parsing of box '"+F+"' read "+v+" more bytes than the indicated box data size, seeking backwards"),o.size!==0&&t.seek(o.start+o.size)),{code:s.OK,box:o,size:o.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var o=n.type!=="uuid"?n.type:n.uuid;this[o]?l.warn("Box of type "+o+" already stored in field of this type"):this[o]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var o=0;o<3;o++)n==16?this.layer_size[o]=t.readUint16():this.layer_size[o]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var o=t.readInt32();o<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(o)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),o=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|o>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var o={};this.ind_subs.push(o);var f=t.readUint8(),g=t.readUint8(),v=t.readUint8();o.fscod=f>>6,o.bsid=f>>1&31,o.bsmod=(f&1)<<4|g>>4&15,o.acmod=g>>1&7,o.lfeon=g&1,o.num_dep_sub=v>>1&15,o.num_dep_sub>0&&(o.chan_loc=(v&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,o=[],f=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),v=Math.min(g&e,f.length-1);if(v?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),o.push(f[v]),g&n)break}while(!0);this.numMetadataBlocks=o.length+" ("+o.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var o=t.readUint32(),f=0;f<o;f++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.entries.push(o),this.version===1?(o.segment_duration=t.readUint64(),o.media_time=t.readInt64()):(o.segment_duration=t.readUint32(),o.media_time=t.readInt32()),o.media_rate_integer=t.readInt16(),o.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var o=n.readUint32();this.entity_ids.push(o)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof y<"u"){var n=new y;this.esd=n.parseOneDescriptor(new h(e.buffer,0,h.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,o,f;this.configurationVersion=t.readUint8(),f=t.readUint8(),this.general_profile_space=f>>6,this.general_tier_flag=(f&32)>>5,this.general_profile_idc=f&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),f=t.readUint8(),this.constantFrameRate=f>>6,this.numTemporalLayers=(f&13)>>3,this.temporalIdNested=(f&4)>>2,this.lengthSizeMinusOne=f&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var v=[];this.nalu_arrays.push(v),f=t.readUint8(),v.completeness=(f&128)>>7,v.nalu_type=f&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};v.push(S),o=t.readUint16(),S.data=t.readUint8Array(o)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var o=0;o<n;o++){var f={};if(this.items.push(f),this.version<2)f.item_ID=t.readUint16();else if(this.version===2)f.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?f.construction_method=t.readUint16()&15:f.construction_method=0,f.data_reference_index=t.readUint16(),this.base_offset_size){case 0:f.base_offset=0;break;case 4:f.base_offset=t.readUint32();break;case 8:f.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();f.extents=[];for(var v=0;v<g;v++){var w={};if(f.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var o={};this.associations.push(o),this.version<1?o.id=t.readUint16():o.id=t.readUint32();var f=t.readUint8();for(o.props=[],n=0;n<f;n++){var g=t.readUint8(),v={};o.props.push(v),v.essential=(g&128)>>7===1,this.flags&1?v.property_index=(g&127)<<8|t.readUint8():v.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var o={};this.levels[n]=o,o.track_ID=t.readUint32();var f=t.readUint8();switch(o.padding_flag=f>>7,o.assignment_type=f&127,o.assignment_type){case 0:o.grouping_type=t.readString(4);break;case 1:o.grouping_type=t.readString(4),o.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:o.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,o;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,o=t.readUint8(),this.numTemporalLayers=(o&13)>>3,this.temporalIdNested=(o&4)>>2,this.lengthSizeMinusOne=o&3,this.nalu_arrays=[];var f=t.readUint8();for(e=0;e<f;e++){var g=[];this.nalu_arrays.push(g),o=t.readUint8(),g.completeness=(o&128)>>7,g.nalu_type=o&63;var v=t.readUint16();for(n=0;n<v;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var o=t.readUint32();o>0&&(this.data=t.readUint8Array(o))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var o=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<o/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),o=0;o<n;o++){var f={};this.dependency.push(f),f.subSeqDirectionFlag=t.readUint8(),f.layerNumber=t.readUint8(),f.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.entries.push(o),o.sample_count=t.readInt32(),o.group_description_index=t.readInt32()}});function A(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}A.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var o=t.readUint32(),f=t.readUint32();this.bad_pixels.push(new A(o,f))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var o=0;o<n;o++)e=t.readUint8(),this.is_leading[o]=e>>6,this.sample_depends_on[o]=e>>4&3,this.sample_is_depended_on[o]=e>>2&3,this.sample_has_redundancy[o]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o;s[this.grouping_type+"SampleGroupEntry"]?o=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):o=new s.SampleGroupEntry(this.grouping_type),this.entries.push(o),this.version===1?this.default_length===0?o.description_length=t.readUint32():o.description_length=this.default_length:o.description_length=this.default_length,o.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),o.data=t.readUint8Array(o.description_length),t.position-=o.description_length),o.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var o={};this.references.push(o);var f=t.readUint32();o.reference_type=f>>31&1,o.referenced_size=f&2147483647,o.subsegment_duration=t.readUint32(),f=t.readUint32(),o.starts_with_SAP=f>>31&1,o.SAP_type=f>>28&7,o.SAP_delta_time=f&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.subsegments.push(o),o.ranges=[];for(var f=t.readUint32(),g=0;g<f;g++){var v={};o.ranges.push(v),v.level=t.readUint8(),v.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,o,f;for(this.entries=[],o=t.readUint32(),e=1;e<=o;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(f=new s[n.type+"SampleEntry"](n.size),f.hdr_size=n.hdr_size,f.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),f=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),f.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+f.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),f.parseDataAndRewind(t)),f.parse(t),this.entries.push(f);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,o;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),o=t.readInt32(),o<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),o=1),this.sample_deltas.push(o)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var o,f;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(o=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),o.code===s.OK)f=o.box,this.boxes.push(f),this[f.type]=f;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var o=t.readUint8();this.sample_sizes[e]=o>>4&15,this.sample_sizes[e+1]=o&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,o,f;for(o=t.readUint32(),this.entries=[],e=0;e<o;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],f=t.readUint16(),f>0)for(n=0;n<f;n++){var v={};g.subsamples.push(v),this.version==1?v.size=t.readUint32():v.size=t.readUint16(),v.priority=t.readUint8(),v.discardable=t.readUint8(),v.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),o=0;o<n;o++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},o=0,f=0;this.version===1?(o=t.readUint64(),f=t.readUint64()):(o=t.readUint32(),f=t.readUint32()),n.absolute_time=o,n.absolute_duration=f,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,o={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(D){this.held_bits=D.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(D){this.held_bits=D.readUint16(),this.num_held_bits=16},extract_bits:function(D){var et=this.held_bits>>this.num_held_bits-D&(1<<D)-1;return this.num_held_bits-=D,et}};if(o.stream_read_1_bytes(t),o.extract_bits(5),this.lengthSizeMinusOne=o.extract_bits(2),this.ptl_present_flag=o.extract_bits(1),this.ptl_present_flag){o.stream_read_2_bytes(t),this.ols_idx=o.extract_bits(9),this.num_sublayers=o.extract_bits(3),this.constant_frame_rate=o.extract_bits(2),this.chroma_format_idc=o.extract_bits(2),o.stream_read_1_bytes(t),this.bit_depth_minus8=o.extract_bits(3),o.extract_bits(5);{if(o.stream_read_2_bytes(t),o.extract_bits(2),this.num_bytes_constraint_info=o.extract_bits(6),this.general_profile_idc=o.extract_bits(7),this.general_tier_flag=o.extract_bits(1),this.general_level_idc=t.readUint8(),o.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=o.extract_bits(1),this.ptl_multilayer_enabled_flag=o.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var f=o.extract_bits(6);o.stream_read_1_bytes(t);var g=o.extract_bits(2);this.general_constraint_info[e]=f<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=o.extract_bits(6)}else o.extract_bits(6);if(this.num_sublayers>1){for(o.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var v=o.extract_bits(1);this.ptl_sublayer_present_mask|=v<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)o.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var k=t.readUint8();for(e=0;e<k;e++){var F=[];this.nalu_arrays.push(F),o.stream_read_1_bytes(t),F.completeness=o.extract_bits(1),o.extract_bits(2),F.nalu_type=o.extract_bits(5);var P=1;for(F.nalu_type!=S&&F.nalu_type!=w&&(P=t.readUint16()),n=0;n<P;n++){var M=t.readUint16();F.push({data:t.readUint8Array(M),length:M})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,o=0;for(t=0;t<32&&(o|=n&1,t!=31);t++)o<<=1,n>>=1;e+=s.decimalToHex(o,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var f=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||f)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,f=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var o=[],f=0;f|=this.vvcC.ptl_frame_only_constraint<<7,f|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)f|=this.vvcC.general_constraint_info[t]>>2&63,o.push(f),f&&(g=t),f=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var v="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|o[t],S+=8;S>=5;){var k=w>>S-5&31;n+=v[k],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=v[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,o;for(o=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[o].pts=t[o].dts+this.sample_offsets[e],o++},s.sttsBox.prototype.unpack=function(t){var e,n,o;for(o=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)o===0?t[o].dts=0:t[o].dts=t[o-1].dts+this.sample_deltas[e],o++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,o,f,g;for(f=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,o=0;o<this.samples_per_chunk[e];o++){if(t[f])t[f].description_index=this.sample_description_index[e],t[f].chunk_index=g;else return;f++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var o=s.DIFF_BOXES_PROP_NAMES[n];if(t[o]&&e[o]&&!s.boxEqual(t[o],e[o]))return!1}return!0};var B=function(){};B.prototype.parseSample=function(t){var e={},n;e.resources=[];var o=new u(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=o.readString(t.data.length);else if(e.documentString=o.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=o.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var I=function(){};I.prototype.parseSample=function(t){var e,n=new u(t.data.buffer);return e=n.readString(t.data.length),e},I.prototype.parseConfig=function(t){var e,n=new u(t.buffer);return n.readUint32(),e=n.readCString(),e},d.XMLSubtitlein4Parser=B,d.Textin4Parser=I;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var o=this.getTrackById(t);if(o){var f={};this.fragmentedTracks.push(f),f.id=t,f.user=e,f.trak=o,o.nextSample=0,f.segmentStream=null,f.nb_samples=1e3,f.rapAlignement=!0,n&&(n.nbSamples&&(f.nb_samples=n.nbSamples),n.rapAlignement&&(f.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var o=this.fragmentedTracks[n];o.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var o=this.getTrackById(t);if(o){var f={};this.extractedTracks.push(f),f.id=t,f.user=e,f.trak=o,o.nextSample=0,f.nb_samples=1e3,f.samples=[],n&&n.nbSamples&&(f.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var o=this.extractedTracks[n];o.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var o;switch(e=t.box,o=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),o){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[o]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+o+", overriding previous occurrence"),this[o]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},o,f,g,v,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(o=this.moov.traks[t],v=o.mdia.minf.stbl.stsd.entries[0],f={},n.tracks.push(f),f.id=o.tkhd.track_id,f.name=o.mdia.hdlr.name,f.references=[],o.tref)for(e=0;e<o.tref.boxes.length;e++)g={},f.references.push(g),g.type=o.tref.boxes[e].type,g.track_ids=o.tref.boxes[e].track_ids;o.edts&&(f.edits=o.edts.elst.entries),f.created=new Date(w+o.tkhd.creation_time*1e3),f.modified=new Date(w+o.tkhd.modification_time*1e3),f.movie_duration=o.tkhd.duration,f.movie_timescale=n.timescale,f.layer=o.tkhd.layer,f.alternate_group=o.tkhd.alternate_group,f.volume=o.tkhd.volume,f.matrix=o.tkhd.matrix,f.track_width=o.tkhd.width/65536,f.track_height=o.tkhd.height/65536,f.timescale=o.mdia.mdhd.timescale,f.cts_shift=o.mdia.minf.stbl.cslg,f.duration=o.mdia.mdhd.duration,f.samples_duration=o.samples_duration,f.codec=v.getCodec(),f.kind=o.udta&&o.udta.kinds.length?o.udta.kinds[0]:{schemeURI:"",value:""},f.language=o.mdia.elng?o.mdia.elng.extended_language:o.mdia.mdhd.languageString,f.nb_samples=o.samples.length,f.size=o.samples_size,f.bitrate=f.size*8*f.timescale/f.samples_duration,v.isAudio()?(f.type="audio",n.audioTracks.push(f),f.audio={},f.audio.sample_rate=v.getSampleRate(),f.audio.channel_count=v.getChannelCount(),f.audio.sample_size=v.getSampleSize()):v.isVideo()?(f.type="video",n.videoTracks.push(f),f.video={},f.video.width=v.getWidth(),f.video.height=v.getHeight()):v.isSubtitle()?(f.type="subtitles",n.subtitleTracks.push(f)):v.isHint()?(f.type="metadata",n.hintTracks.push(f)):v.isMetadata()?(f.type="metadata",n.metadataTracks.push(f)):(f.type="metadata",n.otherTracks.push(f))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var o=this.fragmentedTracks[e];for(n=o.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+o.id+" for sample "+n.nextSample);var f=this.createFragment(o.id,n.nextSample,o.segmentStream);if(f)o.segmentStream=f,n.nextSample++;else break;if((n.nextSample%o.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+o.id+" for samples ["+Math.max(0,n.nextSample-o.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(o.id,o.user,o.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),o.segmentStream=null,o!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var v=this.getSample(n,n.nextSample);if(v)n.nextSample++,g.samples.push(v);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var o in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[o],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),o=this.getSample(n,e);return o},U.prototype.releaseUsedSamples=function(t,e){var n=0,o=this.getTrackById(t);o.lastValidSample||(o.lastValidSample=0);for(var f=o.lastValidSample;f<e;f++)n+=this.releaseSample(o,f);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),o.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var o,f,g=1/0,v=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(o=0;o<n.samples.length;o++){if(f=n.samples[o],o===0)w=0,S=f.timescale;else if(f.cts>t*f.timescale){w=o-1;break}e&&f.is_sync&&(v=o)}for(e&&(w=v),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,o,f,g,v={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)o=n.traks[g],!(t>this.getTrackDuration(o))&&(f=this.seekTrack(t,e,o),f.offset<v.offset&&(v.offset=f.offset),f.time<v.time&&(v.time=f.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(v.time,1)+" needs a buffer with a fileStart position of "+v.offset),v.offset===1/0?v={offset:this.nextParsePosition,time:0}:v.offset=this.stream.getEndFilePositionAfter(v.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+v.offset),v}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],o=t.boxes[e];if(!s.boxEqual(n,o))return!1;e++}return!0},d.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,o;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,o=this.stream.seek(e.start+e.size,!1,this.discardMdatData),o?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var o=n.add("mdia");o.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),o.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),o.add("elng").set("extended_language",e.language||"fr-FR");var f=o.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var v="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],k=0;k<S.length;k++)if(S.indexOf(e.type)>-1){v=w;break}switch(v){case"Visual":if(f.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var F=new s.avcCBox;F.parse(new u(e.avcDecoderConfigRecord)),g.addBox(F)}else if(e.hevcDecoderConfigRecord){var P=new s.hvcCBox;P.parse(new u(e.hevcDecoderConfigRecord)),g.addBox(P)}break;case"Audio":f.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":f.add("hmhd");break;case"Subtitle":switch(f.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":f.add("nmhd");break;case"System":f.add("nmhd");break;default:f.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(D){g.addBox(D)}),f.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var M=f.add("stbl");return M.add("stsd").addEntry(g),M.add("stts").set("sample_counts",[]).set("sample_deltas",[]),M.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),M.add("stco").set("chunk_offsets",[]),M.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new h;e.endianness=h.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var o=n||{},f={},g=this.getTrackById(t);if(g!==null){f.number=g.samples.length,f.track_id=g.tkhd.track_id,f.timescale=g.mdia.mdhd.timescale,f.description_index=o.sample_description_index?o.sample_description_index-1:0,f.description=g.mdia.minf.stbl.stsd.entries[f.description_index],f.data=e,f.size=e.byteLength,f.alreadyRead=f.size,f.duration=o.duration||1,f.cts=o.cts||0,f.dts=o.dts||0,f.is_sync=o.is_sync||!1,f.is_leading=o.is_leading||0,f.depends_on=o.depends_on||0,f.is_depended_on=o.is_depended_on||0,f.has_redundancy=o.has_redundancy||0,f.degradation_priority=o.degradation_priority||0,f.offset=0,f.subsamples=o.subsamples,g.samples.push(f),g.samples_size+=f.size,g.samples_duration+=f.duration,g.first_dts===void 0&&(g.first_dts=o.dts),this.processSamples();var v=this.createSingleSampleMoof(f);return this.addBox(v),v.computeSize(),v.trafs[0].truns[0].data_offset=v.size+8,this.add("mdat").data=new Uint8Array(e),f}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var o=n.add("traf"),f=this.getTrackById(t.track_id);return o.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),o.add("tfdt").set("baseMediaDecodeTime",t.dts-(f.first_dts||0)),o.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,o,f,g,v,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],o=e.mdia.minf.stbl.stsc,o.first_chunk=[],o.samples_per_chunk=[],o.sample_description_index=[],f=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,f.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],v=e.mdia.minf.stbl.ctts,v&&(v.sample_counts=[],v.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,o,f){var g,v,w,S;function k(F,P,M){this.grouping_type=F,this.grouping_type_parameter=P,this.sbgp=M,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),v=0;v<n.length;v++){for(S=n[v].grouping_type+"/"+n[v].grouping_type_parameter,w=new k(n[v].grouping_type,n[v].grouping_type_parameter,n[v]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<o.length;g++)o[g].grouping_type===n[v].grouping_type&&(w.description=o[g],w.description.used=!0);if(f)for(g=0;g<f.length;g++)f[g].grouping_type===n[v].grouping_type&&(w.fragment_description=f[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(f)for(v=0;v<f.length;v++)!f[v].used&&f[v].version>=2&&(S=f[v].grouping_type+"/0",w=new k(f[v].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(v=0;v<o.length;v++)!o[v].used&&o[v].version>=2&&(S=o[v].grouping_type+"/0",w=new k(o[v].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,o){var f,g;e.sample_groups=[];for(f in o)if(e.sample_groups[f]={},e.sample_groups[f].grouping_type=o[f].grouping_type,e.sample_groups[f].grouping_type_parameter=o[f].grouping_type_parameter,n>=o[f].last_sample_in_run&&(o[f].last_sample_in_run<0&&(o[f].last_sample_in_run=0),o[f].entry_index++,o[f].entry_index<=o[f].sbgp.entries.length-1&&(o[f].last_sample_in_run+=o[f].sbgp.entries[o[f].entry_index].sample_count)),o[f].entry_index<=o[f].sbgp.entries.length-1?e.sample_groups[f].group_description_index=o[f].sbgp.entries[o[f].entry_index].group_description_index:e.sample_groups[f].group_description_index=-1,e.sample_groups[f].group_description_index!==0){var v;o[f].fragment_description?v=o[f].fragment_description:v=o[f].description,e.sample_groups[f].group_description_index>0?(e.sample_groups[f].group_description_index>65535?g=(e.sample_groups[f].group_description_index>>16)-1:g=e.sample_groups[f].group_description_index-1,v&&g>=0&&(e.sample_groups[f].description=v.entries[g])):v&&v.version>=2&&v.default_group_description_index>0&&(e.sample_groups[f].description=v.entries[v.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,o,f,g,v,w,S,k,F,P,M,D,et,at,Ft,lt,Tt,Bt,Ht,it,ee,H,Q;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,o=t.mdia.minf.stbl.stsc,f=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,v=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,k=t.mdia.minf.stbl.subs,M=t.mdia.minf.stbl.stdp,F=t.mdia.minf.stbl.sbgps,P=t.mdia.minf.stbl.sgpds,Tt=-1,Bt=-1,Ht=-1,it=-1,ee=0,H=0,Q=0,U.initSampleGroups(t,null,F,P),!(typeof f>"u")){for(e=0;e<f.sample_sizes.length;e++){var Y={};Y.number=e,Y.track_id=t.tkhd.track_id,Y.timescale=t.mdia.mdhd.timescale,Y.alreadyRead=0,t.samples[e]=Y,Y.size=f.sample_sizes[e],t.samples_size+=Y.size,e===0?(et=1,D=0,Y.chunk_index=et,Y.chunk_run_index=D,lt=o.samples_per_chunk[D],Ft=0,D+1<o.first_chunk.length?at=o.first_chunk[D+1]-1:at=1/0):e<lt?(Y.chunk_index=et,Y.chunk_run_index=D):(et++,Y.chunk_index=et,Ft=0,et<=at||(D++,D+1<o.first_chunk.length?at=o.first_chunk[D+1]-1:at=1/0),Y.chunk_run_index=D,lt+=o.samples_per_chunk[D]),Y.description_index=o.sample_description_index[Y.chunk_run_index]-1,Y.description=S.entries[Y.description_index],Y.offset=n.chunk_offsets[Y.chunk_index-1]+Ft,Ft+=Y.size,e>Tt&&(Bt++,Tt<0&&(Tt=0),Tt+=g.sample_counts[Bt]),e>0?(t.samples[e-1].duration=g.sample_deltas[Bt],t.samples_duration+=t.samples[e-1].duration,Y.dts=t.samples[e-1].dts+t.samples[e-1].duration):Y.dts=0,v?(e>=Ht&&(it++,Ht<0&&(Ht=0),Ht+=v.sample_counts[it]),Y.cts=t.samples[e].dts+v.sample_offsets[it]):Y.cts=Y.dts,w?(e==w.sample_numbers[ee]-1?(Y.is_sync=!0,ee++):(Y.is_sync=!1,Y.degradation_priority=0),k&&k.entries[H].sample_delta+Q==e+1&&(Y.subsamples=k.entries[H].subsamples,Q+=k.entries[H].sample_delta,H++)):Y.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,Y,Y.number),M?Y.degradation_priority=M.priority[e]:Y.degradation_priority=0,k&&k.entries[H].sample_delta+Q==e&&(Y.subsamples=k.entries[H].subsamples,Q+=k.entries[H].sample_delta),(F.length>0||P.length>0)&&U.setSampleGroupProperties(t,Y,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,o,f,g,v,w,S,k,F,P,M,D,et;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(k=S,t=0;t<k.trafs.length;t++){for(F=k.trafs[t],P=this.getTrackById(F.tfhd.track_id),M=this.getTrexById(F.tfhd.track_id),F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?o=F.tfhd.default_sample_description_index:o=M?M.default_sample_description_index:1,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?f=F.tfhd.default_sample_duration:f=M?M.default_sample_duration:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=F.tfhd.default_sample_size:g=M?M.default_sample_size:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?v=F.tfhd.default_sample_flags:v=M?M.default_sample_flags:0,F.sample_number=0,F.sbgps.length>0&&U.initSampleGroups(P,F,F.sbgps,P.mdia.minf.stbl.sgpds,F.sgpds),e=0;e<F.truns.length;e++){var at=F.truns[e];for(n=0;n<at.sample_count;n++){D={},D.moof_number=this.lastMoofIndex,D.number_in_traf=F.sample_number,F.sample_number++,D.number=P.samples.length,F.first_sample_index=P.samples.length,P.samples.push(D),D.track_id=P.tkhd.track_id,D.timescale=P.mdia.mdhd.timescale,D.description_index=o-1,D.description=P.mdia.minf.stbl.stsd.entries[D.description_index],D.size=g,at.flags&s.TRUN_FLAGS_SIZE&&(D.size=at.sample_size[n]),P.samples_size+=D.size,D.duration=f,at.flags&s.TRUN_FLAGS_DURATION&&(D.duration=at.sample_duration[n]),P.samples_duration+=D.duration,P.first_traf_merged||n>0?D.dts=P.samples[P.samples.length-2].dts+P.samples[P.samples.length-2].duration:(F.tfdt?D.dts=F.tfdt.baseMediaDecodeTime:D.dts=0,P.first_traf_merged=!0),D.cts=D.dts,at.flags&s.TRUN_FLAGS_CTS_OFFSET&&(D.cts=D.dts+at.sample_composition_time_offset[n]),et=v,at.flags&s.TRUN_FLAGS_FLAGS?et=at.sample_flags[n]:n===0&&at.flags&s.TRUN_FLAGS_FIRST_FLAG&&(et=at.first_sample_flags),D.is_sync=!(et>>16&1),D.is_leading=et>>26&3,D.depends_on=et>>24&3,D.is_depended_on=et>>22&3,D.has_redundancy=et>>20&3,D.degradation_priority=et&65535;var Ft=!!(F.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),lt=!!(F.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Tt=!!(at.flags&s.TRUN_FLAGS_DATA_OFFSET),Bt=0;Ft?Bt=F.tfhd.base_data_offset:lt||e===0?Bt=k.start:Bt=w,e===0&&n===0?Tt?D.offset=Bt+at.data_offset:D.offset=Bt:D.offset=w,w=D.offset+D.size,(F.sbgps.length>0||F.sgpds.length>0||P.mdia.minf.stbl.sbgps.length>0||P.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(P,D,D.number_in_traf,F.sample_groups_info)}}if(F.subs){P.has_fragment_subsamples=!0;var Ht=F.first_sample_index;for(e=0;e<F.subs.entries.length;e++)Ht+=F.subs.entries[e].sample_delta,D=P.samples[Ht-1],D.subsamples=F.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,o=t.samples[e];if(!this.moov)return null;if(!o.data)o.data=new Uint8Array(o.size),o.alreadyRead=0,this.samplesDataSize+=o.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+o.size+" (total: "+this.samplesDataSize+")");else if(o.alreadyRead==o.size)return o;for(;;){var f=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(f>-1){n=this.stream.buffers[f];var g=n.byteLength-(o.offset+o.alreadyRead-n.fileStart);if(o.size-o.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-n.fileStart)+" read size: "+(o.size-o.alreadyRead)+" full size: "+o.size+")"),h.memcpy(o.data.buffer,o.alreadyRead,n,o.offset+o.alreadyRead-n.fileStart,o.size-o.alreadyRead),n.usedBytes+=o.size-o.alreadyRead,this.stream.logBufferLevel(),o.alreadyRead=o.size,o;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+o.size+")"),h.memcpy(o.data.buffer,o.alreadyRead,n,o.offset+o.alreadyRead-n.fileStart,g),o.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,o,f,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)f={},f.id=g.iinf.item_infos[n].item_ID,t[f.id]=f,f.ref_to=[],f.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(f.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?f.type=g.iinf.item_infos[n].item_type:f.type="mime",f.content_type=g.iinf.item_infos[n].content_type,f.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var v=g.iloc.items[n];switch(f=t[v.item_ID],v.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),f.source=g.dinf.boxes[v.data_reference_index-1]),v.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(f.extents=[],f.size=0,o=0;o<v.extents.length;o++)f.extents[o]={},f.extents[o].offset=v.extents[o].extent_offset+v.base_offset,f.extents[o].length=v.extents[o].extent_length,f.extents[o].alreadyRead=0,f.size+=f.extents[o].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(o=0;o<w.references.length;o++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[o]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var k=g.iprp.ipmas[S];for(n=0;n<k.associations.length;n++){var F=k.associations[n];if(f=t[F.id],f||(f=e[F.id]),f)for(f.properties===void 0&&(f.properties={},f.properties.boxes=[]),o=0;o<F.props.length;o++){var P=F.props[o];if(P.property_index>0&&P.property_index-1<g.iprp.ipco.boxes.length){var M=g.iprp.ipco.boxes[P.property_index-1];f.properties[M.type]=M,f.properties.boxes.push(M)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var o=0;o<n.extents.length;o++){var f=n.extents[o];if(f.alreadyRead!==f.length){var g=this.stream.findPosition(!0,f.offset+f.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var v=e.byteLength-(f.offset+f.alreadyRead-e.fileStart);if(f.length-f.alreadyRead<=v)l.debug("ISOFile","Getting item #"+t+" extent #"+o+" data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+(f.length-f.alreadyRead)+" full extent size: "+f.length+" full item size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,f.length-f.alreadyRead),e.usedBytes+=f.length-f.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=f.length-f.alreadyRead,f.alreadyRead=f.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+o+" partial data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+v+" full extent size: "+f.length+" full item size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,v),f.alreadyRead+=v,n.alreadyRead+=v,e.usedBytes+=v,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var o=e.extents[n];o.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var o=new U;o.discardMdatData=!1;var f={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(f.width=n.properties.ispe.image_width,f.height=n.properties.ispe.image_height);var g=o.addTrack(f);return g?(o.addSample(g,n.data),o):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var o=this.getTrackById(t),f=this.getSample(o,e);if(f==null)return this.setNextSeekPositionFromSample(o.samples[e]),null;var g=n||new h;g.endianness=h.BIG_ENDIAN;var v=this.createSingleSampleMoof(f);v.write(g),v.trafs[0].truns[0].data_offset=v.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+v.trafs[0].truns[0].data_offset),g.adjustUint32(v.trafs[0].truns[0].data_offset_position,v.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=f.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,o){var f;l.debug("ISOFile","Generating initialization segment");var g=new h;g.endianness=h.BIG_ENDIAN,t.write(g);var v=e.add("mvex");for(n&&v.add("mehd").set("fragment_duration",n),f=0;f<e.traks.length;f++)v.add("trex").set("track_id",e.traks[f].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",o).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new h;e.endianness=h.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,o;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var f=new s.moovBox;f.mvhd=this.moov.mvhd,f.boxes.push(f.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),f.boxes.push(n),f.traks.push(n),o={},o.id=n.tkhd.track_id,o.user=this.fragmentedTracks[t].user,o.buffer=U.writeInitializationSegment(this.ftyp,f,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(o)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var G={};G.createFile=function(t,e){var n=t!==void 0?t:!0,o=new U(e);return o.discardMdatData=!n,o},d.createFile=G.createFile})(Jd);const uu=Kd(Jd);var Qd={};(function(d){var l=function(){var t=new Date,e=4,n=3,o=2,f=1,g=e,v={setLogLevel:function(w){w==this.debug?g=f:w==this.info?g=o:w==this.warn?g=n:(w==this.error,g=e)},debug:function(w,S){console.debug===void 0&&(console.debug=console.log),f>=g&&console.debug("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},log:function(w,S){this.debug(w.msg)},info:function(w,S){o>=g&&console.info("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},warn:function(w,S){n>=g&&console.warn("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)},error:function(w,S){e>=g&&console.error("["+l.getDurationString(new Date-t,1e3)+"]","["+w+"]",S)}};return v}();l.getDurationString=function(t,e){var n;function o(k,F){for(var P=""+k,M=P.split(".");M[0].length<F;)M[0]="0"+M[0];return M.join(".")}t<0?(n=!0,t=-t):n=!1;var f=e||1,g=t/f,v=Math.floor(g/3600);g-=v*3600;var w=Math.floor(g/60);g-=w*60;var S=g*1e3;return g=Math.floor(g),S-=g*1e3,S=Math.floor(S),(n?"-":"")+v+":"+o(w,2)+":"+o(g,2)+"."+o(S,3)},l.printRanges=function(t){var e=t.length;if(e>0){for(var n="",o=0;o<e;o++)o>0&&(n+=","),n+="["+l.getDurationString(t.start(o))+","+l.getDurationString(t.end(o))+"]";return n}else return"(empty)"},d.Log=l;var u=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};u.prototype.getPosition=function(){return this.position},u.prototype.getEndPosition=function(){return this.buffer.byteLength},u.prototype.getLength=function(){return this.buffer.byteLength},u.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},u.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},u.prototype.readAnyInt=function(t,e){var n=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?n=this.dataview.getInt8(this.position):n=this.dataview.getUint8(this.position);break;case 2:e?n=this.dataview.getInt16(this.position):n=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";n=this.dataview.getUint8(this.position)<<16,n|=this.dataview.getUint8(this.position+1)<<8,n|=this.dataview.getUint8(this.position+2);break;case 4:e?n=this.dataview.getInt32(this.position):n=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";n=this.dataview.getUint32(this.position)<<32,n|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,n}else throw"Not enough bytes in buffer"},u.prototype.readUint8=function(){return this.readAnyInt(1,!1)},u.prototype.readUint16=function(){return this.readAnyInt(2,!1)},u.prototype.readUint24=function(){return this.readAnyInt(3,!1)},u.prototype.readUint32=function(){return this.readAnyInt(4,!1)},u.prototype.readUint64=function(){return this.readAnyInt(8,!1)},u.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",n=0;n<t;n++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},u.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},u.prototype.readInt8=function(){return this.readAnyInt(1,!0)},u.prototype.readInt16=function(){return this.readAnyInt(2,!0)},u.prototype.readInt32=function(){return this.readAnyInt(4,!0)},u.prototype.readInt64=function(){return this.readAnyInt(8,!1)},u.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),n=0;n<t;n++)e[n]=this.readUint8();return e},u.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readInt16();return e},u.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),n=0;n<t;n++)e[n]=this.readUint16();return e},u.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),n=0;n<t;n++)e[n]=this.readUint32();return e},u.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),n=0;n<t;n++)e[n]=this.readInt32();return e},d.MP4BoxStream=u;var h=function(t,e,n){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=n??h.LITTLE_ENDIAN};h.prototype={},h.prototype.getPosition=function(){return this.position},h.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,n=this._buffer.byteLength;if(e<=n){e>this._byteLength&&(this._byteLength=e);return}for(n<1&&(n=1);e>n;)n*=2;var o=new ArrayBuffer(n),f=new Uint8Array(this._buffer),g=new Uint8Array(o,0,f.length);g.set(f),this.buffer=o,this._byteLength=e}},h.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),n=new Uint8Array(this._buffer,0,e.length);e.set(n),this.buffer=t}},h.BIG_ENDIAN=!1,h.LITTLE_ENDIAN=!0,h.prototype._byteLength=0,Object.defineProperty(h.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(h.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},h.prototype.isEof=function(){return this.position>=this._byteLength},h.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Int32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Int16Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Uint32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var n=new Uint16Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var n=new Float64Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var n=new Float32Array(t);return h.memcpy(n.buffer,0,this.buffer,this.byteOffset+this.position,t*n.BYTES_PER_ELEMENT),h.arrayToNative(n,e??this.endianness),this.position+=n.byteLength,n},h.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},h.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},h.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},h.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},h.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},h.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},h.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,h.memcpy=function(t,e,n,o,f){var g=new Uint8Array(t,e,f),v=new Uint8Array(n,o,f);g.set(v)},h.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},h.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},h.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=0;n<t.byteLength;n+=t.BYTES_PER_ELEMENT)for(var o=n+t.BYTES_PER_ELEMENT-1,f=n;o>f;o--,f++){var g=e[f];e[f]=e[o],e[o]=g}return t},h.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return String.fromCharCode.apply(null,e)},h.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},h.prototype.readCString=function(t){var e=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),o=e;t!=null&&(o=Math.min(t,e));for(var f=0;f<o&&n[f]!==0;f++);var g=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(f)]);return t!=null?this.position+=o-f:f!=e&&(this.position+=1),g};var p=Math.pow(2,32);h.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},h.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},h.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},h.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},d.DataStream=h,h.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var n=window.URL.createObjectURL(e),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("href",n),o.setAttribute("download",t),o.setAttribute("target","_self"),o.click(),window.URL.revokeObjectURL(n)}else throw"DataStream.save: Can't create object URL."},h.prototype._dynamicSize=!0,Object.defineProperty(h.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),h.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),n=new Uint8Array(e),o=new Uint8Array(this._buffer,t,n.length);n.set(o),this.buffer=e,this.position-=t},h.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt32(t[n],e)},h.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeInt16(t[n],e)},h.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},h.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint32(t[n],e)},h.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeUint16(t[n],e)},h.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},h.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat64(t[n],e)},h.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var n=0;n<t.length;n++)this.writeFloat32(t[n],e)},h.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},h.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},h.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},h.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},h.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},h.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},h.prototype.writeUCS2String=function(t,e,n){n==null&&(n=t.length);for(var o=0;o<t.length&&o<n;o++)this.writeUint16(t.charCodeAt(o),e);for(;o<n;o++)this.writeUint16(0)},h.prototype.writeString=function(t,e,n){var o=0;if(e==null||e=="ASCII")if(n!=null){var f=Math.min(t.length,n);for(o=0;o<f;o++)this.writeUint8(t.charCodeAt(o));for(;o<n;o++)this.writeUint8(0)}else for(o=0;o<t.length;o++)this.writeUint8(t.charCodeAt(o));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,n)))},h.prototype.writeCString=function(t,e){var n=0;if(e!=null){var o=Math.min(t.length,e);for(n=0;n<o;n++)this.writeUint8(t.charCodeAt(n));for(;n<e;n++)this.writeUint8(0)}else{for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}},h.prototype.writeStruct=function(t,e){for(var n=0;n<t.length;n+=2){var o=t[n+1];this.writeType(o,e[t[n]],e)}},h.prototype.writeType=function(t,e,n){var o;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,n);var f=null,g="ASCII",v=this.position;switch(typeof t=="string"&&/:/.test(t)&&(o=t.split(":"),t=o[0],f=parseInt(o[1])),typeof t=="string"&&/,/.test(t)&&(o=t.split(","),t=o[0],g=parseInt(o[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,h.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,h.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,h.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,h.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,h.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,h.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,h.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,h.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,h.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,h.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,h.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,h.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,f);break;case"string":this.writeString(e,g,f);break;case"u16string":this.writeUCS2String(e,this.endianness,f);break;case"u16stringle":this.writeUCS2String(e,h.LITTLE_ENDIAN,f);break;case"u16stringbe":this.writeUCS2String(e,h.BIG_ENDIAN,f);break;default:if(t.length==3){for(var w=t[1],S=0;S<e.length;S++)this.writeType(w,e[S]);break}else{this.writeStruct(t,e);break}}f!=null&&(this.position=v,this._realloc(f),this.position=v+f)},h.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},h.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},h.prototype.adjustUint32=function(t,e){var n=this.position;this.seek(t),this.writeUint32(e),this.seek(n)},h.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var n=new Int32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n},h.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var n=new Int16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*2,n},h.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var n=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n},h.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var n=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*2,n},h.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var n=new Float64Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*8,n},h.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var n=new Float32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(n,e??this.endianness),this.position+=t*4,n};var _=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};_.prototype=new h(new ArrayBuffer,0,h.BIG_ENDIAN),_.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,l.debug("MultiBufferStream","Stream ready for parsing"),!0):(l.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(l.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){l.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},_.prototype.reduceBuffer=function(t,e,n){var o;return o=new Uint8Array(n),o.set(new Uint8Array(t,e,n)),o.buffer.fileStart=t.fileStart+e,o.buffer.usedBytes=0,o.buffer},_.prototype.insertBuffer=function(t){for(var e=!0,n=0;n<this.buffers.length;n++){var o=this.buffers[n];if(t.fileStart<=o.fileStart){if(t.fileStart===o.fileStart)if(t.byteLength>o.byteLength){this.buffers.splice(n,1),n--;continue}else l.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=o.fileStart||(t=this.reduceBuffer(t,0,o.fileStart-t.fileStart)),l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(n,0,t),n===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<o.fileStart+o.byteLength){var f=o.fileStart+o.byteLength-t.fileStart,g=t.byteLength-f;if(g>0)t=this.reduceBuffer(t,f,g);else{e=!1;break}}}e&&(l.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),n===0&&(this.buffer=t))},_.prototype.logBufferLevel=function(t){var e,n,o,f,g=[],v,w="";for(o=0,f=0,e=0;e<this.buffers.length;e++)n=this.buffers[e],e===0?(v={},g.push(v),v.start=n.fileStart,v.end=n.fileStart+n.byteLength,w+="["+v.start+"-"):v.end===n.fileStart?v.end=n.fileStart+n.byteLength:(v={},v.start=n.fileStart,w+=g[g.length-1].end-1+"], ["+v.start+"-",v.end=n.fileStart+n.byteLength,g.push(v)),o+=n.usedBytes,f+=n.byteLength;g.length>0&&(w+=v.end-1+"]");var S=t?l.info:l.debug;this.buffers.length===0?S("MultiBufferStream","No more buffer in memory"):S("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+o+"/"+f+" bytes), continuous ranges: "+w)},_.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(l.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},_.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,n=this.buffer.usedBytes,o=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=n,this.buffer.fileStart=o,l.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},_.prototype.findPosition=function(t,e,n){var o,f=null,g=-1;for(t===!0?o=0:o=this.bufferIndex;o<this.buffers.length&&(f=this.buffers[o],f.fileStart<=e);){g=o,n&&(f.fileStart+f.byteLength<=e?f.usedBytes=f.byteLength:f.usedBytes=e-f.fileStart,this.logBufferLevel());o++}return g!==-1?(f=this.buffers[g],f.fileStart+f.byteLength>=e?(l.debug("MultiBufferStream","Found position in existing buffer #"+g),g):-1):-1},_.prototype.findEndContiguousBuf=function(t){var e,n,o,f=t!==void 0?t:this.bufferIndex;if(n=this.buffers[f],this.buffers.length>f+1)for(e=f+1;e<this.buffers.length&&(o=this.buffers[e],o.fileStart===n.fileStart+n.byteLength);e++)n=o;return n.fileStart+n.byteLength},_.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},_.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},_.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},_.prototype.seek=function(t,e,n){var o;return o=this.findPosition(e,t,n),o!==-1?(this.buffer=this.buffers[o],this.bufferIndex=o,this.position=t-this.buffer.fileStart,l.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(l.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},_.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},_.prototype.getLength=function(){return this.byteLength},_.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},d.MultiBufferStream=_;var y=function(){var t=3,e=4,n=5,o=6,f=[];f[t]="ES_Descriptor",f[e]="DecoderConfigDescriptor",f[n]="DecoderSpecificInfo",f[o]="SLConfigDescriptor",this.getDescriptorName=function(w){return f[w]};var g=this,v={};return this.parseOneDescriptor=function(w){var S=0,k,F,P;for(k=w.readUint8(),P=w.readUint8();P&128;)S=(P&127)<<7,P=w.readUint8();return S+=P&127,l.debug("MPEG4DescriptorParser","Found "+(f[k]||"Descriptor "+k)+", size "+S+" at position "+w.getPosition()),f[k]?F=new v[f[k]](S):F=new v.Descriptor(S),F.parse(w),F},v.Descriptor=function(w,S){this.tag=w,this.size=S,this.descs=[]},v.Descriptor.prototype.parse=function(w){this.data=w.readUint8Array(this.size)},v.Descriptor.prototype.findDescriptor=function(w){for(var S=0;S<this.descs.length;S++)if(this.descs[S].tag==w)return this.descs[S];return null},v.Descriptor.prototype.parseRemainingDescriptors=function(w){for(var S=w.position;w.position<S+this.size;){var k=g.parseOneDescriptor(w);this.descs.push(k)}},v.ES_Descriptor=function(w){v.Descriptor.call(this,t,w)},v.ES_Descriptor.prototype=new v.Descriptor,v.ES_Descriptor.prototype.parse=function(w){if(this.ES_ID=w.readUint16(),this.flags=w.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=w.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var S=w.readUint8();this.URL=w.readString(S),this.size-=S+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=w.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(w)},v.ES_Descriptor.prototype.getOTI=function(w){var S=this.findDescriptor(e);return S?S.oti:0},v.ES_Descriptor.prototype.getAudioConfig=function(w){var S=this.findDescriptor(e);if(!S)return null;var k=S.findDescriptor(n);if(k&&k.data){var F=(k.data[0]&248)>>3;return F===31&&k.data.length>=2&&(F=32+((k.data[0]&7)<<3)+((k.data[1]&224)>>5)),F}else return null},v.DecoderConfigDescriptor=function(w){v.Descriptor.call(this,e,w)},v.DecoderConfigDescriptor.prototype=new v.Descriptor,v.DecoderConfigDescriptor.prototype.parse=function(w){this.oti=w.readUint8(),this.streamType=w.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=w.readUint24(),this.maxBitrate=w.readUint32(),this.avgBitrate=w.readUint32(),this.size-=13,this.parseRemainingDescriptors(w)},v.DecoderSpecificInfo=function(w){v.Descriptor.call(this,n,w)},v.DecoderSpecificInfo.prototype=new v.Descriptor,v.SLConfigDescriptor=function(w){v.Descriptor.call(this,o,w)},v.SLConfigDescriptor.prototype=new v.Descriptor,this};d.MPEG4DescriptorParser=y;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,n){this.type=t,this.size=e,this.uuid=n},FullBox:function(t,e,n){s.Box.call(this,t,e,n),this.flags=0,this.version=0},ContainerBox:function(t,e,n){s.Box.call(this,t,e,n),this.boxes=[]},SampleEntry:function(t,e,n,o){s.ContainerBox.call(this,t,e),this.hdr_size=n,this.start=o},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(n){s.Box.call(this,t,n)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){this.parseFullHeader(n),e&&e.call(this,n)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,n=0;n<e;n++)this[t[n]+"s"]=[]}},createContainerBoxCtor:function(t,e,n){s[t+"Box"]=function(o){s.ContainerBox.call(this,t,o),s.addSubBoxArrays.call(this,n)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,n){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(o,f){s.SampleEntry.call(this,o,f),s.addSubBoxArrays.call(this,n)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,n,o){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(f){s[t+"SampleEntry"].call(this,e,f),s.addSubBoxArrays.call(this,o)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],n&&(s[e+"SampleEntry"].prototype.parse=n)},createEncryptedSampleEntryCtor:function(t,e,n){s.createSampleEntryCtor.call(this,t,e,n,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(n){s.SampleGroupEntry.call(this,t,n)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(n){s.TrackGroupTypeBox.call(this,t,n)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,n,o){s.UUIDs.push(t),s.UUIDBoxes[t]=function(f){e?s.FullBox.call(this,"uuid",f,t):n?s.ContainerBox.call(this,"uuid",f,t):s.Box.call(this,"uuid",f,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:n?new s.ContainerBox:new s.Box,o&&(e?s.UUIDBoxes[t].prototype.parse=function(f){this.parseFullHeader(f),o&&o.call(this,f)}:s.UUIDBoxes[t].prototype.parse=o)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var n=e||"entries";return this[n]||(this[n]=[]),this[n].push(t),this},d.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",n=0;n<16;n++){var o=t.readUint8().toString(16);e+=o.length===1?"0"+o:o}return e},s.parseOneBox=function(t,e,n){var o,f=t.getPosition(),g=0,v,w;if(t.getEndPosition()-f<8)return l.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(n&&n<8)return l.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var S=t.readUint32(),k=t.readString(4),F=k;if(l.debug("BoxParser","Found box of type '"+k+"' and size "+S+" at position "+f),g=8,k=="uuid"){if(t.getEndPosition()-t.getPosition()<16||n-g<16)return t.seek(f),l.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};w=s.parseUUID(t),g+=16,F=w}if(S==1){if(t.getEndPosition()-t.getPosition()<8||n&&n-g<8)return t.seek(f),l.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+k+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};S=t.readUint64(),g+=8}else if(S===0){if(n)S=n;else if(k!=="mdat")return l.error("BoxParser","Unlimited box size not supported for type: '"+k+"'"),o=new s.Box(k,S),{code:s.OK,box:o,size:o.size}}return S!==0&&S<g?(l.error("BoxParser","Box of type "+k+" has an invalid size "+S+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):S!==0&&n&&S>n?(l.error("BoxParser","Box of type '"+k+"' has a size "+S+" greater than its container size "+n),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):S!==0&&f+S>t.getEndPosition()?(t.seek(f),l.info("BoxParser","Not enough data in stream to parse the entire '"+k+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:k,size:S,hdr_size:g,start:f}):e?{code:s.OK,type:k,size:S,hdr_size:g,start:f}:(s[k+"Box"]?o=new s[k+"Box"](S):k!=="uuid"?(l.warn("BoxParser","Unknown box type: '"+k+"'"),o=new s.Box(k,S),o.has_unparsed_data=!0):s.UUIDBoxes[w]?o=new s.UUIDBoxes[w](S):(l.warn("BoxParser","Unknown uuid type: '"+w+"'"),o=new s.Box(k,S),o.uuid=w,o.has_unparsed_data=!0),o.hdr_size=g,o.start=f,o.write===s.Box.prototype.write&&o.type!=="mdat"&&(l.info("BoxParser","'"+F+"' box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(t)),o.parse(t),v=t.getPosition()-(o.start+o.size),v<0?(l.warn("BoxParser","Parsing of box '"+F+"' did not read the entire indicated box data size (missing "+-v+" bytes), seeking forward"),t.seek(o.start+o.size)):v>0&&(l.error("BoxParser","Parsing of box '"+F+"' read "+v+" more bytes than the indicated box data size, seeking backwards"),o.size!==0&&t.seek(o.start+o.size)),{code:s.OK,box:o,size:o.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(n=e.box,this.boxes.push(n),this.subBoxNames&&this.subBoxNames.indexOf(n.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(n.type)]+"s"].push(n);else{var o=n.type!=="uuid"?n.type:n.uuid;this[o]?l.warn("Box of type "+o+" already stored in field of this type"):this[o]=n}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,n=((e&1)+1)*16;this.layer_size=[];for(var o=0;o<3;o++)n==16?this.layer_size[o]=t.readUint16():this.layer_size[o]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){l.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){l.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){l.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){l.error("av1C reserved_2 parsing problem");return}var n=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(n)}),s.createBoxCtor("avcC",function(t){var e,n;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,n=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),n-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),n--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),n-=2+this.PPS[e].length;n>0&&(this.ext=t.readUint8Array(n))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,n;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(n=0;n<e;n++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(n=0;n<e;n++){this.sample_counts.push(t.readUint32());var o=t.readInt32();o<0&&l.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(o)}else if(this.version==1)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),n=t.readUint8(),o=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|n>>6&3,this.acmod=n>>3&7,this.lfeon=n>>2&1,this.bit_rate_code=n&3|o>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var n=0;n<this.num_ind_sub+1;n++){var o={};this.ind_subs.push(o);var f=t.readUint8(),g=t.readUint8(),v=t.readUint8();o.fscod=f>>6,o.bsid=f>>1&31,o.bsmod=(f&1)<<4|g>>4&15,o.acmod=g>>1&7,o.lfeon=g&1,o.num_dep_sub=v>>1&15,o.num_dep_sub>0&&(o.chan_loc=(v&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,n=128,o=[],f=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var g=t.readUint8(),v=Math.min(g&e,f.length-1);if(v?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),o.push(f[v]),g&n)break}while(!0);this.numMetadataBlocks=o.length+" ("+o.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,n;this.entries=[];for(var o=t.readUint32(),f=0;f<o;f++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=e.box,this.entries.push(n);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.entries.push(o),this.version===1?(o.segment_duration=t.readUint64(),o.media_time=t.readInt64()):(o.segment_duration=t.readUint32(),o.media_time=t.readInt32()),o.media_rate_integer=t.readInt16(),o.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(n){s.FullBox.call(this,t,n)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(n){if(this.parseFullHeader(n),e)e.call(this,n);else for(this.group_id=n.readUint32(),this.num_entities_in_group=n.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var o=n.readUint32();this.entity_ids.push(o)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var n=t.readUint32();this.entity_ids.push(n)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof y<"u"){var n=new y;this.esd=n.parseOneDescriptor(new h(e.buffer,0,h.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var n=0;e>=4;)this.compatible_brands[n]=t.readString(4),e-=4,n++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,n,o,f;this.configurationVersion=t.readUint8(),f=t.readUint8(),this.general_profile_space=f>>6,this.general_tier_flag=(f&32)>>5,this.general_profile_idc=f&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),f=t.readUint8(),this.constantFrameRate=f>>6,this.numTemporalLayers=(f&13)>>3,this.temporalIdNested=(f&4)>>2,this.lengthSizeMinusOne=f&3,this.nalu_arrays=[];var g=t.readUint8();for(e=0;e<g;e++){var v=[];this.nalu_arrays.push(v),f=t.readUint8(),v.completeness=(f&128)>>7,v.nalu_type=f&63;var w=t.readUint16();for(n=0;n<w;n++){var S={};v.push(S),o=t.readUint16(),S.data=t.readUint8Array(o)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var n=0;n<this.entry_count;n++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&l.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[n]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var n=0;if(this.version<2)n=t.readUint16();else if(this.version===2)n=t.readUint32();else throw"version of iloc box not supported";for(var o=0;o<n;o++){var f={};if(this.items.push(f),this.version<2)f.item_ID=t.readUint16();else if(this.version===2)f.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?f.construction_method=t.readUint16()&15:f.construction_method=0,f.data_reference_index=t.readUint16(),this.base_offset_size){case 0:f.base_offset=0;break;case 4:f.base_offset=t.readUint32();break;case 8:f.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var g=t.readUint16();f.extents=[];for(var v=0;v<g;v++){var w={};if(f.extents.push(w),this.version===1||this.version===2)switch(this.index_size){case 0:w.extent_index=0;break;case 4:w.extent_index=t.readUint32();break;case 8:w.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:w.extent_offset=0;break;case 4:w.extent_offset=t.readUint32();break;case 8:w.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:w.extent_length=0;break;case 4:w.extent_length=t.readUint32();break;case 8:w.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),l.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,n;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var o={};this.associations.push(o),this.version<1?o.id=t.readUint16():o.id=t.readUint32();var f=t.readUint8();for(o.props=[],n=0;n<f;n++){var g=t.readUint8(),v={};o.props.push(v),v.essential=(g&128)>>7===1,this.flags&1?v.property_index=(g&127)<<8|t.readUint8():v.property_index=g&127}}}),s.createFullBoxCtor("iref",function(t){var e,n;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?n=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):n=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var n=0;n<e;n++){var o={};this.levels[n]=o,o.track_ID=t.readUint32();var f=t.readUint8();switch(o.padding_flag=f>>7,o.assignment_type=f&127,o.assignment_type){case 0:o.grouping_type=t.readString(4);break;case 1:o.grouping_type=t.readString(4),o.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:o.sub_track_id=t.readUint32();break;default:l.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lhvC",function(t){var e,n,o;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,o=t.readUint8(),this.numTemporalLayers=(o&13)>>3,this.temporalIdNested=(o&4)>>2,this.lengthSizeMinusOne=o&3,this.nalu_arrays=[];var f=t.readUint8();for(e=0;e<f;e++){var g=[];this.nalu_arrays.push(g),o=t.readUint8(),g.completeness=(o&128)>>7,g.nalu_type=o&63;var v=t.readUint16();for(n=0;n<v;n++){var w={};g.push(w);var S=t.readUint16();w.data=t.readUint8Array(S)}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function b(t,e){this.x=t,this.y=e}b.prototype.toString=function(){return"("+this.x+","+this.y+")"},s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new b(t.readUint16(),t.readUint16()),this.display_primaries[1]=new b(t.readUint16(),t.readUint16()),this.display_primaries[2]=new b(t.readUint16(),t.readUint16()),this.white_point=new b(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(l.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var n=0;n<Math.floor((e+1)/2);n++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var n=0;n<e;n++)this.rate[n]=t.readUint32(),this.initial_delay[n]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var n=0;n<e;n++)this.kid[n]=s.parseHex16(t)}var o=t.readUint32();o>0&&(this.data=t.readUint8Array(o))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var n=0;n<e;n++)this.version===0?this.offset[n]=t.readUint32():this.offset[n]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var n=0;n<e;n++)this.sample_info_size[n]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,n=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<n;e++)this.sample_offset[e]=t.readUint32();var o=this.description_length-4-4*n;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<o/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var n=t.readUint8(),o=0;o<n;o++){var f={};this.dependency.push(f),f.subSeqDirectionFlag=t.readUint8(),f.layerNumber=t.readUint8(),f.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)l.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){l.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){l.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.entries.push(o),o.sample_count=t.readInt32(),o.group_description_index=t.readInt32()}});function A(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}A.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},s.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var n=t.readUint8();for(this.correction_applied=(n&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var o=t.readUint32(),f=t.readUint32();this.bad_pixels.push(new A(o,f))}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,n=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var o=0;o<n;o++)e=t.readUint8(),this.is_leading[o]=e>>6,this.sample_depends_on[o]=e>>4&3,this.sample_is_depended_on[o]=e>>2&3,this.sample_has_redundancy[o]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),l.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),n=0;n<e;n++){var o;s[this.grouping_type+"SampleGroupEntry"]?o=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):o=new s.SampleGroupEntry(this.grouping_type),this.entries.push(o),this.version===1?this.default_length===0?o.description_length=t.readUint32():o.description_length=this.default_length:o.description_length=this.default_length,o.write===s.SampleGroupEntry.prototype.write&&(l.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),o.data=t.readUint8Array(o.description_length),t.position-=o.description_length),o.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),n=0;n<e;n++){var o={};this.references.push(o);var f=t.readUint32();o.reference_type=f>>31&1,o.referenced_size=f&2147483647,o.subsegment_duration=t.readUint32(),f=t.readUint32(),o.starts_with_SAP=f>>31&1,o.SAP_type=f>>28&7,o.SAP_delta_time=f&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var n=0;n<e;n++)this.references[n]={},this.references[n].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),n=0;n<e;n++){var o={};this.subsegments.push(o),o.ranges=[];for(var f=t.readUint32(),g=0;g<f;g++){var v={};o.ranges.push(v),v.level=t.readUint8(),v.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var n=0;n<e;n++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var n=0;n<e;n++)this.priority[n]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,n;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(n=0;n<e;n++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,n,o,f;for(this.entries=[],o=t.readUint32(),e=1;e<=o;e++)if(n=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),n.code===s.OK)s[n.type+"SampleEntry"]?(f=new s[n.type+"SampleEntry"](n.size),f.hdr_size=n.hdr_size,f.start=n.start):(l.warn("BoxParser","Unknown sample entry type: "+n.type),f=new s.SampleEntry(n.type,n.size,n.hdr_size,n.start)),f.write===s.SampleEntry.prototype.write&&(l.info("BoxParser","SampleEntry "+f.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),f.parseDataAndRewind(t)),f.parse(t),this.entries.push(f);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var n=0;n<e;n++)this.group_description_index[n]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,n;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(n=0;n<e;n++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,n;if(n=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<n;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,n,o;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(n=0;n<e;n++)this.sample_counts.push(t.readUint32()),o=t.readInt32(),o<0&&(l.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),o=1),this.sample_deltas.push(o)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var n=t.readUint32();this.stereo_indication_type=t.readString(n);var o,f;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(o=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),o.code===s.OK)f=o.box,this.boxes.push(f),this[f.type]=f;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,n;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),n=t.readUint32(),this.field_size===4)for(e=0;e<n;e+=2){var o=t.readUint8();this.sample_sizes[e]=o>>4&15,this.sample_sizes[e+1]=o&15}else if(this.field_size===8)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<n;e++)this.sample_sizes[e]=t.readUint16();else l.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,n,o,f;for(o=t.readUint32(),this.entries=[],e=0;e<o;e++){var g={};if(this.entries[e]=g,g.sample_delta=t.readUint32(),g.subsamples=[],f=t.readUint16(),f>0)for(n=0;n<f;n++){var v={};g.subsamples.push(v),this.version==1?v.size=t.readUint32():v.size=t.readUint16(),v.priority=t.readUint8(),v.discardable=t.readUint8(),v.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var n=t.readUint32(),o=0;o<n;o++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,n,o){s.Box.call(this,t,e),this.hdr_size=n,this.start=o},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,n;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)n=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),n.write===s.Box.prototype.write&&n.type!=="mdat"&&(l.info("BoxParser","TrackReference "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.boxes.push(n);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var n=0;n<this.sample_count;n++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[n]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[n]=t.readUint32():this.sample_composition_time_offset[n]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var n=0;n<e;n++)this.attribute_list[n]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var n=0;n<e;n++)this.compatible_brands[n]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var n=t.readUint8();this.component_little_endian=n>>7&1,this.block_pad_lsb=n>>6&1,this.block_little_endian=n>>5&1,this.block_reversed=n>>4&1,this.pad_unknown=n>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var n={},o=0,f=0;this.version===1?(o=t.readUint64(),f=t.readUint64()):(o=t.readUint32(),f=t.readUint32()),n.absolute_time=o,n.absolute_duration=f,this.entries.push(n)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,n,o={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(D){this.held_bits=D.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(D){this.held_bits=D.readUint16(),this.num_held_bits=16},extract_bits:function(D){var et=this.held_bits>>this.num_held_bits-D&(1<<D)-1;return this.num_held_bits-=D,et}};if(o.stream_read_1_bytes(t),o.extract_bits(5),this.lengthSizeMinusOne=o.extract_bits(2),this.ptl_present_flag=o.extract_bits(1),this.ptl_present_flag){o.stream_read_2_bytes(t),this.ols_idx=o.extract_bits(9),this.num_sublayers=o.extract_bits(3),this.constant_frame_rate=o.extract_bits(2),this.chroma_format_idc=o.extract_bits(2),o.stream_read_1_bytes(t),this.bit_depth_minus8=o.extract_bits(3),o.extract_bits(5);{if(o.stream_read_2_bytes(t),o.extract_bits(2),this.num_bytes_constraint_info=o.extract_bits(6),this.general_profile_idc=o.extract_bits(7),this.general_tier_flag=o.extract_bits(1),this.general_level_idc=t.readUint8(),o.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=o.extract_bits(1),this.ptl_multilayer_enabled_flag=o.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var f=o.extract_bits(6);o.stream_read_1_bytes(t);var g=o.extract_bits(2);this.general_constraint_info[e]=f<<2|g}this.general_constraint_info[this.num_bytes_constraint_info-1]=o.extract_bits(6)}else o.extract_bits(6);if(this.num_sublayers>1){for(o.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,n=this.num_sublayers-2;n>=0;--n){var v=o.extract_bits(1);this.ptl_sublayer_present_mask|=v<<n}for(n=this.num_sublayers;n<=8&&this.num_sublayers>1;++n)o.extract_bits(1);for(this.sublayer_level_idc=[],n=this.num_sublayers-2;n>=0;--n)this.ptl_sublayer_present_mask&1<<n&&(this.sublayer_level_idc[n]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var w=12,S=13;this.nalu_arrays=[];var k=t.readUint8();for(e=0;e<k;e++){var F=[];this.nalu_arrays.push(F),o.stream_read_1_bytes(t),F.completeness=o.extract_bits(1),o.extract_bits(2),F.nalu_type=o.extract_bits(5);var P=1;for(F.nalu_type!=S&&F.nalu_type!=w&&(P=t.readUint16()),n=0;n<P;n++){var M=t.readUint16();F.push({data:t.readUint8Array(M),length:M})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var n=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;n.length<e;)n="0"+n;return n},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var n=this.hvcC.general_profile_compatibility,o=0;for(t=0;t<32&&(o|=n&1,t!=31);t++)o<<=1,n>>=1;e+=s.decimalToHex(o,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var f=!1,g="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||f)&&(g="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+g,f=!0);e+=g}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var n="";if(this.vvcC.general_constraint_info){var o=[],f=0;f|=this.vvcC.ptl_frame_only_constraint<<7,f|=this.vvcC.ptl_multilayer_enabled<<6;var g;for(t=0;t<this.vvcC.general_constraint_info.length;++t)f|=this.vvcC.general_constraint_info[t]>>2&63,o.push(f),f&&(g=t),f=this.vvcC.general_constraint_info[t]>>2&3;if(g===void 0)n=".CA";else{n=".C";var v="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",w=0,S=0;for(t=0;t<=g;++t)for(w=w<<8|o[t],S+=8;S>=5;){var k=w>>S-5&31;n+=v[k],S-=5,w&=(1<<S)-1}S&&(w<<=5-S,n+=v[w&31])}}e+=n}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),n=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(n?"."+n:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var n=this.vpcC.bitDepth;return n==8&&(n="08"),t+".0"+this.vpcC.profile+"."+e+"."+n},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var n;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?n=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(n=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+n},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),l.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeUint32(n.segment_duration),t.writeInt32(n.media_time),t.writeInt16(n.media_rate_integer),t.writeInt16(n.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,n;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,n=0;n<this.nalu_arrays[e].length;n++)this.size+=2+this.nalu_arrays[e][n].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),n=0;n<this.nalu_arrays[e].length;n++)t.writeUint16(this.nalu_arrays[e][n].data.length),t.writeUint8Array(this.nalu_arrays[e][n].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var n=this.entries[e];t.writeInt32(n.sample_count),t.writeInt32(n.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,n;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=n.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)n=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(n.description_length),n.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var n=this.references[e];t.writeUint32(n.reference_type<<31|n.referenced_size),t.writeUint32(n.subsegment_duration),t.writeUint32(n.starts_with_SAP<<31|n.SAP_type<<28|n.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;l.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,n=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){n=!1;break}else e++;else n=!1;this.size=8,n||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),n?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),n||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,n,o;for(o=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)t[o].pts=t[o].dts+this.sample_offsets[e],o++},s.sttsBox.prototype.unpack=function(t){var e,n,o;for(o=0,e=0;e<this.sample_counts.length;e++)for(n=0;n<this.sample_counts[e];n++)o===0?t[o].dts=0:t[o].dts=t[o-1].dts+this.sample_deltas[e],o++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,n,o,f,g;for(f=0,g=0,e=0;e<this.first_chunk.length;e++)for(n=0;n<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);n++)for(g++,o=0;o<this.samples_per_chunk[e];o++){if(t[f])t[f].description_index=this.sample_description_index[e],t[f].chunk_index=g;else return;f++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var n;for(n in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(n)>-1)){if(t[n]instanceof s.Box||e[n]instanceof s.Box)continue;if(typeof t[n]>"u"||typeof e[n]>"u")continue;if(typeof t[n]=="function"||typeof e[n]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(n.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(n.slice(0,4))>-1)continue;if(n==="data"||n==="start"||n==="size"||n==="creation_time"||n==="modification_time")continue;if(s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(n)>-1)continue;if(t[n]!==e[n])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var n=0;n<s.DIFF_BOXES_PROP_NAMES.length;n++){var o=s.DIFF_BOXES_PROP_NAMES[n];if(t[o]&&e[o]&&!s.boxEqual(t[o],e[o]))return!1}return!0};var B=function(){};B.prototype.parseSample=function(t){var e={},n;e.resources=[];var o=new u(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=o.readString(t.data.length);else if(e.documentString=o.readString(t.subsamples[0].size),t.subsamples.length>1)for(n=1;n<t.subsamples.length;n++)e.resources[n]=o.readUint8Array(t.subsamples[n].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var I=function(){};I.prototype.parseSample=function(t){var e,n=new u(t.data.buffer);return e=n.readString(t.data.length),e},I.prototype.parseConfig=function(t){var e,n=new u(t.buffer);return n.readUint32(),e=n.readCString(),e},d.XMLSubtitlein4Parser=B,d.Textin4Parser=I;var U=function(t){this.stream=t||new _,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};U.prototype.setSegmentOptions=function(t,e,n){var o=this.getTrackById(t);if(o){var f={};this.fragmentedTracks.push(f),f.id=t,f.user=e,f.trak=o,o.nextSample=0,f.segmentStream=null,f.nb_samples=1e3,f.rapAlignement=!0,n&&(n.nbSamples&&(f.nb_samples=n.nbSamples),n.rapAlignement&&(f.rapAlignement=n.rapAlignement))}},U.prototype.unsetSegmentOptions=function(t){for(var e=-1,n=0;n<this.fragmentedTracks.length;n++){var o=this.fragmentedTracks[n];o.id==t&&(e=n)}e>-1&&this.fragmentedTracks.splice(e,1)},U.prototype.setExtractionOptions=function(t,e,n){var o=this.getTrackById(t);if(o){var f={};this.extractedTracks.push(f),f.id=t,f.user=e,f.trak=o,o.nextSample=0,f.nb_samples=1e3,f.samples=[],n&&n.nbSamples&&(f.nb_samples=n.nbSamples)}},U.prototype.unsetExtractionOptions=function(t){for(var e=-1,n=0;n<this.extractedTracks.length;n++){var o=this.extractedTracks[n];o.id==t&&(e=n)}e>-1&&this.extractedTracks.splice(e,1)},U.prototype.parse=function(){var t,e,n=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,n),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var o;switch(e=t.box,o=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),o){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[o]!==void 0&&l.warn("ISOFile","Duplicate Box of type: "+o+", overriding previous occurrence"),this[o]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},U.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(l.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(l.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(l.warn("ISOFile","Not ready to start parsing"),!1))},U.prototype.appendBuffer=function(t,e){var n;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(n=this.nextSeekPosition,this.nextSeekPosition=void 0):n=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(n=this.stream.getEndFilePositionAfter(n))):this.nextParsePosition?n=this.nextParsePosition:n=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(l.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+n),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),n},U.prototype.getInfo=function(){var t,e,n={},o,f,g,v,w=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(n.hasMoov=!0,n.duration=this.moov.mvhd.duration,n.timescale=this.moov.mvhd.timescale,n.isFragmented=this.moov.mvex!=null,n.isFragmented&&this.moov.mvex.mehd&&(n.fragment_duration=this.moov.mvex.mehd.fragment_duration),n.isProgressive=this.isProgressive,n.hasIOD=this.moov.iods!=null,n.brands=[],n.brands.push(this.ftyp.major_brand),n.brands=n.brands.concat(this.ftyp.compatible_brands),n.created=new Date(w+this.moov.mvhd.creation_time*1e3),n.modified=new Date(w+this.moov.mvhd.modification_time*1e3),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(o=this.moov.traks[t],v=o.mdia.minf.stbl.stsd.entries[0],f={},n.tracks.push(f),f.id=o.tkhd.track_id,f.name=o.mdia.hdlr.name,f.references=[],o.tref)for(e=0;e<o.tref.boxes.length;e++)g={},f.references.push(g),g.type=o.tref.boxes[e].type,g.track_ids=o.tref.boxes[e].track_ids;o.edts&&(f.edits=o.edts.elst.entries),f.created=new Date(w+o.tkhd.creation_time*1e3),f.modified=new Date(w+o.tkhd.modification_time*1e3),f.movie_duration=o.tkhd.duration,f.movie_timescale=n.timescale,f.layer=o.tkhd.layer,f.alternate_group=o.tkhd.alternate_group,f.volume=o.tkhd.volume,f.matrix=o.tkhd.matrix,f.track_width=o.tkhd.width/65536,f.track_height=o.tkhd.height/65536,f.timescale=o.mdia.mdhd.timescale,f.cts_shift=o.mdia.minf.stbl.cslg,f.duration=o.mdia.mdhd.duration,f.samples_duration=o.samples_duration,f.codec=v.getCodec(),f.kind=o.udta&&o.udta.kinds.length?o.udta.kinds[0]:{schemeURI:"",value:""},f.language=o.mdia.elng?o.mdia.elng.extended_language:o.mdia.mdhd.languageString,f.nb_samples=o.samples.length,f.size=o.samples_size,f.bitrate=f.size*8*f.timescale/f.samples_duration,v.isAudio()?(f.type="audio",n.audioTracks.push(f),f.audio={},f.audio.sample_rate=v.getSampleRate(),f.audio.channel_count=v.getChannelCount(),f.audio.sample_size=v.getSampleSize()):v.isVideo()?(f.type="video",n.videoTracks.push(f),f.video={},f.video.width=v.getWidth(),f.video.height=v.getHeight()):v.isSubtitle()?(f.type="subtitles",n.subtitleTracks.push(f)):v.isHint()?(f.type="metadata",n.hintTracks.push(f)):v.isMetadata()?(f.type="metadata",n.metadataTracks.push(f)):(f.type="metadata",n.otherTracks.push(f))}else n.hasMoov=!1;if(n.mime="",n.hasMoov&&n.tracks){for(n.videoTracks&&n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks&&n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)t!==0&&(n.mime+=","),n.mime+=n.tracks[t].codec;n.mime+='"; profiles="',n.mime+=this.ftyp.compatible_brands.join(),n.mime+='"'}return n},U.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},U.prototype.processSamples=function(t){var e,n;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var o=this.fragmentedTracks[e];for(n=o.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Creating media fragment on track #"+o.id+" for sample "+n.nextSample);var f=this.createFragment(o.id,n.nextSample,o.segmentStream);if(f)o.segmentStream=f,n.nextSample++;else break;if((n.nextSample%o.nb_samples===0||t||n.nextSample>=n.samples.length)&&(l.info("ISOFile","Sending fragmented data on track #"+o.id+" for samples ["+Math.max(0,n.nextSample-o.nb_samples)+","+(n.nextSample-1)+"]"),l.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(o.id,o.user,o.segmentStream.buffer,n.nextSample,t||n.nextSample>=n.samples.length),o.segmentStream=null,o!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var g=this.extractedTracks[e];for(n=g.trak;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){l.debug("ISOFile","Exporting on track #"+g.id+" sample #"+n.nextSample);var v=this.getSample(n,n.nextSample);if(v)n.nextSample++,g.samples.push(v);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%g.nb_samples===0||n.nextSample>=n.samples.length)&&(l.debug("ISOFile","Sending samples on track #"+g.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(g.id,g.user,g.samples),g.samples=[],g!==this.extractedTracks[e]))break}}}},U.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},U.prototype.getBoxes=function(t,e){var n=[];return U._sweep.call(this,t,n,e),n},U._sweep=function(t,e,n){this.type&&this.type==t&&e.push(this);for(var o in this.boxes){if(e.length&&n)return;U._sweep.call(this.boxes[o],t,e,n)}},U.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},U.prototype.getTrackSample=function(t,e){var n=this.getTrackById(t),o=this.getSample(n,e);return o},U.prototype.releaseUsedSamples=function(t,e){var n=0,o=this.getTrackById(t);o.lastValidSample||(o.lastValidSample=0);for(var f=o.lastValidSample;f<e;f++)n+=this.releaseSample(o,f);l.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+n+", remaining: "+this.samplesDataSize+")"),o.lastValidSample=e},U.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},U.prototype.stop=function(){this.sampleProcessingStarted=!1},U.prototype.flush=function(){l.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},U.prototype.seekTrack=function(t,e,n){var o,f,g=1/0,v=0,w=0,S;if(n.samples.length===0)return l.info("ISOFile","No sample in track, cannot seek! Using time "+l.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(o=0;o<n.samples.length;o++){if(f=n.samples[o],o===0)w=0,S=f.timescale;else if(f.cts>t*f.timescale){w=o-1;break}e&&f.is_sync&&(v=o)}for(e&&(w=v),t=n.samples[w].cts,n.nextSample=w;n.samples[w].alreadyRead===n.samples[w].size&&n.samples[w+1];)w++;return g=n.samples[w].offset+n.samples[w].alreadyRead,l.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+n.nextSample+" on track "+n.tkhd.track_id+", time "+l.getDurationString(t,S)+" and offset: "+g),{offset:g,time:t/S}},U.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},U.prototype.seek=function(t,e){var n=this.moov,o,f,g,v={offset:1/0,time:1/0};if(this.moov){for(g=0;g<n.traks.length;g++)o=n.traks[g],!(t>this.getTrackDuration(o))&&(f=this.seekTrack(t,e,o),f.offset<v.offset&&(v.offset=f.offset),f.time<v.time&&(v.time=f.time));return l.info("ISOFile","Seeking at time "+l.getDurationString(v.time,1)+" needs a buffer with a fileStart position of "+v.offset),v.offset===1/0?v={offset:this.nextParsePosition,time:0}:v.offset=this.stream.getEndFilePositionAfter(v.offset),l.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+v.offset),v}else throw"Cannot seek: moov not received!"},U.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var n=this.boxes[e],o=t.boxes[e];if(!s.boxEqual(n,o))return!1;e++}return!0},d.ISOFile=U,U.prototype.lastBoxStartPosition=0,U.prototype.parsingMdat=null,U.prototype.nextParsePosition=0,U.prototype.discardMdatData=!1,U.prototype.processIncompleteBox=function(t){var e,n,o;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,o=this.stream.seek(e.start+e.size,!1,this.discardMdatData),o?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),n=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,n?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},U.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},U.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(l.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},U.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},U.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},U.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},U.prototype.add=s.Box.prototype.add,U.prototype.addBox=s.Box.prototype.addBox,U.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var n=this.add("moov");return n.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),n.add("mvex"),this},U.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var n=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,n.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var o=n.add("mdia");o.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),o.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),o.add("elng").set("extended_language",e.language||"fr-FR");var f=o.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var g=new s[e.type+"SampleEntry"];g.data_reference_index=1;var v="";for(var w in s.sampleEntryCodes)for(var S=s.sampleEntryCodes[w],k=0;k<S.length;k++)if(S.indexOf(e.type)>-1){v=w;break}switch(v){case"Visual":if(f.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),g.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var F=new s.avcCBox;F.parse(new u(e.avcDecoderConfigRecord)),g.addBox(F)}else if(e.hevcDecoderConfigRecord){var P=new s.hvcCBox;P.parse(new u(e.hevcDecoderConfigRecord)),g.addBox(P)}break;case"Audio":f.add("smhd").set("balance",e.balance||0),g.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":f.add("hmhd");break;case"Subtitle":switch(f.add("sthd"),e.type){case"stpp":g.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":f.add("nmhd");break;case"System":f.add("nmhd");break;default:f.add("nmhd");break}e.description&&g.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(D){g.addBox(D)}),f.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var M=f.add("stbl");return M.add("stsd").addEntry(g),M.add("stts").set("sample_counts",[]).set("sample_deltas",[]),M.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),M.add("stco").set("chunk_offsets",[]),M.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(n),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new h;e.endianness=h.BIG_ENDIAN,this.write(e)},U.prototype.addSample=function(t,e,n){var o=n||{},f={},g=this.getTrackById(t);if(g!==null){f.number=g.samples.length,f.track_id=g.tkhd.track_id,f.timescale=g.mdia.mdhd.timescale,f.description_index=o.sample_description_index?o.sample_description_index-1:0,f.description=g.mdia.minf.stbl.stsd.entries[f.description_index],f.data=e,f.size=e.byteLength,f.alreadyRead=f.size,f.duration=o.duration||1,f.cts=o.cts||0,f.dts=o.dts||0,f.is_sync=o.is_sync||!1,f.is_leading=o.is_leading||0,f.depends_on=o.depends_on||0,f.is_depended_on=o.is_depended_on||0,f.has_redundancy=o.has_redundancy||0,f.degradation_priority=o.degradation_priority||0,f.offset=0,f.subsamples=o.subsamples,g.samples.push(f),g.samples_size+=f.size,g.samples_duration+=f.duration,g.first_dts===void 0&&(g.first_dts=o.dts),this.processSamples();var v=this.createSingleSampleMoof(f);return this.addBox(v),v.computeSize(),v.trafs[0].truns[0].data_offset=v.size+8,this.add("mdat").data=new Uint8Array(e),f}},U.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var n=new s.moofBox;n.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var o=n.add("traf"),f=this.getTrackById(t.track_id);return o.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),o.add("tfdt").set("baseMediaDecodeTime",t.dts-(f.first_dts||0)),o.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),n},U.prototype.lastMoofIndex=0,U.prototype.samplesDataSize=0,U.prototype.resetTables=function(){var t,e,n,o,f,g,v,w;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,n=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,n.chunk_offsets=[],o=e.mdia.minf.stbl.stsc,o.first_chunk=[],o.samples_per_chunk=[],o.sample_description_index=[],f=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,f.sample_sizes=[],g=e.mdia.minf.stbl.stts,g.sample_counts=[],g.sample_deltas=[],v=e.mdia.minf.stbl.ctts,v&&(v.sample_counts=[],v.sample_offsets=[]),w=e.mdia.minf.stbl.stss;var S=e.mdia.minf.stbl.boxes.indexOf(w);S!=-1&&(e.mdia.minf.stbl.boxes[S]=null)}},U.initSampleGroups=function(t,e,n,o,f){var g,v,w,S;function k(F,P,M){this.grouping_type=F,this.grouping_type_parameter=P,this.sbgp=M,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),v=0;v<n.length;v++){for(S=n[v].grouping_type+"/"+n[v].grouping_type_parameter,w=new k(n[v].grouping_type,n[v].grouping_type_parameter,n[v]),e&&(e.sample_groups_info[S]=w),t.sample_groups_info[S]||(t.sample_groups_info[S]=w),g=0;g<o.length;g++)o[g].grouping_type===n[v].grouping_type&&(w.description=o[g],w.description.used=!0);if(f)for(g=0;g<f.length;g++)f[g].grouping_type===n[v].grouping_type&&(w.fragment_description=f[g],w.fragment_description.used=!0,w.is_fragment=!0)}if(e){if(f)for(v=0;v<f.length;v++)!f[v].used&&f[v].version>=2&&(S=f[v].grouping_type+"/0",w=new k(f[v].grouping_type,0),w.is_fragment=!0,e.sample_groups_info[S]||(e.sample_groups_info[S]=w))}else for(v=0;v<o.length;v++)!o[v].used&&o[v].version>=2&&(S=o[v].grouping_type+"/0",w=new k(o[v].grouping_type,0),t.sample_groups_info[S]||(t.sample_groups_info[S]=w))},U.setSampleGroupProperties=function(t,e,n,o){var f,g;e.sample_groups=[];for(f in o)if(e.sample_groups[f]={},e.sample_groups[f].grouping_type=o[f].grouping_type,e.sample_groups[f].grouping_type_parameter=o[f].grouping_type_parameter,n>=o[f].last_sample_in_run&&(o[f].last_sample_in_run<0&&(o[f].last_sample_in_run=0),o[f].entry_index++,o[f].entry_index<=o[f].sbgp.entries.length-1&&(o[f].last_sample_in_run+=o[f].sbgp.entries[o[f].entry_index].sample_count)),o[f].entry_index<=o[f].sbgp.entries.length-1?e.sample_groups[f].group_description_index=o[f].sbgp.entries[o[f].entry_index].group_description_index:e.sample_groups[f].group_description_index=-1,e.sample_groups[f].group_description_index!==0){var v;o[f].fragment_description?v=o[f].fragment_description:v=o[f].description,e.sample_groups[f].group_description_index>0?(e.sample_groups[f].group_description_index>65535?g=(e.sample_groups[f].group_description_index>>16)-1:g=e.sample_groups[f].group_description_index-1,v&&g>=0&&(e.sample_groups[f].description=v.entries[g])):v&&v.version>=2&&v.default_group_description_index>0&&(e.sample_groups[f].description=v.entries[v.default_group_description_index-1])}},U.process_sdtp=function(t,e,n){e&&(t?(e.is_leading=t.is_leading[n],e.depends_on=t.sample_depends_on[n],e.is_depended_on=t.sample_is_depended_on[n],e.has_redundancy=t.sample_has_redundancy[n]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},U.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},U.prototype.buildTrakSampleLists=function(t){var e,n,o,f,g,v,w,S,k,F,P,M,D,et,at,Ft,lt,Tt,Bt,Ht,it,ee,H,Q;if(t.samples=[],t.samples_duration=0,t.samples_size=0,n=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,o=t.mdia.minf.stbl.stsc,f=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,g=t.mdia.minf.stbl.stts,v=t.mdia.minf.stbl.ctts,w=t.mdia.minf.stbl.stss,S=t.mdia.minf.stbl.stsd,k=t.mdia.minf.stbl.subs,M=t.mdia.minf.stbl.stdp,F=t.mdia.minf.stbl.sbgps,P=t.mdia.minf.stbl.sgpds,Tt=-1,Bt=-1,Ht=-1,it=-1,ee=0,H=0,Q=0,U.initSampleGroups(t,null,F,P),!(typeof f>"u")){for(e=0;e<f.sample_sizes.length;e++){var Y={};Y.number=e,Y.track_id=t.tkhd.track_id,Y.timescale=t.mdia.mdhd.timescale,Y.alreadyRead=0,t.samples[e]=Y,Y.size=f.sample_sizes[e],t.samples_size+=Y.size,e===0?(et=1,D=0,Y.chunk_index=et,Y.chunk_run_index=D,lt=o.samples_per_chunk[D],Ft=0,D+1<o.first_chunk.length?at=o.first_chunk[D+1]-1:at=1/0):e<lt?(Y.chunk_index=et,Y.chunk_run_index=D):(et++,Y.chunk_index=et,Ft=0,et<=at||(D++,D+1<o.first_chunk.length?at=o.first_chunk[D+1]-1:at=1/0),Y.chunk_run_index=D,lt+=o.samples_per_chunk[D]),Y.description_index=o.sample_description_index[Y.chunk_run_index]-1,Y.description=S.entries[Y.description_index],Y.offset=n.chunk_offsets[Y.chunk_index-1]+Ft,Ft+=Y.size,e>Tt&&(Bt++,Tt<0&&(Tt=0),Tt+=g.sample_counts[Bt]),e>0?(t.samples[e-1].duration=g.sample_deltas[Bt],t.samples_duration+=t.samples[e-1].duration,Y.dts=t.samples[e-1].dts+t.samples[e-1].duration):Y.dts=0,v?(e>=Ht&&(it++,Ht<0&&(Ht=0),Ht+=v.sample_counts[it]),Y.cts=t.samples[e].dts+v.sample_offsets[it]):Y.cts=Y.dts,w?(e==w.sample_numbers[ee]-1?(Y.is_sync=!0,ee++):(Y.is_sync=!1,Y.degradation_priority=0),k&&k.entries[H].sample_delta+Q==e+1&&(Y.subsamples=k.entries[H].subsamples,Q+=k.entries[H].sample_delta,H++)):Y.is_sync=!0,U.process_sdtp(t.mdia.minf.stbl.sdtp,Y,Y.number),M?Y.degradation_priority=M.priority[e]:Y.degradation_priority=0,k&&k.entries[H].sample_delta+Q==e&&(Y.subsamples=k.entries[H].subsamples,Q+=k.entries[H].sample_delta),(F.length>0||P.length>0)&&U.setSampleGroupProperties(t,Y,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},U.prototype.updateSampleLists=function(){var t,e,n,o,f,g,v,w,S,k,F,P,M,D,et;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(S=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,S.type=="moof")for(k=S,t=0;t<k.trafs.length;t++){for(F=k.trafs[t],P=this.getTrackById(F.tfhd.track_id),M=this.getTrexById(F.tfhd.track_id),F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?o=F.tfhd.default_sample_description_index:o=M?M.default_sample_description_index:1,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?f=F.tfhd.default_sample_duration:f=M?M.default_sample_duration:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?g=F.tfhd.default_sample_size:g=M?M.default_sample_size:0,F.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?v=F.tfhd.default_sample_flags:v=M?M.default_sample_flags:0,F.sample_number=0,F.sbgps.length>0&&U.initSampleGroups(P,F,F.sbgps,P.mdia.minf.stbl.sgpds,F.sgpds),e=0;e<F.truns.length;e++){var at=F.truns[e];for(n=0;n<at.sample_count;n++){D={},D.moof_number=this.lastMoofIndex,D.number_in_traf=F.sample_number,F.sample_number++,D.number=P.samples.length,F.first_sample_index=P.samples.length,P.samples.push(D),D.track_id=P.tkhd.track_id,D.timescale=P.mdia.mdhd.timescale,D.description_index=o-1,D.description=P.mdia.minf.stbl.stsd.entries[D.description_index],D.size=g,at.flags&s.TRUN_FLAGS_SIZE&&(D.size=at.sample_size[n]),P.samples_size+=D.size,D.duration=f,at.flags&s.TRUN_FLAGS_DURATION&&(D.duration=at.sample_duration[n]),P.samples_duration+=D.duration,P.first_traf_merged||n>0?D.dts=P.samples[P.samples.length-2].dts+P.samples[P.samples.length-2].duration:(F.tfdt?D.dts=F.tfdt.baseMediaDecodeTime:D.dts=0,P.first_traf_merged=!0),D.cts=D.dts,at.flags&s.TRUN_FLAGS_CTS_OFFSET&&(D.cts=D.dts+at.sample_composition_time_offset[n]),et=v,at.flags&s.TRUN_FLAGS_FLAGS?et=at.sample_flags[n]:n===0&&at.flags&s.TRUN_FLAGS_FIRST_FLAG&&(et=at.first_sample_flags),D.is_sync=!(et>>16&1),D.is_leading=et>>26&3,D.depends_on=et>>24&3,D.is_depended_on=et>>22&3,D.has_redundancy=et>>20&3,D.degradation_priority=et&65535;var Ft=!!(F.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),lt=!!(F.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),Tt=!!(at.flags&s.TRUN_FLAGS_DATA_OFFSET),Bt=0;Ft?Bt=F.tfhd.base_data_offset:lt||e===0?Bt=k.start:Bt=w,e===0&&n===0?Tt?D.offset=Bt+at.data_offset:D.offset=Bt:D.offset=w,w=D.offset+D.size,(F.sbgps.length>0||F.sgpds.length>0||P.mdia.minf.stbl.sbgps.length>0||P.mdia.minf.stbl.sgpds.length>0)&&U.setSampleGroupProperties(P,D,D.number_in_traf,F.sample_groups_info)}}if(F.subs){P.has_fragment_subsamples=!0;var Ht=F.first_sample_index;for(e=0;e<F.subs.entries.length;e++)Ht+=F.subs.entries[e].sample_delta,D=P.samples[Ht-1],D.subsamples=F.subs.entries[e].subsamples}}}},U.prototype.getSample=function(t,e){var n,o=t.samples[e];if(!this.moov)return null;if(!o.data)o.data=new Uint8Array(o.size),o.alreadyRead=0,this.samplesDataSize+=o.size,l.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+o.size+" (total: "+this.samplesDataSize+")");else if(o.alreadyRead==o.size)return o;for(;;){var f=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(f>-1){n=this.stream.buffers[f];var g=n.byteLength-(o.offset+o.alreadyRead-n.fileStart);if(o.size-o.alreadyRead<=g)return l.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-n.fileStart)+" read size: "+(o.size-o.alreadyRead)+" full size: "+o.size+")"),h.memcpy(o.data.buffer,o.alreadyRead,n,o.offset+o.alreadyRead-n.fileStart,o.size-o.alreadyRead),n.usedBytes+=o.size-o.alreadyRead,this.stream.logBufferLevel(),o.alreadyRead=o.size,o;if(g===0)return null;l.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-n.fileStart)+" read size: "+g+" full size: "+o.size+")"),h.memcpy(o.data.buffer,o.alreadyRead,n,o.offset+o.alreadyRead-n.fileStart,g),o.alreadyRead+=g,n.usedBytes+=g,this.stream.logBufferLevel()}else return null}},U.prototype.releaseSample=function(t,e){var n=t.samples[e];return n.data?(this.samplesDataSize-=n.size,n.data=null,n.alreadyRead=0,n.size):0},U.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},U.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var n=this.moov.traks[t];t>0&&(e+=","),e+=n.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},U.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var n=this.moov.mvex.trexs[e];if(n.track_id==t)return n}return null},U.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var n=this.moov.traks[e];if(n.tkhd.track_id==t)return n}return null},U.prototype.items=[],U.prototype.entity_groups=[],U.prototype.itemsDataSize=0,U.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,n,o,f,g=this.meta;if(g!=null&&g.hdlr!==void 0&&g.iinf!==void 0){for(n=0;n<g.iinf.item_infos.length;n++)f={},f.id=g.iinf.item_infos[n].item_ID,t[f.id]=f,f.ref_to=[],f.name=g.iinf.item_infos[n].item_name,g.iinf.item_infos[n].protection_index>0&&(f.protection=g.ipro.protections[g.iinf.item_infos[n].protection_index-1]),g.iinf.item_infos[n].item_type?f.type=g.iinf.item_infos[n].item_type:f.type="mime",f.content_type=g.iinf.item_infos[n].content_type,f.content_encoding=g.iinf.item_infos[n].content_encoding;if(g.grpl)for(n=0;n<g.grpl.boxes.length;n++)entity_group={},entity_group.id=g.grpl.boxes[n].group_id,entity_group.entity_ids=g.grpl.boxes[n].entity_ids,entity_group.type=g.grpl.boxes[n].type,e[entity_group.id]=entity_group;if(g.iloc)for(n=0;n<g.iloc.items.length;n++){var v=g.iloc.items[n];switch(f=t[v.item_ID],v.data_reference_index!==0&&(l.warn("Item storage with reference to other files: not supported"),f.source=g.dinf.boxes[v.data_reference_index-1]),v.construction_method){case 0:break;case 1:l.warn("Item storage with construction_method : not supported");break;case 2:l.warn("Item storage with construction_method : not supported");break}for(f.extents=[],f.size=0,o=0;o<v.extents.length;o++)f.extents[o]={},f.extents[o].offset=v.extents[o].extent_offset+v.base_offset,f.extents[o].length=v.extents[o].extent_length,f.extents[o].alreadyRead=0,f.size+=f.extents[o].length}if(g.pitm&&(t[g.pitm.item_id].primary=!0),g.iref)for(n=0;n<g.iref.references.length;n++){var w=g.iref.references[n];for(o=0;o<w.references.length;o++)t[w.from_item_ID].ref_to.push({type:w.type,id:w.references[o]})}if(g.iprp)for(var S=0;S<g.iprp.ipmas.length;S++){var k=g.iprp.ipmas[S];for(n=0;n<k.associations.length;n++){var F=k.associations[n];if(f=t[F.id],f||(f=e[F.id]),f)for(f.properties===void 0&&(f.properties={},f.properties.boxes=[]),o=0;o<F.props.length;o++){var P=F.props[o];if(P.property_index>0&&P.property_index-1<g.iprp.ipco.boxes.length){var M=g.iprp.ipco.boxes[P.property_index-1];f.properties[M.type]=M,f.properties.boxes.push(M)}}}}}},U.prototype.getItem=function(t){var e,n;if(!this.meta)return null;if(n=this.items[t],!n.data&&n.size)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.itemsDataSize+=n.size,l.debug("ISOFile","Allocating item #"+t+" of size "+n.size+" (total: "+this.itemsDataSize+")");else if(n.alreadyRead===n.size)return n;for(var o=0;o<n.extents.length;o++){var f=n.extents[o];if(f.alreadyRead!==f.length){var g=this.stream.findPosition(!0,f.offset+f.alreadyRead,!1);if(g>-1){e=this.stream.buffers[g];var v=e.byteLength-(f.offset+f.alreadyRead-e.fileStart);if(f.length-f.alreadyRead<=v)l.debug("ISOFile","Getting item #"+t+" extent #"+o+" data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+(f.length-f.alreadyRead)+" full extent size: "+f.length+" full item size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,f.length-f.alreadyRead),e.usedBytes+=f.length-f.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead+=f.length-f.alreadyRead,f.alreadyRead=f.length;else return l.debug("ISOFile","Getting item #"+t+" extent #"+o+" partial data (alreadyRead: "+f.alreadyRead+" offset: "+(f.offset+f.alreadyRead-e.fileStart)+" read size: "+v+" full extent size: "+f.length+" full item size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,e,f.offset+f.alreadyRead-e.fileStart,v),f.alreadyRead+=v,n.alreadyRead+=v,e.usedBytes+=v,this.stream.logBufferLevel(),null}else return null}}return n.alreadyRead===n.size?n:null},U.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var n=0;n<e.extents.length;n++){var o=e.extents[n];o.alreadyRead=0}return e.size}else return 0},U.prototype.processItems=function(t){for(var e in this.items){var n=this.items[e];this.getItem(n.id),t&&!n.sent&&(t(n),n.sent=!0,n.data=null)}},U.prototype.hasItem=function(t){for(var e in this.items){var n=this.items[e];if(n.name===t)return n.id}return-1},U.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},U.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},U.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},n=null;if(e.itemId?n=this.getItem(e.itemId):n=this.getPrimaryItem(),n==null)return null;var o=new U;o.discardMdatData=!1;var f={type:n.type,description_boxes:n.properties.boxes};n.properties.ispe&&(f.width=n.properties.ispe.image_width,f.height=n.properties.ispe.image_height);var g=o.addTrack(f);return g?(o.addSample(g,n.data),o):null},U.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},U.prototype.createFragment=function(t,e,n){var o=this.getTrackById(t),f=this.getSample(o,e);if(f==null)return this.setNextSeekPositionFromSample(o.samples[e]),null;var g=n||new h;g.endianness=h.BIG_ENDIAN;var v=this.createSingleSampleMoof(f);v.write(g),v.trafs[0].truns[0].data_offset=v.size+8,l.debug("MP4Box","Adjusting data_offset with new value "+v.trafs[0].truns[0].data_offset),g.adjustUint32(v.trafs[0].truns[0].data_offset_position,v.trafs[0].truns[0].data_offset);var w=new s.mdatBox;return w.data=f.data,w.write(g),g},U.writeInitializationSegment=function(t,e,n,o){var f;l.debug("ISOFile","Generating initialization segment");var g=new h;g.endianness=h.BIG_ENDIAN,t.write(g);var v=e.add("mvex");for(n&&v.add("mehd").set("fragment_duration",n),f=0;f<e.traks.length;f++)v.add("trex").set("track_id",e.traks[f].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",o).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(g),g.buffer},U.prototype.save=function(t){var e=new h;e.endianness=h.BIG_ENDIAN,this.write(e),e.save(t)},U.prototype.getBuffer=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.write(t),t.buffer},U.prototype.initializeSegmentation=function(){var t,e,n,o;for(this.onSegment===null&&l.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var f=new s.moovBox;f.mvhd=this.moov.mvhd,f.boxes.push(f.mvhd),n=this.getTrackById(this.fragmentedTracks[t].id),f.boxes.push(n),f.traks.push(n),o={},o.id=n.tkhd.track_id,o.user=this.fragmentedTracks[t].user,o.buffer=U.writeInitializationSegment(this.ftyp,f,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(o)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var n=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=n}},U.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var G={};G.createFile=function(t,e){var n=t!==void 0?t:!0,o=new U(e);return o.discardMdatData=!n,o},d.createFile=G.createFile})(Qd);const ns=Kd(Qd);var dw=Object.defineProperty,tc=d=>{throw TypeError(d)},cw=(d,l,u)=>l in d?dw(d,l,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[l]=u,Ql=(d,l,u)=>cw(d,typeof l!="symbol"?l+"":l,u),pw=(d,l,u)=>l.has(d)||tc("Cannot "+u),zr=(d,l,u)=>(pw(d,l,"read from private field"),u?u.call(d):l.get(d)),_w=(d,l,u)=>l.has(d)?tc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(d):l.set(d,u),zn;class pr{constructor(){_w(this,zn,new Map),Ql(this,"on",(l,u)=>{const h=zr(this,zn).get(l)??new Set;return h.add(u),zr(this,zn).has(l)||zr(this,zn).set(l,h),()=>{h.delete(u),h.size===0&&zr(this,zn).delete(l)}}),Ql(this,"once",(l,u)=>{const h=this.on(l,(...p)=>{h(),u(...p)});return h}),Ql(this,"emit",(l,...u)=>{const h=zr(this,zn).get(l);h!=null&&h.forEach(p=>p(...u))})}static forwardEvent(l,u,h){const p=h.map(_=>{const[y,s]=Array.isArray(_)?_:[_,_];return l.on(y,(...b)=>{u.emit(s,...b)})});return()=>{p.forEach(_=>_())}}destroy(){zr(this,zn).clear()}}zn=new WeakMap;const gw=()=>{let d,l=16.6;self.onmessage=u=>{u.data.event==="start"&&(self.clearInterval(d),d=self.setInterval(()=>{self.postMessage({})},l)),u.data.event==="stop"&&self.clearInterval(d)}},mw=()=>{const d=new Blob([`(${gw.toString()})()`]),l=URL.createObjectURL(d);return new Worker(l)},kr=new Map;let hu=1,Zr=null;globalThis.Worker!=null&&(Zr=mw(),Zr.onmessage=()=>{hu+=1;for(const[d,l]of kr)if(hu%d===0)for(const u of l)u()});const ku=(d,l)=>{const u=Math.round(l/16.6),h=kr.get(u)??new Set;return h.add(d),kr.set(u,h),kr.size===1&&h.size===1&&(Zr==null||Zr.postMessage({event:"start"})),()=>{h.delete(d),h.size===0&&kr.delete(u),kr.size===0&&(hu=0,Zr==null||Zr.postMessage({event:"stop"}))}};function vw(d,l){let u=!1;async function h(){const p=d.getReader();for(;!u;){const{value:_,done:y}=await p.read();if(y){l.onDone();return}await l.onChunk(_)}p.releaseLock(),await d.cancel()}return h().catch(console.error),()=>{u=!0}}function yw(d,l,u){let h=0,p=0;const _=d.boxes;let y=!1;const s=()=>{var I;if(!y)if(_.find(t=>t.type==="moof")!=null)y=!0;else return null;if(p>=_.length)return null;const U=new ns.DataStream;U.endianness=ns.DataStream.BIG_ENDIAN;let G=p;try{for(;G<_.length;)_[G].write(U),delete _[G],G+=1}catch(t){const e=_[G];throw t instanceof Error&&e!=null?Error(`${t.message} | deltaBuf( boxType: ${e.type}, boxSize: ${e.size}, boxDataLen: ${((I=e.data)==null?void 0:I.length)??-1})`):t}return ww(d),p=_.length,new Uint8Array(U.buffer)};let b=!1,A=!1,B=null;return{stream:new ReadableStream({start(I){h=self.setInterval(()=>{const U=s();U!=null&&!A&&I.enqueue(U)},l),B=U=>{if(clearInterval(h),d.flush(),U!=null){I.error(U);return}const G=s();G!=null&&!A&&I.enqueue(G),A||I.close()},b&&B()},cancel(){A=!0,clearInterval(h),u==null||u()}}),stop:I=>{b||(b=!0,B==null||B(I))}}}function ww(d){if(d.moov!=null){for(var l=0;l<d.moov.traks.length;l++)d.moov.traks[l].samples=[];d.mdats=[],d.moofs=[]}}const Lu=(d,l)=>{const u=new Uint8Array(8);new DataView(u.buffer).setUint32(0,l);for(let h=0;h<4;h++)u[4+h]=d.charCodeAt(h);return u},xw=()=>{const d=new TextEncoder,l=d.encode("mdta"),u=d.encode("mp4 handler"),h=32+u.byteLength+1,p=new Uint8Array(h),_=new DataView(p.buffer);return p.set(Lu("hdlr",h),0),_.setUint32(8,0),p.set(l,16),p.set(u,32),p},bw=d=>{const l=new TextEncoder,u=l.encode("mdta"),h=d.map(b=>{const A=l.encode(b),B=8+A.byteLength,I=new Uint8Array(B);return new DataView(I.buffer).setUint32(0,B),I.set(u,4),I.set(A,4+u.byteLength),I}),p=16+h.reduce((b,A)=>b+A.byteLength,0),_=new Uint8Array(p),y=new DataView(_.buffer);_.set(Lu("keys",p),0),y.setUint32(8,0),y.setUint32(12,d.length);let s=16;for(const b of h)_.set(b,s),s+=b.byteLength;return _},Sw=d=>{const l=new TextEncoder,u=l.encode("data"),h=Object.entries(d).map(([s,b],A)=>{const B=A+1,I=l.encode(b),U=24+I.byteLength,G=new Uint8Array(U),t=new DataView(G.buffer);return t.setUint32(0,U),t.setUint32(4,B),t.setUint32(8,16+I.byteLength),G.set(u,12),t.setUint32(16,1),G.set(I,24),G}),p=8+h.reduce((s,b)=>s+b.byteLength,0),_=new Uint8Array(p);_.set(Lu("ilst",p),0);let y=8;for(const s of h)_.set(s,y),y+=s.byteLength;return _},Uw=d=>{const l=xw(),u=bw(Object.keys(d)),h=Sw(d),p=l.length+u.length+h.length,_=new Uint8Array(p);return _.set(l,0),_.set(u,l.length),_.set(h,l.length+u.length),_};function Ew(d){return d instanceof Error?String(d):typeof d=="object"?JSON.stringify(d,(l,u)=>u instanceof Error?String(u):u):String(d)}function Cw(){const d=new Date;return`${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}.${d.getMilliseconds()}`}let ec=1;const ic=[],Ud=["debug","info","warn","error"].reduce((d,l,u)=>Object.assign(d,{[l]:(...h)=>{ec<=u&&(console[l](...h),ic.push({lvName:l,timeStr:Cw(),args:h}))}}),{}),Js=new Map,kt={setLogLevel:d=>{ec=Js.get(d)??1},...Ud,create:d=>Object.fromEntries(Object.entries(Ud).map(([l,u])=>[l,(...h)=>u(d,...h)])),async dump(){return ic.reduce((d,{lvName:l,timeStr:u,args:h})=>d+`[${l}][${u}]  ${h.map(p=>Ew(p)).join(" ")}
`,"")}};Js.set(kt.debug,0);Js.set(kt.info,1);Js.set(kt.warn,2);Js.set(kt.error,3);(async function(){await Promise.resolve(),!(globalThis.navigator==null||globalThis.document==null)&&(kt.info(`@webav version: 1.0.11, date: ${new Date().toLocaleDateString()}`),kt.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",()=>{kt.info(`visibilitychange: ${document.visibilityState}`)}),"PressureObserver"in globalThis&&new PressureObserver(d=>{kt.info(`cpu state change: ${JSON.stringify(d.map(l=>l.state))}`)}).observe("cpu"))})();function Tw(d){kt.info("recodemux opts:",d);const l=ns.createFile(),u=new pr,h=(b,A)=>{const B=b.add("udta").add("meta");B.data=Uw(A),B.size=B.data.byteLength};let p=!1;const _=()=>{l.moov==null||p||(p=!0,d.metaDataTags!=null&&h(l.moov,d.metaDataTags),d.duration!=null&&(l.moov.mvhd.duration=d.duration))};u.once("VideoReady",_),u.once("AudioReady",_);let y=d.video!=null?Aw(d.video,l,u):null,s=d.audio!=null?Bw(d.audio,l,u):null;return d.video==null&&u.emit("VideoReady"),d.audio==null&&u.emit("AudioReady"),{encodeVideo:(b,A)=>{y==null||y.encode(b,A),b.close()},encodeAudio:b=>{if(s!=null)try{s.encode(b),b.close()}catch(A){const B=`encode audio chunk error: ${A.message}, state: ${JSON.stringify({qSize:s.encodeQueueSize,state:s.state})}`;throw kt.error(B),Error(B)}},getEncodeQueueSize:()=>(y==null?void 0:y.encodeQueueSize)??(s==null?void 0:s.encodeQueueSize)??0,flush:async()=>{await Promise.all([y==null?void 0:y.flush(),(s==null?void 0:s.state)==="configured"?s.flush():null])},close:()=>{u.destroy(),y==null||y.close(),(s==null?void 0:s.state)==="configured"&&s.close()},mp4file:l}}function Aw(d,l,u){const h={timescale:1e6,width:d.width,height:d.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null,name:"Track created with WebAV"};let p=-1,_=!1;u.once("AudioReady",()=>{_=!0});const y={encoder0:[],encoder1:[]},s=(o,f,g)=>{var v;if(p===-1&&g!=null){const w=(v=g.decoderConfig)==null?void 0:v.description;Iw(w),h.avcDecoderConfigRecord=w,p=l.addTrack(h),u.emit("VideoReady"),kt.info("VideoEncoder, video track ready, trackId:",p)}y[o].push(fu(f))};let b="encoder1",A=0;const B=Math.floor(1e3/d.expectFPS*1e3);function I(){if(!_)return;const o=b==="encoder1"?"encoder0":"encoder1",f=y[b],g=y[o];if(f.length===0&&g.length===0)return;let v=f[0];if(v!=null&&(!v.is_sync||v.cts-A<B)){const S=U(f);S>A&&(A=S)}const w=g[0];if(w!=null&&w.is_sync&&w.cts-A<B){b=o,I();return}if(v!=null&&v.is_sync&&w!=null&&w.is_sync)if(v.cts<=w.cts){const S=U(f);S>A&&(A=S)}else{b=o,I();return}}function U(o){let f=-1,g=0;for(;g<o.length;g++){const v=o[g];if(g>0&&v.is_sync)break;l.addSample(p,v.data,v),f=v.cts+v.duration}return o.splice(0,g),f}const G=ku(I,15),t=Ed(d,(o,f)=>s("encoder0",o,f)),e=Ed(d,(o,f)=>s("encoder1",o,f));let n=0;return{get encodeQueueSize(){return t.encodeQueueSize+e.encodeQueueSize},encode:(o,f)=>{try{f.keyFrame&&(n+=1),(n%2===0?t:e).encode(o,f)}catch(g){const v=`encode video frame error: ${g.message}, state: ${JSON.stringify({ts:o.timestamp,keyFrame:f.keyFrame,duration:o.duration,gopId:n})}`;throw kt.error(v),Error(v)}},flush:async()=>{await Promise.all([t.state==="configured"?await t.flush():null,e.state==="configured"?await e.flush():null]),G(),I()},close:()=>{t.state==="configured"&&t.close(),e.state==="configured"&&e.close()}}}function Iw(d){const l=new Uint8Array(d);l[2].toString(2).slice(-2).includes("1")&&(l[2]=0)}function Ed(d,l){const u={codec:d.codec,framerate:d.expectFPS,hardwareAcceleration:d.__unsafe_hardwareAcceleration__,bitrate:d.bitrate,width:d.width,height:d.height,alpha:"discard",avc:{format:"avc"}},h=new VideoEncoder({error:p=>{const _=`VideoEncoder error: ${p.message}, config: ${JSON.stringify(u)}, state: ${JSON.stringify({qSize:h.encodeQueueSize,state:h.state})}`;throw kt.error(_),Error(_)},output:l});return h.configure(u),h}function Bw(d,l,u){const h={timescale:1e6,samplerate:d.sampleRate,channel_count:d.channelCount,hdlr:"soun",type:d.codec==="aac"?"mp4a":"Opus",name:"Track created with WebAV"};let p=-1,_=[],y=!1;u.once("VideoReady",()=>{y=!0,_.forEach(A=>{const B=fu(A);l.addSample(p,B.data,B)}),_=[]});const s={codec:d.codec==="aac"?"mp4a.40.2":"opus",sampleRate:d.sampleRate,numberOfChannels:d.channelCount,bitrate:128e3},b=new AudioEncoder({error:A=>{const B=`AudioEncoder error: ${A.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify({qSize:b.encodeQueueSize,state:b.state})}`;throw kt.error(B),Error(B)},output:(A,B)=>{var I;if(p===-1){const U=(I=B.decoderConfig)==null?void 0:I.description;p=l.addTrack({...h,description:U==null?void 0:zw(U)}),u.emit("AudioReady"),kt.info("AudioEncoder, audio track ready, trackId:",p)}if(y){const U=fu(A);l.addSample(p,U.data,U)}else _.push(A)}});return b.configure(s),b}function zw(d){const l=d.byteLength,u=new Uint8Array([0,0,0,0,3,23+l,0,2,0,4,18+l,64,21,0,0,0,0,0,0,0,0,0,0,0,5,l,...new Uint8Array(d instanceof ArrayBuffer?d:d.buffer),6,1,2]),h=new ns.BoxParser.esdsBox(u.byteLength);return h.hdr_size=0,h.parse(new ns.DataStream(u,0,ns.DataStream.BIG_ENDIAN)),h}function fu(d){const l=new ArrayBuffer(d.byteLength);d.copyTo(l);const u=d.timestamp;return{duration:d.duration??0,dts:u,cts:u,is_sync:d.type==="key",data:l}}class Fw{constructor(l,u,h){this.length_=l,this.scaleFactor_=(l-1)/u,this.interpolate=this.cubic,h.method==="point"?this.interpolate=this.point:h.method==="linear"?this.interpolate=this.linear:h.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,h.tension||0)),this.sincFilterSize_=h.sincFilterSize||1,this.kernel_=Lw(h.sincWindow||kw)}point(l,u){return this.getClippedInput_(Math.round(this.scaleFactor_*l),u)}linear(l,u){l=this.scaleFactor_*l;let h=Math.floor(l);return l-=h,(1-l)*this.getClippedInput_(h,u)+l*this.getClippedInput_(h+1,u)}cubic(l,u){l=this.scaleFactor_*l;let h=Math.floor(l),p=[this.getTangent_(h,u),this.getTangent_(h+1,u)],_=[this.getClippedInput_(h,u),this.getClippedInput_(h+1,u)];l-=h;let y=l*l,s=l*y;return(2*s-3*y+1)*_[0]+(s-2*y+l)*p[0]+(-2*s+3*y)*_[1]+(s-y)*p[1]}sinc(l,u){l=this.scaleFactor_*l;let h=Math.floor(l),p=h-this.sincFilterSize_+1,_=h+this.sincFilterSize_,y=0;for(let s=p;s<=_;s++)y+=this.kernel_(l-s)*this.getClippedInput_(s,u);return y}getTangent_(l,u){return this.tangentFactor_*(this.getClippedInput_(l+1,u)-this.getClippedInput_(l-1,u))/2}getClippedInput_(l,u){return 0<=l&&l<this.length_?u[l]:0}}function kw(d){return Math.exp(-d/2*d/2)}function Lw(d){return function(l){return Pw(l)*d(l)}}function Pw(d){return d===0?1:Math.sin(Math.PI*d)/(Math.PI*d)}class Dw{constructor(l,u,h){let p=2*Math.PI*h/u,_=0;this.filters=[];for(let y=0;y<=l;y++)y-l/2===0?this.filters[y]=p:(this.filters[y]=Math.sin(p*(y-l/2))/(y-l/2),this.filters[y]*=.54-.46*Math.cos(2*Math.PI*y/l)),_=_+this.filters[y];for(let y=0;y<=l;y++)this.filters[y]/=_;this.z=this.initZ_()}filter(l){this.z.buf[this.z.pointer]=l;let u=0;for(let h=0,p=this.z.buf.length;h<p;h++)u+=this.filters[h]*this.z.buf[(this.z.pointer+h)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,u}reset(){this.z=this.initZ_()}initZ_(){let l=[];for(let u=0;u<this.filters.length-1;u++)l.push(0);return{buf:l,pointer:0}}}class Rw{constructor(l,u,h){let p=[];for(let _=0;_<l;_++)p.push(this.getCoeffs_({Fs:u,Fc:h,Q:.5/Math.sin(Math.PI/(l*2)*(_+.5))}));this.stages=[];for(let _=0;_<p.length;_++)this.stages[_]={b0:p[_].b[0],b1:p[_].b[1],b2:p[_].b[2],a1:p[_].a[0],a2:p[_].a[1],k:p[_].k,z:[0,0]}}filter(l){let u=l;for(let h=0,p=this.stages.length;h<p;h++)u=this.runStage_(h,u);return u}getCoeffs_(l){let u={};u.z=[0,0],u.a=[],u.b=[];let h=this.preCalc_(l,u);return u.k=1,u.b.push((1-h.cw)/(2*h.a0)),u.b.push(2*u.b[0]),u.b.push(u.b[0]),u}preCalc_(l,u){let h={},p=2*Math.PI*l.Fc/l.Fs;return h.alpha=Math.sin(p)/(2*l.Q),h.cw=Math.cos(p),h.a0=1+h.alpha,u.a0=h.a0,u.a.push(-2*h.cw/h.a0),u.k=1,u.a.push((1-h.alpha)/h.a0),h}runStage_(l,u){let h=u*this.stages[l].k-this.stages[l].a1*this.stages[l].z[0]-this.stages[l].a2*this.stages[l].z[1],p=this.stages[l].b0*h+this.stages[l].b1*this.stages[l].z[0]+this.stages[l].b2*this.stages[l].z[1];return this.stages[l].z[1]=this.stages[l].z[0],this.stages[l].z[0]=h,p}reset(){for(let l=0;l<this.stages.length;l++)this.stages[l].z=[0,0]}}const Mw={point:!1,linear:!1,cubic:!0,sinc:!0},Cd={IIR:16,FIR:71},Ow={IIR:Rw,FIR:Dw};function Nw(d,l,u,h={}){let p=(u-l)/l+1,_=new Float64Array(d.length*p);h.method=h.method||"cubic";let y=new Fw(d.length,_.length,{method:h.method,tension:h.tension||0,sincFilterSize:h.sincFilterSize||6,sincWindow:h.sincWindow||void 0});if(h.LPF===void 0&&(h.LPF=Mw[h.method]),h.LPF){h.LPFType=h.LPFType||"IIR";const s=Ow[h.LPFType];if(u>l){let b=new s(h.LPFOrder||Cd[h.LPFType],u,l/2);Gw(d,_,y,b)}else{let b=new s(h.LPFOrder||Cd[h.LPFType],l,u/2);Hw(d,_,y,b)}}else nc(d,_,y);return _}function nc(d,l,u){for(let h=0,p=l.length;h<p;h++)l[h]=u.interpolate(h,d)}function Gw(d,l,u,h){for(let p=0,_=l.length;p<_;p++)l[p]=h.filter(u.interpolate(p,d));h.reset();for(let p=l.length-1;p>=0;p--)l[p]=h.filter(l[p])}function Hw(d,l,u,h){for(let p=0,_=d.length;p<_;p++)d[p]=h.filter(d[p]);h.reset();for(let p=d.length-1;p>=0;p--)d[p]=h.filter(d[p]);nc(d,l,u)}var Yw=Object.defineProperty,rc=d=>{throw TypeError(d)},Vw=(d,l,u)=>l in d?Yw(d,l,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[l]=u,_e=(d,l,u)=>Vw(d,typeof l!="symbol"?l+"":l,u),Pu=(d,l,u)=>l.has(d)||rc("Cannot "+u),T=(d,l,u)=>(Pu(d,l,"read from private field"),u?u.call(d):l.get(d)),st=(d,l,u)=>l.has(d)?rc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(d):l.set(d,u),tt=(d,l,u,h)=>(Pu(d,l,"write to private field"),l.set(d,u),u),Ri=(d,l,u)=>(Pu(d,l,"access private method"),u);function $w(d){if(d.format==="f32-planar"){const l=[];for(let u=0;u<d.numberOfChannels;u+=1){const h=d.allocationSize({planeIndex:u}),p=new ArrayBuffer(h);d.copyTo(p,{planeIndex:u}),l.push(new Float32Array(p))}return l}else if(d.format==="f32"){const l=new ArrayBuffer(d.allocationSize({planeIndex:0}));return d.copyTo(l,{planeIndex:0}),Xw(new Float32Array(l),d.numberOfChannels)}else if(d.format==="s16"){const l=new ArrayBuffer(d.allocationSize({planeIndex:0}));return d.copyTo(l,{planeIndex:0}),Ww(new Int16Array(l),d.numberOfChannels)}throw Error("Unsupported audio data format")}function Ww(d,l){const u=d.length/l,h=Array.from({length:l},()=>new Float32Array(u));for(let p=0;p<u;p++)for(let _=0;_<l;_++){const y=d[p*l+_];h[_][p]=y/32768}return h}function Xw(d,l){const u=d.length/l,h=Array.from({length:l},()=>new Float32Array(u));for(let p=0;p<u;p++)for(let _=0;_<l;_++)h[_][p]=d[p*l+_];return h}function sc(d){return Array(d.numberOfChannels).fill(0).map((l,u)=>d.getChannelData(u))}async function qw(d,l){var u;const h={type:l,data:d},p=new ImageDecoder(h);await Promise.all([p.completed,p.tracks.ready]);let _=((u=p.tracks.selectedTrack)==null?void 0:u.frameCount)??1;const y=[];for(let s=0;s<_;s+=1)y.push((await p.decode({frameIndex:s})).image);return y}async function jw(d,l,u){const h=d.length,p=Array(u.chanCount).fill(0).map(()=>new Float32Array(0));if(h===0)return p;const _=Math.max(...d.map(A=>A.length));if(_===0)return p;if(globalThis.OfflineAudioContext==null)return d.map(A=>new Float32Array(Nw(A,l,u.rate,{method:"sinc",LPF:!1})));const y=new globalThis.OfflineAudioContext(u.chanCount,_*u.rate/l,u.rate),s=y.createBufferSource(),b=y.createBuffer(h,_,l);return d.forEach((A,B)=>b.copyToChannel(A,B)),s.buffer=b,s.connect(y.destination),s.start(),sc(await y.startRendering())}function Du(d){return new Promise(l=>{const u=ku(()=>{u(),l()},d)})}function Td(d,l,u){const h=u-l,p=new Float32Array(h);let _=0;for(;_<h;)p[_]=d[(l+_)%d.length],_+=1;return p}function ac(d,l){const u=Math.floor(d.length/l),h=new Float32Array(u);for(let p=0;p<u;p++){const _=p*l,y=Math.floor(_),s=_-y;y+1<d.length?h[p]=d[y]*(1-s)+d[y+1]*s:h[p]=d[y]}return h}const ce={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function Kw(d,l){const u=l.videoTracks[0],h={};if(u!=null){const _=Zw(d.getTrackById(u.id)).buffer,{descKey:y,type:s}=u.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:u.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};y!==""&&(h.videoTrackConf={timescale:u.timescale,duration:u.duration,width:u.video.width,height:u.video.height,brands:l.brands,type:s,[y]:_}),h.videoDecoderConf={codec:u.codec,codedHeight:u.video.height,codedWidth:u.video.width,description:_}}const p=l.audioTracks[0];if(p!=null){const _=Ad(d);h.audioTrackConf={timescale:p.timescale,samplerate:p.audio.sample_rate,channel_count:p.audio.channel_count,hdlr:"soun",type:p.codec.startsWith("mp4a")?"mp4a":p.codec,description:Ad(d)},h.audioDecoderConf={codec:p.codec.startsWith("mp4a")?ce.codec:p.codec,numberOfChannels:p.audio.channel_count,sampleRate:p.audio.sample_rate,..._==null?{}:Jw(_)}}return h}function Zw(d){for(const l of d.mdia.minf.stbl.stsd.entries){const u=l.avcC??l.hvcC??l.av1C??l.vpcC;if(u!=null){const h=new uu.DataStream(void 0,0,uu.DataStream.BIG_ENDIAN);return u.write(h),new Uint8Array(h.buffer.slice(8))}}throw Error("avcC, hvcC, av1C or VPX not found")}function Ad(d,l="mp4a"){var u;const h=(u=d.moov)==null?void 0:u.traks.map(p=>p.mdia.minf.stbl.stsd.entries).flat().find(({type:p})=>p===l);return h==null?void 0:h.esds}function Jw(d){var l;const u=(l=d.esd.descs[0])==null?void 0:l.descs[0];if(u==null)return{};const[h,p]=u.data,_=((h&7)<<1)+(p>>7),y=(p&127)>>3;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][_],numberOfChannels:y}}async function Qw(d,l,u){const h=uu.createFile(!1);h.onReady=_=>{var y,s;l({mp4boxFile:h,info:_});const b=(y=_.videoTracks[0])==null?void 0:y.id;b!=null&&h.setExtractionOptions(b,"video",{nbSamples:100});const A=(s=_.audioTracks[0])==null?void 0:s.id;A!=null&&h.setExtractionOptions(A,"audio",{nbSamples:100}),h.start()},h.onSamples=u,await p();async function p(){let _=0;const y=30*1024*1024;for(;;){const s=await d.read(y,{at:_});if(s.byteLength===0)break;s.fileStart=_;const b=h.appendBuffer(s);if(b==null)break;_=b}h.stop()}}let Ru=0;function tu(d){return d.kind==="file"&&d.createReader instanceof Function}var du,Wa,Xa,Wi,li,qa,Xi,Jn,Ds,Lr,ln,ui,Rs;const tx=class Pr{constructor(l,u={}){if(st(this,du,Ru++),st(this,Wa,kt.create(`MP4Clip id:${T(this,du)},`)),_e(this,"ready"),st(this,Xa,!1),st(this,Wi,{duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0}),st(this,li),st(this,qa,1),st(this,Xi,[]),st(this,Jn,[]),st(this,Ds,null),st(this,Lr,null),st(this,ln,{video:null,audio:null}),st(this,ui,{audio:!0}),_e(this,"tickInterceptor",async(p,_)=>_),st(this,Rs,new AbortController),!(l instanceof ReadableStream)&&!tu(l)&&!Array.isArray(l.videoSamples))throw Error("Illegal argument");tt(this,ui,{audio:!0,...u}),tt(this,qa,typeof u.audio=="object"&&"volume"in u.audio?u.audio.volume:1);const h=async p=>(await Fu(T(this,li),p),T(this,li));tt(this,li,tu(l)?l:"localFile"in l?l.localFile:lw()),this.ready=(l instanceof ReadableStream?h(l).then(p=>Id(p,T(this,ui))):tu(l)?Id(l,T(this,ui)):Promise.resolve(l)).then(async({videoSamples:p,audioSamples:_,decoderConf:y})=>{tt(this,Xi,p),tt(this,Jn,_),tt(this,ln,y);const{videoFrameFinder:s,audioFrameFinder:b}=ix({video:y.video==null?null:{...y.video,hardwareAcceleration:T(this,ui).__unsafe_hardwareAcceleration__},audio:y.audio},await T(this,li).createReader(),p,_,T(this,ui).audio!==!1?T(this,qa):0);return tt(this,Ds,s),tt(this,Lr,b),tt(this,Wi,ex(y,p,_)),T(this,Wa).info("MP4Clip meta:",T(this,Wi)),{...T(this,Wi)}})}get meta(){return{...T(this,Wi)}}async tick(l){var u,h,p;if(l>=T(this,Wi).duration)return await this.tickInterceptor(l,{audio:await((u=T(this,Lr))==null?void 0:u.find(l))??[],state:"done"});const[_,y]=await Promise.all([((h=T(this,Lr))==null?void 0:h.find(l))??[],(p=T(this,Ds))==null?void 0:p.find(l)]);return y==null?await this.tickInterceptor(l,{audio:_,state:"success"}):await this.tickInterceptor(l,{video:y,audio:_,state:"success"})}async thumbnails(l=100,u){T(this,Rs).abort(),tt(this,Rs,new AbortController);const h=T(this,Rs).signal;await this.ready;const p="generate thumbnails aborted";if(h.aborted)throw Error(p);const{width:_,height:y}=T(this,Wi),s=ox(l,Math.round(y*(l/_)),{quality:.1,type:"image/png"});return new Promise(async(b,A)=>{let B=[];const I=T(this,ln).video;if(I==null||T(this,Xi).length===0){U();return}h.addEventListener("abort",()=>{A(Error(p))});async function U(){h.aborted||b(await Promise.all(B.map(async o=>({ts:o.ts,img:await o.img}))))}function G(o){B.push({ts:o.timestamp,img:s(o)})}const{start:t=0,end:e=T(this,Wi).duration,step:n}=u??{};if(n){let o=t;const f=new oc(await T(this,li).createReader(),T(this,Xi),{...I,hardwareAcceleration:T(this,ui).__unsafe_hardwareAcceleration__});for(;o<=e&&!h.aborted;){const g=await f.find(o);g&&G(g),o+=n}f.destroy(),U()}else await dx(T(this,Xi),T(this,li),I,h,{start:t,end:e},(o,f)=>{o!=null&&G(o),f&&U()})})}async split(l){if(await this.ready,l<=0||l>=T(this,Wi).duration)throw Error('"time" out of bounds');const[u,h]=lx(T(this,Xi),l),[p,_]=ux(T(this,Jn),l),y=new Pr({localFile:T(this,li),videoSamples:u??[],audioSamples:p??[],decoderConf:T(this,ln)},T(this,ui)),s=new Pr({localFile:T(this,li),videoSamples:h??[],audioSamples:_??[],decoderConf:T(this,ln)},T(this,ui));return await Promise.all([y.ready,s.ready]),[y,s]}async clone(){await this.ready;const l=new Pr({localFile:T(this,li),videoSamples:[...T(this,Xi)],audioSamples:[...T(this,Jn)],decoderConf:T(this,ln)},T(this,ui));return await l.ready,l.tickInterceptor=this.tickInterceptor,l}async splitTrack(){await this.ready;const l=[];if(T(this,Xi).length>0){const u=new Pr({localFile:T(this,li),videoSamples:[...T(this,Xi)],audioSamples:[],decoderConf:{video:T(this,ln).video,audio:null}},T(this,ui));await u.ready,u.tickInterceptor=this.tickInterceptor,l.push(u)}if(T(this,Jn).length>0){const u=new Pr({localFile:T(this,li),videoSamples:[],audioSamples:[...T(this,Jn)],decoderConf:{audio:T(this,ln).audio,video:null}},T(this,ui));await u.ready,u.tickInterceptor=this.tickInterceptor,l.push(u)}return l}destroy(){var l,u;T(this,Xa)||(T(this,Wa).info("MP4Clip destroy"),tt(this,Xa,!0),(l=T(this,Ds))==null||l.destroy(),(u=T(this,Lr))==null||u.destroy())}};du=new WeakMap,Wa=new WeakMap,Xa=new WeakMap,Wi=new WeakMap,li=new WeakMap,qa=new WeakMap,Xi=new WeakMap,Jn=new WeakMap,Ds=new WeakMap,Lr=new WeakMap,ln=new WeakMap,ui=new WeakMap,Rs=new WeakMap;let Mu=tx;function ex(d,l,u){const h={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};d.video!=null&&l.length>0&&(h.width=d.video.codedWidth??0,h.height=d.video.codedHeight??0),d.audio!=null&&u.length>0&&(h.audioSampleRate=ce.sampleRate,h.audioChanCount=ce.channelCount);let p=0,_=0;if(l.length>0)for(let y=l.length-1;y>=0;y--){const s=l[y];if(!s.deleted){p=s.cts+s.duration;break}}if(u.length>0){const y=u.at(-1);_=y.cts+y.duration}return h.duration=Math.max(p,_),h}function ix(d,l,u,h,p){return{audioFrameFinder:p===0||d.audio==null||h.length===0?null:new rx(l,h,d.audio,{volume:p,targetSampleRate:ce.sampleRate}),videoFrameFinder:d.video==null||u.length===0?null:new oc(l,u,d.video)}}async function Id(d,l={}){let u=null;const h={video:null,audio:null};let p=[],_=[],y=-1,s=-1;const b=await d.createReader();await Qw(b,I=>{u=I.info;let{videoDecoderConf:U,audioDecoderConf:G}=Kw(I.mp4boxFile,I.info);h.video=U??null,h.audio=G??null,U==null&&G==null&&kt.error("MP4Clip no video and audio track"),kt.info("mp4BoxFile moov ready",{...I.info,tracks:null,videoTracks:null,audioTracks:null},h)},(I,U,G)=>{if(U==="video"){y===-1&&(y=G[0].dts);for(const t of G)p.push(B(t,y,"video"))}else if(U==="audio"&&l.audio){s===-1&&(s=G[0].dts);for(const t of G)_.push(B(t,s,"audio"))}}),await b.close();const A=p.at(-1)??_.at(-1);if(u==null)throw Error("MP4Clip stream is done, but not emit ready");if(A==null)throw Error("MP4Clip stream not contain any sample");return gu(p),kt.info("mp4 stream parsed"),{videoSamples:p,audioSamples:_,decoderConf:h};function B(I,U=0,G){const t=G==="video"&&I.is_sync&&fx(I.data,I.description.type);let e=I.offset,n=I.size;if(t){const o=hx(I.data,I.description.type);e+=o,n-=o}return{...I,is_idr:t,offset:e,size:n,cts:(I.cts-U)/I.timescale*1e6,dts:(I.dts-U)/I.timescale*1e6,duration:I.duration/I.timescale*1e6,timescale:1e6,data:G==="video"?null:I.data}}}var We,Dr,Rr,ja,Mr,un,bi,Fn,Qn,Or,Ms,tr,Ka,Nr,Za;class oc{constructor(l,u,h){st(this,We,null),st(this,Dr,0),st(this,Rr,{abort:!1,st:performance.now()}),_e(this,"find",async p=>{(T(this,We)==null||T(this,We).state==="closed"||p<=T(this,Dr)||p-T(this,Dr)>3e6)&&T(this,Nr).call(this,p),T(this,Rr).abort=!0,tt(this,Dr,p),tt(this,Rr,{abort:!1,st:performance.now()});const _=await T(this,Ms).call(this,p,T(this,We),T(this,Rr));return tt(this,Or,0),_}),st(this,ja,0),st(this,Mr,!1),st(this,un,0),st(this,bi,[]),st(this,Fn,0),st(this,Qn,0),st(this,Or,0),st(this,Ms,async(p,_,y)=>{if(_==null||_.state==="closed"||y.abort)return null;if(T(this,bi).length>0){const s=T(this,bi)[0];return p<s.timestamp?null:(T(this,bi).shift(),p>s.timestamp+(s.duration??0)?(s.close(),await T(this,Ms).call(this,p,_,y)):(T(this,bi).length<10&&T(this,Ka).call(this,_).catch(b=>{throw T(this,Nr).call(this,p),b}),s))}if(T(this,tr)||T(this,Fn)<T(this,Qn)&&_.decodeQueueSize>0){if(performance.now()-y.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(T(this,Za).call(this))}`);tt(this,Or,T(this,Or)+1),await Du(15)}else{if(T(this,un)>=this.samples.length)return null;try{await T(this,Ka).call(this,_)}catch(s){throw T(this,Nr).call(this,p),s}}return await T(this,Ms).call(this,p,_,y)}),st(this,tr,!1),st(this,Ka,async p=>{var _,y;if(T(this,tr)||p.decodeQueueSize>600)return;let s=T(this,un)+1;if(s>this.samples.length)return;tt(this,tr,!0);let b=!1;for(;s<this.samples.length;s++){const A=this.samples[s];if(!b&&!A.deleted&&(b=!0),A.is_idr)break}if(b){const A=this.samples.slice(T(this,un),s);if(((_=A[0])==null?void 0:_.is_idr)!==!0)kt.warn("First sample not idr frame");else{const B=performance.now(),I=await lc(A,this.localFileReader),U=performance.now()-B;if(U>1e3){const G=A[0],t=A.at(-1),e=t.offset+t.size-G.offset;kt.warn(`Read video samples time cost: ${Math.round(U)}ms, file chunk size: ${e}`)}if(p.state==="closed")return;tt(this,ja,((y=I[0])==null?void 0:y.duration)??0),_u(p,I,{onDecodingError:G=>{if(T(this,Mr))throw G;T(this,Fn)===0&&(tt(this,Mr,!0),kt.warn("Downgrade to software decode"),T(this,Nr).call(this))}}),tt(this,Qn,T(this,Qn)+I.length)}}tt(this,un,s),tt(this,tr,!1)}),st(this,Nr,p=>{var _,y;if(tt(this,tr,!1),T(this,bi).forEach(b=>b.close()),tt(this,bi,[]),p==null||p===0)tt(this,un,0);else{let b=0;for(let A=0;A<this.samples.length;A++){const B=this.samples[A];if(B.is_idr&&(b=A),!(B.cts<p)){tt(this,un,b);break}}}tt(this,Qn,0),tt(this,Fn,0),((_=T(this,We))==null?void 0:_.state)!=="closed"&&((y=T(this,We))==null||y.close());const s={...this.conf,...T(this,Mr)?{hardwareAcceleration:"prefer-software"}:{}};tt(this,We,new VideoDecoder({output:b=>{if(tt(this,Fn,T(this,Fn)+1),b.timestamp===-1){b.close();return}let A=b;b.duration==null&&(A=new VideoFrame(b,{duration:T(this,ja)}),b.close()),T(this,bi).push(A)},error:b=>{if(b.message.includes("Codec reclaimed due to inactivity")){tt(this,We,null);return}const A=`VideoFinder VideoDecoder err: ${b.message}, config: ${JSON.stringify(s)}, state: ${JSON.stringify(T(this,Za).call(this))}`;throw kt.error(A),Error(A)}})),T(this,We).configure(s)}),st(this,Za,()=>{var p,_;return{time:T(this,Dr),decState:(p=T(this,We))==null?void 0:p.state,decQSize:(_=T(this,We))==null?void 0:_.decodeQueueSize,decCusorIdx:T(this,un),sampleLen:this.samples.length,inputCnt:T(this,Qn),outputCnt:T(this,Fn),cacheFrameLen:T(this,bi).length,softDeocde:T(this,Mr),clipIdCnt:Ru,sleepCnt:T(this,Or),memInfo:uc()}}),_e(this,"destroy",()=>{var p,_;((p=T(this,We))==null?void 0:p.state)!=="closed"&&((_=T(this,We))==null||_.close()),tt(this,We,null),T(this,Rr).abort=!0,T(this,bi).forEach(y=>y.close()),tt(this,bi,[]),this.localFileReader.close()}),this.localFileReader=l,this.samples=u,this.conf=h}}We=new WeakMap,Dr=new WeakMap,Rr=new WeakMap,ja=new WeakMap,Mr=new WeakMap,un=new WeakMap,bi=new WeakMap,Fn=new WeakMap,Qn=new WeakMap,Or=new WeakMap,Ms=new WeakMap,tr=new WeakMap,Ka=new WeakMap,Nr=new WeakMap,Za=new WeakMap;function nx(d,l){for(let u=0;u<l.length;u++){const h=l[u];if(d>=h.cts&&d<h.cts+h.duration)return u;if(h.cts>d)break}return 0}var Ja,Qa,qi,Gr,hn,kn,Li,Hr,to,eo,cu,pu;class rx{constructor(l,u,h,p){st(this,Ja,1),st(this,Qa),st(this,qi,null),st(this,Gr,{abort:!1,st:performance.now()}),_e(this,"find",async _=>{const y=_<=T(this,hn)||_-T(this,hn)>1e5;(T(this,qi)==null||T(this,qi).state==="closed"||y)&&T(this,cu).call(this),y&&(tt(this,hn,_),tt(this,kn,nx(_,this.samples))),T(this,Gr).abort=!0;const s=_-T(this,hn);tt(this,hn,_),tt(this,Gr,{abort:!1,st:performance.now()});const b=await T(this,to).call(this,Math.ceil(s*(T(this,Qa)/1e6)),T(this,qi),T(this,Gr));return tt(this,Hr,0),b}),st(this,hn,0),st(this,kn,0),st(this,Li,{frameCnt:0,data:[]}),st(this,Hr,0),st(this,to,async(_,y=null,s)=>{if(y==null||s.abort||y.state==="closed"||_===0)return[];const b=T(this,Li).frameCnt-_;if(b>0)return b<ce.sampleRate/10&&T(this,eo).call(this,y),Bd(T(this,Li),_);if(y.decoding){if(performance.now()-s.st>3e3)throw s.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(T(this,pu).call(this))}`);tt(this,Hr,T(this,Hr)+1),await Du(15)}else{if(T(this,kn)>=this.samples.length-1)return Bd(T(this,Li),T(this,Li).frameCnt);T(this,eo).call(this,y)}return T(this,to).call(this,_,y,s)}),st(this,eo,_=>{if(_.decodeQueueSize>10)return;const y=[];let s=T(this,kn);for(;s<this.samples.length;){const b=this.samples[s];if(s+=1,!b.deleted&&(y.push(b),y.length>=10))break}tt(this,kn,s),_.decode(y.map(b=>new EncodedAudioChunk({type:"key",timestamp:b.cts,duration:b.duration,data:b.data})))}),st(this,cu,()=>{var _;tt(this,hn,0),tt(this,kn,0),tt(this,Li,{frameCnt:0,data:[]}),(_=T(this,qi))==null||_.close(),tt(this,qi,sx(this.conf,{resampleRate:ce.sampleRate,volume:T(this,Ja)},y=>{T(this,Li).data.push(y),T(this,Li).frameCnt+=y[0].length}))}),st(this,pu,()=>{var _,y;return{time:T(this,hn),decState:(_=T(this,qi))==null?void 0:_.state,decQSize:(y=T(this,qi))==null?void 0:y.decodeQueueSize,decCusorIdx:T(this,kn),sampleLen:this.samples.length,pcmLen:T(this,Li).frameCnt,clipIdCnt:Ru,sleepCnt:T(this,Hr),memInfo:uc()}}),_e(this,"destroy",()=>{tt(this,qi,null),T(this,Gr).abort=!0,tt(this,Li,{frameCnt:0,data:[]}),this.localFileReader.close()}),this.localFileReader=l,this.samples=u,this.conf=h,tt(this,Ja,p.volume),tt(this,Qa,p.targetSampleRate)}}Ja=new WeakMap,Qa=new WeakMap,qi=new WeakMap,Gr=new WeakMap,hn=new WeakMap,kn=new WeakMap,Li=new WeakMap,Hr=new WeakMap,to=new WeakMap,eo=new WeakMap,cu=new WeakMap,pu=new WeakMap;function sx(d,l,u){let h=0,p=0;const _=B=>{if(p+=1,B.length!==0){if(l.volume!==1)for(const I of B)for(let U=0;U<I.length;U++)I[U]*=l.volume;B.length===1&&(B=[B[0],B[0]]),u(B)}},y=ax(_),s=l.resampleRate!==d.sampleRate;let b=new AudioDecoder({output:B=>{const I=$w(B);s?y(()=>jw(I,B.sampleRate,{rate:l.resampleRate,chanCount:B.numberOfChannels})):_(I),B.close()},error:B=>{B.message.includes("Codec reclaimed due to inactivity")||A("MP4Clip AudioDecoder err",B)}});b.configure(d);function A(B,I){const U=`${B}: ${I.message}, state: ${JSON.stringify({qSize:b.decodeQueueSize,state:b.state,inputCnt:h,outputCnt:p})}`;throw kt.error(U),Error(U)}return{decode(B){h+=B.length;try{for(const I of B)b.decode(I)}catch(I){A("decode audio chunk error",I)}},close(){b.state!=="closed"&&b.close()},get decoding(){return h>p&&b.decodeQueueSize>0},get state(){return b.state},get decodeQueueSize(){return b.decodeQueueSize}}}function ax(d){const l=[];let u=0;function h(y,s){l[s]=y,p()}function p(){const y=l[u];y!=null&&(d(y),u+=1,p())}let _=0;return y=>{const s=_;_+=1,y().then(b=>h(b,s)).catch(b=>h(b,s))}}function Bd(d,l){const u=[new Float32Array(l),new Float32Array(l)];let h=0,p=0;for(;p<d.data.length;){const[_,y]=d.data[p];if(h+_.length>l){const s=l-h;u[0].set(_.subarray(0,s),h),u[1].set(y.subarray(0,s),h),d.data[p][0]=_.subarray(s,_.length),d.data[p][1]=y.subarray(s,y.length);break}else u[0].set(_,h),u[1].set(y,h),h+=_.length,p++}return d.data=d.data.slice(p),d.frameCnt-=l,u}async function lc(d,l){const u=d[0],h=d.at(-1);if(h==null)return[];const p=h.offset+h.size-u.offset;if(p<3e7){const _=new Uint8Array(await l.read(p,{at:u.offset}));return d.map(y=>{const s=y.offset-u.offset;return new EncodedVideoChunk({type:y.is_sync?"key":"delta",timestamp:y.cts,duration:y.duration,data:_.subarray(s,s+y.size)})})}return await Promise.all(d.map(async _=>new EncodedVideoChunk({type:_.is_sync?"key":"delta",timestamp:_.cts,duration:_.duration,data:await l.read(_.size,{at:_.offset})})))}function ox(d,l,u){const h=new OffscreenCanvas(d,l),p=h.getContext("2d");return async _=>(p.drawImage(_,0,0,d,l),_.close(),await h.convertToBlob(u))}function lx(d,l){if(d.length===0)return[];let u=0,h=0,p=-1;for(let b=0;b<d.length;b++){const A=d[b];if(p===-1&&l<A.cts&&(p=b-1),A.is_idr)if(p===-1)u=b;else{h=b;break}}const _=d[p];if(_==null)throw Error("Not found video sample by time");const y=d.slice(0,h===0?d.length:h).map(b=>({...b}));for(let b=u;b<y.length;b++){const A=y[b];l<A.cts&&(A.deleted=!0,A.cts=-1)}gu(y);const s=d.slice(_.is_idr?p:u).map(b=>({...b,cts:b.cts-l}));for(const b of s)b.cts<0&&(b.deleted=!0,b.cts=-1);return gu(s),[y,s]}function ux(d,l){if(d.length===0)return[];let u=-1;for(let _=0;_<d.length;_++){const y=d[_];if(!(l>y.cts)){u=_;break}}if(u===-1)throw Error("Not found audio sample by time");const h=d.slice(0,u).map(_=>({..._})),p=d.slice(u).map(_=>({..._,cts:_.cts-l}));return[h,p]}function _u(d,l,u){let h=0;if(d.state==="configured"){for(;h<l.length;h++)d.decode(l[h]);d.flush().catch(p=>{if(!(p instanceof Error))throw p;if(p.message.includes("Decoding error")&&u.onDecodingError!=null){u.onDecodingError(p);return}if(!p.message.includes("Aborted due to close"))throw p})}}function hx(d,l){if(l!=="avc1"&&l!=="hvc1")return 0;const u=new DataView(d.buffer);if(l==="avc1"&&(u.getUint8(4)&31)===6)return u.getUint32(0)+4;if(l==="hvc1"){const h=u.getUint8(4)>>1&63;if(h===39||h===40)return u.getUint32(0)+4}return 0}function fx(d,l){if(l!=="avc1"&&l!=="hvc1")return!0;const u=new DataView(d.buffer);let h=0;for(;h<d.byteLength-4;){if(l==="avc1"&&(u.getUint8(h+4)&31)===5)return!0;if(l==="hvc1"){const p=u.getUint8(h+4)>>1&63;if(p===19||p===20)return!0}h+=u.getUint32(h)+4}return!1}async function dx(d,l,u,h,p,_){const y=await l.createReader(),s=await lc(d.filter(B=>!B.deleted&&B.is_sync&&B.cts>=p.start&&B.cts<=p.end),y);if(s.length===0||h.aborted)return;let b=0;_u(A(),s,{onDecodingError:B=>{kt.warn("thumbnailsByKeyFrame",B),b===0?_u(A(!0),s,{onDecodingError:I=>{y.close(),kt.error("thumbnailsByKeyFrame retry soft deocde",I)}}):(_(null,!0),y.close())}});function A(B=!1){const I={...u,...B?{hardwareAcceleration:"prefer-software"}:{}},U=new VideoDecoder({output:G=>{b+=1;const t=b===s.length;_(G,t),t&&(y.close(),U.state!=="closed"&&U.close())},error:G=>{const t=`thumbnails decoder error: ${G.message}, config: ${JSON.stringify(I)}, state: ${JSON.stringify({qSize:U.decodeQueueSize,state:U.state,outputCnt:b,inputCnt:s.length})}`;throw kt.error(t),Error(t)}});return h.addEventListener("abort",()=>{y.close(),U.state!=="closed"&&U.close()}),U.configure(I),U}}function gu(d){let l=0,u=null;for(const h of d)if(!h.deleted){if(h.is_sync&&(l+=1),l>=2)break;(u==null||h.cts<u.cts)&&(u=h)}u!=null&&u.cts<2e5&&(u.duration+=u.cts,u.cts=0)}function uc(){try{const d=performance.memory;return{jsHeapSizeLimit:d.jsHeapSizeLimit,totalJSHeapSize:d.totalJSHeapSize,usedJSHeapSize:d.usedJSHeapSize,percentUsed:(d.usedJSHeapSize/d.jsHeapSizeLimit).toFixed(3),percentTotal:(d.totalJSHeapSize/d.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}var Qe,Pi,He,mu,hc;const cx=class Yr{constructor(l){st(this,mu),_e(this,"ready"),st(this,Qe,{duration:0,width:0,height:0}),st(this,Pi,null),st(this,He,[]);const u=h=>(tt(this,Pi,h),T(this,Qe).width=h.width,T(this,Qe).height=h.height,T(this,Qe).duration=1/0,{...T(this,Qe)});if(l instanceof ReadableStream)this.ready=new Response(l).blob().then(h=>createImageBitmap(h)).then(u);else if(l instanceof ImageBitmap)this.ready=Promise.resolve(u(l));else if(Array.isArray(l)&&l.every(h=>h instanceof VideoFrame)){tt(this,He,l);const h=T(this,He)[0];if(h==null)throw Error("The frame count must be greater than 0");tt(this,Qe,{width:h.displayWidth,height:h.displayHeight,duration:T(this,He).reduce((p,_)=>p+(_.duration??0),0)}),this.ready=Promise.resolve({...T(this,Qe),duration:1/0})}else if("type"in l)this.ready=Ri(this,mu,hc).call(this,l.stream,l.type).then(()=>({width:T(this,Qe).width,height:T(this,Qe).height,duration:1/0}));else throw Error("Illegal arguments")}get meta(){return{...T(this,Qe)}}async tick(l){if(T(this,Pi)!=null)return{video:await createImageBitmap(T(this,Pi)),state:"success"};const u=l%T(this,Qe).duration;return{video:(T(this,He).find(h=>u>=h.timestamp&&u<=h.timestamp+(h.duration??0))??T(this,He)[0]).clone(),state:"success"}}async split(l){if(await this.ready,T(this,Pi)!=null)return[new Yr(await createImageBitmap(T(this,Pi))),new Yr(await createImageBitmap(T(this,Pi)))];let u=-1;for(let _=0;_<T(this,He).length;_++){const y=T(this,He)[_];if(!(l>y.timestamp)){u=_;break}}if(u===-1)throw Error("Not found frame by time");const h=T(this,He).slice(0,u).map(_=>new VideoFrame(_)),p=T(this,He).slice(u).map(_=>new VideoFrame(_,{timestamp:_.timestamp-l}));return[new Yr(h),new Yr(p)]}async clone(){await this.ready;const l=T(this,Pi)==null?T(this,He).map(u=>u.clone()):await createImageBitmap(T(this,Pi));return new Yr(l)}destroy(){var l;kt.info("ImgClip destroy"),(l=T(this,Pi))==null||l.close(),T(this,He).forEach(u=>u.close())}};Qe=new WeakMap,Pi=new WeakMap,He=new WeakMap,mu=new WeakSet,hc=async function(d,l){tt(this,He,await qw(d,l));const u=T(this,He)[0];if(u==null)throw Error("No frame available in gif");tt(this,Qe,{duration:T(this,He).reduce((h,p)=>h+(p.duration??0),0),width:u.codedWidth,height:u.codedHeight}),kt.info("ImgClip ready:",T(this,Qe))};let bo=cx;var Jr,Dn,or,cn,vu,fc,er,fn;const Os=class io{constructor(l,u={}){st(this,vu),_e(this,"ready"),st(this,Jr,{duration:0,width:0,height:0}),st(this,Dn,new Float32Array),st(this,or,new Float32Array),st(this,cn),st(this,er,0),st(this,fn,0),tt(this,cn,{loop:!1,volume:1,...u}),this.ready=Ri(this,vu,fc).call(this,l).then(()=>({width:0,height:0,duration:u.loop?1/0:T(this,Jr).duration}))}get meta(){return{...T(this,Jr),sampleRate:ce.sampleRate,chanCount:2}}getPCMData(){return[T(this,Dn),T(this,or)]}async tick(l){if(!T(this,cn).loop&&l>=T(this,Jr).duration)return{audio:[],state:"done"};const u=l-T(this,er);if(l<T(this,er)||u>3e6)return tt(this,er,l),tt(this,fn,Math.ceil(T(this,er)/1e6*ce.sampleRate)),{audio:[new Float32Array(0),new Float32Array(0)],state:"success"};tt(this,er,l);const h=Math.ceil(u/1e6*ce.sampleRate),p=T(this,fn)+h,_=T(this,cn).loop?[Td(T(this,Dn),T(this,fn),p),Td(T(this,or),T(this,fn),p)]:[T(this,Dn).slice(T(this,fn),p),T(this,or).slice(T(this,fn),p)];return tt(this,fn,p),{audio:_,state:"success"}}async split(l){await this.ready;const u=Math.ceil(l/1e6*ce.sampleRate),h=new io(this.getPCMData().map(_=>_.slice(0,u)),T(this,cn)),p=new io(this.getPCMData().map(_=>_.slice(u)),T(this,cn));return[h,p]}async clone(){await this.ready;const l=new io(this.getPCMData(),T(this,cn));return await l.ready,l}destroy(){tt(this,Dn,new Float32Array(0)),tt(this,or,new Float32Array(0)),kt.info("---- audioclip destroy ----")}};Jr=new WeakMap,Dn=new WeakMap,or=new WeakMap,cn=new WeakMap,vu=new WeakSet,fc=async function(d){Os.ctx==null&&(Os.ctx=new AudioContext({sampleRate:ce.sampleRate}));const l=performance.now(),u=d instanceof ReadableStream?await px(d,Os.ctx):d;kt.info("Audio clip decoded complete:",performance.now()-l);const h=T(this,cn).volume;if(h!==1)for(const p of u)for(let _=0;_<p.length;_+=1)p[_]*=h;T(this,Jr).duration=u[0].length/ce.sampleRate*1e6,tt(this,Dn,u[0]),tt(this,or,u[1]??T(this,Dn)),kt.info("Audio clip convert to AudioData, time:",performance.now()-l)},er=new WeakMap,fn=new WeakMap,_e(Os,"ctx",null);let Ou=Os;async function px(d,l){const u=await new Response(d).arrayBuffer();return sc(await l.decodeAudioData(u))}var Vr,no,$r,Ns;const dc=class cc{constructor(l){_e(this,"ready"),st(this,Vr,{duration:0,width:0,height:0}),st(this,no,()=>{}),_e(this,"audioTrack"),st(this,$r,null),st(this,Ns),tt(this,Ns,l);const u=l.getVideoTracks()[0];if(u!=null){const{width:h,height:p}=u.getSettings();u.contentHint="motion",T(this,Vr).width=h??0,T(this,Vr).height=p??0,tt(this,$r,new OffscreenCanvas(h??0,p??0)),tt(this,no,gx(T(this,$r).getContext("2d"),u))}this.audioTrack=l.getAudioTracks()[0]??null,T(this,Vr).duration=1/0,this.ready=Promise.resolve(this.meta)}get meta(){return{...T(this,Vr)}}async tick(){return{video:T(this,$r)==null?null:await createImageBitmap(T(this,$r)),audio:[],state:"success"}}async split(){return[await this.clone(),await this.clone()]}async clone(){return new cc(T(this,Ns).clone())}destroy(){T(this,Ns).getTracks().forEach(l=>l.stop()),T(this,no).call(this)}};Vr=new WeakMap,no=new WeakMap,$r=new WeakMap,Ns=new WeakMap,_e(dc,"ctx",null);let _x=dc;function gx(d,l){return vw(new MediaStreamTrackProcessor({track:l}).readable,{onChunk:async u=>{d.drawImage(u,0,0),u.close()},onDone:async()=>{}})}var So,Uo,Eo,Co,To,Ao,ir,Wr,nr;const mx=class pc{constructor(l,u,h,p,_){st(this,ir),st(this,So,new pr),_e(this,"on",T(this,So).on),st(this,Uo,0),st(this,Eo,0),st(this,Co,0),st(this,To,0),st(this,Ao,0),st(this,nr,null),_e(this,"fixedAspectRatio",!1),_e(this,"fixedScaleCenter",!1),this.x=l??0,this.y=u??0,this.w=h??0,this.h=p??0,tt(this,nr,_??null)}get x(){return T(this,Uo)}set x(l){Ri(this,ir,Wr).call(this,"x",l)}get y(){return T(this,Eo)}set y(l){Ri(this,ir,Wr).call(this,"y",l)}get w(){return T(this,Co)}set w(l){Ri(this,ir,Wr).call(this,"w",l)}get h(){return T(this,To)}set h(l){Ri(this,ir,Wr).call(this,"h",l)}get angle(){return T(this,Ao)}set angle(l){Ri(this,ir,Wr).call(this,"angle",l)}get center(){const{x:l,y:u,w:h,h:p}=this;return{x:l+h/2,y:u+p/2}}clone(){const{x:l,y:u,w:h,h:p}=this,_=new pc(l,u,h,p,T(this,nr));return _.angle=this.angle,_.fixedAspectRatio=this.fixedAspectRatio,_.fixedScaleCenter=this.fixedScaleCenter,_}checkHit(l,u){var h,p;let{angle:_,center:y,x:s,y:b,w:A,h:B}=this;const I=((h=T(this,nr))==null?void 0:h.center)??y,U=((p=T(this,nr))==null?void 0:p.angle)??_;T(this,nr)==null&&(s=s-I.x,b=b-I.y);const G=l-I.x,t=u-I.y;let e=G,n=t;return U!==0&&(e=G*Math.cos(U)+t*Math.sin(U),n=t*Math.cos(U)-G*Math.sin(U)),!(e<s||e>s+A||n<b||n>b+B)}};So=new WeakMap,Uo=new WeakMap,Eo=new WeakMap,Co=new WeakMap,To=new WeakMap,Ao=new WeakMap,ir=new WeakSet,Wr=function(d,l){const u=this[d]!==l;switch(d){case"x":tt(this,Uo,l);break;case"y":tt(this,Eo,l);break;case"w":tt(this,Co,l);break;case"h":tt(this,To,l);break;case"angle":tt(this,Ao,l);break}u&&T(this,So).emit("propsChange",{[d]:l})},nr=new WeakMap;let ji=mx;var ro,Xr,Gs,rr,dn;class _c{constructor(){_e(this,"rect",new ji),st(this,ro,{offset:0,duration:0,playbackRate:1}),st(this,Xr,new pr),_e(this,"on",T(this,Xr).on),st(this,Gs,0),_e(this,"opacity",1),_e(this,"flip",null),st(this,rr,null),st(this,dn,null),_e(this,"ready",Promise.resolve()),this.rect.on("propsChange",l=>{T(this,Xr).emit("propsChange",{rect:l})})}get time(){return T(this,ro)}set time(l){Object.assign(T(this,ro),l)}get zIndex(){return T(this,Gs)}set zIndex(l){const u=T(this,Gs)!==l;tt(this,Gs,l),u&&T(this,Xr).emit("propsChange",{zIndex:l})}_render(l){const{rect:{center:u,angle:h}}=this;l.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,u.x,u.y),l.rotate((this.flip==null?1:-1)*h),l.globalAlpha=this.opacity}setAnimation(l,u){tt(this,rr,Object.entries(l).map(([h,p])=>{const _={from:0,to:100}[h]??Number(h.slice(0,-1));if(isNaN(_)||_>100||_<0)throw Error("keyFrame must between 0~100");return[_/100,p]})),tt(this,dn,Object.assign({},T(this,dn),{duration:u.duration,delay:u.delay??0,iterCount:u.iterCount??1/0}))}animate(l){if(T(this,rr)==null||T(this,dn)==null||l<T(this,dn).delay)return;const u=vx(l,T(this,rr),T(this,dn));for(const h in u)switch(h){case"opacity":this.opacity=u[h];break;case"x":case"y":case"w":case"h":case"angle":this.rect[h]=u[h];break}}copyStateTo(l){tt(l,rr,T(this,rr)),tt(l,dn,T(this,dn)),l.zIndex=this.zIndex,l.opacity=this.opacity,l.flip=this.flip,l.rect=this.rect.clone(),l.time={...this.time}}destroy(){T(this,Xr).destroy()}}ro=new WeakMap,Xr=new WeakMap,Gs=new WeakMap,rr=new WeakMap,dn=new WeakMap;function vx(d,l,u){const h=d-u.delay;if(h/u.duration>=u.iterCount)return{};const p=h%u.duration,_=h===u.duration?1:p/u.duration,y=l.findIndex(G=>G[0]>=_);if(y===-1)return{};const s=l[y-1],b=l[y],A=b[1];if(s==null)return A;const B=s[1],I={},U=(_-s[0])/(b[0]-s[0]);for(const G in A){const t=G;B[t]!=null&&(I[t]=(A[t]-B[t])*U+B[t])}return I}var qr,sr,so;const yx=class gc extends _c{constructor(l){super(),st(this,qr),st(this,sr,null),st(this,so,!1),tt(this,qr,l),this.ready=l.ready.then(({width:u,height:h,duration:p})=>{this.rect.w=this.rect.w===0?u:this.rect.w,this.rect.h=this.rect.h===0?h:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}async offscreenRender(l,u){var h;const p=u*this.time.playbackRate;this.animate(p),super._render(l);const{w:_,h:y}=this.rect,{video:s,audio:b,state:A}=await T(this,qr).tick(p);let B=b??[];if(b!=null&&this.time.playbackRate!==1&&(B=b.map(U=>ac(U,this.time.playbackRate))),A==="done")return{audio:B,done:!0};const I=s??T(this,sr);return I!=null&&l.drawImage(I,-_/2,-y/2,_,y),s!=null&&((h=T(this,sr))==null||h.close(),tt(this,sr,s)),{audio:B,done:!1}}async clone(){const l=new gc(await T(this,qr).clone());return await l.ready,this.copyStateTo(l),l}destroy(){var l;T(this,so)||(tt(this,so,!0),kt.info("OffscreenSprite destroy"),super.destroy(),(l=T(this,sr))==null||l.close(),tt(this,sr,null),T(this,qr).destroy())}};qr=new WeakMap,sr=new WeakMap,so=new WeakMap;let wx=yx;var Qr,fr,rs,Hs,ao,yu,oo,lo;const xx=class mc extends _c{constructor(l){super(),st(this,ao),st(this,Qr),_e(this,"visible",!0),st(this,fr,null),st(this,rs,[]),st(this,Hs,!1),st(this,oo,-1),st(this,lo,!1),tt(this,Qr,l),this.ready=l.ready.then(({width:u,height:h,duration:p})=>{this.rect.w=this.rect.w===0?u:this.rect.w,this.rect.h=this.rect.h===0?h:this.rect.h,this.time.duration=this.time.duration===0?p:this.time.duration})}getClip(){return T(this,Qr)}preFrame(l){Ri(this,ao,yu).call(this,l)}render(l,u){this.animate(u),super._render(l);const{w:h,h:p}=this.rect;T(this,oo)!==u&&Ri(this,ao,yu).call(this,u),tt(this,oo,u);const _=T(this,rs);tt(this,rs,[]);const y=T(this,fr);return y!=null&&l.drawImage(y,-h/2,-p/2,h,p),{audio:_}}copyStateTo(l){super.copyStateTo(l),l instanceof mc&&(l.visible=this.visible)}destroy(){var l;T(this,lo)||(tt(this,lo,!0),kt.info("VisibleSprite destroy"),super.destroy(),(l=T(this,fr))==null||l.close(),tt(this,fr,null),T(this,Qr).destroy())}};Qr=new WeakMap,fr=new WeakMap,rs=new WeakMap,Hs=new WeakMap,ao=new WeakSet,yu=function(d){T(this,Hs)||(tt(this,Hs,!0),T(this,Qr).tick(d*this.time.playbackRate).then(({video:l,audio:u})=>{var h;l!=null&&((h=T(this,fr))==null||h.close(),tt(this,fr,l??null)),tt(this,rs,u??[]),u!=null&&this.time.playbackRate!==1&&tt(this,rs,u.map(p=>ac(p,this.time.playbackRate)))}).finally(()=>{tt(this,Hs,!1)}))},oo=new WeakMap,lo=new WeakMap;let zs=xx,bx=0;async function vc(d){d()>50&&(await Du(15),await vc(d))}var pn,uo,Ki,Vs,Io,ho,ts,$s,ar,fo,yc,wc;class Sx{constructor(l={}){st(this,fo),st(this,pn,kt.create(`id:${bx++},`)),st(this,uo,!1),st(this,Ki,[]),st(this,Vs),st(this,Io),st(this,ho,null),st(this,ts),st(this,$s),st(this,ar,new pr),_e(this,"on",T(this,ar).on);const{width:u=0,height:h=0}=l;tt(this,Vs,new OffscreenCanvas(u,h));const p=T(this,Vs).getContext("2d",{alpha:!1});if(p==null)throw Error("Can not create 2d offscreen context");tt(this,Io,p),tt(this,ts,Object.assign({bgColor:"#000",width:0,height:0,videoCodec:"avc1.42E032",audio:!0,bitrate:5e6,fps:30,metaDataTags:null},l)),tt(this,$s,u*h>0)}static async isSupported(l={}){return(self.OffscreenCanvas!=null&&self.VideoEncoder!=null&&self.VideoDecoder!=null&&self.VideoFrame!=null&&self.AudioEncoder!=null&&self.AudioDecoder!=null&&self.AudioData!=null&&((await self.VideoEncoder.isConfigSupported({codec:l.videoCodec??"avc1.42E032",width:l.width??1920,height:l.height??1080,bitrate:l.bitrate??7e6})).supported??!1)&&(await self.AudioEncoder.isConfigSupported({codec:ce.codec,sampleRate:ce.sampleRate,numberOfChannels:ce.channelCount})).supported)??!1}async addSprite(l,u={}){const h={rect:Tx(["x","y","w","h"],l.rect),time:{...l.time},zIndex:l.zIndex};T(this,pn).info("Combinator add sprite",h);const p=await l.clone();T(this,pn).info("Combinator add sprite ready"),T(this,Ki).push(Object.assign(p,{main:u.main??!1,expired:!1})),T(this,Ki).sort((_,y)=>_.zIndex-y.zIndex)}output(){if(T(this,Ki).length===0)throw Error("No sprite added");const l=T(this,Ki).find(b=>b.main),u=l!=null?l.time.offset+l.time.duration:Math.max(...T(this,Ki).map(b=>b.time.offset+b.time.duration));if(u===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");u===-1&&T(this,pn).warn("Unable to determine the end time, process value don't update"),T(this,pn).info(`start combinate video, maxTime:${u}`);const h=Ri(this,fo,yc).call(this,u);let p=performance.now();const _=Ri(this,fo,wc).call(this,h,u,{onProgress:b=>{T(this,pn).debug("OutputProgress:",b),T(this,ar).emit("OutputProgress",b)},onEnded:async()=>{await h.flush(),T(this,pn).info("===== output ended =====, cost:",performance.now()-p),T(this,ar).emit("OutputProgress",1),this.destroy()},onError:b=>{T(this,ar).emit("error",b),s(b),this.destroy()}});tt(this,ho,()=>{_(),h.close(),s()});const{stream:y,stop:s}=yw(h.mp4file,500,this.destroy);return y}destroy(){var l;T(this,uo)||(tt(this,uo,!0),(l=T(this,ho))==null||l.call(this),T(this,ar).destroy())}}pn=new WeakMap,uo=new WeakMap,Ki=new WeakMap,Vs=new WeakMap,Io=new WeakMap,ho=new WeakMap,ts=new WeakMap,$s=new WeakMap,ar=new WeakMap,fo=new WeakSet,yc=function(d){const{fps:l,width:u,height:h,videoCodec:p,bitrate:_,audio:y,metaDataTags:s}=T(this,ts);return Tw({video:T(this,$s)?{width:u,height:h,expectFPS:l,codec:p,bitrate:_,__unsafe_hardwareAcceleration__:T(this,ts).__unsafe_hardwareAcceleration__}:null,audio:y===!1?null:{codec:"aac",sampleRate:ce.sampleRate,channelCount:ce.channelCount},duration:d,metaDataTags:s})},wc=function(d,l,{onProgress:u,onEnded:h,onError:p}){let _=0;const y={aborted:!1};let s=null;(async()=>{const{fps:B,bgColor:I,audio:U}=T(this,ts),G=Math.round(1e6/B),t=T(this,Io),e=Ux({ctx:t,bgColor:I,sprites:T(this,Ki),aborter:y}),n=Ex({remux:d,ctx:t,cvs:T(this,Vs),outputAudio:U,hasVideoTrack:T(this,$s),timeSlice:G});let o=0;for(;;){if(s!=null)return;if(y.aborted||l!==-1&&o>l||T(this,Ki).length===0){A(),await h();return}_=o/l;const{audios:f,mainSprDone:g}=await e(o);if(g){A(),await h();return}if(y.aborted)return;n(o,f),o+=G,await vc(d.getEncodeQueueSize)}})().catch(B=>{s=B,T(this,pn).error(B),A(),p(B)});const b=setInterval(()=>{u(_)},500),A=()=>{y.aborted||(y.aborted=!0,clearInterval(b),T(this,Ki).forEach(B=>B.destroy()))};return A};function Ux(d){const{ctx:l,bgColor:u,sprites:h,aborter:p}=d,{width:_,height:y}=l.canvas;return async s=>{l.fillStyle=u,l.fillRect(0,0,_,y);const b=[];let A=!1;for(const B of h){if(p.aborted)break;if(s<B.time.offset||B.expired)continue;l.save();const{audio:I,done:U}=await B.offscreenRender(l,s-B.time.offset);b.push(I),l.restore(),(B.time.duration>0&&s>B.time.offset+B.time.duration||U)&&(B.main&&(A=!0),B.destroy(),B.expired=!0)}return{audios:b,mainSprDone:A}}}function Ex(d){const{ctx:l,cvs:u,outputAudio:h,remux:p,hasVideoTrack:_,timeSlice:y}=d,{width:s,height:b}=u;let A=0;const B=Cx(1024);return(I,U)=>{if(h!==!1)for(const G of B(I,U))p.encodeAudio(G);if(_){const G=new VideoFrame(u,{duration:y,timestamp:I});p.encodeVideo(G,{keyFrame:A%150===0}),l.resetTransform(),l.clearRect(0,0,s,b),A+=1}}}function Cx(d){const l=d*ce.channelCount,u=new Float32Array(l*3);let h=0,p=0;const _=d/ce.sampleRate*1e6,y=new Float32Array(l),s=b=>{let A=0;const B=Math.floor(h/l),I=[];for(let U=0;U<B;U++)I.push(new AudioData({timestamp:p,numberOfChannels:ce.channelCount,numberOfFrames:d,sampleRate:ce.sampleRate,format:"f32",data:u.subarray(A,A+l)})),A+=l,p+=_;for(u.set(u.subarray(A,h),0),h-=A;b-p>_;)I.push(new AudioData({timestamp:p,numberOfChannels:ce.channelCount,numberOfFrames:d,sampleRate:ce.sampleRate,format:"f32",data:y})),p+=_;return I};return(b,A)=>{var B,I;const U=Math.max(...A.map(G=>{var t;return((t=G[0])==null?void 0:t.length)??0}));for(let G=0;G<U;G++){let t=0,e=0;for(let n=0;n<A.length;n++){const o=((B=A[n][0])==null?void 0:B[G])??0,f=((I=A[n][1])==null?void 0:I[G])??o;t+=o,e+=f}u[h]=t,u[h+1]=e,h+=2}return s(b)}}function Tx(d,l){return d.reduce((u,h)=>(u[h]=l[h],u),{})}var Ax=Object.defineProperty,xc=d=>{throw TypeError(d)},Ix=(d,l,u)=>l in d?Ax(d,l,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[l]=u,co=(d,l,u)=>Ix(d,typeof l!="symbol"?l+"":l,u),Nu=(d,l,u)=>l.has(d)||xc("Cannot "+u),Z=(d,l,u)=>(Nu(d,l,"read from private field"),u?u.call(d):l.get(d)),Ee=(d,l,u)=>l.has(d)?xc("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(d):l.set(d,u),hi=(d,l,u,h)=>(Nu(d,l,"write to private field"),l.set(d,u),u),lr=(d,l,u)=>(Nu(d,l,"access private method"),u);const Bx=["t","b","l","r","lt","lb","rt","rb","rotate"];function ls(d){return document.createElement(d)}function zx(d){let l=16;const u=new ResizeObserver(p=>{const _=p[0];_!=null&&(l=10/(_.contentRect.width/d.width))});u.observe(d);function h(p){const{w:_,h:y}=p,s=l,b=s/2,A=_/2,B=y/2,I=s*1.5,U=I/2;return{...p.fixedAspectRatio?{}:{t:new ji(-b,-B-b,s,s,p),b:new ji(-b,B-b,s,s,p),l:new ji(-A-b,-b,s,s,p),r:new ji(A-b,-b,s,s,p)},lt:new ji(-A-b,-B-b,s,s,p),lb:new ji(-A-b,B-b,s,s,p),rt:new ji(A-b,-B-b,s,s,p),rb:new ji(A-b,B-b,s,s,p),rotate:new ji(-U,-B-s*2-U,I,I,p)}}return{rectCtrlsGetter:h,destroy:()=>{u.disconnect()}}}var qs=(d=>(d.ActiveSpriteChange="activeSpriteChange",d.AddSprite="addSprite",d))(qs||{}),Si,jr,Kr,Ys;class Fx{constructor(){Ee(this,Si,[]),Ee(this,jr,null),Ee(this,Kr,new pr),co(this,"on",Z(this,Kr).on),Ee(this,Ys,0)}get activeSprite(){return Z(this,jr)}set activeSprite(l){l!==Z(this,jr)&&(hi(this,jr,l),Z(this,Kr).emit("activeSpriteChange",l))}async addSprite(l){await l.ready,Z(this,Si).push(l),hi(this,Si,Z(this,Si).sort((u,h)=>u.zIndex-h.zIndex)),l.on("propsChange",u=>{u.zIndex!=null&&hi(this,Si,Z(this,Si).sort((h,p)=>h.zIndex-p.zIndex))}),Z(this,Kr).emit("addSprite",l)}removeSprite(l){Z(this,jr)===l&&(this.activeSprite=null),hi(this,Si,Z(this,Si).filter(u=>u!==l)),l.destroy()}getSprites(l={time:!0}){return Z(this,Si).filter(u=>u.visible&&(l.time?Z(this,Ys)>=u.time.offset&&Z(this,Ys)<=u.time.offset+u.time.duration:!0))}updateRenderTime(l){hi(this,Ys,l);const u=this.activeSprite;u!=null&&(l<u.time.offset||l>u.time.offset+u.time.duration)&&(this.activeSprite=null)}destroy(){Z(this,Kr).destroy(),Z(this,Si).forEach(l=>l.destroy()),hi(this,Si,[])}}Si=new WeakMap,jr=new WeakMap,Kr=new WeakMap,Ys=new WeakMap;function kx(d,l,u,h){const p={w:l.clientWidth/l.width,h:l.clientHeight/l.height},_=new ResizeObserver(()=>{p.w=l.clientWidth/l.width,p.h=l.clientHeight/l.height,u.activeSprite!=null&&eu(u.activeSprite,y,s,p,h)});_.observe(l);const{rectEl:y,ctrlsEl:s}=Lx(d),b=u.on(qs.ActiveSpriteChange,G=>{if(G==null){y.style.display="none";return}eu(G,y,s,p,h),y.style.display=""});let A=!1;const B=G=>{G.button===0&&(A=!0)},I=()=>{A=!1},U=()=>{!A||u.activeSprite==null||eu(u.activeSprite,y,s,p,h)};return l.addEventListener("mousedown",B),window.addEventListener("mouseup",I),window.addEventListener("mousemove",U),()=>{_.disconnect(),b(),y.remove(),l.removeEventListener("mousedown",B),window.removeEventListener("mouseup",I),window.removeEventListener("mousemove",U)}}function Lx(d){const l=ls("div");l.style.cssText=`
    position: absolute;
    pointer-events: none;
    border: 1px solid #eee;
    box-sizing: border-box;
    display: none;
  `;const u=Object.fromEntries(Bx.map(h=>{const p=ls("div");return p.style.cssText=`
        display: none;
        position: absolute;
        border: 1px solid #3ee; border-radius: 50%;
        box-sizing: border-box;
        background-color: #fff;
      `,[h,p]}));return Object.values(u).forEach(h=>l.appendChild(h)),d.appendChild(l),{rectEl:l,ctrlsEl:u}}function eu(d,l,u,h,p){const{x:_,y,w:s,h:b,angle:A}=d.rect;Object.assign(l.style,{left:`${_*h.w}px`,top:`${y*h.h}px`,width:`${s*h.w}px`,height:`${b*h.h}px`,rotate:`${A}rad`}),Object.entries(p(d.rect)).forEach(([B,{x:I,y:U,w:G,h:t}])=>{Object.assign(u[B].style,{display:"block",left:"50%",top:"50%",width:`${G*h.w}px`,height:`${t*h.h}px`,transform:`translate(${I*h.w}px, ${U*h.h}px)`})})}function Px(d,l,u){const h={w:d.clientWidth/d.width,h:d.clientHeight/d.height},p=new ResizeObserver(()=>{h.w=d.clientWidth/d.width,h.h=d.clientHeight/d.height});p.observe(d);const _=y=>{if(y.button!==0)return;const{offsetX:s,offsetY:b}=y,A=s/h.w,B=b/h.h;if(l.activeSprite!=null){const[I]=Object.entries(u(l.activeSprite.rect)).find(([,U])=>U.checkHit(A,B))??[];if(I!=null)return}l.activeSprite=l.getSprites().reverse().find(I=>I.visible&&I.rect.checkHit(A,B))??null};return d.addEventListener("mousedown",_),()=>{p.disconnect(),d.removeEventListener("mousedown",_)}}function Dx(d,l,u,h){const p={w:d.clientWidth/d.width,h:d.clientHeight/d.height},_=new ResizeObserver(()=>{p.w=d.clientWidth/d.width,p.h=d.clientHeight/d.height});_.observe(d);let y=0,s=0,b=null;const A=Yx(d,u);let B=null;const I=t=>{if(t.button!==0||l.activeSprite==null)return;B=l.activeSprite;const{offsetX:e,offsetY:n,clientX:o,clientY:f}=t;Nx({rect:B.rect,offsetX:e,offsetY:n,clientX:o,clientY:f,cvsRatio:p,cvsEl:d,rectCtrlsGetter:h})||(b=B.rect.clone(),A.magneticEffect(B.rect.x,B.rect.y,B.rect),y=o,s=f,window.addEventListener("mousemove",U),window.addEventListener("mouseup",G))},U=t=>{if(B==null||b==null)return;const{clientX:e,clientY:n}=t;let o=b.x+(e-y)/p.w,f=b.y+(n-s)/p.h;bc(B.rect,d,A.magneticEffect(o,f,B.rect))};d.addEventListener("mousedown",I);const G=()=>{A.hide(),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",G)};return()=>{_.disconnect(),A.destroy(),G(),d.removeEventListener("mousedown",I)}}function Rx({sprRect:d,startX:l,startY:u,ctrlKey:h,cvsRatio:p,cvsEl:_}){const y=d.clone(),s=A=>{const{clientX:B,clientY:I}=A,U=(B-l)/p.w,G=(I-u)/p.h,t=h.length===1?Mx:Ox,{x:e,y:n,w:o,h:f}=y,g=Math.atan2(f,o),{incW:v,incH:w,incS:S,rotateAngle:k}=t({deltaX:U,deltaY:G,angle:d.angle,ctrlKey:h,diagonalAngle:g}),F=10;let P=o,M=f,D=y.fixedScaleCenter?v*2:v,et=y.fixedScaleCenter?w*2:w,at=S;const Ft=Math.sqrt(f**2+o**2),lt=Math.sqrt((F*(f/o))**2+F**2);switch(h){case"l":P=Math.max(o+D,F),at=Math.min(S,o-F);break;case"r":P=Math.max(o+D,F),at=Math.max(S,F-o);break;case"b":M=Math.max(f+et,F),at=Math.min(S,f-F);break;case"t":M=Math.max(f+et,F),at=Math.max(S,F-f);break;case"lt":case"lb":P=Math.max(o+D,F),M=P===F?f/o*P:f+et,at=Math.min(S,Ft-lt);break;case"rt":case"rb":P=Math.max(o+D,F),M=P===F?f/o*P:f+et,at=Math.max(S,lt-Ft);break}let Tt=e,Bt=n;if(y.fixedScaleCenter)Tt=e+o/2-P/2,Bt=n+f/2-M/2;else{const Ht=at/2*Math.cos(k)+e+o/2,it=at/2*Math.sin(k)+n+f/2;Tt=Ht-P/2,Bt=it-M/2}bc(d,_,{x:Tt,y:Bt,w:P,h:M})},b=()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",s),window.addEventListener("mouseup",b)}function Mx({deltaX:d,deltaY:l,angle:u,ctrlKey:h}){let p=0,_=0,y=0,s=u;return h==="l"||h==="r"?(p=d*Math.cos(u)+l*Math.sin(u),_=p*(h==="l"?-1:1)):(h==="t"||h==="b")&&(s=u-Math.PI/2,p=d*Math.cos(s)+l*Math.sin(s),y=p*(h==="b"?-1:1)),{incW:_,incH:y,incS:p,rotateAngle:s}}function Ox({deltaX:d,deltaY:l,angle:u,ctrlKey:h,diagonalAngle:p}){const _=(h==="lt"||h==="rb"?1:-1)*p+u,y=d*Math.cos(_)+l*Math.sin(_),s=h==="lt"||h==="lb"?-1:1,b=y*Math.cos(p)*s,A=y*Math.sin(p)*s;return{incW:b,incH:A,incS:y,rotateAngle:_}}function Nx({rect:d,cvsRatio:l,offsetX:u,offsetY:h,clientX:p,clientY:_,cvsEl:y,rectCtrlsGetter:s}){const b=u/l.w,A=h/l.h,[B]=Object.entries(s(d)).find(([,I])=>I.checkHit(b,A))??[];return B==null?!1:(B==="rotate"?Gx(d,Hx(d.center,l,y)):Rx({sprRect:d,ctrlKey:B,startX:p,startY:_,cvsRatio:l,cvsEl:y}),!0)}function Gx(d,l){const u=({clientX:p,clientY:_})=>{const y=p-l.x,s=_-l.y,b=Math.atan2(s,y)+Math.PI/2;d.angle=b},h=()=>{window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",h)};window.addEventListener("mousemove",u),window.addEventListener("mouseup",h)}function Hx(d,l,u){const h=d.x*l.w,p=d.y*l.h,{left:_,top:y}=u.getBoundingClientRect();return{x:h+_,y:p+y}}function bc(d,l,u){const h={x:d.x,y:d.y,w:d.w,h:d.h,...u},p=l.width*.05,_=l.height*.05;h.x<-h.w+p?h.x=-h.w+p:h.x>l.width-p&&(h.x=l.width-p),h.y<-h.h+_?h.y=-h.h+_:h.y>l.height-_&&(h.y=l.height-_),d.x=h.x,d.y=h.y,d.w=h.w,d.h=h.h}function Yx(d,l){const u="display: none; position: absolute;",h={w:0,h:0,x:0,y:0},p={vertMiddle:{...h,h:100,x:50,ref:{prop:"x",val:({w:b})=>(d.width-b)/2}},horMiddle:{...h,w:100,y:50,ref:{prop:"y",val:({h:b})=>(d.height-b)/2}},top:{...h,w:100,ref:{prop:"y",val:()=>0}},bottom:{...h,w:100,y:100,ref:{prop:"y",val:({h:b})=>d.height-b}},left:{...h,h:100,ref:{prop:"x",val:()=>0}},right:{...h,h:100,x:100,ref:{prop:"x",val:({w:b})=>d.width-b}}},_=ls("div");_.style.cssText=`
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    box-sizing: border-box;
  `;const y=Object.fromEntries(Object.entries(p).map(([b,{w:A,h:B,x:I,y:U}])=>{const G=ls("div");return G.style.cssText=`
        ${u}
        border-${A>0?"top":"left"}: 1px solid #3ee;
        top: ${U}%; left: ${I}%;
        ${I===100?"margin-left: -1px":""};
        ${U===100?"margin-top: -1px":""};
        width: ${A}%; height: ${B}%;
      `,_.appendChild(G),[b,G]}));l.appendChild(_);const s=6/(900/d.width);return{magneticEffect(b,A,B){const I={x:b,y:A};let U,G={x:!1,y:!1};for(U in p){const{prop:t,val:e}=p[U].ref;if(G[t])continue;const n=e(B);Math.abs(B[t]-n)<=s&&Math.abs(B[t]-(t==="x"?b:A))<=s?(I[t]=n,y[U].style.display="block",G[t]=!0):y[U].style.display="none"}return I},hide(){Object.values(y).forEach(b=>b.style.display="none")},destroy(){_.remove()}}}function Vx(d,l,u){const h={w:d.clientWidth/d.width,h:d.clientHeight/d.height},p=new ResizeObserver(()=>{h.w=d.clientWidth/d.width,h.h=d.clientHeight/d.height});p.observe(d);const _=d.style;let y=l.activeSprite;l.on(qs.ActiveSpriteChange,G=>{y=G,G==null&&(_.cursor="")});let s=!1;const b=({offsetX:G,offsetY:t})=>{s=!0;const e=G/h.w,n=t/h.h;(y==null?void 0:y.rect.checkHit(e,n))===!0&&_.cursor===""&&(_.cursor="move")},A=()=>{s=!1},B=["ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize"],I={t:0,rt:1,r:2,rb:3,b:4,lb:5,l:6,lt:7},U=G=>{if(y==null||s)return;const{offsetX:t,offsetY:e}=G,n=t/h.w,o=e/h.h,[f]=Object.entries(u(y.rect)).find(([,g])=>g.checkHit(n,o))??[];if(f!=null){if(f==="rotate"){_.cursor="crosshair";return}const g=y.rect.angle,v=g<0?g+2*Math.PI:g,w=(I[f]+Math.floor((v+Math.PI/8)/(Math.PI/4)))%8;_.cursor=B[w];return}if(y.rect.checkHit(n,o)){_.cursor="move";return}_.cursor=""};return d.addEventListener("mousemove",U),d.addEventListener("mousedown",b),window.addEventListener("mouseup",A),()=>{p.disconnect(),d.removeEventListener("mousemove",U),d.removeEventListener("mousedown",b),window.removeEventListener("mouseup",A)}}const $x={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function Wx(d){const l=ls("canvas");return l.style.cssText=`
    width: 100%;
    height: 100%;
    display: block;
  `,l.width=d.width,l.height=d.height,l}var Le,Se,es,po,_o,go,Ln,mo,Rn,_n,Bo,zo,Xe,ur,hr,Sc,Di,vo;class Xx{constructor(l,u){Ee(this,_n),Ee(this,Le),Ee(this,Se),Ee(this,es),Ee(this,po,!1),Ee(this,_o,[]),Ee(this,go),Ee(this,Ln,new pr),co(this,"on",Z(this,Ln).on),Ee(this,mo),Ee(this,Rn,0),Ee(this,Xe,new AudioContext),Ee(this,ur,Z(this,Xe).createMediaStreamDestination()),Ee(this,hr,new Set),Ee(this,Di,{start:0,end:0,step:0,audioPlayAt:0}),Ee(this,vo,new WeakMap),co(this,"addSprite",async I=>{Z(this,Xe).state==="suspended"&&Z(this,Xe).resume().catch(kt.error);const U=I.getClip();if(U instanceof _x&&U.audioTrack!=null){const G=Z(this,Xe).createMediaStreamSource(new MediaStream([U.audioTrack]));G.connect(Z(this,ur)),Z(this,vo).set(I,G)}await Z(this,Se).addSprite(I)}),co(this,"removeSprite",I=>{var U;(U=Z(this,vo).get(I))==null||U.disconnect(),Z(this,Se).removeSprite(I)}),hi(this,mo,u),hi(this,Le,Wx(u));const h=Z(this,Le).getContext("2d",{alpha:!1});if(h==null)throw Error("canvas context is null");hi(this,es,h);const p=ls("div");p.style.cssText="width: 100%; height: 100%; position: relative; overflow: hidden;",p.appendChild(Z(this,Le)),l.appendChild(p),jx(Z(this,Xe)).connect(Z(this,ur)),hi(this,Se,new Fx);const{rectCtrlsGetter:_,destroy:y}=zx(Z(this,Le));Z(this,_o).push(y,Px(Z(this,Le),Z(this,Se),_),Vx(Z(this,Le),Z(this,Se),_),Dx(Z(this,Le),Z(this,Se),p,_),kx(p,Z(this,Le),Z(this,Se),_),Z(this,Se).on(qs.AddSprite,I=>{const{rect:U}=I;U.x===0&&U.y===0&&(U.x=(Z(this,Le).width-U.w)/2,U.y=(Z(this,Le).height-U.h)/2)}),pr.forwardEvent(Z(this,Se),Z(this,Ln),[qs.ActiveSpriteChange]));let s=Z(this,Rn),b=performance.now(),A=0;const B=1e3/30;hi(this,go,ku(()=>{(performance.now()-b)/(B*A)<1||(A+=1,Z(this,es).fillStyle=u.bgColor,Z(this,es).fillRect(0,0,Z(this,Le).width,Z(this,Le).height),lr(this,_n,Sc).call(this),s!==Z(this,Rn)&&(s=Z(this,Rn),Z(this,Ln).emit("timeupdate",Math.round(s))))},B))}play(l){const u=Z(this,Se).getSprites({time:!1}).map(p=>p.time.offset+p.time.duration),h=l.end??(u.length>0?Math.max(...u):1/0);if(l.start>=h||l.start<0)throw Error(`Invalid time parameter, ${JSON.stringify({start:l.start,end:h})}`);lr(this,_n,Bo).call(this,l.start),Z(this,Se).getSprites({time:!1}).forEach(p=>{const{offset:_,duration:y}=p.time,s=Z(this,Rn)-_;p.preFrame(s>0&&s<y?s:0)}),Z(this,Di).start=l.start,Z(this,Di).end=h,Z(this,Di).step=(l.playbackRate??1)*(1e3/30)*1e3,Z(this,Xe).resume(),Z(this,Di).audioPlayAt=0,Z(this,Ln).emit("playing"),kt.info("AVCanvs play by:",Z(this,Di))}pause(){lr(this,_n,zo).call(this)}previewFrame(l){lr(this,_n,Bo).call(this,l),lr(this,_n,zo).call(this)}captureImage(){return Z(this,Le).toDataURL()}get activeSprite(){return Z(this,Se).activeSprite}set activeSprite(l){Z(this,Se).activeSprite=l}destroy(){var l;Z(this,po)||(hi(this,po,!0),Z(this,Xe).close(),Z(this,ur).disconnect(),Z(this,Ln).destroy(),Z(this,go).call(this),(l=Z(this,Le).parentElement)==null||l.remove(),Z(this,_o).forEach(u=>u()),Z(this,hr).clear(),Z(this,Se).destroy())}captureStream(){Z(this,Xe).state==="suspended"&&Z(this,Xe).resume().catch(kt.error);const l=new MediaStream(Z(this,Le).captureStream().getTracks().concat(Z(this,ur).stream.getTracks()));return kt.info("AVCanvas.captureStream, tracks:",l.getTracks().map(u=>u.kind)),l}async createCombinator(l={}){kt.info("AVCanvas.createCombinator, opts:",l);const u=new Sx({...Z(this,mo),...l}),h=Z(this,Se).getSprites({time:!1});if(h.length===0)throw Error("No sprite added");for(const p of h){const _=new wx(p.getClip());_.time={...p.time},p.copyStateTo(_),await u.addSprite(_)}return u}}Le=new WeakMap,Se=new WeakMap,es=new WeakMap,po=new WeakMap,_o=new WeakMap,go=new WeakMap,Ln=new WeakMap,mo=new WeakMap,Rn=new WeakMap,_n=new WeakSet,Bo=function(d){hi(this,Rn,d),Z(this,Se).updateRenderTime(d)},zo=function(){const d=Z(this,Di).step!==0;Z(this,Di).step=0,d&&(Z(this,Ln).emit("paused"),Z(this,Xe).suspend());for(const l of Z(this,hr))l.stop(),l.disconnect();Z(this,hr).clear()},Xe=new WeakMap,ur=new WeakMap,hr=new WeakMap,Sc=function(){var d;const l=Z(this,es);let u=Z(this,Rn);const{start:h,end:p,step:_,audioPlayAt:y}=Z(this,Di);_!==0&&u>=h&&u<p?u+=_:lr(this,_n,zo).call(this),lr(this,_n,Bo).call(this,u);const s=[];for(const b of Z(this,Se).getSprites()){l.save();const{audio:A}=b.render(l,u-b.time.offset);l.restore(),s.push(A)}if(l.resetTransform(),_!==0){const b=Math.max(Z(this,Xe).currentTime,y),A=qx(s,Z(this,Xe));let B=0;for(const I of A)I.start(b),I.connect(Z(this,Xe).destination),I.connect(Z(this,ur)),Z(this,hr).add(I),I.onended=()=>{I.disconnect(),Z(this,hr).delete(I)},B=Math.max(B,((d=I.buffer)==null?void 0:d.duration)??0);Z(this,Di).audioPlayAt=b+B}},Di=new WeakMap,vo=new WeakMap;function qx(d,l){const u=[];if(d.length===0)return u;for(const[h,p]of d){if(h==null||h.length<=0)continue;const _=l.createBuffer(2,h.length,$x.sampleRate);_.copyToChannel(h,0),_.copyToChannel(p??h,1);const y=l.createBufferSource();y.buffer=_,u.push(y)}return u}function jx(d){const l=d.createOscillator(),u=new Float32Array([0,0]),h=new Float32Array([0,0]),p=d.createPeriodicWave(u,h,{disableNormalization:!0});return l.setPeriodicWave(p),l.start(),l}const _r=nw("track",{state:()=>({showContextMenu:!1,contextMenuPosition:{x:0,y:0},dragData:null,canvasSize:{width:0,height:0},currentHistoryIndex:-1,maxHistoryIndex:-1,maxHistorySize:50,clipUpdateSubscribers:new Map,activeClip:null}),getters:{getShowContextMenu:d=>d.showContextMenu,getContextMenuPosition:d=>d.contextMenuPosition,getDragData:d=>d.dragData,getCanvasSize:d=>d.canvasSize,canUndo:d=>d.currentHistoryIndex>0},actions:{subscribeToClipUpdates(d,l){this.clipUpdateSubscribers.set(d,l)},unsubscribeFromClipUpdates(d){this.clipUpdateSubscribers.delete(d)},publishClipUpdate(d,l="default"){const u=this.clipUpdateSubscribers.get(d.id);u&&u(d,l)},setShowContextMenu(d){this.showContextMenu=d},setContextMenuPosition(d){this.contextMenuPosition=d},setDragData(d){this.dragData=d},clearDragData(){this.dragData=null},setCanvasSize(d){this.canvasSize=d},async saveHistoryState(d,l){if(await Ce.history.where("projectId").equals(d).and(h=>h.index>this.currentHistoryIndex).delete(),this.currentHistoryIndex++,this.maxHistoryIndex=this.currentHistoryIndex,await Ce.history.add({projectId:d,tracks:JSON.parse(JSON.stringify(l)),index:this.currentHistoryIndex,timestamp:Date.now()}),await Ce.history.where("projectId").equals(d).count()>this.maxHistorySize){const h=await Ce.history.where("projectId").equals(d).and(p=>p.index===0).toArray();h.length>0&&(await Ce.history.delete(h[0].id),this.currentHistoryIndex--,this.maxHistoryIndex--)}},async undo(d){if(!this.canUndo)return null;const l=await Ce.history.where("projectId").equals(d).and(u=>u.index===this.currentHistoryIndex-1).first();return l?(this.currentHistoryIndex--,l.tracks):null},async redo(d){const l=await Ce.history.where("projectId").equals(d).and(u=>u.index===this.currentHistoryIndex+1).first();return l?(this.currentHistoryIndex++,l.tracks):null},async getCanRedo(d){const l=await Ce.history.where("projectId").equals(d).count();return console.log("getCanRedo",d,l,this.currentHistoryIndex),this.currentHistoryIndex<l-1},async clearHistory(d){await Ce.history.where("projectId").equals(d).delete(),this.currentHistoryIndex=-1,this.maxHistoryIndex=-1},setActiveClip(d){this.activeClip=d}}}),Uc=/^[a-z0-9]+(-[a-z0-9]+)*$/,Lo=(d,l,u,h="")=>{const p=d.split(":");if(d.slice(0,1)==="@"){if(p.length<2||p.length>3)return null;h=p.shift().slice(1)}if(p.length>3||!p.length)return null;if(p.length>1){const s=p.pop(),b=p.pop(),A={provider:p.length>0?p[0]:h,prefix:b,name:s};return l&&!yo(A)?null:A}const _=p[0],y=_.split("-");if(y.length>1){const s={provider:h,prefix:y.shift(),name:y.join("-")};return l&&!yo(s)?null:s}if(u&&h===""){const s={provider:h,prefix:"",name:_};return l&&!yo(s,u)?null:s}return null},yo=(d,l)=>d?!!((l&&d.prefix===""||d.prefix)&&d.name):!1,Ec=Object.freeze({left:0,top:0,width:16,height:16}),Fo=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),Po=Object.freeze({...Ec,...Fo}),wu=Object.freeze({...Po,body:"",hidden:!1});function Kx(d,l){const u={};!d.hFlip!=!l.hFlip&&(u.hFlip=!0),!d.vFlip!=!l.vFlip&&(u.vFlip=!0);const h=((d.rotate||0)+(l.rotate||0))%4;return h&&(u.rotate=h),u}function zd(d,l){const u=Kx(d,l);for(const h in wu)h in Fo?h in d&&!(h in u)&&(u[h]=Fo[h]):h in l?u[h]=l[h]:h in d&&(u[h]=d[h]);return u}function Zx(d,l){const u=d.icons,h=d.aliases||Object.create(null),p=Object.create(null);function _(y){if(u[y])return p[y]=[];if(!(y in p)){p[y]=null;const s=h[y]&&h[y].parent,b=s&&_(s);b&&(p[y]=[s].concat(b))}return p[y]}return Object.keys(u).concat(Object.keys(h)).forEach(_),p}function Jx(d,l,u){const h=d.icons,p=d.aliases||Object.create(null);let _={};function y(s){_=zd(h[s]||p[s],_)}return y(l),u.forEach(y),zd(d,_)}function Cc(d,l){const u=[];if(typeof d!="object"||typeof d.icons!="object")return u;d.not_found instanceof Array&&d.not_found.forEach(p=>{l(p,null),u.push(p)});const h=Zx(d);for(const p in h){const _=h[p];_&&(l(p,Jx(d,p,_)),u.push(p))}return u}const Qx={provider:"",aliases:{},not_found:{},...Ec};function iu(d,l){for(const u in l)if(u in d&&typeof d[u]!=typeof l[u])return!1;return!0}function Tc(d){if(typeof d!="object"||d===null)return null;const l=d;if(typeof l.prefix!="string"||!d.icons||typeof d.icons!="object"||!iu(d,Qx))return null;const u=l.icons;for(const p in u){const _=u[p];if(!p||typeof _.body!="string"||!iu(_,wu))return null}const h=l.aliases||Object.create(null);for(const p in h){const _=h[p],y=_.parent;if(!p||typeof y!="string"||!u[y]&&!h[y]||!iu(_,wu))return null}return l}const Fd=Object.create(null);function tb(d,l){return{provider:d,prefix:l,icons:Object.create(null),missing:new Set}}function us(d,l){const u=Fd[d]||(Fd[d]=Object.create(null));return u[l]||(u[l]=tb(d,l))}function Ac(d,l){return Tc(l)?Cc(l,(u,h)=>{h?d.icons[u]=h:d.missing.add(u)}):[]}function eb(d,l,u){try{if(typeof u.body=="string")return d.icons[l]={...u},!0}catch{}return!1}let js=!1;function Ic(d){return typeof d=="boolean"&&(js=d),js}function ib(d){const l=typeof d=="string"?Lo(d,!0,js):d;if(l){const u=us(l.provider,l.prefix),h=l.name;return u.icons[h]||(u.missing.has(h)?null:void 0)}}function nb(d,l){const u=Lo(d,!0,js);if(!u)return!1;const h=us(u.provider,u.prefix);return l?eb(h,u.name,l):(h.missing.add(u.name),!0)}function rb(d,l){if(typeof d!="object")return!1;if(typeof l!="string"&&(l=d.provider||""),js&&!l&&!d.prefix){let p=!1;return Tc(d)&&(d.prefix="",Cc(d,(_,y)=>{nb(_,y)&&(p=!0)})),p}const u=d.prefix;if(!yo({provider:l,prefix:u,name:"a"}))return!1;const h=us(l,u);return!!Ac(h,d)}const Bc=Object.freeze({width:null,height:null}),zc=Object.freeze({...Bc,...Fo}),sb=/(-?[0-9.]*[0-9]+[0-9.]*)/g,ab=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function kd(d,l,u){if(l===1)return d;if(u=u||100,typeof d=="number")return Math.ceil(d*l*u)/u;if(typeof d!="string")return d;const h=d.split(sb);if(h===null||!h.length)return d;const p=[];let _=h.shift(),y=ab.test(_);for(;;){if(y){const s=parseFloat(_);isNaN(s)?p.push(_):p.push(Math.ceil(s*l*u)/u)}else p.push(_);if(_=h.shift(),_===void 0)return p.join("");y=!y}}function ob(d,l="defs"){let u="";const h=d.indexOf("<"+l);for(;h>=0;){const p=d.indexOf(">",h),_=d.indexOf("</"+l);if(p===-1||_===-1)break;const y=d.indexOf(">",_);if(y===-1)break;u+=d.slice(p+1,_).trim(),d=d.slice(0,h).trim()+d.slice(y+1)}return{defs:u,content:d}}function lb(d,l){return d?"<defs>"+d+"</defs>"+l:l}function ub(d,l,u){const h=ob(d);return lb(h.defs,l+h.content+u)}const hb=d=>d==="unset"||d==="undefined"||d==="none";function fb(d,l){const u={...Po,...d},h={...zc,...l},p={left:u.left,top:u.top,width:u.width,height:u.height};let _=u.body;[u,h].forEach(e=>{const n=[],o=e.hFlip,f=e.vFlip;let g=e.rotate;o?f?g+=2:(n.push("translate("+(p.width+p.left).toString()+" "+(0-p.top).toString()+")"),n.push("scale(-1 1)"),p.top=p.left=0):f&&(n.push("translate("+(0-p.left).toString()+" "+(p.height+p.top).toString()+")"),n.push("scale(1 -1)"),p.top=p.left=0);let v;switch(g<0&&(g-=Math.floor(g/4)*4),g=g%4,g){case 1:v=p.height/2+p.top,n.unshift("rotate(90 "+v.toString()+" "+v.toString()+")");break;case 2:n.unshift("rotate(180 "+(p.width/2+p.left).toString()+" "+(p.height/2+p.top).toString()+")");break;case 3:v=p.width/2+p.left,n.unshift("rotate(-90 "+v.toString()+" "+v.toString()+")");break}g%2===1&&(p.left!==p.top&&(v=p.left,p.left=p.top,p.top=v),p.width!==p.height&&(v=p.width,p.width=p.height,p.height=v)),n.length&&(_=ub(_,'<g transform="'+n.join(" ")+'">',"</g>"))});const y=h.width,s=h.height,b=p.width,A=p.height;let B,I;y===null?(I=s===null?"1em":s==="auto"?A:s,B=kd(I,b/A)):(B=y==="auto"?b:y,I=s===null?kd(B,A/b):s==="auto"?A:s);const U={},G=(e,n)=>{hb(n)||(U[e]=n.toString())};G("width",B),G("height",I);const t=[p.left,p.top,b,A];return U.viewBox=t.join(" "),{attributes:U,viewBox:t,body:_}}const db=/\sid="(\S+)"/g,cb="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let pb=0;function _b(d,l=cb){const u=[];let h;for(;h=db.exec(d);)u.push(h[1]);if(!u.length)return d;const p="suffix"+(Math.random()*16777216|Date.now()).toString(16);return u.forEach(_=>{const y=typeof l=="function"?l(_):l+(pb++).toString(),s=_.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");d=d.replace(new RegExp('([#;"])('+s+')([")]|\\.[a-z])',"g"),"$1"+y+p+"$3")}),d=d.replace(new RegExp(p,"g"),""),d}const xu=Object.create(null);function gb(d,l){xu[d]=l}function bu(d){return xu[d]||xu[""]}function Gu(d){let l;if(typeof d.resources=="string")l=[d.resources];else if(l=d.resources,!(l instanceof Array)||!l.length)return null;return{resources:l,path:d.path||"/",maxURL:d.maxURL||500,rotate:d.rotate||750,timeout:d.timeout||5e3,random:d.random===!0,index:d.index||0,dataAfterTimeout:d.dataAfterTimeout!==!1}}const Hu=Object.create(null),Fs=["https://api.simplesvg.com","https://api.unisvg.com"],wo=[];for(;Fs.length>0;)Fs.length===1||Math.random()>.5?wo.push(Fs.shift()):wo.push(Fs.pop());Hu[""]=Gu({resources:["https://api.iconify.design"].concat(wo)});function mb(d,l){const u=Gu(l);return u===null?!1:(Hu[d]=u,!0)}function Yu(d){return Hu[d]}const vb=()=>{let d;try{if(d=fetch,typeof d=="function")return d}catch{}};let Ld=vb();function yb(d,l){const u=Yu(d);if(!u)return 0;let h;if(!u.maxURL)h=0;else{let p=0;u.resources.forEach(y=>{p=Math.max(p,y.length)});const _=l+".json?icons=";h=u.maxURL-p-u.path.length-_.length}return h}function wb(d){return d===404}const xb=(d,l,u)=>{const h=[],p=yb(d,l),_="icons";let y={type:_,provider:d,prefix:l,icons:[]},s=0;return u.forEach((b,A)=>{s+=b.length+1,s>=p&&A>0&&(h.push(y),y={type:_,provider:d,prefix:l,icons:[]},s=b.length),y.icons.push(b)}),h.push(y),h};function bb(d){if(typeof d=="string"){const l=Yu(d);if(l)return l.path}return"/"}const Sb=(d,l,u)=>{if(!Ld){u("abort",424);return}let h=bb(l.provider);switch(l.type){case"icons":{const _=l.prefix,s=l.icons.join(","),b=new URLSearchParams({icons:s});h+=_+".json?"+b.toString();break}case"custom":{const _=l.uri;h+=_.slice(0,1)==="/"?_.slice(1):_;break}default:u("abort",400);return}let p=503;Ld(d+h).then(_=>{const y=_.status;if(y!==200){setTimeout(()=>{u(wb(y)?"abort":"next",y)});return}return p=501,_.json()}).then(_=>{if(typeof _!="object"||_===null){setTimeout(()=>{_===404?u("abort",_):u("next",p)});return}setTimeout(()=>{u("success",_)})}).catch(()=>{u("next",p)})},Ub={prepare:xb,send:Sb};function Eb(d){const l={loaded:[],missing:[],pending:[]},u=Object.create(null);d.sort((p,_)=>p.provider!==_.provider?p.provider.localeCompare(_.provider):p.prefix!==_.prefix?p.prefix.localeCompare(_.prefix):p.name.localeCompare(_.name));let h={provider:"",prefix:"",name:""};return d.forEach(p=>{if(h.name===p.name&&h.prefix===p.prefix&&h.provider===p.provider)return;h=p;const _=p.provider,y=p.prefix,s=p.name,b=u[_]||(u[_]=Object.create(null)),A=b[y]||(b[y]=us(_,y));let B;s in A.icons?B=l.loaded:y===""||A.missing.has(s)?B=l.missing:B=l.pending;const I={provider:_,prefix:y,name:s};B.push(I)}),l}function Fc(d,l){d.forEach(u=>{const h=u.loaderCallbacks;h&&(u.loaderCallbacks=h.filter(p=>p.id!==l))})}function Cb(d){d.pendingCallbacksFlag||(d.pendingCallbacksFlag=!0,setTimeout(()=>{d.pendingCallbacksFlag=!1;const l=d.loaderCallbacks?d.loaderCallbacks.slice(0):[];if(!l.length)return;let u=!1;const h=d.provider,p=d.prefix;l.forEach(_=>{const y=_.icons,s=y.pending.length;y.pending=y.pending.filter(b=>{if(b.prefix!==p)return!0;const A=b.name;if(d.icons[A])y.loaded.push({provider:h,prefix:p,name:A});else if(d.missing.has(A))y.missing.push({provider:h,prefix:p,name:A});else return u=!0,!0;return!1}),y.pending.length!==s&&(u||Fc([d],_.id),_.callback(y.loaded.slice(0),y.missing.slice(0),y.pending.slice(0),_.abort))})}))}let Tb=0;function Ab(d,l,u){const h=Tb++,p=Fc.bind(null,u,h);if(!l.pending.length)return p;const _={id:h,icons:l,callback:d,abort:p};return u.forEach(y=>{(y.loaderCallbacks||(y.loaderCallbacks=[])).push(_)}),p}function Ib(d,l=!0,u=!1){const h=[];return d.forEach(p=>{const _=typeof p=="string"?Lo(p,l,u):p;_&&h.push(_)}),h}var Bb={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function zb(d,l,u,h){const p=d.resources.length,_=d.random?Math.floor(Math.random()*p):d.index;let y;if(d.random){let S=d.resources.slice(0);for(y=[];S.length>1;){const k=Math.floor(Math.random()*S.length);y.push(S[k]),S=S.slice(0,k).concat(S.slice(k+1))}y=y.concat(S)}else y=d.resources.slice(_).concat(d.resources.slice(0,_));const s=Date.now();let b="pending",A=0,B,I=null,U=[],G=[];typeof h=="function"&&G.push(h);function t(){I&&(clearTimeout(I),I=null)}function e(){b==="pending"&&(b="aborted"),t(),U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function n(S,k){k&&(G=[]),typeof S=="function"&&G.push(S)}function o(){return{startTime:s,payload:l,status:b,queriesSent:A,queriesPending:U.length,subscribe:n,abort:e}}function f(){b="failed",G.forEach(S=>{S(void 0,B)})}function g(){U.forEach(S=>{S.status==="pending"&&(S.status="aborted")}),U=[]}function v(S,k,F){const P=k!=="success";switch(U=U.filter(M=>M!==S),b){case"pending":break;case"failed":if(P||!d.dataAfterTimeout)return;break;default:return}if(k==="abort"){B=F,f();return}if(P){B=F,U.length||(y.length?w():f());return}if(t(),g(),!d.random){const M=d.resources.indexOf(S.resource);M!==-1&&M!==d.index&&(d.index=M)}b="completed",G.forEach(M=>{M(F)})}function w(){if(b!=="pending")return;t();const S=y.shift();if(S===void 0){if(U.length){I=setTimeout(()=>{t(),b==="pending"&&(g(),f())},d.timeout);return}f();return}const k={status:"pending",resource:S,callback:(F,P)=>{v(k,F,P)}};U.push(k),A++,I=setTimeout(w,d.rotate),u(S,l,k.callback)}return setTimeout(w),o}function kc(d){const l={...Bb,...d};let u=[];function h(){u=u.filter(s=>s().status==="pending")}function p(s,b,A){const B=zb(l,s,b,(I,U)=>{h(),A&&A(I,U)});return u.push(B),B}function _(s){return u.find(b=>s(b))||null}return{query:p,find:_,setIndex:s=>{l.index=s},getIndex:()=>l.index,cleanup:h}}function Pd(){}const nu=Object.create(null);function Fb(d){if(!nu[d]){const l=Yu(d);if(!l)return;const u=kc(l),h={config:l,redundancy:u};nu[d]=h}return nu[d]}function kb(d,l,u){let h,p;if(typeof d=="string"){const _=bu(d);if(!_)return u(void 0,424),Pd;p=_.send;const y=Fb(d);y&&(h=y.redundancy)}else{const _=Gu(d);if(_){h=kc(_);const y=d.resources?d.resources[0]:"",s=bu(y);s&&(p=s.send)}}return!h||!p?(u(void 0,424),Pd):h.query(l,p,u)().abort}function Dd(){}function Lb(d){d.iconsLoaderFlag||(d.iconsLoaderFlag=!0,setTimeout(()=>{d.iconsLoaderFlag=!1,Cb(d)}))}function Pb(d){const l=[],u=[];return d.forEach(h=>{(h.match(Uc)?l:u).push(h)}),{valid:l,invalid:u}}function ks(d,l,u){function h(){const p=d.pendingIcons;l.forEach(_=>{p&&p.delete(_),d.icons[_]||d.missing.add(_)})}if(u&&typeof u=="object")try{if(!Ac(d,u).length){h();return}}catch(p){console.error(p)}h(),Lb(d)}function Rd(d,l){d instanceof Promise?d.then(u=>{l(u)}).catch(()=>{l(null)}):l(d)}function Db(d,l){d.iconsToLoad?d.iconsToLoad=d.iconsToLoad.concat(l).sort():d.iconsToLoad=l,d.iconsQueueFlag||(d.iconsQueueFlag=!0,setTimeout(()=>{d.iconsQueueFlag=!1;const{provider:u,prefix:h}=d,p=d.iconsToLoad;if(delete d.iconsToLoad,!p||!p.length)return;const _=d.loadIcon;if(d.loadIcons&&(p.length>1||!_)){Rd(d.loadIcons(p,h,u),B=>{ks(d,p,B)});return}if(_){p.forEach(B=>{const I=_(B,h,u);Rd(I,U=>{const G=U?{prefix:h,icons:{[B]:U}}:null;ks(d,[B],G)})});return}const{valid:y,invalid:s}=Pb(p);if(s.length&&ks(d,s,null),!y.length)return;const b=h.match(Uc)?bu(u):null;if(!b){ks(d,y,null);return}b.prepare(u,h,y).forEach(B=>{kb(u,B,I=>{ks(d,B.icons,I)})})}))}const Rb=(d,l)=>{const u=Ib(d,!0,Ic()),h=Eb(u);if(!h.pending.length){let b=!0;return l&&setTimeout(()=>{b&&l(h.loaded,h.missing,h.pending,Dd)}),()=>{b=!1}}const p=Object.create(null),_=[];let y,s;return h.pending.forEach(b=>{const{provider:A,prefix:B}=b;if(B===s&&A===y)return;y=A,s=B,_.push(us(A,B));const I=p[A]||(p[A]=Object.create(null));I[B]||(I[B]=[])}),h.pending.forEach(b=>{const{provider:A,prefix:B,name:I}=b,U=us(A,B),G=U.pendingIcons||(U.pendingIcons=new Set);G.has(I)||(G.add(I),p[A][B].push(I))}),_.forEach(b=>{const A=p[b.provider][b.prefix];A.length&&Db(b,A)}),l?Ab(l,h,_):Dd};function Mb(d,l){const u={...d};for(const h in l){const p=l[h],_=typeof p;h in Bc?(p===null||p&&(_==="string"||_==="number"))&&(u[h]=p):_===typeof u[h]&&(u[h]=h==="rotate"?p%4:p)}return u}const Ob=/[\s,]+/;function Nb(d,l){l.split(Ob).forEach(u=>{switch(u.trim()){case"horizontal":d.hFlip=!0;break;case"vertical":d.vFlip=!0;break}})}function Gb(d,l=0){const u=d.replace(/^-?[0-9.]*/,"");function h(p){for(;p<0;)p+=4;return p%4}if(u===""){const p=parseInt(d);return isNaN(p)?0:h(p)}else if(u!==d){let p=0;switch(u){case"%":p=25;break;case"deg":p=90}if(p){let _=parseFloat(d.slice(0,d.length-u.length));return isNaN(_)?0:(_=_/p,_%1===0?h(_):0)}}return l}function Hb(d,l){let u=d.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const h in l)u+=" "+h+'="'+l[h]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+u+">"+d+"</svg>"}function Yb(d){return d.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function Vb(d){return"data:image/svg+xml,"+Yb(d)}function $b(d){return'url("'+Vb(d)+'")'}const Md={...zc,inline:!1},Wb={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},Xb={display:"inline-block"},Su={backgroundColor:"currentColor"},Lc={backgroundColor:"transparent"},Od={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},Nd={webkitMask:Su,mask:Su,background:Lc};for(const d in Nd){const l=Nd[d];for(const u in Od)l[d+u]=Od[u]}const xo={};["horizontal","vertical"].forEach(d=>{const l=d.slice(0,1)+"Flip";xo[d+"-flip"]=l,xo[d.slice(0,1)+"-flip"]=l,xo[d+"Flip"]=l});function Gd(d){return d+(d.match(/^[-0-9.]+$/)?"px":"")}const Hd=(d,l)=>{const u=Mb(Md,l),h={...Wb},p=l.mode||"svg",_={},y=l.style,s=typeof y=="object"&&!(y instanceof Array)?y:{};for(let e in l){const n=l[e];if(n!==void 0)switch(e){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":u[e]=n===!0||n==="true"||n===1;break;case"flip":typeof n=="string"&&Nb(u,n);break;case"color":_.color=n;break;case"rotate":typeof n=="string"?u[e]=Gb(n):typeof n=="number"&&(u[e]=n);break;case"ariaHidden":case"aria-hidden":n!==!0&&n!=="true"&&delete h["aria-hidden"];break;default:{const o=xo[e];o?(n===!0||n==="true"||n===1)&&(u[o]=!0):Md[e]===void 0&&(h[e]=n)}}}const b=fb(d,u),A=b.attributes;if(u.inline&&(_.verticalAlign="-0.125em"),p==="svg"){h.style={..._,...s},Object.assign(h,A);let e=0,n=l.id;return typeof n=="string"&&(n=n.replace(/-/g,"_")),h.innerHTML=_b(b.body,n?()=>n+"ID"+e++:"iconifyVue"),bd("svg",h)}const{body:B,width:I,height:U}=d,G=p==="mask"||(p==="bg"?!1:B.indexOf("currentColor")!==-1),t=Hb(B,{...A,width:I+"",height:U+""});return h.style={..._,"--svg":$b(t),width:Gd(A.width),height:Gd(A.height),...Xb,...G?Su:Lc,...s},bd("span",h)};Ic(!0);gb("",Ub);if(typeof document<"u"&&typeof window<"u"){const d=window;if(d.IconifyPreload!==void 0){const l=d.IconifyPreload,u="Invalid IconifyPreload syntax.";typeof l=="object"&&l!==null&&(l instanceof Array?l:[l]).forEach(h=>{try{(typeof h!="object"||h===null||h instanceof Array||typeof h.icons!="object"||typeof h.prefix!="string"||!rb(h))&&console.error(u)}catch{console.error(u)}})}if(d.IconifyProviders!==void 0){const l=d.IconifyProviders;if(typeof l=="object"&&l!==null)for(let u in l){const h="IconifyProviders["+u+"] is invalid.";try{const p=l[u];if(typeof p!="object"||!p||p.resources===void 0)continue;mb(u,p)||console.error(h)}catch{console.error(h)}}}}const qb={...Po,body:""},re=Re({inheritAttrs:!1,data(){return{_name:"",_loadingIcon:null,iconMounted:!1,counter:0}},mounted(){this.iconMounted=!0},unmounted(){this.abortLoading()},methods:{abortLoading(){this._loadingIcon&&(this._loadingIcon.abort(),this._loadingIcon=null)},getIcon(d,l,u){if(typeof d=="object"&&d!==null&&typeof d.body=="string")return this._name="",this.abortLoading(),{data:d};let h;if(typeof d!="string"||(h=Lo(d,!1,!0))===null)return this.abortLoading(),null;let p=ib(h);if(!p)return(!this._loadingIcon||this._loadingIcon.name!==d)&&(this.abortLoading(),this._name="",p!==null&&(this._loadingIcon={name:d,abort:Rb([h],()=>{this.counter++})})),null;if(this.abortLoading(),this._name!==d&&(this._name=d,l&&l(d)),u){p=Object.assign({},p);const y=u(p.body,h.name,h.prefix,h.provider);typeof y=="string"&&(p.body=y)}const _=["iconify"];return h.prefix!==""&&_.push("iconify--"+h.prefix),h.provider!==""&&_.push("iconify--"+h.provider),{data:p,classes:_}}},render(){this.counter;const d=this.$attrs,l=this.iconMounted||d.ssr?this.getIcon(d.icon,d.onLoad,d.customise):null;if(!l)return Hd(qb,d);let u=d;return l.classes&&(u={...d,class:(typeof d.class=="string"?d.class+" ":"")+l.classes.join(" ")}),Hd({...Po,...l.data},u)}});var Ue,Be,ss,Rt,dr,Oi,Eu,Cu,Tu;const $u=class $u{constructor(l,u){An(this,Oi);An(this,Ue);An(this,Be);An(this,ss);jl(this,"ready");An(this,Rt);An(this,dr,{width:0,height:0,duration:1/0});In(this,Ue,document.createElement("canvas")),In(this,Rt,l),In(this,ss,u),In(this,Be,dt(this,Ue).getContext("2d"));const h=dt(this,Rt).content.split(`
`),{xPadding:p,yPadding:_}=Zn(this,Oi,Eu).call(this);dt(this,Ue).width=Zn(this,Oi,Cu).call(this,h)+p*2,dt(this,Ue).height=Zn(this,Oi,Tu).call(this,h)+_*2,this.ready=Promise.resolve({width:dt(this,Ue).width,height:dt(this,Ue).height,duration:1/0}),dt(this,Be).font=`${dt(this,Rt).fontSize}px ${dt(this,Rt).fontFamily}`}get textConfig(){return dt(this,Rt)}set textConfig(l){In(this,Rt,l)}get meta(){return dt(this,dr)}set meta(l){In(this,dr,l)}async tick(l){const u=dt(this,Rt).content.split(`
`),{xPadding:h,yPadding:p}=Zn(this,Oi,Eu).call(this),_=Zn(this,Oi,Cu).call(this,u),y=Zn(this,Oi,Tu).call(this,u);dt(this,Ue).width=_+h*2,dt(this,Ue).height=y+p*2,dt(this,dr).width=dt(this,Ue).width,dt(this,dr).height=dt(this,Ue).height,dt(this,ss).call(this,_+h*2,y+p*2),dt(this,Be).clearRect(0,0,dt(this,Ue).width,dt(this,Ue).height),dt(this,Be).fillStyle=dt(this,Rt).color,dt(this,Be).font=`${dt(this,Rt).bold?"bold":""} ${dt(this,Rt).italic?"italic":""} ${dt(this,Rt).fontSize}px ${dt(this,Rt).fontFamily}`,dt(this,Be).textBaseline="hanging",dt(this,Rt).showShadow&&(dt(this,Be).shadowColor=dt(this,Rt).shadowColor,dt(this,Be).shadowBlur=dt(this,Rt).shadowBlur,dt(this,Be).shadowOffsetX=dt(this,Rt).shadowOffsetX,dt(this,Be).shadowOffsetY=dt(this,Rt).shadowOffsetY);let s=0,b=0;for(let A=0;A<u.length;A++){let B=dt(this,Rt).fontSize*u[A].length+dt(this,Rt).letterSpacing*(u[A].length-1);switch(dt(this,Rt).align){case"left":s=0;break;case"center":s=(dt(this,Ue).width-B)/2;break;case"right":s=dt(this,Ue).width-B;break}for(let I=0;I<u[A].length;I++)dt(this,Rt).showStroke&&(dt(this,Be).lineJoin="round",dt(this,Be).strokeStyle=dt(this,Rt).strokeColor,dt(this,Be).lineWidth=dt(this,Rt).strokeWidth,dt(this,Be).strokeText(u[A][I],s+I*dt(this,Rt).fontSize+dt(this,Rt).letterSpacing*I,A*dt(this,Rt).fontSize+dt(this,Rt).lineSpacing*A+b)),dt(this,Be).fillText(u[A][I],I*dt(this,Rt).fontSize+dt(this,Rt).letterSpacing*I+s,A*dt(this,Rt).fontSize+dt(this,Rt).lineSpacing*A+b)}return{state:"success",video:new VideoFrame(dt(this,Ue),{timestamp:l})}}async generateImage(){const{video:l}=await this.tick(0),u=new OffscreenCanvas(l.codedWidth,l.codedHeight);u.getContext("2d").drawImage(l,0,0,l.codedWidth,l.codedHeight);const p=await u.convertToBlob(),_=document.createElement("a");_.href=URL.createObjectURL(p),_.download="text.png",_.click()}async clone(){return new $u(dt(this,Rt),dt(this,ss))}destroy(){dt(this,Ue).remove()}};Ue=new WeakMap,Be=new WeakMap,ss=new WeakMap,Rt=new WeakMap,dr=new WeakMap,Oi=new WeakSet,Eu=function(){let l=0,u=0;const h=dt(this,Rt);return l=Math.max(h.showStroke?h.strokeWidth:0,h.showShadow?Math.max(h.shadowBlur,h.shadowOffsetX):0),u=Math.max(h.showStroke?h.strokeWidth:0,h.showShadow?Math.max(h.shadowBlur,h.shadowOffsetY):0),{xPadding:l,yPadding:u}},Cu=function(l){return Math.max(...l.map(u=>dt(this,Rt).fontSize*u.length+dt(this,Rt).letterSpacing*(u.length-1)))},Tu=function(l){return dt(this,Rt).fontSize*l.length+dt(this,Rt).lineSpacing*(l.length-1)};let Uu=$u;var as;const Wu=class Wu{constructor(l){jl(this,"ready");An(this,as,{width:0,height:0,duration:0});this.ready=Promise.resolve({width:0,height:0,duration:l})}get meta(){return dt(this,as)}set meta(l){In(this,as,l)}async tick(l){return{state:"success"}}async clone(){return new Wu(dt(this,as).duration)}destroy(){}};as=new WeakMap;let Au=Wu;const jb={class:"flex-1 flex items-center justify-center"},Kb={class:"control-bar w-full px-4 py-4 flex items-center gap-4"},Zb={class:"text-white text-base"},Jb={class:"text-white text-base"},Qb={class:"flex w-full items-center justify-center gap-6"},t1={class:"text-white hover:text-purple-500 transition-colors"},e1={class:"ml-auto flex items-center gap-4"},i1=Re({__name:"Player",props:{tracks:{},currentTime:{},playerDuration:{}},emits:["prevFrame","nextFrame","timeUpdate","captureImage","fullscreenChange","updateClipProps"],setup(d,{expose:l,emit:u}){const h=d,p=u,_=_r(),y=zu("activeClip"),s=_t(!0),b=_t(!1),A=_t(100),B=_t(!1),I=_t(!1),U=_t(null),G=_t(null),t=_t(0);let e=null;ge(()=>B.value||A.value===0?"fa-volume-mute":A.value<30?"fa:volume-off":A.value<70?"fa-volume-down":"fa-volume-up");const n=ge(()=>_.getCanvasSize),o=ge(()=>{let H=0;return h.tracks.forEach(Q=>{Q.clips.forEach(Y=>{H++})}),H}),f=H=>{H?(e.play({start:h.currentTime*1e6}),b.value=!0):(e.pause(),b.value=!1)},g=()=>{b.value&&f(!1),p("timeUpdate",h.currentTime-1/30),e.previewFrame(h.currentTime*1e6)},v=()=>{b.value&&f(!1),p("timeUpdate",h.currentTime+1/30),e.previewFrame(h.currentTime*1e6)},w=()=>{I.value=!I.value,I.value?G.value&&G.value.requestFullscreen():document.exitFullscreen()},S=H=>{const Q=document.activeElement;if(!(Q instanceof HTMLInputElement||Q instanceof HTMLTextAreaElement||(Q==null?void 0:Q.getAttribute("contenteditable"))==="true"))switch(H.code){case"Space":H.preventDefault(),f(!b.value);break;case"ArrowLeft":H.preventDefault(),g();break;case"ArrowRight":H.preventDefault(),v();break}},k=()=>{e=new Xx(U.value,{bgColor:"#000",width:1920,height:1080}),console.log(e),P(),e.previewFrame(0),e.on("timeupdate",H=>{p("timeUpdate",H/1e6)}),e.on("playing",()=>{console.log("playing")}),e.on("paused",()=>{console.log("paused"),h.currentTime>=h.playerDuration&&(b.value=!1,p("timeUpdate",0))}),e.on("activeSpriteChange",H=>{for(const[Q,Y]of F.entries())Object.is(Y,H)&&y(Q)})},F=new Map,P=()=>{h.tracks.forEach(H=>{H.clips.forEach(Q=>{et(Q)})})},M=H=>{et(H)},D=H=>{if(!H)return e.activeSprite=null;const Q=F.get(H.id);e&&(Q!=null&&Q.visible)&&(e.activeSprite=Q)},et=async H=>{if(F.has(H.id))return;let Q=null;switch(H.type){case"video":{let Y=await Jl(H.path),vt=await new Mu(await Y.stream());vt.tickInterceptor=async(Pt,ie)=>{let Te=[];for(const ht of ie.audio)Te.push(ht.map(V=>V=V*(H.volume/100)));return ie.audio=Te,ie.video=await at(ie.video),ie},Number(H.sourceStartTime)>0&&(vt=(await vt.split(Number(H.sourceStartTime)*1e6))[1]),Q=new zs(vt);break}case"audio":{const Y=await Jl(H.path);let vt=await new Ou(await Y.stream());if(Number(H.sourceStartTime)>0){const Pt=await vt.split(Number(H.sourceStartTime)*1e6);Number(H.sourceEndTime)?vt=(await Pt[1].split((Number(H.originalDuration)-Number(H.sourceEndTime)-Number(H.sourceStartTime))*1e6))[0]:vt=Pt[1]}Q=new zs(vt),Q.visible=!1;break}case"image":{const Y=await Jl(H.path);let vt=null;if(H.isAnimateImg){const Pt=Y.name.split(".").pop();vt=new bo({type:`image/${Pt}`,stream:await Y.stream()})}else vt=new bo(await Y.stream());Q=new zs(vt);break}case"text":{const Y=new Uu(H.textConfig,(vt,Pt)=>{p("updateClipProps",H.id,{w:vt,h:Pt})});Q=new zs(Y),Q.visible=!1;break}case"filter":{const Y=new Au(Number(H.duration)*1e6);Q=new zs(Y);break}}_.unsubscribeFromClipUpdates(H.id),_.subscribeToClipUpdates(H.id,async(Y,vt)=>{lt(Y,vt)}),Q&&(Q.time.offset=Number(H.startTime)*1e6,Q.time.duration=Number(H.duration)*1e6,Q.opacity=Number((H.opacity/100).toFixed(2)),Q.rect.fixedScaleCenter=!0,Q.rect.fixedAspectRatio=!0,F.set(H.id,Q),await(e==null?void 0:e.addSprite(Q)),t.value++,H.type!=="audio"&&(H.w?(Q.rect.x=H.x,Q.rect.y=H.y,Q.rect.w=H.w,Q.rect.h=H.h,Q.rect.angle=H.angle):H.type==="text"?p("updateClipProps",H.id,{x:Q.rect.x,y:Q.rect.y,w:H.textConfig.width,h:H.textConfig.height,angle:Q.rect.angle}):p("updateClipProps",H.id,{x:Q.rect.x,y:Q.rect.y,w:Q.rect.w,h:Q.rect.h,angle:Q.rect.angle})),Q.rect.on("propsChange",Y=>{H.type==="text"?"w"in Y&&H.w&&(H.textConfig.fontSize=Y.w/H.w*H.textConfig.fontSize,H.w=Y.w):p("updateClipProps",H.id,Y)}))},at=async(H,Q)=>{if(!H)return null;const Y=H.displayWidth,vt=H.displayHeight,Pt=h.tracks.flatMap(nt=>nt.clips).filter(nt=>nt.type==="filter"&&h.currentTime>=nt.startTime&&h.currentTime<nt.startTime+nt.duration);if(!Pt.length)return H;const ie=new OffscreenCanvas(Y,vt),Te=ie.getContext("2d");if(!Te)return H;Te.drawImage(H,0,0);const ht=Te.getImageData(0,0,Y,vt);H.close();const V=ht.data;for(const nt of Pt){const ot=nt.intensity/100;switch(nt.filterType){case"grayscale":for(let ut=0;ut<V.length;ut+=4){const Nt=(V[ut]+V[ut+1]+V[ut+2])/3,jt=[V[ut],V[ut+1],V[ut+2]];V[ut]=jt[0]*(1-ot)+Nt*ot,V[ut+1]=jt[1]*(1-ot)+Nt*ot,V[ut+2]=jt[2]*(1-ot)+Nt*ot}break;case"sepia":for(let ut=0;ut<V.length;ut+=4){const Nt=V[ut],jt=V[ut+1],Ae=V[ut+2],mn=Math.min(255,Nt*.393+jt*.769+Ae*.189),ze=Math.min(255,Nt*.349+jt*.686+Ae*.168),ue=Math.min(255,Nt*.272+jt*.534+Ae*.131);V[ut]=Nt*(1-ot)+mn*ot,V[ut+1]=jt*(1-ot)+ze*ot,V[ut+2]=Ae*(1-ot)+ue*ot}break;case"invert":for(let ut=0;ut<V.length;ut+=4){const Nt=[V[ut],V[ut+1],V[ut+2]];V[ut]=Nt[0]*(1-ot)+(255-Nt[0])*ot,V[ut+1]=Nt[1]*(1-ot)+(255-Nt[1])*ot,V[ut+2]=Nt[2]*(1-ot)+(255-Nt[2])*ot}break;case"brightness":const Qt=1+ot;for(let ut=0;ut<V.length;ut+=4){const Nt=[V[ut],V[ut+1],V[ut+2]];V[ut]=Math.min(255,Nt[0]*Qt),V[ut+1]=Math.min(255,Nt[1]*Qt),V[ut+2]=Math.min(255,Nt[2]*Qt)}break;case"blur":const Wt=Math.floor(ot*10),Yt=new Uint8ClampedArray(V);for(let ut=0;ut<vt;ut++)for(let Nt=0;Nt<Y;Nt++){let jt=0,Ae=0,mn=0,ze=0,ue=0;for(let Ni=-Wt;Ni<=Wt;Ni++)for(let On=-Wt;On<=Wt;On++){const qt=Nt+On,Nn=ut+Ni;if(qt>=0&&qt<Y&&Nn>=0&&Nn<vt){const di=(Nn*Y+qt)*4;jt+=Yt[di],Ae+=Yt[di+1],mn+=Yt[di+2],ze+=Yt[di+3],ue++}}const qe=(ut*Y+Nt)*4;V[qe]=jt/ue,V[qe+1]=Ae/ue,V[qe+2]=mn/ue,V[qe+3]=ze/ue}break}}return Te.putImageData(ht,0,0),new VideoFrame(ie,{timestamp:H.timestamp,duration:H.duration,displayWidth:Y,displayHeight:vt})},Ft=()=>{let H=0;h.tracks.forEach(Q=>{Q.clips.forEach(Y=>{const vt=F.get(Y.id);!vt||Y.type==="text"||(vt.zIndex=H++)}),Q.clips.forEach(Y=>{const vt=F.get(Y.id);!vt||Y.type!=="text"||(vt.zIndex=H++)})})},lt=async(H,Q="default")=>{if(f(!1),!F.has(H.id))return;const Y=F.get(H.id);if(Q==="delete"){e==null||e.removeSprite(Y),F.delete(H.id);return}if(Q==="resize"&&(H.type==="video"||H.type==="audio")){e==null||e.removeSprite(Y),F.delete(H.id),await et(H);return}if(Y.time.offset=H.startTime*1e6,Y.time.duration=Number(H.duration)*1e6,Y.opacity=Number((H.opacity/100).toFixed(2)),Ft(),H.type==="text"){const vt=Y.getClip();vt.textConfig=H.textConfig,Y.rect.w=H.w,Y.rect.h=H.h,Y.preFrame(h.currentTime*1e6)}else H.type==="filter"?h.tracks.forEach(vt=>{vt.clips.forEach(Pt=>{if((Pt.type==="video"||Pt.type==="image")&&Pt.startTime<=h.currentTime&&Pt.endTime>=h.currentTime){const ie=F.get(Pt.id);ie&&ie.preFrame(h.currentTime*1e6-ie.time.offset)}})}):H.type!=="audio"&&(Y.rect.x=H.x,Y.rect.y=H.y,Y.rect.w=H.w,Y.rect.h=H.h,Y.rect.angle=H.angle);e==null||e.previewFrame(h.currentTime*1e6)},Tt=()=>{e==null||e.destroy(),F.clear(),t.value=0,Ws(()=>{k()})},Bt=async()=>{const H=await(e==null?void 0:e.createCombinator());try{const Q={dangerouslyUseHTMLString:!0,showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1,showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"停止",customClass:"export-progress-dialog",beforeClose:(Y,vt,Pt)=>{Y==="cancel"&&(H==null||H.destroy(),Pt())}};Zl.alert(`
            <div class="flex flex-col gap-2 w-full min-w-[300px]">
                <div class="text-center text-base">0%</div>
                <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        `,"导出进度",Q),await Ws(),H.on("OutputProgress",Y=>{const vt=Math.round(Y*100),Pt=document.querySelector(".el-message-box__message");if(Pt&&(Pt.innerHTML=`
                    <div class="flex flex-col gap-2 w-full min-w-[300px]">
                        <div class="text-center text-base">${vt}%</div>
                        <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: ${vt}%"></div>
                        </div>
                    </div>
                `,Y===1)){const ie=document.querySelector(".el-message-box__cancel");ie&&(ie.style.display="none"),Pt.innerHTML=`
                        <div class="flex flex-col gap-2 w-full min-w-[300px]">
                            <div class="text-center text-green-500 text-base">导出完成！</div>
                            <div class="w-full bg-[#2b2b2b] rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                            </div>
                        </div>
                    `,setTimeout(()=>{Zl.close()},3e3)}}),await(H==null?void 0:H.output().pipeTo(await uw()))}catch(Q){Zl.close(),cr.error("导出失败："+Q.message)}},Ht=H=>{const Q=Math.floor(H/60),Y=Math.floor(H%60);return`${Q}:${Y.toString().padStart(2,"0")}`},it=()=>{G.value&&new ResizeObserver(Q=>{var Y;for(let vt of Q){const{width:Pt,height:ie}=vt.contentRect,Te=(Y=document.querySelector(".control-bar"))==null?void 0:Y.clientHeight,ht=ie-Te;Pt/ht>1.7777777777777777?_.setCanvasSize({width:ht*16/9,height:ht}):_.setCanvasSize({width:Pt,height:Pt*9/16})}}).observe(G.value)};os(()=>{kt.setLogLevel(kt.warn),k(),it(),window.addEventListener("keydown",S)}),Zs(()=>{e==null||e.destroy(),F.clear(),e=null,t.value=0,window.removeEventListener("keydown",S);for(const H of F.keys())_.unsubscribeFromClipUpdates(H)}),Mn(()=>t.value,H=>{if(H===o.value){s.value=!1,e==null||e.previewFrame(h.currentTime*1e6);for(const Q of h.tracks.flatMap(Y=>Y.clips))Ft();setTimeout(()=>{const Q=e==null?void 0:e.captureImage();p("captureImage",Q)},500)}}),Mn(()=>h.currentTime,H=>{b.value||e.previewFrame(H*1e6)}),l({refreshPlayer:Tt,addClip:M,activeClip:D,handleExport:Bt});const ee=document.createElement("style");return ee.textContent=`
.export-progress-dialog .el-message-box__content {
    padding: 20px;
}
.export-progress-dialog .el-message-box__message {
    padding: 0;
}
.export-progress-dialog .el-message-box__message p {
    margin: 0;
}
.export-progress-dialog .el-message-box__container {
    width: 100%;
}
`,document.head.appendChild(ee),(H,Q)=>{const Y=sw("loading");return rw((ct(),yt("div",{ref_key:"playerRef",ref:G,class:"player-container w-full h-full bg-[#1b1b1b] relative flex flex-col"},[O("div",jb,[O("div",{ref_key:"avCanvas",ref:U,class:"",style:Mi({width:Ct(n).width+"px",height:Ct(n).height+"px"})},null,4)]),O("div",Kb,[O("div",Zb,De(Ht(H.currentTime)),1),Q[2]||(Q[2]=O("div",{class:"text-white text-base"},"/",-1)),O("div",Jb,De(Ht(H.playerDuration)),1),O("div",Qb,[O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:g},[J(Ct(re),{icon:"fa-step-backward"})]),O("button",t1,[Ct(b)?(ct(),ei(Ct(re),{key:1,icon:"fa-pause",onClick:Q[1]||(Q[1]=vt=>f(!1))})):(ct(),ei(Ct(re),{key:0,icon:"fa-play",onClick:Q[0]||(Q[0]=vt=>f(!0))}))]),O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:v},[J(Ct(re),{icon:"fa-step-forward"})])]),O("div",e1,[O("button",{class:"text-white hover:text-purple-500 transition-colors",onClick:w},[J(Ct(re),{icon:Ct(I)?"fa-compress":"fa-expand"},null,8,["icon"])])])])])),[[Y,Ct(s)]])}}}),n1=Ei(i1,[["__scopeId","data-v-b89c3101"]]);let Ya;const r1=new Uint8Array(16);function s1(){if(!Ya&&(Ya=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ya))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ya(r1)}const Pe=[];for(let d=0;d<256;++d)Pe.push((d+256).toString(16).slice(1));function a1(d,l=0){return Pe[d[l+0]]+Pe[d[l+1]]+Pe[d[l+2]]+Pe[d[l+3]]+"-"+Pe[d[l+4]]+Pe[d[l+5]]+"-"+Pe[d[l+6]]+Pe[d[l+7]]+"-"+Pe[d[l+8]]+Pe[d[l+9]]+"-"+Pe[d[l+10]]+Pe[d[l+11]]+Pe[d[l+12]]+Pe[d[l+13]]+Pe[d[l+14]]+Pe[d[l+15]]}const o1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Yd={randomUUID:o1};function is(d,l,u){if(Yd.randomUUID&&!d)return Yd.randomUUID();d=d||{};const h=d.random||(d.rng||s1)();return h[6]=h[6]&15|64,h[8]=h[8]&63|128,a1(h)}const l1={class:"p-5"},u1={class:"flex items-center justify-center"},h1={class:"flex items-center justify-center"},f1={class:"h-[calc(100vh-7rem)] mt-2 overflow-y-auto"},d1={class:"w-full grid grid-cols-2 gap-3"},c1=["onContextmenu","onMouseover","onMouseleave","onDragstart"],p1={class:"relative w-full h-full bg-[#121212]"},_1=["src"],g1=["src"],m1={key:2,class:"w-full aspect-video flex items-center justify-center"},v1={key:3,class:"absolute w-[12%] h-[12%] right-[16%] bottom-[12%] flex items-center gap-1 rounded-full"},y1={class:"text-tiny truncate mt-1"},w1=Re({__name:"mediaLibrary",emits:["add-clip"],setup(d,{emit:l}){const u=_r(),h=zu("addClip"),p=_t([]),_=new Map,y=g=>v=>{_.set(g,v)};os(()=>{s()});const s=()=>{Ce.medias.toArray().then(async g=>{if(g){let v=[];for(const w of g){const S=await hw(w.path);v.push({...w,filePath:S})}p.value=v}})},b=async g=>{const v=await Ce.medias.where({name:g.name}).first();if(v&&v.size===g.size)return cr.warning("文件已存在"),!1;const w=g.name.split(".").pop();let S="";switch(w){case"mp4":case"mov":case"avi":case"wmv":S="video";break;case"mp3":case"wav":case"m4a":case"m4s":case"m3u8":case"aac":case"ogg":case"flac":case"webm":case"opus":S="audio";break;case"png":case"jpg":case"jpeg":case"gif":case"bmp":case"tiff":case"ico":case"svg":case"webp":case"avif":S="image";break;default:return cr.warning("请检查文件格式"),!1}let k="/"+S+"/"+g.name;const F=await Xs(k);let P=!1;if(F.exists()&&(await F.remove(),P=!0),await Fu(k,g.stream()),await Xs(k).exists()){const M={name:g.name,size:g.size,type:S,path:k,isAnimateImg:!1};switch(S){case"video":const et=await new Mu(g.stream()).ready;et&&(M.duration=et.duration);break;case"audio":const Ft=await new Ou(await g.stream()).ready;Ft&&(M.duration=Ft.duration);break;case"image":try{M.duration=3e6;const lt=["gif","webp","avif","webp"],Tt=g.name.split(".").pop();if(lt.includes(Tt)){const Bt=new bo({type:`image/${Tt}`,stream:await g.stream()}),Ht=await Bt.ready;console.log(Ht);const{video:it}=await Bt.tick(0),{video:ee}=await Bt.tick(1e6),Q=new OffscreenCanvas(it.codedWidth,it.codedHeight).getContext("2d");Q.drawImage(it,0,0);const Y=Q.getImageData(0,0,it.codedWidth,it.codedHeight);Q.clearRect(0,0,it.codedWidth,it.height),Q.drawImage(ee,0,0);const vt=Q.getImageData(0,0,ee.codedWidth,ee.codedHeight),Pt=A(Y.data,vt.data);M.isAnimateImg=!0}else M.isAnimateImg=!1}catch(lt){console.log(lt)}break}console.log(M.duration),P&&v?(M.updateTime=new Date().getTime(),await Ce.medias.where({name:g.name}).modify(M)):(M.createTime=new Date().getTime(),await Ce.medias.add(M)),s()}else cr.error("上传失败");return!1},A=(g,v)=>{if(g.length!==v.length)return!1;for(let w=0;w<g.length;w++)if(g[w]!==v[w])return!1;return!0},B=ge(()=>u.getShowContextMenu),I=ge(()=>u.getContextMenuPosition),U=_t(""),G=(g,v)=>{U.value=v.id,u.setShowContextMenu(!0);const{offsetX:w,offsetY:S}=g;u.setContextMenuPosition({x:w,y:S}),console.log(I.value)},t=(g,v)=>{g.hovered=!0;const w=_.get(v);w&&g.type==="video"&&w.play()},e=(g,v)=>{g.hovered=!1;const w=_.get(v);w&&g.type==="video"&&(w.currentTime=0,w.pause())},n=(g,v)=>{g.dataTransfer&&(g.dataTransfer.effectAllowed="move",g.dataTransfer.setData("application/json",JSON.stringify(v)),g.dataTransfer.setData("text/plain",JSON.stringify(v)),u.setDragData(v))},o=g=>{const v={id:is(),type:g.type,isAnimateImg:g.isAnimateImg,name:g.name,path:g.path,duration:g.duration?Number(g.duration)/1e6:5,startTime:0,endTime:g.duration?Number(g.duration)/1e6:5,opacity:100,angle:0};g.type==="image"&&(v.duration=5,v.endTime=5),h==null||h(v,!0)},f=g=>{Ce.medias.where({id:g.id}).delete(),s()};return(g,v)=>{const w=$t("upload-filled"),S=$t("el-icon"),k=$t("el-upload"),F=$t("Headset"),P=$t("CirclePlus"),M=$t("DeleteFilled");return ct(),yt("div",l1,[O("div",u1,[J(k,{class:"w-full",drag:"",action:"163",multiple:"","show-file-list":!1,"before-upload":b},{tip:Xt(()=>v[1]||(v[1]=[])),default:Xt(()=>[O("div",h1,[J(S,{class:"mr-1",size:"30"},{default:Xt(()=>[J(w)]),_:1}),v[0]||(v[0]=O("div",{class:"flex flex-col items-start"},[O("div",{class:"text-tiny"}," 拖拽或上传文件 "),O("div",{class:"flex items-center justify-center text-xs"}," 支持视频、音频、图片格式 ")],-1))])]),_:1})]),O("div",f1,[O("div",d1,[(ct(!0),yt(fi,null,gn(p.value,(D,et)=>(ct(),yt("div",{class:"relative flex flex-col justify-center w-full hover:bg-[#121212] p-1.5 rounded-md",onContextmenu:ti(at=>G(at,D),["prevent"]),onMouseover:at=>t(D,et),onMouseleave:at=>e(D,et),onDragstart:at=>n(at,D),draggable:"true"},[O("div",p1,[D.type==="image"?(ct(),yt("img",{key:0,src:D.filePath,alt:"",class:"aspect-video object-contain rounded"},null,8,_1)):oe("",!0),D.type==="video"?(ct(),yt("video",{key:1,ref_for:!0,ref:y(et),src:D.filePath,muted:"",loop:"",disablepictureinpicture:"",class:"aspect-video object-contain rounded"},null,8,g1)):oe("",!0),D.type==="audio"?(ct(),yt("div",m1,[J(S,null,{default:Xt(()=>[J(F)]),_:1})])):oe("",!0),D.hovered?(ct(),yt("div",v1,[J(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:ti(at=>o(D),["stop"])},{default:Xt(()=>[J(P)]),_:2},1032,["onClick"]),J(S,{class:"w-full h-full bg-[#333333] rounded-full cursor-pointer",onClick:ti(at=>f(D),["stop"])},{default:Xt(()=>[J(M)]),_:2},1032,["onClick"])])):oe("",!0),Ct(B)&&D.id===U.value?(ct(),yt("div",{key:4,class:"absolute flex flex-col justify-center bg-[#121212] py-1.5 rounded-md",style:Mi({left:Ct(I).x+"px",top:Ct(I).y+"px"})},v[2]||(v[2]=[O("div",{class:"px-3 py-0.5 text-tiny hover:bg-gray cursor-pointer"},"裁剪",-1)]),4)):oe("",!0)]),O("div",y1,De(D.name),1)],40,c1))),256))])])])}}}),x1=Ei(w1,[["__scopeId","data-v-30c9ea77"]]),b1=""+new URL("1-DX-6C8MT.png",import.meta.url).href,S1=""+new URL("2-Bbrfykah.png",import.meta.url).href,Vd=d=>new URL(Object.assign({"../assets/image/text/1.png":b1,"../assets/image/text/2.png":S1})[`../assets/image/${d}`],import.meta.url).href,U1=[{preview:Vd("text/1.png"),name:"描边标题",style:{content:"描边文字效果",fontSize:48,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFFFFF",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!1,shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,showStroke:!0,strokeColor:"red",strokeWidth:3}},{preview:Vd("text/2.png"),name:"阴影标题",style:{content:"阴影文字效果",fontSize:52,fontFamily:"Microsoft YaHei",bold:!0,italic:!1,color:"#FFD93D",opacity:100,lineSpacing:0,letterSpacing:0,align:"center",showShadow:!0,shadowColor:"rgba(59, 59, 59, 1)",shadowBlur:10,shadowOffsetX:4,shadowOffsetY:4,showStroke:!1,strokeColor:"#000000",strokeWidth:0}}],E1={class:"p-4"},C1={class:"grid grid-cols-2 gap-4"},T1={class:"h-8 text-white text-xl mb-2"},A1={class:"text-[#666] text-sm"},I1={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},B1=["onClick","onDragstart"],z1={class:"h-8 text-white text-xl mb-2"},F1=["src"],k1={class:"text-[#666] text-sm"},L1={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},P1=Re({__name:"textLibrary",setup(d){const l=_r(),u=zu("addClip"),h=_t({preview:"Aa",name:"基础文字",style:{fontSize:72,fontFamily:"Microsoft YaHei",color:"#ffffff"}}),p=s=>{const b=y(s);l.setDragData(b)},_=s=>{const b=y(s);u==null||u(b,!0)},y=s=>({id:is(),type:"text",name:s.name,duration:5,startTime:0,endTime:5,opacity:100,angle:0,textConfig:{content:s.name||"基础文字",lineSpacing:0,letterSpacing:0,showStroke:!1,strokeColor:"#ffffff",strokeWidth:0,showShadow:!1,shadowColor:"#ffffff",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,...s.style}});return(s,b)=>{const A=$t("el-icon");return ct(),yt("div",E1,[O("div",C1,[O("div",{class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",onClick:b[0]||(b[0]=B=>_(Ct(h))),draggable:"true",onDragstart:b[1]||(b[1]=B=>p(Ct(h)))},[O("div",T1,De(Ct(h).preview),1),O("div",A1,De(Ct(h).name),1),O("div",I1,[J(A,{class:"text-white text-2xl"},{default:Xt(()=>[J(Ct(lu))]),_:1})])],32),(ct(!0),yt(fi,null,gn(Ct(U1),B=>(ct(),yt("div",{key:B.name,class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",onClick:I=>_(B),draggable:"true",onDragstart:I=>p(B)},[O("div",z1,[O("img",{src:B.preview,class:"w-full h-full object-contain"},null,8,F1)]),O("div",k1,De(Ct(h).name),1),O("div",L1,[J(A,{class:"text-white text-2xl"},{default:Xt(()=>[J(Ct(lu))]),_:1})])],40,B1))),128))])])}}}),D1={class:"p-4"},R1={class:"grid grid-cols-2 gap-4"},M1=["onDragstart"],O1={class:"preview-box h-8 mb-2"},N1={class:"text-[#666] text-sm"},G1={class:"absolute inset-0 bg-purple-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity rounded-lg"},H1="/preview.jpg",Y1=Re({__name:"filterLibrary",setup(d){const l=_r(),u=[{type:"grayscale",name:"黑白"},{type:"sepia",name:"复古"},{type:"invert",name:"反色"},{type:"brightness",name:"明亮"},{type:"blur",name:"模糊"}],h=_=>{switch(_){case"grayscale":return{filter:"grayscale(100%)"};case"sepia":return{filter:"sepia(100%)"};case"invert":return{filter:"invert(100%)"};case"brightness":return{filter:"brightness(150%)"};case"blur":return{filter:"blur(2px)"};default:return{}}},p=(_,y)=>{if(!_.dataTransfer)return;const s={type:"filter",filterType:y.type,name:y.name,intensity:100,duration:5,startTime:0,endTime:5};_.dataTransfer.setData("application/json",JSON.stringify(s)),l.setDragData(s),_.dataTransfer.effectAllowed="copy"};return(_,y)=>{const s=$t("el-icon");return ct(),yt("div",D1,[O("div",R1,[(ct(),yt(fi,null,gn(u,b=>O("div",{key:b.type,class:"relative group cursor-pointer bg-[#2a2a2a] hover:bg-[#3a3a3a] rounded-lg p-4 flex flex-col items-center",draggable:"true",onDragstart:A=>p(A,b)},[O("div",O1,[O("img",{src:H1,class:"h-full object-contain",style:Mi(h(b.type))},null,4)]),O("div",N1,De(b.name),1),O("div",G1,[J(s,{class:"text-white text-2xl"},{default:Xt(()=>[J(Ct(lu))]),_:1})])],40,M1)),64))])])}}}),V1=Ei(Y1,[["__scopeId","data-v-ab015f29"]]),$1={class:"h-screen"},W1={class:"flex flex-col items-center justify-center"},X1=Re({__name:"clipMenu",setup(d){const l=[{name:"媒体库",component:x1},{name:"文字",component:P1},{name:"滤镜",component:V1}];return(u,h)=>{const p=$t("Files"),_=$t("el-icon"),y=$t("el-tab-pane"),s=$t("el-tabs");return ct(),yt("div",$1,[J(s,{type:"border-card",tabPosition:"left"},{default:Xt(()=>[(ct(),yt(fi,null,gn(l,b=>J(y,{label:"User"},{label:Xt(()=>[O("div",W1,[J(_,null,{default:Xt(()=>[J(p)]),_:1}),O("div",null,De(b.name),1)])]),default:Xt(()=>[(ct(),ei(aw(b.component),{class:"w-full h-screen bg-[#303030]"}))]),_:2},1024)),64))]),_:1})])}}}),q1=Ei(X1,[["__scopeId","data-v-946103cd"]]);var Ui=typeof window<"u"?window:null,Vu=Ui===null,Ks=Vu?void 0:Ui.document,Bi="addEventListener",zi="removeEventListener",ru="getBoundingClientRect",Ls="_a",Fi="_b",on="_c",Va="horizontal",ki=function(){return!1},j1=Vu?"calc":["","-webkit-","-moz-","-o-"].filter(function(d){var l=Ks.createElement("div");return l.style.cssText="width:"+d+"calc(9px)",!!l.style.length}).shift()+"calc",Pc=function(d){return typeof d=="string"||d instanceof String},$d=function(d){if(Pc(d)){var l=Ks.querySelector(d);if(!l)throw new Error("Selector "+d+" did not match a DOM element");return l}return d},Ge=function(d,l,u){var h=d[l];return h!==void 0?h:u},$a=function(d,l,u,h){if(l){if(h==="end")return 0;if(h==="center")return d/2}else if(u){if(h==="start")return 0;if(h==="center")return d/2}return d},K1=function(d,l){var u=Ks.createElement("div");return u.className="gutter gutter-"+l,u},Z1=function(d,l,u){var h={};return Pc(l)?h[d]=l:h[d]=j1+"("+l+"% - "+u+"px)",h},J1=function(d,l){var u;return u={},u[d]=l+"px",u},Wd=function(d,l){if(l===void 0&&(l={}),Vu)return{};var u=d,h,p,_,y,s,b;Array.from&&(u=Array.from(u));var A=$d(u[0]),B=A.parentNode,I=getComputedStyle?getComputedStyle(B):null,U=I?I.flexDirection:null,G=Ge(l,"sizes")||u.map(function(){return 100/u.length}),t=Ge(l,"minSize",100),e=Array.isArray(t)?t:u.map(function(){return t}),n=Ge(l,"maxSize",1/0),o=Array.isArray(n)?n:u.map(function(){return n}),f=Ge(l,"expandToMin",!1),g=Ge(l,"gutterSize",10),v=Ge(l,"gutterAlign","center"),w=Ge(l,"snapOffset",30),S=Array.isArray(w)?w:u.map(function(){return w}),k=Ge(l,"dragInterval",1),F=Ge(l,"direction",Va),P=Ge(l,"cursor",F===Va?"col-resize":"row-resize"),M=Ge(l,"gutter",K1),D=Ge(l,"elementStyle",Z1),et=Ge(l,"gutterStyle",J1);F===Va?(h="width",p="clientX",_="left",y="right",s="clientWidth"):F==="vertical"&&(h="height",p="clientY",_="top",y="bottom",s="clientHeight");function at(ht,V,nt,ot){var Qt=D(h,V,nt,ot);Object.keys(Qt).forEach(function(Wt){ht.style[Wt]=Qt[Wt]})}function Ft(ht,V,nt){var ot=et(h,V,nt);Object.keys(ot).forEach(function(Qt){ht.style[Qt]=ot[Qt]})}function lt(){return b.map(function(ht){return ht.size})}function Tt(ht){return"touches"in ht?ht.touches[0][p]:ht[p]}function Bt(ht){var V=b[this.a],nt=b[this.b],ot=V.size+nt.size;V.size=ht/this.size*ot,nt.size=ot-ht/this.size*ot,at(V.element,V.size,this[Fi],V.i),at(nt.element,nt.size,this[on],nt.i)}function Ht(ht){var V,nt=b[this.a],ot=b[this.b];this.dragging&&(V=Tt(ht)-this.start+(this[Fi]-this.dragOffset),k>1&&(V=Math.round(V/k)*k),V<=nt.minSize+nt.snapOffset+this[Fi]?V=nt.minSize+this[Fi]:V>=this.size-(ot.minSize+ot.snapOffset+this[on])&&(V=this.size-(ot.minSize+this[on])),V>=nt.maxSize-nt.snapOffset+this[Fi]?V=nt.maxSize+this[Fi]:V<=this.size-(ot.maxSize-ot.snapOffset+this[on])&&(V=this.size-(ot.maxSize+this[on])),Bt.call(this,V),Ge(l,"onDrag",ki)(lt()))}function it(){var ht=b[this.a].element,V=b[this.b].element,nt=ht[ru](),ot=V[ru]();this.size=nt[h]+ot[h]+this[Fi]+this[on],this.start=nt[_],this.end=nt[y]}function ee(ht){if(!getComputedStyle)return null;var V=getComputedStyle(ht);if(!V)return null;var nt=ht[s];return nt===0?null:(F===Va?nt-=parseFloat(V.paddingLeft)+parseFloat(V.paddingRight):nt-=parseFloat(V.paddingTop)+parseFloat(V.paddingBottom),nt)}function H(ht){var V=ee(B);if(V===null||e.reduce(function(Wt,Yt){return Wt+Yt},0)>V)return ht;var nt=0,ot=[],Qt=ht.map(function(Wt,Yt){var ut=V*Wt/100,Nt=$a(g,Yt===0,Yt===ht.length-1,v),jt=e[Yt]+Nt;return ut<jt?(nt+=jt-ut,ot.push(0),jt):(ot.push(ut-jt),ut)});return nt===0?ht:Qt.map(function(Wt,Yt){var ut=Wt;if(nt>0&&ot[Yt]-nt>0){var Nt=Math.min(nt,ot[Yt]-nt);nt-=Nt,ut=Wt-Nt}return ut/V*100})}function Q(){var ht=this,V=b[ht.a].element,nt=b[ht.b].element;ht.dragging&&Ge(l,"onDragEnd",ki)(lt()),ht.dragging=!1,Ui[zi]("mouseup",ht.stop),Ui[zi]("touchend",ht.stop),Ui[zi]("touchcancel",ht.stop),Ui[zi]("mousemove",ht.move),Ui[zi]("touchmove",ht.move),ht.stop=null,ht.move=null,V[zi]("selectstart",ki),V[zi]("dragstart",ki),nt[zi]("selectstart",ki),nt[zi]("dragstart",ki),V.style.userSelect="",V.style.webkitUserSelect="",V.style.MozUserSelect="",V.style.pointerEvents="",nt.style.userSelect="",nt.style.webkitUserSelect="",nt.style.MozUserSelect="",nt.style.pointerEvents="",ht.gutter.style.cursor="",ht.parent.style.cursor="",Ks.body.style.cursor=""}function Y(ht){if(!("button"in ht&&ht.button!==0)){var V=this,nt=b[V.a].element,ot=b[V.b].element;V.dragging||Ge(l,"onDragStart",ki)(lt()),ht.preventDefault(),V.dragging=!0,V.move=Ht.bind(V),V.stop=Q.bind(V),Ui[Bi]("mouseup",V.stop),Ui[Bi]("touchend",V.stop),Ui[Bi]("touchcancel",V.stop),Ui[Bi]("mousemove",V.move),Ui[Bi]("touchmove",V.move),nt[Bi]("selectstart",ki),nt[Bi]("dragstart",ki),ot[Bi]("selectstart",ki),ot[Bi]("dragstart",ki),nt.style.userSelect="none",nt.style.webkitUserSelect="none",nt.style.MozUserSelect="none",nt.style.pointerEvents="none",ot.style.userSelect="none",ot.style.webkitUserSelect="none",ot.style.MozUserSelect="none",ot.style.pointerEvents="none",V.gutter.style.cursor=P,V.parent.style.cursor=P,Ks.body.style.cursor=P,it.call(V),V.dragOffset=Tt(ht)-V.end}}G=H(G);var vt=[];b=u.map(function(ht,V){var nt={element:$d(ht),size:G[V],minSize:e[V],maxSize:o[V],snapOffset:S[V],i:V},ot;if(V>0&&(ot={a:V-1,b:V,dragging:!1,direction:F,parent:B},ot[Fi]=$a(g,V-1===0,!1,v),ot[on]=$a(g,!1,V===u.length-1,v),U==="row-reverse"||U==="column-reverse")){var Qt=ot.a;ot.a=ot.b,ot.b=Qt}if(V>0){var Wt=M(V,F,nt.element);Ft(Wt,g,V),ot[Ls]=Y.bind(ot),Wt[Bi]("mousedown",ot[Ls]),Wt[Bi]("touchstart",ot[Ls]),B.insertBefore(Wt,nt.element),ot.gutter=Wt}return at(nt.element,nt.size,$a(g,V===0,V===u.length-1,v),V),V>0&&vt.push(ot),nt});function Pt(ht){var V=ht.i===vt.length,nt=V?vt[ht.i-1]:vt[ht.i];it.call(nt);var ot=V?nt.size-ht.minSize-nt[on]:ht.minSize+nt[Fi];Bt.call(nt,ot)}b.forEach(function(ht){var V=ht.element[ru]()[h];V<ht.minSize&&(f?Pt(ht):ht.minSize=V)});function ie(ht){var V=H(ht);V.forEach(function(nt,ot){if(ot>0){var Qt=vt[ot-1],Wt=b[Qt.a],Yt=b[Qt.b];Wt.size=V[ot-1],Yt.size=nt,at(Wt.element,Wt.size,Qt[Fi],Wt.i),at(Yt.element,Yt.size,Qt[on],Yt.i)}})}function Te(ht,V){vt.forEach(function(nt){if(V!==!0?nt.parent.removeChild(nt.gutter):(nt.gutter[zi]("mousedown",nt[Ls]),nt.gutter[zi]("touchstart",nt[Ls])),ht!==!0){var ot=D(h,nt.a.size,nt[Fi]);Object.keys(ot).forEach(function(Qt){b[nt.a].element.style[Qt]="",b[nt.b].element.style[Qt]=""})}})}return{setSizes:ie,getSizes:lt,collapse:function(V){Pt(b[V])},destroy:Te,parent:B,pairs:vt}};const Q1={class:"ticks h-full"},tS={key:0,class:"tick-mark"},eS={key:1,class:"tick-mark-long"},iS={key:2,class:"tick-label"},Fr=3,Xd=100,nS=15,rS=Re({__name:"timelineRuler",props:{duration:{type:Number,required:!0},zoom:{type:Number,default:1},currentTime:{type:Number,default:0},totalWidth:{type:Number,default:0}},emits:["timeUpdate","scroll"],setup(d,{emit:l}){const u=d,h=l,p=_t(null),_=ge(()=>Fr*u.zoom),y=ge(()=>Math.ceil(u.duration*10)),s=ge(()=>u.currentTime*Fr*u.zoom*10),b=_t(!1),A=_t(0),B=_t(null);let I=null,U=_t(0);const G=v=>{const w=Math.floor(v/10),S=Math.floor(w/60),k=w%60;return`${S}:${k.toString().padStart(2,"0")}`},t=v=>{if(!p.value)return;const w=p.value.getBoundingClientRect(),k=(v.clientX-w.left)/(Fr*u.zoom*10);h("timeUpdate",Math.max(0,Math.min(k,u.duration))),n(v)},e=v=>{if(v.stopPropagation(),!p.value)return;const w=p.value.getBoundingClientRect(),S=v.clientX-w.left,k=Math.max(0,Math.min(S/(Fr*u.zoom*10),u.duration));h("timeUpdate",k),n(v)},n=v=>{b.value=!0,A.value=v.clientX,U.value=v.clientX,document.addEventListener("mousemove",f),document.addEventListener("mouseup",g)},o=()=>{if(!(!b.value||!p.value||!p.value.parentElement)&&B.value){h("scroll",B.value==="right"?nS:-15);const w=p.value.getBoundingClientRect(),S=A.value-w.left,k=Math.max(0,Math.min(S/(Fr*u.zoom*10),u.duration));h("timeUpdate",k),I=requestAnimationFrame(o)}},f=v=>{if(!b.value||!p.value)return;const w=p.value.getBoundingClientRect(),S=p.value.parentElement;if(!S)return;const k=v.clientX-w.left,F=v.clientX-U.value;if(U.value=v.clientX,F!==0){const M=S.getBoundingClientRect();F>0?v.clientX>M.right-Xd?B.value!=="right"&&(B.value="right",o()):B.value=null:v.clientX<M.left+Xd?B.value!=="left"&&(B.value="left",o()):B.value=null}const P=Math.max(0,Math.min(k/(Fr*u.zoom*10),u.duration));h("timeUpdate",P),A.value=v.clientX},g=()=>{b.value=!1,B.value=null,document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",g),I!==null&&(cancelAnimationFrame(I),I=null)};return Zs(()=>{I!==null&&cancelAnimationFrame(I)}),(v,w)=>(ct(),yt(fi,null,[O("div",{class:"ticks-container h-10",ref_key:"rulerContainer",ref:p,style:Mi({width:d.totalWidth+"px"}),onMousedown:t},[O("div",Q1,[(ct(!0),yt(fi,null,gn(Ct(y),S=>(ct(),yt("div",{key:S,class:"tick h-full",style:Mi({left:S*Ct(_)+"px"})},[S%5===0?(ct(),yt("div",tS)):oe("",!0),S%50===0?(ct(),yt("div",eS)):oe("",!0),S%50===0?(ct(),yt("span",iS,De(G(S)),1)):oe("",!0)],4))),128))])],36),O("div",{class:"playhead",style:Mi({left:Ct(s)+"px"}),onMousedown:e},w[0]||(w[0]=[O("div",{class:"playhead-line"},null,-1),O("div",{class:"playhead-triangle"},null,-1)]),36)],64))}}),sS=Ei(rS,[["__scopeId","data-v-9b78982e"]]),aS={class:"w-full h-full p-1 flex flex-col justify-center items-center pointer-events-none select-none"},oS={key:0,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},lS=["src"],uS={key:1,class:"flex flex-nowrap gap-0.5 items-center overflow-hidden px-1 h-full"},hS=["src"],fS={key:2,class:"w-full h-full flex flex-col relative rounded"},dS={class:"absolute inset-0"},cS={key:0,class:"absolute inset-0 w-auto h-full flex items-center bg-[#ffffff] bg-opacity-10 text-[#000000]"},pS={class:"text-base inline-block truncate px-5 z-10"},_S={key:3,class:"flex items-center text-bigger text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},gS={class:"pl-6.5"},mS={key:4,class:"flex items-center text-bigger text-white whitespace-nowrap overflow-hidden text-ellipsis w-full"},vS={class:"pl-6.5"},yS={key:0},wS=Re({__name:"trackItem",props:{clip:{type:Object,required:!0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},hovered:{type:Boolean,default:!1}},setup(d){const l=d,u=ge(()=>70/l.frameLength),h=_t([]),p=_t(null),_=()=>{try{if(!l.clip.thumbnail||!Array.isArray(l.clip.thumbnail)){h.value=[];return}const b=Number(l.clip.duration);if(isNaN(b)||b<=0){console.warn("Invalid clip duration:",b);return}const A=Math.ceil(b/u.value),B=[];if(l.clip.type==="image"&&l.clip.thumbnail.length>0){const I=l.clip.thumbnail[0];for(let U=0;U<A;U++)B.push(I)}else if(l.clip.type==="video"&&l.clip.thumbnail.length>0){const I=l.clip.thumbnail;let U=I[0];for(let G=0;G<A;G++){const t=G*u.value,e=I.find(n=>n.timestamp/1e6>=t)||U||I[I.length-1];e&&(B.push(e),U=e)}}h.value=B}catch(b){console.error("Error updating thumbnails:",b),h.value=[]}},y=()=>{try{if(!p.value||!l.clip.volumeData)return;const b=p.value,A=b.getContext("2d");if(!A)return;const B=b.getBoundingClientRect();if(b.width=B.width*window.devicePixelRatio,b.height=B.height*window.devicePixelRatio,A.clearRect(0,0,b.width,b.height),!l.clip.originalDuration){console.warn("Missing originalDuration for audio clip");return}const I=l.clip.volumeData.slice(l.clip.sourceStartTime/l.clip.originalDuration*l.clip.volumeData.length,(l.clip.originalDuration-l.clip.sourceEndTime)/l.clip.originalDuration*l.clip.volumeData.length);if(!I.length){console.warn("No volume data available");return}const U=2,G=2,t=Math.floor(b.width/(U+G)),e=b.height*.8,n=I.length/t;A.fillStyle="#ffffff80";for(let o=0;o<t;o++){const f=Math.floor(o*n),v=(I[f]||0)*e,w=o*(U+G),S=(b.height-v)/2;A.fillRect(w,S,U,v)}}catch(b){console.error("Error drawing waveform:",b)}},s=b=>b?{grayscale:"灰度",invert:"反色",brightness:"亮度",sepia:"复古",blur:"模糊"}[b]:"未知滤镜";return Mn([()=>l.frameLength,()=>l.zoom,()=>l.clip.duration,()=>l.clip.sourceStartTime,()=>l.clip.sourceEndTime,()=>l.clip.thumbnail],()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&Ws(()=>{_()})},{deep:!0,immediate:!0}),Mn(()=>l.clip.thumbnail,()=>{l.clip&&(l.clip.type==="video"||l.clip.type==="image")&&Ws(()=>{_()})},{deep:!0,immediate:!0}),os(()=>{if(l.clip.type==="audio"){const b=new ResizeObserver(()=>{y()});p.value&&(b.observe(p.value),y())}}),(b,A)=>(ct(),yt("div",aS,[d.clip.type==="video"?(ct(),yt("div",oS,[h.value.length>0?(ct(!0),yt(fi,{key:0},gn(h.value,B=>(ct(),yt("img",{key:B.timestamp,src:B.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,lS))),128)):oe("",!0)])):oe("",!0),d.clip.type==="image"?(ct(),yt("div",uS,[h.value.length>0?(ct(!0),yt(fi,{key:0},gn(h.value,B=>(ct(),yt("img",{key:B.timestamp,src:B.url,class:"h-[90%] shrink-0 grow-0 object-cover rounded",style:{width:"70px"}},null,8,hS))),128)):oe("",!0)])):d.clip.type==="audio"?(ct(),yt("div",fS,[O("div",dS,[O("canvas",{ref_key:"waveformCanvas",ref:p,class:"w-full h-full"},null,512)]),d.hovered?(ct(),yt("div",cS,[O("span",pS,De(d.clip.name),1)])):oe("",!0)])):d.clip.type==="text"?(ct(),yt("div",_S,[J(Ct(re),{icon:"material-symbols-light:text-fields",class:"w-6 h-6 absolute left-1 text-white"}),O("div",gS,De(d.clip.textConfig.content),1)])):d.clip.type==="filter"?(ct(),yt("div",mS,[J(Ct(re),{icon:"material-symbols-light:magnify-fullscreen-outline-rounded",class:"w-6 h-6 absolute left-1 text-white"}),O("div",vS,[O("span",null,De(s(d.clip.filterType)),1),d.clip.intensity!==void 0?(ct(),yt("span",yS,De(Math.round(d.clip.intensity))+"% ",1)):oe("",!0)])])):oe("",!0)]))}}),xS=Ei(wS,[["__scopeId","data-v-d31631bc"]]),bS=["data-track","onDragenter","onDragleave"],SS=["data-clip","onMousedown","onMouseover","onMouseleave"],US={class:"flex items-center justify-center w-full h-full relative"},ES=["onMousedown"],CS=["onMousedown"],TS=Re({__name:"tracksList",props:{tracks:{type:Array,required:!0},hoveredTrack:{type:Number,default:-1},dragPreview:{type:Boolean,default:!1},dragPreviewPosition:{type:Number,default:0},dragPreviewWidth:{type:Number,default:0},zoom:{type:Number,default:1},frameLength:{type:Number,default:20},isReplaceMode:{type:Boolean,default:!1}},emits:["track-drag-enter","track-drag-leave","clip-mouse-down","background-click","save-history-state","clip-hover","start-resize","delete-clip"],setup(d,{expose:l,emit:u}){const h=d,p=u,_=_t(void 0),y=_t(void 0),s=()=>{h.tracks.forEach(w=>{w.clips.forEach(S=>{S.selected=!1})}),y.value=void 0},b=w=>{s(),w&&(w.selected=!0,y.value=w)},A=w=>{w.preventDefault()},B=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect();w.clientX-S.left;const k=w.clientY-S.top,F=S.height/h.tracks.length,P=Math.floor(k/F);P>=0&&P<h.tracks.length&&p("track-drag-enter",P)},I=w=>{w.preventDefault();const S=w.currentTarget.getBoundingClientRect(),k=w.clientX,F=w.clientY;(k<S.left||k>S.right||F<S.top||F>S.bottom)&&p("track-drag-leave",h.hoveredTrack)},U=w=>{p("track-drag-enter",w)},G=w=>{p("track-drag-leave",w)},t=(w,S,k)=>{w.stopPropagation(),w.preventDefault(),h.tracks.forEach(P=>{P.clips.forEach(M=>{M!==S&&(M.selected=!1)})}),S.selected=!0,y.value=S,_.value=void 0;const F=w.target;!F.classList.contains("resize-handle")&&!F.closest(".resize-handle")&&p("clip-mouse-down",S,k,w)},e=w=>{y.value||(_.value=w,w.selected=!0),p("clip-hover",w)},n=w=>{_.value===w&&!y.value&&(_.value=void 0,w.selected=!1)},o=(w,S,k)=>{p("start-resize",w,S,k)},f=w=>{s(),p("background-click"),_.value=void 0},g=w=>{const S=document.activeElement;(S==null?void 0:S.tagName)==="INPUT"||(S==null?void 0:S.tagName)==="TEXTAREA"||(S==null?void 0:S.getAttribute("contenteditable"))==="true"||S!=null&&S.classList.contains("el-input__inner")||S!=null&&S.classList.contains("el-textarea__inner")||(w.key==="Delete"||w.key==="Backspace")&&(h.tracks.forEach((F,P)=>{F.clips.filter(D=>D.selected||D===y.value).forEach(D=>{p("delete-clip",D,P)})}),v())},v=()=>{p("save-history-state")};return os(()=>{window.addEventListener("keydown",g);const w=document.querySelector(".tracks-list");w&&w.focus()}),Zs(()=>{window.removeEventListener("keydown",g)}),l({activeClip:b}),(w,S)=>(ct(),yt("div",{class:"w-full h-full bg-[#252525] tracks-list select-none",onDragenter:ti(A,["prevent"]),onDragover:ti(B,["prevent"]),onDragleave:ti(I,["prevent"]),onMousedown:f,onKeydown:g,tabindex:"0"},[(ct(!0),yt(fi,null,gn(d.tracks,(k,F)=>(ct(),yt("div",{key:k.id,class:"relative h-15 my-3 bg-[#252525]","data-track":k.id,onDragenter:ti(P=>U(F),["prevent"]),onDragleave:ti(P=>G(F),["prevent"])},[(ct(!0),yt(fi,null,gn(k.clips,P=>(ct(),yt("div",{key:P.id,class:Pn(["absolute top-0 h-full flex items-center bg-[#444] rounded-xl cursor-pointer select-none min-w-[30px]",{"ring-2 ring-[#b534cf]":P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id,"bg-[#631975]":P.type==="video","bg-[#6ab7ff]":P.type==="audio","bg-[#722ed133]":P.type==="image","bg-[#a85201]":P.type==="text","bg-[#f827eec2]":P.type==="filter"}]),style:Mi({left:`${P.startTime*d.frameLength}px`,width:`${P.duration*d.frameLength}px`}),"data-clip":P.id,onMousedown:ti(M=>t(M,P,k.id),["stop"]),onMouseover:M=>e(P),onMouseleave:M=>n(P)},[O("div",US,[J(xS,{clip:P,zoom:d.zoom,frameLength:d.frameLength,hovered:P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id},null,8,["clip","zoom","frameLength","hovered"])]),P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id?(ct(),yt("div",{key:0,class:"absolute left-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-l-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:ti(M=>o(M,P,"left"),["stop"])},S[0]||(S[0]=[O("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,ES)):oe("",!0),P.selected||_.value&&_.value.id===P.id||y.value&&y.value.id===P.id?(ct(),yt("div",{key:1,class:"absolute right-[1.25px] top-[0.285px] bottom-0 flex items-center justify-center w-3 h-[98%] bg-[#d4d4d4] rounded-r-[0.75rem] cursor-w-resize hover:bg-[#a0a0a0] z-10",onMousedown:ti(M=>o(M,P,"right"),["stop"])},S[1]||(S[1]=[O("div",{class:"w-1 h-[80%] bg-[#646464]"},null,-1)]),40,CS)):oe("",!0)],46,SS))),128))],40,bS))),128))],32))}}),AS=Ei(TS,[["__scopeId","data-v-95f3c58a"]]);function IS(d){let l=0;for(let h=0;h<d.length;h++)l+=d[h]*d[h];return Math.sqrt(l/d.length)}const Iu=async d=>new Promise(async l=>{if(d.type==="image"){const u=await Xs(d.path),h=new bo(await u.stream());if(await h.ready){const{video:_}=await h.tick(0);if(_ instanceof ImageBitmap){const y=new OffscreenCanvas(_.width,_.height);y.getContext("2d").drawImage(_,0,0,_.width,_.height);const b=await y.convertToBlob();l({type:"image",data:b})}}}else if(d.type==="video"){const u=await Xs(d.path),h=new Mu(u);if(await h.ready){let _=performance.now();h.thumbnails().then(y=>{let s=[];y.forEach(b=>{s.push({url:URL.createObjectURL(b.img),timestamp:b.ts})}),console.log("get video frame",(performance.now()-_)/1e3+"s"),l({type:"video",data:s})})}}}),Bu=async d=>new Promise(async(l,u)=>{var b;const h=await Xs(d.path),p=new Ou(await h.stream());await p.ready,performance.now();let _=!1,y=0,s=[];for(;!_;){const{audio:A,state:B}=await p.tick(y);if(B==="done"){_=!0;continue}if(y+=33333,A.length===0||((b=A[0])==null?void 0:b.length)===0){s.push(0);continue}else{const I=IS(A[0]);s.push(I)}}l({type:"audio",data:s})});var ko={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */ko.exports;(function(d,l){(function(){var u,h="4.17.21",p=200,_="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",y="Expected a function",s="Invalid `variable` option passed into `_.template`",b="__lodash_hash_undefined__",A=500,B="__lodash_placeholder__",I=1,U=2,G=4,t=1,e=2,n=1,o=2,f=4,g=8,v=16,w=32,S=64,k=128,F=256,P=512,M=30,D="...",et=800,at=16,Ft=1,lt=2,Tt=3,Bt=1/0,Ht=9007199254740991,it=17976931348623157e292,ee=NaN,H=4294967295,Q=H-1,Y=H>>>1,vt=[["ary",k],["bind",n],["bindKey",o],["curry",g],["curryRight",v],["flip",P],["partial",w],["partialRight",S],["rearg",F]],Pt="[object Arguments]",ie="[object Array]",Te="[object AsyncFunction]",ht="[object Boolean]",V="[object Date]",nt="[object DOMException]",ot="[object Error]",Qt="[object Function]",Wt="[object GeneratorFunction]",Yt="[object Map]",ut="[object Number]",Nt="[object Null]",jt="[object Object]",Ae="[object Promise]",mn="[object Proxy]",ze="[object RegExp]",ue="[object Set]",qe="[object String]",Ni="[object Symbol]",On="[object Undefined]",qt="[object WeakMap]",Nn="[object WeakSet]",di="[object ArrayBuffer]",ci="[object DataView]",gr="[object Float32Array]",Gn="[object Float64Array]",hs="[object Int8Array]",fs="[object Int16Array]",ds="[object Int32Array]",Gi="[object Uint8Array]",cs="[object Uint8ClampedArray]",vn="[object Uint16Array]",ps="[object Uint32Array]",Do=/\b__p \+= '';/g,Ro=/\b(__p \+=) '' \+/g,Mo=/(__e\(.*?\)|\b__t\)) \+\n'';/g,Qs=/&(?:amp|lt|gt|quot|#39);/g,X=/[&<>"']/g,rt=RegExp(Qs.source),xt=RegExp(X.source),wt=/<%-([\s\S]+?)%>/g,gt=/<%([\s\S]+?)%>/g,bt=/<%=([\s\S]+?)%>/g,At=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,te=/^\w*$/,ye=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,we=/[\\^$.*+?()[\]{}|]/g,he=RegExp(we.source),fe=/^\s+/,Me=/\s/,Hi=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,ta=/\{\n\/\* \[wrapped with (.+)\] \*/,Xu=/,? & /,Rc=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Mc=/[()=,{}\[\]\/\s]/,Oc=/\\(\\)?/g,Nc=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,qu=/\w*$/,Gc=/^[-+]0x[0-9a-f]+$/i,Hc=/^0b[01]+$/i,Yc=/^\[object .+?Constructor\]$/,Vc=/^0o[0-7]+$/i,$c=/^(?:0|[1-9]\d*)$/,Wc=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,ea=/($^)/,Xc=/['\n\r\u2028\u2029\\]/g,ia="\\ud800-\\udfff",qc="\\u0300-\\u036f",jc="\\ufe20-\\ufe2f",Kc="\\u20d0-\\u20ff",ju=qc+jc+Kc,Ku="\\u2700-\\u27bf",Zu="a-z\\xdf-\\xf6\\xf8-\\xff",Zc="\\xac\\xb1\\xd7\\xf7",Jc="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",Qc="\\u2000-\\u206f",tp=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Ju="A-Z\\xc0-\\xd6\\xd8-\\xde",Qu="\\ufe0e\\ufe0f",th=Zc+Jc+Qc+tp,Oo="['’]",ep="["+ia+"]",eh="["+th+"]",na="["+ju+"]",ih="\\d+",ip="["+Ku+"]",nh="["+Zu+"]",rh="[^"+ia+th+ih+Ku+Zu+Ju+"]",No="\\ud83c[\\udffb-\\udfff]",np="(?:"+na+"|"+No+")",sh="[^"+ia+"]",Go="(?:\\ud83c[\\udde6-\\uddff]){2}",Ho="[\\ud800-\\udbff][\\udc00-\\udfff]",mr="["+Ju+"]",ah="\\u200d",oh="(?:"+nh+"|"+rh+")",rp="(?:"+mr+"|"+rh+")",lh="(?:"+Oo+"(?:d|ll|m|re|s|t|ve))?",uh="(?:"+Oo+"(?:D|LL|M|RE|S|T|VE))?",hh=np+"?",fh="["+Qu+"]?",sp="(?:"+ah+"(?:"+[sh,Go,Ho].join("|")+")"+fh+hh+")*",ap="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",op="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",dh=fh+hh+sp,lp="(?:"+[ip,Go,Ho].join("|")+")"+dh,up="(?:"+[sh+na+"?",na,Go,Ho,ep].join("|")+")",hp=RegExp(Oo,"g"),fp=RegExp(na,"g"),Yo=RegExp(No+"(?="+No+")|"+up+dh,"g"),dp=RegExp([mr+"?"+nh+"+"+lh+"(?="+[eh,mr,"$"].join("|")+")",rp+"+"+uh+"(?="+[eh,mr+oh,"$"].join("|")+")",mr+"?"+oh+"+"+lh,mr+"+"+uh,op,ap,ih,lp].join("|"),"g"),cp=RegExp("["+ah+ia+ju+Qu+"]"),pp=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,_p=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],gp=-1,ae={};ae[gr]=ae[Gn]=ae[hs]=ae[fs]=ae[ds]=ae[Gi]=ae[cs]=ae[vn]=ae[ps]=!0,ae[Pt]=ae[ie]=ae[di]=ae[ht]=ae[ci]=ae[V]=ae[ot]=ae[Qt]=ae[Yt]=ae[ut]=ae[jt]=ae[ze]=ae[ue]=ae[qe]=ae[qt]=!1;var se={};se[Pt]=se[ie]=se[di]=se[ci]=se[ht]=se[V]=se[gr]=se[Gn]=se[hs]=se[fs]=se[ds]=se[Yt]=se[ut]=se[jt]=se[ze]=se[ue]=se[qe]=se[Ni]=se[Gi]=se[cs]=se[vn]=se[ps]=!0,se[ot]=se[Qt]=se[qt]=!1;var mp={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},vp={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},yp={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},wp={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},xp=parseFloat,bp=parseInt,ch=typeof Bs=="object"&&Bs&&Bs.Object===Object&&Bs,Sp=typeof self=="object"&&self&&self.Object===Object&&self,Fe=ch||Sp||Function("return this")(),Vo=l&&!l.nodeType&&l,Hn=Vo&&!0&&d&&!d.nodeType&&d,ph=Hn&&Hn.exports===Vo,$o=ph&&ch.process,pi=function(){try{var R=Hn&&Hn.require&&Hn.require("util").types;return R||$o&&$o.binding&&$o.binding("util")}catch{}}(),_h=pi&&pi.isArrayBuffer,gh=pi&&pi.isDate,mh=pi&&pi.isMap,vh=pi&&pi.isRegExp,yh=pi&&pi.isSet,wh=pi&&pi.isTypedArray;function ii(R,W,$){switch($.length){case 0:return R.call(W);case 1:return R.call(W,$[0]);case 2:return R.call(W,$[0],$[1]);case 3:return R.call(W,$[0],$[1],$[2])}return R.apply(W,$)}function Up(R,W,$,pt){for(var It=-1,Kt=R==null?0:R.length;++It<Kt;){var xe=R[It];W(pt,xe,$(xe),R)}return pt}function _i(R,W){for(var $=-1,pt=R==null?0:R.length;++$<pt&&W(R[$],$,R)!==!1;);return R}function Ep(R,W){for(var $=R==null?0:R.length;$--&&W(R[$],$,R)!==!1;);return R}function xh(R,W){for(var $=-1,pt=R==null?0:R.length;++$<pt;)if(!W(R[$],$,R))return!1;return!0}function yn(R,W){for(var $=-1,pt=R==null?0:R.length,It=0,Kt=[];++$<pt;){var xe=R[$];W(xe,$,R)&&(Kt[It++]=xe)}return Kt}function ra(R,W){var $=R==null?0:R.length;return!!$&&vr(R,W,0)>-1}function Wo(R,W,$){for(var pt=-1,It=R==null?0:R.length;++pt<It;)if($(W,R[pt]))return!0;return!1}function le(R,W){for(var $=-1,pt=R==null?0:R.length,It=Array(pt);++$<pt;)It[$]=W(R[$],$,R);return It}function wn(R,W){for(var $=-1,pt=W.length,It=R.length;++$<pt;)R[It+$]=W[$];return R}function Xo(R,W,$,pt){var It=-1,Kt=R==null?0:R.length;for(pt&&Kt&&($=R[++It]);++It<Kt;)$=W($,R[It],It,R);return $}function Cp(R,W,$,pt){var It=R==null?0:R.length;for(pt&&It&&($=R[--It]);It--;)$=W($,R[It],It,R);return $}function qo(R,W){for(var $=-1,pt=R==null?0:R.length;++$<pt;)if(W(R[$],$,R))return!0;return!1}var Tp=jo("length");function Ap(R){return R.split("")}function Ip(R){return R.match(Rc)||[]}function bh(R,W,$){var pt;return $(R,function(It,Kt,xe){if(W(It,Kt,xe))return pt=Kt,!1}),pt}function sa(R,W,$,pt){for(var It=R.length,Kt=$+(pt?1:-1);pt?Kt--:++Kt<It;)if(W(R[Kt],Kt,R))return Kt;return-1}function vr(R,W,$){return W===W?Gp(R,W,$):sa(R,Sh,$)}function Bp(R,W,$,pt){for(var It=$-1,Kt=R.length;++It<Kt;)if(pt(R[It],W))return It;return-1}function Sh(R){return R!==R}function Uh(R,W){var $=R==null?0:R.length;return $?Zo(R,W)/$:ee}function jo(R){return function(W){return W==null?u:W[R]}}function Ko(R){return function(W){return R==null?u:R[W]}}function Eh(R,W,$,pt,It){return It(R,function(Kt,xe,ne){$=pt?(pt=!1,Kt):W($,Kt,xe,ne)}),$}function zp(R,W){var $=R.length;for(R.sort(W);$--;)R[$]=R[$].value;return R}function Zo(R,W){for(var $,pt=-1,It=R.length;++pt<It;){var Kt=W(R[pt]);Kt!==u&&($=$===u?Kt:$+Kt)}return $}function Jo(R,W){for(var $=-1,pt=Array(R);++$<R;)pt[$]=W($);return pt}function Fp(R,W){return le(W,function($){return[$,R[$]]})}function Ch(R){return R&&R.slice(0,Bh(R)+1).replace(fe,"")}function ni(R){return function(W){return R(W)}}function Qo(R,W){return le(W,function($){return R[$]})}function _s(R,W){return R.has(W)}function Th(R,W){for(var $=-1,pt=R.length;++$<pt&&vr(W,R[$],0)>-1;);return $}function Ah(R,W){for(var $=R.length;$--&&vr(W,R[$],0)>-1;);return $}function kp(R,W){for(var $=R.length,pt=0;$--;)R[$]===W&&++pt;return pt}var Lp=Ko(mp),Pp=Ko(vp);function Dp(R){return"\\"+wp[R]}function Rp(R,W){return R==null?u:R[W]}function yr(R){return cp.test(R)}function Mp(R){return pp.test(R)}function Op(R){for(var W,$=[];!(W=R.next()).done;)$.push(W.value);return $}function tl(R){var W=-1,$=Array(R.size);return R.forEach(function(pt,It){$[++W]=[It,pt]}),$}function Ih(R,W){return function($){return R(W($))}}function xn(R,W){for(var $=-1,pt=R.length,It=0,Kt=[];++$<pt;){var xe=R[$];(xe===W||xe===B)&&(R[$]=B,Kt[It++]=$)}return Kt}function aa(R){var W=-1,$=Array(R.size);return R.forEach(function(pt){$[++W]=pt}),$}function Np(R){var W=-1,$=Array(R.size);return R.forEach(function(pt){$[++W]=[pt,pt]}),$}function Gp(R,W,$){for(var pt=$-1,It=R.length;++pt<It;)if(R[pt]===W)return pt;return-1}function Hp(R,W,$){for(var pt=$+1;pt--;)if(R[pt]===W)return pt;return pt}function wr(R){return yr(R)?Vp(R):Tp(R)}function Ci(R){return yr(R)?$p(R):Ap(R)}function Bh(R){for(var W=R.length;W--&&Me.test(R.charAt(W)););return W}var Yp=Ko(yp);function Vp(R){for(var W=Yo.lastIndex=0;Yo.test(R);)++W;return W}function $p(R){return R.match(Yo)||[]}function Wp(R){return R.match(dp)||[]}var Xp=function R(W){W=W==null?Fe:xr.defaults(Fe.Object(),W,xr.pick(Fe,_p));var $=W.Array,pt=W.Date,It=W.Error,Kt=W.Function,xe=W.Math,ne=W.Object,el=W.RegExp,qp=W.String,gi=W.TypeError,oa=$.prototype,jp=Kt.prototype,br=ne.prototype,la=W["__core-js_shared__"],ua=jp.toString,Jt=br.hasOwnProperty,Kp=0,zh=function(){var r=/[^.]+$/.exec(la&&la.keys&&la.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}(),ha=br.toString,Zp=ua.call(ne),Jp=Fe._,Qp=el("^"+ua.call(Jt).replace(we,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),fa=ph?W.Buffer:u,bn=W.Symbol,da=W.Uint8Array,Fh=fa?fa.allocUnsafe:u,ca=Ih(ne.getPrototypeOf,ne),kh=ne.create,Lh=br.propertyIsEnumerable,pa=oa.splice,Ph=bn?bn.isConcatSpreadable:u,gs=bn?bn.iterator:u,Yn=bn?bn.toStringTag:u,_a=function(){try{var r=qn(ne,"defineProperty");return r({},"",{}),r}catch{}}(),t_=W.clearTimeout!==Fe.clearTimeout&&W.clearTimeout,e_=pt&&pt.now!==Fe.Date.now&&pt.now,i_=W.setTimeout!==Fe.setTimeout&&W.setTimeout,ga=xe.ceil,ma=xe.floor,il=ne.getOwnPropertySymbols,n_=fa?fa.isBuffer:u,Dh=W.isFinite,r_=oa.join,s_=Ih(ne.keys,ne),be=xe.max,Oe=xe.min,a_=pt.now,o_=W.parseInt,Rh=xe.random,l_=oa.reverse,nl=qn(W,"DataView"),ms=qn(W,"Map"),rl=qn(W,"Promise"),Sr=qn(W,"Set"),vs=qn(W,"WeakMap"),ys=qn(ne,"create"),va=vs&&new vs,Ur={},u_=jn(nl),h_=jn(ms),f_=jn(rl),d_=jn(Sr),c_=jn(vs),ya=bn?bn.prototype:u,ws=ya?ya.valueOf:u,Mh=ya?ya.toString:u;function E(r){if(pe(r)&&!zt(r)&&!(r instanceof Gt)){if(r instanceof mi)return r;if(Jt.call(r,"__wrapped__"))return Nf(r)}return new mi(r)}var Er=function(){function r(){}return function(a){if(!de(a))return{};if(kh)return kh(a);r.prototype=a;var c=new r;return r.prototype=u,c}}();function wa(){}function mi(r,a){this.__wrapped__=r,this.__actions__=[],this.__chain__=!!a,this.__index__=0,this.__values__=u}E.templateSettings={escape:wt,evaluate:gt,interpolate:bt,variable:"",imports:{_:E}},E.prototype=wa.prototype,E.prototype.constructor=E,mi.prototype=Er(wa.prototype),mi.prototype.constructor=mi;function Gt(r){this.__wrapped__=r,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=H,this.__views__=[]}function p_(){var r=new Gt(this.__wrapped__);return r.__actions__=je(this.__actions__),r.__dir__=this.__dir__,r.__filtered__=this.__filtered__,r.__iteratees__=je(this.__iteratees__),r.__takeCount__=this.__takeCount__,r.__views__=je(this.__views__),r}function __(){if(this.__filtered__){var r=new Gt(this);r.__dir__=-1,r.__filtered__=!0}else r=this.clone(),r.__dir__*=-1;return r}function g_(){var r=this.__wrapped__.value(),a=this.__dir__,c=zt(r),m=a<0,x=c?r.length:0,C=Ag(0,x,this.__views__),z=C.start,L=C.end,N=L-z,q=m?L:z-1,j=this.__iteratees__,K=j.length,ft=0,mt=Oe(N,this.__takeCount__);if(!c||!m&&x==N&&mt==N)return uf(r,this.__actions__);var Ut=[];t:for(;N--&&ft<mt;){q+=a;for(var Dt=-1,Et=r[q];++Dt<K;){var Ot=j[Dt],Vt=Ot.iteratee,ai=Ot.type,$e=Vt(Et);if(ai==lt)Et=$e;else if(!$e){if(ai==Ft)continue t;break t}}Ut[ft++]=Et}return Ut}Gt.prototype=Er(wa.prototype),Gt.prototype.constructor=Gt;function Vn(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var m=r[a];this.set(m[0],m[1])}}function m_(){this.__data__=ys?ys(null):{},this.size=0}function v_(r){var a=this.has(r)&&delete this.__data__[r];return this.size-=a?1:0,a}function y_(r){var a=this.__data__;if(ys){var c=a[r];return c===b?u:c}return Jt.call(a,r)?a[r]:u}function w_(r){var a=this.__data__;return ys?a[r]!==u:Jt.call(a,r)}function x_(r,a){var c=this.__data__;return this.size+=this.has(r)?0:1,c[r]=ys&&a===u?b:a,this}Vn.prototype.clear=m_,Vn.prototype.delete=v_,Vn.prototype.get=y_,Vn.prototype.has=w_,Vn.prototype.set=x_;function Zi(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var m=r[a];this.set(m[0],m[1])}}function b_(){this.__data__=[],this.size=0}function S_(r){var a=this.__data__,c=xa(a,r);if(c<0)return!1;var m=a.length-1;return c==m?a.pop():pa.call(a,c,1),--this.size,!0}function U_(r){var a=this.__data__,c=xa(a,r);return c<0?u:a[c][1]}function E_(r){return xa(this.__data__,r)>-1}function C_(r,a){var c=this.__data__,m=xa(c,r);return m<0?(++this.size,c.push([r,a])):c[m][1]=a,this}Zi.prototype.clear=b_,Zi.prototype.delete=S_,Zi.prototype.get=U_,Zi.prototype.has=E_,Zi.prototype.set=C_;function Ji(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var m=r[a];this.set(m[0],m[1])}}function T_(){this.size=0,this.__data__={hash:new Vn,map:new(ms||Zi),string:new Vn}}function A_(r){var a=ka(this,r).delete(r);return this.size-=a?1:0,a}function I_(r){return ka(this,r).get(r)}function B_(r){return ka(this,r).has(r)}function z_(r,a){var c=ka(this,r),m=c.size;return c.set(r,a),this.size+=c.size==m?0:1,this}Ji.prototype.clear=T_,Ji.prototype.delete=A_,Ji.prototype.get=I_,Ji.prototype.has=B_,Ji.prototype.set=z_;function $n(r){var a=-1,c=r==null?0:r.length;for(this.__data__=new Ji;++a<c;)this.add(r[a])}function F_(r){return this.__data__.set(r,b),this}function k_(r){return this.__data__.has(r)}$n.prototype.add=$n.prototype.push=F_,$n.prototype.has=k_;function Ti(r){var a=this.__data__=new Zi(r);this.size=a.size}function L_(){this.__data__=new Zi,this.size=0}function P_(r){var a=this.__data__,c=a.delete(r);return this.size=a.size,c}function D_(r){return this.__data__.get(r)}function R_(r){return this.__data__.has(r)}function M_(r,a){var c=this.__data__;if(c instanceof Zi){var m=c.__data__;if(!ms||m.length<p-1)return m.push([r,a]),this.size=++c.size,this;c=this.__data__=new Ji(m)}return c.set(r,a),this.size=c.size,this}Ti.prototype.clear=L_,Ti.prototype.delete=P_,Ti.prototype.get=D_,Ti.prototype.has=R_,Ti.prototype.set=M_;function Oh(r,a){var c=zt(r),m=!c&&Kn(r),x=!c&&!m&&Tn(r),C=!c&&!m&&!x&&Ir(r),z=c||m||x||C,L=z?Jo(r.length,qp):[],N=L.length;for(var q in r)(a||Jt.call(r,q))&&!(z&&(q=="length"||x&&(q=="offset"||q=="parent")||C&&(q=="buffer"||q=="byteLength"||q=="byteOffset")||nn(q,N)))&&L.push(q);return L}function Nh(r){var a=r.length;return a?r[_l(0,a-1)]:u}function O_(r,a){return La(je(r),Wn(a,0,r.length))}function N_(r){return La(je(r))}function sl(r,a,c){(c!==u&&!Ai(r[a],c)||c===u&&!(a in r))&&Qi(r,a,c)}function xs(r,a,c){var m=r[a];(!(Jt.call(r,a)&&Ai(m,c))||c===u&&!(a in r))&&Qi(r,a,c)}function xa(r,a){for(var c=r.length;c--;)if(Ai(r[c][0],a))return c;return-1}function G_(r,a,c,m){return Sn(r,function(x,C,z){a(m,x,c(x),z)}),m}function Gh(r,a){return r&&Vi(a,Ie(a),r)}function H_(r,a){return r&&Vi(a,Ze(a),r)}function Qi(r,a,c){a=="__proto__"&&_a?_a(r,a,{configurable:!0,enumerable:!0,value:c,writable:!0}):r[a]=c}function al(r,a){for(var c=-1,m=a.length,x=$(m),C=r==null;++c<m;)x[c]=C?u:Nl(r,a[c]);return x}function Wn(r,a,c){return r===r&&(c!==u&&(r=r<=c?r:c),a!==u&&(r=r>=a?r:a)),r}function vi(r,a,c,m,x,C){var z,L=a&I,N=a&U,q=a&G;if(c&&(z=x?c(r,m,x,C):c(r)),z!==u)return z;if(!de(r))return r;var j=zt(r);if(j){if(z=Bg(r),!L)return je(r,z)}else{var K=Ne(r),ft=K==Qt||K==Wt;if(Tn(r))return df(r,L);if(K==jt||K==Pt||ft&&!x){if(z=N||ft?{}:zf(r),!L)return N?yg(r,H_(z,r)):vg(r,Gh(z,r))}else{if(!se[K])return x?r:{};z=zg(r,K,L)}}C||(C=new Ti);var mt=C.get(r);if(mt)return mt;C.set(r,z),ad(r)?r.forEach(function(Et){z.add(vi(Et,a,c,Et,r,C))}):rd(r)&&r.forEach(function(Et,Ot){z.set(Ot,vi(Et,a,c,Ot,r,C))});var Ut=q?N?Cl:El:N?Ze:Ie,Dt=j?u:Ut(r);return _i(Dt||r,function(Et,Ot){Dt&&(Ot=Et,Et=r[Ot]),xs(z,Ot,vi(Et,a,c,Ot,r,C))}),z}function Y_(r){var a=Ie(r);return function(c){return Hh(c,r,a)}}function Hh(r,a,c){var m=c.length;if(r==null)return!m;for(r=ne(r);m--;){var x=c[m],C=a[x],z=r[x];if(z===u&&!(x in r)||!C(z))return!1}return!0}function Yh(r,a,c){if(typeof r!="function")throw new gi(y);return As(function(){r.apply(u,c)},a)}function bs(r,a,c,m){var x=-1,C=ra,z=!0,L=r.length,N=[],q=a.length;if(!L)return N;c&&(a=le(a,ni(c))),m?(C=Wo,z=!1):a.length>=p&&(C=_s,z=!1,a=new $n(a));t:for(;++x<L;){var j=r[x],K=c==null?j:c(j);if(j=m||j!==0?j:0,z&&K===K){for(var ft=q;ft--;)if(a[ft]===K)continue t;N.push(j)}else C(a,K,m)||N.push(j)}return N}var Sn=mf(Yi),Vh=mf(ll,!0);function V_(r,a){var c=!0;return Sn(r,function(m,x,C){return c=!!a(m,x,C),c}),c}function ba(r,a,c){for(var m=-1,x=r.length;++m<x;){var C=r[m],z=a(C);if(z!=null&&(L===u?z===z&&!si(z):c(z,L)))var L=z,N=C}return N}function $_(r,a,c,m){var x=r.length;for(c=Lt(c),c<0&&(c=-c>x?0:x+c),m=m===u||m>x?x:Lt(m),m<0&&(m+=x),m=c>m?0:ld(m);c<m;)r[c++]=a;return r}function $h(r,a){var c=[];return Sn(r,function(m,x,C){a(m,x,C)&&c.push(m)}),c}function ke(r,a,c,m,x){var C=-1,z=r.length;for(c||(c=kg),x||(x=[]);++C<z;){var L=r[C];a>0&&c(L)?a>1?ke(L,a-1,c,m,x):wn(x,L):m||(x[x.length]=L)}return x}var ol=vf(),Wh=vf(!0);function Yi(r,a){return r&&ol(r,a,Ie)}function ll(r,a){return r&&Wh(r,a,Ie)}function Sa(r,a){return yn(a,function(c){return rn(r[c])})}function Xn(r,a){a=En(a,r);for(var c=0,m=a.length;r!=null&&c<m;)r=r[$i(a[c++])];return c&&c==m?r:u}function Xh(r,a,c){var m=a(r);return zt(r)?m:wn(m,c(r))}function Ye(r){return r==null?r===u?On:Nt:Yn&&Yn in ne(r)?Tg(r):Ng(r)}function ul(r,a){return r>a}function W_(r,a){return r!=null&&Jt.call(r,a)}function X_(r,a){return r!=null&&a in ne(r)}function q_(r,a,c){return r>=Oe(a,c)&&r<be(a,c)}function hl(r,a,c){for(var m=c?Wo:ra,x=r[0].length,C=r.length,z=C,L=$(C),N=1/0,q=[];z--;){var j=r[z];z&&a&&(j=le(j,ni(a))),N=Oe(j.length,N),L[z]=!c&&(a||x>=120&&j.length>=120)?new $n(z&&j):u}j=r[0];var K=-1,ft=L[0];t:for(;++K<x&&q.length<N;){var mt=j[K],Ut=a?a(mt):mt;if(mt=c||mt!==0?mt:0,!(ft?_s(ft,Ut):m(q,Ut,c))){for(z=C;--z;){var Dt=L[z];if(!(Dt?_s(Dt,Ut):m(r[z],Ut,c)))continue t}ft&&ft.push(Ut),q.push(mt)}}return q}function j_(r,a,c,m){return Yi(r,function(x,C,z){a(m,c(x),C,z)}),m}function Ss(r,a,c){a=En(a,r),r=Pf(r,a);var m=r==null?r:r[$i(wi(a))];return m==null?u:ii(m,r,c)}function qh(r){return pe(r)&&Ye(r)==Pt}function K_(r){return pe(r)&&Ye(r)==di}function Z_(r){return pe(r)&&Ye(r)==V}function Us(r,a,c,m,x){return r===a?!0:r==null||a==null||!pe(r)&&!pe(a)?r!==r&&a!==a:J_(r,a,c,m,Us,x)}function J_(r,a,c,m,x,C){var z=zt(r),L=zt(a),N=z?ie:Ne(r),q=L?ie:Ne(a);N=N==Pt?jt:N,q=q==Pt?jt:q;var j=N==jt,K=q==jt,ft=N==q;if(ft&&Tn(r)){if(!Tn(a))return!1;z=!0,j=!1}if(ft&&!j)return C||(C=new Ti),z||Ir(r)?Af(r,a,c,m,x,C):Eg(r,a,N,c,m,x,C);if(!(c&t)){var mt=j&&Jt.call(r,"__wrapped__"),Ut=K&&Jt.call(a,"__wrapped__");if(mt||Ut){var Dt=mt?r.value():r,Et=Ut?a.value():a;return C||(C=new Ti),x(Dt,Et,c,m,C)}}return ft?(C||(C=new Ti),Cg(r,a,c,m,x,C)):!1}function Q_(r){return pe(r)&&Ne(r)==Yt}function fl(r,a,c,m){var x=c.length,C=x,z=!m;if(r==null)return!C;for(r=ne(r);x--;){var L=c[x];if(z&&L[2]?L[1]!==r[L[0]]:!(L[0]in r))return!1}for(;++x<C;){L=c[x];var N=L[0],q=r[N],j=L[1];if(z&&L[2]){if(q===u&&!(N in r))return!1}else{var K=new Ti;if(m)var ft=m(q,j,N,r,a,K);if(!(ft===u?Us(j,q,t|e,m,K):ft))return!1}}return!0}function jh(r){if(!de(r)||Pg(r))return!1;var a=rn(r)?Qp:Yc;return a.test(jn(r))}function tg(r){return pe(r)&&Ye(r)==ze}function eg(r){return pe(r)&&Ne(r)==ue}function ig(r){return pe(r)&&Na(r.length)&&!!ae[Ye(r)]}function Kh(r){return typeof r=="function"?r:r==null?Je:typeof r=="object"?zt(r)?Qh(r[0],r[1]):Jh(r):yd(r)}function dl(r){if(!Ts(r))return s_(r);var a=[];for(var c in ne(r))Jt.call(r,c)&&c!="constructor"&&a.push(c);return a}function ng(r){if(!de(r))return Og(r);var a=Ts(r),c=[];for(var m in r)m=="constructor"&&(a||!Jt.call(r,m))||c.push(m);return c}function cl(r,a){return r<a}function Zh(r,a){var c=-1,m=Ke(r)?$(r.length):[];return Sn(r,function(x,C,z){m[++c]=a(x,C,z)}),m}function Jh(r){var a=Al(r);return a.length==1&&a[0][2]?kf(a[0][0],a[0][1]):function(c){return c===r||fl(c,r,a)}}function Qh(r,a){return Bl(r)&&Ff(a)?kf($i(r),a):function(c){var m=Nl(c,r);return m===u&&m===a?Gl(c,r):Us(a,m,t|e)}}function Ua(r,a,c,m,x){r!==a&&ol(a,function(C,z){if(x||(x=new Ti),de(C))rg(r,a,z,c,Ua,m,x);else{var L=m?m(Fl(r,z),C,z+"",r,a,x):u;L===u&&(L=C),sl(r,z,L)}},Ze)}function rg(r,a,c,m,x,C,z){var L=Fl(r,c),N=Fl(a,c),q=z.get(N);if(q){sl(r,c,q);return}var j=C?C(L,N,c+"",r,a,z):u,K=j===u;if(K){var ft=zt(N),mt=!ft&&Tn(N),Ut=!ft&&!mt&&Ir(N);j=N,ft||mt||Ut?zt(L)?j=L:me(L)?j=je(L):mt?(K=!1,j=df(N,!0)):Ut?(K=!1,j=cf(N,!0)):j=[]:Is(N)||Kn(N)?(j=L,Kn(L)?j=ud(L):(!de(L)||rn(L))&&(j=zf(N))):K=!1}K&&(z.set(N,j),x(j,N,m,C,z),z.delete(N)),sl(r,c,j)}function tf(r,a){var c=r.length;if(c)return a+=a<0?c:0,nn(a,c)?r[a]:u}function ef(r,a,c){a.length?a=le(a,function(C){return zt(C)?function(z){return Xn(z,C.length===1?C[0]:C)}:C}):a=[Je];var m=-1;a=le(a,ni(St()));var x=Zh(r,function(C,z,L){var N=le(a,function(q){return q(C)});return{criteria:N,index:++m,value:C}});return zp(x,function(C,z){return mg(C,z,c)})}function sg(r,a){return nf(r,a,function(c,m){return Gl(r,m)})}function nf(r,a,c){for(var m=-1,x=a.length,C={};++m<x;){var z=a[m],L=Xn(r,z);c(L,z)&&Es(C,En(z,r),L)}return C}function ag(r){return function(a){return Xn(a,r)}}function pl(r,a,c,m){var x=m?Bp:vr,C=-1,z=a.length,L=r;for(r===a&&(a=je(a)),c&&(L=le(r,ni(c)));++C<z;)for(var N=0,q=a[C],j=c?c(q):q;(N=x(L,j,N,m))>-1;)L!==r&&pa.call(L,N,1),pa.call(r,N,1);return r}function rf(r,a){for(var c=r?a.length:0,m=c-1;c--;){var x=a[c];if(c==m||x!==C){var C=x;nn(x)?pa.call(r,x,1):vl(r,x)}}return r}function _l(r,a){return r+ma(Rh()*(a-r+1))}function og(r,a,c,m){for(var x=-1,C=be(ga((a-r)/(c||1)),0),z=$(C);C--;)z[m?C:++x]=r,r+=c;return z}function gl(r,a){var c="";if(!r||a<1||a>Ht)return c;do a%2&&(c+=r),a=ma(a/2),a&&(r+=r);while(a);return c}function Mt(r,a){return kl(Lf(r,a,Je),r+"")}function lg(r){return Nh(Br(r))}function ug(r,a){var c=Br(r);return La(c,Wn(a,0,c.length))}function Es(r,a,c,m){if(!de(r))return r;a=En(a,r);for(var x=-1,C=a.length,z=C-1,L=r;L!=null&&++x<C;){var N=$i(a[x]),q=c;if(N==="__proto__"||N==="constructor"||N==="prototype")return r;if(x!=z){var j=L[N];q=m?m(j,N,L):u,q===u&&(q=de(j)?j:nn(a[x+1])?[]:{})}xs(L,N,q),L=L[N]}return r}var sf=va?function(r,a){return va.set(r,a),r}:Je,hg=_a?function(r,a){return _a(r,"toString",{configurable:!0,enumerable:!1,value:Yl(a),writable:!0})}:Je;function fg(r){return La(Br(r))}function yi(r,a,c){var m=-1,x=r.length;a<0&&(a=-a>x?0:x+a),c=c>x?x:c,c<0&&(c+=x),x=a>c?0:c-a>>>0,a>>>=0;for(var C=$(x);++m<x;)C[m]=r[m+a];return C}function dg(r,a){var c;return Sn(r,function(m,x,C){return c=a(m,x,C),!c}),!!c}function Ea(r,a,c){var m=0,x=r==null?m:r.length;if(typeof a=="number"&&a===a&&x<=Y){for(;m<x;){var C=m+x>>>1,z=r[C];z!==null&&!si(z)&&(c?z<=a:z<a)?m=C+1:x=C}return x}return ml(r,a,Je,c)}function ml(r,a,c,m){var x=0,C=r==null?0:r.length;if(C===0)return 0;a=c(a);for(var z=a!==a,L=a===null,N=si(a),q=a===u;x<C;){var j=ma((x+C)/2),K=c(r[j]),ft=K!==u,mt=K===null,Ut=K===K,Dt=si(K);if(z)var Et=m||Ut;else q?Et=Ut&&(m||ft):L?Et=Ut&&ft&&(m||!mt):N?Et=Ut&&ft&&!mt&&(m||!Dt):mt||Dt?Et=!1:Et=m?K<=a:K<a;Et?x=j+1:C=j}return Oe(C,Q)}function af(r,a){for(var c=-1,m=r.length,x=0,C=[];++c<m;){var z=r[c],L=a?a(z):z;if(!c||!Ai(L,N)){var N=L;C[x++]=z===0?0:z}}return C}function of(r){return typeof r=="number"?r:si(r)?ee:+r}function ri(r){if(typeof r=="string")return r;if(zt(r))return le(r,ri)+"";if(si(r))return Mh?Mh.call(r):"";var a=r+"";return a=="0"&&1/r==-1/0?"-0":a}function Un(r,a,c){var m=-1,x=ra,C=r.length,z=!0,L=[],N=L;if(c)z=!1,x=Wo;else if(C>=p){var q=a?null:Sg(r);if(q)return aa(q);z=!1,x=_s,N=new $n}else N=a?[]:L;t:for(;++m<C;){var j=r[m],K=a?a(j):j;if(j=c||j!==0?j:0,z&&K===K){for(var ft=N.length;ft--;)if(N[ft]===K)continue t;a&&N.push(K),L.push(j)}else x(N,K,c)||(N!==L&&N.push(K),L.push(j))}return L}function vl(r,a){return a=En(a,r),r=Pf(r,a),r==null||delete r[$i(wi(a))]}function lf(r,a,c,m){return Es(r,a,c(Xn(r,a)),m)}function Ca(r,a,c,m){for(var x=r.length,C=m?x:-1;(m?C--:++C<x)&&a(r[C],C,r););return c?yi(r,m?0:C,m?C+1:x):yi(r,m?C+1:0,m?x:C)}function uf(r,a){var c=r;return c instanceof Gt&&(c=c.value()),Xo(a,function(m,x){return x.func.apply(x.thisArg,wn([m],x.args))},c)}function yl(r,a,c){var m=r.length;if(m<2)return m?Un(r[0]):[];for(var x=-1,C=$(m);++x<m;)for(var z=r[x],L=-1;++L<m;)L!=x&&(C[x]=bs(C[x]||z,r[L],a,c));return Un(ke(C,1),a,c)}function hf(r,a,c){for(var m=-1,x=r.length,C=a.length,z={};++m<x;){var L=m<C?a[m]:u;c(z,r[m],L)}return z}function wl(r){return me(r)?r:[]}function xl(r){return typeof r=="function"?r:Je}function En(r,a){return zt(r)?r:Bl(r,a)?[r]:Of(Zt(r))}var cg=Mt;function Cn(r,a,c){var m=r.length;return c=c===u?m:c,!a&&c>=m?r:yi(r,a,c)}var ff=t_||function(r){return Fe.clearTimeout(r)};function df(r,a){if(a)return r.slice();var c=r.length,m=Fh?Fh(c):new r.constructor(c);return r.copy(m),m}function bl(r){var a=new r.constructor(r.byteLength);return new da(a).set(new da(r)),a}function pg(r,a){var c=a?bl(r.buffer):r.buffer;return new r.constructor(c,r.byteOffset,r.byteLength)}function _g(r){var a=new r.constructor(r.source,qu.exec(r));return a.lastIndex=r.lastIndex,a}function gg(r){return ws?ne(ws.call(r)):{}}function cf(r,a){var c=a?bl(r.buffer):r.buffer;return new r.constructor(c,r.byteOffset,r.length)}function pf(r,a){if(r!==a){var c=r!==u,m=r===null,x=r===r,C=si(r),z=a!==u,L=a===null,N=a===a,q=si(a);if(!L&&!q&&!C&&r>a||C&&z&&N&&!L&&!q||m&&z&&N||!c&&N||!x)return 1;if(!m&&!C&&!q&&r<a||q&&c&&x&&!m&&!C||L&&c&&x||!z&&x||!N)return-1}return 0}function mg(r,a,c){for(var m=-1,x=r.criteria,C=a.criteria,z=x.length,L=c.length;++m<z;){var N=pf(x[m],C[m]);if(N){if(m>=L)return N;var q=c[m];return N*(q=="desc"?-1:1)}}return r.index-a.index}function _f(r,a,c,m){for(var x=-1,C=r.length,z=c.length,L=-1,N=a.length,q=be(C-z,0),j=$(N+q),K=!m;++L<N;)j[L]=a[L];for(;++x<z;)(K||x<C)&&(j[c[x]]=r[x]);for(;q--;)j[L++]=r[x++];return j}function gf(r,a,c,m){for(var x=-1,C=r.length,z=-1,L=c.length,N=-1,q=a.length,j=be(C-L,0),K=$(j+q),ft=!m;++x<j;)K[x]=r[x];for(var mt=x;++N<q;)K[mt+N]=a[N];for(;++z<L;)(ft||x<C)&&(K[mt+c[z]]=r[x++]);return K}function je(r,a){var c=-1,m=r.length;for(a||(a=$(m));++c<m;)a[c]=r[c];return a}function Vi(r,a,c,m){var x=!c;c||(c={});for(var C=-1,z=a.length;++C<z;){var L=a[C],N=m?m(c[L],r[L],L,c,r):u;N===u&&(N=r[L]),x?Qi(c,L,N):xs(c,L,N)}return c}function vg(r,a){return Vi(r,Il(r),a)}function yg(r,a){return Vi(r,If(r),a)}function Ta(r,a){return function(c,m){var x=zt(c)?Up:G_,C=a?a():{};return x(c,r,St(m,2),C)}}function Cr(r){return Mt(function(a,c){var m=-1,x=c.length,C=x>1?c[x-1]:u,z=x>2?c[2]:u;for(C=r.length>3&&typeof C=="function"?(x--,C):u,z&&Ve(c[0],c[1],z)&&(C=x<3?u:C,x=1),a=ne(a);++m<x;){var L=c[m];L&&r(a,L,m,C)}return a})}function mf(r,a){return function(c,m){if(c==null)return c;if(!Ke(c))return r(c,m);for(var x=c.length,C=a?x:-1,z=ne(c);(a?C--:++C<x)&&m(z[C],C,z)!==!1;);return c}}function vf(r){return function(a,c,m){for(var x=-1,C=ne(a),z=m(a),L=z.length;L--;){var N=z[r?L:++x];if(c(C[N],N,C)===!1)break}return a}}function wg(r,a,c){var m=a&n,x=Cs(r);function C(){var z=this&&this!==Fe&&this instanceof C?x:r;return z.apply(m?c:this,arguments)}return C}function yf(r){return function(a){a=Zt(a);var c=yr(a)?Ci(a):u,m=c?c[0]:a.charAt(0),x=c?Cn(c,1).join(""):a.slice(1);return m[r]()+x}}function Tr(r){return function(a){return Xo(md(gd(a).replace(hp,"")),r,"")}}function Cs(r){return function(){var a=arguments;switch(a.length){case 0:return new r;case 1:return new r(a[0]);case 2:return new r(a[0],a[1]);case 3:return new r(a[0],a[1],a[2]);case 4:return new r(a[0],a[1],a[2],a[3]);case 5:return new r(a[0],a[1],a[2],a[3],a[4]);case 6:return new r(a[0],a[1],a[2],a[3],a[4],a[5]);case 7:return new r(a[0],a[1],a[2],a[3],a[4],a[5],a[6])}var c=Er(r.prototype),m=r.apply(c,a);return de(m)?m:c}}function xg(r,a,c){var m=Cs(r);function x(){for(var C=arguments.length,z=$(C),L=C,N=Ar(x);L--;)z[L]=arguments[L];var q=C<3&&z[0]!==N&&z[C-1]!==N?[]:xn(z,N);if(C-=q.length,C<c)return Uf(r,a,Aa,x.placeholder,u,z,q,u,u,c-C);var j=this&&this!==Fe&&this instanceof x?m:r;return ii(j,this,z)}return x}function wf(r){return function(a,c,m){var x=ne(a);if(!Ke(a)){var C=St(c,3);a=Ie(a),c=function(L){return C(x[L],L,x)}}var z=r(a,c,m);return z>-1?x[C?a[z]:z]:u}}function xf(r){return en(function(a){var c=a.length,m=c,x=mi.prototype.thru;for(r&&a.reverse();m--;){var C=a[m];if(typeof C!="function")throw new gi(y);if(x&&!z&&Fa(C)=="wrapper")var z=new mi([],!0)}for(m=z?m:c;++m<c;){C=a[m];var L=Fa(C),N=L=="wrapper"?Tl(C):u;N&&zl(N[0])&&N[1]==(k|g|w|F)&&!N[4].length&&N[9]==1?z=z[Fa(N[0])].apply(z,N[3]):z=C.length==1&&zl(C)?z[L]():z.thru(C)}return function(){var q=arguments,j=q[0];if(z&&q.length==1&&zt(j))return z.plant(j).value();for(var K=0,ft=c?a[K].apply(this,q):j;++K<c;)ft=a[K].call(this,ft);return ft}})}function Aa(r,a,c,m,x,C,z,L,N,q){var j=a&k,K=a&n,ft=a&o,mt=a&(g|v),Ut=a&P,Dt=ft?u:Cs(r);function Et(){for(var Ot=arguments.length,Vt=$(Ot),ai=Ot;ai--;)Vt[ai]=arguments[ai];if(mt)var $e=Ar(Et),oi=kp(Vt,$e);if(m&&(Vt=_f(Vt,m,x,mt)),C&&(Vt=gf(Vt,C,z,mt)),Ot-=oi,mt&&Ot<q){var ve=xn(Vt,$e);return Uf(r,a,Aa,Et.placeholder,c,Vt,ve,L,N,q-Ot)}var Ii=K?c:this,an=ft?Ii[r]:r;return Ot=Vt.length,L?Vt=Gg(Vt,L):Ut&&Ot>1&&Vt.reverse(),j&&N<Ot&&(Vt.length=N),this&&this!==Fe&&this instanceof Et&&(an=Dt||Cs(an)),an.apply(Ii,Vt)}return Et}function bf(r,a){return function(c,m){return j_(c,r,a(m),{})}}function Ia(r,a){return function(c,m){var x;if(c===u&&m===u)return a;if(c!==u&&(x=c),m!==u){if(x===u)return m;typeof c=="string"||typeof m=="string"?(c=ri(c),m=ri(m)):(c=of(c),m=of(m)),x=r(c,m)}return x}}function Sl(r){return en(function(a){return a=le(a,ni(St())),Mt(function(c){var m=this;return r(a,function(x){return ii(x,m,c)})})})}function Ba(r,a){a=a===u?" ":ri(a);var c=a.length;if(c<2)return c?gl(a,r):a;var m=gl(a,ga(r/wr(a)));return yr(a)?Cn(Ci(m),0,r).join(""):m.slice(0,r)}function bg(r,a,c,m){var x=a&n,C=Cs(r);function z(){for(var L=-1,N=arguments.length,q=-1,j=m.length,K=$(j+N),ft=this&&this!==Fe&&this instanceof z?C:r;++q<j;)K[q]=m[q];for(;N--;)K[q++]=arguments[++L];return ii(ft,x?c:this,K)}return z}function Sf(r){return function(a,c,m){return m&&typeof m!="number"&&Ve(a,c,m)&&(c=m=u),a=sn(a),c===u?(c=a,a=0):c=sn(c),m=m===u?a<c?1:-1:sn(m),og(a,c,m,r)}}function za(r){return function(a,c){return typeof a=="string"&&typeof c=="string"||(a=xi(a),c=xi(c)),r(a,c)}}function Uf(r,a,c,m,x,C,z,L,N,q){var j=a&g,K=j?z:u,ft=j?u:z,mt=j?C:u,Ut=j?u:C;a|=j?w:S,a&=~(j?S:w),a&f||(a&=-4);var Dt=[r,a,x,mt,K,Ut,ft,L,N,q],Et=c.apply(u,Dt);return zl(r)&&Df(Et,Dt),Et.placeholder=m,Rf(Et,r,a)}function Ul(r){var a=xe[r];return function(c,m){if(c=xi(c),m=m==null?0:Oe(Lt(m),292),m&&Dh(c)){var x=(Zt(c)+"e").split("e"),C=a(x[0]+"e"+(+x[1]+m));return x=(Zt(C)+"e").split("e"),+(x[0]+"e"+(+x[1]-m))}return a(c)}}var Sg=Sr&&1/aa(new Sr([,-0]))[1]==Bt?function(r){return new Sr(r)}:Wl;function Ef(r){return function(a){var c=Ne(a);return c==Yt?tl(a):c==ue?Np(a):Fp(a,r(a))}}function tn(r,a,c,m,x,C,z,L){var N=a&o;if(!N&&typeof r!="function")throw new gi(y);var q=m?m.length:0;if(q||(a&=-97,m=x=u),z=z===u?z:be(Lt(z),0),L=L===u?L:Lt(L),q-=x?x.length:0,a&S){var j=m,K=x;m=x=u}var ft=N?u:Tl(r),mt=[r,a,c,m,x,j,K,C,z,L];if(ft&&Mg(mt,ft),r=mt[0],a=mt[1],c=mt[2],m=mt[3],x=mt[4],L=mt[9]=mt[9]===u?N?0:r.length:be(mt[9]-q,0),!L&&a&(g|v)&&(a&=-25),!a||a==n)var Ut=wg(r,a,c);else a==g||a==v?Ut=xg(r,a,L):(a==w||a==(n|w))&&!x.length?Ut=bg(r,a,c,m):Ut=Aa.apply(u,mt);var Dt=ft?sf:Df;return Rf(Dt(Ut,mt),r,a)}function Cf(r,a,c,m){return r===u||Ai(r,br[c])&&!Jt.call(m,c)?a:r}function Tf(r,a,c,m,x,C){return de(r)&&de(a)&&(C.set(a,r),Ua(r,a,u,Tf,C),C.delete(a)),r}function Ug(r){return Is(r)?u:r}function Af(r,a,c,m,x,C){var z=c&t,L=r.length,N=a.length;if(L!=N&&!(z&&N>L))return!1;var q=C.get(r),j=C.get(a);if(q&&j)return q==a&&j==r;var K=-1,ft=!0,mt=c&e?new $n:u;for(C.set(r,a),C.set(a,r);++K<L;){var Ut=r[K],Dt=a[K];if(m)var Et=z?m(Dt,Ut,K,a,r,C):m(Ut,Dt,K,r,a,C);if(Et!==u){if(Et)continue;ft=!1;break}if(mt){if(!qo(a,function(Ot,Vt){if(!_s(mt,Vt)&&(Ut===Ot||x(Ut,Ot,c,m,C)))return mt.push(Vt)})){ft=!1;break}}else if(!(Ut===Dt||x(Ut,Dt,c,m,C))){ft=!1;break}}return C.delete(r),C.delete(a),ft}function Eg(r,a,c,m,x,C,z){switch(c){case ci:if(r.byteLength!=a.byteLength||r.byteOffset!=a.byteOffset)return!1;r=r.buffer,a=a.buffer;case di:return!(r.byteLength!=a.byteLength||!C(new da(r),new da(a)));case ht:case V:case ut:return Ai(+r,+a);case ot:return r.name==a.name&&r.message==a.message;case ze:case qe:return r==a+"";case Yt:var L=tl;case ue:var N=m&t;if(L||(L=aa),r.size!=a.size&&!N)return!1;var q=z.get(r);if(q)return q==a;m|=e,z.set(r,a);var j=Af(L(r),L(a),m,x,C,z);return z.delete(r),j;case Ni:if(ws)return ws.call(r)==ws.call(a)}return!1}function Cg(r,a,c,m,x,C){var z=c&t,L=El(r),N=L.length,q=El(a),j=q.length;if(N!=j&&!z)return!1;for(var K=N;K--;){var ft=L[K];if(!(z?ft in a:Jt.call(a,ft)))return!1}var mt=C.get(r),Ut=C.get(a);if(mt&&Ut)return mt==a&&Ut==r;var Dt=!0;C.set(r,a),C.set(a,r);for(var Et=z;++K<N;){ft=L[K];var Ot=r[ft],Vt=a[ft];if(m)var ai=z?m(Vt,Ot,ft,a,r,C):m(Ot,Vt,ft,r,a,C);if(!(ai===u?Ot===Vt||x(Ot,Vt,c,m,C):ai)){Dt=!1;break}Et||(Et=ft=="constructor")}if(Dt&&!Et){var $e=r.constructor,oi=a.constructor;$e!=oi&&"constructor"in r&&"constructor"in a&&!(typeof $e=="function"&&$e instanceof $e&&typeof oi=="function"&&oi instanceof oi)&&(Dt=!1)}return C.delete(r),C.delete(a),Dt}function en(r){return kl(Lf(r,u,Yf),r+"")}function El(r){return Xh(r,Ie,Il)}function Cl(r){return Xh(r,Ze,If)}var Tl=va?function(r){return va.get(r)}:Wl;function Fa(r){for(var a=r.name+"",c=Ur[a],m=Jt.call(Ur,a)?c.length:0;m--;){var x=c[m],C=x.func;if(C==null||C==r)return x.name}return a}function Ar(r){var a=Jt.call(E,"placeholder")?E:r;return a.placeholder}function St(){var r=E.iteratee||Vl;return r=r===Vl?Kh:r,arguments.length?r(arguments[0],arguments[1]):r}function ka(r,a){var c=r.__data__;return Lg(a)?c[typeof a=="string"?"string":"hash"]:c.map}function Al(r){for(var a=Ie(r),c=a.length;c--;){var m=a[c],x=r[m];a[c]=[m,x,Ff(x)]}return a}function qn(r,a){var c=Rp(r,a);return jh(c)?c:u}function Tg(r){var a=Jt.call(r,Yn),c=r[Yn];try{r[Yn]=u;var m=!0}catch{}var x=ha.call(r);return m&&(a?r[Yn]=c:delete r[Yn]),x}var Il=il?function(r){return r==null?[]:(r=ne(r),yn(il(r),function(a){return Lh.call(r,a)}))}:Xl,If=il?function(r){for(var a=[];r;)wn(a,Il(r)),r=ca(r);return a}:Xl,Ne=Ye;(nl&&Ne(new nl(new ArrayBuffer(1)))!=ci||ms&&Ne(new ms)!=Yt||rl&&Ne(rl.resolve())!=Ae||Sr&&Ne(new Sr)!=ue||vs&&Ne(new vs)!=qt)&&(Ne=function(r){var a=Ye(r),c=a==jt?r.constructor:u,m=c?jn(c):"";if(m)switch(m){case u_:return ci;case h_:return Yt;case f_:return Ae;case d_:return ue;case c_:return qt}return a});function Ag(r,a,c){for(var m=-1,x=c.length;++m<x;){var C=c[m],z=C.size;switch(C.type){case"drop":r+=z;break;case"dropRight":a-=z;break;case"take":a=Oe(a,r+z);break;case"takeRight":r=be(r,a-z);break}}return{start:r,end:a}}function Ig(r){var a=r.match(ta);return a?a[1].split(Xu):[]}function Bf(r,a,c){a=En(a,r);for(var m=-1,x=a.length,C=!1;++m<x;){var z=$i(a[m]);if(!(C=r!=null&&c(r,z)))break;r=r[z]}return C||++m!=x?C:(x=r==null?0:r.length,!!x&&Na(x)&&nn(z,x)&&(zt(r)||Kn(r)))}function Bg(r){var a=r.length,c=new r.constructor(a);return a&&typeof r[0]=="string"&&Jt.call(r,"index")&&(c.index=r.index,c.input=r.input),c}function zf(r){return typeof r.constructor=="function"&&!Ts(r)?Er(ca(r)):{}}function zg(r,a,c){var m=r.constructor;switch(a){case di:return bl(r);case ht:case V:return new m(+r);case ci:return pg(r,c);case gr:case Gn:case hs:case fs:case ds:case Gi:case cs:case vn:case ps:return cf(r,c);case Yt:return new m;case ut:case qe:return new m(r);case ze:return _g(r);case ue:return new m;case Ni:return gg(r)}}function Fg(r,a){var c=a.length;if(!c)return r;var m=c-1;return a[m]=(c>1?"& ":"")+a[m],a=a.join(c>2?", ":" "),r.replace(Hi,`{
/* [wrapped with `+a+`] */
`)}function kg(r){return zt(r)||Kn(r)||!!(Ph&&r&&r[Ph])}function nn(r,a){var c=typeof r;return a=a??Ht,!!a&&(c=="number"||c!="symbol"&&$c.test(r))&&r>-1&&r%1==0&&r<a}function Ve(r,a,c){if(!de(c))return!1;var m=typeof a;return(m=="number"?Ke(c)&&nn(a,c.length):m=="string"&&a in c)?Ai(c[a],r):!1}function Bl(r,a){if(zt(r))return!1;var c=typeof r;return c=="number"||c=="symbol"||c=="boolean"||r==null||si(r)?!0:te.test(r)||!At.test(r)||a!=null&&r in ne(a)}function Lg(r){var a=typeof r;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?r!=="__proto__":r===null}function zl(r){var a=Fa(r),c=E[a];if(typeof c!="function"||!(a in Gt.prototype))return!1;if(r===c)return!0;var m=Tl(c);return!!m&&r===m[0]}function Pg(r){return!!zh&&zh in r}var Dg=la?rn:ql;function Ts(r){var a=r&&r.constructor,c=typeof a=="function"&&a.prototype||br;return r===c}function Ff(r){return r===r&&!de(r)}function kf(r,a){return function(c){return c==null?!1:c[r]===a&&(a!==u||r in ne(c))}}function Rg(r){var a=Ma(r,function(m){return c.size===A&&c.clear(),m}),c=a.cache;return a}function Mg(r,a){var c=r[1],m=a[1],x=c|m,C=x<(n|o|k),z=m==k&&c==g||m==k&&c==F&&r[7].length<=a[8]||m==(k|F)&&a[7].length<=a[8]&&c==g;if(!(C||z))return r;m&n&&(r[2]=a[2],x|=c&n?0:f);var L=a[3];if(L){var N=r[3];r[3]=N?_f(N,L,a[4]):L,r[4]=N?xn(r[3],B):a[4]}return L=a[5],L&&(N=r[5],r[5]=N?gf(N,L,a[6]):L,r[6]=N?xn(r[5],B):a[6]),L=a[7],L&&(r[7]=L),m&k&&(r[8]=r[8]==null?a[8]:Oe(r[8],a[8])),r[9]==null&&(r[9]=a[9]),r[0]=a[0],r[1]=x,r}function Og(r){var a=[];if(r!=null)for(var c in ne(r))a.push(c);return a}function Ng(r){return ha.call(r)}function Lf(r,a,c){return a=be(a===u?r.length-1:a,0),function(){for(var m=arguments,x=-1,C=be(m.length-a,0),z=$(C);++x<C;)z[x]=m[a+x];x=-1;for(var L=$(a+1);++x<a;)L[x]=m[x];return L[a]=c(z),ii(r,this,L)}}function Pf(r,a){return a.length<2?r:Xn(r,yi(a,0,-1))}function Gg(r,a){for(var c=r.length,m=Oe(a.length,c),x=je(r);m--;){var C=a[m];r[m]=nn(C,c)?x[C]:u}return r}function Fl(r,a){if(!(a==="constructor"&&typeof r[a]=="function")&&a!="__proto__")return r[a]}var Df=Mf(sf),As=i_||function(r,a){return Fe.setTimeout(r,a)},kl=Mf(hg);function Rf(r,a,c){var m=a+"";return kl(r,Fg(m,Hg(Ig(m),c)))}function Mf(r){var a=0,c=0;return function(){var m=a_(),x=at-(m-c);if(c=m,x>0){if(++a>=et)return arguments[0]}else a=0;return r.apply(u,arguments)}}function La(r,a){var c=-1,m=r.length,x=m-1;for(a=a===u?m:a;++c<a;){var C=_l(c,x),z=r[C];r[C]=r[c],r[c]=z}return r.length=a,r}var Of=Rg(function(r){var a=[];return r.charCodeAt(0)===46&&a.push(""),r.replace(ye,function(c,m,x,C){a.push(x?C.replace(Oc,"$1"):m||c)}),a});function $i(r){if(typeof r=="string"||si(r))return r;var a=r+"";return a=="0"&&1/r==-1/0?"-0":a}function jn(r){if(r!=null){try{return ua.call(r)}catch{}try{return r+""}catch{}}return""}function Hg(r,a){return _i(vt,function(c){var m="_."+c[0];a&c[1]&&!ra(r,m)&&r.push(m)}),r.sort()}function Nf(r){if(r instanceof Gt)return r.clone();var a=new mi(r.__wrapped__,r.__chain__);return a.__actions__=je(r.__actions__),a.__index__=r.__index__,a.__values__=r.__values__,a}function Yg(r,a,c){(c?Ve(r,a,c):a===u)?a=1:a=be(Lt(a),0);var m=r==null?0:r.length;if(!m||a<1)return[];for(var x=0,C=0,z=$(ga(m/a));x<m;)z[C++]=yi(r,x,x+=a);return z}function Vg(r){for(var a=-1,c=r==null?0:r.length,m=0,x=[];++a<c;){var C=r[a];C&&(x[m++]=C)}return x}function $g(){var r=arguments.length;if(!r)return[];for(var a=$(r-1),c=arguments[0],m=r;m--;)a[m-1]=arguments[m];return wn(zt(c)?je(c):[c],ke(a,1))}var Wg=Mt(function(r,a){return me(r)?bs(r,ke(a,1,me,!0)):[]}),Xg=Mt(function(r,a){var c=wi(a);return me(c)&&(c=u),me(r)?bs(r,ke(a,1,me,!0),St(c,2)):[]}),qg=Mt(function(r,a){var c=wi(a);return me(c)&&(c=u),me(r)?bs(r,ke(a,1,me,!0),u,c):[]});function jg(r,a,c){var m=r==null?0:r.length;return m?(a=c||a===u?1:Lt(a),yi(r,a<0?0:a,m)):[]}function Kg(r,a,c){var m=r==null?0:r.length;return m?(a=c||a===u?1:Lt(a),a=m-a,yi(r,0,a<0?0:a)):[]}function Zg(r,a){return r&&r.length?Ca(r,St(a,3),!0,!0):[]}function Jg(r,a){return r&&r.length?Ca(r,St(a,3),!0):[]}function Qg(r,a,c,m){var x=r==null?0:r.length;return x?(c&&typeof c!="number"&&Ve(r,a,c)&&(c=0,m=x),$_(r,a,c,m)):[]}function Gf(r,a,c){var m=r==null?0:r.length;if(!m)return-1;var x=c==null?0:Lt(c);return x<0&&(x=be(m+x,0)),sa(r,St(a,3),x)}function Hf(r,a,c){var m=r==null?0:r.length;if(!m)return-1;var x=m-1;return c!==u&&(x=Lt(c),x=c<0?be(m+x,0):Oe(x,m-1)),sa(r,St(a,3),x,!0)}function Yf(r){var a=r==null?0:r.length;return a?ke(r,1):[]}function tm(r){var a=r==null?0:r.length;return a?ke(r,Bt):[]}function em(r,a){var c=r==null?0:r.length;return c?(a=a===u?1:Lt(a),ke(r,a)):[]}function im(r){for(var a=-1,c=r==null?0:r.length,m={};++a<c;){var x=r[a];m[x[0]]=x[1]}return m}function Vf(r){return r&&r.length?r[0]:u}function nm(r,a,c){var m=r==null?0:r.length;if(!m)return-1;var x=c==null?0:Lt(c);return x<0&&(x=be(m+x,0)),vr(r,a,x)}function rm(r){var a=r==null?0:r.length;return a?yi(r,0,-1):[]}var sm=Mt(function(r){var a=le(r,wl);return a.length&&a[0]===r[0]?hl(a):[]}),am=Mt(function(r){var a=wi(r),c=le(r,wl);return a===wi(c)?a=u:c.pop(),c.length&&c[0]===r[0]?hl(c,St(a,2)):[]}),om=Mt(function(r){var a=wi(r),c=le(r,wl);return a=typeof a=="function"?a:u,a&&c.pop(),c.length&&c[0]===r[0]?hl(c,u,a):[]});function lm(r,a){return r==null?"":r_.call(r,a)}function wi(r){var a=r==null?0:r.length;return a?r[a-1]:u}function um(r,a,c){var m=r==null?0:r.length;if(!m)return-1;var x=m;return c!==u&&(x=Lt(c),x=x<0?be(m+x,0):Oe(x,m-1)),a===a?Hp(r,a,x):sa(r,Sh,x,!0)}function hm(r,a){return r&&r.length?tf(r,Lt(a)):u}var fm=Mt($f);function $f(r,a){return r&&r.length&&a&&a.length?pl(r,a):r}function dm(r,a,c){return r&&r.length&&a&&a.length?pl(r,a,St(c,2)):r}function cm(r,a,c){return r&&r.length&&a&&a.length?pl(r,a,u,c):r}var pm=en(function(r,a){var c=r==null?0:r.length,m=al(r,a);return rf(r,le(a,function(x){return nn(x,c)?+x:x}).sort(pf)),m});function _m(r,a){var c=[];if(!(r&&r.length))return c;var m=-1,x=[],C=r.length;for(a=St(a,3);++m<C;){var z=r[m];a(z,m,r)&&(c.push(z),x.push(m))}return rf(r,x),c}function Ll(r){return r==null?r:l_.call(r)}function gm(r,a,c){var m=r==null?0:r.length;return m?(c&&typeof c!="number"&&Ve(r,a,c)?(a=0,c=m):(a=a==null?0:Lt(a),c=c===u?m:Lt(c)),yi(r,a,c)):[]}function mm(r,a){return Ea(r,a)}function vm(r,a,c){return ml(r,a,St(c,2))}function ym(r,a){var c=r==null?0:r.length;if(c){var m=Ea(r,a);if(m<c&&Ai(r[m],a))return m}return-1}function wm(r,a){return Ea(r,a,!0)}function xm(r,a,c){return ml(r,a,St(c,2),!0)}function bm(r,a){var c=r==null?0:r.length;if(c){var m=Ea(r,a,!0)-1;if(Ai(r[m],a))return m}return-1}function Sm(r){return r&&r.length?af(r):[]}function Um(r,a){return r&&r.length?af(r,St(a,2)):[]}function Em(r){var a=r==null?0:r.length;return a?yi(r,1,a):[]}function Cm(r,a,c){return r&&r.length?(a=c||a===u?1:Lt(a),yi(r,0,a<0?0:a)):[]}function Tm(r,a,c){var m=r==null?0:r.length;return m?(a=c||a===u?1:Lt(a),a=m-a,yi(r,a<0?0:a,m)):[]}function Am(r,a){return r&&r.length?Ca(r,St(a,3),!1,!0):[]}function Im(r,a){return r&&r.length?Ca(r,St(a,3)):[]}var Bm=Mt(function(r){return Un(ke(r,1,me,!0))}),zm=Mt(function(r){var a=wi(r);return me(a)&&(a=u),Un(ke(r,1,me,!0),St(a,2))}),Fm=Mt(function(r){var a=wi(r);return a=typeof a=="function"?a:u,Un(ke(r,1,me,!0),u,a)});function km(r){return r&&r.length?Un(r):[]}function Lm(r,a){return r&&r.length?Un(r,St(a,2)):[]}function Pm(r,a){return a=typeof a=="function"?a:u,r&&r.length?Un(r,u,a):[]}function Pl(r){if(!(r&&r.length))return[];var a=0;return r=yn(r,function(c){if(me(c))return a=be(c.length,a),!0}),Jo(a,function(c){return le(r,jo(c))})}function Wf(r,a){if(!(r&&r.length))return[];var c=Pl(r);return a==null?c:le(c,function(m){return ii(a,u,m)})}var Dm=Mt(function(r,a){return me(r)?bs(r,a):[]}),Rm=Mt(function(r){return yl(yn(r,me))}),Mm=Mt(function(r){var a=wi(r);return me(a)&&(a=u),yl(yn(r,me),St(a,2))}),Om=Mt(function(r){var a=wi(r);return a=typeof a=="function"?a:u,yl(yn(r,me),u,a)}),Nm=Mt(Pl);function Gm(r,a){return hf(r||[],a||[],xs)}function Hm(r,a){return hf(r||[],a||[],Es)}var Ym=Mt(function(r){var a=r.length,c=a>1?r[a-1]:u;return c=typeof c=="function"?(r.pop(),c):u,Wf(r,c)});function Xf(r){var a=E(r);return a.__chain__=!0,a}function Vm(r,a){return a(r),r}function Pa(r,a){return a(r)}var $m=en(function(r){var a=r.length,c=a?r[0]:0,m=this.__wrapped__,x=function(C){return al(C,r)};return a>1||this.__actions__.length||!(m instanceof Gt)||!nn(c)?this.thru(x):(m=m.slice(c,+c+(a?1:0)),m.__actions__.push({func:Pa,args:[x],thisArg:u}),new mi(m,this.__chain__).thru(function(C){return a&&!C.length&&C.push(u),C}))});function Wm(){return Xf(this)}function Xm(){return new mi(this.value(),this.__chain__)}function qm(){this.__values__===u&&(this.__values__=od(this.value()));var r=this.__index__>=this.__values__.length,a=r?u:this.__values__[this.__index__++];return{done:r,value:a}}function jm(){return this}function Km(r){for(var a,c=this;c instanceof wa;){var m=Nf(c);m.__index__=0,m.__values__=u,a?x.__wrapped__=m:a=m;var x=m;c=c.__wrapped__}return x.__wrapped__=r,a}function Zm(){var r=this.__wrapped__;if(r instanceof Gt){var a=r;return this.__actions__.length&&(a=new Gt(this)),a=a.reverse(),a.__actions__.push({func:Pa,args:[Ll],thisArg:u}),new mi(a,this.__chain__)}return this.thru(Ll)}function Jm(){return uf(this.__wrapped__,this.__actions__)}var Qm=Ta(function(r,a,c){Jt.call(r,c)?++r[c]:Qi(r,c,1)});function tv(r,a,c){var m=zt(r)?xh:V_;return c&&Ve(r,a,c)&&(a=u),m(r,St(a,3))}function ev(r,a){var c=zt(r)?yn:$h;return c(r,St(a,3))}var iv=wf(Gf),nv=wf(Hf);function rv(r,a){return ke(Da(r,a),1)}function sv(r,a){return ke(Da(r,a),Bt)}function av(r,a,c){return c=c===u?1:Lt(c),ke(Da(r,a),c)}function qf(r,a){var c=zt(r)?_i:Sn;return c(r,St(a,3))}function jf(r,a){var c=zt(r)?Ep:Vh;return c(r,St(a,3))}var ov=Ta(function(r,a,c){Jt.call(r,c)?r[c].push(a):Qi(r,c,[a])});function lv(r,a,c,m){r=Ke(r)?r:Br(r),c=c&&!m?Lt(c):0;var x=r.length;return c<0&&(c=be(x+c,0)),Ga(r)?c<=x&&r.indexOf(a,c)>-1:!!x&&vr(r,a,c)>-1}var uv=Mt(function(r,a,c){var m=-1,x=typeof a=="function",C=Ke(r)?$(r.length):[];return Sn(r,function(z){C[++m]=x?ii(a,z,c):Ss(z,a,c)}),C}),hv=Ta(function(r,a,c){Qi(r,c,a)});function Da(r,a){var c=zt(r)?le:Zh;return c(r,St(a,3))}function fv(r,a,c,m){return r==null?[]:(zt(a)||(a=a==null?[]:[a]),c=m?u:c,zt(c)||(c=c==null?[]:[c]),ef(r,a,c))}var dv=Ta(function(r,a,c){r[c?0:1].push(a)},function(){return[[],[]]});function cv(r,a,c){var m=zt(r)?Xo:Eh,x=arguments.length<3;return m(r,St(a,4),c,x,Sn)}function pv(r,a,c){var m=zt(r)?Cp:Eh,x=arguments.length<3;return m(r,St(a,4),c,x,Vh)}function _v(r,a){var c=zt(r)?yn:$h;return c(r,Oa(St(a,3)))}function gv(r){var a=zt(r)?Nh:lg;return a(r)}function mv(r,a,c){(c?Ve(r,a,c):a===u)?a=1:a=Lt(a);var m=zt(r)?O_:ug;return m(r,a)}function vv(r){var a=zt(r)?N_:fg;return a(r)}function yv(r){if(r==null)return 0;if(Ke(r))return Ga(r)?wr(r):r.length;var a=Ne(r);return a==Yt||a==ue?r.size:dl(r).length}function wv(r,a,c){var m=zt(r)?qo:dg;return c&&Ve(r,a,c)&&(a=u),m(r,St(a,3))}var xv=Mt(function(r,a){if(r==null)return[];var c=a.length;return c>1&&Ve(r,a[0],a[1])?a=[]:c>2&&Ve(a[0],a[1],a[2])&&(a=[a[0]]),ef(r,ke(a,1),[])}),Ra=e_||function(){return Fe.Date.now()};function bv(r,a){if(typeof a!="function")throw new gi(y);return r=Lt(r),function(){if(--r<1)return a.apply(this,arguments)}}function Kf(r,a,c){return a=c?u:a,a=r&&a==null?r.length:a,tn(r,k,u,u,u,u,a)}function Zf(r,a){var c;if(typeof a!="function")throw new gi(y);return r=Lt(r),function(){return--r>0&&(c=a.apply(this,arguments)),r<=1&&(a=u),c}}var Dl=Mt(function(r,a,c){var m=n;if(c.length){var x=xn(c,Ar(Dl));m|=w}return tn(r,m,a,c,x)}),Jf=Mt(function(r,a,c){var m=n|o;if(c.length){var x=xn(c,Ar(Jf));m|=w}return tn(a,m,r,c,x)});function Qf(r,a,c){a=c?u:a;var m=tn(r,g,u,u,u,u,u,a);return m.placeholder=Qf.placeholder,m}function td(r,a,c){a=c?u:a;var m=tn(r,v,u,u,u,u,u,a);return m.placeholder=td.placeholder,m}function ed(r,a,c){var m,x,C,z,L,N,q=0,j=!1,K=!1,ft=!0;if(typeof r!="function")throw new gi(y);a=xi(a)||0,de(c)&&(j=!!c.leading,K="maxWait"in c,C=K?be(xi(c.maxWait)||0,a):C,ft="trailing"in c?!!c.trailing:ft);function mt(ve){var Ii=m,an=x;return m=x=u,q=ve,z=r.apply(an,Ii),z}function Ut(ve){return q=ve,L=As(Ot,a),j?mt(ve):z}function Dt(ve){var Ii=ve-N,an=ve-q,wd=a-Ii;return K?Oe(wd,C-an):wd}function Et(ve){var Ii=ve-N,an=ve-q;return N===u||Ii>=a||Ii<0||K&&an>=C}function Ot(){var ve=Ra();if(Et(ve))return Vt(ve);L=As(Ot,Dt(ve))}function Vt(ve){return L=u,ft&&m?mt(ve):(m=x=u,z)}function ai(){L!==u&&ff(L),q=0,m=N=x=L=u}function $e(){return L===u?z:Vt(Ra())}function oi(){var ve=Ra(),Ii=Et(ve);if(m=arguments,x=this,N=ve,Ii){if(L===u)return Ut(N);if(K)return ff(L),L=As(Ot,a),mt(N)}return L===u&&(L=As(Ot,a)),z}return oi.cancel=ai,oi.flush=$e,oi}var Sv=Mt(function(r,a){return Yh(r,1,a)}),Uv=Mt(function(r,a,c){return Yh(r,xi(a)||0,c)});function Ev(r){return tn(r,P)}function Ma(r,a){if(typeof r!="function"||a!=null&&typeof a!="function")throw new gi(y);var c=function(){var m=arguments,x=a?a.apply(this,m):m[0],C=c.cache;if(C.has(x))return C.get(x);var z=r.apply(this,m);return c.cache=C.set(x,z)||C,z};return c.cache=new(Ma.Cache||Ji),c}Ma.Cache=Ji;function Oa(r){if(typeof r!="function")throw new gi(y);return function(){var a=arguments;switch(a.length){case 0:return!r.call(this);case 1:return!r.call(this,a[0]);case 2:return!r.call(this,a[0],a[1]);case 3:return!r.call(this,a[0],a[1],a[2])}return!r.apply(this,a)}}function Cv(r){return Zf(2,r)}var Tv=cg(function(r,a){a=a.length==1&&zt(a[0])?le(a[0],ni(St())):le(ke(a,1),ni(St()));var c=a.length;return Mt(function(m){for(var x=-1,C=Oe(m.length,c);++x<C;)m[x]=a[x].call(this,m[x]);return ii(r,this,m)})}),Rl=Mt(function(r,a){var c=xn(a,Ar(Rl));return tn(r,w,u,a,c)}),id=Mt(function(r,a){var c=xn(a,Ar(id));return tn(r,S,u,a,c)}),Av=en(function(r,a){return tn(r,F,u,u,u,a)});function Iv(r,a){if(typeof r!="function")throw new gi(y);return a=a===u?a:Lt(a),Mt(r,a)}function Bv(r,a){if(typeof r!="function")throw new gi(y);return a=a==null?0:be(Lt(a),0),Mt(function(c){var m=c[a],x=Cn(c,0,a);return m&&wn(x,m),ii(r,this,x)})}function zv(r,a,c){var m=!0,x=!0;if(typeof r!="function")throw new gi(y);return de(c)&&(m="leading"in c?!!c.leading:m,x="trailing"in c?!!c.trailing:x),ed(r,a,{leading:m,maxWait:a,trailing:x})}function Fv(r){return Kf(r,1)}function kv(r,a){return Rl(xl(a),r)}function Lv(){if(!arguments.length)return[];var r=arguments[0];return zt(r)?r:[r]}function Pv(r){return vi(r,G)}function Dv(r,a){return a=typeof a=="function"?a:u,vi(r,G,a)}function Rv(r){return vi(r,I|G)}function Mv(r,a){return a=typeof a=="function"?a:u,vi(r,I|G,a)}function Ov(r,a){return a==null||Hh(r,a,Ie(a))}function Ai(r,a){return r===a||r!==r&&a!==a}var Nv=za(ul),Gv=za(function(r,a){return r>=a}),Kn=qh(function(){return arguments}())?qh:function(r){return pe(r)&&Jt.call(r,"callee")&&!Lh.call(r,"callee")},zt=$.isArray,Hv=_h?ni(_h):K_;function Ke(r){return r!=null&&Na(r.length)&&!rn(r)}function me(r){return pe(r)&&Ke(r)}function Yv(r){return r===!0||r===!1||pe(r)&&Ye(r)==ht}var Tn=n_||ql,Vv=gh?ni(gh):Z_;function $v(r){return pe(r)&&r.nodeType===1&&!Is(r)}function Wv(r){if(r==null)return!0;if(Ke(r)&&(zt(r)||typeof r=="string"||typeof r.splice=="function"||Tn(r)||Ir(r)||Kn(r)))return!r.length;var a=Ne(r);if(a==Yt||a==ue)return!r.size;if(Ts(r))return!dl(r).length;for(var c in r)if(Jt.call(r,c))return!1;return!0}function Xv(r,a){return Us(r,a)}function qv(r,a,c){c=typeof c=="function"?c:u;var m=c?c(r,a):u;return m===u?Us(r,a,u,c):!!m}function Ml(r){if(!pe(r))return!1;var a=Ye(r);return a==ot||a==nt||typeof r.message=="string"&&typeof r.name=="string"&&!Is(r)}function jv(r){return typeof r=="number"&&Dh(r)}function rn(r){if(!de(r))return!1;var a=Ye(r);return a==Qt||a==Wt||a==Te||a==mn}function nd(r){return typeof r=="number"&&r==Lt(r)}function Na(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Ht}function de(r){var a=typeof r;return r!=null&&(a=="object"||a=="function")}function pe(r){return r!=null&&typeof r=="object"}var rd=mh?ni(mh):Q_;function Kv(r,a){return r===a||fl(r,a,Al(a))}function Zv(r,a,c){return c=typeof c=="function"?c:u,fl(r,a,Al(a),c)}function Jv(r){return sd(r)&&r!=+r}function Qv(r){if(Dg(r))throw new It(_);return jh(r)}function ty(r){return r===null}function ey(r){return r==null}function sd(r){return typeof r=="number"||pe(r)&&Ye(r)==ut}function Is(r){if(!pe(r)||Ye(r)!=jt)return!1;var a=ca(r);if(a===null)return!0;var c=Jt.call(a,"constructor")&&a.constructor;return typeof c=="function"&&c instanceof c&&ua.call(c)==Zp}var Ol=vh?ni(vh):tg;function iy(r){return nd(r)&&r>=-9007199254740991&&r<=Ht}var ad=yh?ni(yh):eg;function Ga(r){return typeof r=="string"||!zt(r)&&pe(r)&&Ye(r)==qe}function si(r){return typeof r=="symbol"||pe(r)&&Ye(r)==Ni}var Ir=wh?ni(wh):ig;function ny(r){return r===u}function ry(r){return pe(r)&&Ne(r)==qt}function sy(r){return pe(r)&&Ye(r)==Nn}var ay=za(cl),oy=za(function(r,a){return r<=a});function od(r){if(!r)return[];if(Ke(r))return Ga(r)?Ci(r):je(r);if(gs&&r[gs])return Op(r[gs]());var a=Ne(r),c=a==Yt?tl:a==ue?aa:Br;return c(r)}function sn(r){if(!r)return r===0?r:0;if(r=xi(r),r===Bt||r===-1/0){var a=r<0?-1:1;return a*it}return r===r?r:0}function Lt(r){var a=sn(r),c=a%1;return a===a?c?a-c:a:0}function ld(r){return r?Wn(Lt(r),0,H):0}function xi(r){if(typeof r=="number")return r;if(si(r))return ee;if(de(r)){var a=typeof r.valueOf=="function"?r.valueOf():r;r=de(a)?a+"":a}if(typeof r!="string")return r===0?r:+r;r=Ch(r);var c=Hc.test(r);return c||Vc.test(r)?bp(r.slice(2),c?2:8):Gc.test(r)?ee:+r}function ud(r){return Vi(r,Ze(r))}function ly(r){return r?Wn(Lt(r),-9007199254740991,Ht):r===0?r:0}function Zt(r){return r==null?"":ri(r)}var uy=Cr(function(r,a){if(Ts(a)||Ke(a)){Vi(a,Ie(a),r);return}for(var c in a)Jt.call(a,c)&&xs(r,c,a[c])}),hd=Cr(function(r,a){Vi(a,Ze(a),r)}),Ha=Cr(function(r,a,c,m){Vi(a,Ze(a),r,m)}),hy=Cr(function(r,a,c,m){Vi(a,Ie(a),r,m)}),fy=en(al);function dy(r,a){var c=Er(r);return a==null?c:Gh(c,a)}var cy=Mt(function(r,a){r=ne(r);var c=-1,m=a.length,x=m>2?a[2]:u;for(x&&Ve(a[0],a[1],x)&&(m=1);++c<m;)for(var C=a[c],z=Ze(C),L=-1,N=z.length;++L<N;){var q=z[L],j=r[q];(j===u||Ai(j,br[q])&&!Jt.call(r,q))&&(r[q]=C[q])}return r}),py=Mt(function(r){return r.push(u,Tf),ii(fd,u,r)});function _y(r,a){return bh(r,St(a,3),Yi)}function gy(r,a){return bh(r,St(a,3),ll)}function my(r,a){return r==null?r:ol(r,St(a,3),Ze)}function vy(r,a){return r==null?r:Wh(r,St(a,3),Ze)}function yy(r,a){return r&&Yi(r,St(a,3))}function wy(r,a){return r&&ll(r,St(a,3))}function xy(r){return r==null?[]:Sa(r,Ie(r))}function by(r){return r==null?[]:Sa(r,Ze(r))}function Nl(r,a,c){var m=r==null?u:Xn(r,a);return m===u?c:m}function Sy(r,a){return r!=null&&Bf(r,a,W_)}function Gl(r,a){return r!=null&&Bf(r,a,X_)}var Uy=bf(function(r,a,c){a!=null&&typeof a.toString!="function"&&(a=ha.call(a)),r[a]=c},Yl(Je)),Ey=bf(function(r,a,c){a!=null&&typeof a.toString!="function"&&(a=ha.call(a)),Jt.call(r,a)?r[a].push(c):r[a]=[c]},St),Cy=Mt(Ss);function Ie(r){return Ke(r)?Oh(r):dl(r)}function Ze(r){return Ke(r)?Oh(r,!0):ng(r)}function Ty(r,a){var c={};return a=St(a,3),Yi(r,function(m,x,C){Qi(c,a(m,x,C),m)}),c}function Ay(r,a){var c={};return a=St(a,3),Yi(r,function(m,x,C){Qi(c,x,a(m,x,C))}),c}var Iy=Cr(function(r,a,c){Ua(r,a,c)}),fd=Cr(function(r,a,c,m){Ua(r,a,c,m)}),By=en(function(r,a){var c={};if(r==null)return c;var m=!1;a=le(a,function(C){return C=En(C,r),m||(m=C.length>1),C}),Vi(r,Cl(r),c),m&&(c=vi(c,I|U|G,Ug));for(var x=a.length;x--;)vl(c,a[x]);return c});function zy(r,a){return dd(r,Oa(St(a)))}var Fy=en(function(r,a){return r==null?{}:sg(r,a)});function dd(r,a){if(r==null)return{};var c=le(Cl(r),function(m){return[m]});return a=St(a),nf(r,c,function(m,x){return a(m,x[0])})}function ky(r,a,c){a=En(a,r);var m=-1,x=a.length;for(x||(x=1,r=u);++m<x;){var C=r==null?u:r[$i(a[m])];C===u&&(m=x,C=c),r=rn(C)?C.call(r):C}return r}function Ly(r,a,c){return r==null?r:Es(r,a,c)}function Py(r,a,c,m){return m=typeof m=="function"?m:u,r==null?r:Es(r,a,c,m)}var cd=Ef(Ie),pd=Ef(Ze);function Dy(r,a,c){var m=zt(r),x=m||Tn(r)||Ir(r);if(a=St(a,4),c==null){var C=r&&r.constructor;x?c=m?new C:[]:de(r)?c=rn(C)?Er(ca(r)):{}:c={}}return(x?_i:Yi)(r,function(z,L,N){return a(c,z,L,N)}),c}function Ry(r,a){return r==null?!0:vl(r,a)}function My(r,a,c){return r==null?r:lf(r,a,xl(c))}function Oy(r,a,c,m){return m=typeof m=="function"?m:u,r==null?r:lf(r,a,xl(c),m)}function Br(r){return r==null?[]:Qo(r,Ie(r))}function Ny(r){return r==null?[]:Qo(r,Ze(r))}function Gy(r,a,c){return c===u&&(c=a,a=u),c!==u&&(c=xi(c),c=c===c?c:0),a!==u&&(a=xi(a),a=a===a?a:0),Wn(xi(r),a,c)}function Hy(r,a,c){return a=sn(a),c===u?(c=a,a=0):c=sn(c),r=xi(r),q_(r,a,c)}function Yy(r,a,c){if(c&&typeof c!="boolean"&&Ve(r,a,c)&&(a=c=u),c===u&&(typeof a=="boolean"?(c=a,a=u):typeof r=="boolean"&&(c=r,r=u)),r===u&&a===u?(r=0,a=1):(r=sn(r),a===u?(a=r,r=0):a=sn(a)),r>a){var m=r;r=a,a=m}if(c||r%1||a%1){var x=Rh();return Oe(r+x*(a-r+xp("1e-"+((x+"").length-1))),a)}return _l(r,a)}var Vy=Tr(function(r,a,c){return a=a.toLowerCase(),r+(c?_d(a):a)});function _d(r){return Hl(Zt(r).toLowerCase())}function gd(r){return r=Zt(r),r&&r.replace(Wc,Lp).replace(fp,"")}function $y(r,a,c){r=Zt(r),a=ri(a);var m=r.length;c=c===u?m:Wn(Lt(c),0,m);var x=c;return c-=a.length,c>=0&&r.slice(c,x)==a}function Wy(r){return r=Zt(r),r&&xt.test(r)?r.replace(X,Pp):r}function Xy(r){return r=Zt(r),r&&he.test(r)?r.replace(we,"\\$&"):r}var qy=Tr(function(r,a,c){return r+(c?"-":"")+a.toLowerCase()}),jy=Tr(function(r,a,c){return r+(c?" ":"")+a.toLowerCase()}),Ky=yf("toLowerCase");function Zy(r,a,c){r=Zt(r),a=Lt(a);var m=a?wr(r):0;if(!a||m>=a)return r;var x=(a-m)/2;return Ba(ma(x),c)+r+Ba(ga(x),c)}function Jy(r,a,c){r=Zt(r),a=Lt(a);var m=a?wr(r):0;return a&&m<a?r+Ba(a-m,c):r}function Qy(r,a,c){r=Zt(r),a=Lt(a);var m=a?wr(r):0;return a&&m<a?Ba(a-m,c)+r:r}function t0(r,a,c){return c||a==null?a=0:a&&(a=+a),o_(Zt(r).replace(fe,""),a||0)}function e0(r,a,c){return(c?Ve(r,a,c):a===u)?a=1:a=Lt(a),gl(Zt(r),a)}function i0(){var r=arguments,a=Zt(r[0]);return r.length<3?a:a.replace(r[1],r[2])}var n0=Tr(function(r,a,c){return r+(c?"_":"")+a.toLowerCase()});function r0(r,a,c){return c&&typeof c!="number"&&Ve(r,a,c)&&(a=c=u),c=c===u?H:c>>>0,c?(r=Zt(r),r&&(typeof a=="string"||a!=null&&!Ol(a))&&(a=ri(a),!a&&yr(r))?Cn(Ci(r),0,c):r.split(a,c)):[]}var s0=Tr(function(r,a,c){return r+(c?" ":"")+Hl(a)});function a0(r,a,c){return r=Zt(r),c=c==null?0:Wn(Lt(c),0,r.length),a=ri(a),r.slice(c,c+a.length)==a}function o0(r,a,c){var m=E.templateSettings;c&&Ve(r,a,c)&&(a=u),r=Zt(r),a=Ha({},a,m,Cf);var x=Ha({},a.imports,m.imports,Cf),C=Ie(x),z=Qo(x,C),L,N,q=0,j=a.interpolate||ea,K="__p += '",ft=el((a.escape||ea).source+"|"+j.source+"|"+(j===bt?Nc:ea).source+"|"+(a.evaluate||ea).source+"|$","g"),mt="//# sourceURL="+(Jt.call(a,"sourceURL")?(a.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++gp+"]")+`
`;r.replace(ft,function(Et,Ot,Vt,ai,$e,oi){return Vt||(Vt=ai),K+=r.slice(q,oi).replace(Xc,Dp),Ot&&(L=!0,K+=`' +
__e(`+Ot+`) +
'`),$e&&(N=!0,K+=`';
`+$e+`;
__p += '`),Vt&&(K+=`' +
((__t = (`+Vt+`)) == null ? '' : __t) +
'`),q=oi+Et.length,Et}),K+=`';
`;var Ut=Jt.call(a,"variable")&&a.variable;if(!Ut)K=`with (obj) {
`+K+`
}
`;else if(Mc.test(Ut))throw new It(s);K=(N?K.replace(Do,""):K).replace(Ro,"$1").replace(Mo,"$1;"),K="function("+(Ut||"obj")+`) {
`+(Ut?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(L?", __e = _.escape":"")+(N?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+K+`return __p
}`;var Dt=vd(function(){return Kt(C,mt+"return "+K).apply(u,z)});if(Dt.source=K,Ml(Dt))throw Dt;return Dt}function l0(r){return Zt(r).toLowerCase()}function u0(r){return Zt(r).toUpperCase()}function h0(r,a,c){if(r=Zt(r),r&&(c||a===u))return Ch(r);if(!r||!(a=ri(a)))return r;var m=Ci(r),x=Ci(a),C=Th(m,x),z=Ah(m,x)+1;return Cn(m,C,z).join("")}function f0(r,a,c){if(r=Zt(r),r&&(c||a===u))return r.slice(0,Bh(r)+1);if(!r||!(a=ri(a)))return r;var m=Ci(r),x=Ah(m,Ci(a))+1;return Cn(m,0,x).join("")}function d0(r,a,c){if(r=Zt(r),r&&(c||a===u))return r.replace(fe,"");if(!r||!(a=ri(a)))return r;var m=Ci(r),x=Th(m,Ci(a));return Cn(m,x).join("")}function c0(r,a){var c=M,m=D;if(de(a)){var x="separator"in a?a.separator:x;c="length"in a?Lt(a.length):c,m="omission"in a?ri(a.omission):m}r=Zt(r);var C=r.length;if(yr(r)){var z=Ci(r);C=z.length}if(c>=C)return r;var L=c-wr(m);if(L<1)return m;var N=z?Cn(z,0,L).join(""):r.slice(0,L);if(x===u)return N+m;if(z&&(L+=N.length-L),Ol(x)){if(r.slice(L).search(x)){var q,j=N;for(x.global||(x=el(x.source,Zt(qu.exec(x))+"g")),x.lastIndex=0;q=x.exec(j);)var K=q.index;N=N.slice(0,K===u?L:K)}}else if(r.indexOf(ri(x),L)!=L){var ft=N.lastIndexOf(x);ft>-1&&(N=N.slice(0,ft))}return N+m}function p0(r){return r=Zt(r),r&&rt.test(r)?r.replace(Qs,Yp):r}var _0=Tr(function(r,a,c){return r+(c?" ":"")+a.toUpperCase()}),Hl=yf("toUpperCase");function md(r,a,c){return r=Zt(r),a=c?u:a,a===u?Mp(r)?Wp(r):Ip(r):r.match(a)||[]}var vd=Mt(function(r,a){try{return ii(r,u,a)}catch(c){return Ml(c)?c:new It(c)}}),g0=en(function(r,a){return _i(a,function(c){c=$i(c),Qi(r,c,Dl(r[c],r))}),r});function m0(r){var a=r==null?0:r.length,c=St();return r=a?le(r,function(m){if(typeof m[1]!="function")throw new gi(y);return[c(m[0]),m[1]]}):[],Mt(function(m){for(var x=-1;++x<a;){var C=r[x];if(ii(C[0],this,m))return ii(C[1],this,m)}})}function v0(r){return Y_(vi(r,I))}function Yl(r){return function(){return r}}function y0(r,a){return r==null||r!==r?a:r}var w0=xf(),x0=xf(!0);function Je(r){return r}function Vl(r){return Kh(typeof r=="function"?r:vi(r,I))}function b0(r){return Jh(vi(r,I))}function S0(r,a){return Qh(r,vi(a,I))}var U0=Mt(function(r,a){return function(c){return Ss(c,r,a)}}),E0=Mt(function(r,a){return function(c){return Ss(r,c,a)}});function $l(r,a,c){var m=Ie(a),x=Sa(a,m);c==null&&!(de(a)&&(x.length||!m.length))&&(c=a,a=r,r=this,x=Sa(a,Ie(a)));var C=!(de(c)&&"chain"in c)||!!c.chain,z=rn(r);return _i(x,function(L){var N=a[L];r[L]=N,z&&(r.prototype[L]=function(){var q=this.__chain__;if(C||q){var j=r(this.__wrapped__),K=j.__actions__=je(this.__actions__);return K.push({func:N,args:arguments,thisArg:r}),j.__chain__=q,j}return N.apply(r,wn([this.value()],arguments))})}),r}function C0(){return Fe._===this&&(Fe._=Jp),this}function Wl(){}function T0(r){return r=Lt(r),Mt(function(a){return tf(a,r)})}var A0=Sl(le),I0=Sl(xh),B0=Sl(qo);function yd(r){return Bl(r)?jo($i(r)):ag(r)}function z0(r){return function(a){return r==null?u:Xn(r,a)}}var F0=Sf(),k0=Sf(!0);function Xl(){return[]}function ql(){return!1}function L0(){return{}}function P0(){return""}function D0(){return!0}function R0(r,a){if(r=Lt(r),r<1||r>Ht)return[];var c=H,m=Oe(r,H);a=St(a),r-=H;for(var x=Jo(m,a);++c<r;)a(c);return x}function M0(r){return zt(r)?le(r,$i):si(r)?[r]:je(Of(Zt(r)))}function O0(r){var a=++Kp;return Zt(r)+a}var N0=Ia(function(r,a){return r+a},0),G0=Ul("ceil"),H0=Ia(function(r,a){return r/a},1),Y0=Ul("floor");function V0(r){return r&&r.length?ba(r,Je,ul):u}function $0(r,a){return r&&r.length?ba(r,St(a,2),ul):u}function W0(r){return Uh(r,Je)}function X0(r,a){return Uh(r,St(a,2))}function q0(r){return r&&r.length?ba(r,Je,cl):u}function j0(r,a){return r&&r.length?ba(r,St(a,2),cl):u}var K0=Ia(function(r,a){return r*a},1),Z0=Ul("round"),J0=Ia(function(r,a){return r-a},0);function Q0(r){return r&&r.length?Zo(r,Je):0}function tw(r,a){return r&&r.length?Zo(r,St(a,2)):0}return E.after=bv,E.ary=Kf,E.assign=uy,E.assignIn=hd,E.assignInWith=Ha,E.assignWith=hy,E.at=fy,E.before=Zf,E.bind=Dl,E.bindAll=g0,E.bindKey=Jf,E.castArray=Lv,E.chain=Xf,E.chunk=Yg,E.compact=Vg,E.concat=$g,E.cond=m0,E.conforms=v0,E.constant=Yl,E.countBy=Qm,E.create=dy,E.curry=Qf,E.curryRight=td,E.debounce=ed,E.defaults=cy,E.defaultsDeep=py,E.defer=Sv,E.delay=Uv,E.difference=Wg,E.differenceBy=Xg,E.differenceWith=qg,E.drop=jg,E.dropRight=Kg,E.dropRightWhile=Zg,E.dropWhile=Jg,E.fill=Qg,E.filter=ev,E.flatMap=rv,E.flatMapDeep=sv,E.flatMapDepth=av,E.flatten=Yf,E.flattenDeep=tm,E.flattenDepth=em,E.flip=Ev,E.flow=w0,E.flowRight=x0,E.fromPairs=im,E.functions=xy,E.functionsIn=by,E.groupBy=ov,E.initial=rm,E.intersection=sm,E.intersectionBy=am,E.intersectionWith=om,E.invert=Uy,E.invertBy=Ey,E.invokeMap=uv,E.iteratee=Vl,E.keyBy=hv,E.keys=Ie,E.keysIn=Ze,E.map=Da,E.mapKeys=Ty,E.mapValues=Ay,E.matches=b0,E.matchesProperty=S0,E.memoize=Ma,E.merge=Iy,E.mergeWith=fd,E.method=U0,E.methodOf=E0,E.mixin=$l,E.negate=Oa,E.nthArg=T0,E.omit=By,E.omitBy=zy,E.once=Cv,E.orderBy=fv,E.over=A0,E.overArgs=Tv,E.overEvery=I0,E.overSome=B0,E.partial=Rl,E.partialRight=id,E.partition=dv,E.pick=Fy,E.pickBy=dd,E.property=yd,E.propertyOf=z0,E.pull=fm,E.pullAll=$f,E.pullAllBy=dm,E.pullAllWith=cm,E.pullAt=pm,E.range=F0,E.rangeRight=k0,E.rearg=Av,E.reject=_v,E.remove=_m,E.rest=Iv,E.reverse=Ll,E.sampleSize=mv,E.set=Ly,E.setWith=Py,E.shuffle=vv,E.slice=gm,E.sortBy=xv,E.sortedUniq=Sm,E.sortedUniqBy=Um,E.split=r0,E.spread=Bv,E.tail=Em,E.take=Cm,E.takeRight=Tm,E.takeRightWhile=Am,E.takeWhile=Im,E.tap=Vm,E.throttle=zv,E.thru=Pa,E.toArray=od,E.toPairs=cd,E.toPairsIn=pd,E.toPath=M0,E.toPlainObject=ud,E.transform=Dy,E.unary=Fv,E.union=Bm,E.unionBy=zm,E.unionWith=Fm,E.uniq=km,E.uniqBy=Lm,E.uniqWith=Pm,E.unset=Ry,E.unzip=Pl,E.unzipWith=Wf,E.update=My,E.updateWith=Oy,E.values=Br,E.valuesIn=Ny,E.without=Dm,E.words=md,E.wrap=kv,E.xor=Rm,E.xorBy=Mm,E.xorWith=Om,E.zip=Nm,E.zipObject=Gm,E.zipObjectDeep=Hm,E.zipWith=Ym,E.entries=cd,E.entriesIn=pd,E.extend=hd,E.extendWith=Ha,$l(E,E),E.add=N0,E.attempt=vd,E.camelCase=Vy,E.capitalize=_d,E.ceil=G0,E.clamp=Gy,E.clone=Pv,E.cloneDeep=Rv,E.cloneDeepWith=Mv,E.cloneWith=Dv,E.conformsTo=Ov,E.deburr=gd,E.defaultTo=y0,E.divide=H0,E.endsWith=$y,E.eq=Ai,E.escape=Wy,E.escapeRegExp=Xy,E.every=tv,E.find=iv,E.findIndex=Gf,E.findKey=_y,E.findLast=nv,E.findLastIndex=Hf,E.findLastKey=gy,E.floor=Y0,E.forEach=qf,E.forEachRight=jf,E.forIn=my,E.forInRight=vy,E.forOwn=yy,E.forOwnRight=wy,E.get=Nl,E.gt=Nv,E.gte=Gv,E.has=Sy,E.hasIn=Gl,E.head=Vf,E.identity=Je,E.includes=lv,E.indexOf=nm,E.inRange=Hy,E.invoke=Cy,E.isArguments=Kn,E.isArray=zt,E.isArrayBuffer=Hv,E.isArrayLike=Ke,E.isArrayLikeObject=me,E.isBoolean=Yv,E.isBuffer=Tn,E.isDate=Vv,E.isElement=$v,E.isEmpty=Wv,E.isEqual=Xv,E.isEqualWith=qv,E.isError=Ml,E.isFinite=jv,E.isFunction=rn,E.isInteger=nd,E.isLength=Na,E.isMap=rd,E.isMatch=Kv,E.isMatchWith=Zv,E.isNaN=Jv,E.isNative=Qv,E.isNil=ey,E.isNull=ty,E.isNumber=sd,E.isObject=de,E.isObjectLike=pe,E.isPlainObject=Is,E.isRegExp=Ol,E.isSafeInteger=iy,E.isSet=ad,E.isString=Ga,E.isSymbol=si,E.isTypedArray=Ir,E.isUndefined=ny,E.isWeakMap=ry,E.isWeakSet=sy,E.join=lm,E.kebabCase=qy,E.last=wi,E.lastIndexOf=um,E.lowerCase=jy,E.lowerFirst=Ky,E.lt=ay,E.lte=oy,E.max=V0,E.maxBy=$0,E.mean=W0,E.meanBy=X0,E.min=q0,E.minBy=j0,E.stubArray=Xl,E.stubFalse=ql,E.stubObject=L0,E.stubString=P0,E.stubTrue=D0,E.multiply=K0,E.nth=hm,E.noConflict=C0,E.noop=Wl,E.now=Ra,E.pad=Zy,E.padEnd=Jy,E.padStart=Qy,E.parseInt=t0,E.random=Yy,E.reduce=cv,E.reduceRight=pv,E.repeat=e0,E.replace=i0,E.result=ky,E.round=Z0,E.runInContext=R,E.sample=gv,E.size=yv,E.snakeCase=n0,E.some=wv,E.sortedIndex=mm,E.sortedIndexBy=vm,E.sortedIndexOf=ym,E.sortedLastIndex=wm,E.sortedLastIndexBy=xm,E.sortedLastIndexOf=bm,E.startCase=s0,E.startsWith=a0,E.subtract=J0,E.sum=Q0,E.sumBy=tw,E.template=o0,E.times=R0,E.toFinite=sn,E.toInteger=Lt,E.toLength=ld,E.toLower=l0,E.toNumber=xi,E.toSafeInteger=ly,E.toString=Zt,E.toUpper=u0,E.trim=h0,E.trimEnd=f0,E.trimStart=d0,E.truncate=c0,E.unescape=p0,E.uniqueId=O0,E.upperCase=_0,E.upperFirst=Hl,E.each=qf,E.eachRight=jf,E.first=Vf,$l(E,function(){var r={};return Yi(E,function(a,c){Jt.call(E.prototype,c)||(r[c]=a)}),r}(),{chain:!1}),E.VERSION=h,_i(["bind","bindKey","curry","curryRight","partial","partialRight"],function(r){E[r].placeholder=E}),_i(["drop","take"],function(r,a){Gt.prototype[r]=function(c){c=c===u?1:be(Lt(c),0);var m=this.__filtered__&&!a?new Gt(this):this.clone();return m.__filtered__?m.__takeCount__=Oe(c,m.__takeCount__):m.__views__.push({size:Oe(c,H),type:r+(m.__dir__<0?"Right":"")}),m},Gt.prototype[r+"Right"]=function(c){return this.reverse()[r](c).reverse()}}),_i(["filter","map","takeWhile"],function(r,a){var c=a+1,m=c==Ft||c==Tt;Gt.prototype[r]=function(x){var C=this.clone();return C.__iteratees__.push({iteratee:St(x,3),type:c}),C.__filtered__=C.__filtered__||m,C}}),_i(["head","last"],function(r,a){var c="take"+(a?"Right":"");Gt.prototype[r]=function(){return this[c](1).value()[0]}}),_i(["initial","tail"],function(r,a){var c="drop"+(a?"":"Right");Gt.prototype[r]=function(){return this.__filtered__?new Gt(this):this[c](1)}}),Gt.prototype.compact=function(){return this.filter(Je)},Gt.prototype.find=function(r){return this.filter(r).head()},Gt.prototype.findLast=function(r){return this.reverse().find(r)},Gt.prototype.invokeMap=Mt(function(r,a){return typeof r=="function"?new Gt(this):this.map(function(c){return Ss(c,r,a)})}),Gt.prototype.reject=function(r){return this.filter(Oa(St(r)))},Gt.prototype.slice=function(r,a){r=Lt(r);var c=this;return c.__filtered__&&(r>0||a<0)?new Gt(c):(r<0?c=c.takeRight(-r):r&&(c=c.drop(r)),a!==u&&(a=Lt(a),c=a<0?c.dropRight(-a):c.take(a-r)),c)},Gt.prototype.takeRightWhile=function(r){return this.reverse().takeWhile(r).reverse()},Gt.prototype.toArray=function(){return this.take(H)},Yi(Gt.prototype,function(r,a){var c=/^(?:filter|find|map|reject)|While$/.test(a),m=/^(?:head|last)$/.test(a),x=E[m?"take"+(a=="last"?"Right":""):a],C=m||/^find/.test(a);x&&(E.prototype[a]=function(){var z=this.__wrapped__,L=m?[1]:arguments,N=z instanceof Gt,q=L[0],j=N||zt(z),K=function(Ot){var Vt=x.apply(E,wn([Ot],L));return m&&ft?Vt[0]:Vt};j&&c&&typeof q=="function"&&q.length!=1&&(N=j=!1);var ft=this.__chain__,mt=!!this.__actions__.length,Ut=C&&!ft,Dt=N&&!mt;if(!C&&j){z=Dt?z:new Gt(this);var Et=r.apply(z,L);return Et.__actions__.push({func:Pa,args:[K],thisArg:u}),new mi(Et,ft)}return Ut&&Dt?r.apply(this,L):(Et=this.thru(K),Ut?m?Et.value()[0]:Et.value():Et)})}),_i(["pop","push","shift","sort","splice","unshift"],function(r){var a=oa[r],c=/^(?:push|sort|unshift)$/.test(r)?"tap":"thru",m=/^(?:pop|shift)$/.test(r);E.prototype[r]=function(){var x=arguments;if(m&&!this.__chain__){var C=this.value();return a.apply(zt(C)?C:[],x)}return this[c](function(z){return a.apply(zt(z)?z:[],x)})}}),Yi(Gt.prototype,function(r,a){var c=E[a];if(c){var m=c.name+"";Jt.call(Ur,m)||(Ur[m]=[]),Ur[m].push({name:a,func:c})}}),Ur[Aa(u,o).name]=[{name:"wrapper",func:u}],Gt.prototype.clone=p_,Gt.prototype.reverse=__,Gt.prototype.value=g_,E.prototype.at=$m,E.prototype.chain=Wm,E.prototype.commit=Xm,E.prototype.next=qm,E.prototype.plant=Km,E.prototype.reverse=Zm,E.prototype.toJSON=E.prototype.valueOf=E.prototype.value=Jm,E.prototype.first=E.prototype.head,gs&&(E.prototype[gs]=jm),E},xr=Xp();Hn?((Hn.exports=xr)._=xr,Vo._=xr):Fe._=xr}).call(Bs)})(ko,ko.exports);var Dc=ko.exports;const BS={class:"w-full h-full bg-[#201f20] relative overflow-hidden select-none"},zS={class:"flex justify-between items-center px-4 py-2"},FS={class:"flex items-center gap-4"},kS={class:"text-white hover:text-purple-500 transition-colors"},LS={class:"flex items-center gap-2"},PS={class:"text-white min-w-[50px] text-center"},DS={class:"flex items-center gap-2"},RS={key:0,class:"absolute w-[10%] left-0 top-0 inset-0 flex flex-col items-center justify-center"},su="track-zoom-value",qd=3,Bn=150,MS=30,jd=5,au=15,OS=Re({__name:"clipTrack",props:{tracks:{},maxTracksNum:{},currentTime:{},timelineDuration:{}},emits:["resetTrack","timeUpdate","refreshPlayer","add-clip","activeClip","delete-empty-track","handleExport","update:tracks"],setup(d,{expose:l,emit:u}){const h=d,p=u,_=ge(()=>qd*y.value*10),y=_t(parseFloat(localStorage.getItem(su)||"1")),s=()=>{y.value<5&&(y.value<1?y.value=Math.min(5,Math.round((y.value+.1)*10)/10):y.value=Math.min(5,Math.floor(y.value+1)),localStorage.setItem(su,y.value.toString()))},b=()=>{y.value>.3&&(y.value<=1?y.value=Math.max(.3,Math.round((y.value-.1)*10)/10):y.value=Math.max(1,Math.floor(y.value-1)),localStorage.setItem(su,y.value.toString()))},A=ge(()=>h.timelineDuration*_.value),B=_t(null),I=_t(-1),U=_t(!1),G=_t(0),t=_t(0),e=_t(null),n=_t(0),o=_t(0),f=_t(null),g=_t(15),v=_t(null),w=_t([]),S=_t(!1),k=_t(null),F=_t(null),P=_r(),M=X=>{X.preventDefault();const rt=X.currentTarget.getBoundingClientRect(),xt=X.clientX-rt.left,gt=X.target.closest("[data-track]"),bt=gt==null?void 0:gt.getAttribute("data-track");if(!P.getDragData)return;const te=xt/_.value;try{if(bt){const ye=h.tracks.find(we=>we.id===bt);if(ye){const we=h.tracks.indexOf(ye),he=ye.clips.find(fe=>te>=fe.startTime&&te<=fe.endTime);he?(S.value=!0,F.value=he,G.value=he.startTime*_.value,I.value=we):(F.value=null,G.value=te*_.value,I.value=we)}}else F.value=null,G.value=te*_.value,I.value=-1}catch(ye){console.error("DragOver error:",ye)}},D=X=>{const rt=X.currentTarget.getBoundingClientRect(),xt=X.clientX,wt=X.clientY;(xt<rt.left||xt>rt.right||wt<rt.top||wt>rt.bottom)&&(et(),U.value=!1,I.value=-1)},et=()=>{v.value&&I.value>=0&&(h.tracks[I.value].clips.forEach(rt=>{const xt=v.value.find(wt=>wt.id===rt.id);xt&&(rt.startTime=xt.startTime)}),v.value=null,w.value=[])},at=async X=>{console.log("handleDrop"),X.preventDefault();const rt=X.currentTarget.getBoundingClientRect(),wt=(X.clientX-rt.left)/_.value,gt=P.getDragData;if(!gt)return;const bt={...gt,id:is(),rect:null,opacity:100,volume:100,startTime:S.value&&F.value?Number(F.value.startTime):wt,duration:Number((gt.duration||5*1e6)/1e6),selected:!1,sourceStartTime:0,sourceEndTime:0,originalDuration:Number((gt.duration||5*1e6)/1e6)};if(bt.endTime=bt.startTime+bt.duration,bt.type==="video"||bt.type==="image"){const At=await Iu(bt);At.type==="video"?bt.thumbnail=At.data:At.type==="image"&&(bt.thumbnail=[{timestamp:0,url:URL.createObjectURL(At.data)}])}else if(bt.type==="audio"){const At=await Bu(bt);At.type==="audio"&&(bt.volumeData=At.data)}else bt.type==="text"&&(bt.textConfig={content:"Hello, World!",fontSize:24,fontFamily:"Arial",color:"#000000",x:10,y:10,width:100,height:100});if(I.value>=0){const At=h.tracks[I.value];At.clips.push(bt),At.clips.sort((te,ye)=>te.startTime-ye.startTime)}else if(h.tracks.length<h.maxTracksNum)console.log("create new track"),h.tracks.push({id:is(),clips:[bt]});else{cr.warning("轨道数量已达到最大限制("+h.maxTracksNum+")");return}Ft(h.tracks[I.value],bt),p("add-clip",bt),Tt(),Gi(),P.clearDragData()},Ft=(X,rt)=>{if(!X||(X==null?void 0:X.clips.length)===0)return;const xt=X.clips.filter(gt=>gt.endTime>rt.startTime&&gt.startTime<rt.startTime);if(xt.length!==0&&Yt.value==="other")rt.startTime=xt[0].endTime,rt.endTime=rt.startTime+rt.duration;else if(xt.length!==0&&Yt.value==="same")if(h.tracks.length<h.maxTracksNum){const gt={id:is(),clips:[rt]},bt=h.tracks.findIndex(At=>At.id===X.id);h.tracks.splice(bt+1,0,gt),X.clips=X.clips.filter(At=>At.id!==rt.id)}else return rt.startTime=xt[0].endTime,rt.endTime=rt.startTime+rt.duration,cr.warning(`轨道数量已达到最大限制(${h.maxTracksNum})`);const wt=X.clips.filter(gt=>gt.id!==rt.id&&gt.startTime>=rt.startTime).sort((gt,bt)=>gt.startTime-bt.startTime);if(wt.length!==0&&wt[0].startTime<rt.endTime){let gt=rt.endTime;wt.forEach(bt=>{const At=bt.endTime-bt.startTime;bt.startTime=gt,bt.endTime=bt.startTime+At,gt=bt.endTime})}},lt=X=>{var rt;(rt=B.value)==null||rt.activeClip(X),it.value=X},Tt=()=>{S.value=!1,k.value=null,F.value=null,U.value=!1,I.value=-1,G.value=0},Bt=X=>{I.value=X},Ht=X=>{I.value===X&&(I.value=-1)},it=_t(null),ee=_t(!1),H=_t(null),Q=_t(0),Y=_t(0),vt=_t(0),Pt=X=>{it.value||(it.value=X)},ie=(X,rt,xt)=>{X.stopPropagation(),ee.value=!0,H.value=xt,it.value=rt,Q.value=X.clientX,Y.value=Number(rt.startTime),vt.value=Number(rt.endTime),rt.originalDuration||(rt.originalDuration=rt.duration),document.addEventListener("mousemove",ht),document.addEventListener("mouseup",V)},Te=ge(()=>MS/_.value),ht=X=>{if(!ee.value||!it.value)return;X.preventDefault(),X.stopPropagation();const rt=qt.value.getBoundingClientRect(),wt=(X.clientX-rt.left+qt.value.scrollLeft)/_.value;if(it.value.type==="video"||it.value.type==="audio"){const gt=Number(it.value.originalDuration);if(H.value==="left"){const bt=Number(it.value.endTime),At=Number(it.value.sourceEndTime),te=bt-Te.value,ye=Math.min(Math.max(0,wt),te),we=bt-ye,he=gt-(At+we);he>=0&&he+At<=gt&&(it.value.startTime=ye,it.value.duration=we,it.value.sourceStartTime=he)}else if(H.value==="right"){const bt=Number(it.value.startTime),At=Number(it.value.sourceStartTime),te=bt+Te.value,ye=bt+(gt-At),we=Math.min(Math.max(te,wt),ye),he=we-bt,fe=gt-(At+he);fe>=0&&At+he<=gt&&(it.value.endTime=we,it.value.duration=he,it.value.sourceEndTime=fe)}}else if(H.value==="left"){const gt=Number(it.value.endTime),bt=gt-Te.value,At=Math.min(Math.max(0,wt),bt),te=gt-At;it.value.startTime=At,it.value.duration=te}else if(H.value==="right"){const gt=Number(it.value.startTime),bt=gt+Te.value,At=Math.max(bt,wt),te=At-gt;it.value.endTime=At,it.value.duration=te}},V=()=>{if(ee.value&&it.value){const X=Number(it.value.startTime),rt=Number(it.value.duration);it.value.endTime=X+rt,it.value.startTime=X,it.value.duration=rt,it.value.sourceStartTime=Number(it.value.sourceStartTime),it.value.sourceEndTime=Number(it.value.sourceEndTime),it.value.originalDuration=Number(it.value.originalDuration),P.publishClipUpdate(it.value,"resize")}ee.value=!1,H.value=null,Gi(),document.removeEventListener("mousemove",ht),document.removeEventListener("mouseup",V)},nt=_t({x:0,y:0}),ot=_t(""),Qt=(X,rt,xt)=>{if(ee.value)return;xt.preventDefault(),xt.stopPropagation(),it.value=X;const wt=qt.value.getBoundingClientRect(),bt=(xt.clientX-wt.left+qt.value.scrollLeft)/_.value;nt.value={x:xt.clientX,y:xt.clientY},ot.value=rt;const At=ye=>{const we=Math.abs(ye.clientX-nt.value.x),he=Math.abs(ye.clientY-nt.value.y);(we>jd||he>jd)&&(document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",te),mn(X,xt))},te=()=>{document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",te),console.log("handleClipMouseDown",X),p("activeClip",X),p("timeUpdate",bt)};document.addEventListener("mousemove",At),document.addEventListener("mouseup",te)},Wt=_t(!1),Yt=_t(null),ut=_t(null),Nt=_t(0),jt=_t(!1),Ae=_t(null),mn=(X,rt)=>{if(!qt.value)return;Wt.value=!0,ut.value=X,it.value=X,X.selected=!0;const xt=qt.value.getBoundingClientRect(),wt=Number(X.startTime)*_.value+xt.left-qt.value.scrollLeft;Nt.value=rt.clientX-wt,n.value=rt.clientX,window.addEventListener("mousemove",ue,{capture:!0,passive:!1}),window.addEventListener("mouseup",qe,{capture:!0}),ze()},ze=()=>{if(!Wt.value||!ut.value||!qt.value)return;const X=qt.value.getBoundingClientRect();let rt=0,xt=!1;if(e.value==="right"){const gt=1-(X.right-n.value)/Bn;rt=Math.max(1,Math.round(g.value*gt)),qt.value.scrollLeft+=rt,xt=!0}else if(e.value==="left"){const gt=1-(n.value-X.left)/Bn;rt=Math.max(1,Math.round(g.value*gt)),qt.value.scrollLeft-=rt,xt=!0}else if(e.value==="up"){const gt=1-(o.value-X.top)/Bn;rt=Math.max(1,Math.round(g.value*gt)),qt.value.scrollTop-=rt,xt=!0}else if(e.value==="down"){const gt=1-(X.bottom-o.value)/Bn;rt=Math.max(1,Math.round(g.value*gt)),qt.value.scrollTop+=rt,xt=!0}if(xt){const gt=n.value-X.left+qt.value.scrollLeft-Nt.value,bt=Math.max(0,gt/_.value),At=Number(ut.value.duration);ut.value.startTime=bt,ut.value.endTime=bt+At}if(e.value){const wt=requestAnimationFrame(ze);f.value=wt}},ue=X=>{var we;if(!Wt.value||!ut.value||!qt.value)return;X.preventDefault(),X.stopPropagation(),n.value=X.clientX,o.value=X.clientY;const rt=document.elementFromPoint(X.clientX,X.clientY),xt=rt==null?void 0:rt.getAttribute("data-clip");let wt=null;xt?wt=(we=rt==null?void 0:rt.parentElement)==null?void 0:we.getAttribute("data-track"):wt=rt==null?void 0:rt.getAttribute("data-track");const gt=qt.value.getBoundingClientRect(),At=X.clientX-gt.left+qt.value.scrollLeft-Nt.value,te=Number(ut.value.duration),ye=wt?h.tracks.find(he=>he.id===wt):null;if(ye){const he=ye.clips.filter(fe=>fe.id!==ut.value.id).sort((fe,Me)=>Number(fe.startTime)-Number(Me.startTime));if(jt.value&&Ae.value!==null)if(Math.abs(At-Ae.value)>au/2)jt.value=!1,Ae.value=null;else{const Me=Ae.value/_.value;ut.value.startTime=Me,ut.value.endTime=Me+te;return}for(const fe of he){const Me=Number(fe.startTime)*_.value,Hi=Number(fe.endTime)*_.value;if(Math.abs(At-Hi)<=au){jt.value=!0,Ae.value=Hi,ut.value.startTime=Hi/_.value,ut.value.endTime=Hi/_.value+te;return}if(Math.abs(At+te*_.value-Me)<=au){jt.value=!0,Ae.value=Me-te*_.value,ut.value.startTime=Me/_.value-te,ut.value.endTime=Me/_.value;return}}}if(ut.value.startTime=Math.max(0,At/_.value),ut.value.endTime=Math.max(te,At/_.value+te),wt&&wt!==ot.value){const he=h.tracks.findIndex(fe=>fe.id===wt);if(he!==-1){const fe=h.tracks.find(Me=>Me.id===ot.value);if(fe){const Me=fe.clips.findIndex(Hi=>Hi.id===ut.value.id);Me!==-1&&(fe.clips.splice(Me,1),h.tracks[he].clips.push(ut.value),h.tracks[he].clips.sort((Hi,ta)=>Number(Hi.startTime)-Number(ta.startTime)),ot.value=wt)}}Yt.value="other"}else Yt.value="same";X.clientX>gt.right-Bn?e.value!=="right"&&(e.value="right",ze()):X.clientX<gt.left+Bn?e.value!=="left"&&(e.value="left",ze()):X.clientY<gt.top+Bn?e.value!=="up"&&(e.value="up",ze()):X.clientY>gt.bottom-Bn?e.value!=="down"&&(e.value="down",ze()):e.value!==null&&(e.value=null)},qe=X=>{if(!Wt.value||!ut.value)return;X&&(X.preventDefault(),X.stopPropagation()),jt.value=!1,Ae.value=null,f.value!==null&&(cancelAnimationFrame(f.value),f.value=null),ut.value.selected=!0,it.value=ut.value;const rt=h.tracks.find(xt=>xt.id===ot.value);Ft(rt,ut.value),P.publishClipUpdate(ut.value),Wt.value=!1,e.value=null,ut.value=null,ot.value="",Nt.value=0,Gi(),window.removeEventListener("mousemove",ue,{capture:!0}),window.removeEventListener("mouseup",qe,{capture:!0})};Zs(()=>{f.value!==null&&cancelAnimationFrame(f.value),window.removeEventListener("mousemove",ue,{capture:!0}),window.removeEventListener("mouseup",qe,{capture:!0})});const Ni=X=>{p("timeUpdate",X)},On=(X,rt)=>{const xt=h.tracks[rt],wt=xt.clips.findIndex(gt=>gt.id===X.id);wt!==-1&&(xt.clips.splice(wt,1),P.publishClipUpdate(X,"delete"),xt.clips.length===0&&h.tracks.splice(rt,1))},qt=_t(null),Nn=X=>{if(console.log("handleRulerScroll",X),qt.value){const rt=qt.value.scrollWidth-qt.value.clientWidth,xt=Math.max(0,Math.min(qt.value.scrollLeft+X,rt));qt.value.scrollLeft=xt}},di=Zd(),ci=Number(di.params.id),gr=ge(()=>P.canUndo),Gn=_t(!1);Mn(()=>h.tracks,async()=>{Gn.value=await P.getCanRedo(ci)});const hs=async()=>{if(!gr.value)return;const X=await P.undo(ci);X&&(p("update:tracks",X),p("refreshPlayer"))},fs=async()=>{if(!Gn.value)return;const X=await P.redo(ci);X&&(p("update:tracks",X),p("refreshPlayer"))},ds=async()=>{p("update:tracks",[]),await P.clearHistory(ci),p("refreshPlayer")},Gi=async()=>{P.saveHistoryState&&(cs(),await P.saveHistoryState(ci,JSON.parse(JSON.stringify(h.tracks))))},cs=()=>{p("delete-empty-track")},vn=_t(!1),ps=()=>{vn.value=!1,p("activeClip",null)};Mn([()=>it.value,()=>h.currentTime],()=>{if(!it.value){vn.value=!1;return}const rt=["video","audio","image"].includes(it.value.type),xt=h.currentTime>Number(it.value.startTime)&&h.currentTime<Number(it.value.endTime);vn.value=rt&&xt});const Do=async()=>{const X=Dc.cloneDeep(it.value);X.id=is(),X.startTime=h.currentTime,X.endTime=Number(X.endTime),X.type==="text"?(X.duration=Number(it.value.duration)-(h.currentTime-Number(it.value.startTime)),it.value.endTime=h.currentTime,it.value.duration=h.currentTime-Number(it.value.startTime)):(X.sourceStartTime=h.currentTime-Number(it.value.startTime)+Number(X.sourceStartTime),X.duration=Number(it.value.duration)-X.startTime+it.value.startTime,it.value.endTime=h.currentTime,it.value.duration=h.currentTime-Number(it.value.startTime),it.value.sourceEndTime=Number(it.value.sourceEndTime)-(h.currentTime-Number(it.value.startTime))),console.log(X),Ro(it.value).clips.push(X),P.publishClipUpdate(it.value),p("add-clip",X),Gi()},Ro=X=>h.tracks.find(rt=>rt.clips.some(xt=>xt.id===X.id)),Mo=()=>{var rt,xt;const X=it.value;X&&(P.publishClipUpdate(X,"delete"),(xt=h.tracks.find(wt=>wt.clips.some(gt=>gt.id===X.id)))==null||xt.clips.splice((rt=h.tracks.find(wt=>wt.clips.some(gt=>gt.id===X.id)))==null?void 0:rt.clips.findIndex(wt=>wt.id===X.id),1),Gi())},Qs=()=>{p("handleExport")};return l({activeClip:lt}),(X,rt)=>{const xt=$t("el-popconfirm"),wt=$t("el-tooltip"),gt=$t("el-button");return ct(),yt("div",BS,[O("div",zS,[O("div",FS,[J(xt,{id:"reset-button",title:"确定要重置轨道吗？","confirm-button-text":"确定","cancel-button-text":"取消",onConfirm:ds},{reference:Xt(()=>[O("button",kS,[J(Ct(re),{icon:"mdi:restore",width:"20"})])]),_:1}),J(wt,{content:"撤销",placement:"top"},{default:Xt(()=>[O("button",{id:"undo-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!gr.value}]),onClick:hs},[J(Ct(re),{icon:"mdi:undo",width:"20"})],2)]),_:1}),J(wt,{content:"恢复",placement:"top"},{default:Xt(()=>[O("button",{id:"redo-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!Gn.value}]),onClick:fs},[J(Ct(re),{icon:"mdi:redo",width:"20"})],2)]),_:1}),J(wt,{content:"分割",placement:"top"},{default:Xt(()=>[O("button",{id:"split-button",class:Pn(["text-white hover:text-purple-500 transition-colors",{"opacity-50 cursor-not-allowed":!vn.value}]),onClick:Do},[J(Ct(re),{icon:"material-symbols-light:split-scene-outline",width:"20"})],2)]),_:1}),J(wt,{content:"删除",placement:"top"},{default:Xt(()=>[O("button",{id:"delete-button",class:"text-white hover:text-purple-500 transition-colors",onClick:Mo},[J(Ct(re),{icon:"mdi:delete",width:"20"})])]),_:1})]),O("div",LS,[J(wt,{content:"缩小",placement:"top"},{default:Xt(()=>[O("button",{id:"zoom-out-button",class:Pn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":y.value<=.3}]),onClick:b},[J(Ct(re),{icon:"mdi:minus",width:"20"})],2)]),_:1}),O("span",PS,De(Math.round(y.value*100))+"%",1),J(wt,{content:"放大",placement:"top"},{default:Xt(()=>[O("button",{id:"zoom-in-button",class:Pn(["text-white hover:text-purple-500 transition-colors p-1 rounded",{"opacity-50 cursor-not-allowed":y.value>=5}]),onClick:s},[J(Ct(re),{icon:"mdi:plus",width:"20"})],2)]),_:1}),J(gt,{id:"export-button",class:"text-white",type:"primary",size:"small",onClick:Qs},{default:Xt(()=>[O("div",DS,[J(Ct(re),{icon:"mdi:export",width:"20"}),rt[0]||(rt[0]=ow(" 导出 "))])]),_:1})])]),O("div",{class:"h-[calc(100%-36px)] relative overflow-x-scroll",ref_key:"trackContainer",ref:qt},[J(sS,{duration:X.timelineDuration,zoom:y.value,"current-time":X.currentTime,"total-width":A.value,onScroll:Nn,onTimeUpdate:Ni},null,8,["duration","zoom","current-time","total-width"]),O("div",{class:"relative h-[calc(100%-36px)] overflow-x-hidden overflow-y-auto",style:Mi({width:A.value+"px"}),onDragover:ti(M,["prevent"]),onDragleave:ti(D,["prevent"]),onDrop:ti(at,["prevent"])},[X.tracks.length?oe("",!0):(ct(),yt("div",RS,rt[1]||(rt[1]=[O("div",{class:"text-[#666] text-lg mb-4"},"拖拽素材到此处",-1),O("div",{class:"w-[200px] h-[40px] bg-purple-500/20 border-2 border-dashed border-purple-500 rounded"},null,-1)]))),J(AS,{ref_key:"tracksListRef",ref:B,tracks:X.tracks,hoveredTrack:I.value,dragPreview:U.value,dragPreviewPosition:G.value,dragPreviewWidth:t.value,zoom:y.value,frameLength:qd*y.value*10,onStartResize:ie,onTrackDragEnter:Bt,onTrackDragLeave:Ht,onClipMouseDown:Qt,onClipHover:Pt,onDeleteClip:On,onBackgroundClick:ps,onSaveHistoryState:Gi},null,8,["tracks","hoveredTrack","dragPreview","dragPreviewPosition","dragPreviewWidth","zoom","frameLength"])],36)],512)])}}}),NS={class:"mb-6"},GS={class:"grid grid-cols-2 gap-3 mb-4"},HS={class:"mb-4"},YS={class:"flex items-center gap-4"},VS={class:"w-full"},$S={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},WS={class:"flex gap-3 mb-3"},XS={class:"flex-1"},qS={class:"flex-1"},jS={class:"flex items-center gap-3 mb-3"},KS={class:"flex-1"},ZS={class:"flex items-center gap-3"},JS={class:"flex items-center gap-3"},QS={class:"flex-1"},tU={class:"flex items-center gap-3"},eU={class:"w-12 text-right"},iU=Re({__name:"VideoProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=l,p=_t(!1),_=t=>{let e=t*(180/Math.PI);return e=e%360,e<0&&(e+=360),Math.round(e)},y=t=>t*(Math.PI/180),s=ge(()=>{var e;if(((e=u.clip)==null?void 0:e.angle)===void 0)return 0;let t=_(u.clip.angle);return t=(t+180)%360,t}),b=ge({get:()=>{var t;return((t=u.clip)==null?void 0:t.angle)===void 0?0:_(u.clip.angle)},set:t=>{u.clip&&(u.clip.angle=y(t))}}),A=t=>{if(!u.clip)return;if(t===null||isNaN(t)){u.clip.angle=0;return}let e=t%360;e<0&&(e+=360),u.clip.angle=y(e)},B=t=>{p.value=!0},I=t=>{if(!p.value||!u.clip)return;const e=t.currentTarget.getBoundingClientRect(),n=e.left+e.width/2,o=e.top+e.height/2;let f=Math.atan2(t.clientY-o,t.clientX-n);f=f+Math.PI/2,f<0&&(f+=Math.PI*2),u.clip.angle=f,h("update",u.clip)},U=()=>{p.value=!1},G=(t,e)=>{u.clip&&((t===null||isNaN(t))&&(u.clip[e]=0),h("update",u.clip))};return(t,e)=>{const n=$t("el-input-number"),o=$t("el-slider");return ct(),yt("div",NS,[e[22]||(e[22]=O("div",{class:"text-base font-medium text-white mb-4"},"视频属性",-1)),O("div",GS,[O("div",null,[e[14]||(e[14]=O("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),J(n,{class:"w-30",modelValue:t.clip.x,"onUpdate:modelValue":e[0]||(e[0]=f=>t.clip.x=f),size:"small",placeholder:"X",precision:0,onChange:e[1]||(e[1]=f=>G(f,"x"))},null,8,["modelValue"])]),O("div",null,[e[15]||(e[15]=O("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),J(n,{class:"w-30",modelValue:t.clip.y,"onUpdate:modelValue":e[2]||(e[2]=f=>t.clip.y=f),size:"small",placeholder:"Y",precision:0,onChange:e[3]||(e[3]=f=>G(f,"y"))},null,8,["modelValue"])])]),O("div",HS,[e[17]||(e[17]=O("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),O("div",YS,[O("div",VS,[J(n,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=f=>b.value=f),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:A},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:B,onMousemove:I,onMouseup:U,onMouseleave:U},[O("div",$S,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Mi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},e[16]||(e[16]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),O("div",WS,[O("div",XS,[e[18]||(e[18]=O("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),J(n,{class:"w-30",modelValue:t.clip.sourceStartTime,"onUpdate:modelValue":e[5]||(e[5]=f=>t.clip.sourceStartTime=f),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:e[6]||(e[6]=f=>G(f,"sourceStartTime"))},null,8,["modelValue"])]),O("div",qS,[e[19]||(e[19]=O("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),J(n,{class:"w-30",modelValue:t.clip.sourceEndTime,"onUpdate:modelValue":e[7]||(e[7]=f=>t.clip.sourceEndTime=f),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:e[8]||(e[8]=f=>G(f,"sourceEndTime"))},null,8,["modelValue"])])]),O("div",jS,[O("div",KS,[e[20]||(e[20]=O("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),O("div",ZS,[J(o,{modelValue:t.clip.volume,"onUpdate:modelValue":e[9]||(e[9]=f=>t.clip.volume=f),min:0,max:100,step:1},null,8,["modelValue"]),t.clip.volume===100?(ct(),ei(Ct(re),{key:0,icon:"material-symbols:volume-up",onClick:e[10]||(e[10]=f=>t.clip.volume=0)})):t.clip.volume!==0?(ct(),ei(Ct(re),{key:1,icon:"material-symbols:volume-down",onClick:e[11]||(e[11]=f=>t.clip.volume=0)})):(ct(),ei(Ct(re),{key:2,icon:"material-symbols:volume-off",onClick:e[12]||(e[12]=f=>t.clip.volume=100)}))])])]),O("div",JS,[O("div",QS,[e[21]||(e[21]=O("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),O("div",tU,[J(o,{modelValue:t.clip.opacity,"onUpdate:modelValue":e[13]||(e[13]=f=>t.clip.opacity=f),min:0,max:100,step:1},null,8,["modelValue"]),O("div",eU,De(Math.round(t.clip.opacity))+"%",1)])])])])}}}),nU=Ei(iU,[["__scopeId","data-v-a203910b"]]),rU={class:"mb-6"},sU={class:"flex gap-3 mb-3"},aU={class:"flex-1"},oU={class:"flex-1"},lU={class:"flex items-center gap-3"},uU={class:"flex-1"},hU={class:"flex items-center gap-3"},fU=Re({__name:"AudioProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=l,p=(_,y)=>{u.clip&&((_===null||isNaN(_))&&(u.clip[y]=0),h("update",u.clip))};return(_,y)=>{const s=$t("el-input-number"),b=$t("el-slider");return ct(),yt("div",rU,[y[11]||(y[11]=O("div",{class:"text-base font-medium text-white mb-4"},"音频属性",-1)),O("div",sU,[O("div",aU,[y[8]||(y[8]=O("div",{class:"text-base text-[#999] mb-1"},"去片头",-1)),J(s,{class:"w-30",modelValue:_.clip.sourceStartTime,"onUpdate:modelValue":y[0]||(y[0]=A=>_.clip.sourceStartTime=A),size:"small",min:0,step:.1,placeholder:"去片头时间",onChange:y[1]||(y[1]=A=>p(A,"sourceStartTime"))},null,8,["modelValue"])]),O("div",oU,[y[9]||(y[9]=O("div",{class:"text-base text-[#999] mb-1"},"去片尾",-1)),J(s,{class:"w-30",modelValue:_.clip.sourceEndTime,"onUpdate:modelValue":y[2]||(y[2]=A=>_.clip.sourceEndTime=A),size:"small",min:0,step:.1,placeholder:"去片尾时间",onChange:y[3]||(y[3]=A=>p(A,"sourceEndTime"))},null,8,["modelValue"])])]),O("div",lU,[O("div",uU,[y[10]||(y[10]=O("div",{class:"text-base text-[#999] mb-1"},"音量",-1)),O("div",hU,[J(b,{modelValue:_.clip.volume,"onUpdate:modelValue":y[4]||(y[4]=A=>_.clip.volume=A),min:0,max:100,step:1},null,8,["modelValue"]),_.clip.volume===100?(ct(),ei(Ct(re),{key:0,icon:"material-symbols:volume-up",onClick:y[5]||(y[5]=A=>_.clip.volume=0)})):_.clip.volume!==0?(ct(),ei(Ct(re),{key:1,icon:"material-symbols:volume-down",onClick:y[6]||(y[6]=A=>_.clip.volume=0)})):(ct(),ei(Ct(re),{key:2,icon:"material-symbols:volume-off",onClick:y[7]||(y[7]=A=>_.clip.volume=100)}))])])])])}}}),dU=Ei(fU,[["__scopeId","data-v-8cf099bb"]]),cU={class:"mb-6"},pU={class:"grid grid-cols-2 gap-3 mb-4"},_U={class:"mb-4"},gU={class:"flex items-center gap-4"},mU={class:"w-full"},vU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},yU={class:"flex items-center gap-3"},wU={class:"flex-1"},xU={class:"flex items-center gap-3"},bU={class:"w-12 text-right"},SU=Re({__name:"ImageProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=l,p=_t(!1),_=t=>{let e=t*(180/Math.PI);return e=e%360,e<0&&(e+=360),Math.round(e)},y=t=>t*(Math.PI/180),s=ge(()=>{var e;if(((e=u.clip)==null?void 0:e.angle)===void 0)return 0;let t=_(u.clip.angle);return t=(t+180)%360,t}),b=ge({get:()=>{var t;return((t=u.clip)==null?void 0:t.angle)===void 0?0:_(u.clip.angle)},set:t=>{u.clip&&(u.clip.angle=y(t))}}),A=t=>{if(!u.clip)return;if(t===null||isNaN(t)){u.clip.angle=0;return}let e=t%360;e<0&&(e+=360),u.clip.angle=y(e)},B=t=>{p.value=!0},I=t=>{if(!p.value||!u.clip)return;const e=t.currentTarget.getBoundingClientRect(),n=e.left+e.width/2,o=e.top+e.height/2;let f=Math.atan2(t.clientY-o,t.clientX-n);f=f+Math.PI/2,f<0&&(f+=Math.PI*2),u.clip.angle=f,h("update",u.clip)},U=()=>{p.value=!1},G=(t,e)=>{u.clip&&((t===null||isNaN(t))&&(u.clip[e]=0),h("update",u.clip))};return(t,e)=>{const n=$t("el-input-number"),o=$t("el-slider");return ct(),yt("div",cU,[e[11]||(e[11]=O("div",{class:"text-base font-medium text-white mb-4"},"图片属性",-1)),O("div",pU,[O("div",null,[e[6]||(e[6]=O("div",{class:"text-base text-[#999] mb-1"},"X 坐标",-1)),J(n,{class:"w-30",modelValue:t.clip.x,"onUpdate:modelValue":e[0]||(e[0]=f=>t.clip.x=f),size:"small",placeholder:"X",precision:0,onChange:e[1]||(e[1]=f=>G(f,"x"))},null,8,["modelValue"])]),O("div",null,[e[7]||(e[7]=O("div",{class:"text-base text-[#999] mb-1"},"Y 坐标",-1)),J(n,{class:"w-30",modelValue:t.clip.y,"onUpdate:modelValue":e[2]||(e[2]=f=>t.clip.y=f),size:"small",placeholder:"Y",precision:0,onChange:e[3]||(e[3]=f=>G(f,"y"))},null,8,["modelValue"])])]),O("div",_U,[e[9]||(e[9]=O("div",{class:"text-base text-[#999] mb-2"},"旋转角度",-1)),O("div",gU,[O("div",mU,[J(n,{class:"w-full",modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=f=>b.value=f),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:A},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:B,onMousemove:I,onMouseup:U,onMouseleave:U},[O("div",vU,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Mi({transform:`rotate(${s.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},e[8]||(e[8]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)])]),O("div",yU,[O("div",wU,[e[10]||(e[10]=O("div",{class:"text-base text-[#999] mb-1"},"不透明度",-1)),O("div",xU,[J(o,{modelValue:t.clip.opacity,"onUpdate:modelValue":e[5]||(e[5]=f=>t.clip.opacity=f),min:0,max:100,step:1},null,8,["modelValue"]),O("div",bU,De(Math.round(t.clip.opacity))+"%",1)])])])])}}}),UU=Ei(SU,[["__scopeId","data-v-6d7357c9"]]),EU={class:"mb-6"},CU={class:"mb-2"},TU={class:"mb-4"},AU={class:"flex items-center gap-4 mb-3"},IU={class:"w-full"},BU={class:"w-8 h-8 rounded-full border border-[#af24ff] relative"},zU={class:"flex justify-start items-center gap-1"},FU={class:"py-2"},kU={class:"flex justify-between items-center mb-2"},LU={class:"flex-1 mx-4"},PU={class:"flex justify-between items-center mb-2"},DU={class:"flex justify-between items-center mb-2"},RU={class:"flex justify-between items-center mb-2"},MU={class:"flex justify-between items-center mb-2 pl-4"},OU={class:"flex justify-between items-center mb-2 pl-4"},NU={class:"flex justify-between items-center mb-2"},GU={class:"flex justify-between items-center mb-2 pl-4"},HU={class:"flex justify-between items-center mb-2 pl-4"},YU={class:"flex justify-between items-center mb-2 pl-4"},VU={class:"flex justify-between items-center mb-2 pl-4"},$U=Re({__name:"TextProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=l,p=_t(!1),_=_t([]),y=n=>{let o=n*(180/Math.PI);return o=o%360,o<0&&(o+=360),Math.round(o)},s=n=>n*(Math.PI/180),b=ge(()=>{var o;if(((o=u.clip)==null?void 0:o.angle)===void 0)return 0;let n=y(u.clip.angle);return n=(n+180)%360,n}),A=ge({get:()=>{var n;return((n=u.clip)==null?void 0:n.angle)===void 0?0:y(u.clip.angle)},set:n=>{u.clip&&(u.clip.angle=s(n))}}),B=ge(()=>{var n,o;switch((o=(n=u.clip)==null?void 0:n.textConfig)==null?void 0:o.align){case"center":return"material-symbols:format-align-center";case"right":return"material-symbols:format-align-right";default:return"material-symbols:format-align-left"}}),I=n=>{u.clip&&(u.clip.textConfig.align=n,h("update",u.clip))},U=n=>{if(!u.clip)return;if(n===null||isNaN(n)){u.clip.angle=0;return}let o=n%360;o<0&&(o+=360),u.clip.angle=s(o),h("update",u.clip)},G=n=>{p.value=!0},t=n=>{if(!p.value||!u.clip)return;const o=n.currentTarget.getBoundingClientRect(),f=o.left+o.width/2,g=o.top+o.height/2;let v=Math.atan2(n.clientY-g,n.clientX-f);v=v+Math.PI/2,v<0&&(v+=Math.PI*2),u.clip.angle=v,h("update",u.clip)},e=()=>{p.value=!1};return(n,o)=>{const f=$t("el-input"),g=$t("el-option"),v=$t("el-select"),w=$t("el-input-number"),S=$t("el-button"),k=$t("el-dropdown-item"),F=$t("el-dropdown-menu"),P=$t("el-dropdown"),M=$t("el-color-picker"),D=$t("el-slider"),et=$t("el-switch"),at=$t("el-collapse-item"),Ft=$t("el-collapse");return ct(),yt("div",EU,[o[36]||(o[36]=O("div",{class:"text-base font-medium text-white mb-4"},"文字属性",-1)),O("div",CU,[J(f,{modelValue:n.clip.textConfig.content,"onUpdate:modelValue":o[0]||(o[0]=lt=>n.clip.textConfig.content=lt),type:"textarea",rows:3,placeholder:"请输入文字内容"},null,8,["modelValue"])]),O("div",TU,[o[22]||(o[22]=O("div",{class:"text-base text-white mb-2"},"字体",-1)),J(v,{modelValue:n.clip.textConfig.fontFamily,"onUpdate:modelValue":o[1]||(o[1]=lt=>n.clip.textConfig.fontFamily=lt),class:"w-full mb-2"},{default:Xt(()=>[J(g,{label:"DM Sans",value:"DM Sans"}),J(g,{label:"微软雅黑",value:"Microsoft YaHei"}),J(g,{label:"宋体",value:"SimSun"}),J(g,{label:"黑体",value:"SimHei"})]),_:1},8,["modelValue"]),o[23]||(o[23]=O("div",{class:"text-base text-white mb-2"},"旋转角度",-1)),O("div",AU,[O("div",IU,[J(w,{class:"w-full",modelValue:A.value,"onUpdate:modelValue":o[2]||(o[2]=lt=>A.value=lt),min:0,max:360,step:1,size:"small","controls-position":"right",onChange:U},null,8,["modelValue"])]),O("div",{class:"relative flex items-center justify-center",onMousedown:G,onMousemove:t,onMouseup:e,onMouseleave:e},[O("div",BU,[O("div",{class:"absolute w-[1px] h-[13px] bg-[#af24ff]",style:Mi({transform:`rotate(${b.value}deg)`,left:"calc(50% - 0.5px)",top:"50%",transformOrigin:"top"})},o[18]||(o[18]=[O("div",{class:"absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[#af24ff]"},null,-1)]),4)])],32)]),O("div",zU,[J(S,{class:Pn({"text-purple-500":n.clip.textConfig.bold}),size:"small",onClick:o[3]||(o[3]=lt=>n.clip.textConfig.bold=!n.clip.textConfig.bold)},{default:Xt(()=>[J(Ct(re),{icon:"material-symbols:format-bold"})]),_:1},8,["class"]),J(S,{class:Pn(["!ml-0",{"text-purple-500":n.clip.textConfig.italic}]),size:"small",onClick:o[4]||(o[4]=lt=>n.clip.textConfig.italic=!n.clip.textConfig.italic)},{default:Xt(()=>[J(Ct(re),{icon:"material-symbols:format-italic"})]),_:1},8,["class"]),J(P,{trigger:"click",onCommand:I},{dropdown:Xt(()=>[J(F,null,{default:Xt(()=>[J(k,{command:"left"},{default:Xt(()=>[J(Ct(re),{icon:"material-symbols:format-align-left"}),o[19]||(o[19]=O("span",{class:"text-sm text-white ml-2"},"左对齐",-1))]),_:1}),J(k,{command:"center"},{default:Xt(()=>[J(Ct(re),{icon:"material-symbols:format-align-center"}),o[20]||(o[20]=O("span",{class:"text-sm text-white ml-2"},"居中",-1))]),_:1}),J(k,{command:"right"},{default:Xt(()=>[J(Ct(re),{icon:"material-symbols:format-align-right"}),o[21]||(o[21]=O("span",{class:"text-sm text-white ml-2"},"右对齐",-1))]),_:1})]),_:1})]),default:Xt(()=>[J(S,{size:"small"},{default:Xt(()=>[J(Ct(re),{icon:B.value},null,8,["icon"])]),_:1})]),_:1}),J(M,{modelValue:n.clip.textConfig.color,"onUpdate:modelValue":o[5]||(o[5]=lt=>n.clip.textConfig.color=lt),size:"small","show-alpha":""},null,8,["modelValue"])])]),J(Ft,{modelValue:_.value,"onUpdate:modelValue":o[17]||(o[17]=lt=>_.value=lt)},{default:Xt(()=>[J(at,{name:"advanced"},{title:Xt(()=>o[24]||(o[24]=[O("span",{class:"text-base text-white"},"高级",-1)])),default:Xt(()=>[O("div",FU,[O("div",kU,[o[25]||(o[25]=O("span",{class:"text-base text-white"},"透明度",-1)),O("div",LU,[J(D,{modelValue:n.clip.opacity,"onUpdate:modelValue":o[6]||(o[6]=lt=>n.clip.opacity=lt),min:0,max:100,step:1},null,8,["modelValue"])])]),O("div",PU,[o[26]||(o[26]=O("span",{class:"text-base text-white"},"行高",-1)),J(w,{modelValue:n.clip.textConfig.lineSpacing,"onUpdate:modelValue":o[7]||(o[7]=lt=>n.clip.textConfig.lineSpacing=lt),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",DU,[o[27]||(o[27]=O("span",{class:"text-base text-white"},"字间距",-1)),J(w,{modelValue:n.clip.textConfig.letterSpacing,"onUpdate:modelValue":o[8]||(o[8]=lt=>n.clip.textConfig.letterSpacing=lt),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",RU,[o[28]||(o[28]=O("span",{class:"text-base text-white"},"边框",-1)),J(et,{modelValue:n.clip.textConfig.showStroke,"onUpdate:modelValue":o[9]||(o[9]=lt=>n.clip.textConfig.showStroke=lt)},null,8,["modelValue"])]),n.clip.textConfig.showStroke?(ct(),yt(fi,{key:0},[O("div",MU,[o[29]||(o[29]=O("span",{class:"text-base text-white"},"边框颜色",-1)),J(M,{modelValue:n.clip.textConfig.strokeColor,"onUpdate:modelValue":o[10]||(o[10]=lt=>n.clip.textConfig.strokeColor=lt),"show-alpha":"",size:"small"},null,8,["modelValue"])]),O("div",OU,[o[30]||(o[30]=O("span",{class:"text-base text-white"},"边框宽度",-1)),J(w,{modelValue:n.clip.textConfig.strokeWidth,"onUpdate:modelValue":o[11]||(o[11]=lt=>n.clip.textConfig.strokeWidth=lt),min:0,step:.5,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):oe("",!0),O("div",NU,[o[31]||(o[31]=O("span",{class:"text-base text-white"},"阴影",-1)),J(et,{modelValue:n.clip.textConfig.showShadow,"onUpdate:modelValue":o[12]||(o[12]=lt=>n.clip.textConfig.showShadow=lt)},null,8,["modelValue"])]),n.clip.textConfig.showShadow?(ct(),yt(fi,{key:1},[O("div",GU,[o[32]||(o[32]=O("span",{class:"text-base text-white"},"阴影颜色",-1)),J(M,{modelValue:n.clip.textConfig.shadowColor,"onUpdate:modelValue":o[13]||(o[13]=lt=>n.clip.textConfig.shadowColor=lt),"show-alpha":"",size:"small"},null,8,["modelValue"])]),O("div",HU,[o[33]||(o[33]=O("span",{class:"text-base text-white"},"阴影模糊",-1)),J(w,{modelValue:n.clip.textConfig.shadowBlur,"onUpdate:modelValue":o[14]||(o[14]=lt=>n.clip.textConfig.shadowBlur=lt),min:0,step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",YU,[o[34]||(o[34]=O("span",{class:"text-base text-white"},"水平偏移",-1)),J(w,{modelValue:n.clip.textConfig.shadowOffsetX,"onUpdate:modelValue":o[15]||(o[15]=lt=>n.clip.textConfig.shadowOffsetX=lt),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])]),O("div",VU,[o[35]||(o[35]=O("span",{class:"text-base text-white"},"垂直偏移",-1)),J(w,{modelValue:n.clip.textConfig.shadowOffsetY,"onUpdate:modelValue":o[16]||(o[16]=lt=>n.clip.textConfig.shadowOffsetY=lt),step:1,"controls-position":"right",class:"w-30"},null,8,["modelValue"])])],64)):oe("",!0)])]),_:1})]),_:1},8,["modelValue"])])}}}),WU=Ei($U,[["__scopeId","data-v-fcc51af5"]]),XU={class:"text-white"},qU={key:0,class:"mb-6"},jU={class:"mb-4"},KU={class:"text-base text-white"},ZU={class:"mb-4"},JU=Re({__name:"FilterProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=_=>{u.clip.intensity=_},p=_=>_?{grayscale:"灰度",invert:"反色",brightness:"亮度",sepia:"复古",blur:"模糊"}[_]:"未知滤镜";return(_,y)=>{const s=$t("el-slider");return ct(),yt("div",XU,[_.clip?(ct(),yt("div",qU,[y[3]||(y[3]=O("div",{class:"text-base font-medium text-white mb-4"},"滤镜属性",-1)),O("div",jU,[y[1]||(y[1]=O("div",{class:"text-base text-[#999] mb-1"},"名称",-1)),O("div",KU,De(p(_.clip.filterType)),1)]),O("div",ZU,[y[2]||(y[2]=O("div",{class:"text-base text-[#999] mb-1"},"强度",-1)),J(s,{modelValue:_.clip.intensity,"onUpdate:modelValue":y[0]||(y[0]=b=>_.clip.intensity=b),min:0,max:100,step:1,onChange:h,class:"filter-slider"},null,8,["modelValue"])])])):oe("",!0)])}}}),QU=Ei(JU,[["__scopeId","data-v-18c52553"]]),t2={class:"p-6 text-white"},e2={key:1,class:"text-center text-[#999] text-base"},i2=Re({__name:"ClipProperties",props:{clip:{}},emits:["update"],setup(d,{emit:l}){const u=d,h=l,p=_r(),_=y=>{h("update",y)};return Mn(()=>u.clip,y=>{y&&p.publishClipUpdate(y)},{deep:!0}),(y,s)=>(ct(),yt("div",t2,[y.clip?(ct(),yt(fi,{key:0},[y.clip.type==="video"?(ct(),ei(nU,{key:0,clip:y.clip,onUpdate:_},null,8,["clip"])):oe("",!0),y.clip.type==="audio"?(ct(),ei(dU,{key:1,clip:y.clip,onUpdate:_},null,8,["clip"])):oe("",!0),y.clip.type==="image"?(ct(),ei(UU,{key:2,clip:y.clip,onUpdate:_},null,8,["clip"])):oe("",!0),y.clip.type==="text"?(ct(),ei(WU,{key:3,clip:y.clip,onUpdate:_},null,8,["clip"])):oe("",!0),y.clip.type==="filter"?(ct(),ei(QU,{key:4,clip:y.clip,onUpdate:_},null,8,["clip"])):oe("",!0)],64)):(ct(),yt("div",e2," 请选择一个片段 "))]))}}),n2={id:"left",class:"h-screen"},r2={id:"right",class:"h-screen overflow-hidden"},s2={id:"top",class:"flex justify-between"},a2={id:"topLeft",class:"w-4/5"},o2={id:"topRight",class:"w-1/5 bg-[#303030]"},l2={id:"bottom",class:"bg-[#201f20]"},ou=10,u2=300,h2=5,Ps="split-sizes",p2=Re({__name:"index",setup(d){const l=M=>{M.ctrlKey&&M.preventDefault()};os(()=>{window.addEventListener("wheel",l,{passive:!1})}),Zs(()=>{window.removeEventListener("wheel",l)});const u=Zd(),h=_r(),p=Number(u.params.id),_=[25,75],y=[65,35],s=_t([]),b=_t(0),A=ge(()=>Math.max(B.value+h2,u2)),B=ge(()=>{let M=0;return s.value.forEach(D=>{D.clips.forEach(et=>{const at=Number(et.endTime);at>M&&(M=at)})}),M}),I=_t(null),U=_t(null),G=M=>{b.value=M},t=async M=>{const D=fw(M);await Fu("/capture/"+p+".png",D,{overwrite:!0});const et=await Ce.projects.where({id:p}).first();et&&Ce.projects.update(et,{thumbnail:"/capture/"+p+".png"})},e=()=>{b.value-=30/1e3/1e3},n=()=>{b.value+=30/1e3/1e3};Sd("addClip",async(M,D)=>{if(M.startTime=b.value,M.endTime=b.value+M.duration,M.type==="video"&&(M.sourceStartTime=0,M.sourceEndTime=0,M.originalDuration=M.duration),M.type==="video"||M.type==="image"){const et=await Iu(M);et.type==="video"?M.thumbnail=et.data:et.type==="image"&&(M.thumbnail=[{timestamp:0,url:URL.createObjectURL(et.data)}])}if(M.type==="audio"){const et=await Bu(M);et.type==="audio"&&(M.volumeData=et.data)}if(D){if(s.value.length>=ou){cr.warning(`轨道数量已达到最大限制(${ou})`);return}const et={id:String(s.value.length),clips:[M]};s.value.push(et)}else s.value.length===0&&s.value.push({id:"0",clips:[]}),s.value[s.value.length-1].clips.push(M);Ws(()=>{var et;(et=I.value)==null||et.refreshPlayer()})}),Sd("activeClip",M=>{var D,et,at;if(M){const Ft=(D=s.value.find(lt=>lt.clips.some(Tt=>Tt.id===M)))==null?void 0:D.clips.find(lt=>lt.id===M);Ft&&((et=U.value)==null||et.activeClip(Ft),v.value=Ft)}else(at=U.value)==null||at.activeClip(null),v.value=null}),_t(0),_t(0),os(async()=>{const M=localStorage.getItem(Ps),{horizontalSizes:D,verticalSizes:et}=M?JSON.parse(M):{horizontalSizes:_,verticalSizes:y};Wd(["#left","#right"],{sizes:D,minSize:[250,500],snapOffset:0,onDragEnd:Ft=>{const lt=localStorage.getItem(Ps),Tt=lt?JSON.parse(lt):{};localStorage.setItem(Ps,JSON.stringify({...Tt,horizontalSizes:Ft}))}}),Wd(["#top","#bottom"],{direction:"vertical",sizes:et,minSize:[250,150],snapOffset:0,onDragEnd:Ft=>{const lt=localStorage.getItem(Ps),Tt=lt?JSON.parse(lt):{};localStorage.setItem(Ps,JSON.stringify({...Tt,verticalSizes:Ft}))}});const at=await Ce.projects.where({id:p}).first();at&&(s.value=at.tracks,k(),s.value.forEach(Ft=>{Ft.clips.forEach(lt=>{lt.type==="audio"?Bu(lt).then(Tt=>{Tt.type==="audio"&&(lt.volumeData=Tt.data)}):(lt.type==="video"||lt.type==="image")&&Iu(lt).then(Tt=>{Tt.type==="video"?lt.thumbnail=Tt.data:Tt.type==="image"&&(lt.thumbnail=[{timestamp:0,url:URL.createObjectURL(Tt.data)}])})})}),h.clearHistory(p),h.saveHistoryState(p,s.value),F())});const o=()=>{h.setShowContextMenu(!1)},f=(M,D)=>{for(const et of s.value)for(const at of et.clips)if(at.id===M){Object.assign(at,D);break}};Mn(()=>s.value,async M=>{await g()},{deep:!0});const g=async()=>{const M=await Ce.projects.where({id:p}).first();if(M){const D=Dc.cloneDeep(s.value);D.forEach(et=>{et.clips.forEach(at=>{at.thumbnail=null})}),await Ce.projects.update(M,{tracks:D})}},v=_t(null),w=M=>{var D;v.value=M,(D=I.value)==null||D.activeClip(M)},S=M=>{var D;(D=I.value)==null||D.addClip(M)},k=()=>{s.value=s.value.filter(M=>M.clips.length>0)},F=()=>{var M;(M=I.value)==null||M.refreshPlayer()},P=()=>{var M;(M=I.value)==null||M.handleExport()};return(M,D)=>(ct(),yt("div",{class:"w-full h-full flex bg-[#1b1b1d] overflow-hidden",onClick:o},[O("div",n2,[J(q1)]),O("div",r2,[O("div",s2,[O("div",a2,[J(n1,{ref_key:"playerRef",ref:I,currentTime:b.value,tracks:s.value,timelineDuration:Ct(A),playerDuration:Ct(B),onPrevFrame:e,onNextFrame:n,onTimeUpdate:G,onCaptureImage:t,onUpdateClipProps:f},null,8,["currentTime","tracks","timelineDuration","playerDuration"])]),O("div",o2,[J(i2,{clip:v.value,onUpdate:f},null,8,["clip"])])]),O("div",l2,[J(OS,{ref_key:"clipTrackRef",ref:U,tracks:s.value,"onUpdate:tracks":D[0]||(D[0]=et=>s.value=et),maxTracksNum:ou,currentTime:b.value,timelineDuration:Ct(A),onTimeUpdate:G,onAddClip:S,onRefreshPlayer:F,onDeleteEmptyTrack:k,onActiveClip:w,onHandleExport:P},null,8,["tracks","currentTime","timelineDuration"])])])]))}});export{p2 as default};
